



<!DOCTYPE html>
<html lang="zh-CN" class="with-v3-banner">
  <head>
    <title>uniapp介绍 — zzf的个人博客笔记</title>
    <meta charset="utf-8">
    <meta name="description" content="Vue.js - The Progressive JavaScript Framework">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="alternate" hreflang="x-default" href="https://v2.vuejs.org/framework/uniapp/index.html">
    <link rel="alternate" hreflang="zh" href="https://v2.cn.vuejs.org/framework/uniapp/index.html">
    <link rel="alternate" hreflang="ja" href="https://jp.vuejs.org/framework/uniapp/index.html">
    <link rel="alternate" hreflang="ru" href="https://ru.vuejs.org/framework/uniapp/index.html">
    <link rel="alternate" hreflang="ko" href="https://kr.vuejs.org/framework/uniapp/index.html">
    <link rel="alternate" hreflang="pt-BR" href="https://br.vuejs.org/framework/uniapp/index.html">
    <link rel="alternate" hreflang="fr" href="https://fr.vuejs.org/framework/uniapp/index.html">
    <link rel="alternate" hreflang="es" href="https://es.vuejs.org/framework/uniapp/index.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="uniapp介绍 — Vue.js">
    <meta property="og:description" content="Vue.js - The Progressive JavaScript Framework">
    <meta property="og:image" content="https://v2.cn.vuejs.org/images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="uniapp介绍 — Vue.js">
    <meta name="twitter:description" content="Vue.js - The Progressive JavaScript Framework">
    <meta name="twitter:image" content="https://v2.cn.vuejs.org/images/logo.png">

    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/images/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
    <meta name="msapplication-TileImage" content="/images/icons/ms-icon-144x144.png">
    <link rel="icon" href="/images/logo.svg">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <!-- <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin> -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com" rel="preconnect" crossorigin> -->

    <!-- <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono&display=swap" rel="stylesheet"> -->
    <!-- <link href="https://fonts.googleapis.com/css?family=Dosis:500&text=Vue.js&display=swap" rel="stylesheet"> -->

    <link href="//code.bdstatic.com/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- main page styles -->
    
<link rel="stylesheet" href="/css/page.css">


    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>

    

    <script>
      Vue.config.productionTip = false
      window.PAGE_TYPE = "uniapp"
    </script>

    <!-- Fathom - beautiful, simple website analytics -->
    <script src="https://cdn.usefathom.com/script.js" data-site="KTDIHEIJ" defer></script>
    <!-- / Fathom -->

    <!-- vimeo analytics -->
    <!-- <script type="text/javascript" defer="defer" src="https://extend.vimeocdn.com/ga/72160148.js"></script> -->
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Vue123.js" type="application/atom+xml">
</head>
  <body class="docs">

    

    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div>


  <header id="header">
    <a id="logo" href="/">
      <!-- <img src="/images/logo.svg" alt="vue logo"> -->
      <span>个人博客</span>
    </a>
    <ul id="nav">
      <li>
    <form id="search-form">
        <input type="text" id="search-query-nav" class="search-query st-default-search-input" aria-label="搜索" />
    </form>
</li>
<li class="nav-dropdown-container learn">
    <a class="nav-link">前端基础</a
    ><span class="arrow"></span>
    <ul class="nav-dropdown">
        <li><h4>文档</h4></li>
        <li>
            <ul>
                <li><a href="/v2/guide/" class="nav-link">HTML</a></li>
        <li><a href="/v2/api/" class="nav-link">CSS</a></li>
        <li><a href="/v2/style-guide/" class="nav-link">JS</a></li>
            </ul>
        </li>
    </ul>
</li>
 <li class="nav-dropdown-container framework">
    <a class="nav-link current">前端框架</a
    ><span class="arrow"></span>
    <ul class="nav-dropdown">
        <li>
            <ul>
                 <li><a href="/framework/vue/" class="nav-link">vue</a></li>
                  <li><a href="/framework/uniapp/" class="nav-link current">uniapp</a></li>
               
            </ul>
        </li>
    </ul>
</li>
 <li class="nav-dropdown-container resources">
    <a class="nav-link">网站部署</a
    ><span class="arrow"></span>
    <ul class="nav-dropdown">
        <li>
            <ul>
                 <li><a href="/website/process/" class="nav-link">部署流程</a></li>
                <li><a href="/website/hexo/" class="nav-link">HEXO</a></li>
                <li><a href="/website/docker/" class="nav-link">Docker</a></li>
            </ul>
        </li>
    </ul>
</li>
 <li class="nav-dropdown-container tool">
    <a class="nav-link">工具</a
    ><span class="arrow"></span>
    <ul class="nav-dropdown">
        <li>
            <ul>
                 <li><a href="/tool/environment/" class="nav-link">开发环境</a></li>
                 <li><a href="/tool/git/" class="nav-link">git</a></li>
                  <li><a href="/tool/webpack/" class="nav-link">webpack</a></li>
                <li><a href="/tool/jenkins/" class="nav-link">jenkins</a></li>
            </ul>
        </li>
    </ul>
</li>
 <li class="nav-dropdown-container backend">
    <a class="nav-link">服务端</a
    ><span class="arrow"></span>
    <ul class="nav-dropdown">
        <li>
            <ul>
                 <li><a href="/backend/node/" class="nav-link">node</a></li>
                 <li><a href="/backend/MongoDB/" class="nav-link">MongoDB</a></li>
                 
            </ul>
        </li>
    </ul>
</li>

<!-- <li>
    <a href="/eol/" class="badge-parent">终止支持 (EOL)<sup class="badge">新</sup></a>
</li> -->

    </ul>
  </header>
</div>

    
      <div id="main" class="fix-sidebar">
         

<div class="sidebar">
    <div class="sidebar-inner">
        
        <div class="list"> <ul class="menu-root">
  
    
    
    <li>
      <a href="/framework/uniapp/index.html" class="sidebar-link current">uniapp介绍</a>
    </li>
  
</ul>
 </div>
    </div>
</div>
<!--

<div id="sidebar-sponsors-platinum-right">
  <div class="main-sponsor">
    <span>白金赞助商</span>
    <div>
    <a href="https://www.vuemastery.com/" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/vuemastery.png" alt="VueMastery">
    </a>
    <a href="https://vehikl.com/" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/vehikl.png" alt="Vehikl">
    </a>
    <a href="https://vuejs.amsterdam/" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/vue_js_amsterdam.png" alt="Vue.js Amsterdam">
    </a>
    <a href="https://www.storyblok.com" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/storyblok.png" alt="Storyblok">
    </a>
    <a href="https://opencollective.com/2021-frameworks-fund" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/chrome_frameworks_fund.png" alt="Chrome Frameworks Fund">
    </a>
    <a href="https://www.herodevs.com/support/vue" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/herodevs.png" alt="HeroDevs">
    </a>
    <a href="https://certificates.dev/javascript/?ref=vuejs-sponsor&friend=VUEJS" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/javascript_certification.png?v2" alt="JavaScript Certification">
    </a>
    <a href="https://www.coderabbit.ai?utm_source=github&utm_medium=sponsors&utm_campaign=evan_you_2025" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/coderabbit_.png" alt="CodeRabbit ">
    </a>
    <a href="https://imagekit.io/?utm_source=vuejs&utm_medium=referral&utm_campaign=oss-sponsorship&utm_content=homepage" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/imagekit_io.svg" alt="ImageKit.io">
    </a>
    <a href="https://www.greptile.com/?utm_source=vuejs&utm_medium=sponsorship&utm_campaign=vue_sponsor_page" target="_blank" rel="sponsored noopener" class="logo">
      <img src="https://sponsors.vuejs.org/images/greptile.png" alt="Greptile">
    </a>
    </div>
  </div>
  <a class="become-backer" href="/support-vuejs">
    成为赞助者
  </a>
</div>


-->
 
<div
    class="content uniapp with-sidebar "
>
      
<div id="ad">
  <!-- start: special logic for cn -->
  <div
    class="wwads-cn wwads-vertical"
    data-id="53"
    style="max-width: 200px"
  ></div>
  <script
    type="text/javascript"
    src="https://cdn.wwads.cn/js/makemoney.js"
    async
  ></script>
  <!-- end: special logic for cn -->
  <!-- <script
    async
    type="text/javascript"
    src="//cdn.carbonads.com/carbon.js?serve=CEBDT27Y&placement=vuejsorg"
    id="_carbonads_js"
  ></script> -->
</div>

   
    <h1>uniapp介绍</h1>
    

    <!-- start: special logic for cn -->
    <!-- start: special logic for cn -->
<!-- <div class="ad-pagetop">
  <a href="http://www.vueshop.com.cn/index.php?http_referer=vuejs" target="_blank" rel="noopener noreferrer">
    <span class="name">VUEshop</span>
    <span class="description">中国免费商城系统 - 搜豹商城系统 - 免费50小时 Vue 视频教程</span>
    <span class="action">立即查看 &gt;</span>
  </a>
</div> -->
<!-- end: special logic for cn -->

    <!-- end: special logic for cn -->

     <h1 id="uniapp介绍"><a href="#uniapp介绍" class="headerlink" title="#uniapp介绍"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#uniapp介绍">#</a>uniapp介绍</h1><h2 id="什么是快应用？"><a href="#什么是快应用？" class="headerlink" title="#什么是快应用？"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#什么是快应用">#</a>什么是快应用？</h2><p>快应用是指用户无需下载安装，即点即用，享受原生性能体验的应用，例如：微信小程序，支付宝小程序，百度小程序等。</p>
<p>快应用的优势：</p>
<ul>
<li>无需下载安装App，节约手机空间；</li>
<li>性能好，体验接近原生；</li>
<li>背靠流量；</li>
</ul>
<p>快应用的缺点：</p>
<ul>
<li>平台多，语法多，开发成本高；</li>
<li>管控难；</li>
</ul>
<p>快应用的发展趋势：平台底层支持，扫码即用，无需安装微信、支付宝等平台，可以参看，<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/269267011">链接(opens new window)</a></p>
<p>为什么PWA不香了？</p>
<ul>
<li>浏览器环境需要考虑兼容性；</li>
<li>支付会被限制；</li>
<li>缺乏原生能力；</li>
<li>追求原生体验；</li>
<li>更高的安全性的要求（内容、代码）；</li>
</ul>
<h2 id="背景介绍"><a href="#背景介绍" class="headerlink" title="#背景介绍"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#背景介绍">#</a>背景介绍</h2><h3 id="技术人想偷懒"><a href="#技术人想偷懒" class="headerlink" title="#技术人想偷懒"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#技术人想偷懒">#</a>技术人想偷懒</h3><p>困境：</p>
<ul>
<li>小程序的平台太多，需要学习多个平台的语法；</li>
<li>前端人也想用vue，react语法来写小程序；</li>
<li>想在小程序中使用npm包（庞大的第三方包）；</li>
<li>小程序代码 -&gt; 原生App，一套代码多端运行；</li>
</ul>
<h3 id="各个平台之间的对比"><a href="#各个平台之间的对比" class="headerlink" title="#各个平台之间的对比"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#各个平台之间的对比">#</a>各个平台之间的对比</h3><p><img src="uniapp.assets/test-frame-11.9ab52396.png" alt="test-frame-11.png"></p>
<p>数据源：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903810788245511">链接 (opens new window)</a>， 2020年横评：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904118901817351">链接(opens new window)</a></p>
<p><strong>结论：</strong></p>
<ul>
<li>跨端支持度测评结论：<code>uni-app</code> &gt; <code>taro</code> &gt; <code>chameleon</code> &gt; <code>mpvue</code> &gt;<code>wepy</code>、<code>原生微信小程序</code></li>
<li>微信原生框架可达到更好的性能，但 <code>uni-app</code>、<code>taro</code> 相比微信原生，性能差距并不大；</li>
<li>微信原生开发手工优化, <code>uni-app</code>&gt;微信原生开发未手工优化, <code>taro</code> &gt; <code>chameleon</code>&gt; <code>wepy</code> &gt; <code>mpvue</code></li>
<li><code>mpvue</code>支持绝大部分的Vue语法；<code>uni-app</code> 编译到微信端曾经使用过<code>mpvue</code>，但后来重新编写，支持了更多vue语法如<code>filter</code>、复杂 <code>JavaScript</code> 表达式等；<code>wepy</code>、<code>chameleon</code> 都是 <code>类Vue</code> 的实现，仅支持 <code>Vue</code> 的部分语法，开发时需要单独学习它们的规则；<code>taro</code> 对于 <code>JSX</code> 的语法支持是相对完善的，React技术栈友好；</li>
<li>学习资料完善度：<code>uni-app</code> &gt; <code>mpvue</code> , <code>taro</code> &gt; <code>chameleon</code> &gt; <code>wepy</code></li>
<li>社区活跃度：<code>uni-app</code> &gt; <code>taro</code>&gt; <code>chameleon</code> &gt; <code>wepy</code> &gt;<code>mpvue</code></li>
</ul>
<p>TIP</p>
<p>没有最好的，只有最适合的。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="#应用场景"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#应用场景">#</a>应用场景</h3><ul>
<li>熟悉Vue技术栈，推荐：uniapp &gt; wepy &gt; mpvue；熟悉React技术栈，taro；</li>
<li>项目初期，想法论证可以使用uniapp -&gt; 多端开发；后续，推荐Flutter跨端开发，再到后期推荐原生开发；</li>
<li>框架的更新本身，不能作为使用框架的绝对指标；选择合适的框架，解决当下的问题；</li>
</ul>
<h2 id="什么是uniapp"><a href="#什么是uniapp" class="headerlink" title="#什么是uniapp?"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#什么是uniapp">#</a>什么是uniapp?</h2><p><code>uni-app</code> 是一个使用 <a target="_blank" rel="noopener" href="https://vuejs.org/">Vue.js (opens new window)</a>开发所有前端应用的框架，开发者编写一套代码，可发布到iOS、Android、Web（响应式）、以及各种小程序（微信/支付宝/百度/头条/QQ/钉钉/淘宝）、快应用等多个平台。</p>
<p>TIP</p>
<p>uni-app与mpvue的渊源：<code>uni-app</code>在初期借鉴了<code>mpvue</code>，实现了微信小程序端的快速兼容，<a target="_blank" rel="noopener" href="https://ask.dcloud.net.cn/article/35699">参考链接 (opens new window)</a>。</p>
<h2 id="开发规范"><a href="#开发规范" class="headerlink" title="#开发规范"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#开发规范">#</a>开发规范</h2><p>为了实现多端兼容，综合考虑编译速度、运行性能等因素，<code>uni-app</code> 约定了如下开发规范：</p>
<ul>
<li><p>页面文件遵循 <a target="_blank" rel="noopener" href="https://vue-loader.vuejs.org/zh/spec.html">Vue 单文件组件 (SFC) 规范(opens new window)</a></p>
</li>
<li><p>组件标签靠近小程序规范，详见<a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/component/README">uni-app 组件规范(opens new window)</a></p>
<p>有几点特别要注意的：</p>
<ol>
<li>注意：所有组件与属性名都是小写，单词之间以连字符<code>-</code>连接；</li>
<li>每个vue文件的根节点必须为 <code>&lt;template&gt;</code>，且这个 <code>&lt;template&gt;</code> 下只能且必须有一个根 <code>&lt;view&gt;</code> 组件；</li>
<li>不推荐使用HTML标签，为了管理方便、策略统一，新写代码时仍然建议使用view等组件；</li>
<li>组件上的事件绑定，需要以 vue 的事件绑定语法来绑定，如 bindchange=”eventName” 事件，需要写成 <code>@change=&quot;eventName&quot;</code>；</li>
<li>uni-app支持的组件分为vue组件和小程序自定义组件；如果扩展组件符合uni-app的<code>easycom</code>组件规范，则可以免注册，直接使用；如果组件不符合easycom规范，则需要在代码里手动import和注册组件，然后才能使用</li>
</ol>
</li>
<li><p>接口能力（JS API）靠近微信小程序规范，但需将前缀 <code>wx</code> 替换为 <code>uni</code>，详见<a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/api/README">uni-app接口规范(opens new window)</a></p>
</li>
<li><p>数据绑定及事件处理同 <code>Vue.js</code> 规范，同时补充了App及页面的生命周期</p>
</li>
<li><p>为兼容多端运行，建议使用flex布局进行开发</p>
</li>
</ul>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="#目录结构"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#目录结构">#</a>目录结构</h2><p>一个uni-app工程，默认包含如下目录及文件：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><code class="hljs markdown">┌─uniCloud              云空间目录，阿里云为uniCloud-aliyun,腾讯云为uniCloud-tcb（详见uniCloud）<br>│─components            符合vue组件规范的uni-app组件目录<br>│  └─comp-a.vue         可复用的a组件<br>├─hybrid                App端存放本地html文件的目录，详见<br>├─platforms             存放各平台专用页面的目录，详见<br>├─pages                 业务页面文件存放的目录<br>│  ├─index<br>│  │  └─index.vue       index页面<br>│  └─list<br>│     └─list.vue        list页面<br>├─static                存放应用引用的本地静态资源（如图片、视频等）的目录，注意：静态资源只能存放于此<br>├─uni<span class="hljs-emphasis">_modules           存放uni_</span>module规范的插件。<br>├─wxcomponents          存放小程序组件的目录，详见<br>├─main.js               Vue初始化入口文件<br>├─App.vue               应用配置，用来配置App全局样式以及监听 应用生命周期<br>├─manifest.json         配置应用名称、appid、logo、版本等打包信息<br>└─pages.json            配置页面路由、导航条、选项卡等页面类信息<br></code></pre></td></tr></table></figure>
<p>TIP</p>
<ul>
<li>编译到任意平台时，<code>static</code> 目录下的文件均会被完整打包进去，且不会编译。非 <code>static</code> 目录下的文件（vue、js、css 等）只有被引用到才会被打包编译进去。</li>
<li><code>static</code> 目录下的 <code>js</code> 文件不会被编译，如果里面有 <code>es6</code> 的代码，不经过转换直接运行，在手机设备上会报错。</li>
<li><code>css</code>、<code>less/scss</code> 等资源不要放在 <code>static</code> 目录下，建议这些公用的资源放在自建的 <code>common</code> 目录下。</li>
<li>HbuilderX 1.9.0+ 支持在根目录创建 <code>ext.json</code>、<code>sitemap.json</code> 等小程序需要的文件。</li>
</ul>
<h2 id="导入静态资源"><a href="#导入静态资源" class="headerlink" title="#导入静态资源"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#导入静态资源">#</a>导入静态资源</h2><h3 id="模板内引入静态资源"><a href="#模板内引入静态资源" class="headerlink" title="#模板内引入静态资源"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#模板内引入静态资源">#</a>模板内引入静态资源</h3><p><code>template</code>内引入静态资源，如<code>image</code>、<code>video</code>等标签的<code>src</code>属性时，可以使用相对路径或者绝对路径，形式如下</p>
<figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 绝对路径，/static指根目录下的static目录，在cli项目中/static指src目录下的static目录 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">image</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;logo&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/static/logo.png&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">image</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;logo&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;@/static/logo.png&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 相对路径 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">image</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;logo&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;../../static/logo.png&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span><br></code></pre></td></tr></table></figure>
<p>特别说明：</p>
<p>TIP</p>
<ul>
<li><code>@</code>开头的绝对路径以及相对路径会经过base64转换规则校验</li>
<li>引入的静态资源在非h5平台，均不转为base64。</li>
<li>H5平台，小于4kb的资源会被转换成base64，其余不转。</li>
<li>自<code>HBuilderX 2.6.6</code>起<code>template</code>内支持<code>@</code>开头路径引入静态资源，旧版本不支持此方式</li>
<li>App平台自<code>HBuilderX 2.6.9</code>起<code>template</code>节点中引用静态资源文件时（如：图片），调整查找策略为【基于当前文件的路径搜索】，与其他平台保持一致</li>
<li>支付宝小程序组件内 image 标签不可使用相对路径</li>
</ul>
<h3 id="js文件引入"><a href="#js文件引入" class="headerlink" title="#js文件引入"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#js文件引入">#</a>js文件引入</h3><p><code>js</code>文件或<code>script</code>标签内（包括renderjs等）引入<code>js</code>文件时，可以使用相对路径和绝对路径，形式如下</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 绝对路径，@指向项目根目录，在cli项目中@指向src目录</span><br><span class="hljs-keyword">import</span> add <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/common/add.js&#x27;</span><br><span class="hljs-comment">// 相对路径</span><br><span class="hljs-keyword">import</span> add <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../common/add.js&#x27;</span><br></code></pre></td></tr></table></figure>
<p>WARNING</p>
<p>js文件不支持使用<code>/</code>开头的方式引入</p>
<h3 id="css引入静态资源"><a href="#css引入静态资源" class="headerlink" title="#css引入静态资源"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/#css引入静态资源">#</a>css引入静态资源</h3><ol>
<li><code>css</code>文件或<code>style标签</code>内引入<code>css</code>文件时（scss、less文件同理），可以使用相对路径或绝对路径（<code>HBuilderX 2.6.6</code>）</li>
</ol>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 绝对路径 */</span><br><span class="hljs-keyword">@import</span> url(<span class="hljs-string">&#x27;/common/uni.css&#x27;</span>);<br><span class="hljs-keyword">@import</span> url(<span class="hljs-string">&#x27;@/common/uni.css&#x27;</span>);<br><span class="hljs-comment">/* 相对路径 */</span><br><span class="hljs-keyword">@import</span> url(<span class="hljs-string">&#x27;../../common/uni.css&#x27;</span>);<br></code></pre></td></tr></table></figure>
<p>WARNING</p>
<p>自<code>HBuilderX 2.6.6</code>起支持绝对路径引入静态资源，旧版本不支持此方式</p>
<ol>
<li><code>css</code>文件或<code>style标签</code>内引用的图片路径可以使用相对路径也可以使用绝对路径，需要注意的是，有些小程序端css文件不允许引用本地文件（请看注意事项）。</li>
</ol>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* 绝对路径 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">/static/logo.png</span>);<br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">@/static/logo.png</span>);<br><span class="hljs-comment">/* 相对路径 */</span><br><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">../../static/logo.png</span>);<br></code></pre></td></tr></table></figure>
<p>注意事项：</p>
<p>TIP</p>
<ul>
<li>引入字体图标请参考，<a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/frame?id=字体图标">字体图标(opens new window)</a></li>
<li><code>@</code>开头的绝对路径以及相对路径会经过base64转换规则校验</li>
<li>不支持本地图片的平台，小于40kb，一定会转base64。（共四个平台mp-weixin, mp-qq, mp-toutiao, app v2）</li>
<li>h5平台，小于4kb会转base64，超出4kb时不转。</li>
<li>其余平台不会转base64</li>
</ul>
<h1 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="#搭建开发环境"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#搭建开发环境">#</a>搭建开发环境</h1><h2 id="集成scss-sass编译"><a href="#集成scss-sass编译" class="headerlink" title="#集成scss/sass编译"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#集成scss-sass编译">#</a>集成scss/sass编译</h2><p>为了方便编写样式（例如<code>&lt;style lang=&quot;scss&quot;&gt;</code>），建议大家安装<code>sass/scss编译</code>插件，插件的下载地址：<a target="_blank" rel="noopener" href="https://ext.dcloud.net.cn/plugin?name=compile-node-sass">scss/sass编译(opens new window)</a></p>
<p><img src="uniapp.assets/image-20210419163056984.8ea29f1f.png" alt="image-20210419163056984"></p>
<p>登录账号 -&gt; 无账号，即注册（邮箱验证） -&gt; 再次点击安装插件 -&gt; 打开HBuilderX</p>
<h2 id="自定义主题、快捷键等"><a href="#自定义主题、快捷键等" class="headerlink" title="#自定义主题、快捷键等"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#自定义主题、快捷键等">#</a>自定义主题、快捷键等</h2><ol>
<li>快捷键切换</li>
</ol>
<p>在<code>工具 -&gt; 预设快捷键方案切换</code> 中可以切换自己喜欢的快捷键方案，对HBuilderX进行自定义：</p>
<p><img src="uniapp.assets/image-20210419163655412.cd023f65.png" alt="image-20210419163655412"></p>
<ol>
<li>设置主题</li>
</ol>
<p><img src="uniapp.assets/image-20210419163851076.d0d9fcc5.png" alt="image-20210419163851076"></p>
<ol>
<li>字号设置</li>
</ol>
<p>macOS的快捷键是 <code>Command + ,</code>，windows的快捷键是<code>Ctrl + ,</code></p>
<p><img src="uniapp.assets/image-20210419164115182.daa3ac9b.png" alt="image-20210419164115182"></p>
<p>常见配置：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;editor.colorScheme&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Default&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.fontFamily&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Consolas&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.fontSize&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.insertSpaces&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.lineHeight&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.5&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.mouseWheelZoom&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.onlyHighlightWord&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.tabSize&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.wordWrap&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.codeassist.px2rem.enabel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;editor.codeassist.px2upx.enabel&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<h2 id="创建项目"><a href="#创建项目" class="headerlink" title="#创建项目"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#创建项目">#</a>创建项目</h2><h3 id="使用HBuilderX"><a href="#使用HBuilderX" class="headerlink" title="#使用HBuilderX"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#使用hbuilderx">#</a>使用HBuilderX</h3><p>步骤：</p>
<ul>
<li><p>下载HBuilderX：<a target="_blank" rel="noopener" href="https://www.dcloud.io/hbuilderx.html">官方IDE下载地址 (opens new window)</a>——建议使用标准版本</p>
<blockquote>
<p>HBuilderX标准版可直接用于web开发、markdown、字处理场景。做App仍需要安装插件。</p>
<p>App开发版预置了App/uni-app开发所需的插件，开箱即用。</p>
<p>标准版也可以在插件安装界面安装App开发所需插件，App开发版只是一个预集成作用。</p>
<p>App开发插件体积大的原因主要有2方面：</p>
<ol>
<li>真机运行基座，Android版、iOS版、iOS模拟器版，加起来体积就1百多M。真机运行基座需要把所有模块都内置进去，方便大家开发调试。开发者自己做app打包是不会这么大的，因为可以在manifest里选模块来控制体积。</li>
<li>uni-app的编译器，依赖webpack和各种node模块，node_modules就是这么一个生态现状，文件超级多，几万个文件，解压起来很慢。</li>
</ol>
</blockquote>
</li>
<li><p>在点击工具栏里的文件 -&gt; 新建 -&gt; 项目：</p>
<p><img src="uniapp.assets/b925a1c0-4f19-11eb-97b7-0dc4655d6e68.0528b5af.png" alt="img"></p>
</li>
<li><p>选择<code>uni-app</code>类型，输入工程名，选择模板，点击创建，即可成功创建。</p>
<p><img src="uniapp.assets/image-20210419161501579.57b59a7b.png" alt="image-20210419161501579"></p>
</li>
<li><p>在微信开发者工具里运行：进入hello-uniapp项目，点击工具栏的运行 -&gt; 运行到小程序模拟器 -&gt; 微信开发者工具，即可在微信开发者工具里面体验uni-app。</p>
<p> <img src="uniapp.assets/d89fd6f0-4f1a-11eb-97b7-0dc4655d6e68.627f3d67.png" alt="img"></p>
<p>第一次运行的提示：</p>
<p><img src="uniapp.assets/image-20210419170249359.6b82ec00.png" alt="image-20210419170249359"></p>
<p>成功运行：</p>
<p><img src="uniapp.assets/image-20210419170454810.8b9f0528.png" alt="image-20210419170454810"></p>
<p><strong>注意：</strong></p>
<ul>
<li><p>如果是第一次使用，需要先配置小程序ide的相关路径，才能运行成功。如下图，需在输入框输入微信开发者工具的安装路径，uni-app默认把项目编译到根目录的unpackage目录。</p>
<p><img src="uniapp.assets/image-20210419171415089.8ee56032.png" alt="image-20210419171415089"></p>
</li>
<li><p>若HBuilderX不能正常启动微信开发者工具，需要开发者手动启动，然后将uni-app生成小程序工程的路径拷贝到微信开发者工具里面，在HBuilderX里面开发，在微信开发者工具里面就可看到实时的效果。</p>
</li>
<li><p>如果提示<code>[error] 工具的服务端口已关闭。要使用命令行调用工具，请在下方输入 y 以确认开启，或手动打开工具 -&gt; 设置 -&gt; 安全设置，将服务端口开启</code>，如图：</p>
<p><img src="uniapp.assets/image-20210419170330616.ed49854b.png" alt="image-20210419170330616"></p>
<p>微信开发者工具设置菜单，安全中打开服务端口：</p>
<p><img src="uniapp.assets/image-20210419165932479.6a975e1a.png" alt="image-20210419165932479"></p>
</li>
</ul>
</li>
</ul>
<h3 id="使用vue-cli命令行-VSCode"><a href="#使用vue-cli命令行-VSCode" class="headerlink" title="#使用vue-cli命令行(VSCode)"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#使用vue-cli命令行-vscode">#</a>使用vue-cli命令行(VSCode)</h3><ol>
<li>初始化项目</li>
</ol>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">// 全局安装 vue-cli 3.x（如已安装请跳过此步骤）<br>npm install -g @vue/cli<br><br>// 通过 CLI 创建 uni-app 项目<br>vue create -p dcloudio/uni-preset-vue my-project<br></code></pre></td></tr></table></figure>
<p><img src="uniapp.assets/1190eb9efa120f8db46d2aa81773a8a8.ca422b25.png" alt="img"></p>
<ol>
<li>安装组件语法提示</li>
</ol>
<p>组件语法提示是uni-app的亮点，其他框架很少能提供。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">npm i @dcloudio/uni-helper-json<br></code></pre></td></tr></table></figure>
<p>如果是HBuilderX的项目，可以使用</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">npm i @types/uni-app @types/html5plus -D<br></code></pre></td></tr></table></figure>
<p>另外，uni-app 项目下的 manifest.json、pages.json 等文件可以包含注释。vscode 里需要改用 jsonc 编辑器打开。</p>
<h3 id="配置AppID"><a href="#配置AppID" class="headerlink" title="#配置AppID"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#配置appid">#</a>配置AppID</h3><p><img src="uniapp.assets/image-20210419171015789.c41b33ae.png" alt="image-20210419171015789"></p>
<h2 id="ESLint与代码格式化"><a href="#ESLint与代码格式化" class="headerlink" title="#ESLint与代码格式化"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#eslint与代码格式化">#</a>ESLint与代码格式化</h2><p>TIP</p>
<p>ESLint与代码保存即自动格式化，仅在VSCode上有效</p>
<h3 id="使用第三方npm包"><a href="#使用第三方npm包" class="headerlink" title="#使用第三方npm包"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#使用第三方npm包">#</a>使用第三方npm包</h3><p>uni-app支持使用<strong>npm</strong>安装第三方包。</p>
<p>此文档要求开发者们对<strong>npm</strong>有一定的了解，因此不会再去介绍<strong>npm</strong>的基本功能。如若之前未接触过<strong>npm</strong>，请翻阅<a target="_blank" rel="noopener" href="https://docs.npmjs.com/getting-started/what-is-npm">NPM官方文档 (opens new window)</a>进行学习。</p>
<p><strong>1. 初始化npm工程</strong></p>
<p>若项目之前未使用npm管理依赖（项目根目录下无package.json文件），先在项目根目录执行命令初始化npm工程：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">npm init -y<br></code></pre></td></tr></table></figure>
<p>cli项目默认已经有package.json了。HBuilderX创建的项目默认没有，需要通过初始化命令来创建。</p>
<p><strong>2. 安装依赖</strong></p>
<p>在项目根目录执行命令安装npm包：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">npm install packageName --save<br></code></pre></td></tr></table></figure>
<p><strong>3. 使用</strong></p>
<p>安装完即可使用npm包，js中引入npm包：</p>
<p>TIP</p>
<ul>
<li>为多端兼容考虑，建议优先从 <a target="_blank" rel="noopener" href="https://ext.dcloud.net.cn/">uni-app插件市场 (opens new window)</a>获取插件。直接从 npm 下载库很容易只兼容H5端。</li>
<li>非 H5 端不支持使用含有 dom、window 等操作的 vue 组件和 js 模块，安装的模块及其依赖的模块使用的 API 必须是 uni-app 已有的 <a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/api/README">API (opens new window)</a>（兼容小程序 API），比如：支持<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/amap-wx">高德地图微信小程序 SDK (opens new window)</a>。类似<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jquery">jQuery (opens new window)</a>等库只能用于H5端。</li>
<li>node_modules 目录必须在项目根目录下。不管是cli项目还是HBuilderX创建的项目。</li>
<li>支持安装 mpvue 组件，但npm方式不支持小程序自定义组件（如 wxml格式的vant-weapp），使用小程序自定义组件请参考：<a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/frame?id=小程序组件支持">小程序组件支持 (opens new window)</a>。</li>
<li>关于ui库的获取，详见<a target="_blank" rel="noopener" href="https://ask.dcloud.net.cn/article/35489">多端UI库(opens new window)</a></li>
</ul>
<h3 id="初始化ESLint"><a href="#初始化ESLint" class="headerlink" title="#初始化ESLint"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#初始化eslint">#</a>初始化ESLint</h3><figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text"># 初始化npm包管理<br>npm init -y<br><br># 安装eslint依赖<br>npm i -D eslint eslint-config-standard eslint-plugin-import eslint-plugin-node eslint-plugin-promise eslint-plugin-vue<br></code></pre></td></tr></table></figure>
<p>package.json文件配置如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;devDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;eslint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^7.24.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eslint-config-standard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^16.0.2&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eslint-plugin-import&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^2.22.1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eslint-plugin-node&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^11.1.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eslint-plugin-promise&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^4.3.1&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eslint-plugin-vue&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^7.8.0&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>新建 两个文件，<code>.eslintrc.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">env</span>: &#123;<br>    <span class="hljs-attr">browser</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">commonjs</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">es2021</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">node</span>: <span class="hljs-literal">true</span><br>  &#125;,<br>  <span class="hljs-attr">extends</span>: [<span class="hljs-string">&#x27;eslint:recommended&#x27;</span>, <span class="hljs-string">&#x27;standard&#x27;</span>, <span class="hljs-string">&#x27;plugin:vue/essential&#x27;</span>],<br>  <span class="hljs-attr">parserOptions</span>: &#123;<br>    <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">12</span><br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">&#x27;vue&#x27;</span>],<br>  <span class="hljs-attr">rules</span>: &#123;<br>    <span class="hljs-comment">// 这里有一些自定义配置</span><br>    <span class="hljs-string">&#x27;no-console&#x27;</span>: [<br>      <span class="hljs-string">&#x27;warn&#x27;</span>,<br>      &#123;<br>        <span class="hljs-attr">allow</span>: [<span class="hljs-string">&#x27;warn&#x27;</span>, <span class="hljs-string">&#x27;error&#x27;</span>]<br>      &#125;<br>    ],<br>    <span class="hljs-string">&#x27;no-eval&#x27;</span>: <span class="hljs-string">&#x27;error&#x27;</span>,<br>    <span class="hljs-string">&#x27;no-alert&#x27;</span>: <span class="hljs-string">&#x27;error&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">globals</span>: &#123;<br>    <span class="hljs-attr">uni</span>: <span class="hljs-string">&#x27;readonly&#x27;</span>,<br>    <span class="hljs-attr">plus</span>: <span class="hljs-string">&#x27;readonly&#x27;</span>,<br>    <span class="hljs-attr">wx</span>: <span class="hljs-string">&#x27;readonly&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>创建<code>.eslintignore</code>文件：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">node_modules<br>.hbuilderx<br>static<br>uni_modules<br>unpackage<br></code></pre></td></tr></table></figure>
<h3 id="配置vscode自动修复功能"><a href="#配置vscode自动修复功能" class="headerlink" title="#配置vscode自动修复功能"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#配置vscode自动修复功能">#</a>配置vscode自动修复功能</h3><p>安装<code>vetur</code>、<code>eslint</code>插件</p>
<p>打开vscode的首选项配置，<code>settings.json</code>文件</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-comment">// ... 你自己的配置</span><br>  <span class="hljs-attr">&quot;editor.codeActionsOnSave&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;source.fixAll.eslint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eslint.format.enable&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-comment">//autoFix默认开启，只需输入字符串数组即可</span><br>  <span class="hljs-attr">&quot;eslint.validate&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;javascript&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;vue&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;html&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br><br>  <span class="hljs-comment">// 关闭vue文件的自动格式化工具, vetur，使用eslint</span><br>  <span class="hljs-attr">&quot;[vue]&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  	<span class="hljs-attr">&quot;editor.defaultFormatter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;octref.vetur&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><br>  <span class="hljs-attr">&quot;vetur.format.defaultFormatter.ts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;vetur.format.defaultFormatter.js&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;none&quot;</span><span class="hljs-punctuation">,</span><br><br>  <span class="hljs-comment">// ... </span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<h2 id="下载官方代码提示"><a href="#下载官方代码提示" class="headerlink" title="#下载官方代码提示"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/01-搭建开发环境.html#下载官方代码提示">#</a>下载官方代码提示</h2><p>点击 <a target="_blank" rel="noopener" href="https://github.com/zhetengbiji/uniapp-snippets-vscode">下载地址 (opens new window)</a>，放到项目目录下的 .vscode 目录即可拥有和 HBuilderX 一样的代码块。</p>
<p><img src="uniapp.assets/d39d378c0821a67c8bf72c7965833378.436a861e.png" alt="img"></p>
<h1 id="首页模块"><a href="#首页模块" class="headerlink" title="#首页模块"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#首页模块">#</a>首页模块</h1><h2 id="首页tabBar"><a href="#首页tabBar" class="headerlink" title="#首页tabBar"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#首页tabbar">#</a>首页tabBar</h2><h3 id="代码依赖分析"><a href="#代码依赖分析" class="headerlink" title="#代码依赖分析"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#代码依赖分析">#</a>代码依赖分析</h3><p>可以在基本信息中选择代码依赖分析</p>
<p><img src="uniapp.assets/image-20210428193747590.a3e78cc2.png" alt="img"></p>
<p>查看本地代码与分包大小：</p>
<p><img src="uniapp.assets/image-20210428193958813.de26ed19.png" alt="img"></p>
<h3 id="导入静态资源-1"><a href="#导入静态资源-1" class="headerlink" title="#导入静态资源"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#导入静态资源">#</a>导入静态资源</h3><ul>
<li>删除原<code>static</code>目录中的文件；</li>
<li>下载课程的静态资源文件夹，并放置于<code>static</code>的<code>images</code>目录中。</li>
</ul>
<h3 id="布局与样式"><a href="#布局与样式" class="headerlink" title="#布局与样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#布局与样式">#</a>布局与样式</h3><p>完成效果：</p>
<p><img src="uniapp.assets/image-20210428194953556.b102bed2.png" alt="img"></p>
<p>创建tabBar的步骤：</p>
<ul>
<li>创建tabBar对应的页面；</li>
<li>修改pages.json中的配置项：<code>pages</code>和<code>tabBar</code></li>
</ul>
<p>创建页面HBuilderx方式：</p>
<p><img src="uniapp.assets/image-20210419173303417.abf903c9.png" alt="img"></p>
<p>创建页面的VSCode插件方式：</p>
<p><img src="uniapp.assets/image-20210428194346415.a9dc6d4b.png" alt="image-20210428194346415"></p>
<p>快速创建4个页面</p>
<p><img src="uniapp.assets/image-20210428194614781.39a556bc.png" alt="image-20210428194614781"></p>
<p>并调整<code>pages.json</code>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/home/home&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/msg/msg&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/hot/hot&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/center/center&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><br>	<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;globalStyle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;navigationBarTextStyle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;black&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;navigationBarTitleText&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;uni-app&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;navigationBarBackgroundColor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#F8F8F8&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;backgroundColor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#F8F8F8&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;app-plus&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;background&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#efeff4&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><br>	<span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>新建tabBar属性：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;tabBar&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;color&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#999&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;backgroundColor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#fafafa&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;selectedColor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;#02D199&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;borderStyle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;white&quot;</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;list&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;首页&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;pagePath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/home/home&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;iconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_home_no.png&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;selectedIconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_home_yes.png&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;消息&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;pagePath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/msg/msg&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;iconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_news_no.png&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;selectedIconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_news_yes.png&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;热门&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;pagePath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/hot/hot&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;iconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_popular_no.png&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;selectedIconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_popular_yes.png&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-punctuation">&#123;</span><br>			<span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;我的&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;pagePath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pages/center/center&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;iconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_my_no.png&quot;</span><span class="hljs-punctuation">,</span><br>			<span class="hljs-attr">&quot;selectedIconPath&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;static/images/tab_my_yes.png&quot;</span><br>		<span class="hljs-punctuation">&#125;</span><br>	<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>	<span class="hljs-attr">&quot;position&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bottom&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>配置package.json中的eslint修复命令：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">&quot;lint&quot;: &quot;eslint --ext vue --ext js pages --fix&quot;<br></code></pre></td></tr></table></figure>
<p>底部的阴影：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;view class=&quot;bottom-line&quot;&gt;&lt;/view&gt;<br><br>&lt;style lang=&quot;scss&quot;&gt;<br>.bottom-line &#123;<br>  position: fixed;<br>  bottom: -5px;<br>  left: 0;<br>  width: 100vw;<br>  height: 5px;<br>  background: transparent;<br>  box-shadow: 0 -5px 5px rgba(0, 0, 0, 0.05);<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h3 id="导入uView-UI"><a href="#导入uView-UI" class="headerlink" title="#导入uView UI"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#导入uview-ui">#</a>导入uView UI</h3><p>准备工作</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 安装sass依赖</span><br>npm i node-sass sass-loader@<span class="hljs-number">10</span> -D<br><br><span class="hljs-comment">// 安装uView</span><br>npm install uview-ui<br></code></pre></td></tr></table></figure>
<p>在<code>main.js</code>中引入：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">import uView from &#x27;uview-ui&#x27;<br>Vue.use(uView)<br></code></pre></td></tr></table></figure>
<p>在项目根目录的<code>uni.scss</code>中引入样式文件：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-comment">/* uni.scss */</span><br><span class="hljs-keyword">@import</span> <span class="hljs-string">&#x27;uview-ui/theme.scss&#x27;</span>;<br></code></pre></td></tr></table></figure>
<p>调整<code>App.vue</code>的样式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;style lang=&quot;scss&quot;&gt;<br>/* 注意要写在第一行，同时给style标签加入lang=&quot;scss&quot;属性 */<br>@import &quot;uview-ui/index.scss&quot;;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>配置<code>pages.json</code>：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// ....</span><br><span class="hljs-attr">&quot;easycom&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>	<span class="hljs-attr">&quot;^u-(.*)&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;uview-ui/components/u-$1/u-$1.vue&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<h2 id="首页Tabs"><a href="#首页Tabs" class="headerlink" title="#首页Tabs"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#首页tabs">#</a>首页Tabs</h2><h3 id="布局与样式-1"><a href="#布局与样式-1" class="headerlink" title="#布局与样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#布局与样式-2">#</a>布局与样式</h3><p><code>home.vue</code>添加tabs</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;u-tabs ref=&quot;uTabs&quot; :is-scroll=&quot;true&quot; active-color=&quot;#02D199&quot; height=&quot;88&quot; gutter=&quot;50&quot;&gt;&lt;/u-tabs&gt;<br></code></pre></td></tr></table></figure>
<p>添加tabs数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;u-tabs ref=&quot;uTabs&quot; :list=&quot;tabs&quot; :name=&quot;&#x27;value&#x27;&quot; :current=&quot;current&quot; :is-scroll=&quot;true&quot; active-color=&quot;#02D199&quot; height=&quot;88&quot; gutter=&quot;50&quot;&gt;&lt;/u-tabs&gt;<br>&lt;script&gt;<br>  export default &#123;<br>  data: () =&gt; (&#123;<br>    tabs: [<br>      &#123;<br>        key: &#x27;&#x27;,<br>        value: &#x27;首页&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;ask&#x27;,<br>        value: &#x27;提问&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;share&#x27;,<br>        value: &#x27;分享&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;discuss&#x27;,<br>        value: &#x27;讨论&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;advise&#x27;,<br>        value: &#x27;建议&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;advise&#x27;,<br>        value: &#x27;公告&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;advise&#x27;,<br>        value: &#x27;动态&#x27;<br>      &#125;<br>    ],<br>    // 因为内部的滑动机制限制，请将tabs组件和swiper组件的current用不同变量赋值<br>    current: 0, // tabs组件的current值，表示当前活动的tab选项<br>    swiperCurrent: 0, // swiper组件的current值，表示当前那个swiper-item是活动的<br>  &#125;)<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<p>完成效果</p>
<p><img src="uniapp.assets/image-20210526225831609.c1003bc6.png" alt="image-20210526225831609"></p>
<h3 id="添加事件"><a href="#添加事件" class="headerlink" title="#添加事件"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#添加事件">#</a>添加事件</h3><p>tabs添加切换事件<code>tabsChange</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;u-tabs ref=&quot;uTabs&quot; :list=&quot;tabs&quot; :name=&quot;&#x27;value&#x27;&quot; :current=&quot;current&quot; @change=&quot;tabsChange&quot; :is-scroll=&quot;true&quot; active-color=&quot;#02D199&quot; height=&quot;88&quot; gutter=&quot;50&quot;&gt;&lt;/u-tabs&gt;<br><br>&lt;script&gt;<br>	export default &#123;<br>    ...<br>    methods: &#123;<br>      // tabs通知swiper切换<br>      tabsChange (index) &#123;<br>        this.current = index<br>      &#125;<br>    &#125;<br>  &#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<h2 id="接口封装"><a href="#接口封装" class="headerlink" title="#接口封装"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#接口封装">#</a>接口封装</h2><p>问题：小程序原生提供了request请求，但是是callback的使用方式，并不支持Promise，见<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html">链接 (opens new window)</a>。</p>
<p><img src="uniapp.assets/image-20210714162901877.3807c355.png" alt="image-20210714162901877"></p>
<p>需求：我们前端里面写网络请求，习惯了Axios + async/await的书写风格，那在小程序中怎么去实现接口请求的封装呢？</p>
<p>拆分需求：</p>
<ul>
<li>Promise化 -&gt; async/await支持</li>
<li>接口请求封装<ul>
<li>拦截器</li>
<li>统一错误处理</li>
<li>取消重复请求</li>
<li>..</li>
</ul>
</li>
</ul>
<h3 id="小程序API-Promise化"><a href="#小程序API-Promise化" class="headerlink" title="#小程序API Promise化"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#小程序api-promise化">#</a>小程序API Promise化</h3><p>扩展微信小程序api支持promise</p>
<p>首先，本地小程序npm初始化</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">npm init -y<br><br>// 安装依赖包<br>npm install --save miniprogram-api-promise<br></code></pre></td></tr></table></figure>
<p>在小程序入口（app.js）调用一次promisifyAll，只需要调用一次。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; promisifyAll, promisify &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;miniprogram-api-promise&#x27;</span>;<br><br><span class="hljs-keyword">const</span> wxp = &#123;&#125;<br><span class="hljs-comment">// promisify all wx&#x27;s api</span><br><span class="hljs-title function_">promisifyAll</span>(wx, wxp)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(wxp.<span class="hljs-title function_">getSystemInfoSync</span>())<br>wxp.<span class="hljs-title function_">getSystemInfo</span>().<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)<br>wxp.<span class="hljs-title function_">showModal</span>().<span class="hljs-title function_">then</span>(wxp.<span class="hljs-title function_">openSetting</span>())<br><br><span class="hljs-comment">// compatible usage</span><br>wxp.<span class="hljs-title function_">getSystemInfo</span>(&#123;<span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) &#123;<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)&#125;&#125;)<br><br><span class="hljs-comment">// promisify single api</span><br><span class="hljs-title function_">promisify</span>(wx.<span class="hljs-property">getSystemInfo</span>)().<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)<br></code></pre></td></tr></table></figure>
<p>建议的写法：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">import &#123; promisifyAll, promisify &#125; from &#x27;miniprogram-api-promise&#x27;;<br><br>const wx.p = &#123;&#125;<br><br>promisifyAll(wx, wx.p)<br><br>// 全局使用wx.p<br>wx.p.getSystemInfo().then(console.log)<br></code></pre></td></tr></table></figure>
<p>async/await支持的方法比较简单：开户<code>将 JS 代码编译成 ES5</code>即可：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/codecompile.html">链接(opens new window)</a></p>
<blockquote>
<p>在工具 1.05.2106091 版本之后，原有的<code>ES6 转 ES5</code> 和 <code>增强编译</code> 选项统一合并为<code>将 JS 代码编译成 ES5</code>，此功能和原有的<code>增强编译</code>逻辑一致。如需了解旧版本的文档，请<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/codecompile_old.html">点此查看 (opens new window)</a>。</p>
</blockquote>
<p>支持async/await语法，按需注入<code>regeneratorRuntime</code>，目录位置与辅助函数一致</p>
<p><img src="uniapp.assets/image-20210714164109331.812b4718.png" alt="image-20210714164109331"></p>
<p>平时开发的时候，一定要注意该选项有没有打开哦！！</p>
<h3 id="uniapp小程序请求封装"><a href="#uniapp小程序请求封装" class="headerlink" title="#uniapp小程序请求封装"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#uniapp小程序请求封装">#</a>uniapp小程序请求封装</h3><p>接口请求封装</p>
<ul>
<li>拦截器</li>
<li>统一错误处理</li>
<li>取消重复请求</li>
</ul>
<p>TIP</p>
<p>uniapp中已经支持Promise + async/await，但是，对于request请求的错误的处理需要自己来处理。</p>
<p>请求工具js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 这个文件我们使用uni.request进行封装</span><br><span class="hljs-comment">// 同样适合于原生小程序的request封装 -&gt; Promise API</span><br><br><span class="hljs-comment">// 需求分析</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">errorHandle</span> = (<span class="hljs-params">err</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (err.<span class="hljs-property">statusCode</span> === <span class="hljs-number">401</span>) &#123;<br>    <span class="hljs-comment">// todo 4.业务 —&gt; refreshToken -&gt; 请求响应401 -&gt; 刷新token</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 其他的错误</span><br>    <span class="hljs-comment">// showToast提示用户</span><br>    <span class="hljs-comment">// 3.对错误进行统一的处理 -&gt; showToast</span><br>    <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: &#123; msg &#125; &#125; = err<br>    uni.<span class="hljs-title function_">showToast</span>(&#123;<br>      <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>      <span class="hljs-attr">title</span>: msg || <span class="hljs-string">&#x27;请求异常，请重试&#x27;</span>,<br>      <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>    &#125;)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">request</span> = (<span class="hljs-params">options = &#123;&#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; success, fail &#125; = options<br>  <span class="hljs-comment">// 1.在头部请求的时候，token带上 -&gt; 请求拦截器</span><br>  <span class="hljs-keyword">const</span> publicArr = [<span class="hljs-regexp">/\/public/</span>, <span class="hljs-regexp">/\/login/</span>]<br>  <span class="hljs-comment">// local store -&gt; uni.getStorageSync(&#x27;token&#x27;)</span><br>  <span class="hljs-keyword">let</span> isPublic = <span class="hljs-literal">false</span><br>  publicArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> &#123;<br>    isPublic = isPublic || path.<span class="hljs-title function_">test</span>(options.<span class="hljs-property">url</span>)<br>  &#125;)<br>  <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&#x27;token&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (!isPublic &amp;&amp; token) &#123;<br>    options.<span class="hljs-property">header</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;,<br>      &#123;<br>        <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">&#x27;Bearer &#x27;</span> + token<br>      &#125;, options.<span class="hljs-property">header</span>)<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    uni.<span class="hljs-title function_">request</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;, options, &#123;<br>      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">// 响应拦截器</span><br>        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; res.<span class="hljs-property">statusCode</span> &lt; <span class="hljs-number">300</span>) &#123;<br>          <span class="hljs-keyword">if</span> (success &amp;&amp; <span class="hljs-keyword">typeof</span> success === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>            <span class="hljs-comment">// 2.在响应的时候，处理data数据</span><br>            <span class="hljs-title function_">success</span>(res.<span class="hljs-property">data</span>)<br>            <span class="hljs-keyword">return</span><br>          &#125;<br>          <span class="hljs-comment">// 请求成功</span><br>          <span class="hljs-comment">// 2.在响应的时候，处理data数据</span><br>          <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">data</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// 请求失败</span><br>          <span class="hljs-title function_">errorHandle</span>(res)<br>          <span class="hljs-title function_">reject</span>(res)<br>        &#125;<br>      &#125;,<br>      <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (fail &amp;&amp; <span class="hljs-keyword">typeof</span> fail === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>          <span class="hljs-title function_">fail</span>(err)<br>          <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-title function_">errorHandle</span>(err)<br>        <span class="hljs-title function_">reject</span>(err)<br>      &#125;<br>    &#125;))<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="uview中请求封装"><a href="#uview中请求封装" class="headerlink" title="#uview中请求封装"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#uview中请求封装">#</a>uview中请求封装</h3><p>工作原理：</p>
<p>uView提供了 http封装：</p>
<p>平台差异说明</p>
<table>
<thead>
<tr>
<th style="text-align:center">App</th>
<th style="text-align:center">H5</th>
<th style="text-align:center">微信小程序</th>
<th style="text-align:center">支付宝小程序</th>
<th style="text-align:center">百度小程序</th>
<th style="text-align:center">头条小程序</th>
<th style="text-align:center">QQ小程序</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
<td style="text-align:center">√</td>
</tr>
</tbody>
</table>
<p>由于某些小程序平台的限制：</p>
<ul>
<li>delete请求，不支持支付宝和头条小程序(HX2.6.15)</li>
<li>put请求，不支持支付宝小程序(HX2.6.15)</li>
</ul>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">语法：<br><br>get | post | put | delete(url, params, header).then(res =&gt; &#123;&#125;).catch(res =&gt; &#123;&#125;)<br></code></pre></td></tr></table></figure>
<ul>
<li><code>url&lt;String&gt;</code> 请求的URL，可以完整的URL(http开头)，或者是路径的一部分，这时会自动拼接上<code>baseUrl</code>(一般为api的域名部分)</li>
<li><code>params&lt;Object&gt;</code> 请求的参数，对象形式，如<code>&quot;&#123;name: &#39;lisa&#39;, age: 23&#125;&quot;</code>，该参数是可选的</li>
<li><code>header &lt;Object&gt;</code> 请求的header，对象形式，如果token等字段，建议通过配置写入，该参数是可选的<code>get</code>和<code>post</code>都挂载在<code>$u</code>对象下，其中<code>get</code>和<code>post</code>使用方法完全一致，只是一个为<code>this.$u.get</code></li>
</ul>
<p>但是如果直接按照上面的写会报错，由于没有设置baseURL： <img src="uniapp.assets/image-20210716134642927.6c997f5f.png" alt="image-20210716134642927"></p>
<p>官方文档也有说明：</p>
<p><img src="uniapp.assets/image-20210716134734477.4f953221.png" alt="image-20210716134734477"></p>
<p>设置baseURL的方法：配置参数的时候，需要调用<code>$u.http.setConfig()</code>，打开<code>main.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">setConfig</span>(&#123;<br>  <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">&#x27;http://localhost:3000&#x27;</span><br>&#125;)<br></code></pre></td></tr></table></figure>
<p>修改接口：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/public/getCaptcha?sid=123123123&#x27;</span><br>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;err&#x27;</span>, err)<br>&#125;)<br></code></pre></td></tr></table></figure>
<p>然后就可以正常的请求了：</p>
<p><img src="uniapp.assets/image-20210716134858589.a1e4dff2.png" alt="image-20210716134858589"></p>
<p>uview对于拦截器（请求/响应）的支持：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">http</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">request</span> = <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;config)</span><br><span class="hljs-string">  return config</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Vue.prototype.$u.http.interceptor.response = (data) =&gt; &#123;</span><br><span class="hljs-string">  console.log(&#x27;</span>data)<br>  <span class="hljs-keyword">return</span> data<br>&#125;<br></code></pre></td></tr></table></figure>
<p>请求封装：</p>
<p><code>config.js</code>配置文件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// export const baseUrl = &#x27;https://mp.toimc.com&#x27;</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> baseUrl =<br>  process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span><br>    ? <span class="hljs-string">&#x27;http://localhsot:3000&#x27;</span><br>    : <span class="hljs-string">&#x27;https://mp.toimc.com&#x27;</span><br></code></pre></td></tr></table></figure>
<p><code>common/request.js</code>文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// console.log(process.env)</span><br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store&#x27;</span><br><span class="hljs-keyword">import</span> &#123; authNav &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/common/checkAuth&#x27;</span><br><span class="hljs-keyword">import</span> &#123; baseUrl &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/config&#x27;</span><br><span class="hljs-keyword">import</span> &#123; simpleHttp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/common/utils/simple-http&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = &#123;<br>  <span class="hljs-attr">baseUrl</span>: baseUrl, <span class="hljs-comment">// 请求的本域名</span><br>  <span class="hljs-comment">// baseUrl: &#x27;https://mp.toimc.com&#x27;, // 请求的本域名</span><br>  <span class="hljs-comment">// 设置为json，返回后会对数据进行一次JSON.parse()</span><br>  <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,<br>  <span class="hljs-attr">showLoading</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否显示请求中的loading</span><br>  <span class="hljs-attr">loadingText</span>: <span class="hljs-string">&#x27;请求中...&#x27;</span>, <span class="hljs-comment">// 请求loading中的文字提示</span><br>  <span class="hljs-attr">loadingTime</span>: <span class="hljs-number">800</span>, <span class="hljs-comment">// 在此时间内，请求还没回来的话，就显示加载中动画，单位ms</span><br>  <span class="hljs-attr">originalData</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否在拦截器中返回服务端的原始数据</span><br>  <span class="hljs-attr">loadingMask</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 展示loading的时候，是否给一个透明的蒙层，防止触摸穿透</span><br>  <span class="hljs-comment">// 配置请求头信息</span><br>  <span class="hljs-attr">header</span>: &#123;<br>    <span class="hljs-string">&#x27;content-type&#x27;</span>: <span class="hljs-string">&#x27;application/json;charset=UTF-8&#x27;</span><br>  &#125;,<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">install</span> = (<span class="hljs-params">Vue</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> http = <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">http</span><br>  http.<span class="hljs-title function_">setConfig</span>(config)<br><br>  http.<span class="hljs-property">interceptor</span>.<span class="hljs-property">request</span> = <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> isPublic = <span class="hljs-literal">false</span><br>    <span class="hljs-keyword">const</span> publicPath = [<span class="hljs-regexp">/^\/public/</span>, <span class="hljs-regexp">/^\/login/</span>]<br>    publicPath.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> &#123;<br>      isPublic = isPublic || path.<span class="hljs-title function_">test</span>(config.<span class="hljs-property">url</span>)<br>    &#125;)<br>    <span class="hljs-keyword">const</span> token = store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span><br>    <span class="hljs-comment">// if (token) &#123;</span><br>    <span class="hljs-keyword">if</span> (!isPublic &amp;&amp; token) &#123;<br>      config.<span class="hljs-property">header</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">&#x27;Bearer &#x27;</span> + token<br>    &#125;<br>    <span class="hljs-keyword">return</span> config<br>    <span class="hljs-comment">// 如果return一个false值，则会取消本次请求</span><br>    <span class="hljs-comment">// if(config.url == &#x27;/user/rest&#x27;) return false; // 取消某次请求</span><br>  &#125;<br><br>  http.<span class="hljs-property">interceptor</span>.<span class="hljs-property">response</span> = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> data<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  install<br>&#125;<br></code></pre></td></tr></table></figure>
<p>问题是如何进行统一的错误处理？</p>
<ul>
<li>uview-ui的http工具类没有错误的统一处理</li>
<li>统一的错误处理的应用场景：401跳转到鉴权、给用户友好提示、refreshToken的场景</li>
</ul>
<p>具体做法，修改uview的源码，并把uview的代码移动到项目的代码中，利用hbuilder&amp;uniapp的按需加载，按需打包的机制，使用uview中的组件。</p>
<p>步骤：</p>
<ul>
<li><p>复制<code>node_modules</code>中的<code>uview-ui</code>到项目的根目录；</p>
</li>
<li><p>删除<code>package.json</code>中的<code>dependencies</code></p>
</li>
<li><p>修改pages.json中的<code>easycom</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;easycom&quot;</span>: &#123;<br>	<span class="hljs-string">&quot;^u-(.*)&quot;</span>: <span class="hljs-string">&quot;@/uview-ui/components/u-$1/u-$1.vue&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>修改main.js中的引入 ：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> uView <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./uview-ui&#x27;</span><br></code></pre></td></tr></table></figure>
<p><code>uni.scss</code>中的引入 ：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/* uni.scss */</span><br>@<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;./uview-ui/theme.scss&quot;</span>;<br></code></pre></td></tr></table></figure>
<p>还有App.vue中的引入 ：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/* 注意要写在第一行，同时给style标签加入lang=&quot;scss&quot;属性 */</span><br>@<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;./uview-ui/index.scss&quot;</span>;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="合并uview请求"><a href="#合并uview请求" class="headerlink" title="#合并uview请求"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#合并uview请求">#</a>合并uview请求</h3><p>目的：</p>
<ul>
<li>动态引入 API 接口</li>
<li>统一所有的请求的使用方式 <code>this.$u.api.接口</code></li>
</ul>
<p>思路：</p>
<ul>
<li>使用<code>require.context</code>动态引入api接口</li>
<li>使用插件的方式，在Vue.prototype.$u来添加api属性</li>
</ul>
<p>目录结构：</p>
<p><img src="uniapp.assets/image-20210717223433286.90a35ff7.png" alt="img"></p>
<p>其中<code>index.js</code>代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> req = <span class="hljs-built_in">require</span>.<span class="hljs-title function_">context</span>(<span class="hljs-string">&#x27;./modules&#x27;</span>, <span class="hljs-literal">false</span>, <span class="hljs-regexp">/\.js$/</span>)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">install</span> = (<span class="hljs-params">Vue</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> api = <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span> || &#123;&#125;<br>  req.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-title function_">req</span>(item)<br>    <span class="hljs-comment">// 1.取得所有的方法 -&gt; key值,</span><br>    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">module</span>)<br>    keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> &#123;<br>      api = &#123;<br>        ...api,<br>        <span class="hljs-comment">// 2.取得所有方法对应的function -&gt; value值</span><br>        <span class="hljs-comment">// 3.把上面的对象 -&gt; $u.api</span><br>        [key]: <span class="hljs-variable language_">module</span>[key]<br>      &#125;<br>    &#125;)<br>    <span class="hljs-comment">// 4.把它封装成为一个插件，以便在后面的方法中使用 this.$u.api.方法名(参数).then(res) ....</span><br>  &#125;)<br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span> = api<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  install<br>&#125;<br></code></pre></td></tr></table></figure>
<p>修改<code>main.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> apis <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/api&#x27;</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(apis)<br></code></pre></td></tr></table></figure>
<h2 id="内容列表"><a href="#内容列表" class="headerlink" title="#内容列表"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#内容列表">#</a>内容列表</h2><p>测试图片地址：<a target="_blank" rel="noopener" href="https://toimc-public.obs.cn-east-3.myhuaweicloud.com/1322928787@qq.com/2021-05-30/107382e7-024d-45ad-a4f4-c5df8a40e91f-tmp_40bdb731a1cae24e217376f9473ed92c.jpg">链接(opens new window)</a></p>
<h3 id="布局与样式-2"><a href="#布局与样式-2" class="headerlink" title="#布局与样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#布局与样式-3">#</a>布局与样式</h3><p>添加<code>list-item</code>组件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;list-item&quot;&gt;<br>    &lt;view class=&quot;list-head&quot;&gt;<br>      &lt;!-- 标题部分 --&gt;<br>      &lt;text class=&quot;type&quot; :class=&quot;[&#x27;type-&#x27;+item.catalog]&quot;&gt;&#123;&#123;tabs.filter(o =&gt; o.key === item.catalog)[0].value&#125;&#125;&lt;/text&gt;<br>      &lt;text class=&quot;title&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/text&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 用户部分 --&gt;<br>    &lt;view class=&quot;author u-flex u-m-b-18&quot;&gt;<br>      &lt;u-image :src=&quot;item.uid.pic&quot; class=&quot;head&quot; width=&quot;40&quot; height=&quot;40&quot; shape=&quot;circle&quot; error-icon=&quot;/static/images/header.jpg&quot;&gt;&lt;/u-image&gt;<br>      &lt;text class=&quot;name u-m-l-10&quot;&gt;&#123;&#123;item.uid.name&#125;&#125;&lt;/text&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 摘要部分 + 右侧的图片 --&gt;<br>    &lt;view class=&quot;list-body u-m-b-30 u-flex u-col-top&quot;&gt;<br>      &lt;view class=&quot;info u-m-r-20 u-flex-1&quot;&gt;&#123;&#123;item.content&#125;&#125;&lt;/view&gt;<br>      &lt;image class=&quot;fmt&quot; :src=&quot;item.snapshot&quot; v-if=&quot;item.snapshot&quot; mode=&quot;aspectFill&quot; /&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 回复 + 文章发表的时间 --&gt;<br>    &lt;view class=&quot;list-footer u-flex&quot;&gt;<br>      &lt;view class=&quot;left&quot;&gt;<br>        &lt;text class=&quot;reply-num u-m-r-25&quot;&gt;&#123;&#123;item.answer&#125;&#125; 回复&lt;/text&gt;<br>        &lt;text class=&quot;timer&quot;&gt;&#123;&#123;item.created | moment&#125;&#125;&lt;/text&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; tabs &#125; from &#x27;@/config/const&#x27;<br>export default &#123;<br>  props: &#123;<br>    item: &#123;<br>      type: Object,<br>      default: () =&gt; (&#123;&#125;)<br>    &#125;<br>  &#125;,<br>  data: () =&gt; (&#123;<br>    tabs<br>  &#125;)<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.list-item &#123;<br>  background: #fff;<br>  margin-top: 20rpx;<br>  padding: 30rpx;<br>&#125;<br><br>.list-head &#123;<br>  margin-bottom: 18rpx;<br>  .type &#123;<br>    display: inline-block;<br>    height: 36rpx;<br>    width: 72rpx;<br>    text-align: center;<br>    line-height: 36rpx;<br>    white-space: nowrap;<br>    margin-right: 10rpx;<br>    font-size: 24rpx;<br>    border-radius: 18rpx;<br>    border-bottom-left-radius: 0;<br>    color: #fff;<br>    background-color: red;<br>    position: relative;<br>    top: -4rpx;<br>    transform: scale(0.9);<br>  &#125;<br>  .type-share &#123;<br>    background-color: #feb21e;<br>  &#125;<br>  .type-ask &#123;<br>    background-color: #02d199;<br>  &#125;<br>  .type-discuss &#123;<br>    background-color: #fe1e1e;<br>  &#125;<br>  .type-advise &#123;<br>    background-color: #0166f8;<br>  &#125;<br>  .type-notice &#123;<br>    background-color: #00a3b8;<br>  &#125;<br>  .type-logs &#123;<br>    background-color: #33cb61;<br>  &#125;<br>  .title &#123;<br>    color: #333;<br>    font-size: 32rpx;<br>    line-height: 44rpx;<br>    font-weight: bold;<br>  &#125;<br>&#125;<br><br>.author &#123;<br>  color: #666;<br>  font-size: 24rpx;<br>&#125;<br><br>.list-body &#123;<br>  .info &#123;<br>    font-size: 28rpx;<br>    color: #666;<br>    overflow: hidden;<br>    text-overflow: ellipsis;<br>    display: -webkit-box;<br>    -webkit-line-clamp: 3;<br>    -webkit-box-orient: vertical;<br>  &#125;<br>  .fmt &#123;<br>    width: 192rpx;<br>    height: 122rpx;<br>    border-radius: 8rpx;<br>    flex-shrink: 0;<br>  &#125;<br>&#125;<br><br>.list-footer &#123;<br>  color: #999;<br>  font-size: 24rpx;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p><code>home.vue</code>添加内容展示区</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;home&quot;&gt;<br>    &lt;view class=&quot;fixed-top&quot;&gt;<br>      &lt;search @click=&quot;handle()&quot;&gt;&lt;/search&gt;<br>      &lt;u-tabs name=&quot;value&quot; :list=&quot;tabs&quot; :is-scroll=&quot;true&quot; :current=&quot;current&quot; @change=&quot;change&quot; gutter=&quot;50&quot; height=&quot;88&quot; active-color=&quot;#02D199&quot;&gt;&lt;/u-tabs&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 首页的列表 --&gt;<br>    &lt;view class=&quot;content&quot; :style=&quot;&#123;&#x27;padding-top&#x27;: offsetTop + &#x27;px&#x27;&#125;&quot;&gt;<br>      &lt;view class=&quot;wrapper&quot;&gt;<br>        &lt;view class=&quot;list-box&quot; v-for=&quot;(item,index) in lists&quot; :key=&quot;index&quot;&gt;<br>          &lt;list-item :item=&quot;item&quot; v-if=&quot;item.status === &#x27;0&#x27; &amp;&amp; item.title &amp;&amp; item.catalog&quot;&gt;&lt;/list-item&gt;<br>        &lt;/view&gt;<br>        &lt;view class=&quot;end&quot;&gt;&#123;&#123;msg&#125;&#125;&lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;bottom-line&quot;&gt;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>// import &#123; request &#125; from &#x27;@/common/http&#x27;<br>import &#123; tabs &#125; from &#x27;@/config/const&#x27;<br>export default &#123;<br>  components: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    current: 0,<br>    offsetTop: 50,<br>    page: &#123;<br>      page: 0,<br>      limit: 10,<br>      catalog: &#x27;&#x27;,<br>      sort: &#x27;created&#x27;<br>    &#125;,<br>    lists: [],<br>    loading: false,<br>    pullDown: false,<br>    isEnd: false,<br>    tabs<br>  &#125;),<br>  methods: &#123;<br>    handle () &#123;<br>      uni.navigateTo(&#123;<br>        url: &#x27;/subcom-pkg/search/search&#x27;<br>      &#125;)<br>    &#125;,<br>    change (index) &#123;<br>      this.isEnd = false<br>      this.current = index<br>      this.page = &#123;<br>        page: 0,<br>        limit: 10,<br>        catalog: this.tabs[index].key,<br>        sort: &#x27;created&#x27;<br>      &#125;<br>      this.lists = []<br>      this.getList()<br>    &#125;,<br>    async getList () &#123;<br>      this.loading = true<br>      const &#123; data &#125; = await this.$u.api.getList(this.page)<br>      if (data.length &lt; this.page.limit) &#123;<br>        this.isEnd = true<br>      &#125;<br>      this.lists = [...this.lists, ...data]<br>      this.loading = false<br>      this.page.page++<br>    &#125;<br>  &#125;,<br>  mounted () &#123;<br>    this.getList()<br>  &#125;,<br>  computed: &#123;<br>    msg () &#123;<br>      let str = &#x27;&#x27;<br>      if (this.loading) &#123;<br>        str = &#x27;加载中...&#x27;<br>      &#125; else &#123;<br>        if (this.lists.length &gt; 0) &#123;<br>          // 说明有数据<br>          if (this.isEnd) &#123;<br>            str = &#x27;您已经到底啦~没有更多了！&#x27;<br>          &#125;<br>        &#125; else &#123;<br>          // 说明没有数据<br>          str = &#x27;暂无内容，请下拉刷新&#x27;<br>        &#125;<br>      &#125;<br>      return str<br>    &#125;<br>  &#125;,<br><br>  // 页面周期函数--监听页面加载<br>  onLoad () &#123;&#125;,<br>  // 页面周期函数--监听页面初次渲染完成<br>  onReady () &#123;<br>    const query = uni.createSelectorQuery().in(this)<br>    query.select(&#x27;.fixed-top&#x27;).boundingClientRect((data) =&gt; &#123;<br>      this.offsetTop = data.height<br>    &#125;).exec()<br>  &#125;,<br>  // 页面周期函数--监听页面显示(not-nvue)<br>  onShow () &#123;&#125;,<br>  // 页面周期函数--监听页面隐藏<br>  onHide () &#123;&#125;,<br>  // 页面周期函数--监听页面卸载<br>  onUnload () &#123;&#125;,<br>  // 页面处理函数--监听用户下拉动作<br>  onPullDownRefresh () &#123;<br>    this.pullDown = true<br>    this.change(this.current)<br>    // setTimeout(() =&gt; &#123;<br>    //   console.log(2222)<br>    //   uni.stopPullDownRefresh()<br>    // &#125;, 2000)<br>  &#125;,<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot;&gt;<br>.fixed-top &#123;<br>  position: fixed;<br>  left: 0;<br>  top: 0;<br>  width: 100vw;<br>  z-index: 999;<br>&#125;<br><br>.search &#123;<br>  width: 70%;<br>&#125;<br><br>.content &#123;<br>  background: #f5f6f7;<br>  .wrapper &#123;<br>    padding-bottom: 24rpx;<br>  &#125;<br>&#125;<br><br>.end &#123;<br>  color: #999;<br>  text-align: center;<br>  background: #fff;<br>  padding: 25rpx 0;<br>  // background: transparent;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>监听页面加载，处理内容列表容器的padding</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">onLoad</span> () &#123;<br>  <span class="hljs-keyword">const</span> query = uni.<span class="hljs-title function_">createSelectorQuery</span>().<span class="hljs-title function_">in</span>(<span class="hljs-variable language_">this</span>)<br>  query.<span class="hljs-title function_">select</span>(<span class="hljs-string">&#x27;.fixed-top&#x27;</span>).<span class="hljs-title function_">boundingClientRect</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetTop</span> = data.<span class="hljs-property">height</span><br>  &#125;).<span class="hljs-title function_">exec</span>()<br>  <span class="hljs-comment">// const &#123; windowHeight &#125; = uni.getSystemInfoSync()</span><br>  <span class="hljs-comment">// const query = uni.createSelectorQuery().in(this)</span><br>  <span class="hljs-comment">// query.select(&#x27;#tabs&#x27;).boundingClientRect(data =&gt; &#123;</span><br>  <span class="hljs-comment">// &#125;).exec()</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="获取数据"><a href="#获取数据" class="headerlink" title="#获取数据"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#获取数据">#</a>获取数据</h3><p>在通过后台接口获取数据前，我们需要对request和api进行简单的封装。</p>
<p>创建<code>common</code>文件夹，新建 request.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 1.请求拦截器</span><br><span class="hljs-comment">// 2.在响应的时候，处理data数据</span><br><span class="hljs-comment">// 3.统一的错误处理</span><br><span class="hljs-comment">// 这里的vm，就是我们在vue文件里面的this，所以我们能在这里获取vuex的变量，比如存放在里面的token变量</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">install</span> = (<span class="hljs-params">Vue, vm</span>) =&gt; &#123;<br>  <span class="hljs-comment">// 此为自定义配置参数，具体参数见上方说明</span><br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">setConfig</span>(&#123;<br>    <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">&#x27;http://localhost:3000&#x27;</span>,<br>    <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,<br>    <span class="hljs-attr">showLoading</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否显示请求中的loading</span><br>    <span class="hljs-attr">loadingText</span>: <span class="hljs-string">&#x27;请求中...&#x27;</span>, <span class="hljs-comment">// 请求loading中的文字提示</span><br>    <span class="hljs-attr">loadingTime</span>: <span class="hljs-number">800</span>, <span class="hljs-comment">// 在此时间内，请求还没回来的话，就显示加载中动画，单位ms</span><br>    <span class="hljs-attr">originalData</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否在拦截器中返回服务端的原始数据</span><br>    <span class="hljs-attr">loadingMask</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 展示loading的时候，是否给一个透明的蒙层，防止触摸穿透</span><br>    <span class="hljs-comment">// 配置请求头信息</span><br>    <span class="hljs-attr">header</span>: &#123;<br>      <span class="hljs-string">&#x27;content-type&#x27;</span>: <span class="hljs-string">&#x27;application/json;charset=UTF-8&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">errorHandle</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">statusCode</span> === <span class="hljs-number">401</span>) &#123;<br>        <span class="hljs-comment">// todo 4.业务 —&gt; refreshToken -&gt; 请求响应401 -&gt; 刷新token</span><br>        uni.<span class="hljs-title function_">showToast</span>(&#123;<br>          <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>          <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;鉴权失败，请重新登录&#x27;</span>,<br>          <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>        &#125;)<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 其他的错误</span><br>        <span class="hljs-comment">// showToast提示用户</span><br>        <span class="hljs-comment">// 3.对错误进行统一的处理 -&gt; showToast</span><br>        <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: &#123; msg &#125; &#125; = err<br>        uni.<span class="hljs-title function_">showToast</span>(&#123;<br>          <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>          <span class="hljs-attr">title</span>: msg || <span class="hljs-string">&#x27;请求异常，请重试&#x27;</span>,<br>          <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>        &#125;)<br>      &#125;<br>    &#125;<br>  &#125;)<br><br>  <span class="hljs-comment">// 请求拦截，配置Token等参数</span><br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">http</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">request</span> = <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// 引用token</span><br>    <span class="hljs-comment">// 1.在头部请求的时候，token带上 -&gt; 请求拦截器</span><br>    <span class="hljs-keyword">const</span> publicArr = [<span class="hljs-regexp">/\/public/</span>, <span class="hljs-regexp">/\/login/</span>]<br>    <span class="hljs-comment">// local store -&gt; uni.getStorageSync(&#x27;token&#x27;)</span><br>    <span class="hljs-keyword">let</span> isPublic = <span class="hljs-literal">false</span><br>    publicArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> &#123;<br>      isPublic = isPublic || path.<span class="hljs-title function_">test</span>(config.<span class="hljs-property">url</span>)<br>    &#125;)<br>    <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&#x27;token&#x27;</span>)<br>    <span class="hljs-keyword">if</span> (!isPublic &amp;&amp; token) &#123;<br>      config.<span class="hljs-property">header</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;,<br>        &#123;<br>          <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">&#x27;Bearer &#x27;</span> + token<br>        &#125;, config.<span class="hljs-property">header</span>)<br>    &#125;<br>    <span class="hljs-comment">// 最后需要将config进行return</span><br>    <span class="hljs-keyword">return</span> config<br>    <span class="hljs-comment">// 如果return一个false值，则会取消本次请求</span><br>    <span class="hljs-comment">// if(config.url === &#x27;/user/rest&#x27;) return false; // 取消某次请求</span><br>  &#125;<br><br>  <span class="hljs-comment">// 响应拦截，判断状态码是否通过</span><br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">http</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">response</span> = <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: request.js ~ line 46 ~ install ~ res&#x27;</span>, res)<br>    <span class="hljs-keyword">return</span> res<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  install<br>&#125;<br></code></pre></td></tr></table></figure>
<p>创建<code>api</code>文件夹，新建 index.js，按模块进行接口划分</p>
<p><img src="uniapp.assets/image-20210526235920712.8bf13693.png" alt="image-20210526235920712"></p>
<p>index.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> req = <span class="hljs-built_in">require</span>.<span class="hljs-title function_">context</span>(<span class="hljs-string">&#x27;./modules&#x27;</span>, <span class="hljs-literal">false</span>, <span class="hljs-regexp">/\.js$/</span>)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">install</span> = (<span class="hljs-params">Vue</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> api = <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span> || &#123;&#125;<br>  req.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-title function_">req</span>(item)<br>    <span class="hljs-comment">// 1.取得所有的方法 -&gt; key值,</span><br>    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">module</span>)<br>    keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> &#123;<br>      api = &#123;<br>        ...api,<br>        <span class="hljs-comment">// 2.取得所有方法对应的function -&gt; value值</span><br>        <span class="hljs-comment">// 3.把上面的对象 -&gt; $u.api</span><br>        [key]: <span class="hljs-variable language_">module</span>[key]<br>      &#125;<br>    &#125;)<br>    <span class="hljs-comment">// 4.把它封装成为一个插件，以便在后面的方法中使用 this.$u.api.方法名(参数).then(res) ....</span><br>  &#125;)<br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span> = api<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  install<br>&#125;<br></code></pre></td></tr></table></figure>
<p>public.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">HttpRequest</span> = <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span><br><br><span class="hljs-comment">// ---------------------------------------首页----------------------------------------- //</span><br><span class="hljs-comment">// 获取首页列表数据</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getContentList</span> = params =&gt; <span class="hljs-title class_">HttpRequest</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/public/list&#x27;</span>, params)<br></code></pre></td></tr></table></figure>
<p>在<code>main.js</code>中引入</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> apis <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/api/index&#x27;</span><br><span class="hljs-keyword">import</span> interceptors <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/common/request&#x27;</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(interceptors)<br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(apis)<br></code></pre></td></tr></table></figure>
<p>下面我们来获取首页列表数据，创建<code>getList</code>方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">methods</span>: &#123;<br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getList</span> () &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span><br>    <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">getList</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>)<br>    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">length</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>.<span class="hljs-property">limit</span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isEnd</span> = <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lists</span> = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">lists</span>, ...data]<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>.<span class="hljs-property">page</span>++<br>  &#125;<br>&#125;,<br></code></pre></td></tr></table></figure>
<p>最后在<code>onshow</code>周期请求数据</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">onShow</span> () &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getList</span>()<br>&#125;<br></code></pre></td></tr></table></figure>
<p>完成效果：</p>
<p><img src="uniapp.assets/image-20210527003502507.3b9a3d15.png" alt="image-20210527003502507"></p>
<h3 id="分页与切换"><a href="#分页与切换" class="headerlink" title="#分页与切换"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#分页与切换">#</a>分页与切换</h3><p>上拉分页加载列表数据</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-attr">watch</span>: &#123;<br>  <span class="hljs-title function_">loading</span> (newval) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pullDown</span> &amp;&amp; !newval) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pullDown</span> = <span class="hljs-literal">false</span><br>      uni.<span class="hljs-title function_">stopPullDownRefresh</span>()<br>    &#125;<br>  &#125;<br>&#125;,<br><span class="hljs-comment">// 页面处理函数--监听用户上拉触底</span><br><span class="hljs-title function_">onReachBottom</span> () &#123;<br>  <span class="hljs-comment">// 1. 触发条件的设置，距离底部多远的时候触发 - 50</span><br>  <span class="hljs-comment">// console.log(&#x27;reach bottom&#x27;)</span><br>  <span class="hljs-comment">// 2. 当没有更多的时候，需要给用户一个提示，同时设置页面样式，不再发请新的请求</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isEnd</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>) <span class="hljs-keyword">return</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getList</span>()<br>&#125;,<br></code></pre></td></tr></table></figure>
<p>同时在tab切换时加载不同分类的数据，在tabs切换方法<code>tabsChange</code>中添加 getList 方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">tabsChange</span> (index) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span> = index<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span> = &#123;<br>    <span class="hljs-attr">page</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">limit</span>: <span class="hljs-number">10</span>,<br>    <span class="hljs-attr">catalog</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabs</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span>].<span class="hljs-property">key</span> || <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">sort</span>: <span class="hljs-string">&#x27;created&#x27;</span><br>  &#125;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getList</span>()<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="日期过滤器"><a href="#日期过滤器" class="headerlink" title="#日期过滤器"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#日期过滤器">#</a>日期过滤器</h3><p>注意：用法与vue中的过滤器一致</p>
<ol>
<li>安装依赖：</li>
</ol>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">npm i dayjs<br></code></pre></td></tr></table></figure>
<ol>
<li>添加filter.js文件：</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> dayjs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;dayjs&#x27;</span><br><span class="hljs-keyword">import</span> relativeTime <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;dayjs/plugin/relativeTime&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;dayjs/locale/zh-cn&#x27;</span><br><br>dayjs.<span class="hljs-title function_">extend</span>(relativeTime)<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">moment</span> = (<span class="hljs-params">date</span>) =&gt; &#123;<br>  <span class="hljs-comment">// 超过7天，显示日期</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">dayjs</span>(date).<span class="hljs-title function_">isBefore</span>(<span class="hljs-title function_">dayjs</span>().<span class="hljs-title function_">subtract</span>(<span class="hljs-number">7</span>, <span class="hljs-string">&#x27;days&#x27;</span>))) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dayjs</span>(date).<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY-MM-DD&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 1小前，xx小时前，X天前</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dayjs</span>(date).<span class="hljs-title function_">locale</span>(<span class="hljs-string">&#x27;zh-cn&#x27;</span>).<span class="hljs-title function_">from</span>(<span class="hljs-title function_">dayjs</span>())<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">hours</span> = (<span class="hljs-params">date</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">dayjs</span>(date).<span class="hljs-title function_">isBefore</span>(<span class="hljs-title function_">dayjs</span>(<span class="hljs-title function_">dayjs</span>().<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY-MM-DD 00:00:00&#x27;</span>)))) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dayjs</span>(date).<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY-MM-DD&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 1天内</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">dayjs</span>(date).<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;HH:mm:ss&#x27;</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ...</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  moment,<br>  hours<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>main.js中使用：</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> filters <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/common/filter&#x27;</span><br><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(filters).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> &#123;<br>  <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">filter</span>(key, filters[key])<br>&#125;)<br></code></pre></td></tr></table></figure>
<h2 id="搜索"><a href="#搜索" class="headerlink" title="#搜索"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#搜索">#</a>搜索</h2><h3 id="首页搜索按钮"><a href="#首页搜索按钮" class="headerlink" title="#首页搜索按钮"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#首页搜索按钮">#</a>首页搜索按钮</h3><p>关于设计：</p>
<p>参考：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/design/#图标">链接1 (opens new window)</a>， <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000018733860">链接2(opens new window)</a></p>
<p>官方的文档目前没有对右侧按钮的说明：</p>
<p><img src="uniapp.assets/image-20210712184845616.663c9f4c.png" alt="image-20210712184845616"></p>
<p>在旧的文档中有说明：</p>
<p><img src="uniapp.assets/image-20210712184922032.fce664cd.png" alt="image-20210712184922032"></p>
<p>从图中分析，我们可以得到如下信息：</p>
<ul>
<li>Android跟iOS有差异，表现在顶部到胶囊按钮之间的距离差了6pt</li>
<li>胶囊按钮高度为32pt， iOS和Android一致</li>
</ul>
<p><strong>关于px，em与pt单位的说明：</strong></p>
<p>px是像素单位，em是相对单位，pt是绝对单位。</p>
<p>它们各自的好处是：</p>
<ul>
<li>px可以在计算机屏幕上，能达到预期的效果，在打印机和其它的高分辨率设备上，它又能取得所希望的效果。</li>
<li>em的优点很多，比如在一个页面上，你给定了一个父元素的字体大小，这样就可以通过调整一个元素来成比例的改变所有元素大小。它可以自由缩放，比如用来制作可伸缩的样式表。</li>
<li>pt是一种固定长度的度量单位，是能够使用测量设备测得的长度。绝对单位作用有限，因为它们不能够缩放，通常只用在已经知道是用在哪种输出媒体的情况下才使用。但大多数情况下最好使用相对单位。一般都是用px和em这两种种配搭比较好。</li>
</ul>
<p>使用<code>wx.getSystemInfoSync()</code>可以在console中快速查看设备的信息。</p>
<p>两种方式创建uni的easycom组件：</p>
<ol>
<li>创建<code>components/组件名同名文件夹/组件名.vue</code></li>
<li>使用hbuilderx来创建组件，勾选<code>创建目录</code></li>
</ol>
<p><img src="uniapp.assets/image-20210712193718265.0bf6f757.png" alt="image-20210712193718265"></p>
<p>创建search组件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;search&quot; :style=&quot;&#123;&#x27;padding-top&#x27;: barHeight + &#x27;px&#x27;&#125;&quot; @click=&quot;$emit(&#x27;click&#x27;)&quot;&gt;<br>    &lt;view class=&quot;search-box&quot;&gt;<br>      &lt;u-icon name=&quot;search&quot; color=&quot;#CCC&quot; size=&quot;28&quot; class=&quot;icon&quot;&gt;&lt;/u-icon&gt;<br>      &lt;text&gt;搜索社区内容&lt;/text&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  name: &#x27;search&#x27;,<br>  data () &#123;<br>    return &#123;<br>      barHeight: 0<br>    &#125;<br>  &#125;,<br>  beforeMount () &#123;<br>    this.getNavBarHeight()<br>  &#125;,<br>  methods: &#123;<br>    getNavBarHeight () &#123;<br>      uni.getSystemInfo(&#123;<br>        success: (result) =&gt; &#123;<br>          console.log(&#x27;🚀 ~ file: home.vue ~ line 24 ~ getNavBarHeight ~ result&#x27;, result)<br>          const statusBarHeight = result.statusBarHeight<br>          const isiOS = result.system.indexOf(&#x27;iOS&#x27;) &gt; -1<br>          if (isiOS) &#123;<br>            this.barHeight = statusBarHeight + 5<br>          &#125; else &#123;<br>            this.barHeight = statusBarHeight + 8<br>          &#125;<br>        &#125;<br>      &#125;)<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.search &#123;<br>  position: relative;<br>  width: 100vw;<br>  background: #fff;<br>  padding: 0 32rpx 12rpx;<br>  z-index: 999;<br>  display: flex;<br>  justify-content: flex-start;<br>  align-items: center;<br>  color: #ccc;<br>  .search-box &#123;<br>    position: relative;<br>    width: 60%;<br>    @media screen and (max-width: 320px) &#123;<br>      width: 50%;<br>    &#125;<br>    background: #f3f3f3;<br>    height: 64rpx;<br>    border-radius: 32rpx;<br>    line-height: 64rpx;<br>    columns: #ccc;<br>    font-size: 26rpx;<br>    padding-left: 74rpx;<br>  &#125;<br>  .icon &#123;<br>    position: absolute;<br>    left: 32rpx;<br>    top: 19rpx;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>在uniapp中自定义的组件是无法直接绑定事件的；</li>
<li>可以在子组件中的最外侧的view上绑定<code>$emit(&#39;click&#39;)</code></li>
</ul>
<h3 id="添加分包"><a href="#添加分包" class="headerlink" title="#添加分包"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#添加分包">#</a>添加分包</h3><p>在uniapp中添加分包</p>
<ul>
<li>新增页面，比如<code>/sub-pkg/search/search</code></li>
<li>配置<code>pages.json</code></li>
</ul>
<p>注意：</p>
<p><strong>分包的作用是为了提升小程序的加载性能，首页tabs相关的页面是不能放置在分包中的。</strong></p>
<h3 id="布局与样式-3"><a href="#布局与样式-3" class="headerlink" title="#布局与样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#布局与样式-4">#</a>布局与样式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;search&quot;&gt;<br>    &lt;div class=&quot;search-box&quot;&gt;<br>      &lt;u-search :focus=&quot;true&quot;&gt;&lt;/u-search&gt;<br>    &lt;/div&gt;<br>    &lt;!-- 搜索建议列表 --&gt;<br>    &lt;view class=&quot;list&quot; v-if=&quot;searchResults.length !== 0&quot;&gt;<br>      &lt;view class=&quot;item&quot; v-for=&quot;(item, i) in searchResults&quot; :key=&quot;i&quot;&gt;<br>        &lt;view class=&quot;name&quot;&gt;&#123;&#123;item.name&#125;&#125;&lt;/view&gt;<br>        &lt;u-icon type=&quot;arrow-right&quot; size=&quot;16&quot;&gt;&lt;/u-icon&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 搜索历史 --&gt;<br>    &lt;view class=&quot;history-box&quot; v-else&gt;<br>      &lt;!-- 标题区域 --&gt;<br>      &lt;view class=&quot;history-title&quot; v-if=&quot;historyList.length !== 0&quot;&gt;<br>        &lt;text&gt;搜索历史&lt;/text&gt;<br>        &lt;u-icon type=&quot;trash&quot; size=&quot;17&quot; @click=&quot;clean&quot;&gt;&lt;/u-icon&gt;<br>      &lt;/view&gt;<br>      &lt;!-- 列表区域 --&gt;<br>      &lt;view class=&quot;history-list&quot;&gt;<br>        &lt;uni-tag :text=&quot;item&quot; v-for=&quot;(item, i) in historyList&quot; :key=&quot;i&quot;&gt;&lt;/uni-tag&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 热门推荐 --&gt;<br>    &lt;view class=&quot;history-box&quot;&gt;<br>      &lt;!-- 标题区域 --&gt;<br>      &lt;view class=&quot;history-title&quot; v-if=&quot;hotList.length !== 0&quot;&gt;<br>        &lt;text&gt;热门推荐&lt;/text&gt;<br>      &lt;/view&gt;<br>      &lt;!-- 列表区域 --&gt;<br>      &lt;view class=&quot;history-list&quot;&gt;<br>        &lt;uni-tag :text=&quot;item&quot; v-for=&quot;(item, i) in hotList&quot; :key=&quot;i&quot;&gt;&lt;/uni-tag&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.search &#123;<br>  padding: 24rpx;<br>&#125;<br><br>.search-box &#123;<br>  position: sticky;<br>  top: 0;<br>  z-index: 999;<br>  padding-bottom: 50rpx;<br>&#125;<br><br>.list &#123;<br>  padding: 0 5px;<br>  .item &#123;<br>    font-size: 12px;<br>    padding: 13px 0;<br>    border-bottom: 1px solid #efefef;<br>    display: flex;<br>    align-items: center;<br>    justify-content: space-between;<br>    .name &#123;<br>      white-space: nowrap;<br>      overflow: hidden;<br>      text-overflow: ellipsis;<br>      margin-right: 3px;<br>    &#125;<br>  &#125;<br>&#125;<br><br>.history-box &#123;<br>  padding: 0 10rpx 50rpx;<br><br>  .history-title &#123;<br>    display: flex;<br>    justify-content: space-between;<br>    align-items: center;<br>    height: 40px;<br>    font-size: 16px;<br>    font-weight: bold;<br>  &#125;<br><br>  .history-list &#123;<br>    display: flex;<br>    flex-wrap: wrap;<br>    ::v-deep .uni-tag &#123;<br>      margin-top: 5px;<br>      margin-right: 5px;<br>      border-radius: 25rpx;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p><code>pages.json</code>中配置分包：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;subPackages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>	<span class="hljs-punctuation">&#123;</span><br>		<span class="hljs-attr">&quot;root&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;subpkg&quot;</span><span class="hljs-punctuation">,</span><br>		<span class="hljs-attr">&quot;pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>			<span class="hljs-punctuation">&#123;</span><br>				<span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;search/search&quot;</span><span class="hljs-punctuation">,</span><br>				<span class="hljs-attr">&quot;style&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>					<span class="hljs-attr">&quot;navigationBarTitleText&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;搜索&quot;</span><br>				<span class="hljs-punctuation">&#125;</span><br>			<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-comment">// ...</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>
<p>使用easycom，添加<code>search.vue</code>组件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view :style=&quot;&#123;&#x27;padding-top&#x27;: barHeight + &#x27;px&#x27;&#125;&quot; class=&quot;search&quot; @click=&quot;$emit(&#x27;click&#x27;)&quot;&gt;<br>    &lt;view class=&quot;search-box&quot;&gt;<br>      &lt;u-icon name=&quot;search&quot; color=&quot;#CCCCCC&quot; size=&quot;28&quot; class=&quot;icon&quot;&gt;&lt;/u-icon&gt;<br>      &lt;text&gt;搜索社区内容&lt;/text&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br><br>export default &#123;<br>  props: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    barHeight: 80<br>  &#125;),<br>  computed: &#123;&#125;,<br>  methods: &#123;<br>    getNavBarHeight () &#123;<br>      uni.getSystemInfo(&#123;<br>        success: (result) =&gt; &#123;<br>          const statusBarHeight = result.statusBarHeight<br>          const isiOS = result.system.indexOf(&#x27;iOS&#x27;) &gt; -1<br>          if (isiOS) &#123;<br>            this.barHeight = statusBarHeight + 5<br>          &#125; else &#123;<br>            this.barHeight = statusBarHeight + 7<br>          &#125;<br>          // getApp().globalData.barHeight = this.barHeight<br>          // 存储至store中<br>          // uni.setStorage(&#123;<br>          //   key: &#x27;setBarHeight&#x27;,<br>          //   data: this.barHeight<br>          // &#125;)<br>        &#125;,<br>        fail: () =&gt; &#123;&#125;,<br>        complete: () =&gt; &#123;&#125;<br>      &#125;)<br>    &#125;<br>  &#125;,<br>  beforeMount () &#123;<br>    this.getNavBarHeight()<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>// search<br>.search &#123;<br>  // padding-top: 25px;<br>  position: relative;<br>  background: #fff;<br>  width: 100vw;<br>  padding: 0 32rpx 12rpx;<br>  z-index: 999;<br>  .search-box &#123;<br>    position: relative;<br>    width: 70%;<br>    @media (max-width: 320px) &#123;<br>      width: 60%;<br>    &#125;<br>    height: 64rpx;<br>    line-height: 64rpx;<br>    background: #f3f3f3;<br>    border-radius: 32rpx;<br>    color: #ccc;<br>    font-size: 26rpx;<br>    padding-left: 74rpx;<br>  &#125;<br>  .icon &#123;<br>    position: absolute;<br>    left: 32rpx;<br>    top: 19rpx;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p><code>home.vue</code>添加导航：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;search @click=&quot;gotoSearch&quot;&gt;&lt;/search&gt;<br></code></pre></td></tr></table></figure>
<p>完成效果：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgQAAABOCAYAAABfXg61AAAEDmlDQ1BrQ0dDb2xvclNwYWNlR2VuZXJpY1JHQgAAOI2NVV1oHFUUPpu5syskzoPUpqaSDv41lLRsUtGE2uj+ZbNt3CyTbLRBkMns3Z1pJjPj/KRpKT4UQRDBqOCT4P9bwSchaqvtiy2itFCiBIMo+ND6R6HSFwnruTOzu5O4a73L3PnmnO9+595z7t4LkLgsW5beJQIsGq4t5dPis8fmxMQ6dMF90A190C0rjpUqlSYBG+PCv9rt7yDG3tf2t/f/Z+uuUEcBiN2F2Kw4yiLiZQD+FcWyXYAEQfvICddi+AnEO2ycIOISw7UAVxieD/Cyz5mRMohfRSwoqoz+xNuIB+cj9loEB3Pw2448NaitKSLLRck2q5pOI9O9g/t/tkXda8Tbg0+PszB9FN8DuPaXKnKW4YcQn1Xk3HSIry5ps8UQ/2W5aQnxIwBdu7yFcgrxPsRjVXu8HOh0qao30cArp9SZZxDfg3h1wTzKxu5E/LUxX5wKdX5SnAzmDx4A4OIqLbB69yMesE1pKojLjVdoNsfyiPi45hZmAn3uLWdpOtfQOaVmikEs7ovj8hFWpz7EV6mel0L9Xy23FMYlPYZenAx0yDB1/PX6dledmQjikjkXCxqMJS9WtfFCyH9XtSekEF+2dH+P4tzITduTygGfv58a5VCTH5PtXD7EFZiNyUDBhHnsFTBgE0SQIA9pfFtgo6cKGuhooeilaKH41eDs38Ip+f4At1Rq/sjr6NEwQqb/I/DQqsLvaFUjvAx+eWirddAJZnAj1DFJL0mSg/gcIpPkMBkhoyCSJ8lTZIxk0TpKDjXHliJzZPO50dR5ASNSnzeLvIvod0HG/mdkmOC0z8VKnzcQ2M/Yz2vKldduXjp9bleLu0ZWn7vWc+l0JGcaai10yNrUnXLP/8Jf59ewX+c3Wgz+B34Df+vbVrc16zTMVgp9um9bxEfzPU5kPqUtVWxhs6OiWTVW+gIfywB9uXi7CGcGW/zk98k/kmvJ95IfJn/j3uQ+4c5zn3Kfcd+AyF3gLnJfcl9xH3OfR2rUee80a+6vo7EK5mmXUdyfQlrYLTwoZIU9wsPCZEtP6BWGhAlhL3p2N6sTjRdduwbHsG9kq32sgBepc+xurLPW4T9URpYGJ3ym4+8zA05u44QjST8ZIoVtu3qE7fWmdn5LPdqvgcZz8Ww8BWJ8X3w0PhQ/wnCDGd+LvlHs8dRy6bLLDuKMaZ20tZrqisPJ5ONiCq8yKhYM5cCgKOu66Lsc0aYOtZdo5QCwezI4wm9J/v0X23mlZXOfBjj8Jzv3WrY5D+CsA9D7aMs2gGfjve8ArD6mePZSeCfEYt8CONWDw8FXTxrPqx/r9Vt4biXeANh8vV7/+/16ffMD1N8AuKD/A/8leAvFY9bLAAAAbGVYSWZNTQAqAAAACAAEARoABQAAAAEAAAA+ARsABQAAAAEAAABGASgAAwAAAAEAAgAAh2kABAAAAAEAAABOAAAAAAAAAJAAAAABAAAAkAAAAAEAAqACAAQAAAABAAACBKADAAQAAAABAAAATgAAAAC40TxvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAXBklEQVR4Ae2d65LUxhmGZ3cWWDDG5xOYg43BxofyH18ITlUuI5VfTnwJqbgqF5KqxEmlKteQH/4RnzjYBi/ngw02LBjYZdfpR/BuerWSRpptzWhm364SmpVare6nhb63v/4kzfQK0q+//rotbD7+ePkgrPeGZXdYnEzABEzABEzABCaLwJ1Q3cth+Sws/2CZmZlZDut1aWbdX+GPIAY+DKtPwnI4v89/m4AJmIAJmIAJTDyBM6EFHwVR8GnckjVBEITAbNjxJzLFGfzbBEzABEzABExgKgkw+P84CINVWjcXNdFiIILhnyZgAiZgAiYw5QTkAPgD7cw8BI+nCf4+5Q1380zABEzABEzABDYS+A3TBzOPAwhPhv2OGdgIyVtMwARMwARMYNoJEFNwjLgBniawGJj27nb7TMAETMAETKCYABrguARBcRZvNQETMAETMAET2AoEjhNUyHsGOp/C1Ebv4cOHvZWVld7q6mq2ZhuLkwmYgAmYgAmMm0CYh++x9Pv93uzsbLaem5vLto27bjXO/wExBIshYydfOoQAWF5ezoQAIsDJBEzABEzABCaNAOIAYbBt27Zs3dH630EQdGqITXUePHiQCQGLgI5eNq6WCZiACZjAUAQQBwiDHTt2dM5z0BlBICGAGHAyARMwARMwgWkngCjokjDohCBYWlrq3b9/3/EA0371u30mYAImYALrCBBzMD8/39u+ffu67eP4Y6yCYGV1pXf/3v0sRmAcjfc5TcAETMAETKALBIgxmN853+vP9sdWnbEJArwC9+7dG1vDfWITMAETMAET6BqBnTt3js1bMBZBgBBAEDiZgAmYgAmYgAmsJ8D0AcJg1GnkguCXX37JniAYdUN9PhMwARMwAROYFAI8ibBr166RVpc3FY4sWQyMDLVPZAImYAImMMEEeAcPNnOUaWSCwGJglN3qc5mACZiACUw6gVGLgpEIAmIGaJiTCZiACZiACZhAfQLYzlEF4LcuCAgedABh/c53ThMwARMwAROICYzKjrYqCHjPwKiUTQzPv03ABEzABExgmghgS7GpbaZWBQEvHXIyARMwARMwARPYPIG2bWprggAXB18rdDIBEzABEzABE9g8AWxqm1PwrQgCPlTEtwmcTMAETMAETMAE0hFo87s/rQgCvljYsa8qp+sNl2QCJmACJmACYyKgLwO3cfrkgqDNyrYBwGWagAmYgAmYwCQRaGvQPZcaAhXtckKwEK3JoldD8pUpJxMwARMwAROYFALYWj6bnDIlt4RdfAHR6upq7+rVq73FxcVekbLavn1b+JDErt5LL7008g9K/PTTT707d+5k76x+7rnnCvuW+vPNbAJKLl++nAmZvXv3FuYdZiN9trCwkJ3j9ddf783ODu84unHjRo820ZZnnnlmYHWuX7+e9clTTz3V27Nnz8D8Xctw7ty5TFzSVq6fNtKVK1fWrpF9+/a1cQqXaQImMGEEuG93WhBgsDBeXUoY2wsXzofIzPI3JbJvaelW7/bt29lNva0bexGXH3/8MXtfNR6LvCC4e/duJgB47TMfucAY/Pzzz1kxCIIffvhhXZE7duwYyqjSb3pnNoJpM1/ZQnhR3vLyUi1BcO3atbVrpo4goOwLFy6sa/dm/4DbsAILkbmy0u77NjiHvFrUE3HoZAImsLUJYGu5H6b0cCf1EHTNO3Dp0qUeBlcJcLt3786MK0YP40fEJoaXGy7TCRi0W7du9V577bVsJK5jR7mmk0+fPr3usU3qFz9uQh68BXFiZP/ee+/Fm7LfFy9erHx1NGUpkbfqAmPf/v37lX3D+sUXX8zqhciCL8Y2ZeI/AcItZcLADisIuGZI/X5/qCoh6gb9v2FqS9fn999/P3BUQP4XXnhhqPr4IBMwgckhwL2j6n7dtCVJBUFsWJpWJHV+hEAsBp5//vnsph+PrhAHSoy8MYYa7eEKfuONN7R7pGvqIJYYGowsi0bxVAbjL2Mb5y+q6M2bN2s/9RGfo6gs+FUJAgwRLm4MJetDhw4VFZNkG+2P+3PYQoc15pxPgmDYaRYEaBOvGt4ClqpEXSwIqgh5nwlMBwHZiVStSSYIuDE2ubGlakBROYykMUYkbo7Miz/xxBNFWde2Pf3005n3gBEYRhGvAaO3cd9Y33333bU6xj9o11tvvZVtYsRMvcsSrviqC4d+YwRKwnNSZdwkQuJz4YkhdkBJRhJPyxdffJFtfvnllzNRozwp1m+++WZjQYCiZhppUHwD/U/9ByW1VdM7Vfnph1iExnlhPjc3nJdB5Tx8uNKZ/4Oqk9cmYALtEeDezT0oxcCIWiYTBFUGpz0cxSUzupc4wRU8SAyoFFwvjGhPnTqVHc/ojZt4kRHUMcOs8UZo/l8vcGL97bffZsUdOHBgmGJLjxk0SkcMfPPNN9nxjP6bxhDQ9zKM+UpoO16MNhNGvszYxufl2sB4X716pXfs2NvxrnW/8aqw1E0wlKgqOwahWlZHPFivvPLKukOZEiJ/PrYCocL1ko91QQQTpOlkAiawdQhw/2WaMEVKJgjavuHXbSyje7m9n3zyyQ2BeoPKAeyrr77aO3/+fCYKmHZIHdnNDV11VH0wnPlt7Pvyyy+zLNQrLxS++uqrzBDL6KqseI3noGo/eWMxR7sHXVyoUWIslBj985RAPmGk5Tko2p/PP+zfBBlivBFuR48eLfVwYJARA6R+v/6lXzalAFcJT0b4ZSq96f8N6ok4pF8QjkxdSdRS/4XwRAgJ44/gzQejZjv9jwmYwJYgwP1l0D27Loj6d8UBJerGOCBb67tjo5ofQdU9Oe5kRmfckOPy6h4/KB+jPm76JEZ6sMOg8AhJ3viIa2y0VX4dQ9M0AI/6sDRJGOIiLwpTCST28ZREW0lGniDGr7/+OjOgRV4OxI5SVRyE8rCmX8qmbeIROXnKBAHCrayv6HOuhe3bt2enxchruosNTGVJDPA3HJ999tlMAHFtEPdy/fq1IBYPrgXLtsmaOjiZgAl0h4BsRIoaJRMEZTe8FJVsUkbsti0yCnXL4qaKMW1qHOuUz4hOozpGgogOjOaRI0eywzFsSvFTA/m6aB/1xBVelTAqRUabMiV62B8bn3x51EvGN78v/zeGTSKGUSyGa3Fx49MBupgfvY9hY7Dc3r37Cr0P8fmIpTh79mwWbEd5TH/gTYnjBKi36k7fbuba0LnxgJCqvAPKW7ZWnzONhJgRM8QFbUAQ4Ilg+oo13hjEDOuF4Cmg73ii47vvvsvy4iFxMgET2DoEUtreZIJgkFt6VN0TGzdu1MMmCQIMTBuPz9WtV1UbtE/rqjJ5SiE/F80IXrwwQBgZDJASxil+pGVQ8KKOQ5RplAtHzsvfGK6yxPVTtB8jXme6gcBR3mmA4SThDaBtTPdQNoJBKT/1ou1N1xJulE+w4jBuO4QA/SAhQB3wGhw+fDhjz/V38uTJtf0Ip2PHjmXnQkzAh2khbgqUxRMITOdUCbum7XR+EzCB7hJIaXunThCsrj4KXsu73pt2Z2xkuVkXja6bljlMfkaNSnHHx9s1yla+QWuM15kzZzKhQ16MR/yGQgwdnguMDCKhydQLrBitkhAZGDYSbm6NqLMNj//RlAbCA/GQT2VBePl8/E09GfkzcoYV8R+IAsoWI4L3UvQlxlfKnHMRiIqnookogEfs2eGNmfv3H1gLPKSfeB+FzkMb4YtA4AkL2kXfMV1Bm4lNIS/88R7F1zDHOpmACUwfgdgubLZ1yQTBZiuS6vj5+Z3ZSDPvXm9afnx8CgNS5/wYLwLkMFpK8chR21iXbY/z8JvRNXlpA0aRETSGkotIbmlG8ORhwdDpCQiOxygpUQZGm+OKEmViwGR8Mc4ySjy+WfQIJ0GT5KcOdef1i86tbZSDYWbaAOMoDwj7MaCpAkSZAokTbUAUMHrnPHWSniBglE+94ikOgjHxHOg/+8GDB7MiERD004kTJ9amFNhxKDwdQ99x/TBFI+516uE8JmACJgCBeneuCWIVu/pxXQ87VyxDgqeh7g1+M5ioK6NyEjfzIrc2IkWPlRXtL/KKYCiUMPSxscfYxCNU5WNNm/EaxO/KRhBozjvOy28M4unTpzJjpX0wPHnyRAjyO9Jo5Kzjh10ToPfOO+9kRhPjqZRCcFAWfaBRO4ILw47xlihAkNS9ZuKnNSib+i6E0b7iHRBfPGUg7wkeCLw76jueruBa4HxM98RTPpTnZAImYAJ1CUydIIgFACOm+O+6UHCZa35YN+K6x9bNh7sY4xwHQXIsRhc3sKLO4/IwsBIE8WgyzlP1G2PB8bOzM2GU/+gxOQyL2qpjiTfgmXgF6jE6rTI0Ra5tlUVcAC5ujPEwdVY5TdcYylgMcDzip6lbP39ejD6xCiR5WBBwMJBQwEuCIGmS6AdEhR7T5FiMPAIsvha4Npgu0JQOMQNMHxGkipehzHvTpC7OawImsDUJJBME3Ii4qY07MVpjpMwIDoOLIWsiCjTyUluazJ/XbXvRY2gYFb1RkblgjEpV0vsJ4jyIiaooc0aXMlQYMNzL8WtweW8Dhlvz4Ho0EkNK/xYF98FJL3KiLrjsFRdA/AHGkzwE+dHGojLiNqT4zSOjsScELoieeASvNjY5n4QP5ZC4NmgTCQGFAJEQwWCXeVOyAx7/Q5nUlz7XNQdryi679mgPcQOwFV+EBOeGP8JgmPbF9fJvEzCBySCQchAwdYKAGzRGbeFxYBmGCCNZFxpz7Bq1c3NlRJY6qS7UFSPAIs8A58KwyOiUnbtovwx41TEYyps3b6xF9FMHAv4wPtSDc2M8WTPqxFiR4EmAYD7Ij7bIkBEjgAiQWEFgwJAgN/K1LQZgQj1jkYM7Hc8EkfgIFfIMEwCoKR21lQDAvMHmuiMfC94cRvxVMQtw0dSA+gxOxJCwljdI+/Jr5UUM0C7qhrBggT0C08kETGC6CXAfSJWSCQJG5UVGKlVFm5SD4cEzwJQB8+6MtrlZVxl3DCA3cI5RwnXeRqIuuIOZjmAkifGIE4YYnogZbvISOXEe/WbqQW5mjEBRQijgti9K9BlBhiyDElMIeuQtzosHBubwyl8D7MNNn98eH5/iN8JFwZKUx38SBIz6nLl6GWDq0kQUICQQGhIDtKnME8N8Py58cdX5i9oYj+LJx7Uqz1ZR/kHb6H+JoTj2Y9Bx3m8CJjC5BIpix4ZtTTJBgNHqUmJkxkiN0S4LgVgYWm6a3NC5GXPT1miO0RiiIE5Ekut58Hj7Zn8zah6UEDQYB+pAPXn+PB+AhpCQGOCiUCR6vux4Dpp9UpTxWkFyCBXyUx4Lf7PINY24yr+5b5BrPDZ8+bpt9m/ajxiAkRL1zc+9sw9jLQFG/rqiACMrMYDwORQFauqcWvP/gGuG88A3z175WNNfGG48KxxHfegHftdlxjWrvsMjQLtgUvRER3xu/zYBE5gOAiltbzJBkFKlpOgmjAKjOIwFN0hu6PFImPpy89SNXufkOPYhIhixISTaEAU6X9UaAYMQwK3MKJVH6TBqXAAYaL2EhzKoY1V6//331+2m3DjI7/PPP8/24/LnvLSfxFSG1sQSVI14s4wj/kfTAJwWLszlx49t5quDUEDU0Lf0P6Jq0FSGxCVtz3+AKF8+f+P54XsYGPtBQan5aQeOZ1omL/7YXpSYHsB7oQQDiwHR8NoEpp9AStubTBBgSLuWuDlyY2ZEfunSxbV5c+qpUZXqTF5uztxM2YcQwGiMWxQgABTtjzcDd/TcXH+tLdSbPHg96iTEhd5sh0AqGt1jKBEfrDFozMPjscAg1h251qlLijyM1nkmn/pVzdfH51KUPrETg8SAjoNxk4SocjIBEzCBtgmktL3JrDjuUYwTRqRrCUGwZ8/b2aiXESELxhWQGFJGwYzKBJY1I+6uiAJcwbGre2npEWN489QA60GJ9hIjEQexlc0zE/muvoQVrmw4Ia66Jgi47vTkxCAG8f4iIRTv928TMAET6DoB7tOa+k1R12SCgMpgSAdFuqeo9LBlYPhZYld5WVlFooDH9Oq6csvKzW+vElAYb54KYA67KB/b8BggePBs5N3T7GdqQY/C6dy4mBAZ+fzaDyOMLOdHRCAmWBAliAiEQZOpA9z6TFEUJU3Z3LmzWPiSJC54gjCLEl6MVP8Z8BQUue+LzttkG+2TN6puXeXFqXMexJuTCZjA1iSgQWyq1icVBIweuywImkLLi4J80GHT8pQfYaGRuubqFXymrwIuLW280WPIcUWz1ktwMPo8GcGCwaEc3NvUHWOOGFDCuDK/rnlw9mOwYqMSz0dh9InDoE+ZZtAUCtH6epxPZVetmZpQ9HtZPtq7tPT/JzzifGWCgPqkSnBIIQh4xwR9IuPPb6U6QpS8CAhElJMJmIAJVBFI7bFNKggwQnI1VzVikvbRJtzL3KCbjIqr2ogBlhBQPj3iiIs+FgPwZDqDYL84ToD81InAQgwjBo0F402dSRh+BAEjfo5nnj1O7IsNFvuK5tQRGcy7E8CGmOE8dY0bZeJVwMOQIvEfAI8IdUiZUvVtvz+bGfR8/egT6l0nIcrKpnPyxy8vL627XvL7/bcJmMB0EsA26F6fqoUz4caV9M6Kccobu1SVnZZyMPp634FG/epYDPpCiBrHMBP0VlcBUiYGnvx1R7o8gaEvEGL0ERll0wgxezwlqm+8Xb8JgmSUeygE/NWtv47typonU1jgQjvqJnjK+6NjeNS1Dle8QxxPv0sgqoyyNf3O+yq4jhwXUUbJ201g+ggw0Ks7cKjb+uSCAH1hd2dd/M5nAiZgAiZgAs0J4HHU1GTzo4uPGByeXnxc6VYqiHJxMgETMAETMAETSE8AG5taDFDL5IKAQtuqLGU7mYAJmIAJmMBWJdDmoLsVQUCFU89tbNXOd7tNwARMwARMQASwrW14Byi/FUFAwQRjVQWekcfJBEzABEzABEygHgFsKra1rdSaIKDC8zvn26q3yzUBEzABEzCBLUWgbZvaqiDoz/bXPTu/pXrOjTUBEzABEzCBRAR4Dw02tc3UqiCg4rg32nRxtAnHZZuACZiACZjAuAmMyo62LggAibKZ1BfUjPtC8PlNwARMwAS2LgFsZ/yW2jZJjEQQ0ADe1GZR0GZXumwTMAETMIFpIoDNrPOW01RtHpkgoMIWBam6zeWYgAmYgAlMM4FRiwFYJn91cZ0O4kM30/RVxDptdh4TMAETMAETqEOAmIFRTRPE9RmLIKACCIJUX8CLG+TfJmACJmACJjCpBBAC4wrEH5sgoLNWVld69+/d7/H1PCcTMAETMAET2KoEeOkQ7xlo+9HCKr5jFQSqGN4CPpuc+EvMKt5rEzABEzABE+gkAb3qf1xegRgKgmAxbNgdbxzHb8TAgwcPsmUc5/c5TcAETMAETGCUBPgQYIc+BngbQXA6ADg6SghV55IwWF5e7q2urlZl9T4TMAETMAETmCgCs7Oz2SP4HRIC4ndiLvz6LCydEQRyn/BFJ2ILEAasLQ7UZ16bgAmYgAlMEgFEADECPErY4Y/+/RcPwW8D2L92HS6eA4TByspKJg5Ys43FyQRMwARMwATGTYABLUu/3+8hAlgjANg2Aek4gmBbqOjJsByegAq7iiZgAiZgAiZgAmkJnA3FHZsNymU5/PgobdkuzQRMwARMwARMYEII/C5ogaXs1cXhx6eh0p9MSMVdTRMwARMwARMwgTQE/hw0wL8pKv6Wwcfhb4uCNIBdigmYgAmYgAl0ncBfghj4oyq5IdIhxBR8GHYiDBxTIEpem4AJmIAJmMD0EDgXmvL7IAb+GTdpgyBg5+NAw+PhJ8sHYdkblrG/vCjUwckETMAETMAETKAZgbsh+9Ww/Ccs/wrL34IY2PDNgP8BQKksQoi1naQAAAAASUVORK5CYII=" alt="image-20210523231442459"></p>
<h3 id="添加事件-1"><a href="#添加事件-1" class="headerlink" title="#添加事件"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#添加事件-2">#</a>添加事件</h3><p><code>home.vue</code>添加<code>gotoSearch</code>方法，完成页面跳转。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">gotoSearch</span> () &#123;<br>  uni.<span class="hljs-title function_">navigateTo</span>(&#123;<br>    <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/subcom-pkg/search/search&#x27;</span><br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>完成效果：</p>
<p><img src="./assets/iShot2021-05-23 23.36.17.gif" alt="iShot2021-05-23 23.36.17"></p>
<h3 id="搜索历史功能"><a href="#搜索历史功能" class="headerlink" title="#搜索历史功能"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#搜索历史功能">#</a>搜索历史功能</h3><ul>
<li>本地数据缓存</li>
<li>新的搜索数据显示在最前面</li>
<li>点击垃圾桶删除所有数据，并只显示热门推荐</li>
<li>点击标签进行快速搜索</li>
</ul>
<p>本地数据缓存：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">data</span> () &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-attr">historyList</span>: uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&#x27;historyList&#x27;</span>) || [],<br>  &#125;<br>&#125;,<br></code></pre></td></tr></table></figure>
<p>添加对应的事件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 添加本地缓存</span><br><span class="hljs-title function_">addHis</span> (value) &#123;<br>  <span class="hljs-comment">// 标签去重</span><br>  <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">historyList</span>.<span class="hljs-title function_">indexOf</span>(value)<br>  <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">historyList</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)<br>  &#125;<br>  <span class="hljs-comment">// 最近搜索的标签，显示在最前端</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">historyList</span>.<span class="hljs-title function_">unshift</span>(value)<br>  <span class="hljs-comment">// 本地缓存</span><br>  uni.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">&#x27;historyList&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">historyList</span>)<br>&#125;,<br><span class="hljs-title function_">clearSearch</span> () &#123;<br>  <span class="hljs-comment">// 当用户点击搜索框右侧的清空按钮的逻辑</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">showResult</span> = <span class="hljs-literal">false</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">searchResults</span> = []<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span> = &#123;<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">page</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">limit</span>: <span class="hljs-number">20</span><br>  &#125;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span><br>&#125;,<br></code></pre></td></tr></table></figure>
<h3 id="搜索建议-列表"><a href="#搜索建议-列表" class="headerlink" title="#搜索建议(列表)"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#搜索建议-列表">#</a>搜索建议(列表)</h3><ul>
<li>完成推荐列表样式</li>
<li>设置请求参数</li>
<li>使用统一发送文章请求</li>
<li>本地展示列表，并隐藏推荐历史与热门推荐</li>
<li>清空搜索条件时，把推荐列表清空，并展示搜索历史&amp;热门推荐</li>
</ul>
<p>结构部分：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;search&quot;&gt;<br>    &lt;!-- 搜索框 --&gt;<br>    &lt;view class=&quot;search-box&quot;&gt;<br>      &lt;u-search v-model=&quot;searchValue&quot; @clear=&quot;clearSearch&quot;&gt;&lt;/u-search&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 搜索建议列表 --&gt;<br>    &lt;view class=&quot;list&quot; v-if=&quot;searchResults.length !== 0&quot;&gt;<br>      &lt;view class=&quot;item&quot; v-for=&quot;(item) in searchResults&quot; :key=&quot;item._id&quot; @click=&quot;gotoDetail(item)&quot;&gt;<br>        &lt;view class=&quot;name&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/view&gt;<br>        &lt;u-icon name=&quot;arrow-right&quot; size=&quot;25&quot;&gt;&lt;/u-icon&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;list no-result&quot; v-else-if=&quot;searchResults.length === 0 &amp;&amp; showResult&quot;&gt;<br>      这里空空如也~<br>    &lt;/view&gt;<br>    &lt;!-- 搜索历史 --&gt;<br>    &lt;view class=&quot;history-box&quot; v-else-if=&quot;historyList.length !== 0 &amp;&amp; searchResults.length === 0&quot;&gt;<br>      &lt;view class=&quot;history-title&quot;&gt;<br>        &lt;text&gt;搜索历史&lt;/text&gt;<br>        &lt;u-icon name=&quot;trash&quot; size=&quot;32&quot; @click=&quot;clearStorage&quot;&gt;&lt;/u-icon&gt;<br>      &lt;/view&gt;<br>      &lt;!-- 标签列表区域 --&gt;<br>      &lt;view class=&quot;history-list&quot;&gt;<br>        &lt;uni-tag :text=&quot;item&quot; v-for=&quot;(item,i) in historyList&quot; :key=&quot;i&quot; @click=&quot;quickSearch(item)&quot;&gt;&lt;/uni-tag&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 热门推荐 --&gt;<br>    &lt;view class=&quot;history-box&quot; v-if=&quot;!showResult&quot;&gt;<br>      &lt;view class=&quot;history-title&quot;&gt;<br>        &lt;text&gt;热门推荐&lt;/text&gt;<br>      &lt;/view&gt;<br>      &lt;!-- 标签列表区域 --&gt;<br>      &lt;view class=&quot;history-list&quot;&gt;<br>        &lt;uni-tag :text=&quot;item&quot; v-for=&quot;(item,i) in hotList&quot; :key=&quot;i&quot; @click=&quot;quickSearch(item)&quot;&gt;&lt;/uni-tag&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure>
<p>样式部分：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">// ...</span><br><span class="hljs-selector-class">.list</span> &#123;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span>;<br>  <span class="hljs-selector-class">.item</span> &#123;<br>    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;<br>    <span class="hljs-attribute">padding</span>: <span class="hljs-number">13px</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#efefef</span>;<br>    <span class="hljs-attribute">display</span>: flex;<br>    <span class="hljs-attribute">align-items</span>: center;<br>    <span class="hljs-attribute">justify-content</span>: space-between;<br>    &amp;<span class="hljs-selector-pseudo">:last-child</span> &#123;<br>      <span class="hljs-attribute">border-bottom</span>: none;<br>    &#125;<br>    <span class="hljs-selector-class">.name</span> &#123;<br>      <span class="hljs-attribute">white-space</span>: nowrap;<br>      <span class="hljs-attribute">overflow</span>: hidden;<br>      <span class="hljs-selector-tag">text</span>-<span class="hljs-attribute">overflow</span>: ellipsis;<br>      <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">3px</span>;<br>    &#125;<br>  &#125;<br>  &amp;<span class="hljs-selector-class">.no-result</span> &#123;<br>    <span class="hljs-selector-tag">text</span>-align: center;<br>    <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;<br>    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">28</span>rpx;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>methods部分:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 发起请求</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">getList</span> () &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span>) <span class="hljs-keyword">return</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">showResult</span> = <span class="hljs-literal">true</span><br>  <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">getList</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>)<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">searchResults</span> = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">searchResults</span>, ...data]<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span><br>&#125;,<br><span class="hljs-comment">// 点击热门推荐，快速搜索</span><br><span class="hljs-title function_">quickSearch</span> (item) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">searchValue</span> = item<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>.<span class="hljs-property">title</span> = item<br>  <span class="hljs-comment">// 添加到搜索历史</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addHis</span>(item)<br>  <span class="hljs-comment">// 发送搜索请求 -&gt; 请求文件列表</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getList</span>()<br>&#125;,<br></code></pre></td></tr></table></figure>
<h3 id="搜索按钮事件绑定"><a href="#搜索按钮事件绑定" class="headerlink" title="#搜索按钮事件绑定"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#搜索按钮事件绑定">#</a>搜索按钮事件绑定</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;u-search v-model=&quot;searchValue&quot; @clear=&quot;clearSearch&quot; @search=&quot;search&quot; @custom=&quot;search&quot;&gt;&lt;/u-search&gt;<br></code></pre></td></tr></table></figure>
<p>添加对应的search方法：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">search</span> (value) &#123;<br>  <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">&#x27;&#x27;</span>) &#123;<br>    uni.<span class="hljs-title function_">showToast</span>(&#123;<br>      <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;error&#x27;</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;关键词不得为空&#x27;</span>,<br>      <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>    &#125;)<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>.<span class="hljs-property">title</span> = value<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">quickSearch</span>(value)<br>&#125;,<br></code></pre></td></tr></table></figure>
<h3 id="整体代码"><a href="#整体代码" class="headerlink" title="#整体代码"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#整体代码">#</a>整体代码</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;search&quot;&gt;<br>    &lt;!-- 搜索框 --&gt;<br>    &lt;view class=&quot;search-box&quot;&gt;<br>      &lt;u-search v-model=&quot;searchValue&quot; @clear=&quot;clearSearch&quot; @search=&quot;search&quot; @custom=&quot;search&quot;&gt;&lt;/u-search&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 搜索建议列表 --&gt;<br>    &lt;view class=&quot;list&quot; v-if=&quot;searchResults.length !== 0&quot;&gt;<br>      &lt;view class=&quot;item&quot; v-for=&quot;(item) in searchResults&quot; :key=&quot;item._id&quot; @click=&quot;gotoDetail(item)&quot;&gt;<br>        &lt;view class=&quot;name&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/view&gt;<br>        &lt;u-icon name=&quot;arrow-right&quot; size=&quot;25&quot;&gt;&lt;/u-icon&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;list no-result&quot; v-else-if=&quot;searchResults.length === 0 &amp;&amp; showResult&quot;&gt;<br>      这里空空如也~<br>    &lt;/view&gt;<br>    &lt;!-- 搜索历史 --&gt;<br>    &lt;view class=&quot;history-box&quot; v-else-if=&quot;historyList.length !== 0 &amp;&amp; searchResults.length === 0&quot;&gt;<br>      &lt;view class=&quot;history-title&quot;&gt;<br>        &lt;text&gt;搜索历史&lt;/text&gt;<br>        &lt;u-icon name=&quot;trash&quot; size=&quot;32&quot; @click=&quot;clearStorage&quot;&gt;&lt;/u-icon&gt;<br>      &lt;/view&gt;<br>      &lt;!-- 标签列表区域 --&gt;<br>      &lt;view class=&quot;history-list&quot;&gt;<br>        &lt;uni-tag :text=&quot;item&quot; v-for=&quot;(item,i) in historyList&quot; :key=&quot;i&quot; @click=&quot;quickSearch(item)&quot;&gt;&lt;/uni-tag&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;!-- 热门推荐 --&gt;<br>    &lt;view class=&quot;history-box&quot; v-if=&quot;!showResult&quot;&gt;<br>      &lt;view class=&quot;history-title&quot;&gt;<br>        &lt;text&gt;热门推荐&lt;/text&gt;<br>      &lt;/view&gt;<br>      &lt;!-- 标签列表区域 --&gt;<br>      &lt;view class=&quot;history-list&quot;&gt;<br>        &lt;uni-tag :text=&quot;item&quot; v-for=&quot;(item,i) in hotList&quot; :key=&quot;i&quot; @click=&quot;quickSearch(item)&quot;&gt;&lt;/uni-tag&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  data () &#123;<br>    return &#123;<br>      searchValue: &#x27;&#x27;,<br>      historyList: uni.getStorageSync(&#x27;historyList&#x27;) || [],<br>      hotList: [&#x27;前端&#x27;, &#x27;vue&#x27;, &#x27;node&#x27;, &#x27;面试&#x27;, &#x27;react&#x27;, &#x27;devops&#x27;, &#x27;flutter&#x27;, &#x27;MySQL&#x27;, &#x27;gitlab&#x27;, &#x27;redis&#x27;, &#x27;git&#x27;, &#x27;typescript&#x27;, &#x27;升职&#x27;, &#x27;B站&#x27;],<br>      page: &#123;<br>        title: &#x27;&#x27;,<br>        page: 0,<br>        limit: 20<br>      &#125;,<br>      loading: false,<br>      searchResults: [],<br>      showResult: false<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    search (value) &#123;<br>      if (value.trim() === &#x27;&#x27;) &#123;<br>        uni.showToast(&#123;<br>          icon: &#x27;error&#x27;,<br>          title: &#x27;关键词不得为空&#x27;,<br>          duration: 2000<br>        &#125;)<br>        return<br>      &#125;<br>      this.page.title = value<br>      this.quickSearch(value)<br>    &#125;,<br>    addHis (value) &#123;<br>      // 标签去重<br>      const index = this.historyList.indexOf(value)<br>      if (index !== -1) &#123;<br>        this.historyList.splice(index, 1)<br>      &#125;<br>      // 最近搜索的标签，显示在最前端<br>      this.historyList.unshift(value)<br>      // 本地缓存<br>      uni.setStorageSync(&#x27;historyList&#x27;, this.historyList)<br>    &#125;,<br>    async getList () &#123;<br>      if (this.loading) return<br>      this.loading = true<br>      this.showResult = true<br>      const &#123; data &#125; = await this.$u.api.getList(this.page)<br>      this.searchResults = [...this.searchResults, ...data]<br>      this.loading = false<br>    &#125;,<br>    // 点击热门推荐，快速搜索<br>    quickSearch (item) &#123;<br>      this.searchValue = item<br>      this.page.title = item<br>      // 添加到搜索历史<br>      this.addHis(item)<br>      // 发送搜索请求 -&gt; 请求文件列表<br>      this.getList()<br>    &#125;,<br>    clearSearch () &#123;<br>      // 当用户点击搜索框右侧的清空按钮的逻辑<br>      this.showResult = false<br>      this.searchResults = []<br>      this.page = &#123;<br>        title: &#x27;&#x27;,<br>        page: 0,<br>        limit: 20<br>      &#125;<br>      this.loading = false<br>    &#125;,<br>    gotoDetail (item) &#123;<br>      // 文章详情<br>      console.log(&#x27;🚀 ~ file: search.vue ~ line 99 ~ gotoDetail ~ item&#x27;, item)<br>    &#125;,<br>    clearStorage () &#123;<br>      this.historyList = []<br>      uni.setStorageSync(&#x27;historyList&#x27;, [])<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.search &#123;<br>  padding: 24rpx;<br>&#125;<br><br>.search-box &#123;<br>  padding-bottom: 50rpx;<br>&#125;<br><br>.history-box &#123;<br>  padding: 0 10rpx 50rpx;<br>  .history-title &#123;<br>    display: flex;<br>    justify-content: space-between;<br>    align-items: center;<br>    height: 40px;<br>    font-size: 16px;<br>    font-weight: bold;<br>  &#125;<br><br>  .history-list &#123;<br>    display: flex;<br>    flex-wrap: wrap;<br>    ::v-deep .uni-tag &#123;<br>      margin-top: 5px;<br>      margin-right: 5px;<br>      border-radius: 25rpx;<br>    &#125;<br>  &#125;<br>&#125;<br><br>.list &#123;<br>  padding: 0 5px;<br>  .item &#123;<br>    font-size: 12px;<br>    padding: 13px 0;<br>    border-bottom: 1px solid #efefef;<br>    display: flex;<br>    align-items: center;<br>    justify-content: space-between;<br>    &amp;:last-child &#123;<br>      border-bottom: none;<br>    &#125;<br>    .name &#123;<br>      white-space: nowrap;<br>      overflow: hidden;<br>      text-overflow: ellipsis;<br>      margin-right: 3px;<br>    &#125;<br>  &#125;<br>  &amp;.no-result &#123;<br>    text-align: center;<br>    color: #666;<br>    font-size: 28rpx;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h2 id="发帖入口"><a href="#发帖入口" class="headerlink" title="#发帖入口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#发帖入口">#</a>发帖入口</h2><h3 id="布局与样式-4"><a href="#布局与样式-4" class="headerlink" title="#布局与样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#布局与样式-5">#</a>布局与样式</h3><p>在<code>home.vue</code>添加发帖入口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;image class=&quot;add-post&quot; src=&quot;/static/images/add-post.png&quot; /&gt;<br></code></pre></td></tr></table></figure>
<p>修改<code>add-post</code>样式</p>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-selector-class">.add-post</span> &#123;<br>  <span class="hljs-attribute">position</span>: fixed;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">150</span>rpx;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">150</span>rpx;<br>  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">30</span>rpx;<br>  <span class="hljs-attribute">right</span>: <span class="hljs-number">10</span>rpx;<br>  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">999</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>完成效果</p>
<p><img src="uniapp.assets/image-20210527004752928.affac181.png" alt="image-20210527004752928"></p>
<h3 id="添加事件-2"><a href="#添加事件-2" class="headerlink" title="#添加事件"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/02-首页模块.html#添加事件-3">#</a>添加事件</h3><p>添加点击事件，点击跳转发帖页面</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">newContent</span> () &#123;<br>  uni.<span class="hljs-title function_">navigateTo</span>(&#123;<br>    <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/subcom-pkg/post/post&#x27;</span><br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="小程序鉴权登录"><a href="#小程序鉴权登录" class="headerlink" title="#小程序鉴权登录"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#小程序鉴权登录">#</a>小程序鉴权登录</h1><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="#需求分析"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#需求分析">#</a>需求分析</h2><p>流程分析：</p>
<p><img src="uniapp.assets/api-login.2fcc9f35.2fcc9f35.jpg" alt="img"></p>
<p>说明：</p>
<ul>
<li>时序图的阅读方式：<ul>
<li>搞清楚有几方，哪几个重要的交互部分，比如：上面有小程序、开发服务器、小程序官方后台；</li>
<li>从上至下，从左至右，跟随箭头的方向走；</li>
<li>时序图中，任何一个流程中断，后续的相关流程不会继续进行；</li>
</ul>
</li>
</ul>
<p>通过分析，我们获取用户的信息用于创建用户，并通过自己的服务器返回用户的登录态，即token信息与用户信息。</p>
<p>用户信息需要跨页面进行共享，同时，也需要持久化，所以惯性的思考到了 vuex + 本地缓存的方案。</p>
<h2 id="Vuex集成uniapp"><a href="#Vuex集成uniapp" class="headerlink" title="#Vuex集成uniapp"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#vuex集成uniapp">#</a>Vuex集成uniapp</h2><h3 id="初始化store"><a href="#初始化store" class="headerlink" title="#初始化store"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#初始化store">#</a>初始化store</h3><p>重要：uniapp中内置vuex，所以直接按照vue中使用vuex的步骤进行集成。</p>
<p>创建文件<code>store/index.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vuex&#x27;</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>);<span class="hljs-comment">//vue的插件机制</span><br><br><span class="hljs-comment">//Vuex.Store 构造器选项</span><br><span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>(&#123;<br>    <span class="hljs-attr">state</span>:&#123;<br>      <span class="hljs-comment">//存放状态</span><br>      <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store<br></code></pre></td></tr></table></figure>
<p>在 <code>main.js</code> 中导入文件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./App&#x27;</span><br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./store&#x27;</span><br><br><span class="hljs-comment">// 把 store 对象提供给 “store” 选项，这可以把 store 的实例注入所有的子组件</span><br><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;<br>    store,<br>    ...<span class="hljs-title class_">App</span><br>&#125;)<br>app.$mount()<br></code></pre></td></tr></table></figure>
<p>state使用上的区别：</p>
<ul>
<li>直接在template中不能使用<code>$store</code>取值；</li>
<li>在data中无法使用<code>this.$store.state</code>取对应的初始值；</li>
</ul>
<p>正确的打开姿势：</p>
<ul>
<li>辅助函数（推荐）</li>
<li>computed方法</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// store.js</span><br><span class="hljs-keyword">const</span> state = &#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;hello Vuex&#x27;</span><br>&#125;<br><br><br><span class="hljs-comment">// 组件中</span><br><span class="hljs-attr">computed</span>: &#123;<br>  <span class="hljs-comment">// 方法一：辅助函数</span><br>  <span class="hljs-comment">// ...mapState([&#x27;count&#x27;]),</span><br>  <span class="hljs-comment">// ...mapState(&#123;</span><br>  <span class="hljs-comment">//   msg2: (state) =&gt; state.msg</span><br>  <span class="hljs-comment">// &#125;),</span><br>  <span class="hljs-comment">// 方法二：computed</span><br>  <span class="hljs-title function_">count1</span> () &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span><br>  &#125;,<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="如何进行调试"><a href="#如何进行调试" class="headerlink" title="#如何进行调试"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#如何进行调试">#</a>如何进行调试</h3><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vuex&#x27;</span><br><span class="hljs-keyword">import</span> createLogger <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vuex/dist/logger&#x27;</span><br><br><span class="hljs-comment">// 获取执行环境变量</span><br><span class="hljs-keyword">const</span> debug = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span><br><span class="hljs-comment">// console.log(&#x27;🚀 ~ file: index.js ~ line 5 ~ debug&#x27;, debug)</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)<br><br><span class="hljs-keyword">const</span> state = &#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;hello Vuex&#x27;</span><br>&#125;<br><br><span class="hljs-keyword">const</span> mutations = &#123;<br>  <span class="hljs-comment">// 测试Mutation</span><br>  <span class="hljs-title function_">add</span> (state, payload) &#123;<br>    state.<span class="hljs-property">count</span> += payload<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> actions = &#123;&#125;<br><br><span class="hljs-keyword">const</span> getters = &#123;&#125;<br><br><span class="hljs-comment">// 添加vuex日志插件</span><br><span class="hljs-keyword">const</span> plugins = debug ? [<span class="hljs-title function_">createLogger</span>()] : []<br><br><span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>(&#123;<br>  state,<br>  mutations,<br>  actions,<br>  getters,<br>  plugins<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> store<br></code></pre></td></tr></table></figure>
<p>当我们在页面触发mutation的时候：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">mounted</span> () &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getList</span>()<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;add&#x27;</span>, <span class="hljs-number">100</span>)<br>  &#125;, <span class="hljs-number">2000</span>)<br>  <span class="hljs-comment">// console.log(this.$store)</span><br>&#125;,<br></code></pre></td></tr></table></figure>
<p>即可以收到console中的打印日志：</p>
<p><img src="uniapp.assets/image-20210723135408789.c89a35bf.png" alt="image-20210723135408789"></p>
<h2 id="微信官方服务相关"><a href="#微信官方服务相关" class="headerlink" title="#微信官方服务相关"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#微信官方服务相关">#</a>微信官方服务相关</h2><h3 id="获取AppID与AppSecret"><a href="#获取AppID与AppSecret" class="headerlink" title="#获取AppID与AppSecret"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#获取appid与appsecret">#</a>获取AppID与AppSecret</h3><p>登录小程序的后台 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/(opens new window)</a></p>
<p><img src="uniapp.assets/image-20210724102639423.71ad0747.png" alt="image-20210724102639423"></p>
<h3 id="unionid与openid"><a href="#unionid与openid" class="headerlink" title="#unionid与openid"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#unionid与openid">#</a>unionid与openid</h3><ul>
<li><p>什么是unionid，openid？</p>
<p>openid是用户在当前小程序的唯一标识；</p>
<p>unionid是用户在开放平台的唯一标识符，若当前小程序已绑定到微信开放平台帐号下会返回；</p>
</li>
<li><p>两者的区别在哪里？unionid的作用是什么？</p>
<p>都是唯一标识，针对的平台不一样，openid针对小程序，unionid针对开放平台；</p>
<p>开放平台是指：<a target="_blank" rel="noopener" href="https://open.weixin.qq.com/">https://open.weixin.qq.com/(opens new window)</a></p>
<p>如果开发者拥有多个移动应用、网站应用、和公众帐号（包括小程序），可通过 UnionID 来区分用户的唯一性，因为只要是同一个微信开放平台帐号下的移动应用、网站应用和公众帐号（包括小程序），用户的 UnionID 是唯一的。</p>
<p><strong>换句话说，同一用户，对同一个微信开放平台下的不同应用，UnionID是相同的。</strong></p>
<p><strong>如果没有微信侧多应用场景（公众号、小程序、网页互通的需求），可以不用弄这个开放平台的账号。</strong></p>
</li>
<li><p>unionID如何获取？</p>
<p>绑定了开放平台开发者帐号的小程序，可以通过以下途径获取 UnionID。</p>
<ol>
<li>开发者可以直接通过 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">wx.login (opens new window)</a>+ <code>code2Session</code> 获取到该用户 UnionID，无须用户授权。</li>
<li>小程序端调用云函数时，可在云函数中通过 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/utils/Cloud.getWXContext.html">Cloud.getWXContext (opens new window)</a>获取 UnionID。</li>
</ol>
</li>
<li><p>开放平台如何注册与使用？</p>
<p>开放平台需要在<a target="_blank" rel="noopener" href="https://open.weixin.qq.com/">开放平台地址 (opens new window)</a>注册，同时需要认证后才能使用。</p>
<p><img src="uniapp.assets/image-20210724102333624.d28d20ad.png" alt="image-20210724102333624"></p>
<p>认证费用300元（xxxx马x腾）</p>
</li>
</ul>
<h3 id="获取用户OpenData"><a href="#获取用户OpenData" class="headerlink" title="#获取用户OpenData"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#获取用户opendata">#</a>获取用户OpenData</h3><p>登录凭证校验，通过 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html">wx.login (opens new window)</a>接口获得临时登录凭证 code 后传到开发者服务器调用此接口完成登录流程。更多使用方法详见 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html">小程序登录 (opens new window)</a>。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 记录微信相关的接口， API项目 -&gt; 微信官方服务器</span><br><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;axios&#x27;</span><br><span class="hljs-keyword">import</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/config&#x27;</span><br><br><span class="hljs-keyword">const</span> instance = axios.<span class="hljs-title function_">create</span>(&#123;<br>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span><br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxGetOpenData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">code</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">get</span>(<span class="hljs-string">`https://api.weixin.qq.com/sns/jscode2session?appid=<span class="hljs-subst">$&#123;config.AppID&#125;</span>&amp;secret=<span class="hljs-subst">$&#123;config.AppSecret&#125;</span>&amp;js_code=<span class="hljs-subst">$&#123;code&#125;</span>&amp;grant_type=authorization_code`</span>)<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: WxUtils.js ~ line 11 ~ wxGetOpenData ~ res&#x27;</span>, res)<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="鉴权页面样式"><a href="#鉴权页面样式" class="headerlink" title="#鉴权页面样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#鉴权页面样式">#</a>鉴权页面样式</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div class=&quot;auth&quot;&gt;<br>    &lt;view class=&quot;title&quot;&gt;<br>      &lt;image src=&quot;/static/images/logo.jpg&quot; mode=&quot;aspectFill&quot; /&gt;<br>      &lt;text&gt;toimc技术社区&lt;/text&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;container&quot;&gt;<br>      &lt;u-button type=&quot;primary&quot; @click=&quot;login&quot; hover-class=&quot;none&quot;&gt;<br>        &lt;u-icon name=&quot;weixin-fill&quot; size=&quot;32&quot; color=&quot;#fff&quot;&gt;&lt;/u-icon&gt;<br>        &lt;text&gt;微信登录&lt;/text&gt;<br>      &lt;/u-button&gt;<br>      &lt;u-button plain :custom-style=&quot;customStyle&quot; hover-class=&quot;none&quot; @click=&quot;goto&quot;&gt;手机号登录&lt;/u-button&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;forbid&quot; @click=&quot;leave&quot;&gt;暂不登录&lt;/view&gt;<br>    &lt;u-toast ref=&quot;uToast&quot; /&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; mapMutations, mapGetters &#125; from &#x27;vuex&#x27;<br>import auth from &#x27;@/mixins/auth&#x27;<br><br>export default &#123;<br>  components: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    customStyle: &#123;<br>      &#x27;margin-top&#x27;: &#x27;40rpx&#x27;,<br>      &#x27;background-color&#x27;: &#x27;#fff&#x27;,<br>      color: &#x27;#02d199&#x27;<br>    &#125;<br>  &#125;),<br>  mixins: [auth],<br>  computed: &#123;<br>    ...mapGetters([&#x27;isLogin&#x27;])<br>  &#125;,<br>  methods: &#123;<br>    ...mapMutations([&#x27;setIsLogin&#x27;, &#x27;setWxInfo&#x27;, &#x27;setToken&#x27;, &#x27;setUserInfo&#x27;]),<br>    goto () &#123;<br>      uni.navigateTo(&#123;<br>        url: &#x27;/subcom-pkg/auth/mobile-login&#x27;<br>      &#125;)<br>    &#125;,<br>    login () &#123;<br>      // 获取用户信息<br>      // todo<br>    &#125;,<br>    leave () &#123;<br>			// todo<br>      uni.navigateBack()<br>    &#125;<br>  &#125;,<br>  watch: &#123;&#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot;&gt;<br>.title &#123;<br>  display: flex;<br>  flex-flow: column nowrap;<br>  align-items: center;<br>  justify-content: center;<br>  height: 500rpx;<br>  width: 100vw;<br>  image &#123;<br>    width: 168rpx;<br>    height: 168rpx;<br>    border-radius: 50%;<br>    box-shadow: 0 0 10px rgba($color: #000000, $alpha: 0.1);<br>  &#125;<br>  text &#123;<br>    margin-top: 32rpx;<br>    font-size: 32rpx;<br>    color: #333;<br>    font-weight: 500;<br>  &#125;<br>&#125;<br><br>.container &#123;<br>  padding: 32rpx;<br>&#125;<br><br>.forbid &#123;<br>  position: fixed;<br>  bottom: 60px;<br>  left: 0;<br>  width: 100%;<br>  text-align: center;<br>  font-size: 28rpx;<br>  text-decoration: underline;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h2 id="解密微信数据"><a href="#解密微信数据" class="headerlink" title="#解密微信数据"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#解密微信数据">#</a>解密微信数据</h2><h3 id="用户信息的解密"><a href="#用户信息的解密" class="headerlink" title="#用户信息的解密"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#用户信息的解密">#</a>用户信息的解密</h3><ul>
<li><p>小程序调用<code>getUserProfile</code>，获取用户加密数据 + 证书，请求用户后台；</p>
</li>
<li><p>后台进行加密数据的校验，确定用户传递的数据是微信侧的数据；</p>
<p>signature = sha1( rawData + session_key )算是校验成功；</p>
</li>
<li><p>加密数据解密，参考官方的<a target="_blank" rel="noopener" href="https://res.wx.qq.com/wxdoc/dist/assets/media/aes-sample.eae1f364.zip">代码 (opens new window)</a>；</p>
</li>
</ul>
<p>官方说明<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html#加密数据解密算法">链接(opens new window)</a></p>
<p><img src="uniapp.assets/signature.8a30a825.8a30a825.jpg" alt="img"></p>
<p>代码示例：</p>
<p>微信解密工具js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> crypto <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;crypto&#x27;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">WXBizDataCrypt</span> (<span class="hljs-params">appId, sessionKey</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">appId</span> = appId<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionKey</span> = sessionKey<br>&#125;<br><br><span class="hljs-title class_">WXBizDataCrypt</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">decryptData</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">encryptedData, iv</span>) &#123;<br>  <span class="hljs-comment">// base64 decode</span><br>  <span class="hljs-keyword">let</span> sessionKey = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">sessionKey</span>, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>  encryptedData = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(encryptedData, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>  iv = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(iv, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>  <span class="hljs-keyword">let</span> decoded<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 解密</span><br>    <span class="hljs-keyword">let</span> decipher = crypto.<span class="hljs-title function_">createDecipheriv</span>(<span class="hljs-string">&#x27;aes-128-cbc&#x27;</span>, sessionKey, iv)<br>    <span class="hljs-comment">// 设置自动 padding 为 true，删除填充补位</span><br>    decipher.<span class="hljs-title function_">setAutoPadding</span>(<span class="hljs-literal">true</span>)<br>    decoded = decipher.<span class="hljs-title function_">update</span>(encryptedData, <span class="hljs-string">&#x27;binary&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>)<br>    decoded += decipher.<span class="hljs-title function_">final</span>(<span class="hljs-string">&#x27;utf8&#x27;</span>)<br><br>    decoded = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(decoded)<br>  &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Illegal Buffer&#x27;</span>)<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (decoded.<span class="hljs-property">watermark</span>.<span class="hljs-property">appid</span> !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">appId</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Illegal Buffer&#x27;</span>)<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> decoded<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">WXBizDataCrypt</span><br></code></pre></td></tr></table></figure>
<p>微信工具js的封装：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 记录微信相关的接口， API项目 -&gt; 微信官方服务器</span><br><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;axios&#x27;</span><br><span class="hljs-keyword">import</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/config&#x27;</span><br><span class="hljs-keyword">import</span> crypto <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;crypto&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">WXBizDataCrypt</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./WXBizDataCrypt&#x27;</span><br><br><span class="hljs-keyword">const</span> instance = axios.<span class="hljs-title function_">create</span>(&#123;<br>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span><br>&#125;)<br><br><span class="hljs-comment">// 获取session_key，openid 等OpenData数据</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxGetOpenData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">code</span>) =&gt; &#123;<br>  <span class="hljs-comment">// sessin_key, openid, unoinid</span><br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">get</span>(<span class="hljs-string">`https://api.weixin.qq.com/sns/jscode2session?appid=<span class="hljs-subst">$&#123;config.AppID&#125;</span>&amp;secret=<span class="hljs-subst">$&#123;config.AppSecret&#125;</span>&amp;js_code=<span class="hljs-subst">$&#123;code&#125;</span>&amp;grant_type=authorization_code`</span>)<br>  <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: WxUtils.js ~ line 11 ~ wxGetOpenData ~ res&#x27;, res)</span><br>  <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span><br>&#125;<br><br><span class="hljs-comment">// 获取解密用户的信息</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxGetUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">user, code</span>) =&gt; &#123;<br>  <span class="hljs-comment">// 1.获取用户的openData -&gt; session_key</span><br>  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetOpenData</span>(code)<br>  <span class="hljs-keyword">const</span> sessionKey = data.<span class="hljs-property">session_key</span><br>  <span class="hljs-comment">// 2.用户数据进行签名校验 -&gt; sha1 -&gt; session_key + rawData + signature</span><br>  <span class="hljs-keyword">const</span> &#123; rawData, signature, encryptedData, iv &#125; = user<br>  <span class="hljs-keyword">const</span> sha1 = crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">&#x27;sha1&#x27;</span>)<br>  sha1.<span class="hljs-title function_">update</span>(rawData)<br>  sha1.<span class="hljs-title function_">update</span>(sessionKey)<br>  <span class="hljs-keyword">if</span> (sha1.<span class="hljs-title function_">digest</span>(<span class="hljs-string">&#x27;hex&#x27;</span>) !== signature) &#123;<br>    <span class="hljs-comment">// 校验失败</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(&#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;签名校验失败&#x27;</span><br>      &#125;)<br>    )<br>  &#125;<br>  <span class="hljs-keyword">const</span> wxBizDataCrypt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WXBizDataCrypt</span>(config.<span class="hljs-property">AppID</span>, sessionKey)<br>  <span class="hljs-comment">// 3.用户加密数据的解密</span><br>  <span class="hljs-keyword">const</span> userInfo = wxBizDataCrypt.<span class="hljs-title function_">decryptData</span>(encryptedData, iv)<br>  <span class="hljs-keyword">return</span> &#123; ...userInfo, ...data &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>小程序侧：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span> () &#123;<br>  uni.<span class="hljs-title function_">login</span>(&#123;<br>    <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span> = e.<span class="hljs-property">code</span><br>    &#125;<br>  &#125;)<br>  uni.<span class="hljs-title function_">getUserProfile</span>(&#123;<br>    <span class="hljs-attr">lang</span>: <span class="hljs-string">&#x27;zh_CN&#x27;</span>,<br>    <span class="hljs-attr">desc</span>: <span class="hljs-string">&#x27;用于完善会员资料&#x27;</span>,<br>    <span class="hljs-attr">success</span>: <span class="hljs-title function_">async</span> (e) =&gt; &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: auth.vue ~ line 37 ~ test ~ e&#x27;</span>, e)<br>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">wxLogin</span>(&#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span>,<br>        <span class="hljs-attr">user</span>: e<br>      &#125;)<br>    &#125;,<br>    <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: auth.vue ~ line 40 ~ test ~ e&#x27;</span>, e)<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>
<p>需要注意的点：</p>
<ul>
<li>uni.login不需要用户感知的触发与uni.getUserProfile需要tap（用户点击）事件触发；</li>
<li>uni.login与uni.getUserProfile如果需要同时使用，可以都使用callback回调的形式来使用；</li>
</ul>
<h3 id="用户登录凭证维护"><a href="#用户登录凭证维护" class="headerlink" title="#用户登录凭证维护"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#用户登录凭证维护">#</a>用户登录凭证维护</h3><p>防止code失效，而请求失败。</p>
<p>解决办法：前端设置定时任务，每隔&lt;5分钟的时间，请求一次<code>uni.login</code>刷新登录凭证。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">&lt;script&gt;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-attr">components</span>: &#123;&#125;,<br>  <span class="hljs-attr">data</span>: <span class="hljs-function">() =&gt;</span> (&#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">ctrl</span>: <span class="hljs-literal">null</span><br>  &#125;),<br>  <span class="hljs-attr">computed</span>: &#123;&#125;,<br>  <span class="hljs-title function_">created</span> () &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNewCode</span>()<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCron</span>()<br>  &#125;,<br>  <span class="hljs-title function_">onShow</span> () &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNewCode</span>()<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCron</span>()<br>  &#125;,<br>  <span class="hljs-title function_">onHide</span> () &#123;<br>    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctrl</span>)<br>  &#125;,<br>  <span class="hljs-comment">// 用户离开当前页面</span><br>  <span class="hljs-title function_">onUnload</span> () &#123;<br>    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctrl</span>)<br>  &#125;,<br>  <span class="hljs-attr">methods</span>: &#123;<br>    <span class="hljs-comment">// 获取code</span><br>    <span class="hljs-title function_">getNewCode</span> () &#123;<br>      uni.<span class="hljs-title function_">login</span>(&#123;<br>        <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span> = e.<span class="hljs-property">code</span><br>        &#125;<br>      &#125;)<br>    &#125;,<br>    <span class="hljs-comment">// 设置定时任务</span><br>    <span class="hljs-title function_">setCron</span> () &#123;<br>      <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">ctrl</span>)<br>      <span class="hljs-comment">// 定时刷新code的方法</span><br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ctrl</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNewCode</span>()<br>        <span class="hljs-comment">// 重新进行cron，保证code的有效性</span><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCron</span>()<br>      &#125;, <span class="hljs-number">4</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)<br>    &#125;,<br>  &#125;,<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<h3 id="用户登录接口"><a href="#用户登录接口" class="headerlink" title="#用户登录接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#用户登录接口">#</a>用户登录接口</h3><p><strong>接口部分:</strong></p>
<p>产生token：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 生成 token 返回给客户端</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">generateToken</span> = (<span class="hljs-params">payload, expire = <span class="hljs-string">&#x27;1h&#x27;</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (payload) &#123;<br>    <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">sign</span>(<br>      &#123;<br>        ...payload,<br>      &#125;,<br>      config.<span class="hljs-property">JWT_SECRET</span>,<br>      &#123; <span class="hljs-attr">expiresIn</span>: expire &#125;<br>    )<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;生成token失败！&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>随机用户名：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">rand</span> = (<span class="hljs-params">len = <span class="hljs-number">8</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> possible = <span class="hljs-string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#x27;</span><br>  <span class="hljs-keyword">let</span> text = <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>    text += possible.<span class="hljs-title function_">charAt</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * possible.<span class="hljs-property">length</span>))<br>  &#125;<br>  <span class="hljs-keyword">return</span> text<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getTempName</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">// 返回用户邮箱</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;toimc_&#x27;</span> + <span class="hljs-title function_">rand</span>() + <span class="hljs-string">&#x27;@toimc.com&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>微信解密用户信息的<code>wxUtils.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取解密用户的信息</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxGetUserInfo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">user, code</span>) =&gt; &#123;<br>  <span class="hljs-comment">// 1.获取用户的openData -&gt; session_key</span><br>  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetOpenData</span>(code)<br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">session_key</span>: sessionKey &#125; = data<br>  <span class="hljs-keyword">if</span> (sessionKey) &#123;<br>    <span class="hljs-comment">// 2.用户数据进行签名校验 -&gt; sha1 -&gt; session_key + rawData + signature</span><br>    <span class="hljs-keyword">const</span> &#123; rawData, signature, encryptedData, iv &#125; = user<br>    <span class="hljs-keyword">const</span> sha1 = crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">&#x27;sha1&#x27;</span>)<br>    sha1.<span class="hljs-title function_">update</span>(rawData)<br>    sha1.<span class="hljs-title function_">update</span>(sessionKey)<br>    <span class="hljs-keyword">if</span> (sha1.<span class="hljs-title function_">digest</span>(<span class="hljs-string">&#x27;hex&#x27;</span>) !== signature) &#123;<br>      <span class="hljs-comment">// 校验失败</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(&#123;<br>          <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>          <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;签名校验失败&#x27;</span><br>        &#125;)<br>      )<br>    &#125;<br>    <span class="hljs-keyword">const</span> wxBizDataCrypt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WXBizDataCrypt</span>(config.<span class="hljs-property">AppID</span>, sessionKey)<br>    <span class="hljs-comment">// 3.用户加密数据的解密</span><br>    <span class="hljs-keyword">const</span> userInfo = wxBizDataCrypt.<span class="hljs-title function_">decryptData</span>(encryptedData, iv)<br>    <span class="hljs-keyword">return</span> &#123; ...userInfo, ...data, <span class="hljs-attr">errcode</span>: <span class="hljs-number">0</span> &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// data -&gt; errcode非0 ，请求失败</span><br>    <span class="hljs-keyword">return</span> data<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>查询并创建用户<code>User.js</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-attr">findOrCreateByUnionid</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findOne</span>(&#123;<br>    <span class="hljs-attr">unionid</span>: user.<span class="hljs-property">unionid</span><br>    <span class="hljs-comment">// openid: user.openid</span><br>  &#125;, &#123;<br>    <span class="hljs-attr">unionid</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">password</span>: <span class="hljs-number">0</span><br>  &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">obj</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> (<br>      obj || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">create</span>(&#123;<br>        <span class="hljs-attr">openid</span>: user.<span class="hljs-property">openid</span>,<br>        <span class="hljs-attr">unionid</span>: user.<span class="hljs-property">unionid</span>,<br>        <span class="hljs-attr">username</span>: <span class="hljs-title function_">getTempName</span>(),<br>        <span class="hljs-attr">name</span>: user.<span class="hljs-property">nickName</span>,<br>        <span class="hljs-attr">roles</span>: [<span class="hljs-string">&#x27;user&#x27;</span>],<br>        <span class="hljs-attr">gender</span>: user.<span class="hljs-property">gender</span>,<br>        <span class="hljs-attr">pic</span>: user.<span class="hljs-property">avatarUrl</span>,<br>        <span class="hljs-attr">location</span>: user.<span class="hljs-property">city</span><br>      &#125;)<br>    )<br>  &#125;)<br>&#125;,<br></code></pre></td></tr></table></figure>
<p><code>LoginController.js</code>微信登录接口：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 微信登录</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">wxLogin</span> (ctx) &#123;<br>  <span class="hljs-comment">// 1.解密用户信息</span><br>  <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>  <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: LoginController.js ~ line 223 ~ LoginController ~ wxLogin ~ body&#x27;, body)</span><br>  <span class="hljs-keyword">const</span> &#123; user, code &#125; = body<br>  <span class="hljs-keyword">if</span> (!code) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;没有足够参数&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetUserInfo</span>(user, code)<br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">errcode</span> === <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">// 2.查询数据库 -&gt; 判断用户是否存在</span><br>    <span class="hljs-comment">// 3.如果不存在 —&gt; 创建用户</span><br>    <span class="hljs-comment">// 4.如果存在 -&gt; 获取用户信息</span><br>    <span class="hljs-keyword">const</span> tmpUser = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOrCreateByUnionid</span>(res)<br>    <span class="hljs-comment">// 5.产生token，获取用户的签到状态</span><br>    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">generateToken</span>(&#123; <span class="hljs-attr">_id</span>: tmpUser.<span class="hljs-property">_id</span> &#125;)<br>    <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addSign</span>(tmpUser)<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>      <span class="hljs-attr">data</span>: userInfo,<br>      token<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">501</span>, res.<span class="hljs-property">errcode</span> === <span class="hljs-number">40163</span> ? <span class="hljs-string">&#x27;code已失效，请刷新后重试&#x27;</span> : <span class="hljs-string">&#x27;获取用户信息失败，请重试&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>获取access_token，并按两小时维护：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxGetAccessToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">flag = <span class="hljs-literal">false</span></span>) =&gt; &#123;<br>  <span class="hljs-comment">// https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</span><br>  <span class="hljs-keyword">let</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-string">&#x27;accessToken&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (!accessToken || flag) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">get</span>(<br>        <span class="hljs-string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=<span class="hljs-subst">$&#123;config.AppID&#125;</span>&amp;secret=<span class="hljs-subst">$&#123;config.AppSecret&#125;</span>`</span><br>      )<br>      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) &#123;<br>        <span class="hljs-comment">// 说明请求成功</span><br>        <span class="hljs-keyword">await</span> <span class="hljs-title function_">setValue</span>(<br>          <span class="hljs-string">&#x27;accessToken&#x27;</span>,<br>          result.<span class="hljs-property">data</span>.<span class="hljs-property">access_token</span>,<br>          result.<span class="hljs-property">data</span>.<span class="hljs-property">expires_in</span><br>        )<br>        accessToken = result.<span class="hljs-property">data</span>.<span class="hljs-property">access_token</span><br>        <span class="hljs-comment">// &#123;&quot;errcode&quot;:40013,&quot;errmsg&quot;:&quot;invalid appid&quot;&#125;</span><br>        <span class="hljs-keyword">if</span> (result.<span class="hljs-property">data</span>.<span class="hljs-property">errcode</span> &amp;&amp; result.<span class="hljs-property">data</span>.<span class="hljs-property">errmsg</span>) &#123;<br>          logger.<span class="hljs-title function_">error</span>(<br>            <span class="hljs-string">`Wx-GetAccessToken Error: <span class="hljs-subst">$&#123;result.data.errcode&#125;</span> - <span class="hljs-subst">$&#123;result.data.errmsg&#125;</span>`</span><br>          )<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`GetAccessToken Error: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>)<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> accessToken<br>&#125;<br></code></pre></td></tr></table></figure>
<p>维护<code>access_token</code>数据：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">CronJob</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cron&#x27;</span><br><span class="hljs-keyword">import</span> &#123; wxGetAccessToken &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./WxUtils&#x27;</span><br><br><span class="hljs-keyword">const</span> job = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CronJob</span>(<span class="hljs-string">&#x27;* 55 */1 * * *&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">wxGetAccessToken</span>()<br>&#125;)<br><br>job.<span class="hljs-title function_">start</span>()<br></code></pre></td></tr></table></figure>
<h2 id="手机登录"><a href="#手机登录" class="headerlink" title="#手机登录"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#手机登录">#</a>手机登录</h2><h3 id="业务流程图"><a href="#业务流程图" class="headerlink" title="#业务流程图"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#业务流程图">#</a>业务流程图</h3><ul>
<li>获取手机号 -&gt; 发送短信验证码页面</li>
</ul>
<p><img src="uniapp.assets/image-20210730163452597.76d98020.png" alt="img"></p>
<ul>
<li>输入验证码 -&gt; 手机号登录页面</li>
</ul>
<p><img src="uniapp.assets/image-20210730163719652.14834a3e.png" alt="img"></p>
<h3 id="如何选择短信服务商"><a href="#如何选择短信服务商" class="headerlink" title="#如何选择短信服务商"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#如何选择短信服务商">#</a>如何选择短信服务商</h3><p>推荐腾讯云、阿里云，下面以腾讯云为示例：</p>
<p><img src="uniapp.assets/image-20210726203051548.4d7929a2.png" alt="image-20210726203051548"></p>
<p>基本的使用步骤：</p>
<ol>
<li>创建云平台账号 -&gt; 实名 -&gt; 推荐公司实名</li>
<li>够买短信包 -&gt; 添加短信模板</li>
<li>集成SDK发送短信</li>
</ol>
<p>腾讯云的两种集成方式：</p>
<ol>
<li>qcloudsms_js，参考<a target="_blank" rel="noopener" href="https://github.com/qcloudsms/qcloudsms_js">github仓库(opens new window)</a></li>
<li>Tencentcloud-sdk-nodejs，参考<a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/382/43197">官方文档(opens new window)</a></li>
</ol>
<h3 id="登录页面样式"><a href="#登录页面样式" class="headerlink" title="#登录页面样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#登录页面样式">#</a>登录页面样式</h3><p><code>auth/mobile-login.vue</code>页面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;wrapper&quot;&gt;<br>    &lt;view class=&quot;title&quot;&gt;登录注册更精彩&lt;/view&gt;<br>    &lt;view class=&quot;info&quot;&gt;未注册的手机号验证后自动创建账号&lt;/view&gt;<br>    &lt;view class=&quot;form&quot;&gt;<br>      &lt;u-form label-width=&quot;120&quot;&gt;<br>        &lt;u-form-item label=&quot;手机号&quot;&gt;<br>          &lt;u-input v-model=&quot;mobile&quot; placeholder=&quot;请输入手机号&quot;&gt;&lt;/u-input&gt;<br>          &lt;template v-slot:right&gt;<br>            &lt;u-button type=&quot;primary&quot; shape=&quot;circle&quot; size=&quot;mini&quot; hover-class=&quot;none&quot;&gt;获取手机号&lt;/u-button&gt;<br>          &lt;/template&gt;<br>        &lt;/u-form-item&gt;<br>      &lt;/u-form&gt;<br>      &lt;view class=&quot;btn&quot; :class=&quot;&#123;&#x27;deactive&#x27;: !/^1[3-9]\d&#123;9&#125;$/.test(mobile)&#125;&quot;&gt;<br>        &lt;u-button type=&quot;primary&quot; hover-class=&quot;none&quot; @click=&quot;getCode&quot;&gt;获取验证码&lt;/u-button&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;navigator open-type=&quot;navigateBack&quot; hover-class=&quot;none&quot;&gt;<br>      &lt;view class=&quot;footer u-flex u-col-center u-row-center&quot;&gt;<br>        &lt;u-icon name=&quot;weixin-circle-fill&quot; size=&quot;120&quot; color=&quot;#1BB723&quot;&gt;&lt;/u-icon&gt;<br>        &lt;text&gt;微信登录&lt;/text&gt;<br>      &lt;/view&gt;<br>    &lt;/navigator&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import auth from &#x27;@/mixins/auth&#x27;<br>export default &#123;<br>  mixins: [auth],<br>  data: () =&gt; (&#123;<br>    mobile: &#x27;&#x27;,<br>    phoneNumber: &#x27;&#x27;,<br>    loading: false<br>  &#125;),<br>  methods: &#123;<br>    async getCode () &#123;<br>      // 发送短信验证码<br>    &#125;,<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.wrapper &#123;<br>  padding: 32rpx;<br>  .title &#123;<br>    color: #333;<br>    font-size: 48rpx;<br>    font-weight: bold;<br>    padding-top: 50rpx;<br>  &#125;<br>  .info &#123;<br>    color: #666;<br>    line-height: 28rpx;<br>    padding-top: 24rpx;<br>  &#125;<br>  .form &#123;<br>    padding-top: 40rpx;<br>  &#125;<br>  ::v-deep .btn &#123;<br>    padding-top: 80rpx;<br>    &amp;.deactive &#123;<br>      .u-btn--primary &#123;<br>        background-color: #ccc;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>.footer &#123;<br>  position: absolute;<br>  bottom: 120rpx;<br>  width: 100vw;<br>  left: 0;<br>  text-align: center;<br>  flex-direction: column;<br>  text &#123;<br>    color: #666;<br>    font-size: 28rpx;<br>    padding-top: 14rpx;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p><code>mobile-code.vue</code>页面：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;wrapper&quot;&gt;<br>    &lt;view class=&quot;title&quot;&gt;输入验证码&lt;/view&gt;<br>    &lt;view class=&quot;info&quot;&gt;验证码已发送至 &#123;&#123;mobile.substr(0,3)&#125;&#125;****&#123;&#123;mobile.substr(7,10)&#125;&#125; &lt;/view&gt;<br>    &lt;view class=&quot;inputs&quot;&gt;<br>      &lt;u-message-input :maxlength=&quot;6&quot; mode=&quot;bottomLine&quot; active-color=&quot;#02d199&quot; inactive-color=&quot;#DDD&quot; width=&quot;90&quot; :bold=&quot;false&quot; :breathe=&quot;false&quot; :focus=&quot;true&quot;&gt;&lt;/u-message-input&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;resend&quot; :class=&quot;&#123;&#x27;disabled&#x27;: sending&#125;&quot; @click=&quot;resend()&quot;&gt;&#123;&#123;msg&#125;&#125;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; mapMutations &#125; from &#x27;vuex&#x27;<br>export default &#123;<br>  data: () =&gt; (&#123;<br>    mobile: &#x27;&#x27;,<br>    count: 60,<br>    ctrl: null,<br>    sending: false<br>  &#125;),<br>  onLoad (options) &#123;<br>    // console.log(&#x27;🚀 ~ file: mobile-code.vue ~ line 15 ~ onLoad ~ options&#x27;, options)<br>    this.mobile = options.mobile<br>    this.setCron()<br>  &#125;,<br>  methods: &#123;<br>    ...mapMutations([&#x27;setToken&#x27;, &#x27;setUserInfo&#x27;]),<br>    setCron () &#123;<br>      clearInterval(this.ctrl)<br>      this.sending = true<br>      this.ctrl = setInterval(() =&gt; &#123;<br>        this.count--<br>        if (this.count === 0) &#123;<br>          this.count = 60<br>          this.sending = false<br>          clearInterval(this.ctrl)<br>        &#125;<br>      &#125;, 1000)<br>    &#125;,<br>    async resend () &#123;<br>      if (this.sending) return<br>      const res = await this.$u.api.sendCode(&#123;<br>        phone: this.mobile<br>      &#125;)<br>      // console.log(&#x27;🚀 ~ file: mobile-code.vue ~ line 75 ~ resend ~ res&#x27;, res)<br>      this.setCron()<br>    &#125;<br>  &#125;,<br>  computed: &#123;<br>    msg () &#123;<br>      let str = &#x27;重新获取&#x27;<br>      if (this.sending) &#123;<br>        str += (&#x27;(&#x27; + (this.count + &#x27;&#x27;).padStart(2, &#x27;0&#x27;) + &#x27;s)&#x27;)<br>      &#125;<br>      return str<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.wrapper &#123;<br>  padding: 32rpx;<br>  .title &#123;<br>    color: #333;<br>    font-size: 48rpx;<br>    font-weight: bold;<br>    padding-top: 50rpx;<br>  &#125;<br>  .info &#123;<br>    color: #666;<br>    line-height: 28rpx;<br>    padding-top: 24rpx;<br>  &#125;<br>  .inputs &#123;<br>    padding: 60rpx 0 40rpx;<br>  &#125;<br>  .resend &#123;<br>    font-size: 26rpx;<br>    font-weight: 300;<br>    color: #02d199;<br>    &amp;.disabled &#123;<br>      color: #ddd;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h3 id="小程序获取手机号"><a href="#小程序获取手机号" class="headerlink" title="#小程序获取手机号"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#小程序获取手机号">#</a>小程序获取手机号</h3><p>小程序侧逻辑：</p>
<p>设置open-type为<code>getPhoneNumber</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">&lt;u-button type=<span class="hljs-string">&quot;primary&quot;</span> shape=<span class="hljs-string">&quot;circle&quot;</span> size=<span class="hljs-string">&quot;mini&quot;</span> hover-<span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;none&quot;</span> open-type=<span class="hljs-string">&quot;getPhoneNumber&quot;</span> @getphonenumber=<span class="hljs-string">&quot;getPhoneNumber&quot;</span>&gt;获取手机号&lt;/u-button&gt;<br></code></pre></td></tr></table></figure>
<p>getPhoneNumber方法：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getPhoneNumber</span> (value) &#123;<br>  <span class="hljs-keyword">const</span> &#123; encryptedData, iv &#125; = value.<span class="hljs-property">detail</span><br>  <span class="hljs-comment">// value.detail + code</span><br>  <span class="hljs-keyword">const</span> &#123; code, data &#125; = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">getMobile</span>(&#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">code</span>,<br>    encryptedData,<br>    iv<br>  &#125;)<br>  <span class="hljs-keyword">if</span> (code === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; phoneNumber, purePhoneNumber, countryCode &#125; = data<br>    <span class="hljs-keyword">if</span> (countryCode !== <span class="hljs-string">&#x27;86&#x27;</span>) &#123;<br>      uni.<span class="hljs-title function_">showToast</span>(&#123;<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;Please use a cell phone number from mainland China&#x27;</span>,<br>        <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>      &#125;)<br>      <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">phoneNumber</span> = phoneNumber<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mobile</span> = purePhoneNumber<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    uni.<span class="hljs-title function_">showToast</span>(&#123;<br>      <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;error&#x27;</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;获取手机号失败，请重试&#x27;</span>,<br>      <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>    &#125;)<br>  &#125;<br>  <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: mobile-login.vue ~ line 48 ~ getPhoneNumber ~ res&#x27;, res)</span><br>&#125;<br></code></pre></td></tr></table></figure>
<p>API接口解密数据：</p>
<p>设置路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/getMobile&#x27;</span>, loginController.<span class="hljs-property">getMobile</span>)<br></code></pre></td></tr></table></figure>
<p>获取手机号<code>LoginController.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取用户手机号</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">getMobile</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>  <span class="hljs-keyword">const</span> &#123; code, encryptedData, iv &#125; = body<br>  <span class="hljs-keyword">if</span> (!code) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;没有足够参数&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">session_key</span>: sessionKey &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetOpenData</span>(code)<br>  <span class="hljs-keyword">const</span> wxBizDataCrypt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WXBizDataCrypt</span>(config.<span class="hljs-property">AppID</span>, sessionKey)<br>  <span class="hljs-comment">// 3.用户加密数据的解密</span><br>  <span class="hljs-keyword">const</span> data = wxBizDataCrypt.<span class="hljs-title function_">decryptData</span>(encryptedData, iv)<br>  <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: LoginController.js ~ line 274 ~ LoginController ~ getMobile ~ data&#x27;, data)</span><br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    data,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;获取手机号成功&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="前后端逻辑-amp-联调"><a href="#前后端逻辑-amp-联调" class="headerlink" title="#前后端逻辑&amp;联调"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#前后端逻辑-联调">#</a>前后端逻辑&amp;联调</h3><p>常见问题：</p>
<ul>
<li><p>参数传递异常：</p>
<p><img src="uniapp.assets/image-20210730161557953.500dcdbf.png" alt="image-20210730161557953"></p>
<p>解决办法：确保前后端传递的参数的正确性，比如，统一参数名称，统一请求methods。</p>
</li>
<li><p>短信服务商的问题</p>
<p><img src="uniapp.assets/image-20210730161718446.59b97977.png" alt="image-20210730161718446"></p>
<p>解决办法：1. 余额不足即充值；2. 传参非法，修改参数；3. 签名或者模板问题，修改对应的模板参数后再进行发送。</p>
</li>
<li><p>需要删除已经使用过的短信验证码数据；</p>
</li>
<li><p>如果给用户已经发送一次短信验证码，则不再相同的时间间隔内，再给用户发送，限制用户发送短信的频次；</p>
</li>
</ul>
<p>小程序侧接口：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取用户手机号</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getMobile</span> = (<span class="hljs-params">data</span>) =&gt; axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login/getMobile&#x27;</span>, data)<br><br><span class="hljs-comment">// 发送短信</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">sendCode</span> = params =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/public/sendCode&#x27;</span>, params)<br></code></pre></td></tr></table></figure>
<p>完成的手机发送验证码页面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;wrapper&quot;&gt;<br>    &lt;view class=&quot;title&quot;&gt;登录注册更精彩&lt;/view&gt;<br>    &lt;view class=&quot;info&quot;&gt;未注册的手机号验证后自动创建账号&lt;/view&gt;<br>    &lt;view class=&quot;form&quot;&gt;<br>      &lt;u-form label-width=&quot;120&quot;&gt;<br>        &lt;u-form-item label=&quot;手机号&quot;&gt;<br>          &lt;u-input v-model=&quot;mobile&quot; placeholder=&quot;请输入手机号&quot;&gt;&lt;/u-input&gt;<br>          &lt;template v-slot:right&gt;<br>            &lt;u-button type=&quot;primary&quot; shape=&quot;circle&quot; size=&quot;mini&quot; hover-class=&quot;none&quot; open-type=&quot;getPhoneNumber&quot; @getphonenumber=&quot;getPhoneNumber&quot;&gt;获取手机号&lt;/u-button&gt;<br>          &lt;/template&gt;<br>        &lt;/u-form-item&gt;<br>      &lt;/u-form&gt;<br>      &lt;view class=&quot;btn&quot; :class=&quot;&#123;&#x27;deactive&#x27;: !/^1[3-9]\d&#123;9&#125;$/.test(mobile)&#125;&quot;&gt;<br>        &lt;u-button type=&quot;primary&quot; hover-class=&quot;none&quot; @click=&quot;getCode&quot;&gt;获取验证码&lt;/u-button&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;navigator open-type=&quot;navigateBack&quot; hover-class=&quot;none&quot;&gt;<br>      &lt;view class=&quot;footer u-flex u-col-center u-row-center&quot;&gt;<br>        &lt;u-icon name=&quot;weixin-circle-fill&quot; size=&quot;120&quot; color=&quot;#1BB723&quot;&gt;&lt;/u-icon&gt;<br>        &lt;text&gt;微信登录&lt;/text&gt;<br>      &lt;/view&gt;<br>    &lt;/navigator&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import auth from &#x27;@/mixins/auth&#x27;<br>export default &#123;<br>  mixins: [auth],<br>  data: () =&gt; (&#123;<br>    mobile: &#x27;&#x27;,<br>    phoneNumber: &#x27;&#x27;,<br>    loading: false<br>  &#125;),<br>  methods: &#123;<br>    async getCode () &#123;<br>      // 发送短信验证码<br>      // 防止用户频繁发送<br>      if (this.loading) return<br>      this.loading = true<br>      try &#123;<br>        const res = await this.$u.api.sendCode(&#123;<br>          mobile: this.mobile<br>        &#125;)<br>        this.loading = false<br>        if (res.code === 200) &#123;<br>        // 提示用户<br>          uni.showToast(&#123;<br>            icon: &#x27;none&#x27;,<br>            title: &#x27;发送成功&#x27;,<br>            duration: 2000<br>          &#125;)<br>          // 延迟跳转到输入验证码的页面<br>          setTimeout(() =&gt; &#123;<br>            uni.navigateTo(&#123;<br>              url: &#x27;/subcom-pkg/auth/mobile-code?mobile=&#x27; + this.mobile<br>            &#125;)<br>          &#125;, 2000)<br>        &#125; else &#123;<br>          uni.showToast(&#123;<br>            icon: &#x27;error&#x27;,<br>            title: &#x27;短信发送失败&#x27;,<br>            duration: 2000<br>          &#125;)<br>        &#125;<br>      &#125; catch (error) &#123;<br>        this.loading = false<br>      &#125;<br>    &#125;,<br>    async getPhoneNumber (value) &#123;<br>      const &#123; encryptedData, iv &#125; = value.detail<br>      // value.detail + code<br>      const &#123; code, data &#125; = await this.$u.api.getMobile(&#123;<br>        code: this.code,<br>        encryptedData,<br>        iv<br>      &#125;)<br>      if (code === 200) &#123;<br>        const &#123; phoneNumber, purePhoneNumber, countryCode &#125; = data<br>        if (countryCode !== &#x27;86&#x27;) &#123;<br>          uni.showToast(&#123;<br>            title: &#x27;Please use a cell phone number from mainland China&#x27;,<br>            duration: 2000<br>          &#125;)<br>          return<br>        &#125;<br>        this.phoneNumber = phoneNumber<br>        this.mobile = purePhoneNumber<br>      &#125; else &#123;<br>        uni.showToast(&#123;<br>          icon: &#x27;error&#x27;,<br>          title: &#x27;获取手机号失败，请重试&#x27;,<br>          duration: 2000<br>        &#125;)<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.wrapper &#123;<br>  padding: 32rpx;<br>  .title &#123;<br>    color: #333;<br>    font-size: 48rpx;<br>    font-weight: bold;<br>    padding-top: 50rpx;<br>  &#125;<br>  .info &#123;<br>    color: #666;<br>    line-height: 28rpx;<br>    padding-top: 24rpx;<br>  &#125;<br>  .form &#123;<br>    padding-top: 40rpx;<br>  &#125;<br>  ::v-deep .btn &#123;<br>    padding-top: 80rpx;<br>    &amp;.deactive &#123;<br>      .u-btn--primary &#123;<br>        background-color: #ccc;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>.footer &#123;<br>  position: absolute;<br>  bottom: 120rpx;<br>  width: 100vw;<br>  left: 0;<br>  text-align: center;<br>  flex-direction: column;<br>  text &#123;<br>    color: #666;<br>    font-size: 28rpx;<br>    padding-top: 14rpx;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>校验验证码的页面：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;wrapper&quot;&gt;<br>    &lt;view class=&quot;title&quot;&gt;输入验证码&lt;/view&gt;<br>    &lt;view class=&quot;info&quot;&gt;验证码已发送至 &#123;&#123;mobile.substr(0,3)&#125;&#125;****&#123;&#123;mobile.substr(7,10)&#125;&#125; &lt;/view&gt;<br>    &lt;view class=&quot;inputs&quot;&gt;<br>      &lt;u-message-input :maxlength=&quot;6&quot; mode=&quot;bottomLine&quot; active-color=&quot;#02d199&quot; inactive-color=&quot;#DDD&quot; width=&quot;90&quot; :bold=&quot;false&quot; :breathe=&quot;false&quot; :focus=&quot;true&quot; @change=&quot;change&quot;&gt;&lt;/u-message-input&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;resend&quot; :class=&quot;&#123;&#x27;disabled&#x27;: sending&#125;&quot; @click=&quot;resend()&quot;&gt;&#123;&#123;msg&#125;&#125;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; mapMutations &#125; from &#x27;vuex&#x27;<br>export default &#123;<br>  data: () =&gt; (&#123;<br>    mobile: &#x27;&#x27;,<br>    count: 60,<br>    ctrl: null,<br>    sending: false<br>  &#125;),<br>  onLoad (options) &#123;<br>    this.mobile = options.mobile<br>    this.setCron()<br>  &#125;,<br>  methods: &#123;<br>    ...mapMutations([&#x27;setToken&#x27;, &#x27;setUserInfo&#x27;]),<br>    setCron () &#123;<br>      clearInterval(this.ctrl)<br>      this.sending = true<br>      this.ctrl = setInterval(() =&gt; &#123;<br>        this.count--<br>        if (this.count === 0) &#123;<br>          this.count = 60<br>          this.sending = false<br>          clearInterval(this.ctrl)<br>        &#125;<br>      &#125;, 1000)<br>    &#125;,<br>    async change (val) &#123;<br>      if (/\d&#123;6&#125;/.test(val)) &#123;<br>        const res = await this.$u.api.loginByPhone(&#123;<br>          mobile: this.mobile,<br>          code: val<br>        &#125;)<br>        if (res.code === 200) &#123;<br>          uni.showToast(&#123;<br>            icon: &#x27;none&#x27;,<br>            title: &#x27;登录成功，2s后跳转&#x27;,<br>            duration: 2000<br>          &#125;)<br>          const &#123; token, data &#125; = res<br>          this.setToken(token)<br>          this.setUserInfo(data)<br>          setTimeout(() =&gt; &#123;<br>            uni.navigateBack(&#123;<br>              delta: 3<br>            &#125;)<br>          &#125;, 2000)<br>        &#125; else &#123;<br>          uni.showToast(&#123;<br>            icon: &#x27;none&#x27;,<br>            title: res.msg,<br>            duration: 2000<br>          &#125;)<br>        &#125;<br>      &#125;<br>    &#125;,<br>    async resend () &#123;<br>      if (this.sending) return<br>      const res = await this.$u.api.sendCode(&#123;<br>        mobile: this.mobile<br>      &#125;)<br>      if (res.code === 200) &#123;<br>        this.setCron()<br>      &#125; else &#123;<br>        uni.showToast(&#123;<br>          icon: &#x27;none&#x27;,<br>          title: res.msg || &#x27;短信发送失败，请稍后重试&#x27;,<br>          duration: 2000<br>        &#125;)<br>      &#125;<br>    &#125;<br>  &#125;,<br>  computed: &#123;<br>    msg () &#123;<br>      let str = &#x27;重新获取&#x27;<br>      if (this.sending) &#123;<br>        str += (&#x27;(&#x27; + (this.count + &#x27;&#x27;).padStart(2, &#x27;0&#x27;) + &#x27;s)&#x27;)<br>      &#125;<br>      return str<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.wrapper &#123;<br>  padding: 32rpx;<br>  .title &#123;<br>    color: #333;<br>    font-size: 48rpx;<br>    font-weight: bold;<br>    padding-top: 50rpx;<br>  &#125;<br>  .info &#123;<br>    color: #666;<br>    line-height: 28rpx;<br>    padding-top: 24rpx;<br>  &#125;<br>  .inputs &#123;<br>    padding: 60rpx 0 40rpx;<br>  &#125;<br>  .resend &#123;<br>    font-size: 26rpx;<br>    font-weight: 300;<br>    color: #02d199;<br>    &amp;.disabled &#123;<br>      color: #ddd;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>后端接口<code>LoginController.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 手机号登录</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">loginByPhone</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>  <span class="hljs-comment">// mobile + code</span><br>  <span class="hljs-keyword">const</span> &#123; mobile, code &#125; = body<br>  <span class="hljs-comment">// 验证手机号与短信验证码的正确性</span><br>  <span class="hljs-keyword">const</span> sms = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getValue</span>(mobile)<br>  <span class="hljs-keyword">if</span> (sms &amp;&amp; sms === code) &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">delValue</span>(mobile)<br>    <span class="hljs-comment">// 查询并创建用户</span><br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOrCreateByMobile</span>(&#123;<br>      mobile<br>    &#125;)<br>    <span class="hljs-comment">// 查看用户是否签到</span><br>    <span class="hljs-keyword">const</span> userObj = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addSign</span>(user)<br>    <span class="hljs-comment">// 响应用户</span><br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>      <span class="hljs-attr">token</span>: <span class="hljs-title function_">generateToken</span>(&#123; <span class="hljs-attr">_id</span>: userObj.<span class="hljs-property">_id</span> &#125;),<br>      <span class="hljs-attr">data</span>: userObj<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;手机号与验证码不匹配&#x27;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>查询并创建手机用户<code>User.js</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-attr">findOrCreateByMobile</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">user</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findOne</span>(&#123; <span class="hljs-attr">mobile</span>: user.<span class="hljs-property">mobile</span> &#125;, &#123;<br>    <span class="hljs-attr">unionid</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">password</span>: <span class="hljs-number">0</span><br>  &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> res || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">create</span>(&#123;<br>      <span class="hljs-attr">mobile</span>: user.<span class="hljs-property">mobile</span>,<br>      <span class="hljs-attr">username</span>: <span class="hljs-title function_">getTempName</span>(),<br>      <span class="hljs-attr">name</span>: <span class="hljs-title function_">getTempName</span>(),<br>      <span class="hljs-attr">roles</span>: [<span class="hljs-string">&#x27;user&#x27;</span>]<br>    &#125;)<br>  &#125;)<br>&#125;,<br></code></pre></td></tr></table></figure>
<p>发送验证码逻辑<code>PublicController.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 发送手机验证码</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">sendCode</span> (ctx) &#123;<br>  <span class="hljs-comment">// 1.获取手机号 phone</span><br>  <span class="hljs-keyword">const</span> &#123; mobile &#125; = ctx.<span class="hljs-property">query</span><br>  <span class="hljs-comment">// 2.查询redis -&gt; 判断是否验证码过期</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">getValue</span>(mobile)) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">501</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;短信正在发送中，请勿重新发送&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-comment">// 3.产生随机的6位数字</span><br>  <span class="hljs-keyword">const</span> sms = <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()).<span class="hljs-title function_">slice</span>(-<span class="hljs-number">6</span>)<br>  <span class="hljs-comment">// 4.发送短信 -&gt; 设置redis -&gt; sms, expire -&gt; key:phone</span><br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendSms</span>(mobile, sms)<br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">result</span> === <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-title function_">setValue</span>(mobile, sms, <span class="hljs-number">10</span> * <span class="hljs-number">60</span>)<br>    <span class="hljs-comment">// 5.响应</span><br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;发送成功&#x27;</span>,<br>      <span class="hljs-attr">data</span>: res<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">500</span>, <span class="hljs-string">&#x27;发送短信失败&#x27;</span> + res.<span class="hljs-property">errmsg</span> || <span class="hljs-string">&#x27;&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>需要注意的点：</p>
<ul>
<li>短信发送失败时：<ul>
<li>限制用户频繁发送-&gt; 不影响重发；</li>
<li>用户提示 -&gt; 短信失败原因 -&gt; 这里大部分是第三方服务商的错误提示，所以需要专门进行处理；</li>
<li>短信限制发送机制设计：不让成功发送短信之后，还让用户重复发送 -&gt; redis记录短信数据；</li>
</ul>
</li>
<li>手机登录接口：<ul>
<li>发送成功短信则响应，并设置redis，否则直接throw错误；</li>
<li>创建用户需要使用findOne来进行查重；</li>
<li>接口参数需要与前端进行一一对应，最好使用文档进行约定；</li>
</ul>
</li>
</ul>
<h3 id="统一的用户授权登录"><a href="#统一的用户授权登录" class="headerlink" title="#统一的用户授权登录"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/03-登录鉴权.html#统一的用户授权登录">#</a>统一的用户授权登录</h3><p>用户授权登录是经常需要使用的功能，封装到<code>common/checkAuth.js</code>中：</p>
<ul>
<li>需要判断小程序用户的登录状态是否失效 - 使用小程序API <code>checkSession</code></li>
<li>用户登录失效，给用户一个Confirm提示框，让用户选择是否进行跳转登录</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/store&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkSession</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">await</span> uni.<span class="hljs-title function_">checkSession</span>()<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> flag = <span class="hljs-literal">true</span><br>  <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&#x27;token&#x27;</span>)<br>  <span class="hljs-keyword">const</span> checked = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkSession</span>()<br>  <span class="hljs-keyword">if</span> (!store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span> || !token || !checked) &#123;<br>    flag = <span class="hljs-literal">false</span><br>    uni.<span class="hljs-title function_">showModal</span>(&#123;<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;您未登录&#x27;</span>,<br>      <span class="hljs-attr">content</span>: <span class="hljs-string">&#x27;需要登录才能操作，确定登录吗？&#x27;</span>,<br>      <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">confirm</span>) &#123;<br>          uni.<span class="hljs-title function_">navigateTo</span>(&#123;<br>            <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/subcom-pkg/auth/auth&#x27;</span><br>          &#125;)<br>        &#125;<br>      &#125;<br>    &#125;)<br>  &#125;<br>  <span class="hljs-keyword">return</span> flag<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="消息-amp-热门-amp-个人中心"><a href="#消息-amp-热门-amp-个人中心" class="headerlink" title="#消息&amp;热门&amp;个人中心"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#消息-热门-个人中心">#</a>消息&amp;热门&amp;个人中心</h1><p>消息、热门、个人中心这三块的内容重点：</p>
<ul>
<li>灵活使用UI框架：uview内置样式的综合使用；</li>
<li>统一鉴权跳转提示：用户登录与未登录状态下，页面跳转逻辑；</li>
<li>熟悉前后端开发流程：从前到后的开发逻辑，排查问题从源头开始找问题；</li>
<li>完善登录失效，接口鉴权失败401的页面跳转逻辑；</li>
</ul>
<h2 id="消息模块"><a href="#消息模块" class="headerlink" title="#消息模块"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#消息模块">#</a>消息模块</h2><p>最终 完成效果：</p>
<p><img src="uniapp.assets/image-20210527025158228.2c02523b.png" alt="img"></p>
<h3 id="页面布局和样式"><a href="#页面布局和样式" class="headerlink" title="#页面布局和样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#页面布局和样式">#</a>页面布局和样式</h3><ul>
<li>添加 tabs 切换，并设置吸顶</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;msg&quot;&gt;<br>    &lt;view class=&quot;msg&quot; v-if=&quot;isLogin&quot;&gt;<br>      &lt;u-sticky&gt;<br>        &lt;view class=&quot;tabs box-shadow&quot;&gt;<br>          &lt;!-- tabs --&gt;<br>          &lt;u-tabs :list=&quot;tabs&quot; :name=&quot;&#x27;value&#x27;&quot; :is-scroll=&quot;false&quot; active-color=&quot;#02D199&quot; inactive-color=&quot;#666&quot; height=&quot;88&quot; @change=&quot;tabsChange&quot; :current=&quot;current&quot;&gt;&lt;/u-tabs&gt;<br>        &lt;/view&gt;<br>      &lt;u-sticky&gt;<br>      &lt;view&gt;<br>        &lt;!-- 评论列表 --&gt;<br>        &lt;!-- 点赞列表 --&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;info u-flex u-row-center u-col-center flex-column&quot; v-else&gt;<br>      &lt;view class=&quot;center&quot;&gt;<br>        登录过后查看评论&amp;点赞消息<br>      &lt;/view&gt;<br>      &lt;u-button type=&quot;primary&quot; hover-class=&quot;none&quot;&gt;去登录&lt;/u-button&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;bottom-line&quot;&gt;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  props: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    current: 0,<br>    tabs: [<br>      &#123;<br>        key: &#x27;comments&#x27;,<br>        value: &#x27;评论&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;like&#x27;,<br>        value: &#x27;点赞&#x27;<br>      &#125;<br>    ],<br>  &#125;),<br>  methods: &#123;<br>    tabsChange (i) &#123;<br>      this.current = i<br>      this.$store.commit(&#x27;setType&#x27;, i === 0 ? &#x27;comment&#x27; : &#x27;hands&#x27;)<br>      this.checkType()<br>    &#125;,<br>	&#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.flex-column &#123;<br>  flex-flow: column nowrap;<br>&#125;<br><br>.info &#123;<br>  flex-flow: column nowrap;<br>  height: 100vh;<br>  width: 100vw;<br>  .center &#123;<br>    color: #666;<br>    font-size: 32rpx;<br>    line-height: 50px;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h3 id="自定义吸顶组件"><a href="#自定义吸顶组件" class="headerlink" title="#自定义吸顶组件"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#自定义吸顶组件">#</a>自定义吸顶组件</h3><p>吸顶效果最关键的属性：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">.t-sticky &#123;<br>  position: sticky;<br>  top: 0;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以自行创建<code>components/t-sticky/t-sticky.vue</code>组件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;t-sticky&quot; :style=&quot;&#123;&#x27;top&#x27;: top + &#x27;px&#x27;&#125;&quot;&gt;<br>    &lt;slot&gt;&lt;/slot&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br><br>export default &#123;<br>  props: &#123;<br>    top: &#123;<br>      default: 0,<br>      type: Number<br>    &#125;<br>  &#125;,<br>  data: () =&gt; (&#123;&#125;)<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.t-sticky &#123;<br>  position: sticky;<br>  // top: 0;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>使用方法：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">&lt;t-sticky :top=&quot;距离顶部的值&quot;&gt;<br>  // ... 组件 <br>&lt;/t-sticky&gt;<br></code></pre></td></tr></table></figure>
<h3 id="消息模块的样式"><a href="#消息模块的样式" class="headerlink" title="#消息模块的样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#消息模块的样式">#</a>消息模块的样式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;msg&quot;&gt;<br>    &lt;view class=&quot;msg&quot; v-if=&quot;isLogin&quot;&gt;<br>      &lt;u-sticky&gt;<br>        &lt;view class=&quot;tabs box-shadow&quot;&gt;<br>          &lt;!-- tabs --&gt;<br>          &lt;u-tabs :list=&quot;tabs&quot; :name=&quot;&#x27;value&#x27;&quot; :is-scroll=&quot;false&quot; active-color=&quot;#02D199&quot; inactive-color=&quot;#666&quot; height=&quot;88&quot; @change=&quot;tabsChange&quot; :current=&quot;current&quot;&gt;&lt;/u-tabs&gt;<br>        &lt;/view&gt;<br>      &lt;/u-sticky&gt;<br>      &lt;view&gt;<br>        &lt;!-- 评论列表 --&gt;<br>        &lt;view v-if=&quot;current === 0&quot;&gt;<br>          &lt;view v-for=&quot;(item, index) in comments&quot; :key=&quot;index&quot;&gt;<br>            &lt;view class=&quot;box&quot;&gt;<br>              &lt;!-- 评论用户卡片 --&gt;<br>              &lt;view class=&quot;user u-flex&quot;&gt;<br>                &lt;u-image class=&quot;phone&quot; :src=&quot;item.cuid.pic&quot; width=&quot;72&quot; height=&quot;72&quot; shape=&quot;circle&quot; error-icon=&quot;/static/images/header.jpg&quot;&gt;&lt;/u-image&gt;<br>                &lt;view class=&quot;user-column u-flex-1 u-flex flex-column u-col-top&quot;&gt;<br>                  &lt;text class=&quot;name&quot;&gt;&#123;&#123; item.cuid.name &#125;&#125;&lt;/text&gt;<br>                  &lt;text class=&quot;label&quot;&gt;&#123;&#123; item.created | moment &#125;&#125; 回复了你&lt;/text&gt;<br>                &lt;/view&gt;<br>                &lt;view class=&quot;reply u-flex u-row-center&quot;&gt;<br>                  &lt;image src=&quot;/static/images/advice.png&quot; mode=&quot;aspectFit&quot; /&gt;<br>                  回复<br>                &lt;/view&gt;<br>              &lt;/view&gt;<br>              &lt;!-- 评论内容 --&gt;<br>              &lt;view class=&quot;comment&quot;&gt;&#123;&#123; item.content &#125;&#125;&lt;/view&gt;<br>              &lt;view class=&quot;post&quot;&gt;<br>                &lt;view&gt;<br>                  &lt;!-- 封面图 --&gt;<br>                  &lt;view v-if=&quot;item.tid.shotpic&quot;&gt;<br>                    &lt;view class=&quot;img&quot;&gt;<br>                      &lt;u-image :src=&quot;item.tid.shotpic&quot; width=&quot;192&quot; height=&quot;122&quot;&gt;&lt;/u-image&gt;<br>                    &lt;/view&gt;<br>                  &lt;/view&gt;<br>                  &lt;!-- 文章标题 + 摘要 --&gt;<br>                  &lt;view class=&quot;post-content u-flex flex-column u-col-top&quot;&gt;<br>                    &lt;text class=&quot;title&quot;&gt;&#123;&#123; item.tid.title &#125;&#125;&lt;/text&gt;<br>                    &lt;text class=&quot;content&quot;&gt;&#123;&#123; item.tid.content &#125;&#125;&lt;/text&gt;<br>                  &lt;/view&gt;<br>                &lt;/view&gt;<br>              &lt;/view&gt;<br>            &lt;/view&gt;<br>          &lt;/view&gt;<br>        &lt;/view&gt;<br>        &lt;!-- 点赞列表 --&gt;<br>        &lt;view v-else&gt;<br>          &lt;view v-for=&quot;(item, index) in handUsers&quot; :key=&quot;index&quot;&gt;<br>            &lt;view class=&quot;box&quot;&gt;<br>              &lt;view class=&quot;user u-flex&quot;&gt;<br>                &lt;u-image class=&quot;pic&quot; :src=&quot;item.huid.pic&quot; width=&quot;72&quot; height=&quot;72&quot; shape=&quot;circle&quot; error-icon=&quot;/static/images/header.jpg&quot; /&gt;<br>                &lt;view class=&quot;user-column u-flex-1 u-flex flex-column u-col-top&quot;&gt;<br>                  &lt;span class=&quot;name&quot;&gt;&#123;&#123; item.huid.name &#125;&#125;&lt;/span&gt;<br>                  &lt;span class=&quot;label&quot;&gt;&#123;&#123; item.created | moment &#125;&#125;&lt;/span&gt;<br>                &lt;/view&gt;<br>              &lt;/view&gt;<br>            &lt;/view&gt;<br>            &lt;view class=&quot;comment&quot;&gt;赞了你的评论 &#123;&#123;item.cid.content&#125;&#125;&lt;/view&gt;<br>          &lt;/view&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;info u-flex u-row-center u-col-center flex-column&quot; v-else&gt;<br>      &lt;view class=&quot;center&quot;&gt;<br>        登录过后查看评论&amp;点赞消息<br>      &lt;/view&gt;<br>      &lt;u-button type=&quot;primary&quot; hover-class=&quot;none&quot; @click=&quot;navTo&quot;&gt;去登录&lt;/u-button&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;bottom-line&quot;&gt;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; mapGetters &#125; from &#x27;vuex&#x27;<br>import &#123; checkAuth &#125; from &#x27;@/common/checkAuth&#x27;<br>export default &#123;<br>  props: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    current: 0,<br>    tabs: [<br>      &#123;<br>        key: &#x27;comments&#x27;,<br>        value: &#x27;评论&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;like&#x27;,<br>        value: &#x27;点赞&#x27;<br>      &#125;<br>    ],<br>    comments: [<br>    ],<br>    handUsers: [<br>    ],<br>    pageMsg: &#123;<br>      page: 0,<br>      limit: 10<br>    &#125;,<br>    pageHands: &#123;<br>      page: 0,<br>      limit: 10<br>    &#125;<br>  &#125;),<br>  computed: &#123;<br>    ...mapGetters([&#x27;isLogin&#x27;])<br>  &#125;,<br>  methods: &#123;<br>    navTo () &#123;<br>      uni.navigateTo(&#123;<br>        url: &#x27;/subcom-pkg/auth/auth&#x27;<br>      &#125;)<br>    &#125;,<br>    tabsChange (i) &#123;<br>      this.current = i<br>      this.$store.commit(&#x27;setType&#x27;, i === 0 ? &#x27;comment&#x27; : &#x27;hands&#x27;)<br>      this.checkType()<br>    &#125;,<br>    async getMsg () &#123;<br>      const &#123; data, code &#125; = await this.$u.api.getMsg(this.pageMsg)<br>      if (code === 200) &#123;<br>        this.comments = data<br>      &#125;<br>    &#125;,<br>    async getHands () &#123;<br>      const &#123; data, code &#125; = await this.$u.api.getHands(this.pageHands)<br>      if (code === 200) &#123;<br>        this.handUsers = data<br>      &#125;<br>    &#125;,<br>    async checkType () &#123;<br>      if (!this.isLogin) return<br>      const flag = await checkAuth()<br>      if (!flag) &#123;<br>        return<br>      &#125;<br>      if (this.$store.state.type === &#x27;hands&#x27;) &#123;<br>        // 这里肯定已经登录<br>        this.current = 1<br>        this.getHands()<br>      &#125; else &#123;<br>        this.current = 0<br>        this.getMsg()<br>      &#125;<br>    &#125;<br>  &#125;,<br>  watch: &#123;&#125;,<br>  // 页面周期函数--监听页面显示(not-nvue)<br>  onShow () &#123;<br>    this.checkType()<br>  &#125;,<br>  // 页面周期函数--监听页面隐藏<br>  onHide () &#123;<br>    this.current = 0<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.flex-column &#123;<br>  flex-flow: column nowrap;<br>&#125;<br><br>.info &#123;<br>  flex-flow: column nowrap;<br>  height: 100vh;<br>  width: 100vw;<br>  .center &#123;<br>    color: #666;<br>    font-size: 32rpx;<br>    line-height: 50px;<br>  &#125;<br>&#125;<br>.user &#123;<br>  margin: 20rpx;<br>  .name &#123;<br>    margin-block: 20rpx;<br>    margin-bottom: 10rpx;<br>    font-size: 28rpx;<br>    font-weight: bold;<br>    color: rgba(51, 51, 51, 1);<br>  &#125;<br>  .phone &#123;<br>    width: 72rpx;<br>    height: 72rpx;<br>    border-radius: 50%;<br>  &#125;<br>  .user-column &#123;<br>    margin-left: 20rpx;<br>  &#125;<br>  .label &#123;<br>    font-size: 22rpx;<br>    font-weight: 500;<br>    color: rgba(153, 153, 153, 1);<br>  &#125;<br>&#125;<br><br>.reply &#123;<br>  color: rgba(153, 153, 153, 1);<br>  margin-right: 40rpx;<br>  font-size: 24rpx;<br>  font-weight: 500;<br>  line-height: 40rpx;<br>  image &#123;<br>    width: 30rpx;<br>    height: 30rpx;<br>    margin-right: 10rpx;<br>  &#125;<br>&#125;<br><br>.comment &#123;<br>  margin: 0 20rpx 20rpx;<br>&#125;<br><br>.post &#123;<br>  margin: 0 20rpx 20rpx;<br>  padding: 20rpx;<br>  background-color: #f3f3f3;<br>  border-radius: 15rpx;<br>  .title &#123;<br>    margin-bottom: 10rpx;<br>    font-size: 26rpx;<br>    font-weight: bold;<br>    color: rgba(51, 51, 51, 1);<br>    display: -webkit-box;<br>    -webkit-line-clamp: 1; /*这个数字是设置要显示省略号的行数*/<br>    -webkit-box-orient: vertical;<br>    overflow: hidden;<br>  &#125;<br>  .content &#123;<br>    font-size: 24rpx;<br>    font-weight: 400;<br>    color: rgba(102, 102, 102, 1);<br>    line-height: 30rpx;<br>    display: -webkit-box;<br>    -webkit-line-clamp: 2; /*这个数字是设置要显示省略号的行数*/<br>    -webkit-box-orient: vertical;<br>    overflow: hidden;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>前端接口<code>api/modules/user.js</code>：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">// 获取点赞数据<br>const getHands = params =&gt; axios.get(&#x27;/user/getHands&#x27;, params)<br><br>// 获取用户未读消息<br>const getMsg = (data) =&gt; axios.get(&#x27;/user/getmsg&#x27;, data)<br></code></pre></td></tr></table></figure>
<h3 id="接口对接与联调"><a href="#接口对接与联调" class="headerlink" title="#接口对接与联调"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#接口对接与联调">#</a>接口对接与联调</h3><p>调整<code>src/model/CommentsHands.js</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> mongoose <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../config/DBHelpler&#x27;</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Schema</span> = mongoose.<span class="hljs-property">Schema</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">CommentsSchema</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(&#123;<br>  <span class="hljs-attr">cid</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">ref</span>: <span class="hljs-string">&#x27;comments&#x27;</span> &#125;, <span class="hljs-comment">// 评论id</span><br>  <span class="hljs-attr">huid</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">ref</span>: <span class="hljs-string">&#x27;users&#x27;</span> &#125;, <span class="hljs-comment">// 被点赞用户的id</span><br>  <span class="hljs-attr">uid</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">ref</span>: <span class="hljs-string">&#x27;users&#x27;</span> &#125;, <span class="hljs-comment">// 点赞用户id</span><br>  <span class="hljs-attr">created</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">Date</span> &#125;<br>&#125;)<br><br><span class="hljs-title class_">CommentsSchema</span>.<span class="hljs-title function_">pre</span>(<span class="hljs-string">&#x27;save&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">next</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">created</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()<br>  <span class="hljs-title function_">next</span>()<br>&#125;)<br><br><span class="hljs-title class_">CommentsSchema</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;save&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">error, doc, next</span>) &#123;<br>  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">name</span> === <span class="hljs-string">&#x27;MongoError&#x27;</span> &amp;&amp; error.<span class="hljs-property">code</span> === <span class="hljs-number">11000</span>) &#123;<br>    <span class="hljs-title function_">next</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;There was a duplicate key error&#x27;</span>))<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_">next</span>(error)<br>  &#125;<br>&#125;)<br><br><span class="hljs-title class_">CommentsSchema</span>.<span class="hljs-property">statics</span> = &#123;<br>  <span class="hljs-attr">findByCid</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">find</span>(&#123; <span class="hljs-attr">cid</span>: id &#125;)<br>  &#125;,<br>  <span class="hljs-attr">getHandsByUid</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">id, page, limit</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">find</span>(&#123; <span class="hljs-attr">uid</span>: id &#125;)<br>      .<span class="hljs-title function_">populate</span>(&#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;huid&#x27;</span>,<br>        <span class="hljs-attr">select</span>: <span class="hljs-string">&#x27;_id name pic&#x27;</span><br>      &#125;)<br>      .<span class="hljs-title function_">populate</span>(&#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;cid&#x27;</span>,<br>        <span class="hljs-attr">select</span>: <span class="hljs-string">&#x27;_id content&#x27;</span><br>      &#125;)<br>      .<span class="hljs-title function_">skip</span>(page * limit)<br>      .<span class="hljs-title function_">limit</span>(limit)<br>      .<span class="hljs-title function_">sort</span>(&#123; <span class="hljs-attr">created</span>: -<span class="hljs-number">1</span> &#125;)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">CommentsHands</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;comments_hands&#x27;</span>, <span class="hljs-title class_">CommentsSchema</span>)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">CommentsHands</span><br></code></pre></td></tr></table></figure>
<p>获取历史消息<code>src/api/UserController.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取历史消息</span><br><span class="hljs-comment">// 记录评论之后，给作者发送消息</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">getHands</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> params = ctx.<span class="hljs-property">query</span><br>  <span class="hljs-keyword">const</span> page = params.<span class="hljs-property">page</span> ? params.<span class="hljs-property">page</span> : <span class="hljs-number">0</span><br>  <span class="hljs-keyword">const</span> limit = params.<span class="hljs-property">limit</span> ? <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-property">limit</span>) : <span class="hljs-number">0</span><br>  <span class="hljs-comment">// 方法一： 嵌套查询 -&gt; aggregate</span><br>  <span class="hljs-comment">// 方法二： 通过冗余换时间</span><br>  <span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getJWTPayload</span>(ctx.<span class="hljs-property">header</span>.<span class="hljs-property">authorization</span>)<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">CommentsHands</span>.<span class="hljs-title function_">getHandsByUid</span>(obj.<span class="hljs-property">_id</span>, page, limit)<br><br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">data</span>: result<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>完成效果（点赞）：</p>
<p><img src="uniapp.assets/image-20210527031025147.cad808cc.png" alt="image-20210527031025147"></p>
<p>完成效果（评论）：</p>
<p><img src="uniapp.assets/image-20210527030947602.6589bfe7.png" alt="image-20210527030947602"></p>
<h2 id="热门模块"><a href="#热门模块" class="headerlink" title="#热门模块"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#热门模块">#</a>热门模块</h2><p>这个部分利旧接口，所以只用开发前端页面即可：</p>
<h3 id="页面布局和样式-1"><a href="#页面布局和样式-1" class="headerlink" title="#页面布局和样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#页面布局和样式-2">#</a>页面布局和样式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view&gt;<br>    &lt;u-sticky&gt;<br>      &lt;view class=&quot;tabs box-shadow&quot;&gt;<br>        &lt;u-tabs :list=&quot;tabs&quot; :name=&quot;&#x27;value&#x27;&quot; :current=&quot;current&quot; @change=&quot;tabsChange&quot; :is-scroll=&quot;false&quot; active-color=&quot;#02D199&quot; inactive-color=&quot;#666&quot; height=&quot;88&quot;&gt;&lt;/u-tabs&gt;<br>      &lt;/view&gt;<br>    &lt;/u-sticky&gt;<br>    &lt;view class=&quot;content&quot;&gt;<br>      &lt;view class=&quot;tags&quot;&gt;<br>        &lt;uni-tag :text=&quot;item.value&quot; v-for=&quot;(item, i) in types[tabs[current].key]&quot; :class=&quot;&#123; active: tagCur === i &#125;&quot; :key=&quot;i&quot; @click=&quot;tagsChange(i)&quot;&gt;&lt;/uni-tag&gt;<br>      &lt;/view&gt;<br>      &lt;HotPostList :lists=&quot;lists&quot; v-if=&quot;tabs[current].key === &#x27;posts&#x27;&quot; @click=&quot;postDetail&quot;&gt;&lt;/HotPostList&gt;<br>      &lt;HotCommentsList :lists=&quot;lists&quot; :type=&quot;types.comments[tagCur].key&quot; v-else-if=&quot;tabs[current].key === &#x27;comments&#x27;&quot; @click=&quot;commentDetail&quot;&gt;&lt;/HotCommentsList&gt;<br>      &lt;HotSignList :lists=&quot;lists&quot; :type=&quot;types.sign[tagCur].key&quot; v-else&gt;&lt;/HotSignList&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;bottom-line&quot;&gt;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import HotPostList from &#x27;./components/HotPostList&#x27;<br>import HotCommentsList from &#x27;./components/HotCommentsList&#x27;<br>import HotSignList from &#x27;./components/HotSignList&#x27;<br><br>export default &#123;<br>  components: &#123;<br>    HotPostList,<br>    HotCommentsList,<br>    HotSignList<br>  &#125;,<br>  data: () =&gt; (&#123;<br>    tabs: [<br>      &#123;<br>        key: &#x27;posts&#x27;,<br>        value: &#x27;热门帖子&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;comments&#x27;,<br>        value: &#x27;热门评论&#x27;<br>      &#125;,<br>      &#123;<br>        key: &#x27;sign&#x27;,<br>        value: &#x27;签到排行&#x27;<br>      &#125;<br>    ],<br>    types: &#123;<br>      posts: [<br>        &#123;<br>          key: &#x27;3&#x27;,<br>          value: &#x27;全部&#x27;<br>        &#125;,<br>        &#123;<br>          key: &#x27;0&#x27;,<br>          value: &#x27;3日内&#x27;<br>        &#125;,<br>        &#123;<br>          key: &#x27;1&#x27;,<br>          value: &#x27;7日内&#x27;<br>        &#125;,<br>        &#123;<br>          key: &#x27;2&#x27;,<br>          value: &#x27;30日内&#x27;<br>        &#125;<br>      ],<br>      comments: [<br>        &#123;<br>          key: &#x27;1&#x27;,<br>          value: &#x27;最新评论&#x27;<br>        &#125;,<br>        &#123;<br>          key: &#x27;0&#x27;,<br>          value: &#x27;热门评论&#x27;<br>        &#125;<br>      ],<br>      sign: [<br>        &#123;<br>          key: &#x27;0&#x27;,<br>          value: &#x27;总签到榜&#x27;<br>        &#125;,<br>        &#123;<br>          key: &#x27;1&#x27;,<br>          value: &#x27;今日签到榜&#x27;<br>        &#125;<br>      ]<br>    &#125;,<br>    current: 0,<br>    tagCur: 0,<br>    lists: [<br>    ],<br>    page: &#123;<br>      page: 0,<br>      limit: 50<br>    &#125;<br>  &#125;),<br>  onLoad (options) &#123;<br>    const &#123; scene &#125; = options<br>    if (scene) &#123;<br>      this.tabsChange(scene)<br>    &#125; else &#123;<br>      this.getHotPost()<br>    &#125;<br>  &#125;,<br>  onShow () &#123;<br>    this.hanldeChange()<br>  &#125;,<br>  methods: &#123;<br>    async getHotPost () &#123;<br>      const &#123; data &#125; = await this.$u.api.getHotPost(&#123;<br>        ...this.page,<br>        index: this.types.posts[this.tagCur].key<br>      &#125;)<br>      this.lists = data<br>    &#125;,<br>    async getHotComments () &#123;<br>      const &#123; data &#125; = await this.$u.api.getHotComments(&#123;<br>        ...this.page,<br>        index: this.types.comments[this.tagCur].key<br>      &#125;)<br>      this.lists = data<br>    &#125;,<br>    async getHotSignRecord () &#123;<br>      const &#123; data &#125; = await this.$u.api.getHotSignRecord(&#123;<br>        ...this.page,<br>        index: this.types.sign[this.tagCur].key<br>      &#125;)<br>      this.lists = data<br>    &#125;,<br>    tabsChange (value) &#123;<br>      this.current = value<br>      this.tagCur = 0<br>      this.page = &#123;<br>        page: 0,<br>        limit: 50<br>      &#125;<br>      this.hanldeChange()<br>    &#125;,<br>    tagsChange (value) &#123;<br>      this.tagCur = value<br>      this.page = &#123;<br>        page: 0,<br>        limit: 50<br>      &#125;<br>      this.hanldeChange()<br>    &#125;,<br>    hanldeChange () &#123;<br>      if (this.current === 0) &#123;<br>        // 热门帖子<br>        this.getHotPost()<br>      &#125; else if (this.current === 1) &#123;<br>        // 热门评论<br>        this.getHotComments()<br>      &#125; else &#123;<br>        // 签到排行<br>        this.getHotSignRecord()<br>      &#125;<br>    &#125;,<br>    // 跳转文章详情<br>    postDetail (item) &#123;<br>      uni.navigateTo(&#123;<br>        url: &#x27;/subcom-pkg/detail/detail?tid=&#x27; + item._id<br>      &#125;)<br>    &#125;,<br>    // 评论详情<br>    commentDetail (item) &#123;<br>      uni.navigateTo(&#123;<br>        url: `/subcom-pkg/detail/detail?tid=$&#123;item.tid&#125;&amp;cid=$&#123;item._id&#125;`<br>      &#125;)<br>    &#125;<br>  &#125;,<br>  async onPullDownRefresh () &#123;<br>    this.hanldeChange()<br>    uni.stopPullDownRefresh()<br>  &#125;,<br>  // 页面处理函数--监听用户上拉触底<br>  onReachBottom () &#123;&#125;<br>  // 页面处理函数--监听页面滚动(not-nvue)<br>  /* onPageScroll(event) &#123;&#125;, */<br>  // 页面处理函数--用户点击右上角分享<br>  /* onShareAppMessage(options) &#123;&#125;, */<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.tags &#123;<br>  display: flex;<br>  padding: 20rpx 25rpx;<br>  width: 100vw;<br>  background-color: #fff;<br>  z-index: 200;<br>  ::v-deep .uni-tag &#123;<br>    // margin-top: 20rpx;<br>    margin-right: 25rpx;<br>    border-radius: 25rpx;<br>    text &#123;<br>      color: #999;<br>      white-space: nowrap;<br>      font-size: 26rpx;<br>    &#125;<br>  &#125;<br>  .active &#123;<br>    ::v-deep .uni-tag &#123;<br>      background-color: #d6f8ef;<br>      text &#123;<br>        color: #02d199;<br>        font-weight: bold;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br>::v-deep .list &#123;<br>  z-index: 100;<br>  padding: 0 30rpx 60rpx 30rpx;<br>  .list-item &#123;<br>    display: flex;<br>    flex-flow: row nowrap;<br>    justify-content: space-between;<br>    align-items: center;<br>    border-bottom: 1px solid #ddd;<br>  &#125;<br>  .num &#123;<br>    font-size: 36rpx;<br>    font-weight: bold;<br>    &amp;.first &#123;<br>      color: #ed745e;<br>    &#125;<br>    &amp;.second &#123;<br>      color: #e08435;<br>    &#125;<br>    &amp;.third &#123;<br>      color: #f1ae37;<br>    &#125;<br>    &amp;.common &#123;<br>      color: #999;<br>    &#125;<br>  &#125;<br>  .user &#123;<br>    width: 90rpx;<br>    height: 90rpx;<br>    border-radius: 50%;<br>    margin-left: 20rpx;<br>  &#125;<br>  .column &#123;<br>    flex: 1;<br>    display: flex;<br>    flex-flow: column nowrap;<br>    justify-content: space-between;<br>    height: 186rpx;<br>    padding: 30rpx 24rpx;<br><br>    &amp;.no-between &#123;<br>      justify-content: center;<br>      .title &#123;<br>        padding-bottom: 16rpx;<br>      &#125;<br>    &#125;<br>    .title &#123;<br>      color: #333;<br>      font-size: 32rpx;<br>      font-weight: bold;<br>    &#125;<br>    .read &#123;<br>      font-size: 26rpx;<br>      color: #999;<br>      text &#123;<br>        color: #333;<br>        font-weight: bold;<br>        padding-right: 10rpx;<br>      &#125;<br>    &#125;<br>  &#125;<br>  .img &#123;<br>    width: 200rpx;<br>    height: 125rpx;<br>    border-radius: 12rpx;<br>    overflow: hidden;<br>    img &#123;<br>      width: 100%;<br>      height: 100%;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>自定义三个组件，热门帖子<code>HotPostList.vue</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view&gt;<br>    &lt;view class=&quot;list&quot; v-for=&quot;(item,index) in lists&quot; :key=&quot;index&quot;&gt;<br>      &lt;view class=&quot;list-item&quot; @click=&quot;gotoDetail(item)&quot;&gt;<br>        &lt;view class=&quot;num first&quot; v-if=&quot;index === 0&quot;&gt;01&lt;/view&gt;<br>        &lt;view class=&quot;num second&quot; v-else-if=&quot;index === 1&quot;&gt;02&lt;/view&gt;<br>        &lt;view class=&quot;num third&quot; v-else-if=&quot;index === 2&quot;&gt;03&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 9&quot;&gt;&#123;&#123; &#x27;0&#x27; + (index+1) &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 50 &amp;&amp; index &gt;=9&quot;&gt;&#123;&#123; index+1 &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num&quot; v-else&gt;&lt;/view&gt;<br>        &lt;view class=&quot;column&quot;&gt;<br>          &lt;view class=&quot;title&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/view&gt;<br>          &lt;view class=&quot;read&quot;&gt;&#123;&#123;parseInt(item.answer) &gt; 1000?parseInt(item.answer/1000).toFixed(1) + &#x27;k&#x27;: item.answer&#125;&#125; 评论&lt;/view&gt;<br>        &lt;/view&gt;<br>        &lt;view class=&quot;img&quot; v-if=&quot;item.shotpic&quot;&gt;<br>          &lt;image :src=&quot;item.shotpic&quot; mode=&quot;aspectFill&quot; /&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  props: &#123;<br>    lists: &#123;<br>      type: Array,<br>      default: () =&gt; []<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    gotoDetail (item) &#123;<br>      this.$emit(&#x27;click&#x27;, item)<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>热门评论<code>HotCommentsList.vue</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view&gt;<br>    &lt;view class=&quot;list&quot; v-for=&quot;(item,index) in lists&quot; :key=&quot;index&quot;&gt;<br>      &lt;!-- 评论 --&gt;<br>      &lt;view class=&quot;list-item&quot; @click=&quot;gotoDetail(item)&quot;&gt;<br>        &lt;view class=&quot;num first&quot; v-if=&quot;index === 0&quot;&gt;01&lt;/view&gt;<br>        &lt;view class=&quot;num second&quot; v-else-if=&quot;index === 1&quot;&gt;02&lt;/view&gt;<br>        &lt;view class=&quot;num third&quot; v-else-if=&quot;index === 2&quot;&gt;03&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 9&quot;&gt;&#123;&#123; &#x27;0&#x27; + (index+1) &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 50 &amp;&amp; index &gt;=9&quot;&gt;&#123;&#123; index+1 &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num&quot; v-else&gt;&lt;/view&gt;<br>        &lt;u-image width=&quot;88&quot; height=&quot;88&quot; class=&quot;user&quot; :src=&quot;item.cuid? item.cuid.pic : &#x27;&#x27;&quot; mode=&quot;aspectFit&quot; shape=&quot;circle&quot; error-icon=&quot;/static/images/header.jpg&quot; /&gt;<br>        &lt;view class=&quot;column no-between&quot;&gt;<br>          &lt;view class=&quot;title&quot;&gt;&#123;&#123;item.cuid &amp;&amp; item.cuid.name? item.cuid.name : &#x27;imooc&#x27;&#125;&#125;&lt;/view&gt;<br>          &lt;view class=&quot;read&quot; v-if=&quot;parseInt(type) === 0&quot;&gt;<br>            &lt;text&gt;&#123;&#123;item.count&#125;&#125;&lt;/text&gt; 条评论<br>          &lt;/view&gt;<br>          &lt;view class=&quot;read&quot; v-else&gt;&#123;&#123;item.created | moment&#125;&#125; 发表了评论&lt;/view&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  props: &#123;<br>    lists: &#123;<br>      type: Array,<br>      default: () =&gt; []<br>    &#125;,<br>    type: &#123;<br>      type: [Number, String],<br>      default: 0<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    gotoDetail (item) &#123;<br>      this.$emit(&#x27;click&#x27;, item)<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>签到排行<code>HotSignList.vue</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view&gt;<br>    &lt;view class=&quot;list&quot; v-for=&quot;(item, index) in lists&quot; :key=&quot;index&quot;&gt;<br>      &lt;!-- 签到 --&gt;<br>      &lt;view<br>        class=&quot;list-item&quot;<br>        v-if=&quot;item.count &amp;&amp; item.count &gt; 0&quot;<br>        @click=&quot;gotoDetail(item)&quot;<br>      &gt;<br>        &lt;view class=&quot;num first&quot; v-if=&quot;index === 0&quot;&gt;01&lt;/view&gt;<br>        &lt;view class=&quot;num second&quot; v-else-if=&quot;index === 1&quot;&gt;02&lt;/view&gt;<br>        &lt;view class=&quot;num third&quot; v-else-if=&quot;index === 2&quot;&gt;03&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 9&quot;&gt;&#123;&#123;<br>          &#x27;0&#x27; + (index + 1)<br>        &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 50 &amp;&amp; index &gt;= 9&quot;&gt;&#123;&#123;<br>          index + 1<br>        &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num&quot; v-else&gt;&lt;/view&gt;<br>        &lt;u-image<br>          width=&quot;88&quot;<br>          height=&quot;88&quot;<br>          class=&quot;user&quot;<br>          :src=&quot;parseInt(type) === 0 ? item.pic : item.uid.pic&quot;<br>          mode=&quot;aspectFit&quot;<br>          shape=&quot;circle&quot;<br>          error-icon=&quot;/static/images/header.jpg&quot;<br>        /&gt;<br>        &lt;view class=&quot;column no-between&quot;&gt;<br>          &lt;view class=&quot;title&quot;&gt;&#123;&#123;<br>            (item.uid ? item.uid.name : item.name) || &#x27;imooc&#x27;<br>          &#125;&#125;&lt;/view&gt;<br>          &lt;view class=&quot;read&quot; v-if=&quot;parseInt(type) === 0&quot;&gt;<br>            已经连续签到<br>            &lt;span&gt;&#123;&#123; item.count &#125;&#125;&lt;/span&gt; 天<br>          &lt;/view&gt;<br>          &lt;view class=&quot;read&quot; v-else&gt;&#123;&#123; item.created | hours &#125;&#125;&lt;/view&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>      &lt;view class=&quot;list-item&quot; v-else&gt;<br>        &lt;view class=&quot;num first&quot; v-if=&quot;index === 0&quot;&gt;01&lt;/view&gt;<br>        &lt;view class=&quot;num second&quot; v-else-if=&quot;index === 1&quot;&gt;02&lt;/view&gt;<br>        &lt;view class=&quot;num third&quot; v-else-if=&quot;index === 2&quot;&gt;03&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 9&quot;&gt;&#123;&#123;<br>          &#x27;0&#x27; + (index + 1)<br>        &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num common&quot; v-else-if=&quot;index &lt; 50 &amp;&amp; index &gt;= 9&quot;&gt;&#123;&#123;<br>          index + 1<br>        &#125;&#125;&lt;/view&gt;<br>        &lt;view class=&quot;num&quot; v-else&gt;&lt;/view&gt;<br>        &lt;u-image<br>          width=&quot;88&quot;<br>          height=&quot;88&quot;<br>          class=&quot;user&quot;<br>          :src=&quot;parseInt(type) === 0 ? item.pic : item.uid.pic&quot;<br>          mode=&quot;aspectFit&quot;<br>          shape=&quot;circle&quot;<br>          error-icon=&quot;/static/images/header.jpg&quot;<br>        /&gt;<br>        &lt;view class=&quot;column no-between&quot;&gt;<br>          &lt;view class=&quot;title&quot;&gt;&#123;&#123; item.uid ? item.uid.name : &#x27;imooc&#x27; &#125;&#125;&lt;/view&gt;<br>          &lt;view class=&quot;read&quot;&gt;<br>            今日签到时间&lt;span class=&quot;text&quot;&gt;&#123;&#123; item.created | hours &#125;&#125;&lt;/span&gt;<br>          &lt;/view&gt;<br>          &lt;!-- &lt;view class=&quot;read&quot; v-else&gt;&#123;&#123;item.created | hours&#125;&#125;&lt;/view&gt; --&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  props: &#123;<br>    lists: &#123;<br>      type: Array,<br>      default: () =&gt; []<br>    &#125;,<br>    type: &#123;<br>      type: [Number, String],<br>      default: 0<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    gotoDetail (item) &#123;<br>      this.$emit(&#x27;click&#x27;, item)<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.text &#123;<br>  padding-left: 15rpx;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h3 id="接口对接与联调-1"><a href="#接口对接与联调-1" class="headerlink" title="#接口对接与联调"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#接口对接与联调-2">#</a>接口对接与联调</h3><p><code>PublicController.js</code>文件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getHotPost</span> (ctx) &#123;<br>  <span class="hljs-comment">// page limit</span><br>  <span class="hljs-comment">// type index 0-3日内， 1-7日内， 2-30日内， 3-全部</span><br>  <span class="hljs-keyword">const</span> params = ctx.<span class="hljs-property">query</span><br>  <span class="hljs-keyword">const</span> page = params.<span class="hljs-property">page</span> ? <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-property">page</span>) : <span class="hljs-number">0</span><br>  <span class="hljs-keyword">const</span> limit = params.<span class="hljs-property">limit</span> ? <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-property">limit</span>) : <span class="hljs-number">10</span><br>  <span class="hljs-keyword">const</span> index = params.<span class="hljs-property">index</span> ? params.<span class="hljs-property">index</span> : <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-keyword">let</span> startTime = <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-keyword">let</span> endTime = <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-keyword">if</span> (index === <span class="hljs-string">&#x27;0&#x27;</span>) &#123;<br>    startTime = <span class="hljs-title function_">moment</span>().<span class="hljs-title function_">subtract</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;day&#x27;</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY-MM-DD 00:00:00&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index === <span class="hljs-string">&#x27;1&#x27;</span>) &#123;<br>    startTime = <span class="hljs-title function_">moment</span>().<span class="hljs-title function_">subtract</span>(<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;day&#x27;</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY-MM-DD 00:00:00&#x27;</span>)<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index === <span class="hljs-string">&#x27;2&#x27;</span>) &#123;<br>    startTime = <span class="hljs-title function_">moment</span>().<span class="hljs-title function_">subtract</span>(<span class="hljs-number">29</span>, <span class="hljs-string">&#x27;day&#x27;</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY-MM-DD 00:00:00&#x27;</span>)<br>  &#125;<br>  endTime = <span class="hljs-title function_">moment</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;day&#x27;</span>).<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY-MM-DD 00:00:00&#x27;</span>)<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Post</span>.<span class="hljs-title function_">getHotPost</span>(page, limit, startTime, endTime)<br>  <span class="hljs-keyword">const</span> total = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Post</span>.<span class="hljs-title function_">getHotPostCount</span>(page, limit, startTime, endTime)<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    total,<br>    <span class="hljs-attr">data</span>: result,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;获取热门文章成功&#x27;</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">getHotComments</span> (ctx) &#123;<br>  <span class="hljs-comment">// 0-热门评论，1-最新评论</span><br>  <span class="hljs-keyword">const</span> params = ctx.<span class="hljs-property">query</span><br>  <span class="hljs-keyword">const</span> page = params.<span class="hljs-property">page</span> ? <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-property">page</span>) : <span class="hljs-number">0</span><br>  <span class="hljs-keyword">const</span> limit = params.<span class="hljs-property">limit</span> ? <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-property">limit</span>) : <span class="hljs-number">10</span><br>  <span class="hljs-keyword">const</span> index = params.<span class="hljs-property">index</span> ? params.<span class="hljs-property">index</span> : <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Comments</span>.<span class="hljs-title function_">getHotComments</span>(page, limit, index)<br>  <span class="hljs-keyword">const</span> total = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Comments</span>.<span class="hljs-title function_">getHotCommentsCount</span>(index)<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">data</span>: result,<br>    total,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;获取热门评论成功&#x27;</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">getHotSignRecord</span> (ctx) &#123;<br>  <span class="hljs-comment">// 0-总签到榜，1-最新签到</span><br>  <span class="hljs-keyword">const</span> params = ctx.<span class="hljs-property">query</span><br>  <span class="hljs-keyword">const</span> page = params.<span class="hljs-property">page</span> ? <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-property">page</span>) : <span class="hljs-number">0</span><br>  <span class="hljs-keyword">const</span> limit = params.<span class="hljs-property">limit</span> ? <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-property">limit</span>) : <span class="hljs-number">10</span><br>  <span class="hljs-keyword">const</span> index = params.<span class="hljs-property">index</span> ? params.<span class="hljs-property">index</span> : <span class="hljs-string">&#x27;0&#x27;</span><br>  <span class="hljs-keyword">let</span> result<br>  <span class="hljs-keyword">let</span> total = <span class="hljs-number">0</span><br>  <span class="hljs-keyword">if</span> (index === <span class="hljs-string">&#x27;0&#x27;</span>) &#123;<br>    <span class="hljs-comment">// 总签到榜</span><br>    result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">getTotalSign</span>(page, limit)<br>    total = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">getTotalSignCount</span>()<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index === <span class="hljs-string">&#x27;1&#x27;</span>) &#123;<br>    <span class="hljs-comment">// 今日签到</span><br>    result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SignRecord</span>.<span class="hljs-title function_">getTopSign</span>(page, limit)<br>    total = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SignRecord</span>.<span class="hljs-title function_">getTopSignCount</span>()<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index === <span class="hljs-string">&#x27;2&#x27;</span>) &#123;<br>    <span class="hljs-comment">// 最新签到</span><br>    result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SignRecord</span>.<span class="hljs-title function_">getLatestSign</span>(page, limit)<br>    total = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SignRecord</span>.<span class="hljs-title function_">getSignCount</span>()<br>  &#125;<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">data</span>: result,<br>    total,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;获取签到排行成功&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>完成效果（热门帖子）：</p>
<p><img src="uniapp.assets/image-20210527032522285.4590bccc.png" alt="image-20210527032522285"></p>
<p>完成效果（热门评论）：</p>
<p><img src="uniapp.assets/image-20210527032608703.890cffa2.png" alt="image-20210527032608703"></p>
<p>完成效果（签到排行）：</p>
<p><img src="uniapp.assets/image-20210527032652755.931b7a09.png" alt="image-20210527032652755"></p>
<h2 id="个人中心模块"><a href="#个人中心模块" class="headerlink" title="#个人中心模块"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#个人中心模块">#</a>个人中心模块</h2><h3 id="页面布局和样式-2"><a href="#页面布局和样式-2" class="headerlink" title="#页面布局和样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#页面布局和样式-3">#</a>页面布局和样式</h3><p>整体的页面分为：</p>
<ul>
<li>背景</li>
<li>个人信息 + 统计信息</li>
<li>功能区</li>
<li>快速跳转区</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view&gt;<br>    &lt;view class=&quot;grey&quot;&gt;<br>      &lt;view class=&quot;bg&quot;&gt;&lt;/view&gt;<br>      &lt;view class=&quot;wrapper&quot;&gt;<br>        &lt;!-- 个人信息卡片 --&gt;<br>        &lt;view class=&quot;profile&quot;&gt;<br>          &lt;view class=&quot;info&quot;&gt;<br>            &lt;u-image class=&quot;pic&quot; :src=&quot;isLogin ? userInfo.pic: &#x27;&#x27;&quot; width=&quot;120&quot; height=&quot;120&quot; shape=&quot;circle&quot; error-icon=&quot;/static/images/header.jpg&quot; /&gt;<br>            &lt;!-- 用户昵称 + VIP --&gt;<br>            &lt;view class=&quot;user&quot; @click=&quot;navTo&quot;&gt;<br>              &lt;view class=&quot;name&quot;&gt;&#123;&#123;isLogin ?userInfo.name : &#x27;请登录&#x27;&#125;&#125;&lt;/view&gt;<br>              &lt;view class=&quot;fav&quot;&gt;<br>                &lt;!-- &lt;van-icon name=&quot;fav2&quot; class-prefix=&quot;iconfont&quot; size=&quot;14&quot;&gt;&lt;/van-icon&gt; --&gt;<br>                积分：&#123;&#123;userInfo &amp;&amp; userInfo.favs ? userInfo.favs:0&#125;&#125;<br>              &lt;/view&gt;<br>            &lt;/view&gt;<br>            &lt;view class=&quot;link&quot; @click=&quot;gotoGuard(&#x27;/sub-pkg/user-info/user-info&#x27;)&quot;&gt;个人主页 &gt;&lt;/view&gt;<br>          &lt;/view&gt;<br>          &lt;!-- 统计信息 --&gt;<br>          &lt;view class=&quot;stats&quot; v-if=&quot;isLogin&quot;&gt;<br>            &lt;view class=&quot;item&quot;&gt;<br>              &lt;navigator :url=&quot;&#x27;/sub-pkg/posts/posts?uid=&#x27; + uid + &#x27;&amp;type=p&#x27;&quot;&gt;<br>                &lt;view&gt;&#123;&#123; countMyPost &#125;&#125;&lt;/view&gt;<br>                &lt;view class=&quot;title&quot;&gt;我的帖子&lt;/view&gt;<br>              &lt;/navigator&gt;<br>            &lt;/view&gt;<br>            &lt;view class=&quot;item&quot;&gt;<br>              &lt;navigator :url=&quot;&#x27;/sub-pkg/posts/posts?uid=&#x27; + uid+ &#x27;&amp;type=c&#x27;&quot;&gt;<br>                &lt;view&gt;&#123;&#123; countMyCollect &#125;&#125;&lt;/view&gt;<br>                &lt;view class=&quot;title&quot;&gt;收藏夹&lt;/view&gt;<br>              &lt;/navigator&gt;<br>            &lt;/view&gt;<br>            &lt;view class=&quot;item&quot;&gt;<br>              &lt;navigator :url=&quot;&#x27;/sub-pkg/posts/posts?uid=&#x27; + uid+ &#x27;&amp;type=h&#x27;&quot;&gt;<br>                &lt;view&gt;&#123;&#123; countMyHistory &#125;&#125;&lt;/view&gt;<br>                &lt;view class=&quot;title&quot;&gt;最近浏览&lt;/view&gt;<br>              &lt;/navigator&gt;<br>            &lt;/view&gt;<br>          &lt;/view&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>      &lt;!-- 功能区 --&gt;<br>      &lt;view class=&quot;center-wraper&quot;&gt;<br>        &lt;view class=&quot;center-list first&quot;&gt;<br>          &lt;li v-for=&quot;(item,index) in lists&quot; :key=&quot;index&quot;&gt;<br>            &lt;view @click=&quot;gotoGuardHandler(item)&quot;&gt;<br>              &lt;i :class=&quot;item.icon&quot;&gt;&lt;/i&gt;<br>              &lt;span&gt;&#123;&#123;item.name&#125;&#125;&lt;/span&gt;<br>            &lt;/view&gt;<br>          &lt;/li&gt;<br>        &lt;/view&gt;<br>        &lt;!-- 首页 -&gt; 分类标签 快速跳转 --&gt;<br>        &lt;view class=&quot;center-list&quot;&gt;<br>          &lt;li v-for=&quot;(item,index) in routes&quot; :key=&quot;index&quot; @click=&quot;gotoHome(item.tab)&quot;&gt;<br>            &lt;i :class=&quot;item.icon&quot;&gt;&lt;/i&gt;<br>            &lt;span&gt;&#123;&#123;item.name&#125;&#125;&lt;/span&gt;<br>          &lt;/li&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;bottom-line&quot;&gt;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; gotoGuard &#125; from &#x27;@/common/checkAuth&#x27;<br>import &#123; mapGetters, mapState, mapMutations &#125; from &#x27;vuex&#x27;<br>export default &#123;<br>  data: () =&gt; (&#123;<br>    lists: [<br>      &#123;<br>        name: &#x27;我的帖子&#x27;,<br>        icon: &#x27;icon-teizi&#x27;,<br>        routeName: &#x27;/sub-pkg/posts/posts&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;修改设置&#x27;,<br>        icon: &#x27;icon-setting&#x27;,<br>        routeName: &#x27;/sub-pkg/settings/settings&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;签到中心&#x27;,<br>        icon: &#x27;icon-qiandao&#x27;,<br>        routeName: &#x27;/sub-pkg/sign/sign&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;电子书&#x27;,<br>        icon: &#x27;icon-book&#x27;,<br>        routeName: &#x27;/sub-pkg/books/books&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;关于我们&#x27;,<br>        icon: &#x27;icon-about&#x27;,<br>        routeName: &#x27;/sub-pkg/about/about&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;人工客服&#x27;,<br>        icon: &#x27;icon-support&#x27;,<br>        routeName: &#x27;/sub-pkg/suggest/suggest&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;意见反馈&#x27;,<br>        icon: &#x27;icon-lock2&#x27;,<br>        routeName: &#x27;/sub-pkg/suggest/survey&#x27;<br>      &#125;<br>    ],<br>    routes: [<br>      &#123;<br>        name: &#x27;提问&#x27;,<br>        icon: &#x27;icon-question&#x27;,<br>        tab: &#x27;ask&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;分享&#x27;,<br>        icon: &#x27;icon-share&#x27;,<br>        tab: &#x27;share&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;讨论&#x27;,<br>        icon: &#x27;icon-taolun&#x27;,<br>        tab: &#x27;discuss&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;建议&#x27;,<br>        icon: &#x27;icon-advise&#x27;,<br>        tab: &#x27;advise&#x27;<br>      &#125;<br>    ],<br>    countMyPost: 0,<br>    countMyCollect: 0,<br>    countMyHistory: 0<br>    // isLogin: true<br>  &#125;),<br>  computed: &#123;<br>    ...mapGetters([&#x27;isLogin&#x27;]),<br>    ...mapState([&#x27;userInfo&#x27;]),<br>    uid () &#123;<br>      return this.userInfo._id<br>    &#125;<br>  &#125;,<br>  onShow () &#123;<br>  &#125;,<br>  methods: &#123;<br>    ...mapMutations([&#x27;setUserInfo&#x27;]),<br>    gotoGuard,<br>    gotoGuardHandler (item) &#123;<br>      const &#123; name, routeName &#125; = item<br>      if (name === &#x27;我的帖子&#x27;) &#123;<br>        gotoGuard(routeName + `?uid=$&#123;this.uid&#125;&amp;type=p`)<br>      &#125; else &#123;<br>        gotoGuard(routeName)<br>      &#125;<br>    &#125;,<br>    gotoHome (tab) &#123;<br>      uni.switchTab(&#123;<br>        url: &#x27;/pages/home/home&#x27;<br>      &#125;)<br>    &#125;,<br>    navTo () &#123;<br>      if (!this.isLogin) &#123;<br>        uni.navigateTo(&#123;<br>          url: &#x27;/subcom-pkg/auth/auth&#x27;<br>        &#125;)<br>      &#125;<br>    &#125;,<br><br>  &#125;<br><br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot;&gt;<br>.grey &#123;<br>  position: fixed;<br>  width: 100%;<br>  height: 100%;<br>  left: 0;<br>  top: 0;<br>  z-index: 30;<br>&#125;<br>a &#123;<br>  color: #666;<br>  text-decoration: none;<br>&#125;<br>.bg &#123;<br>  background-image: url(&quot;/static/images/my_bg.png&quot;);<br>  background-repeat: no-repeat;<br>  background-size: contain;<br>  position: relative;<br>  left: 0;<br>  top: 0;<br>  width: 100%;<br>  height: 280rpx;<br>  background-position: 0 0;<br>  z-index: 100;<br>&#125;<br>.wrapper &#123;<br>  width: 100%;<br>  height: 370rpx;<br>  padding: 25rpx;<br>  position: absolute;<br>  left: 0;<br>  top: 0;<br>  z-index: 100;<br>  box-sizing: border-box;<br>  color: #333;<br>  .profile &#123;<br>    background: #fff;<br>    border-radius: 12rpx;<br>    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);<br>    width: 100%;<br>    height: 100%;<br>    padding: 30rpx;<br>    box-sizing: border-box;<br>    .name &#123;<br>      font-size: 36rpx;<br>      font-weight: 700;<br>      margin-bottom: 10rpx;<br>      margin-top: 0;<br>      width: 370rpx;<br>      overflow: hidden;<br>      text-overflow: ellipsis;<br>      white-space: nowrap;<br>    &#125;<br>    .link &#123;<br>      font-size: 24rpx;<br>      color: #999;<br>    &#125;<br>    .fav &#123;<br>      display: inline-block;<br>      padding: 8px 12rpx;<br>      background: rgba(2, 209, 153, 0.16);<br>      border-radius: 12rpx;<br>      color: #02d199;<br>      margin: 0;<br>      font-size: 22rpx;<br>      .icon-fav &#123;<br>        padding-right: 10rpx;<br>      &#125;<br>    &#125;<br>    .info,<br>    .stats &#123;<br>      display: flex;<br>      flex-flow: row nowrap;<br>      justify-content: space-between;<br>      align-items: center;<br>    &#125;<br>    .info &#123;<br>      margin-bottom: 24rpx;<br>    &#125;<br>    .stats &#123;<br>      justify-content: space-around;<br>    &#125;<br>    .user &#123;<br>      flex: 1;<br>      padding-left: 20rpx;<br>    &#125;<br>    .pic &#123;<br>      width: 120rpx;<br>      height: 120rpx;<br>      border-radius: 50%;<br>    &#125;<br>    .item &#123;<br>      text-align: center;<br>      position: relative;<br>      p &#123;<br>        margin-top: 14rpx;<br>        margin-bottom: 0;<br>      &#125;<br>      &amp;:after &#123;<br>        width: 2rpx;<br>        height: 80rpx;<br>        background: #ddd;<br>        content: &quot;&quot;;<br>        position: absolute;<br>        right: -60rpx;<br>        top: 20rpx;<br>      &#125;<br>      &amp;:last-child &#123;<br>        &amp;:after &#123;<br>          width: 0;<br>        &#125;<br>      &#125;<br>      .title &#123;<br>        color: #666;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>.center-wraper &#123;<br>  background: #f6f5f8;<br>  position: relative;<br>  width: 100%;<br>  // height: 100%;<br>  z-index: 10;<br>  .center-list &#123;<br>    background: #fff;<br>    margin-bottom: 30rpx;<br>    display: flex;<br>    flex-flow: wrap;<br>    padding-top: 40rpx;<br>    &amp;.first &#123;<br>      padding-top: 100rpx;<br>    &#125;<br>    li &#123;<br>      width: 25%;<br>      text-align: center;<br>      color: #666;<br>      margin-bottom: 40rpx;<br>      font-size: 26rpx;<br>    &#125;<br>    i &#123;<br>      display: block;<br>      margin: 0 auto;<br>      font-size: 40rpx;<br>      width: 56rpx;<br>      height: 56rpx;<br>      margin-bottom: 20rpx;<br>      color: #888;<br>      background-size: contain;<br>    &#125;<br>    .icon-teizi &#123;<br>      background-image: url(&quot;/static/images/teizi@2x.png&quot;);<br>    &#125;<br>    .icon-setting &#123;<br>      background-image: url(&quot;/static/images/setting@2x.png&quot;);<br>    &#125;<br>    .icon-lock2 &#123;<br>      background-image: url(&quot;/static/images/lock2@2x.png&quot;);<br>    &#125;<br>    .icon-support &#123;<br>      background-image: url(&quot;/static/images/support.png&quot;);<br>    &#125;<br>    .icon-qiandao &#123;<br>      background-image: url(&quot;/static/images/sign1.png&quot;);<br>    &#125;<br>    .icon-book &#123;<br>      background-image: url(&quot;/static/images/books.png&quot;);<br>    &#125;<br>    .icon-record &#123;<br>      background-image: url(&quot;/static/images/record@2x.png&quot;);<br>    &#125;<br>    .icon-about &#123;<br>      background-image: url(&quot;/static/images/about.png&quot;);<br>    &#125;<br>    // 快捷访问<br>    .icon-question &#123;<br>      background-image: url(&quot;/static/images/question@2x.png&quot;);<br>    &#125;<br>    .icon-share &#123;<br>      background-image: url(&quot;/static/images/share@2x.png&quot;);<br>    &#125;<br>    .icon-taolun &#123;<br>      background-image: url(&quot;/static/images/taolun@2x.png&quot;);<br>    &#125;<br>    .icon-advise &#123;<br>      background-image: url(&quot;/static/images/advice@2x.png&quot;);<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h3 id="最近浏览功能"><a href="#最近浏览功能" class="headerlink" title="#最近浏览功能"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#最近浏览功能">#</a>最近浏览功能</h3><p>创建<code>PostHistory</code>模型：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> mongoose <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../config/DBHelpler&#x27;</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Schema</span> = mongoose.<span class="hljs-property">Schema</span><br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">PostHistorySchema</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(<br>  &#123;<br>    <span class="hljs-attr">uid</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">ref</span>: <span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> &#125;,<br>    <span class="hljs-attr">tid</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">ref</span>: <span class="hljs-string">&#x27;post&#x27;</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> &#125;<br>  &#125;,<br>  &#123; <span class="hljs-attr">timestamps</span>: &#123; <span class="hljs-attr">createdAt</span>: <span class="hljs-string">&#x27;created&#x27;</span>, <span class="hljs-attr">updatedAt</span>: <span class="hljs-string">&#x27;updated&#x27;</span> &#125; &#125;<br>)<br><br><span class="hljs-title class_">PostHistorySchema</span>.<span class="hljs-property">statics</span> = &#123;<br>  <span class="hljs-title function_">queryCount</span> (options) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">find</span>(options).<span class="hljs-title function_">countDocuments</span>()<br>  &#125;,<br>  <span class="hljs-title function_">addOrUpdate</span> (uid, tid) &#123;<br>    <span class="hljs-comment">// 增加浏览记录，如果有则更新浏览时间</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findOne</span>(&#123; uid, tid &#125;).<span class="hljs-title function_">exec</span>(<span class="hljs-function">(<span class="hljs-params">err, doc</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)<br>      &#125;<br>      <span class="hljs-keyword">if</span> (doc) &#123;<br>        doc.<span class="hljs-property">created</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()<br>        doc.<span class="hljs-title function_">save</span>()<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">create</span>(&#123; uid, tid &#125;)<br>      &#125;<br>    &#125;)<br>  &#125;,<br>  <span class="hljs-title function_">delOne</span> (uid, tid) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteOne</span>(&#123; uid, tid &#125;)<br>  &#125;,<br>  <span class="hljs-title function_">getListByUid</span> (uid, skip, limit) &#123;<br>    <span class="hljs-comment">// 获取用户的浏览记录</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">find</span>(&#123; uid &#125;)<br>      .<span class="hljs-title function_">populate</span>(&#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;tid&#x27;</span>,<br>        <span class="hljs-attr">select</span>: <span class="hljs-string">&#x27;uid catalog title content answer created&#x27;</span>,<br>        <span class="hljs-attr">populate</span>: &#123;<br>          <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;uid&#x27;</span>,<br>          <span class="hljs-attr">select</span>: <span class="hljs-string">&#x27;name pic&#x27;</span><br>        &#125;<br>      &#125;)<br>      .<span class="hljs-title function_">sort</span>(&#123; <span class="hljs-attr">created</span>: -<span class="hljs-number">1</span> &#125;)<br>      .<span class="hljs-title function_">skip</span>(skip)<br>      .<span class="hljs-title function_">limit</span>(limit)<br>  &#125;,<br>  <span class="hljs-attr">deleteByPostId</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">tid</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteMany</span>(&#123; tid &#125;)<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">PostHistory</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;post_history&#x27;</span>, <span class="hljs-title class_">PostHistorySchema</span>)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">PostHistory</span><br></code></pre></td></tr></table></figure>
<p>创建<code>src/api/StaticsController.js</code>：</p>
<ul>
<li>统计最近浏览、我的帖子、收藏夹、我的评论、我的点赞、我的获赞、个人积分、用户的签到日期；</li>
<li>个人积分需要单独写方法，其他的可以使用mongoose中的<code>countDocuments</code>方法；</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// import &#123; getJWTPayload &#125; from &#x27;@/common/Utils&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Post</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/model/Post&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">PostHistory</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/model/PostHistory&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/model/User&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">UserCollect</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/model/UserCollect&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Comments</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/model/Comments&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">CommentsHands</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/model/CommentsHands&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">SignRecord</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/model/SignRecord&#x27;</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 统计相关的 api 放在这里</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">StatisticsController</span> &#123;<br>  <span class="hljs-comment">// 统计数据：最近浏览、我的帖子、收藏夹、我的评论、我的点赞、获赞、个人积分</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">wxUserCount</span> (ctx) &#123;<br>    <span class="hljs-keyword">const</span> body = ctx.<span class="hljs-property">query</span><br>    <span class="hljs-comment">// const obj = await getJWTPayload(ctx.header.authorization)</span><br>    <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">_id</span>: uid &#125; = ctx<br>    <span class="hljs-keyword">const</span> &#123; reqAll &#125; = body<br>    <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: StatisticsController.js ~ line 20 ~ StatisticsController ~ wxUserCount ~ reqAll&#x27;, reqAll)</span><br>    <span class="hljs-keyword">if</span> (uid) &#123;<br>      <span class="hljs-keyword">const</span> countMyHistory =<br>        (body.<span class="hljs-property">reqHistory</span> || reqAll) &amp;&amp; (<span class="hljs-keyword">await</span> <span class="hljs-title class_">PostHistory</span>.<span class="hljs-title function_">countDocuments</span>(&#123; uid &#125;)) <span class="hljs-comment">// 最近浏览</span><br>      <span class="hljs-keyword">const</span> countMyPost =<br>        (body.<span class="hljs-property">reqPost</span> || reqAll) &amp;&amp; (<span class="hljs-keyword">await</span> <span class="hljs-title class_">Post</span>.<span class="hljs-title function_">countDocuments</span>(&#123; uid &#125;)) <span class="hljs-comment">// 我的帖子</span><br>      <span class="hljs-keyword">const</span> countMyCollect =<br>        (body.<span class="hljs-property">reqCollect</span> || reqAll) &amp;&amp;<br>        (<span class="hljs-keyword">await</span> <span class="hljs-title class_">UserCollect</span>.<span class="hljs-title function_">countDocuments</span>(&#123; uid &#125;)) <span class="hljs-comment">// 收藏夹</span><br>      <span class="hljs-keyword">const</span> countMyComment =<br>        (body.<span class="hljs-property">reqComment</span> || reqAll) &amp;&amp;<br>        (<span class="hljs-keyword">await</span> <span class="hljs-title class_">Comments</span>.<span class="hljs-title function_">countDocuments</span>(&#123; <span class="hljs-attr">cuid</span>: uid &#125;)) <span class="hljs-comment">// 我的评论</span><br>      <span class="hljs-keyword">const</span> countMyHands =<br>        (body.<span class="hljs-property">reqHands</span> || reqAll) &amp;&amp;<br>        (<span class="hljs-keyword">await</span> <span class="hljs-title class_">CommentsHands</span>.<span class="hljs-title function_">countDocuments</span>(&#123; uid &#125;)) <span class="hljs-comment">// 我的点赞</span><br>      <span class="hljs-keyword">const</span> countHandsOnMe =<br>        (body.<span class="hljs-property">reqHandsOnMe</span> || reqAll) &amp;&amp;<br>        (<span class="hljs-keyword">await</span> <span class="hljs-title class_">CommentsHands</span>.<span class="hljs-title function_">countDocuments</span>(&#123; <span class="hljs-attr">huid</span>: uid &#125;)) <span class="hljs-comment">// 获赞</span><br>      <span class="hljs-keyword">const</span> countFavs = (body.<span class="hljs-property">reqFavs</span> || reqAll) &amp;&amp; (<span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">getFavs</span>(uid)) <span class="hljs-comment">// 个人积分</span><br>      <span class="hljs-keyword">const</span> countSign =<br>        (body.<span class="hljs-property">reqSign</span> || reqAll) &amp;&amp; (<span class="hljs-keyword">await</span> <span class="hljs-title class_">SignRecord</span>.<span class="hljs-title function_">countDocuments</span>(&#123; uid &#125;)) <span class="hljs-comment">// 签到次数</span><br>      <span class="hljs-keyword">const</span> lastSigned =<br>        (body.<span class="hljs-property">reqLastSigned</span> || reqAll) &amp;&amp; (<span class="hljs-keyword">await</span> <span class="hljs-title class_">SignRecord</span>.<span class="hljs-title function_">countDocuments</span>(&#123; uid &#125;)) <span class="hljs-comment">// 获取用户最新的签到日期</span><br><br>      ctx.<span class="hljs-property">body</span> = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>        <span class="hljs-attr">data</span>: &#123;<br>          countMyPost,<br>          countMyCollect,<br>          countMyComment,<br>          countMyHands,<br>          countHandsOnMe,<br>          countMyHistory,<br>          countFavs,<br>          lastSigned,<br>          countSign<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ctx.<span class="hljs-property">body</span> = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;查询失败&#x27;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StatisticsController</span>()<br></code></pre></td></tr></table></figure>
<p>更新用户获取文章详情的方法<code>getPostDetail</code>，在文件<code>src/api/ContentController.js</code>中：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取文章详情</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">getPostDetail</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> params = ctx.<span class="hljs-property">query</span><br>  <span class="hljs-keyword">if</span> (!params.<span class="hljs-property">tid</span>) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;文章id为空&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Post</span>.<span class="hljs-title function_">findByTid</span>(params.<span class="hljs-property">tid</span>)<br>  <span class="hljs-keyword">if</span> (!post) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>      <span class="hljs-attr">data</span>: &#123;&#125;,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;查询文章详情成功&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">let</span> isFav = <span class="hljs-number">0</span><br>  <span class="hljs-comment">// 判断用户是否传递Authorization的数据，即是否登录</span><br>  <span class="hljs-keyword">if</span> (<br>    <span class="hljs-keyword">typeof</span> ctx.<span class="hljs-property">header</span>.<span class="hljs-property">authorization</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span> &amp;&amp;<br>    ctx.<span class="hljs-property">header</span>.<span class="hljs-property">authorization</span> !== <span class="hljs-string">&#x27;&#x27;</span><br>  ) &#123;<br>    <span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getJWTPayload</span>(ctx.<span class="hljs-property">header</span>.<span class="hljs-property">authorization</span>)<br>    <span class="hljs-keyword">const</span> userCollect = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserCollect</span>.<span class="hljs-title function_">findOne</span>(&#123;<br>      <span class="hljs-attr">uid</span>: obj.<span class="hljs-property">_id</span>,<br>      <span class="hljs-attr">tid</span>: params.<span class="hljs-property">tid</span><br>    &#125;)<br>    <span class="hljs-keyword">if</span> (userCollect &amp;&amp; userCollect.<span class="hljs-property">tid</span>) &#123;<br>      isFav = <span class="hljs-number">1</span><br>    &#125;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title class_">PostHistory</span>.<span class="hljs-title function_">addOrUpdate</span>(ctx.<span class="hljs-property">_id</span>, params.<span class="hljs-property">tid</span>) <span class="hljs-comment">// 添加浏览记录</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> newPost = post.<span class="hljs-title function_">toJSON</span>()<br>  newPost.<span class="hljs-property">isFav</span> = isFav<br>  <span class="hljs-comment">// 更新文章阅读记数</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Post</span>.<span class="hljs-title function_">updateOne</span>(<br>    &#123; <span class="hljs-attr">_id</span>: params.<span class="hljs-property">tid</span> &#125;,<br>    &#123; <span class="hljs-attr">$inc</span>: &#123; <span class="hljs-attr">reads</span>: <span class="hljs-number">1</span> &#125; &#125;<br>  )<br>  <span class="hljs-keyword">if</span> (post.<span class="hljs-property">_id</span> &amp;&amp; result.<span class="hljs-property">ok</span> === <span class="hljs-number">1</span>) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>      <span class="hljs-attr">data</span>: newPost,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;查询文章详情成功&#x27;</span><br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;获取文章详情失败&#x27;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="接口对接与联调-2"><a href="#接口对接与联调-2" class="headerlink" title="#接口对接与联调"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/04-消息&amp;热门&amp;个人中心.html#接口对接与联调-3">#</a>接口对接与联调</h3><p>前端添加接口：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 个人中心的统计数字</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">wxUserCount</span> = params =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/user/wxUserCount&#x27;</span>, params)<br></code></pre></td></tr></table></figure>
<p>前端页面添加请求：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getUserCount</span> () &#123;<br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">_id</span>: uid &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">userInfo</span><br>  <span class="hljs-keyword">if</span> (!uid) <span class="hljs-keyword">return</span><br>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUserInfo</span>()<br>  <span class="hljs-keyword">const</span> &#123; data, code &#125; = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">wxUserCount</span>(&#123; uid, <span class="hljs-attr">reqAll</span>: <span class="hljs-number">1</span> &#125;)<br>  <span class="hljs-keyword">if</span> (code === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; countMyPost, countMyCollect, countMyHistory &#125; = data<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">countMyPost</span> = countMyPost<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">countMyCollect</span> = countMyCollect<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">countMyHistory</span> = countMyHistory<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>完整的页面代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view&gt;<br>    &lt;view class=&quot;grey&quot;&gt;<br>      &lt;view class=&quot;bg&quot;&gt;&lt;/view&gt;<br>      &lt;view class=&quot;wrapper&quot;&gt;<br>        &lt;!-- 个人信息卡片 --&gt;<br>        &lt;view class=&quot;profile&quot;&gt;<br>          &lt;view class=&quot;info&quot;&gt;<br>            &lt;u-image class=&quot;pic&quot; :src=&quot;isLogin ? userInfo.pic: &#x27;&#x27;&quot; width=&quot;120&quot; height=&quot;120&quot; shape=&quot;circle&quot; error-icon=&quot;/static/images/header.jpg&quot; /&gt;<br>            &lt;!-- 用户昵称 + VIP --&gt;<br>            &lt;view class=&quot;user&quot; @click=&quot;navTo&quot;&gt;<br>              &lt;view class=&quot;name&quot;&gt;&#123;&#123;isLogin ?userInfo.name : &#x27;请登录&#x27;&#125;&#125;&lt;/view&gt;<br>              &lt;view class=&quot;fav&quot;&gt;<br>                &lt;!-- &lt;van-icon name=&quot;fav2&quot; class-prefix=&quot;iconfont&quot; size=&quot;14&quot;&gt;&lt;/van-icon&gt; --&gt;<br>                积分：&#123;&#123;userInfo &amp;&amp; userInfo.favs ? userInfo.favs:0&#125;&#125;<br>              &lt;/view&gt;<br>            &lt;/view&gt;<br>            &lt;view class=&quot;link&quot; @click=&quot;gotoGuard(&#x27;/sub-pkg/user-info/user-info&#x27;)&quot;&gt;个人主页 &gt;&lt;/view&gt;<br>            &lt;!-- &lt;navigator class=&quot;link&quot; url=&quot;/subcom-pkg/auth/auth&quot;&gt;个人主页 &gt;&lt;/navigator&gt; --&gt;<br>            &lt;!-- &lt;navigator class=&quot;link&quot; url=&quot;/sub-pkg/user-info/user-info&quot;&gt;个人主页 &gt;&lt;/navigator&gt; --&gt;<br>          &lt;/view&gt;<br>          &lt;view class=&quot;stats&quot; v-if=&quot;isLogin&quot;&gt;<br>            &lt;view class=&quot;item&quot;&gt;<br>              &lt;navigator :url=&quot;&#x27;/sub-pkg/posts/posts?uid=&#x27; + uid + &#x27;&amp;type=p&#x27;&quot;&gt;<br>                &lt;view&gt;&#123;&#123; countMyPost &#125;&#125;&lt;/view&gt;<br>                &lt;view class=&quot;title&quot;&gt;我的帖子&lt;/view&gt;<br>              &lt;/navigator&gt;<br>            &lt;/view&gt;<br>            &lt;view class=&quot;item&quot;&gt;<br>              &lt;navigator :url=&quot;&#x27;/sub-pkg/posts/posts?uid=&#x27; + uid+ &#x27;&amp;type=c&#x27;&quot;&gt;<br>                &lt;view&gt;&#123;&#123; countMyCollect &#125;&#125;&lt;/view&gt;<br>                &lt;view class=&quot;title&quot;&gt;收藏夹&lt;/view&gt;<br>              &lt;/navigator&gt;<br>            &lt;/view&gt;<br>            &lt;view class=&quot;item&quot;&gt;<br>              &lt;navigator :url=&quot;&#x27;/sub-pkg/posts/posts?uid=&#x27; + uid+ &#x27;&amp;type=h&#x27;&quot;&gt;<br>                &lt;view&gt;&#123;&#123; countMyHistory &#125;&#125;&lt;/view&gt;<br>                &lt;view class=&quot;title&quot;&gt;最近浏览&lt;/view&gt;<br>              &lt;/navigator&gt;<br>            &lt;/view&gt;<br>          &lt;/view&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>      &lt;view class=&quot;center-wraper&quot;&gt;<br>        &lt;view class=&quot;center-list first&quot;&gt;<br>          &lt;li v-for=&quot;(item,index) in lists&quot; :key=&quot;index&quot;&gt;<br>            &lt;view @click=&quot;gotoGuardHandler(item)&quot;&gt;<br>              &lt;i :class=&quot;item.icon&quot;&gt;&lt;/i&gt;<br>              &lt;span&gt;&#123;&#123;item.name&#125;&#125;&lt;/span&gt;<br>            &lt;/view&gt;<br>          &lt;/li&gt;<br>        &lt;/view&gt;<br>        &lt;view class=&quot;center-list&quot;&gt;<br>          &lt;li v-for=&quot;(item,index) in routes&quot; :key=&quot;index&quot; @click=&quot;gotoHome(item.tab)&quot;&gt;<br>            &lt;i :class=&quot;item.icon&quot;&gt;&lt;/i&gt;<br>            &lt;span&gt;&#123;&#123;item.name&#125;&#125;&lt;/span&gt;<br>          &lt;/li&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;bottom-line&quot;&gt;&lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; gotoGuard &#125; from &#x27;@/common/checkAuth&#x27;<br>import &#123; mapGetters, mapState, mapMutations &#125; from &#x27;vuex&#x27;<br>export default &#123;<br>  data: () =&gt; (&#123;<br>    lists: [<br>      &#123;<br>        name: &#x27;我的帖子&#x27;,<br>        icon: &#x27;icon-teizi&#x27;,<br>        routeName: &#x27;/sub-pkg/posts/posts&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;修改设置&#x27;,<br>        icon: &#x27;icon-setting&#x27;,<br>        routeName: &#x27;/sub-pkg/settings/settings&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;签到中心&#x27;,<br>        icon: &#x27;icon-qiandao&#x27;,<br>        routeName: &#x27;/sub-pkg/sign/sign&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;电子书&#x27;,<br>        icon: &#x27;icon-book&#x27;,<br>        routeName: &#x27;/sub-pkg/books/books&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;关于我们&#x27;,<br>        icon: &#x27;icon-about&#x27;,<br>        routeName: &#x27;/sub-pkg/about/about&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;人工客服&#x27;,<br>        icon: &#x27;icon-support&#x27;,<br>        routeName: &#x27;/sub-pkg/suggest/suggest&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;意见反馈&#x27;,<br>        icon: &#x27;icon-lock2&#x27;,<br>        routeName: &#x27;/sub-pkg/suggest/survey&#x27;<br>      &#125;<br>    ],<br>    routes: [<br>      &#123;<br>        name: &#x27;提问&#x27;,<br>        icon: &#x27;icon-question&#x27;,<br>        tab: &#x27;ask&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;分享&#x27;,<br>        icon: &#x27;icon-share&#x27;,<br>        tab: &#x27;share&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;讨论&#x27;,<br>        icon: &#x27;icon-taolun&#x27;,<br>        tab: &#x27;discuss&#x27;<br>      &#125;,<br>      &#123;<br>        name: &#x27;建议&#x27;,<br>        icon: &#x27;icon-advise&#x27;,<br>        tab: &#x27;advise&#x27;<br>      &#125;<br>    ],<br>    countMyPost: 0,<br>    countMyCollect: 0,<br>    countMyHistory: 0<br>    // isLogin: true<br>  &#125;),<br>  computed: &#123;<br>    ...mapGetters([&#x27;isLogin&#x27;]),<br>    ...mapState([&#x27;userInfo&#x27;]),<br>    uid () &#123;<br>      return this.userInfo._id<br>    &#125;<br>  &#125;,<br>  onShow () &#123;<br>    this.getUserCount()<br>  &#125;,<br>  methods: &#123;<br>    ...mapMutations([&#x27;setTab&#x27;, &#x27;setUserInfo&#x27;]),<br>    gotoGuard,<br>    gotoGuardHandler (item) &#123;<br>      const &#123; name, routeName &#125; = item<br>      if (name === &#x27;我的帖子&#x27;) &#123;<br>        gotoGuard(routeName + `?uid=$&#123;this.uid&#125;&amp;type=p`)<br>      &#125; else &#123;<br>        gotoGuard(routeName)<br>      &#125;<br>    &#125;,<br>    gotoHome (tab) &#123;<br>      this.setTab(tab)<br>      uni.switchTab(&#123;<br>        url: &#x27;/pages/home/home&#x27;<br>      &#125;)<br>    &#125;,<br>    navTo () &#123;<br>      if (!this.isLogin) &#123;<br>        uni.navigateTo(&#123;<br>          url: &#x27;/subcom-pkg/auth/auth&#x27;<br>        &#125;)<br>      &#125;<br>    &#125;,<br>    async getUserInfo () &#123;<br>      const &#123; _id: uid &#125; = this.userInfo<br>      const &#123; code, data &#125; = await this.$u.api.getBasic(&#123; uid &#125;)<br>      if (code === 200) &#123;<br>        this.setUserInfo(data)<br>      &#125;<br>    &#125;,<br>    async getUserCount () &#123;<br>      const &#123; _id: uid &#125; = this.userInfo<br>      if (!uid) return<br>      await this.getUserInfo()<br>      const &#123; data, code &#125; = await this.$u.api.wxUserCount(&#123; uid, reqAll: 1 &#125;)<br>      if (code === 200) &#123;<br>        const &#123; countMyPost, countMyCollect, countMyHistory &#125; = data<br>        this.countMyPost = countMyPost<br>        this.countMyCollect = countMyCollect<br>        this.countMyHistory = countMyHistory<br>      &#125;<br>    &#125;<br>  &#125;<br><br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot;&gt;<br>.grey &#123;<br>  position: fixed;<br>  width: 100%;<br>  height: 100%;<br>  left: 0;<br>  top: 0;<br>  z-index: 30;<br>&#125;<br>a &#123;<br>  color: #666;<br>  text-decoration: none;<br>&#125;<br>// .bg &#123;<br>//   height: 260rpx;<br>//   // 4个参数： 左上 右上 右下 左下<br>//   border-radius: 0 0 50% 50%;<br>//   background-color: #16d1a2;<br>//   position: relative;<br>//   z-index: 50;<br>// &#125;<br>.bg &#123;<br>  background-image: url(&quot;/static/images/my_bg.png&quot;);<br>  background-repeat: no-repeat;<br>  background-size: contain;<br>  position: relative;<br>  left: 0;<br>  top: 0;<br>  width: 100%;<br>  height: 280rpx;<br>  background-position: 0 0;<br>  z-index: 100;<br>&#125;<br>.wrapper &#123;<br>  width: 100%;<br>  height: 370rpx;<br>  padding: 25rpx;<br>  position: absolute;<br>  left: 0;<br>  top: 0;<br>  z-index: 100;<br>  box-sizing: border-box;<br>  color: #333;<br>  .profile &#123;<br>    background: #fff;<br>    border-radius: 12rpx;<br>    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);<br>    width: 100%;<br>    height: 100%;<br>    padding: 30rpx;<br>    box-sizing: border-box;<br>    .name &#123;<br>      font-size: 36rpx;<br>      font-weight: 700;<br>      margin-bottom: 10rpx;<br>      margin-top: 0;<br>      width: 370rpx;<br>      overflow: hidden;<br>      text-overflow: ellipsis;<br>      white-space: nowrap;<br>    &#125;<br>    .link &#123;<br>      font-size: 24rpx;<br>      color: #999;<br>    &#125;<br>    .fav &#123;<br>      display: inline-block;<br>      padding: 8px 12rpx;<br>      background: rgba(2, 209, 153, 0.16);<br>      border-radius: 12rpx;<br>      color: #02d199;<br>      margin: 0;<br>      font-size: 22rpx;<br>      .icon-fav &#123;<br>        padding-right: 10rpx;<br>      &#125;<br>    &#125;<br>    .info,<br>    .stats &#123;<br>      display: flex;<br>      flex-flow: row nowrap;<br>      justify-content: space-between;<br>      align-items: center;<br>    &#125;<br>    .info &#123;<br>      margin-bottom: 24rpx;<br>    &#125;<br>    .stats &#123;<br>      justify-content: space-around;<br>    &#125;<br>    .user &#123;<br>      flex: 1;<br>      padding-left: 20rpx;<br>    &#125;<br>    .pic &#123;<br>      width: 120rpx;<br>      height: 120rpx;<br>      border-radius: 50%;<br>    &#125;<br>    .item &#123;<br>      text-align: center;<br>      position: relative;<br>      p &#123;<br>        margin-top: 14rpx;<br>        margin-bottom: 0;<br>      &#125;<br>      &amp;:after &#123;<br>        width: 2rpx;<br>        height: 80rpx;<br>        background: #ddd;<br>        content: &quot;&quot;;<br>        position: absolute;<br>        right: -60rpx;<br>        top: 20rpx;<br>      &#125;<br>      &amp;:last-child &#123;<br>        &amp;:after &#123;<br>          width: 0;<br>        &#125;<br>      &#125;<br>      .title &#123;<br>        color: #666;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>.center-wraper &#123;<br>  background: #f6f5f8;<br>  position: relative;<br>  width: 100%;<br>  // height: 100%;<br>  z-index: 10;<br>  .center-list &#123;<br>    background: #fff;<br>    margin-bottom: 30rpx;<br>    display: flex;<br>    flex-flow: wrap;<br>    padding-top: 40rpx;<br>    &amp;.first &#123;<br>      padding-top: 100rpx;<br>    &#125;<br>    li &#123;<br>      width: 25%;<br>      text-align: center;<br>      color: #666;<br>      margin-bottom: 40rpx;<br>      font-size: 26rpx;<br>    &#125;<br>    i &#123;<br>      display: block;<br>      margin: 0 auto;<br>      font-size: 40rpx;<br>      width: 56rpx;<br>      height: 56rpx;<br>      margin-bottom: 20rpx;<br>      color: #888;<br>      background-size: contain;<br>    &#125;<br>    .icon-teizi &#123;<br>      background-image: url(&quot;/static/images/teizi@2x.png&quot;);<br>    &#125;<br>    .icon-setting &#123;<br>      background-image: url(&quot;/static/images/setting@2x.png&quot;);<br>    &#125;<br>    .icon-lock2 &#123;<br>      background-image: url(&quot;/static/images/lock2@2x.png&quot;);<br>    &#125;<br>    .icon-support &#123;<br>      background-image: url(&quot;/static/images/support.png&quot;);<br>    &#125;<br>    .icon-qiandao &#123;<br>      background-image: url(&quot;/static/images/sign1.png&quot;);<br>    &#125;<br>    .icon-book &#123;<br>      background-image: url(&quot;/static/images/books.png&quot;);<br>    &#125;<br>    .icon-record &#123;<br>      background-image: url(&quot;/static/images/record@2x.png&quot;);<br>    &#125;<br>    .icon-about &#123;<br>      background-image: url(&quot;/static/images/about.png&quot;);<br>    &#125;<br>    // 快捷访问<br>    .icon-question &#123;<br>      background-image: url(&quot;/static/images/question@2x.png&quot;);<br>    &#125;<br>    .icon-share &#123;<br>      background-image: url(&quot;/static/images/share@2x.png&quot;);<br>    &#125;<br>    .icon-taolun &#123;<br>      background-image: url(&quot;/static/images/taolun@2x.png&quot;);<br>    &#125;<br>    .icon-advise &#123;<br>      background-image: url(&quot;/static/images/advice@2x.png&quot;);<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>最终效果：</p>
<p><img src="uniapp.assets/image-20210801235142625.48262a26.png" alt="image-20210801235142625"></p>
<h1 id="RefreshToken机制"><a href="#RefreshToken机制" class="headerlink" title="#RefreshToken机制"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#refreshtoken机制">#</a>RefreshToken机制</h1><h2 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="#需求分析"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#需求分析">#</a>需求分析</h2><p>用户token不能设置太长的有效时间，这样可以提高接口部分的安全性。</p>
<p><img src="uniapp.assets/refreshToken.02c26e12.gif" alt="refreshToken"></p>
<p>说明：</p>
<ul>
<li>登录请求/login成功之后会响应token&amp;refreshToken；</li>
<li>token的过期时间比较短，比如1小时到4小时，refreshToken的过期时间比token要长，比如1天或者7天；</li>
<li>用户在登录之后，所有的鉴权的接口带上token；</li>
<li>如果token过期，则使用refreshToken进行请求/login/refresh接口，请求新的token；</li>
<li>如果refreshToken未过期，则返回新token；</li>
<li>如果refreshToken过期，则返回401;</li>
</ul>
<h2 id="创建refreshToken接口"><a href="#创建refreshToken接口" class="headerlink" title="#创建refreshToken接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#创建refreshtoken接口">#</a>创建refreshToken接口</h2><p>添加<code>src/routes/modules/loginRouter.js</code>路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// refresh</span><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/refresh&#x27;</span>, loginController.<span class="hljs-property">refresh</span>)<br></code></pre></td></tr></table></figure>
<p>调整登录接口<code>src/api/LoginController.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 微信登录</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">wxLogin</span> (ctx) &#123;<br><span class="hljs-comment">// 1.解密用户信息</span><br>  <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>  <span class="hljs-keyword">const</span> &#123; user, code &#125; = body<br>  <span class="hljs-keyword">if</span> (!code) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;没有足够参数&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetUserInfo</span>(user, code)<br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">errcode</span> === <span class="hljs-number">0</span>) &#123;<br>  <span class="hljs-comment">// 2.查询数据库 -&gt; 判断用户是否存在</span><br>  <span class="hljs-comment">// 3.如果不存在 —&gt; 创建用户</span><br>  <span class="hljs-comment">// 4.如果存在 -&gt; 获取用户信息</span><br>    <span class="hljs-keyword">const</span> tmpUser = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findOrCreateByUnionid</span>(res)<br>    <span class="hljs-comment">// 5.产生token，获取用户的签到状态</span><br>    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">generateToken</span>(&#123; <span class="hljs-attr">_id</span>: tmpUser.<span class="hljs-property">_id</span> &#125;)<br>    <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> <span class="hljs-title function_">addSign</span>(tmpUser)<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>      <span class="hljs-attr">data</span>: userInfo,<br>      token,<br>      <span class="hljs-comment">// 新增refreshToken</span><br>      <span class="hljs-attr">refreshToken</span>: <span class="hljs-title function_">generateToken</span>(&#123; <span class="hljs-attr">_id</span>: tmpUser.<span class="hljs-property">_id</span> &#125;, <span class="hljs-string">&#x27;7d&#x27;</span>)<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    ctx.<span class="hljs-keyword">throw</span>(<span class="hljs-number">501</span>, res.<span class="hljs-property">errcode</span> === <span class="hljs-number">40163</span> ? <span class="hljs-string">&#x27;code已失效，请刷新后重试&#x27;</span> : <span class="hljs-string">&#x27;获取用户信息失败，请重试&#x27;</span>)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// refreshToken</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">refresh</span> (ctx) &#123;<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">token</span>: <span class="hljs-title function_">generateToken</span>(&#123; <span class="hljs-attr">_id</span>: ctx.<span class="hljs-property">_id</span> &#125;, <span class="hljs-string">&#x27;60m&#x27;</span>),<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;获取token成功&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="前端页面逻辑"><a href="#前端页面逻辑" class="headerlink" title="#前端页面逻辑"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#前端页面逻辑">#</a>前端页面逻辑</h2><ul>
<li>错误拦截中，针对 401的情况进行单独处理；<ul>
<li>返回401之后，使用新的request实例请求refreshToken的接口；</li>
<li>请求成功之后，更新本地的token及缓存；</li>
</ul>
</li>
<li>使用新的Token重新发发起旧的请求；</li>
</ul>
<h3 id="登录失败后处理缓存"><a href="#登录失败后处理缓存" class="headerlink" title="#登录失败后处理缓存"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#登录失败后处理缓存">#</a>登录失败后处理缓存</h3><p>在<code>src/store/index.js</code>中新增关于清除token及用户信息的<code>actions</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> actions = &#123;<br>  <span class="hljs-title function_">logout</span> (&#123; commit &#125;) &#123;<br>    <span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;setToken&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;setUserInfo&#x27;</span>, &#123;&#125;)<br>    <span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;setRefreshToken&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    uni.<span class="hljs-title function_">clearStorage</span>()<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终测试与效果：</p>
<p><img src="uniapp.assets/image-20210802192754262.f2e58c05.png" alt="image-20210802192754262"></p>
<h3 id="封装Simple-js"><a href="#封装Simple-js" class="headerlink" title="#封装Simple.js"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#封装simple-js">#</a>封装Simple.js</h3><p>simple.js封装新的request补全，用于在默认实例请求401的情况下，发送refreshToken的请求：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">simpleHttp</span> = (<span class="hljs-params">options, &#123; header = &#123;&#125;, callback &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    uni.<span class="hljs-title function_">request</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;<br>      <span class="hljs-attr">timeout</span>: <span class="hljs-number">10</span> * <span class="hljs-number">1000</span><br>    &#125;, options, &#123;<br>      header,<br>      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">// 请求成功</span><br>        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; res.<span class="hljs-property">statusCode</span> &lt; <span class="hljs-number">300</span>) &#123;<br>          <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">data</span>)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-title function_">reject</span>(res)<br>        &#125;<br>      &#125;,<br>      <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">reject</span>(err)<br>      &#125;,<br>      <span class="hljs-attr">complete</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>        callback &amp;&amp; <span class="hljs-title function_">callback</span>()<br>      &#125;<br>    &#125;))<br>  &#125;)<br>  <span class="hljs-keyword">return</span> result<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="调整errorHandle-401逻辑"><a href="#调整errorHandle-401逻辑" class="headerlink" title="#调整errorHandle 401逻辑"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#调整errorhandle-401逻辑">#</a>调整errorHandle 401逻辑</h3><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; simpleHttp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./request/simple&#x27;</span><br><br><span class="hljs-comment">// 调整errorHandle处理流程：</span><br><span class="hljs-attr">errorHandle</span>: <span class="hljs-title function_">async</span> (err, &#123; options, instance &#125;) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (err.<span class="hljs-property">statusCode</span> === <span class="hljs-number">401</span>) &#123;<br>    <span class="hljs-comment">// 4.业务 —&gt; refreshToken -&gt; 请求响应401 -&gt; 刷新token</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> &#123; code, token &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">simpleHttp</span>(&#123;<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        <span class="hljs-attr">url</span>: baseUrl + <span class="hljs-string">&#x27;/login/refresh&#x27;</span><br>      &#125;, &#123;<br>        <span class="hljs-attr">header</span>: &#123;<br>          <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">&#x27;Bearer &#x27;</span> + uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&#x27;refreshToken&#x27;</span>)<br>        &#125;<br>      &#125;)<br>      <span class="hljs-keyword">if</span> (code === <span class="hljs-number">200</span>) &#123;<br>        <span class="hljs-comment">// refreshToken请求成功</span><br>        <span class="hljs-comment">// 1.设置全局的token</span><br>        store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;setToken&#x27;</span>, token)<br>        <span class="hljs-comment">// 2.重新发起请求</span><br>        <span class="hljs-keyword">const</span> newResult = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">request</span>(options)<br>        <span class="hljs-keyword">return</span> newResult<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-comment">// 代表refreshToken已经失效</span><br>      <span class="hljs-comment">// 清除本地的token</span><br>      store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">&#x27;logout&#x27;</span>)<br>      <span class="hljs-comment">// 导航到用户的登录页面</span><br>      <span class="hljs-title function_">authNav</span>()<br>    &#125;<br>    uni.<span class="hljs-title function_">showToast</span>(&#123;<br>      <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;鉴权失败，请重新登录&#x27;</span>,<br>      <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>    &#125;)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// 其他的错误</span><br>    <span class="hljs-comment">// showToast提示用户</span><br>    <span class="hljs-comment">// 3.对错误进行统一的处理 -&gt; showToast</span><br>    <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: &#123; msg &#125; &#125; = err<br>    uni.<span class="hljs-title function_">showToast</span>(&#123;<br>      <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>      <span class="hljs-attr">title</span>: msg || <span class="hljs-string">&#x27;请求异常，请重试&#x27;</span>,<br>      <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>    &#125;)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="请求拦截器"><a href="#请求拦截器" class="headerlink" title="#请求拦截器"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#请求拦截器">#</a>请求拦截器</h3><p>要注意请求拦截器中token的设置方式，可以使用<code>config.header.Authorization = &#39;Bearer &#39; + token</code>进行赋值：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 请求拦截，配置Token等参数</span><br><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$u</span>.<span class="hljs-property">http</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">request</span> = <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 引用token</span><br>  <span class="hljs-comment">// 1.在头部请求的时候，token带上 -&gt; 请求拦截器</span><br>  <span class="hljs-keyword">const</span> publicArr = [<span class="hljs-regexp">/\/public/</span>, <span class="hljs-regexp">/\/login/</span>]<br>  <span class="hljs-comment">// local store -&gt; uni.getStorageSync(&#x27;token&#x27;)</span><br>  <span class="hljs-keyword">let</span> isPublic = <span class="hljs-literal">false</span><br>  publicArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> &#123;<br>    isPublic = isPublic || path.<span class="hljs-title function_">test</span>(config.<span class="hljs-property">url</span>)<br>  &#125;)<br>  <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">&#x27;token&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (!isPublic &amp;&amp; token) &#123;<br>    config.<span class="hljs-property">header</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">&#x27;Bearer &#x27;</span> + token<br>  &#125;<br>  <span class="hljs-comment">// 最后需要将config进行return</span><br>  <span class="hljs-keyword">return</span> config<br>  <span class="hljs-comment">// 如果return一个false值，则会取消本次请求</span><br>  <span class="hljs-comment">// if(config.url === &#x27;/user/rest&#x27;) return false; // 取消某次请求</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="调整工具类request-js"><a href="#调整工具类request-js" class="headerlink" title="#调整工具类request.js"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshToken机制.html#调整工具类request-js">#</a>调整工具类request.js</h3><p>原先Request.js封装中，errorhandle的部分只会返回错误的内容。</p>
<p>而我们在errorHandle中需要发送旧的请求，即需要：</p>
<ul>
<li>原请求的相关配置<code>config</code>，如url、method等；</li>
<li>原请求的实例，上面有请求拦截器，使用token数据发送请求；</li>
</ul>
<p>思路使用callback回调的方式，把参数传递出来：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> errCallback = &#123; options, <span class="hljs-attr">instance</span>: <span class="hljs-variable language_">this</span> &#125;<br><br><span class="hljs-comment">// ...</span><br><span class="hljs-title function_">errorHandle</span>(response, errCallback)<br></code></pre></td></tr></table></figure>
<p>完整的代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> deepMerge <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../function/deepMerge&#x27;</span><br><span class="hljs-comment">// import validate from &#x27;../function/test&#x27;</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Request</span> &#123;<br>  <span class="hljs-comment">// 设置全局默认配置</span><br>  <span class="hljs-title function_">setConfig</span> (customConfig) &#123;<br>    <span class="hljs-comment">// 深度合并对象，否则会造成对象深层属性丢失</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = <span class="hljs-title function_">deepMerge</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>, customConfig)<br>  &#125;<br><br>  <span class="hljs-comment">// 主要请求部分</span><br>  <span class="hljs-title function_">request</span> (options = &#123;&#125;) &#123;<br>    <span class="hljs-comment">// 检查请求拦截</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">request</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">request</span> === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      <span class="hljs-keyword">const</span> interceptorRequest = <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-title function_">request</span>(options)<br>      <span class="hljs-keyword">if</span> (interceptorRequest === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-comment">// 返回一个处于pending状态中的Promise，来取消原promise，避免进入then()回调</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">() =&gt;</span> &#123; &#125;)<br>      &#125;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = interceptorRequest<br>    &#125;<br>    options.<span class="hljs-property">dataType</span> = options.<span class="hljs-property">dataType</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">dataType</span><br>    options.<span class="hljs-property">responseType</span> = options.<span class="hljs-property">responseType</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">responseType</span><br>    options.<span class="hljs-property">url</span> = options.<span class="hljs-property">url</span> || <span class="hljs-string">&#x27;&#x27;</span><br>    options.<span class="hljs-property">params</span> = options.<span class="hljs-property">params</span> || &#123;&#125;<br>    options.<span class="hljs-property">header</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">header</span>, options.<span class="hljs-property">header</span>)<br>    options.<span class="hljs-property">method</span> = options.<span class="hljs-property">method</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">method</span><br>    <span class="hljs-keyword">const</span> errCallback = &#123; options, <span class="hljs-attr">instance</span>: <span class="hljs-variable language_">this</span> &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>      options.<span class="hljs-property">complete</span> = <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> &#123; errorHandle &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span><br>        <span class="hljs-comment">// 请求返回后，隐藏loading(如果请求返回快的话，可能会没有loading)</span><br>        uni.<span class="hljs-title function_">hideLoading</span>()<br>        <span class="hljs-comment">// 清除定时器，如果请求回来了，就无需loading</span><br>        <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timer</span>)<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timer</span> = <span class="hljs-literal">null</span><br>        <span class="hljs-comment">// 判断用户对拦截返回数据的要求，如果originalData为true，返回所有的数据(response)到拦截器，否则只返回response.data</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">originalData</span>) &#123;<br>          <span class="hljs-comment">// 判断是否存在拦截器</span><br>          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">response</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">response</span> === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>            <span class="hljs-keyword">const</span> resInterceptors = <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-title function_">response</span>(response)<br>            <span class="hljs-comment">// 如果拦截器不返回false，就将拦截器返回的内容给this.$u.post的then回调</span><br>            <span class="hljs-keyword">if</span> (resInterceptors !== <span class="hljs-literal">false</span>) &#123;<br>              <span class="hljs-title function_">resolve</span>(resInterceptors)<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-comment">// 如果拦截器返回false，意味着拦截器定义者认为返回有问题，直接接入catch回调</span><br>              <span class="hljs-title function_">errorHandle</span>(response, errCallback)<br>              <span class="hljs-title function_">reject</span>(response)<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果要求返回原始数据，就算没有拦截器，也返回最原始的数据</span><br>            <span class="hljs-title function_">resolve</span>(response)<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">if</span> (response.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">response</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-property">response</span> === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>              <span class="hljs-keyword">const</span> resInterceptors = <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span>.<span class="hljs-title function_">response</span>(response.<span class="hljs-property">data</span>)<br>              <span class="hljs-keyword">if</span> (resInterceptors !== <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-title function_">resolve</span>(resInterceptors)<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-title function_">errorHandle</span>(response, errCallback)<br>                <span class="hljs-title function_">reject</span>(response.<span class="hljs-property">data</span>)<br>              &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-comment">// 如果不是返回原始数据(originalData=false)，且没有拦截器的情况下，返回纯数据给then回调</span><br>              <span class="hljs-title function_">resolve</span>(response.<span class="hljs-property">data</span>)<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 不返回原始数据的情况下，服务器状态码不为200，modal弹框提示</span><br>            <span class="hljs-comment">// if(response.errMsg) &#123;</span><br>            <span class="hljs-comment">//  uni.showModal(&#123;</span><br>            <span class="hljs-comment">//   title: response.errMsg</span><br>            <span class="hljs-comment">//  &#125;);</span><br>            <span class="hljs-comment">// &#125;</span><br>            <span class="hljs-title function_">errorHandle</span>(response, errCallback)<br>            <span class="hljs-title function_">reject</span>(response)<br>          &#125;<br>        &#125;<br>      &#125;<br><br>      <span class="hljs-comment">// 判断用户传递的URL是否/开头,如果不是,加上/，这里使用了uView的test.js验证库的url()方法</span><br>      <span class="hljs-comment">// 情景一：如果是使用的官方的uview组件库 -&gt; 创建新的reg -&gt; url</span><br>      <span class="hljs-comment">// 情况二：如果是自己定义的request工具js -&gt; 替换正则</span><br>      options.<span class="hljs-property">url</span> = <span class="hljs-regexp">/^https?:\/\/.*/</span>.<span class="hljs-title function_">test</span>(options.<span class="hljs-property">url</span>)<br>        ? options.<span class="hljs-property">url</span><br>        : (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">baseUrl</span> + (options.<span class="hljs-property">url</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;/&#x27;</span>) === <span class="hljs-number">0</span><br>            ? options.<span class="hljs-property">url</span><br>            : <span class="hljs-string">&#x27;/&#x27;</span> + options.<span class="hljs-property">url</span>))<br>      <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: index.js ~ line 82 ~ Request ~ returnnewPromise ~ options.url&#x27;, options.url, /^https?:\/\/.*/.test(options.url))</span><br><br>      <span class="hljs-comment">// 是否显示loading</span><br>      <span class="hljs-comment">// 加一个是否已有timer定时器的判断，否则有两个同时请求的时候，后者会清除前者的定时器id</span><br>      <span class="hljs-comment">// 而没有清除前者的定时器，导致前者超时，一直显示loading</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">showLoading</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timer</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>          uni.<span class="hljs-title function_">showLoading</span>(&#123;<br>            <span class="hljs-attr">title</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">loadingText</span>,<br>            <span class="hljs-attr">mask</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">loadingMask</span><br>          &#125;)<br>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">timer</span> = <span class="hljs-literal">null</span><br>        &#125;, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">loadingTime</span>)<br>      &#125;<br>      uni.<span class="hljs-title function_">request</span>(options)<br>    &#125;)<br>    <span class="hljs-comment">// .catch(res =&gt; &#123;</span><br>    <span class="hljs-comment">//  // 如果返回reject()，不让其进入this.$u.post().then().catch()后面的catct()</span><br>    <span class="hljs-comment">//  // 因为很多人都会忘了写后面的catch()，导致报错捕获不到catch</span><br>    <span class="hljs-comment">//  return new Promise(()=&gt;&#123;&#125;);</span><br>    <span class="hljs-comment">// &#125;)</span><br>  &#125;<br><br>  <span class="hljs-title function_">constructor</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = &#123;<br>      <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// 请求的根域名</span><br>      <span class="hljs-comment">// 默认的请求头</span><br>      <span class="hljs-attr">header</span>: &#123;&#125;,<br>      <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>      <span class="hljs-comment">// 设置为json，返回后uni.request会对数据进行一次JSON.parse</span><br>      <span class="hljs-attr">dataType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,<br>      <span class="hljs-comment">// 此参数无需处理，因为5+和支付宝小程序不支持，默认为text即可</span><br>      <span class="hljs-attr">responseType</span>: <span class="hljs-string">&#x27;text&#x27;</span>,<br>      <span class="hljs-attr">showLoading</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否显示请求中的loading</span><br>      <span class="hljs-attr">loadingText</span>: <span class="hljs-string">&#x27;请求中...&#x27;</span>,<br>      <span class="hljs-attr">loadingTime</span>: <span class="hljs-number">800</span>, <span class="hljs-comment">// 在此时间内，请求还没回来的话，就显示加载中动画，单位ms</span><br>      <span class="hljs-attr">timer</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 定时器</span><br>      <span class="hljs-attr">originalData</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否在拦截器中返回服务端的原始数据，见文档说明</span><br>      <span class="hljs-attr">loadingMask</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 展示loading的时候，是否给一个透明的蒙层，防止触摸穿透</span><br>    &#125;<br><br>    <span class="hljs-comment">// 拦截器</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptor</span> = &#123;<br>      <span class="hljs-comment">// 请求前的拦截</span><br>      <span class="hljs-attr">request</span>: <span class="hljs-literal">null</span>,<br>      <span class="hljs-comment">// 请求后的拦截</span><br>      <span class="hljs-attr">response</span>: <span class="hljs-literal">null</span><br>    &#125;<br><br>    <span class="hljs-comment">// get请求</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">get</span> = <span class="hljs-function">(<span class="hljs-params">url, data = &#123;&#125;, header = &#123;&#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(&#123;<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;GET&#x27;</span>,<br>        url,<br>        header,<br>        data<br>      &#125;)<br>    &#125;<br><br>    <span class="hljs-comment">// post请求</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">post</span> = <span class="hljs-function">(<span class="hljs-params">url, data = &#123;&#125;, header = &#123;&#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(&#123;<br>        url,<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>        header,<br>        data<br>      &#125;)<br>    &#125;<br><br>    <span class="hljs-comment">// put请求，不支持支付宝小程序(HX2.6.15)</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">put</span> = <span class="hljs-function">(<span class="hljs-params">url, data = &#123;&#125;, header = &#123;&#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(&#123;<br>        url,<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;PUT&#x27;</span>,<br>        header,<br>        data<br>      &#125;)<br>    &#125;<br><br>    <span class="hljs-comment">// delete请求，不支持支付宝和头条小程序(HX2.6.15)</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">delete</span> = <span class="hljs-function">(<span class="hljs-params">url, data = &#123;&#125;, header = &#123;&#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(&#123;<br>        url,<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;DELETE&#x27;</span>,<br>        header,<br>        data<br>      &#125;)<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>()<br></code></pre></td></tr></table></figure>
<h1 id="文章详情"><a href="#文章详情" class="headerlink" title="#文章详情"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/06-文章详情.html#文章详情">#</a>文章详情</h1><p>完成效果：</p>
<p><img src="uniapp.assets/image-20210527020457329.01b5962e.png" alt="image-20210527020457329"></p>
<h2 id="页面布局与样式"><a href="#页面布局与样式" class="headerlink" title="#页面布局与样式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/06-文章详情.html#页面布局与样式">#</a>页面布局与样式</h2><p>基本的步骤</p>
<ul>
<li><p>新增页面<code>/subcom-pkg/detail/detail</code></p>
</li>
<li><p>配置<code>pages.json</code></p>
</li>
<li>调整页面的样式与接口</li>
</ul>
<p>配置<code>pages.json</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;subPackages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;root&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;subcom-pkg&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      ...<br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;detail/detail&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;style&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;navigationBarTitleText&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;文章详情&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>
<p>页面样式与基础逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;detail&quot; v-show=&quot;page._id&quot; @click.stop=&quot;showReply = false&quot;&gt;<br>    &lt;view class=&quot;header title&quot;&gt;<br>      &#123;&#123;page.title&#125;&#125;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;content&quot;&gt;<br>      &lt;view class=&quot;user u-flex&quot;&gt;<br>        &lt;u-image class=&quot;photo&quot; :src=&quot;page.uid.pic&quot; error-icon=&quot;/static/images/header.jpg&quot; width=&quot;72&quot; height=&quot;72&quot; /&gt;<br>        &lt;view class=&quot;user-column u-flex-1&quot;&gt;<br>          &lt;span class=&quot;name&quot;&gt;&#123;&#123;page.uid.name&#125;&#125;&lt;/span&gt;<br>          &lt;span class=&quot;label&quot;&gt;&#123;&#123; page.created | moment &#125;&#125;&lt;/span&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>      &lt;u-parse :html=&quot;page.content&quot;&gt;<br>        &lt;view class=&quot;title&quot;&gt;&lt;/view&gt;<br>      &lt;/u-parse&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;comments&quot; :style=&quot;&#123;&#x27;padding-bottom&#x27;: paddingHeight + &#x27;px&#x27;&#125;&quot;&gt;<br>      &lt;view class=&quot;title&quot;&gt;评论&lt;/view&gt;<br>      &lt;view class=&quot;item&quot; v-for=&quot;(item) in comments&quot; :key=&quot;item._id&quot;&gt;<br>        &lt;view class=&quot;u-flex u-col-center&quot;&gt;<br>          &lt;view class=&quot;user u-flex-1&quot;&gt;<br>            &lt;u-image class=&quot;photo&quot; :src=&quot;item.cuid.pic&quot; error-icon=&quot;/static/images/header.jpg&quot; width=&quot;72&quot; height=&quot;72&quot; /&gt;<br>            &lt;view class=&quot;user-column u-flex-1&quot;&gt;<br>              &lt;span class=&quot;name&quot;&gt;&#123;&#123; item.cuid.name &#125;&#125;&lt;/span&gt;<br>              &lt;span class=&quot;label&quot;&gt;&#123;&#123; item.created | moment &#125;&#125; 回复了你&lt;/span&gt;<br>            &lt;/view&gt;<br>          &lt;/view&gt;<br>          &lt;view class=&quot;u-flex u-col-center add-hand&quot;&gt;<br>            &lt;view class=&quot;reply&quot; :class=&quot;&#123;&#x27;active&#x27;: item.handed === &#x27;1&#x27;&#125;&quot; @click=&quot;hand(item)&quot;&gt;<br>              &lt;u-icon name=&quot;thumb-up-fill&quot; size=&quot;30&quot; v-if=&quot;item.handed === &#x27;1&#x27;&quot;&gt;&lt;/u-icon&gt;<br>              &lt;u-icon name=&quot;thumb-up&quot; size=&quot;30&quot; v-else&gt;&lt;/u-icon&gt;<br>              &lt;text&gt;&#123;&#123;item.hands&#125;&#125;&lt;/text&gt;<br>            &lt;/view&gt;<br>            &lt;view v-if=&quot;isOwner&quot;&gt;<br>              &lt;view class=&quot;caina&quot; v-if=&quot;item.isBest === &#x27;1&#x27;&quot;&gt;<br>                &lt;u-icon name=&quot;yicaina&quot; custom-prefix=&quot;iconfont&quot; size=&quot;70&quot; color=&quot;#58a571&quot;&gt;&lt;/u-icon&gt;<br>              &lt;/view&gt;<br>              &lt;view class=&quot;setBest&quot; v-else-if=&quot;parseInt(page.isEnd) === 0 &amp;&amp; parseInt(item.isBest) === 0&quot; @click=&quot;setBest(item)&quot;&gt;<br>                &lt;u-icon name=&quot;caina&quot; custom-prefix=&quot;iconfont&quot; size=&quot;32&quot;&gt;&lt;/u-icon&gt;<br>              &lt;/view&gt;<br>            &lt;/view&gt;<br>          &lt;/view&gt;<br>        &lt;/view&gt;<br>        &lt;view class=&quot;comments-content&quot;&gt;&#123;&#123;item.content&#125;&#125;&lt;/view&gt;<br>      &lt;/view&gt;<br>      &lt;view v-if=&quot;comments.length === 0&quot;&gt;<br>        &lt;view v-if=&quot;!loading&quot; class=&quot;info&quot;&gt;<br>          暂无评论，赶紧来抢沙发吧~~~<br>        &lt;/view&gt;<br>        &lt;view class=&quot;flex-center-center loading&quot; v-else&gt;<br>          &lt;u-loading class=&quot;loading-icon&quot; mode=&quot;circle&quot;&gt;&lt;/u-loading&gt;<br>          &lt;text class=&quot;loading-text&quot;&gt;加载中...&lt;/text&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>    &lt;view class=&quot;footer&quot;&gt;<br>      &lt;view class=&quot;box u-flex u-col-center&quot; v-if=&quot;!showReply&quot;&gt;<br>        &lt;view class=&quot;add-comment&quot; @click.stop=&quot;reply()&quot;&gt;<br>          &lt;u-icon name=&quot;edit-pen&quot; size=&quot;32&quot; color=&quot;#cccccc&quot;&gt;&lt;/u-icon&gt;<br>          &lt;text class=&quot;text&quot;&gt;写评论&lt;/text&gt;<br>        &lt;/view&gt;<br>        &lt;view class=&quot;ctrls u-flex u-col-center u-row-between&quot;&gt;<br>          &lt;view class=&quot;comment u-flex flex-column&quot;&gt;<br>            &lt;u-icon name=&quot;chat&quot; size=&quot;45&quot;&gt;&lt;/u-icon&gt;<br>            &lt;text&gt;评论&#123;&#123; page.answer &gt; 0 ? page.answer : &#x27;&#x27;&#125;&#125;&lt;/text&gt;<br>          &lt;/view&gt;<br>          &lt;view class=&quot;fav u-flex flex-column&quot; :class=&quot;&#123;&#x27;active&#x27;: page.isFav === 1&#125;&quot; @click=&quot;setCollect&quot;&gt;<br>            &lt;u-icon name=&quot;star-fill&quot; size=&quot;45&quot; v-if=&quot;page.isFav === 1&quot;&gt;&lt;/u-icon&gt;<br>            &lt;u-icon name=&quot;star&quot; size=&quot;45&quot; v-else&gt;&lt;/u-icon&gt;<br>            &lt;text&gt;&#123;&#123;page.isFav === 1 ? &#x27;已收藏&#x27;: &#x27;收藏&#x27;&#125;&#125;&lt;/text&gt;<br>          &lt;/view&gt;<br>          &lt;view class=&quot;like u-flex flex-column&quot; :class=&quot;&#123;&#x27;active&#x27;: page.isHand === 1&#125;&quot; @click=&quot;handsPost&quot;&gt;<br>            &lt;u-icon name=&quot;thumb-up-fill&quot; size=&quot;45&quot; v-if=&quot;page.isHand === 1&quot;&gt;&lt;/u-icon&gt;<br>            &lt;u-icon name=&quot;thumb-up&quot; size=&quot;45&quot; v-else&gt;&lt;/u-icon&gt;<br>            &lt;text&gt;&#123;&#123;page.isHand === 1 ? &#x27;已点赞&#x27; : &#x27;点赞&#x27;&#125;&#125;&lt;/text&gt;<br>          &lt;/view&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>      &lt;view class=&quot;box u-flex u-col-center&quot; v-else&gt;<br>        &lt;u-input v-model=&quot;content&quot; class=&quot;reply&quot; placeholder=&quot;请输入评论内容&quot; focus @clear=&quot;clear&quot;&gt;&lt;/u-input&gt;<br>        &lt;button type=&quot;primary&quot; plain size=&quot;mini&quot; @click.stop=&quot;send&quot;&gt;发送&lt;/button&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; mapGetters, mapState &#125; from &#x27;vuex&#x27;<br>import &#123; checkToken &#125; from &#x27;@/common/checkAuth&#x27;<br><br>export default &#123;<br>  components: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    page: &#123;&#125;,<br>    comments: [],<br>    params: &#123;<br>      page: 0,<br>      limit: 10,<br>      tid: &#x27;&#x27;<br>    &#125;,<br>    content: &#x27;&#x27;,<br>    showReply: false,<br>    height: 0,<br>    paddingHeight: 60,<br>    loading: false<br>  &#125;),<br>  computed: &#123;<br>    ...mapState([&#x27;userInfo&#x27;]),<br>    ...mapGetters([&#x27;isLogin&#x27;]),<br>    isCollect () &#123;<br>      return typeof this.page.isFav !== &#x27;undefined&#x27; &amp;&amp; this.page.isFav === 1<br>    &#125;,<br>    isOwner () &#123;<br>      let flag = false<br>      if (this.page.uid &amp;&amp; typeof this.page.uid !== &#x27;undefined&#x27; &amp;&amp; typeof this.userInfo._id !== &#x27;undefined&#x27;) &#123;<br>        flag = this.page.uid._id === this.userInfo._id<br>      &#125;<br>      return flag<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    check: checkToken,<br>    async getReply () &#123;<br>      const &#123; data &#125; = await this.$u.api.getComents(this.params)<br>      const arr = data.reverse()<br>      if (this.params.page === 0) &#123;<br>        this.comments = arr<br>      &#125; else &#123;<br>        this.comments = [...this.comments, ...arr]<br>      &#125;<br>      this.page.answer = this.comments.length || 0<br>    &#125;,<br>    async handsPost () &#123;<br>      // 文章点赞<br>    &#125;,<br>    async hand (item) &#123;<br>      // 评论点赞<br>      if (!this.check()) return<br>      const &#123; msg, data, code &#125; = await this.$u.api.setHands(&#123; cid: item._id &#125;)<br>      if (code === 200 &amp;&amp; data) &#123;<br>        item.handed = &#x27;1&#x27;<br>        item.hands++<br>      &#125; else &#123;<br>        uni.showToast(&#123;<br>          icon: &#x27;none&#x27;,<br>          title: msg,<br>          duration: 2000<br>        &#125;)<br>      &#125;<br>    &#125;,<br>    async setCollect () &#123;<br>      // 设置收藏<br>      if (!this.check()) return<br>      const &#123; msg, isCollect &#125; = await this.$u.api.addCollect(&#123; tid: this.params.tid, isFav: this.isCollect ? 1 : 0 &#125;)<br>      if (isCollect) &#123;<br>        this.page.isFav = 1<br>      &#125; else &#123;<br>        this.page.isFav = 0<br>      &#125;<br>      uni.showToast(&#123;<br>        icon: &#x27;none&#x27;,<br>        title: msg,<br>        duration: 2000<br>      &#125;)<br>    &#125;,<br>    reply () &#123;<br>      if (!this.check()) return<br>      this.showReply = true<br>    &#125;,<br>    async send () &#123;<br>      // 微信评论<br>    &#125;,<br>    setBest (item) &#123;<br>      // 设置最佳<br>    &#125;,<br>    onShareAppMessage () &#123;<br>      // 微信分享<br>    &#125;<br>  &#125;,<br>  watch: &#123;&#125;,<br>  // 页面周期函数--监听页面加载<br>  async onLoad (options) &#123;<br>    this.loading = true<br>    const &#123; tid &#125; = options<br>    this.params.tid = tid<br>    const &#123; data &#125; = await this.$u.api.getDetail(&#123; tid &#125;)<br>    this.page = data<br>    await this.getReply()<br>    this.loading = false<br>  &#125;,<br>  // 页面周期函数--监听页面初次渲染完成<br>  onPullDownRefresh () &#123;<br>    uni.stopPullDownRefresh()<br>  &#125;,<br>  // 页面处理函数--监听用户上拉触底<br>  onReachBottom () &#123;&#125;<br>  // 页面处理函数--监听页面滚动(not-nvue)<br>  /* onPageScroll(event) &#123;&#125;, */<br>  // 页面处理函数--用户点击右上角分享<br>  /* onShareAppMessage(options) &#123;&#125;, */<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot;&gt;<br>.detail &#123;<br>  background: #f4f6f8;<br>  min-height: 100vh;<br>&#125;<br><br>.header,<br>.content,<br>.comments &#123;<br>  background: #fff;<br>  padding: 32rpx;<br>&#125;<br><br>.header,<br>.content &#123;<br>  margin-bottom: 24rpx;<br>  box-shadow: 0 5rpx 5px rgba($color: black, $alpha: 0.1);<br>&#125;<br><br>.add-hand &#123;<br>  position: relative;<br>  .caina &#123;<br>    position: absolute;<br>    right: 100rpx;<br>    top: -20rpx;<br>  &#125;<br>  .setBest &#123;<br>    padding-left: 25rpx;<br>  &#125;<br>&#125;<br><br>.footer &#123;<br>  position: fixed;<br>  bottom: 0;<br>  left: 0;<br>  width: 100vw;<br>  padding: 20rpx 32rpx;<br>  background-color: #fff;<br>  // height: 100rpx;<br>  box-shadow: 0 -5rpx 5px rgba($color: black, $alpha: 0.1);<br>  .box &#123;<br>    width: 100%;<br>  &#125;<br>  .reply &#123;<br>    flex: 1;<br>    border: 1px solid #eee;<br>    padding: 0 15rpx;<br>    margin-right: 15rpx;<br>  &#125;<br>&#125;<br><br>.title &#123;<br>  font-size: 32rpx;<br>  color: #333;<br>  font-weight: bold;<br>&#125;<br><br>.user &#123;<br>  display: flex;<br>  align-items: center; /* 垂直居中 */<br>  margin-right: 20rpx;<br>  .name &#123;<br>    margin-bottom: 10rpx;<br>    font-size: 28rpx;<br>    font-family: PingFang SC;<br>    font-weight: bold;<br>    color: rgba(51, 51, 51, 1);<br>    white-space: nowrap;<br>    max-width: 420rpx;<br>    overflow: hidden;<br>    text-overflow: ellipsis;<br>  &#125;<br>  .photo &#123;<br>    width: 72rpx;<br>    height: 72rpx;<br>    border-radius: 50%;<br>  &#125;<br>  .user-column &#123;<br>    display: flex;<br>    flex-direction: column;<br>    margin-left: 20rpx;<br>  &#125;<br>  .label &#123;<br>    font-size: 22rpx;<br>    font-family: PingFang SC;<br>    font-weight: 500;<br>    color: rgba(153, 153, 153, 1);<br>  &#125;<br>&#125;<br><br>.comments &#123;<br>  .item &#123;<br>    padding: 24rpx 0;<br>    .comments-content &#123;<br>      padding-top: 32rpx;<br>    &#125;<br>    .reply &#123;<br>      text &#123;<br>        padding-left: 10rpx;<br>      &#125;<br>      &amp;.active &#123;<br>        color: $u-type-primary;<br>      &#125;<br>    &#125;<br>  &#125;<br>  .info &#123;<br>    font-size: 28rpx;<br>    color: #666;<br>    line-height: 90rpx;<br>    text-align: center;<br>  &#125;<br>&#125;<br><br>.ctrls &#123;<br>  color: #999;<br>  font-size: 22rpx;<br>  width: 35%;<br>  .fav,<br>  .like &#123;<br>    &amp;.active &#123;<br>      color: $u-type-primary;<br>    &#125;<br>  &#125;<br>&#125;<br><br>.add-comment &#123;<br>  background: #f3f3f3;<br>  height: 64rpx;<br>  border-radius: 32rpx;<br>  line-height: 64rpx;<br>  padding: 0 32rpx;<br>  width: 65%;<br>  margin-right: 40rpx;<br>  color: #ccc;<br>  .text &#123;<br>    padding-left: 10rpx;<br>  &#125;<br>&#125;<br><br>.loading &#123;<br>  height: 50px;<br>  .loading-text &#123;<br>    padding-left: 15rpx;<br>  &#125;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>App.vue页面中添加公共样式：</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><code class="hljs scss"><span class="hljs-selector-class">.flex-column</span> &#123;<br>  <span class="hljs-attribute">flex-direction</span>: column;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>调整api接口：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取文章中的评论列表</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getComents</span> = (<span class="hljs-params">params</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> token = store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span><br>  <span class="hljs-keyword">let</span> headers = &#123;&#125;<br>  <span class="hljs-keyword">if</span> (token !== <span class="hljs-string">&#x27;&#x27;</span>) &#123;<br>    headers = &#123;<br>      <span class="hljs-attr">headers</span>: &#123;<br>        <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">&#x27;Bearer &#x27;</span> + store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span><br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/public/comments&#x27;</span>, params, headers)<br>&#125;<br><br><span class="hljs-comment">// 获取文章详情</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getDetail</span> = (<span class="hljs-params">data</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> token = store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span><br>  <span class="hljs-keyword">let</span> headers = &#123;&#125;<br>  <span class="hljs-keyword">if</span> (token !== <span class="hljs-string">&#x27;&#x27;</span>) &#123;<br>    headers = &#123;<br>      <span class="hljs-attr">headers</span>: &#123;<br>        <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">&#x27;Bearer &#x27;</span> + store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span><br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/public/content/detail&#x27;</span>, data, headers)<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="长屏适配方案"><a href="#长屏适配方案" class="headerlink" title="#长屏适配方案"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/06-文章详情.html#长屏适配方案">#</a>长屏适配方案</h2><p>安全区域指的是一个可视窗口范围，处于安全区域的内容不受圆角（corners）、齐刘海（sensor housing）、小黑条（Home Indicator）影响，如下图蓝色区域：</p>
<p><img src="uniapp.assets/iphonex_4.7d2b50ea.png" alt="img"></p>
<p>也就是说，我们要做好适配，必须保证页面可视、可操作区域是在安全区域内。</p>
<p>解决方案env() 和 constant()：</p>
<p>iOS11 新增特性，Webkit 的一个 CSS 函数，用于设定安全区域与边界的距离，有四个预定义的变量：</p>
<ul>
<li>safe-area-inset-left：安全区域距离左边边界距离</li>
<li>safe-area-inset-right：安全区域距离右边边界距离</li>
<li>safe-area-inset-top：安全区域距离顶部边界距离</li>
<li>safe-area-inset-bottom：安全区域距离底部边界距离</li>
</ul>
<p>这里我们只需要关注 safe-area-inset-bottom 这个变量，因为它对应的就是小黑条的高度（横竖屏时值不一样）。</p>
<blockquote>
<p>注意：当 viewport-fit=contain 时 env() 是不起作用的，必须要配合 viewport-fit=cover 使用。对于不支持env() 的浏览器，浏览器将会忽略它。</p>
</blockquote>
<p>在这之前，笔者使用的是 constant()，后来，官方文档加了这么一段注释（坑）：</p>
<blockquote>
<p>The env() function shipped in iOS 11 with the name constant(). Beginning with Safari Technology Preview 41 and the iOS 11.2 beta, constant() has been removed and replaced with env(). You can use the CSS fallback mechanism to support both versions, if necessary, but should prefer env() going forward.</p>
</blockquote>
<p>这就意味着，之前使用的 constant() 在 iOS11.2 之后就不能使用的，但我们还是需要做向后兼容，像这样：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript">padding-<span class="hljs-attr">bottom</span>: <span class="hljs-title function_">constant</span>(safe-area-inset-bottom); <span class="hljs-comment">/* 兼容 iOS &lt; 11.2 */</span><br>padding-<span class="hljs-attr">bottom</span>: <span class="hljs-title function_">env</span>(safe-area-inset-bottom); <span class="hljs-comment">/* 兼容 iOS &gt;= 11.2 */</span><br></code></pre></td></tr></table></figure>
<p>注意：env() 跟 constant() 需要同时存在，而且顺序不能换。</p>
<p>更详细说明，参考文档： <a target="_blank" rel="noopener" href="https://webkit.org/blog/7929/designing-websites-for-iphone-x/?hmsr=funteas.com&amp;utm_medium=funteas.com&amp;utm_source=funteas.com">Designing Websites for iPhone X(opens new window)</a></p>
<h2 id="页面分享设置"><a href="#页面分享设置" class="headerlink" title="#页面分享设置"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/06-文章详情.html#页面分享设置">#</a>页面分享设置</h2><p>与页面分享相关的uniapp的API有两个：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/api/plugins/share?id=share">uni.share(OBJECT) (opens new window)</a>—— 针对于App分享到微信、QQ、微博</li>
<li><a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/api/plugins/share?id=onshareappmessage">onShareAppMessage(OBJECT) (opens new window)</a>—— 针对于小程序的页面的分享</li>
</ul>
<p>小程序中用户点击分享后，在 js 中定义 onShareAppMessage 处理函数（和 onLoad 等生命周期函数同级），设置该页面的分享信息。</p>
<ul>
<li>用户点击分享按钮的时候会调用。这个分享按钮可能是小程序右上角原生菜单自带的分享按钮，也可能是开发者在页面中放置的分享按钮（<code>&lt;button open-type=&quot;share&quot;&gt;</code>）；</li>
<li>此事件需要 return 一个Object，用于自定义分享内容。</li>
</ul>
<p>微信小程序平台的分享管理比较严格，请参考 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/share.html">小程序分享指引 (opens new window)</a>。</p>
<p>在详情页面中加入<code>onShareAppMessage</code>方法：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">onShareAppMessage</span> () &#123;<br>  <span class="hljs-comment">// 微信分享 -&gt; 这个分享单一的好友</span><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">title</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">page</span>.<span class="hljs-property">title</span>,<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/subcom-pkg/detail/detail?tid=&#x27;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span>.<span class="hljs-property">tid</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>目前，微信官方没有提供正式的朋友圈分享的功能，只是在android设备上进行beta测试，参考说明：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#onShareTimeline">https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#onShareTimeline</a></p>
<p><img src="uniapp.assets/image-20210802212601310.a2267358.png" alt="image-20210802212601310"></p>
</blockquote>
<h2 id="富文本显示"><a href="#富文本显示" class="headerlink" title="#富文本显示"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/06-文章详情.html#富文本显示">#</a>富文本显示</h2><h3 id="高亮方案一：自定义的highlight组件"><a href="#高亮方案一：自定义的highlight组件" class="headerlink" title="#高亮方案一：自定义的highlight组件"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/06-文章详情.html#高亮方案一-自定义的highlight组件">#</a>高亮方案一：自定义的highlight组件</h3><p>步骤：</p>
<ul>
<li>定义highlight.vue组件；</li>
<li>安装prismjs库，并使用tokenize方法进行拆分html字符串；</li>
<li>使用normalize库进行转换为对象数组；</li>
</ul>
<p>安装依赖：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">npm i prismjs<br></code></pre></td></tr></table></figure>
<p>自定义的<code>highlight.vue</code>组件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;highlight&quot;&gt;<br>    &lt;scroll-view scroll-x&gt;<br>      &lt;view v-for=&quot;(line,i) in tokenLines&quot; :key=&quot;i&quot; class=&quot;lines&quot;&gt;<br>        &lt;!-- 行数 --&gt;<br>        &lt;text class=&quot;line-number&quot;&gt;&#123;&#123;i+1&#125;&#125;&lt;/text&gt;<br>        &lt;!-- 代码块 --&gt;<br>        &lt;text v-for=&quot;(token,index) in line&quot; :key=&quot;index&quot; :class=&quot;&#x27;token--&#x27; + token.type&quot;&gt;&#123;&#123;token.content&#125;&#125;&lt;/text&gt;<br>      &lt;/view&gt;<br>    &lt;/scroll-view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import Prism from &#x27;prismjs&#x27;<br>import normalize from &#x27;@/common/utils/normalize&#x27;<br><br>// const code = `<br>// &lt;template&gt;<br>//   &lt;view class=&quot;list-item&quot;&gt;<br>//     &lt;view class=&quot;list-head&quot;&gt;<br>//       &lt;!-- 标题部分 --&gt;<br>//       &lt;text class=&quot;type&quot; :class=&quot;[&#x27;type-&#x27;+item.catalog]&quot;&gt;&#123;&#123;tabs.filter(o =&gt; o.key === item.catalog)[0].value&#125;&#125;&lt;/text&gt;<br>//       &lt;text class=&quot;title&quot;&gt;&#123;&#123;item.title&#125;&#125;&lt;/text&gt;<br>//     &lt;/view&gt;<br>//     &lt;!-- 用户部分 --&gt;<br>//     &lt;view class=&quot;author u-flex u-m-b-18&quot;&gt;<br>//       &lt;u-image :src=&quot;item.uid.pic&quot; class=&quot;head&quot; width=&quot;40&quot; height=&quot;40&quot; shape=&quot;circle&quot; error-icon=&quot;/static/images/header.jpg&quot;&gt;&lt;/u-image&gt;<br>//       &lt;text class=&quot;name u-m-l-10&quot;&gt;&#123;&#123;item.uid.name&#125;&#125;&lt;/text&gt;<br>//     &lt;/view&gt;<br>//     &lt;!-- 摘要部分 + 右侧的图片 --&gt;<br>//     &lt;view class=&quot;list-body u-m-b-30 u-flex u-col-top&quot;&gt;<br>//       &lt;view class=&quot;info u-m-r-20 u-flex-1&quot;&gt;&#123;&#123;item.content&#125;&#125;&lt;/view&gt;<br>//       &lt;image class=&quot;fmt&quot; :src=&quot;item.snapshot&quot; v-if=&quot;item.snapshot&quot; mode=&quot;aspectFill&quot; /&gt;<br>//     &lt;/view&gt;<br>//     &lt;!-- 回复 + 文章发表的时间 --&gt;<br>//     &lt;view class=&quot;list-footer u-flex&quot;&gt;<br>//       &lt;view class=&quot;left&quot;&gt;<br>//         &lt;text class=&quot;reply-num u-m-r-25&quot;&gt;&#123;&#123;item.answer&#125;&#125; 回复&lt;/text&gt;<br>//         &lt;text class=&quot;timer&quot;&gt;&#123;&#123;item.created | moment&#125;&#125;&lt;/text&gt;<br>//       &lt;/view&gt;<br>//     &lt;/view&gt;<br>//   &lt;/view&gt;<br>// &lt;/template&gt;<br>// `<br>export default &#123;<br>  props: &#123;<br>    code: &#123;<br>      type: String,<br>      default: &#x27;&#x27;<br>    &#125;,<br>    language: &#123;<br>      type: String,<br>      default: &#x27;js&#x27;<br>    &#125;<br>  &#125;,<br>  data: () =&gt; (&#123;<br>  &#125;),<br>  computed: &#123;<br>    tokenLines () &#123;<br>      const result = normalize(Prism.tokenize(this.code, Prism.languages[this.language]))<br>      // console.log(&#x27;🚀 ~ file: highlight.vue ~ line 54 ~ tokenLines ~ result&#x27;, result)<br>      return result<br>    &#125;<br>  &#125;,<br>  methods: &#123;&#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.intro &#123;<br>  margin: 30px;<br>  text-align: center;<br>&#125;<br><br>:host &#123;<br>  text-align: left;<br>  font-family: consolas, monospace;<br>  line-height: 1.44;<br>  white-space: nowrap;<br>&#125;<br><br>.lines &#123;<br>  display: flex;<br>  flex-flow: row nowrap;<br>  width: 100%;<br>  align-items: center;<br>  justify-content: flex-start;<br>&#125;<br><br>.line-number &#123;<br>  display: inline-block;<br>  flex-shrink: 0;<br>  border-right: 4px solid #d8d8d8;<br>  min-width: 55px;<br>  text-align: right;<br>  margin-right: 10px;<br>  padding-right: 10px;<br>  color: #888;<br>  &amp;.max &#123;<br>    width: 110px;<br>  &#125;<br>&#125;<br><br>.token &#123;<br>  color: #333;<br>  white-space: pre;<br>&#125;<br><br>.token--plain,<br>.token--string &#123;<br>  white-space: pre;<br>&#125;<br><br>.token--keyword &#123;<br>  color: #00f;<br>&#125;<br><br>.token--number &#123;<br>  color: #09885a;<br>&#125;<br><br>.token--string &#123;<br>  color: #a31515;<br>&#125;<br><br>.token--regex &#123;<br>  color: #811f3f;<br>&#125;<br><br>.token--comment &#123;<br>  color: #008000;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h3 id="高亮方案二：wxParse"><a href="#高亮方案二：wxParse" class="headerlink" title="#高亮方案二：wxParse"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/06-文章详情.html#高亮方案二-wxparse">#</a>高亮方案二：wxParse</h3><p>效果展示：</p>
<p><img src="uniapp.assets/image-20210803112201381.b1453768.png" alt="img"> <img src="uniapp.assets/image-20210803112237505.ba04d822.png" alt="img"></p>
<ul>
<li>1.将<code>prism.css</code>重命名为<code>prism.wxss</code></li>
<li>2.复制<code>prism.js</code>和<code>prism.wxss</code>至<code>utils</code>文件夹下</li>
<li>3.替换<code>prism.wxss</code>中的<code>code[class*=&quot;language-&quot;]</code>为<code>.wxParse-code[class*=&quot;language-&quot;]</code></li>
<li>4.<code>wxParse.wxss</code>中引用<code>prism.wxss</code></li>
</ul>
<figure class="highlight css"><table><tr><td class="code"><pre><code class="hljs css"><span class="hljs-keyword">@import</span> <span class="hljs-string">&quot;../utils/prism.wxss&quot;</span>;<br></code></pre></td></tr></table></figure>
<ul>
<li>5.新增<code>highlight.js</code>高亮工具类（代码放置在wxParse文件夹下）</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-title class_">Prism</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../utils/prism.js&#x27;</span>)<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">highlight</span>(<span class="hljs-params">data, that</span>) &#123;<br>  <span class="hljs-comment">// Prism 所支持的代码语言数组</span><br>  <span class="hljs-keyword">let</span> langArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>  langArr = <span class="hljs-title function_">listLanguages</span>();<br>  <span class="hljs-comment">// console.log(&#x27;all-language:&#x27;+langArr)</span><br>  <span class="hljs-keyword">let</span> html = data;<br>  <span class="hljs-comment">//匹配到的所有标签&lt;\/code&gt;</span><br>  <span class="hljs-keyword">let</span> tagArr = data.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/&lt;\/?code[^&gt;]*&gt;/g</span>);<br>  <span class="hljs-keyword">if</span> (tagArr == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> html;<span class="hljs-comment">// 如果没有 pre 标签就直接返回原来的内容，不做代码高亮处理</span><br>  &#125;<br>  <span class="hljs-comment">//记录每一个 code 标签在data中的索引位置</span><br>  <span class="hljs-keyword">let</span> indexArr = [];<br>  <span class="hljs-comment">//计算索引位置</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tagArr.<span class="hljs-property">length</span>; i++) &#123;<br>    <span class="hljs-comment">//添加索引值</span><br>    <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>      indexArr.<span class="hljs-title function_">push</span>(data.<span class="hljs-title function_">indexOf</span>(tagArr[i]));<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      indexArr.<span class="hljs-title function_">push</span>(data.<span class="hljs-title function_">indexOf</span>(tagArr[i], indexArr[i - <span class="hljs-number">1</span>]));<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//记录基本的class信息</span><br>  <span class="hljs-keyword">let</span> cls;<br><br>  <span class="hljs-comment">// 开始循环处理 code 标签</span><br>  <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> (i &lt; tagArr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) &#123;<span class="hljs-comment">// 这里减一是因为不处理最后的 code 标签</span><br>    <span class="hljs-comment">// 调用函数来获取 class 信息</span><br>    <span class="hljs-title function_">getStartInfo</span>(tagArr[i])<br>    <span class="hljs-comment">// 获取标签的值</span><br>    <span class="hljs-keyword">var</span> label = tagArr[i].<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/&lt;*([^&gt; ]*)/</span>)[<span class="hljs-number">1</span>];<br>    <span class="hljs-comment">// console.log(&#x27;label:&#x27;+label)</span><br>    <span class="hljs-keyword">if</span> (tagArr[i + <span class="hljs-number">1</span>] === <span class="hljs-string">&#x27;&lt;/&#x27;</span> + label + <span class="hljs-string">&#x27;&gt;&#x27;</span>) &#123;<span class="hljs-comment">//判断紧跟它的下一个标签是否为它的闭合标签</span><br>      <span class="hljs-keyword">if</span> (label === <span class="hljs-string">&#x27;code&#x27;</span>) &#123;<br>        <span class="hljs-comment">// 代码语言判断,根据类进行判断，自定义，比如 lang-语言,language-语言。</span><br>        <span class="hljs-keyword">let</span> lang = cls.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27; &#x27;</span>)[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/lang-(.*)/i</span>.<span class="hljs-title function_">test</span>(lang)) &#123;<span class="hljs-comment">// 代码语言定义是 lang-XXX 的样式</span><br>          lang = lang.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/lang-(.*)/i</span>, <span class="hljs-string">&#x27;$1&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/languages?-(.*)/i</span>.<span class="hljs-title function_">test</span>(lang)) &#123;<br>          lang = lang.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/languages?-(.*)/i</span>, <span class="hljs-string">&#x27;$1&#x27;</span>);<span class="hljs-comment">// 代码语言定义是 language(s)-XXX 的样式</span><br>        &#125;<br>        <span class="hljs-comment">// 如果代码语言不在 Prism 存在的语言，或者 class 值是 null，则不执行代码高亮函数</span><br>        <span class="hljs-keyword">if</span> (langArr.<span class="hljs-title function_">indexOf</span>(lang) == -<span class="hljs-number">1</span> || lang == <span class="hljs-literal">null</span> || lang == <span class="hljs-string">&#x27;none&#x27;</span> || lang == <span class="hljs-string">&#x27;null&#x27;</span>) &#123;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// 获取代码段内容为 code</span><br>          <span class="hljs-keyword">let</span> code = data.<span class="hljs-title function_">substring</span>(indexArr[i], indexArr[i + <span class="hljs-number">1</span>]).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;code[^&gt;]*&gt;/</span>, <span class="hljs-string">&#x27;&#x27;</span>);<br><br>          <span class="hljs-comment">// 执行 Prism 的代码高亮函数</span><br>          <span class="hljs-keyword">let</span> hcode = <span class="hljs-title class_">Prism</span>.<span class="hljs-title function_">highlight</span>(code, <span class="hljs-title class_">Prism</span>.<span class="hljs-property">languages</span>[lang], lang);<br>          html = html.<span class="hljs-title function_">replace</span>(code, hcode);<br>        &#125;<br><br>      &#125;<br>      <span class="hljs-comment">// 指向下一个标签（闭合标签）索引</span><br>      i++;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//onsole.log(&#x27;不是闭包&#x27;)</span><br>    &#125;<br>    <span class="hljs-comment">// 指向下一个标签（开始标签）的索引</span><br>    i++;<br>  &#125;<br>  <span class="hljs-keyword">return</span> html;<br><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStartInfo</span>(<span class="hljs-params">str</span>) &#123;<br>    cls = <span class="hljs-title function_">matchRule</span>(str, <span class="hljs-string">&#x27;class&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">//获取部分属性的值</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">matchRule</span>(<span class="hljs-params">str, rule</span>) &#123;<br>    <span class="hljs-keyword">let</span> value = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">let</span> re = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(rule + <span class="hljs-string">&#x27;=[\&#x27;&quot;]?([^\&#x27;&quot;]*)&#x27;</span>);<br>    <span class="hljs-comment">//console.log(&#x27;regexp:&#x27;+re)</span><br>    <span class="hljs-keyword">if</span> (str.<span class="hljs-title function_">match</span>(re) !== <span class="hljs-literal">null</span>) &#123;<br>      value = str.<span class="hljs-title function_">match</span>(re)[<span class="hljs-number">1</span>];<br>      <span class="hljs-comment">//console.log(&#x27;value:&#x27;+value)</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125;<br><br><br>  <span class="hljs-comment">// 列出当前 Prism.js 中已有的代码语言，可以自己在 Prism 的下载页面选择更多的语言。</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">listLanguages</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> langs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> language <span class="hljs-keyword">in</span> <span class="hljs-title class_">Prism</span>.<span class="hljs-property">languages</span>) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-title class_">Prism</span>.<span class="hljs-property">languages</span>[language]) !== <span class="hljs-string">&#x27;[object Function]&#x27;</span>) &#123;<br>        langs[i] = language;<br>        i++;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> langs;<br>  &#125;<br>&#125;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">highlight</span>: highlight<br>&#125;;<br></code></pre></td></tr></table></figure>
<ul>
<li>6.在<code>wxParse</code>文件夹下的<code>html2json.js</code>中引用<code>highlight.js</code>工具类的<code>highligh</code>高亮函数</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//引用`highlight.js`工具类</span><br><span class="hljs-keyword">var</span> highlight = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./highlight.js&#x27;</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">html2json</span>(<span class="hljs-params">html, bindName, that</span>) &#123;<br>    html = <span class="hljs-title function_">removeDOCTYPE</span>(html);<br>    html = <span class="hljs-title function_">trimHtml</span>(html);<br>    html = wxDiscode.<span class="hljs-title function_">strDiscode</span>(html);<br>    <span class="hljs-comment">//引用高亮函数</span><br>    html = highlight.<span class="hljs-title function_">highlight</span>(html, that); <br><br>    <span class="hljs-comment">//省略了后续代码</span><br>    ...<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>参考链接 ：</p>
<p><a target="_blank" rel="noopener" href="https://blog.sunriseydy.top/technology/server-blog/wordpress/wordpress-miniapp-code-highlight">https://blog.sunriseydy.top/technology/server-blog/wordpress/wordpress-miniapp-code-highlight</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41107410/article/details/89042212">https://blog.csdn.net/qq_41107410/article/details/89042212</a></p>
<h1 id="安全域名相关"><a href="#安全域名相关" class="headerlink" title="#安全域名相关"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#安全域名相关">#</a>安全域名相关</h1><p>微信小程序的安全域名必须是HTTPS，同时必须是在国内ICP备案的域名，本章来介绍如何使用acme.sh+nginx配置https与申请SSL证书。</p>
<h2 id="SSL证书申请"><a href="#SSL证书申请" class="headerlink" title="#SSL证书申请"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#ssl证书申请">#</a>SSL证书申请</h2><h3 id="前置准备"><a href="#前置准备" class="headerlink" title="#前置准备"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#前置准备">#</a>前置准备</h3><ul>
<li><p>申请域名：阿里云、腾讯云等各家云服务商；</p>
</li>
<li><p>有一台云主机，有公网的IP，最好进行过备案；如果没有国内的服务器，也可以注册一台国外的服务器，地址1：<a target="_blank" rel="noopener" href="https://bwh81.net/aff.php?aff=6389">搬瓦工 (opens new window)</a>，地址2：<a target="_blank" rel="noopener" href="https://www.vultr.com/?ref=6862890">vultr (opens new window)</a>；</p>
</li>
<li><p>云主机的操作系统：Centos 7+（以下所有演示内容，均为Centos 7）或者Ubuntu 16LTS+；</p>
</li>
<li><p>DNS解析：DNSpod，cloudflare；</p>
<p>配置域名进行解析：</p>
<p><img src="uniapp.assets/image-20210810145545806.a0e07748.png" alt="image-20210810145545806"></p>
<p>使用A记录，配置自己的域名 -&gt; 自己的云主机IP</p>
<p>使用ping命令检查 是否已经网络通了：</p>
<p><img src="uniapp.assets/image-20210810145801200.cc140063.png" alt="image-20210810145801200"></p>
</li>
</ul>
<h3 id="整体架构"><a href="#整体架构" class="headerlink" title="#整体架构"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#整体架构">#</a>整体架构</h3><p>配置架构图：</p>
<p><img src="uniapp.assets/image-20210810144327946.bbb98c11.png" alt="image-20210810144327946"></p>
<h3 id="基本步骤"><a href="#基本步骤" class="headerlink" title="#基本步骤"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#基本步骤">#</a>基本步骤</h3><p>借助<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/wiki/说明">acme.sh (opens new window)</a>进行申请SSL证书，以便微信接口部分的使用，下面演示的是DNSpod进行证书申请的过程。</p>
<p><strong>主要步骤：</strong></p>
<p>前置：使用ssh命令连接到服务器 -&gt;</p>
<ol>
<li><p>安装 <strong>acme.sh</strong></p>
</li>
<li><p>生成证书 ——<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">推荐DNS的方式(opens new window)</a></p>
<blockquote>
<p>支持的DNS列表：<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/tree/master/dnsapi">https://github.com/acmesh-official/acme.sh/tree/master/dnsapi(opens new window)</a></p>
</blockquote>
</li>
<li><p>copy 证书到 nginx/apache 或者其他服务</p>
</li>
<li><p>更新证书</p>
</li>
<li><p>更新 <strong>acme.sh</strong></p>
</li>
</ol>
<h3 id="acme-sh安装"><a href="#acme-sh安装" class="headerlink" title="#acme.sh安装"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#acme-sh安装">#</a>acme.sh安装</h3><p>安装很简单, 一个命令:</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">curl  https://get.acme.sh | sh -s email=my@example.com<br></code></pre></td></tr></table></figure>
<p><img src="uniapp.assets/image-20210810145930893.237427d0.png" alt="image-20210810145930893"></p>
<p>再次打开一个新的ssh终端，使用<code>crontab -e</code>(Centos)查看<code>acme.sh</code>自动创建的定时任务：</p>
<p><img src="uniapp.assets/image-20210810150236024.e82227d2.png" alt="image-20210810150236024"></p>
<p>输入<code>i</code>进入编辑模式，调整如上图所示，使用<code>:wq</code>退出。</p>
<blockquote>
<p>PS：上面的配置是每天的0点23分去执行一次脚本。</p>
</blockquote>
<h3 id="配置DNS密钥"><a href="#配置DNS密钥" class="headerlink" title="#配置DNS密钥"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#配置dns密钥">#</a>配置DNS密钥</h3><p>下面介绍了DNSpod、阿里云、Cloudflare的配置过程，大家可以根据自己的云服务商选择，过程类似。</p>
<h4 id="DNSpod"><a href="#DNSpod" class="headerlink" title="#DNSpod"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#dnspod">#</a>DNSpod</h4><ul>
<li><p>选择密钥管理：</p>
<p><img src="uniapp.assets/image-20210810150640094.3d656e26.png" alt="image-20210810150640094"></p>
</li>
<li><p>创建密钥</p>
<p><img src="uniapp.assets/image-20210810150731394.b27888e3.png" alt="image-20210810150731394"></p>
</li>
<li><p>记录下来，后续使用：</p>
<p><img src="uniapp.assets/image-20210810150751582.43ca872b.png" alt="image-20210810150751582"></p>
</li>
</ul>
<p>配置密钥：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> DPI_Id=<span class="hljs-string">&quot;1234&quot;</span><br><span class="hljs-built_in">export</span> DPI_Key=<span class="hljs-string">&quot;sADDsdasdgdsf&quot;</span><br></code></pre></td></tr></table></figure>
<h4 id="阿里云"><a href="#阿里云" class="headerlink" title="#阿里云"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#阿里云">#</a>阿里云</h4><p>点击：<a target="_blank" rel="noopener" href="https://ak-console.aliyun.com/#/accesskey">https://ak-console.aliyun.com/#/accesskey (opens new window)</a>，申请密钥：</p>
<p><img src="uniapp.assets/image-20210810151001761.9040174d.png" alt="image-20210810151001761"></p>
<p>选择<code>编程访问</code>：</p>
<p><img src="uniapp.assets/image-20210810151252035.d404c680.png" alt="image-20210810151252035"></p>
<p>生成accessKey与密钥：</p>
<p><img src="uniapp.assets/image-20210810151319187.d113629f.png" alt="image-20210810151319187"></p>
<p>配置过程：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> Ali_Key=<span class="hljs-string">&quot;sdfsdfsdfljlbjkljlkjsdfoiwje&quot;</span><br><span class="hljs-built_in">export</span> Ali_Secret=<span class="hljs-string">&quot;jlsdflanljkljlfdsaklkjflsa&quot;</span><br></code></pre></td></tr></table></figure>
<h4 id="Cloudflare"><a href="#Cloudflare" class="headerlink" title="#Cloudflare"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#cloudflare">#</a>Cloudflare</h4><p>配置<a target="_blank" rel="noopener" href="https://dash.cloudflare.com/profile">页面 (opens new window)</a>：</p>
<p><img src="uniapp.assets/image-20210810151518194.3045c842.png" alt="image-20210810151518194"></p>
<p>配置过程：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">export CF_Key=&quot;sdfsdfsdfljlbjkljlkjsdfoiwje&quot;<br>export CF_Email=&quot;xxxx@sss.com&quot;<br></code></pre></td></tr></table></figure>
<h3 id="产生证书"><a href="#产生证书" class="headerlink" title="#产生证书"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#产生证书">#</a>产生证书</h3><ul>
<li><p>Dnspod:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">acme.sh --issue --dns dns_dpi -d example.com -d www.example.com<br></code></pre></td></tr></table></figure>
</li>
<li><p>阿里云：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">acme.sh --issue --dns dns_ali -d example.com -d www.example.com<br></code></pre></td></tr></table></figure>
</li>
<li><p>Cloudflare：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">acme.sh --issue --dns dns_cf -d example.com -d www.example.com<br></code></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>推荐域名通配符的写法：example.com 与 *.example.com，那么二级子域名，全部都可以使用https。</p>
</blockquote>
<p>过程1：</p>
<p><img src="uniapp.assets/image-20210810152354761.b8f93ecb.png" alt="image-20210810152354761"></p>
<p>上面的图片是展示出在对域名进行校验。</p>
<p>过程2：</p>
<p><img src="uniapp.assets/image-20210810152415177.a8f72743.png" alt="image-20210810152415177"></p>
<p>证书申请成功，证书所在位置。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">cer 自签<br>key 密钥<br>CA 中间证书<br>把CA与cert链接到一起的证书，这个是后续放在nginx上的，用于服务器之间的协商<br></code></pre></td></tr></table></figure>
<h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="#Nginx配置"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#nginx配置">#</a>Nginx配置</h2><h3 id="前置准备-1"><a href="#前置准备-1" class="headerlink" title="#前置准备"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#前置准备-2">#</a>前置准备</h3><p><img src="uniapp.assets/image-20210810205823556.b18f986b.png" alt="image-20210810205823556"></p>
<p>步骤：</p>
<ul>
<li>安装docker,docker-compose -&gt; nginx</li>
<li>docker-compose来启动nginx</li>
<li>创建一个https docker网络 -&gt; 共享给github, jenkins 等需要https的服务</li>
<li>配置<code>nginx.conf</code>配置文件，创建<code>conf.d</code>文件目录，可以创建虚拟域名<code>vhost.conf</code>文件</li>
<li>使用证书安装命令安装ssl证书 -&gt; 到指定的目录</li>
<li><code>docker-compose up -d</code>运行nginx容器 -&gt; 测试cron定时任务脚本</li>
</ul>
<h3 id="证书安装命令"><a href="#证书安装命令" class="headerlink" title="#证书安装命令"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#证书安装命令">#</a>证书安装命令</h3><p>Apache配置:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">acme.sh --install-cert -d example.com \<br>--cert-file      /path/to/certfile/in/apache/cert.pem  \<br>--key-file       /path/to/keyfile/in/apache/key.pem  \<br>--fullchain-file /path/to/fullchain/certfile/apache/fullchain.pem \<br>--reloadcmd     <span class="hljs-string">&quot;service apache2 force-reload&quot;</span><br></code></pre></td></tr></table></figure>
<p>Nginx配置:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">acme.sh --install-cert -d example.com \<br>--key-file       /path/to/keyfile/in/nginx/key.pem  \<br>--fullchain-file /path/to/fullchain/nginx/cert.pem \<br>--reloadcmd     <span class="hljs-string">&quot;service nginx force-reload&quot;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p><code>--reloadcmd</code>可以指定docker容器进行重启，或者是指定运行shell脚本。</p>
<p>比如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">--reloadcmd &quot;docker restart some-nginx&quot;<br></code></pre></td></tr></table></figure>
</blockquote>
<h3 id="dhparam-pem证书"><a href="#dhparam-pem证书" class="headerlink" title="#dhparam.pem证书"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#dhparam-pem证书">#</a>dhparam.pem证书</h3><p>创建一个目录：<code>/home/keys</code></p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text"># 生成 dhparam.pem 文件, 在命令行执行任一方法:<br><br># 方法1: 很慢<br>openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048<br><br># 方法2: 较快<br># 与方法1无明显区别. 2048位也足够用, 4096更强<br>openssl dhparam -dsaparam -out /etc/nginx/ssl/dhparam.pem 4096<br></code></pre></td></tr></table></figure>
<p>把dhparam.pem复制到个人SSL证书安装相同的目录<code>/home/keys</code>。</p>
<h3 id="docker配置"><a href="#docker配置" class="headerlink" title="#docker配置"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#docker配置">#</a>docker配置</h3><ul>
<li><p>手动创建网络</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker network create https<br></code></pre></td></tr></table></figure>
<p><img src="uniapp.assets/image-20210810210138510.dce600c7.png" alt="image-20210810210138510"></p>
<blockquote>
<p>查看网络 <code>docker network ls</code></p>
<p>检查网络的信息 <code>docker network inspect https</code></p>
</blockquote>
</li>
<li><p>创建<code>docker-compose.yml</code>文件</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">&quot;some-nginx&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/nginx/nginx.conf:/etc/nginx/nginx.conf</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/nginx/conf.d:/etc/nginx/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/keys:/home/keys</span><br>      <span class="hljs-comment"># blog</span><br>      <span class="hljs-comment"># - /home/blog:/var/www</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;80:80&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;443:443&quot;</span><br><br><span class="hljs-comment"># docker network create https</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">external:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br></code></pre></td></tr></table></figure>
<h3 id="nginx-conf配置"><a href="#nginx-conf配置" class="headerlink" title="#nginx.conf配置"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#nginx-conf配置">#</a>nginx.conf配置</h3><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">user nginx;<br>worker_processes auto;<br>pid /run/nginx.pid;<br>worker_rlimit_nofile 65535;<br><br>events &#123;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">设置事件驱动模型，是内核2.6以上支持</span><br>	use epoll;<br>	worker_connections 65535;<br>	accept_mutex off;<br>	multi_accept off;<br>&#125;<br><br>http &#123;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">Basic Settings</span><br>	sendfile on;<br>	tcp_nopush on;<br>	tcp_nodelay on;<br>	send_timeout 120;<br>	keepalive_timeout 300;<br>	client_body_timeout 300;<br>	client_header_timeout 120;<br><br>	proxy_read_timeout 300;<br>	proxy_send_timeout 300;<br><span class="hljs-meta prompt_">	#</span><span class="language-bash">tcp_nopush on;</span><br>	types_hash_max_size 4096;<br>	client_header_buffer_size 16m;<br>	client_max_body_size 4096m;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">  # </span><span class="language-bash">添加nginx的配置文件目录 -&gt; 用户后期添加vhost文件</span><br>	include /etc/nginx/mime.types;<br>	include /etc/nginx/conf.d/*.conf;<br><br>	default_type application/octet-stream;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">Logging Settings</span><br>	access_log /var/log/nginx/access.log;<br>	error_log /var/log/nginx/error.log;<br>	log_format main &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;<br>	&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;<br>	&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;<br><span class="hljs-meta prompt_">	</span><br><span class="hljs-meta prompt_">	# </span><span class="language-bash">开启gzip</span><br>	gzip on;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">启用gzip压缩的最小文件，小于设置值的文件将不会压缩</span><br>	gzip_min_length 1k;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">gzip 压缩级别，1-10，数字越大压缩的越好，也越占用CPU时间，后面会有详细说明</span><br>	gzip_comp_level 2;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">进行压缩的文件类型。javascript有多种形式。其中的值可以在 mime.types 文件中找到。</span><br>	gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">是否在http header中添加Vary: Accept-Encoding，建议开启</span><br>	gzip_vary on;<br><span class="hljs-meta prompt_">	# </span><span class="language-bash">禁用IE 6 gzip</span><br>	gzip_disable &quot;MSIE [1-6]\.&quot;;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="安装证书启动nginx"><a href="#安装证书启动nginx" class="headerlink" title="#安装证书启动nginx"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#安装证书启动nginx">#</a>安装证书启动nginx</h3><p><img src="uniapp.assets/image-20210810211832312.c848f3ae.png" alt="image-20210810211832312"></p>
<p>测试Nignx的配置文件：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker exec -it some-nginx nginx -t<br></code></pre></td></tr></table></figure>
<p><img src="uniapp.assets/image-20210810220403001.ba89c359.png" alt="image-20210810220403001"></p>
<h3 id="课程福利nginx配置"><a href="#课程福利nginx配置" class="headerlink" title="#课程福利nginx配置"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#课程福利nginx配置">#</a>课程福利nginx配置</h3><p>nginx的配置文件地址：<a target="_blank" rel="noopener" href="https://gist.github.com/toimc/24df7ea1adab57ee9560062ae9905c2a">github(opens new window)</a></p>
<h3 id="场景一：配置博客应用"><a href="#场景一：配置博客应用" class="headerlink" title="#场景一：配置博客应用"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#场景一-配置博客应用">#</a>场景一：配置博客应用</h3><p>添加宿主机的docker目录映射：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">&quot;some-nginx&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/nginx/nginx.conf:/etc/nginx/nginx.conf</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/nginx/conf.d:/etc/nginx/conf.d</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/keys:/home/keys</span><br>      <span class="hljs-comment"># blog</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/blog:/var/www</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;80:80&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;443:443&quot;</span><br><br><span class="hljs-comment"># docker network create https</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">external:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br></code></pre></td></tr></table></figure>
<p>nginx的配置文件 <code>conf.d/vhost.conf</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># listen on HTTP2/SSL</span><br>server &#123;<br>  listen 443 ssl http2;<br>  server_name www.wayearn.com;<br>  <span class="hljs-comment"># ssl certs from letsencrypt</span><br>  <span class="hljs-comment"># ssl on;</span><br>  <span class="hljs-comment"># 这里要注意目录是docker里面的目录，所以建议大家把容器里面的目录与宿主机的目录映射一致</span><br>  ssl_certificate /home/keys/certs.pem;<br>  ssl_certificate_key /home/keys/key.pem;<br>  <span class="hljs-comment"># dhparam.pem</span><br>  ssl_dhparam /home/keys/dhparam.pem;<br><br>  ssl_session_cache shared:SSL:50m;<br>  ssl_session_timeout 30m;<br>  ssl_session_tickets off;<br><br>  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br>  <span class="hljs-comment"># ciphers chosen for forward secrecy and compatibility</span><br>  <span class="hljs-comment"># http://blog.ivanristic.com/2013/08/configuring-apache-nginx-and-openssl-for-forward-secrecy.html</span><br>  ssl_ciphers <span class="hljs-string">&#x27;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&#x27;</span>;<br><br>  ssl_prefer_server_ciphers on;<br><br>  add_header Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubdomains; preload&quot;</span>;<br><br>  location / &#123;<br>    root /var/www/;<br>    index index.html;<br>    proxy_set_header Host <span class="hljs-variable">$host</span>:<span class="hljs-variable">$server_port</span>;<br>    proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>    proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment"># redirect HTTP and handle let&#x27;s encrypt requests</span><br>server &#123;<br>  listen 80;<br>  server_name www.wayearn.com;<br>  location / &#123;<br>    <span class="hljs-built_in">return</span> 301 https://$host<span class="hljs-variable">$request_uri</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>检测ssl网站的评级 myssl.com：</p>
<p><img src="uniapp.assets/image-20210810220929142.1537ad70.png" alt="image-20210810220929142"></p>
<h3 id="场景二：配置小程序API接口"><a href="#场景二：配置小程序API接口" class="headerlink" title="#场景二：配置小程序API接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#场景二-配置小程序api接口">#</a>场景二：配置小程序API接口</h3><p>步骤：</p>
<ul>
<li>api -&gt; 线上 -&gt; nginx进行代理 ；</li>
<li>api部署到线上的服务器；</li>
<li>api服务可以被nginx访问到；</li>
<li>域名 + https形式去访问 -&gt; 提供api服务<ul>
<li>配置nginx的vhost配置 + 配置域名解析dns</li>
<li>wx.yourdomain.com -&gt; 指向服务器的IP</li>
<li>重启nginx容器让vhost的配置生效 -&gt; 测试服务</li>
</ul>
</li>
</ul>
<p>小程序的docker-compose文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span><br>      <span class="hljs-attr">args:</span><br>        <span class="hljs-attr">Version:</span> <span class="hljs-string">$&#123;Version&#125;</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">api_online:$&#123;tag&#125;</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">api_online</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-comment"># env_file: .env</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_USER=$DB_USER</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_PASS=$DB_PASS</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_HOST=$DB_HOST</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_PORT=$DB_PORT</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_NAME=$DB_NAME</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_HOST=$REDIS_HOST</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_PORT=$REDIS_PORT</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_PASS=$REDIS_PASS</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;$&#123;PORT&#125;:3000&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;$&#123;WS_PORT&#125;:3001&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/imooc/online:/app/public</span><br><br><span class="hljs-comment"># 关键就是这里，配置API项目的网络，连接到https网络</span><br><span class="hljs-comment"># 然后，使用vhost配置，让Nginx进行代理</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">external:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br></code></pre></td></tr></table></figure>
<p>可选方案：提供Mongo、redis环境的<code>docker-compose.yml</code>文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">web:</span><br>    <span class="hljs-attr">build:</span><br>      <span class="hljs-attr">context:</span> <span class="hljs-string">.</span><br>      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span><br>      <span class="hljs-attr">args:</span><br>        <span class="hljs-attr">Version:</span> <span class="hljs-number">1.0</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">api_online:1.0</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">api_online</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-comment"># env_file: .env</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_USER=toimc</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_PASS=long_random_pass_mongo</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_HOST=mongo</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_PORT=27017</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">DB_NAME=community</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_HOST=redis</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_PORT=6379</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">REDIS_PASS=long_random_pass_redis</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10030:3000&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;10031:3001&quot;</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/imooc/online:/app/public</span><br><br>  <span class="hljs-attr">mongo:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mongo</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">&quot;mongodb&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/imooc/db:/data/db</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">/home/imooc/db/initdb.d:/docker-entrypoint-initdb.d/</span><br>      <span class="hljs-comment"># .sh &amp; .js</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;27017:27017&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="hljs-string">root</span><br>      <span class="hljs-attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="hljs-string">example</span><br>      <span class="hljs-attr">MONGO_INITDB_DATABASE:</span> <span class="hljs-string">testdb</span><br>      <span class="hljs-attr">MONGO_INITDB_USERNAME:</span> <span class="hljs-string">toimc</span><br>      <span class="hljs-attr">MONGO_INITDB_PASSWORD:</span> <span class="hljs-string">long_random_pass_mongo</span><br><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">&quot;redis&quot;</span><br>    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;6379:6379&quot;</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">--requirepass</span> <span class="hljs-string">long_random_pass_redis</span><br><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">default:</span><br>    <span class="hljs-attr">external:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br></code></pre></td></tr></table></figure>
<p>MongoDB的初始化文件<code>init.d/mongo-init.sh</code>文件：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">mongo -- <span class="hljs-string">&quot;<span class="hljs-variable">$MONGO_INITDB_DATABASE</span>&quot;</span> &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">var rootUser = &#x27;$MONGO_INITDB_ROOT_USERNAME&#x27;;</span><br><span class="hljs-string">var rootPassword = &#x27;$MONGO_INITDB_ROOT_PASSWORD&#x27;;</span><br><span class="hljs-string">var initDB = &#x27;$MONGO_INITDB_DATABASE&#x27;</span><br><span class="hljs-string">var admin = db.getSiblingDB(initDB);</span><br><span class="hljs-string">admin.auth(rootUser, rootPassword);</span><br><span class="hljs-string"></span><br><span class="hljs-string">var user = &#x27;$MONGO_INITDB_USERNAME&#x27;;</span><br><span class="hljs-string">var passwd = &#x27;$MONGO_INITDB_PASSWORD&#x27;;</span><br><span class="hljs-string">db.createUser(&#123; user: user, pwd: passwd, roles: [&quot;dbOwner&quot;] &#125;);</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>
<p>手动部署API服务：</p>
<ul>
<li><p>使用docker命令进行docker镜像的构建</p>
</li>
<li><p>推送镜像或者使用手动方式导入镜像</p>
<p>保存(Save)</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text"># 保留原镜像的名称和标签<br>docker save &lt;IMAGE NAME&gt;:&lt;IMAGE TAG&gt; &gt; save.tar<br>  <br># 不保留原镜像的基本信息,加载load后需执行tag命令重命名none镜像<br>docker save &lt;IMAGE ID&gt; &gt; save.tar <br></code></pre></td></tr></table></figure>
<p>示例:</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker save elasticsearch:7.1.1 &gt; elasticsearch-7.1.1.tar<br># 或<br>docker save b0cb1543380d &gt; elasticsearch-7.1.1.tar<br></code></pre></td></tr></table></figure>
<p>加载(Load)</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker load &lt; save.tar<br></code></pre></td></tr></table></figure>
<p>示列:</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker load &lt; elasticsearch-7.1.1.tar<br></code></pre></td></tr></table></figure>
</li>
<li><p>配置nginx文件<code>/home/nginx/conf.d/ws.conf</code>：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">upstream target-server &#123;<br>  server api_online:3001 fail_timeout=0;<br>&#125;<br><span class="hljs-comment"># listen on HTTP2/SSL</span><br>server &#123;<br>  listen 443 ssl http2;<br>  server_name ws.wayearn.com;<br>  <span class="hljs-comment"># ssl certs from letsencrypt</span><br>  ssl_certificate /home/acme/fullchain.pem;<br>  ssl_certificate_key /home/acme/key.pem;<br>  <span class="hljs-comment"># dhparam.pem</span><br>  ssl_dhparam /home/acme/dhparam.pem;<br>  ssl_session_timeout 5m;<br>  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br>  ssl_ciphers <span class="hljs-string">&#x27;ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&#x27;</span>;<br>  ssl_prefer_server_ciphers on;<br>  location / &#123;<br>    proxy_set_header X-Forwarded-Ssl on;<br>    proxy_redirect off;<br>    proxy_set_header Host <span class="hljs-variable">$host</span>:<span class="hljs-variable">$server_port</span>;<br>    proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>    proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>    proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>    proxy_pass http://target-server;<br>    proxy_set_header Upgrade <span class="hljs-variable">$http_upgrade</span>;<br>    proxy_set_header Connection <span class="hljs-string">&#x27;Upgrade&#x27;</span>;<br>  &#125;<br>&#125;<br><span class="hljs-comment"># redirect HTTP and handle let&#x27;s encrypt requests</span><br>server &#123;<br>  listen 80;<br>  server_name ws.wayearn.com;<br>  <span class="hljs-comment"># send everything else to HTTPS</span><br>  rewrite ^(.*)$ https://$host<span class="hljs-variable">$1</span> permanent;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>添加dns解析</p>
<p><img src="uniapp.assets/image-20210810223431309.368c5c94.png" alt="image-20210810223431309"></p>
</li>
<li><p>导入镜像，启动api服务：</p>
<p><img src="uniapp.assets/image-20210810223550333.d0fedae0.png" alt="image-20210810223550333"></p>
<p>使用<code>docker-compose up -d</code>启动服务：</p>
<p><img src="uniapp.assets/image-20210810223613863.5fbb1359.png" alt="image-20210810223613863"></p>
</li>
<li><p>重启nginx服务：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker restart some-nginx<br></code></pre></td></tr></table></figure>
<p>网络互访：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker network inspect https<br></code></pre></td></tr></table></figure>
<p><img src="uniapp.assets/image-20210810223801721.cc7b1e2f.png" alt="image-20210810223801721"></p>
</li>
</ul>
<h3 id="排查问题"><a href="#排查问题" class="headerlink" title="#排查问题"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#排查问题">#</a>排查问题</h3><ul>
<li>常见的防火墙问题：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 查看防火墙的运行状态</span><br>firewall-cmd --state<br><br>firewall-cmd --add-port=443/tcp --permanenet<br><br>firewall-cmd --reload<br></code></pre></td></tr></table></figure>
<ul>
<li>云服务商的放行策略：</li>
</ul>
<p>华为云示例：</p>
<p><img src="uniapp.assets/image-20210810221145314.e34347c6.png" alt="image-20210810221145314"></p>
<p>腾讯云：</p>
<p><img src="uniapp.assets/image-20210810221210594.0b72c5d5.png" alt="image-20210810221210594"></p>
<h3 id="小程序接口联调"><a href="#小程序接口联调" class="headerlink" title="#小程序接口联调"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#小程序接口联调">#</a>小程序接口联调</h3><ul>
<li><p>nginx启动之后，就可以访问<code>https://域名</code>了</p>
</li>
<li><p>导出测试数据库</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">exec</span> -it mongodb mongodump -u <span class="hljs-built_in">test</span> -d testdb -o /tmp/<br></code></pre></td></tr></table></figure>
<p>使用docker cp命令来复制目录：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">cp</span> &lt;容器<span class="hljs-built_in">id</span>&gt;:/tmp/testdb /tmp/本地目录<br></code></pre></td></tr></table></figure>
</li>
<li><p>导入数据库</p>
<p>上传上面的本地目录的文件到线上的服务器。</p>
<p>mongodb恢复数据库的命令：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">docker <span class="hljs-built_in">cp</span> /home/docker/testdb &lt;容器<span class="hljs-built_in">id</span>&gt;:/tmp/<br><br>docker <span class="hljs-built_in">exec</span> -it mongodb mongorestore -u <span class="hljs-built_in">test</span> -d testdb /tmp/testdb<br></code></pre></td></tr></table></figure>
<p><img src="uniapp.assets/image-20210810224430465.e62eb13b.png" alt="image-20210810224430465"></p>
</li>
</ul>
<p>请求测试：</p>
<p><img src="uniapp.assets/image-20210810224507919.89fa22dc.png" alt="image-20210810224507919"></p>
<ul>
<li><p>微信小程序配置安全域名</p>
<p>开发 -&gt; 开发设置 -&gt; 安全域名</p>
<p><img src="uniapp.assets/image-20210810224610237.4224a675.png" alt="image-20210810224610237"></p>
<p>添加域名：</p>
<p><img src="uniapp.assets/image-20210810224636162.9792e446.png" alt="image-20210810224636162"></p>
</li>
</ul>
<p>  下面即可以在微信开发者工具中进行测试了，取消<code>不校验合法域名</code>：</p>
<p>  <img src="uniapp.assets/image-20210810224714543.439e8328.png" alt="image-20210810224714543"></p>
<h1 id="订阅消息"><a href="#订阅消息" class="headerlink" title="#订阅消息"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#订阅消息">#</a>订阅消息</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="#介绍"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#介绍">#</a>介绍</h2><p>消息能力是小程序能力中的重要组成，我们为开发者提供了订阅消息能力，以便实现服务的闭环和更优的体验。</p>
<ul>
<li>订阅消息推送位置：服务通知</li>
<li>订阅消息下发条件：用户自主订阅</li>
<li>订阅消息卡片跳转能力：点击查看详情可跳转至该小程序的页面</li>
</ul>
<p><img src="uniapp.assets/request-subscribe-message.3851318e.3851318e.jpg" alt="intro"></p>
<h3 id="消息类型"><a href="#消息类型" class="headerlink" title="#消息类型"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#消息类型">#</a>消息类型</h3><p><strong>1. 一次性订阅消息</strong></p>
<p>一次性订阅消息用于解决用户使用小程序后，后续服务环节的通知问题。用户自主订阅后，开发者可<strong>不限时间</strong>地下发<strong>一条对应的服务消息</strong>；每条消息可单独订阅或退订。</p>
<p><strong>2. 长期订阅消息</strong></p>
<p>一次性订阅消息可满足小程序的大部分服务场景需求，但线下公共服务领域存在一次性订阅无法满足的场景，如航班延误，需根据航班实时动态来多次发送消息提醒。为便于服务，我们提供了长期性订阅消息，用户订阅一次后，开发者可长期下发多条消息。</p>
<p>目前长期性订阅消息仅向政务民生、医疗、交通、金融、教育等线下公共服务开放，后期将逐步支持到其他线下公共服务业务。</p>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="#使用步骤"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#使用步骤">#</a>使用步骤</h3><ul>
<li><p>步骤一：获取模板 ID</p>
<p>在微信公众平台手动配置获取模板 ID： 登录 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com (opens new window)</a>获取模板，如果没有合适的模板，可以申请添加新模板，审核通过后可使用。</p>
<p><img src="uniapp.assets/subscribe-message.b562750a.jpg" alt="intro"></p>
</li>
<li><p>步骤二：获取下发权限</p>
<p>详见小程序端消息订阅接口 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html">wx.requestSubscribeMessage(opens new window)</a></p>
</li>
<li><p>步骤三：调用接口下发订阅消息</p>
<p>详见服务端消息发送接口 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html">subscribeMessage.send(opens new window)</a></p>
<blockquote>
<p>注意事项：用户勾选 “总是保持以上选择，不再询问” 之后，下次订阅调用 wx.requestSubscribeMessage 不会弹窗，保持之前的选择，修改选择需要打开小程序设置进行修改。</p>
</blockquote>
</li>
</ul>
<h2 id="封装订阅消息工具js"><a href="#封装订阅消息工具js" class="headerlink" title="#封装订阅消息工具js"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#封装订阅消息工具js">#</a>封装订阅消息工具js</h2><p>作用：</p>
<ul>
<li>发起订阅请求；</li>
<li>判断用户是否开启了通知；</li>
<li>提示未开启通知的用户，并跳转设置页面；</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-title function_">default</span> (arr, cb, mute = <span class="hljs-literal">false</span>) =&gt; &#123;<br>  uni.<span class="hljs-title function_">requestSubscribeMessage</span>(&#123;<br>    <span class="hljs-attr">tmplIds</span>: arr.<span class="hljs-property">length</span> &gt; <span class="hljs-number">3</span> ? arr.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) : arr,<br>    <span class="hljs-comment">// 在调试工具中，无论订阅成功还是取消，都可以在complete取到状态</span><br>    <span class="hljs-comment">// 调试工具中，无法直接测试关闭订阅的状态</span><br>    <span class="hljs-comment">// 在真机上，可以获取用户拒绝订阅的状态</span><br>    <span class="hljs-comment">// 而且在complete部分可以获取到success/fail的回调内容</span><br>    <span class="hljs-attr">complete</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 2.1 如果用户未订阅，并未拒绝，正常发起订阅</span><br>      <span class="hljs-comment">// 2.2 如果用户拒绝了订阅，需要给用户一个轻提示 -&gt; 手动打开订阅消息的</span><br>      <span class="hljs-comment">// wx.openSetting</span><br>      <span class="hljs-keyword">if</span> (arr.<span class="hljs-title function_">includes</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> res[item] === <span class="hljs-string">&#x27;reject&#x27;</span>) || res.<span class="hljs-property">errCode</span> === <span class="hljs-number">20004</span>) &#123;<br>        uni.<span class="hljs-title function_">showModal</span>(&#123;<br>          <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;您关闭了订阅通知&#x27;</span>,<br>          <span class="hljs-attr">content</span>: <span class="hljs-string">&#x27;需要打开设置进行手动设置吗？&#x27;</span>,<br>          <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>            <span class="hljs-keyword">if</span> (res.<span class="hljs-property">confirm</span>) &#123;<br>              uni.<span class="hljs-title function_">openSetting</span>()<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res.<span class="hljs-property">cancel</span>) &#123;<br>              uni.<span class="hljs-title function_">showToast</span>(&#123;<br>                <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;error&#x27;</span>,<br>                <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;您取消了订阅&#x27;</span>,<br>                <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>              &#125;)<br>            &#125;<br>          &#125;<br>        &#125;)<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!arr.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> res[item] === <span class="hljs-string">&#x27;reject&#x27;</span>)) &#123;<br>        !mute &amp;&amp; uni.<span class="hljs-title function_">showToast</span>(&#123;<br>          <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>          <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;您已经订阅了该消息&#x27;</span>,<br>          <span class="hljs-attr">duration</span>: <span class="hljs-number">1500</span><br>        &#125;)<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res.<span class="hljs-property">errCode</span> === <span class="hljs-number">10002</span> || res.<span class="hljs-property">errCode</span> === <span class="hljs-number">10003</span>) &#123;<br>        uni.<span class="hljs-title function_">showToast</span>(&#123;<br>          <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;网络问题订阅失败，请重新订阅&#x27;</span>,<br>          <span class="hljs-attr">duration</span>: <span class="hljs-number">1500</span><br>        &#125;)<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 其他的逻辑 https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html</span><br>      &#125;<br>      cb &amp;&amp; <span class="hljs-title function_">cb</span>()<br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="前端主动订阅"><a href="#前端主动订阅" class="headerlink" title="#前端主动订阅"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#前端主动订阅">#</a>前端主动订阅</h2><p>在App.vue中添加判断用户订阅逻辑：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-attr">onLaunch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// console.warn(&#x27;当前组件仅支持 uni_modules 目录结构 ，请升级 HBuilderX 到 3.1.0 版本以上！&#x27;)</span><br>    <span class="hljs-comment">// console.log(&#x27;App Launch&#x27;)</span><br>    uni.<span class="hljs-title function_">getSetting</span>(&#123;<br>      <span class="hljs-attr">withSubscriptions</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">success</span>: <span class="hljs-title function_">async</span> (res) =&gt; &#123;<br>        <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">getApp</span>()<br>        app.<span class="hljs-property">globalData</span>.<span class="hljs-property">subscriptionsSetting</span> = res.<span class="hljs-property">subscriptionsSetting</span><br>        <span class="hljs-keyword">const</span> arr = [<br>          <span class="hljs-string">&#x27;S7zrpjN9Kq05-4ZG_nlTAYxnARMLWlSW09h54A2JCZo&#x27;</span>,<br>          <span class="hljs-string">&#x27;ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs&#x27;</span>,<br>          <span class="hljs-string">&#x27;FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA&#x27;</span>,<br>          <span class="hljs-string">&#x27;g9FFU43_deHRuez-2FcrASorTSITsJJPYx-GhzvHEIU&#x27;</span><br>        ]<br>        <span class="hljs-comment">// 1. 获取用户已经订阅的消息</span><br>        <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">itemSettings</span>: keys, mainSwitch &#125; = res.<span class="hljs-property">subscriptionsSetting</span><br>        <span class="hljs-comment">// 相当于用户未打开订阅开关</span><br>        <span class="hljs-keyword">if</span> (!mainSwitch) &#123;<br>          <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-comment">// 用户开启订阅消息 -&gt; 如果未设置任何消息</span><br>        <span class="hljs-keyword">if</span> (!keys) &#123;<br>          app.<span class="hljs-property">globalData</span>.<span class="hljs-property">tmplIds</span> = arr<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// 用户开启了订阅消息 -&gt; 已经有部分订阅 -&gt; reject, accept</span><br>          <span class="hljs-keyword">const</span> keysArr = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(keys)<br>          app.<span class="hljs-property">globalData</span>.<span class="hljs-property">tmplIds</span> = arr.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> keysArr.<span class="hljs-title function_">indexOf</span>(item) === -<span class="hljs-number">1</span>)<br>        &#125;<br>      &#125;<br>    &#125;)<br>  &#125;,<br>  <span class="hljs-attr">onShow</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;App Show&#x27;</span>)<br>  &#125;,<br>  <span class="hljs-attr">onHide</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;App Hide&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在需要订阅的位置，加入订阅逻辑，比如在个人中心中，点击去登录时：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> sub <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/common/utils/subscribe&#x27;</span><br><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">getApp</span>()<br><span class="hljs-keyword">const</span> tmplIds = app.<span class="hljs-property">globalData</span>.<span class="hljs-property">tmplIds</span> || []<br><span class="hljs-title function_">sub</span>(tmplIds.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>), <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isLogin</span>) &#123;<br>    uni.<span class="hljs-title function_">navigateTo</span>(&#123;<br>      <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/subcom-pkg/auth/auth&#x27;</span><br>    &#125;)<br>  &#125;<br>&#125;, <span class="hljs-literal">true</span>)<br></code></pre></td></tr></table></figure>
<blockquote>
<p>注意：订阅消息一次最多只可以订阅3条，所以需要加入一个splice方法截断未订阅的消息。</p>
<p>也可以自己在指定的业务部分，给<code>sub</code>方法，传递指定的模板ID。</p>
</blockquote>
<h2 id="订阅消息模板API"><a href="#订阅消息模板API" class="headerlink" title="#订阅消息模板API"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#订阅消息模板api">#</a>订阅消息模板API</h2><p>应用场景：</p>
<ul>
<li>后台控制哪些消息可以被订阅；</li>
<li>当模板消息的id发生了变化时，如果保证订阅的准确性；</li>
</ul>
<p>前端请求模板API：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取模板id</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getSubIds</span> = (<span class="hljs-params"></span>) =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/public/subids&#x27;</span>)<br></code></pre></td></tr></table></figure>
<p>调整App.vue中的模板IDs的判断逻辑，处理：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 模板ID</span><br><span class="hljs-comment">// 改装成一个API接口 -&gt; key:value -&gt; value, key -&gt; 业务场景</span><br><span class="hljs-keyword">const</span> &#123; code, data &#125; = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">getSubIds</span>()<br><span class="hljs-keyword">let</span> arr<br><span class="hljs-keyword">if</span> (code === <span class="hljs-number">200</span>) &#123;<br>  <span class="hljs-comment">// &#123;key: value, key1: value1&#125; =&gt; [value, value1]</span><br>  arr = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(data).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">o</span> =&gt;</span> o[<span class="hljs-number">1</span>])<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// 默认的前端模板数据</span><br>  arr = [<br>    <span class="hljs-string">&#x27;S7zrpjN9Kq05-4ZG_nlTAYxnARMLWlSW09h54A2JCZo&#x27;</span>,<br>    <span class="hljs-string">&#x27;ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs&#x27;</span>,<br>    <span class="hljs-string">&#x27;FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA&#x27;</span>,<br>    <span class="hljs-string">&#x27;g9FFU43_deHRuez-2FcrASorTSITsJJPYx-GhzvHEIU&#x27;</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>
<p>后端创建路由与接口：</p>
<p>路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取微信模板id</span><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/subids&#x27;</span>, publicController.<span class="hljs-property">getSubIds</span>)<br></code></pre></td></tr></table></figure>
<p>接口：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">getSubIds</span> (ctx) &#123;<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">data</span>: config.<span class="hljs-property">subIds</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="维护accessToken"><a href="#维护accessToken" class="headerlink" title="#维护accessToken"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#维护accesstoken">#</a>维护accessToken</h2><p>后端发送订阅消息需要accessToken：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-variable constant_">POST</span> <span class="hljs-attr">https</span>:<span class="hljs-comment">//api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN</span><br></code></pre></td></tr></table></figure>
<p>见官方文档：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html">链接(opens new window)</a></p>
<p>由于acessToken的有效时间是2小时，而且每天微信请求的限制为2000次（<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/API_Call_Limits.html">链接 (opens new window)</a>），如下图：</p>
<p><img src="uniapp.assets/image-20210812102933432.90192975.png" alt="image-20210812102933432"></p>
<p>所以，需要自己定时维护accessToken：</p>
<ul>
<li><p>创建<code>wxGetAccessToken</code>方法：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> log4js <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/config/Log4j&#x27;</span><br><span class="hljs-keyword">const</span> logger = log4js.<span class="hljs-title function_">getLogger</span>(<span class="hljs-string">&#x27;error&#x27;</span>)<br><span class="hljs-keyword">import</span> &#123; getValue, setValue &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/config/RedisConfig&#x27;</span><br><br><span class="hljs-comment">// flag 强制刷新，默认false - 不强制刷新</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxGetAccessToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">flag = <span class="hljs-literal">false</span></span>) =&gt; &#123;<br>  <span class="hljs-comment">// https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=APPID&amp;secret=APPSECRET</span><br>  <span class="hljs-comment">// 1.判断redis中是否有accessToken</span><br>  <span class="hljs-comment">// 2.有 &amp; flag -&gt; 则直接返回</span><br>  <span class="hljs-comment">// 3.没有 -&gt; 请求新的token</span><br>  <span class="hljs-keyword">let</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-string">&#x27;accessToken&#x27;</span>)<br>  <span class="hljs-keyword">if</span> (!accessToken || flag) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">get</span>(<span class="hljs-string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=<span class="hljs-subst">$&#123;config.AppID&#125;</span>&amp;secret=<span class="hljs-subst">$&#123;config.AppSecret&#125;</span>`</span>)<br>      <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: WxUtils.js ~ line 60 ~ wxGetAccessToken ~ result&#x27;, result)</span><br>      <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) &#123;<br>        <span class="hljs-keyword">await</span> <span class="hljs-title function_">setValue</span>(<span class="hljs-string">&#x27;accessToken&#x27;</span>, result.<span class="hljs-property">data</span>.<span class="hljs-property">access_token</span>, result.<span class="hljs-property">data</span>.<span class="hljs-property">expires_in</span>)<br>        accessToken = result.<span class="hljs-property">data</span>.<span class="hljs-property">access_token</span><br>        <span class="hljs-keyword">if</span> (result.<span class="hljs-property">data</span>.<span class="hljs-property">errcode</span> &amp;&amp; result.<span class="hljs-property">data</span>.<span class="hljs-property">errmsg</span>) &#123;<br>          logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`wxGetAccessToken error<span class="hljs-subst">$&#123;result.data.errcode&#125;</span> - <span class="hljs-subst">$&#123;result.data.errmsg&#125;</span>`</span>)<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`wxGetAccessToken error: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>)<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> accessToken<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>安装依赖<code>npm i cron</code></p>
</li>
<li><p>配置定时任务：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 每隔7200秒执行一次 刷新accessToken</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">CronJob</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cron&#x27;</span><br><span class="hljs-keyword">import</span> &#123; wxGetAccessToken &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./WxUtils&#x27;</span><br><br><span class="hljs-comment">// Seconds: 0-59</span><br><span class="hljs-comment">// Minutes: 0-59</span><br><span class="hljs-comment">// Hours: 0-23</span><br><span class="hljs-comment">// Day of Month: 1-31</span><br><span class="hljs-comment">// Months: 0-11 (Jan-Dec)</span><br><span class="hljs-comment">// Day of Week: 0-6 (Sun-Sat)</span><br><br><span class="hljs-keyword">const</span> job = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CronJob</span>(<span class="hljs-string">&#x27;* * */1 * * *&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">wxGetAccessToken</span>(<span class="hljs-literal">true</span>)<br>&#125;)<br><br>job.<span class="hljs-title function_">start</span>()<br></code></pre></td></tr></table></figure>
</li>
<li><p>在入口文件处理，添加该文件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./common/Cron&#x27;</span><br></code></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>常见问题，如果不小心accessToken请求超限怎么办：</strong></p>
<p><img src="uniapp.assets/0.a36c9ed1.png" alt="img"></p>
<h2 id="后台发送订阅消息"><a href="#后台发送订阅消息" class="headerlink" title="#后台发送订阅消息"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#后台发送订阅消息">#</a>后台发送订阅消息</h2><p>发送订阅消息：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html">官方文档(opens new window)</a></p>
<p>调用方式：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-http">HTTPS 调用(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-cloud">云调用(opens new window)</a></li>
</ul>
<h3 id="HTTPS调用接口说明"><a href="#HTTPS调用接口说明" class="headerlink" title="#HTTPS调用接口说明"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#https调用接口说明">#</a>HTTPS调用接口说明</h3><figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN<br></code></pre></td></tr></table></figure>
<p><strong>请求参数：</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">必填</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">access_token / cloudbase_access_token</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left"><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html">接口调用凭证(opens new window)</a></td>
</tr>
<tr>
<td style="text-align:left">touser</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">接收者（用户）的 openid</td>
</tr>
<tr>
<td style="text-align:left">template_id</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">所需下发的订阅模板id</td>
</tr>
<tr>
<td style="text-align:left">page</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">否</td>
<td style="text-align:left">点击模板卡片后的跳转页面，仅限本小程序内的页面。支持带参数,（示例index?foo=bar）。该字段不填则模板无跳转。</td>
</tr>
<tr>
<td style="text-align:left">data</td>
<td style="text-align:left">Object</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">模板内容，格式形如 { “key1”: { “value”: any }, “key2”: { “value”: any } }</td>
</tr>
<tr>
<td style="text-align:left">miniprogram_state</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">否</td>
<td style="text-align:left">跳转小程序类型：developer为开发版；trial为体验版；formal为正式版；默认为正式版</td>
</tr>
<tr>
<td style="text-align:left">lang</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">否</td>
<td style="text-align:left">进入小程序查看”的语言类型，支持zh_CN(简体中文)、en_US(英文)、zh_HK(繁体中文)、zh_TW(繁体中文)，默认为zh_CN</td>
</tr>
</tbody>
</table>
<p><strong>说明一下关于<code>data</code>：</strong></p>
<p>例如，模板的内容为</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">姓名: &#123;&#123;name01.DATA&#125;&#125;<br>金额: &#123;&#123;amount01.DATA&#125;&#125;<br>行程: &#123;&#123;thing01.DATA&#125;&#125;<br>日期: &#123;&#123;date01.DATA&#125;&#125;<br></code></pre></td></tr></table></figure>
<p>则对应的json为</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;touser&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;OPENID&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;template_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;TEMPLATE_ID&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;page&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;index&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;name01&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;某某&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;amount01&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;￥100&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;thing01&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;广州至北京&quot;</span><br>      <span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;date01&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2018-01-01&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>这里的data有内容限制（举例如下表），更多查看官方文档详情：</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数类别</th>
<th style="text-align:left">参数说明</th>
<th style="text-align:left">参数值限制</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">thing.DATA</td>
<td style="text-align:left">事物</td>
<td style="text-align:left">20个以内字符</td>
<td style="text-align:left">可汉字、数字、字母或符号组合</td>
</tr>
<tr>
<td style="text-align:left">number.DATA</td>
<td style="text-align:left">数字</td>
<td style="text-align:left">32位以内数字</td>
<td style="text-align:left">只能数字，可带小数</td>
</tr>
<tr>
<td style="text-align:left">letter.DATA</td>
<td style="text-align:left">字母</td>
<td style="text-align:left">32位以内字母</td>
<td style="text-align:left">只能字母</td>
</tr>
<tr>
<td style="text-align:left">symbol.DATA</td>
<td style="text-align:left">符号</td>
<td style="text-align:left">5位以内符号</td>
<td style="text-align:left">只能符号</td>
</tr>
<tr>
<td style="text-align:left">character_string.DATA</td>
<td style="text-align:left">字符串</td>
<td style="text-align:left">32位以内数字、字母或符号</td>
<td style="text-align:left">可数字、字母或符号组合</td>
</tr>
<tr>
<td style="text-align:left">time.DATA</td>
<td style="text-align:left">时间</td>
<td style="text-align:left">24小时制时间格式（支持+年月日），支持填时间段，两个时间点之间用“~”符号连接</td>
<td style="text-align:left">例如：15:01，或：2019年10月1日 15:01</td>
</tr>
<tr>
<td style="text-align:left">date.DATA</td>
<td style="text-align:left">日期</td>
<td style="text-align:left">年月日格式（支持+24小时制时间），支持填时间段，两个时间点之间用“~”符号连接</td>
<td style="text-align:left">例如：2019年10月1日，或：2019年10月1日 15:01</td>
</tr>
<tr>
<td style="text-align:left">amount.DATA</td>
<td style="text-align:left">金额</td>
<td style="text-align:left">1个币种符号+10位以内纯数字，可带小数，结尾可带“元”</td>
<td style="text-align:left">可带小数</td>
</tr>
<tr>
<td style="text-align:left">phone_number.DATA</td>
<td style="text-align:left">电话</td>
<td style="text-align:left">17位以内，数字、符号</td>
<td style="text-align:left">电话号码，例：+86-0766-66888866</td>
</tr>
<tr>
<td style="text-align:left">car_number.DATA</td>
<td style="text-align:left">车牌</td>
<td style="text-align:left">8位以内，第一位与最后一位可为汉字，其余为字母或数字</td>
<td style="text-align:left">车牌号码：粤A8Z888挂</td>
</tr>
<tr>
<td style="text-align:left">name.DATA</td>
<td style="text-align:left">姓名</td>
<td style="text-align:left">10个以内纯汉字或20个以内纯字母或符号</td>
<td style="text-align:left">中文名10个汉字内；纯英文名20个字母内；中文和字母混合按中文名算，10个字内</td>
</tr>
<tr>
<td style="text-align:left">phrase.DATA</td>
<td style="text-align:left">汉字</td>
<td style="text-align:left">5个以内汉字</td>
<td style="text-align:left">5个以内纯汉字，例如：配送中</td>
</tr>
</tbody>
</table>
<p>返回的 JSON 数据包</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">errcode</td>
<td style="text-align:left">number</td>
<td style="text-align:left">错误码</td>
</tr>
<tr>
<td style="text-align:left">errmsg</td>
<td style="text-align:left">string</td>
<td style="text-align:left">错误信息</td>
</tr>
</tbody>
</table>
<p><strong>errcode 的合法值</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">40003</td>
<td style="text-align:left">touser字段openid为空或者不正确</td>
</tr>
<tr>
<td style="text-align:left">40037</td>
<td style="text-align:left">订阅模板id为空不正确</td>
</tr>
<tr>
<td style="text-align:left">43101</td>
<td style="text-align:left">用户拒绝接受消息，如果用户之前曾经订阅过，则表示用户取消了订阅关系</td>
</tr>
<tr>
<td style="text-align:left">47003</td>
<td style="text-align:left">模板参数不准确，可能为空或者不满足规则，errmsg会提示具体是哪个字段出错</td>
</tr>
<tr>
<td style="text-align:left">41030</td>
<td style="text-align:left">page路径不正确，需要保证在现网版本小程序中存在，与app.json保持一致</td>
</tr>
</tbody>
</table>
<h3 id="创建发送消息工具js"><a href="#创建发送消息工具js" class="headerlink" title="#创建发送消息工具js"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#创建发送消息工具js">#</a>创建发送消息工具js</h3><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxSendMessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">options</span>) =&gt; &#123;<br>  <span class="hljs-comment">// POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN</span><br>  <span class="hljs-keyword">let</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetAccessToken</span>()<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(<span class="hljs-string">`https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=<span class="hljs-subst">$&#123;accessToken&#125;</span>`</span>, options)<br>    <span class="hljs-keyword">return</span> data<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`wxSendMessage error: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>举例：</p>
<p>在用户登录之后，发送订阅消息通知：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 推送消息</span><br><span class="hljs-comment">// 字段限制：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html</span><br><span class="hljs-keyword">const</span> notify = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxSendMessage</span>(&#123;<br>  <span class="hljs-attr">touser</span>: tmpUser.<span class="hljs-property">openid</span>,<br>  <span class="hljs-attr">template_id</span>: <span class="hljs-string">&#x27;FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA&#x27;</span>,<br>  <span class="hljs-attr">data</span>: &#123;<br>    <span class="hljs-attr">phrase1</span>: &#123;<br>      <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;登录安全&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">date2</span>: &#123;<br>      <span class="hljs-attr">value</span>: <span class="hljs-title function_">moment</span>().<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY年MM月DD HH:mm&#x27;</span>)<br>    &#125;,<br>    <span class="hljs-attr">thing4</span>: &#123;<br>      <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;通过微信授权登录成功，请注意信息安全&#x27;</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">miniprogram_state</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span> ? <span class="hljs-string">&#x27;developer&#x27;</span> : <span class="hljs-string">&#x27;formal&#x27;</span><br>&#125;)<br></code></pre></td></tr></table></figure>
<h2 id="前后端联调"><a href="#前后端联调" class="headerlink" title="#前后端联调"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/08-订阅消息.html#前后端联调">#</a>前后端联调</h2><p>联调需要注意的点：</p>
<ul>
<li>设置<code>miniprogram_state</code>属性；</li>
<li>使用真机进行调试 -&gt; 配置局域网的访问的IP -&gt; 让电脑与手机处于同一个网段；</li>
<li>检查发送订阅消息的数据格式、模板id、用户openid数据是否正确；</li>
<li>使用单步调试：发送订阅消息的接口，查看返回的errcode如果是0，说明发送成功；如果失败，则根据errcode来调整程序代码；</li>
</ul>
<p><img src="uniapp.assets/image-20210812111502555.6ac23418.png" alt="image-20210812111502555"></p>
<h1 id="内容安全"><a href="#内容安全" class="headerlink" title="#内容安全"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#内容安全">#</a>内容安全</h1><h2 id="微信安全检测"><a href="#微信安全检测" class="headerlink" title="#微信安全检测"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#微信安全检测">#</a>微信安全检测</h2><p>微信官方提供了可疑用户与危险接口的检查：</p>
<p><img src="uniapp.assets/image-20210815144637652.605489b5.png" alt="image-20210815144637652"></p>
<p>接口安全扫描：</p>
<p><img src="uniapp.assets/image-20210815144649621.30fc62ba.png" alt="image-20210815144649621"></p>
<p>这两个功能在后台即可操作，平坦可以交由运营小姐姐来进行操作一下。</p>
<h2 id="第三方内容安全推荐"><a href="#第三方内容安全推荐" class="headerlink" title="#第三方内容安全推荐"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#第三方内容安全推荐">#</a>第三方内容安全推荐</h2><ul>
<li>各家云服务商：<a target="_blank" rel="noopener" href="https://www.aliyun.com/product/lvwang">云盾 (opens new window)</a>(阿里)，<a target="_blank" rel="noopener" href="https://dun.163.com/">易盾 (opens new window)</a>(网易)，<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/tms">天御 (opens new window)</a>(腾讯)</li>
<li>第三方：<a target="_blank" rel="noopener" href="https://www.tuputech.com/text_moderation">图普 (opens new window)</a>、国信网安、<a target="_blank" rel="noopener" href="https://www.vanwei.com.cn/main/tq">梵为科技(opens new window)</a></li>
</ul>
<h2 id="文本内容安全"><a href="#文本内容安全" class="headerlink" title="#文本内容安全"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#文本内容安全">#</a>文本内容安全</h2><h3 id="整体思路"><a href="#整体思路" class="headerlink" title="#整体思路"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#整体思路">#</a>整体思路</h3><ul>
<li>下载网络上的一些敏感词的数据库，使用正则进行匹配过滤一次，减少成本；</li>
<li>使用官方的限额的api对文本进行查验；</li>
<li>使用第三方的api对内容进行查验；</li>
</ul>
<h3 id="官方介绍"><a href="#官方介绍" class="headerlink" title="#官方介绍"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#官方介绍">#</a>官方介绍</h3><p>检查一段文本是否含有违法违规内容，下面介绍的接口：<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html">官方链接(opens new window)</a></p>
<p>1.0 版本接口文档<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck-v1.html">【点击查看】(opens new window)</a></p>
<p>应用场景举例：</p>
<ol>
<li>用户个人资料违规文字检测；</li>
<li>媒体新闻类用户发表文章，评论内容检测；</li>
<li>游戏类用户编辑上传的素材(如答题类小游戏用户上传的问题及答案)检测等。 *频率限制：单个 appId 调用上限为 4000 次/分钟，2,000,000 次/天**</li>
</ol>
<p>调用方式：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html#method-http">HTTPS 调用(opens new window)</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html#method-cloud">云调用(opens new window)</a></li>
</ul>
<h3 id="工具js封装"><a href="#工具js封装" class="headerlink" title="#工具js封装"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#工具js封装">#</a>工具js封装</h3><p>请求地址</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">POST https://api.weixin.qq.com/wxa/msg_sec_check?access_token=ACCESS_TOKEN<br></code></pre></td></tr></table></figure>
<p>请求参数</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">必填</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">access_token / cloudbase_access_token</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left"><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html">接口调用凭证(opens new window)</a></td>
</tr>
<tr>
<td style="text-align:left">version</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">接口版本号，2.0版本为固定值2</td>
</tr>
<tr>
<td style="text-align:left">openid</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">用户的openid（用户需在近两小时访问过小程序）</td>
</tr>
<tr>
<td style="text-align:left">scene</td>
<td style="text-align:left">number</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">场景枚举值（1 资料；2 评论；3 论坛；4 社交日志）</td>
</tr>
<tr>
<td style="text-align:left">content</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">需检测的文本内容，文本字数的上限为2500字</td>
</tr>
<tr>
<td style="text-align:left">nickname</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">否</td>
<td style="text-align:left">用户昵称</td>
</tr>
<tr>
<td style="text-align:left">title</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">否</td>
<td style="text-align:left">文本标题</td>
</tr>
<tr>
<td style="text-align:left">signature</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">否</td>
<td style="text-align:left">个性签名，该参数仅在资料类场景有效(scene=1)</td>
</tr>
</tbody>
</table>
<p>返回的 JSON 数据包</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">errcode</td>
<td style="text-align:left">number</td>
<td style="text-align:left">错误码</td>
</tr>
<tr>
<td style="text-align:left">errmsg</td>
<td style="text-align:left">string</td>
<td style="text-align:left">错误信息</td>
</tr>
<tr>
<td style="text-align:left">trace_id</td>
<td style="text-align:left">string</td>
<td style="text-align:left">唯一请求标识，标记单次请求</td>
</tr>
<tr>
<td style="text-align:left">result</td>
<td style="text-align:left">object</td>
<td style="text-align:left">综合结果</td>
</tr>
<tr>
<td style="text-align:left">detail</td>
<td style="text-align:left">array</td>
<td style="text-align:left">详细检测结果</td>
</tr>
</tbody>
</table>
<p>逻辑：</p>
<ul>
<li>用户只用传文本内容，其他的openid等信息可以不传，设置一个默认值，方便其他的平台使用；</li>
<li>使用正则匹配掉一些无用的内容；</li>
<li>长度判断，分2500词进行多次判断；</li>
<li>判断结果非pass的全部进入risky部分；</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 文本内容安全</span><br><span class="hljs-comment">// content - 内容</span><br><span class="hljs-comment">// title - 标题 可选</span><br><span class="hljs-comment">// signature - 签名 也是可选</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxMsgCheck</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">content, &#123;</span><br><span class="hljs-params">  user: &#123;</span><br><span class="hljs-params">    openid,</span><br><span class="hljs-params">    name: nickname,</span><br><span class="hljs-params">    remark: signature</span><br><span class="hljs-params">  &#125;,</span><br><span class="hljs-params">  scene,</span><br><span class="hljs-params">  title</span><br><span class="hljs-params">&#125; = &#123;</span><br><span class="hljs-params">  user: &#123;&#125;,</span><br><span class="hljs-params">  scene: <span class="hljs-number">3</span>,</span><br><span class="hljs-params">  title: <span class="hljs-string">&#x27;&#x27;</span></span><br><span class="hljs-params">&#125;</span>) =&gt; &#123;<br>  <span class="hljs-comment">// POST https://api.weixin.qq.com/wxa/msg_sec_check?access_token=ACCESS_TOKEN</span><br>  <span class="hljs-keyword">let</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetAccessToken</span>()<br>  <span class="hljs-keyword">let</span> res<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 1.过滤掉一些如Html，自定义的标签内容</span><br>    content = content.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&lt;[^&gt;]+&gt;/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\sface\[\S&#123;1,&#125;]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/img\[\S+\]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\sa\(\S+\]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\[\/?quote\]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\[\/?pre\]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\[\/?hr\]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[\r\n|\n|\s]/g</span>, <span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-comment">// 2.如果content内容超过了2500词，需要进行分段处理</span><br>    <span class="hljs-keyword">if</span> (content.<span class="hljs-property">length</span> &gt; <span class="hljs-number">2500</span>) &#123;<br>      <span class="hljs-comment">// 分段 —&gt; arr -&gt; method1: for , method2: reg</span><br>      <span class="hljs-keyword">let</span> arr = content.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[\s\S]&#123;1,2500&#125;/g</span>) || []<br>      <span class="hljs-comment">// 多次请求接口</span><br>      <span class="hljs-keyword">let</span> mulResult = []<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) &#123;<br>        <span class="hljs-comment">// 获取所有接口的返回结果 -&gt; 结果判断 -&gt; 返回</span><br>        res = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(<span class="hljs-string">`https://api.weixin.qq.com/wxa/msg_sec_check?access_token=<span class="hljs-subst">$&#123;accessToken&#125;</span>`</span>, &#123;<br>          <span class="hljs-attr">version</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">openid</span>: openid || <span class="hljs-string">&#x27;ooTjn5YPpogMWLtEQ_PxyUJkIp2I&#x27;</span>,<br>          scene,<br>          <span class="hljs-attr">content</span>: arr[i],<br>          <span class="hljs-attr">nickname</span>: nickname,<br>          title,<br>          <span class="hljs-attr">signature</span>: scene === <span class="hljs-number">1</span> ? signature : <span class="hljs-literal">null</span><br>        &#125;)<br>        mulResult.<span class="hljs-title function_">push</span>(res)<br>      &#125;<br>      <span class="hljs-comment">// 判断mulResult</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mulResult)<br>      <span class="hljs-keyword">const</span> arrTemp = mulResult.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">const</span> &#123; status, <span class="hljs-attr">data</span>: &#123; errcode, result &#125; &#125; = item<br>        <span class="hljs-keyword">return</span> status !== <span class="hljs-number">200</span> || errcode !== <span class="hljs-number">0</span> || (result &amp;&amp; result.<span class="hljs-property">suggest</span> !== <span class="hljs-string">&#x27;pass&#x27;</span>)<br>      &#125;)<br>      <span class="hljs-keyword">return</span> !(arrTemp.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>)<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      res = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(<span class="hljs-string">`https://api.weixin.qq.com/wxa/msg_sec_check?access_token=<span class="hljs-subst">$&#123;accessToken&#125;</span>`</span>, &#123;<br>        <span class="hljs-attr">version</span>: <span class="hljs-number">2</span>,<br>        <span class="hljs-attr">openid</span>: openid || <span class="hljs-string">&#x27;ooTjn5YPpogMWLtEQ_PxyUJkIp2I&#x27;</span>,<br>        scene,<br>        content,<br>        <span class="hljs-attr">nickname</span>: nickname,<br>        title,<br>        <span class="hljs-attr">signature</span>: scene === <span class="hljs-number">1</span> ? signature : <span class="hljs-literal">null</span><br>      &#125;)<br>      <span class="hljs-keyword">const</span> &#123; status, <span class="hljs-attr">data</span>: &#123; errcode, result &#125; &#125; = res<br>      <span class="hljs-keyword">return</span> status === <span class="hljs-number">200</span> &amp;&amp; errcode === <span class="hljs-number">0</span> &amp;&amp; result &amp;&amp; result.<span class="hljs-property">suggest</span> === <span class="hljs-string">&#x27;pass&#x27;</span><br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`wxMsgCheck error: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="自定义安全敏感词汇"><a href="#自定义安全敏感词汇" class="headerlink" title="#自定义安全敏感词汇"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#自定义安全敏感词汇">#</a>自定义安全敏感词汇</h3><p>在小程序管理后台，开发管理 -&gt; 安全中心 -&gt; 内容风控：</p>
<p><img src="uniapp.assets/image-20210815144815314.0bc0ee08.png" alt="image-20210815144815314"></p>
<blockquote>
<p>在这里添加的分值越高，越可能被屏蔽。</p>
</blockquote>
<h3 id="测试接口工具js"><a href="#测试接口工具js" class="headerlink" title="#测试接口工具js"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#测试接口工具js">#</a>测试接口工具js</h3><ul>
<li><p>加入accessToken失效判断</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">async</span> (res) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; data &#125; = res<br>  <span class="hljs-keyword">if</span> (data.<span class="hljs-property">errcode</span> === <span class="hljs-number">40001</span>) &#123;<br>    <span class="hljs-comment">// 重新获取新的accessToken</span><br>    <span class="hljs-keyword">const</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetAccessToken</span>(<span class="hljs-literal">true</span>)<br>    <span class="hljs-keyword">const</span> &#123; url &#125; = res.<span class="hljs-property">config</span><br>    <span class="hljs-comment">// 重新发起请求 -&gt; res</span><br>    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&#x27;access_token&#x27;</span>) !== -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">const</span> arr = url.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;?&#x27;</span>) <span class="hljs-comment">// ?key=value&amp;key1=value1... -&gt; [&#x27;域名&#x27;, &#x27;key=value&amp;key1=value1...&#x27;]</span><br>      <span class="hljs-keyword">const</span> params = qs.<span class="hljs-title function_">parse</span>(arr[<span class="hljs-number">1</span>])<br>      <span class="hljs-keyword">const</span> newParams = &#123;<br>        ...params,<br>        <span class="hljs-attr">access_token</span>: accessToken<br>      &#125;<br>      <span class="hljs-keyword">const</span> newUrl = arr[<span class="hljs-number">0</span>] + <span class="hljs-string">&#x27;?&#x27;</span> + qs.<span class="hljs-title function_">stringify</span>(newParams)<br>      <span class="hljs-keyword">const</span> config = &#123; ...res.<span class="hljs-property">config</span>, <span class="hljs-attr">url</span>: newUrl &#125;<br>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">axios</span>(config)<br>      <span class="hljs-keyword">return</span> result<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> res<br>&#125;)<br></code></pre></td></tr></table></figure>
</li>
<li><p>有风险的词汇：</p>
<p><img src="uniapp.assets/image-20210815151921140.02b4ac8e.png" alt="image-20210815151921140"></p>
</li>
</ul>
<h2 id="图片内容安全"><a href="#图片内容安全" class="headerlink" title="#图片内容安全"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#图片内容安全">#</a>图片内容安全</h2><h3 id="整体思路-1"><a href="#整体思路-1" class="headerlink" title="#整体思路"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#整体思路-2">#</a>整体思路</h3><ul>
<li>图片上传之后，创建tmp目录（使用<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/make-dir">make-dir (opens new window)</a>），获取图片的基本信息；</li>
<li>判断图片的尺寸，如果超过了微信接口的分辨率要求750x1336，那需要使用<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/sharp">sharp (opens new window)</a>来进行压缩;</li>
<li>nodejs侧对接微信接口需要使用formData数据类型，所以还需要安装<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/form-data">form-data(opens new window)</a></li>
<li>最后还需要删除临时文件，使用<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/del">del (opens new window)</a>库，删除之前使用<a target="_blank" rel="noopener" href="https://nodejs.org/api/fs.html#fs_fs_accesssync_path_mode">fs.access (opens new window)</a>进行判断</li>
</ul>
<h3 id="官方介绍-1"><a href="#官方介绍-1" class="headerlink" title="#官方介绍"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#官方介绍-2">#</a>官方介绍</h3><p>请求地址</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">POST https://api.weixin.qq.com/wxa/img_sec_check?access_token=ACCESS_TOKEN<br></code></pre></td></tr></table></figure>
<p>请求参数</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">必填</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">access_token / cloudbase_access_token</td>
<td style="text-align:left">string</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left"><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html">接口调用凭证(opens new window)</a></td>
</tr>
<tr>
<td style="text-align:left">media</td>
<td style="text-align:left">FormData</td>
<td style="text-align:left"></td>
<td style="text-align:left">是</td>
<td style="text-align:left">要检测的图片文件，格式支持PNG、JPEG、JPG、GIF，图片尺寸不超过 750px x 1334px</td>
</tr>
</tbody>
</table>
<p>返回的 JSON 数据包</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">errcode</td>
<td style="text-align:left">number</td>
<td style="text-align:left">错误码</td>
</tr>
<tr>
<td style="text-align:left">errmsg</td>
<td style="text-align:left">string</td>
<td style="text-align:left">错误信息</td>
</tr>
</tbody>
</table>
<p><strong>errcode 的合法值</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">值</th>
<th style="text-align:left">说明</th>
<th style="text-align:left">最低版本</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0</td>
<td style="text-align:left">内容正常</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">87014</td>
<td style="text-align:left">内容可能潜在风险</td>
</tr>
</tbody>
</table>
<h3 id="工具js封装-1"><a href="#工具js封装-1" class="headerlink" title="#工具js封装"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#工具js封装-2">#</a>工具js封装</h3><p>安装依赖：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">npm i make-dir form-date sharp del<br></code></pre></td></tr></table></figure>
<p>其中<a target="_blank" rel="noopener" href="https://sharp.pixelplumbing.com/">sharp (opens new window)</a>需要配置加速：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><code class="hljs sh">npm config <span class="hljs-built_in">set</span> sharp_binary_host <span class="hljs-string">&quot;https://npm.taobao.org/mirrors/sharp&quot;</span><br>npm config <span class="hljs-built_in">set</span> sharp_libvips_binary_host <span class="hljs-string">&quot;https://npm.taobao.org/mirrors/sharp-libvips&quot;</span><br></code></pre></td></tr></table></figure>
<p>工具js：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 获取头部属性</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getHeaders</span> = (<span class="hljs-params">form</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    form.<span class="hljs-title function_">getLength</span>(<span class="hljs-function">(<span class="hljs-params">err, length</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) &#123;<br>        <span class="hljs-title function_">reject</span>(err)<br>      &#125;<br>      <span class="hljs-keyword">const</span> headers = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;<br>        <span class="hljs-string">&#x27;Content-Length&#x27;</span>: length<br>      &#125;, form.<span class="hljs-title function_">getHeaders</span>())<br>      <span class="hljs-title function_">resolve</span>(headers)<br>    &#125;)<br>  &#125;)<br>&#125;<br><br><span class="hljs-comment">// 删除文件</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkAndDelFile</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">path</span>) =&gt; &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-title function_">accessSync</span>(path, constants.<span class="hljs-property">R_OK</span> | constants.<span class="hljs-property">W_OK</span>)<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">del</span>(path)<br>  &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>    <span class="hljs-comment">// console.error(&#x27;no access!&#x27;)</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 图片内容安全</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxImgCheck</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">file</span>) =&gt; &#123;<br>  <span class="hljs-comment">// POST https://api.weixin.qq.com/wxa/img_sec_check?access_token=ACCESS_TOKEN</span><br>  <span class="hljs-keyword">const</span> accessToken = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxGetAccessToken</span>()<br>  <span class="hljs-comment">// 1.保证图片 -&gt; 判断分辨率 -&gt; sharp 750 * 1334</span><br>  <span class="hljs-keyword">let</span> newPath = file.<span class="hljs-property">path</span><br>  <span class="hljs-keyword">const</span> tmpPath = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;./tmp&#x27;</span>)<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> img = <span class="hljs-title function_">sharp</span>(newPath)<br>    <span class="hljs-keyword">const</span> meta = <span class="hljs-keyword">await</span> img.<span class="hljs-title function_">metadata</span>()<br>    <span class="hljs-keyword">if</span> (meta.<span class="hljs-property">width</span> &gt; <span class="hljs-number">750</span> || meta.<span class="hljs-property">height</span> &gt; <span class="hljs-number">1334</span>) &#123;<br>      <span class="hljs-comment">// 判断临时路径是否存在，并创建</span><br>      <span class="hljs-keyword">await</span> <span class="hljs-title function_">mkdir</span>(tmpPath)<br>      <span class="hljs-comment">// uuid -&gt; 指定临时的文件名称</span><br>      newPath = path.<span class="hljs-title function_">join</span>(tmpPath, <span class="hljs-title function_">uuidv4</span>() + path.<span class="hljs-title function_">extname</span>(newPath) || <span class="hljs-string">&#x27;.jpg&#x27;</span>)<br>      <span class="hljs-keyword">await</span> img.<span class="hljs-title function_">resize</span>(<span class="hljs-number">750</span>, <span class="hljs-number">1334</span>, &#123;<br>        <span class="hljs-attr">fit</span>: <span class="hljs-string">&#x27;inside&#x27;</span><br>      &#125;).<span class="hljs-title function_">toFile</span>(newPath)<br>    &#125;<br>    <span class="hljs-keyword">const</span> stream = fs.<span class="hljs-title function_">createReadStream</span>(newPath)<br>    <span class="hljs-comment">// 2.FormData类型的数据准备</span><br>    <span class="hljs-keyword">const</span> form = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()<br>    form.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;media&#x27;</span>, stream)<br>    <span class="hljs-keyword">const</span> headers = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getHeaders</span>(form)<br>    <span class="hljs-comment">// 3.请求接口 -&gt; 返回结果</span><br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(<span class="hljs-string">`https://api.weixin.qq.com/wxa/img_sec_check?access_token=<span class="hljs-subst">$&#123;accessToken&#125;</span>`</span>, form, &#123; headers &#125;)<br>    <span class="hljs-comment">// 校验成功 -&gt; 删除tmp数据 -&gt; 判断路径中的文件是否存在</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: WxUtils.js ~ line 232 ~ wxImgCheck ~ result&#x27;</span>, result)<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkAndDelFile</span>(newPath)<br>    <span class="hljs-keyword">return</span> result.<span class="hljs-property">status</span> === <span class="hljs-number">200</span> &amp;&amp; result.<span class="hljs-property">data</span> &amp;&amp; result.<span class="hljs-property">data</span>.<span class="hljs-property">errcode</span> === <span class="hljs-number">0</span><br>    <span class="hljs-comment">// if (result.status === 200 &amp;&amp; result.data &amp;&amp; result.data.errcode === 0) &#123;</span><br>    <span class="hljs-comment">//   // errcode 0 - 内容正常，否则 - 异常</span><br>    <span class="hljs-comment">//   return true</span><br>    <span class="hljs-comment">// &#125; else &#123;</span><br>    <span class="hljs-comment">//   return false</span><br>    <span class="hljs-comment">// &#125;</span><br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkAndDelFile</span>(newPath)<br>    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`wxImgCheck error: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="测试接口工具js-1"><a href="#测试接口工具js-1" class="headerlink" title="#测试接口工具js"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/09-内容安全.html#测试接口工具js-2">#</a>测试接口工具js</h3><p>注意：</p>
<ul>
<li>自行找一下网上可疑的图片进行测试；</li>
<li>errcode为0说明校验通过，反之不通过；</li>
<li>通过之后，删除图片临时目录中的文件；</li>
<li>一般上传图片的接口需要对接云上的存储，所以采用了本地缓存的方式校验图片；</li>
</ul>
<p><img src="uniapp.assets/image-20210815154746020.dd53a2fe.png" alt="image-20210815154746020"></p>
<h1 id="发贴评论功能"><a href="#发贴评论功能" class="headerlink" title="#发贴评论功能"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#发贴评论功能">#</a>发贴评论功能</h1><h2 id="创建分包"><a href="#创建分包" class="headerlink" title="#创建分包"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#创建分包">#</a>创建分包</h2><p>在uniapp中添加分包，减少主包体积，提升页面加载的性能：</p>
<ul>
<li><p>新增页面，<code>/subcom-pkg/post/post</code>加入基本的vue页面的结构</p>
</li>
<li><p>配置<code>pages.json</code></p>
</li>
</ul>
<p><code>pages.json</code>中配置分包：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;subPackages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;root&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;subcom-pkg&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;pages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      ...<br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;post/post&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;style&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;navigationBarTitleText&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;发贴&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>
<h2 id="表单校验"><a href="#表单校验" class="headerlink" title="#表单校验"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#表单校验">#</a>表单校验</h2><p>使用uview中的<a target="_blank" rel="noopener" href="https://www.uviewui.com/components/form.html">form (opens new window)</a>表单组件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;container&quot;&gt;<br>    &lt;u-form :model=&quot;form&quot; ref=&quot;uForm&quot; label-width=&quot;0&quot;&gt;<br>      &lt;u-form-item prop=&quot;title&quot;&gt;<br>        &lt;u-input v-model=&quot;form.title&quot; placeholder=&quot;请输入帖子标题&quot; clearable&gt;&lt;/u-input&gt;<br>      &lt;/u-form-item&gt;<br>      &lt;u-form-item prop=&quot;content&quot;&gt;<br>        &lt;u-input v-model=&quot;form.content&quot; placeholder=&quot;请输入帖子内容&quot; type=&quot;textarea&quot;&gt;&lt;/u-input&gt;<br>      &lt;/u-form-item&gt;<br><br>      &lt;view class=&quot;upload-img&quot;&gt;<br>        &lt;view class=&quot;prev&quot;&gt;设置封面图片:&lt;/view&gt;<br>        &lt;!-- 上传图片 --&gt;<br>      &lt;/view&gt;<br>      &lt;u-form-item :label-position=&quot;labelPosition&quot; label=&quot;发贴类型&quot; label-width=&quot;140&quot; prop=&quot;catalog&quot;&gt;<br>        &lt;u-input class=&quot;right-text&quot; type=&quot;select&quot; :select-open=&quot;show1&quot; v-model=&quot;form.catalog&quot; placeholder=&quot;请选择发贴类型&quot; @click=&quot;show1=true&quot;&gt;&lt;/u-input&gt;<br>        &lt;u-select v-model=&quot;show1&quot; :list=&quot;list&quot; @confirm=&quot;confirmType&quot;&gt;&lt;/u-select&gt;<br>      &lt;/u-form-item&gt;<br>      &lt;!-- &lt;/view&gt; --&gt;<br>      &lt;u-form-item label=&quot;奖励积分&quot; label-width=&quot;140&quot; prop=&quot;fav&quot;&gt;<br>        &lt;u-input class=&quot;right-text&quot; type=&quot;select&quot; :select-open=&quot;show&quot; v-model=&quot;form.fav&quot; placeholder=&quot;请选择奖励积分&quot; @click=&quot;show=true&quot;&gt;&lt;/u-input&gt;<br>        &lt;u-select v-model=&quot;show&quot; :list=&quot;tempFavs&quot; @confirm=&quot;confirmFav&quot;&gt;&lt;/u-select&gt;<br>      &lt;/u-form-item&gt;<br>    &lt;/u-form&gt;<br>    &lt;view class=&quot;btn&quot;&gt;<br>      &lt;u-button size=&quot;default&quot; type=&quot;primary&quot; hover-class=&quot;none&quot;&gt;发布&lt;/u-button&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure>
<p>加入表单校验：</p>
<ul>
<li>配置<code>u-form</code>中的<code>model</code>属性，<code>ref</code>用于校验整个表单；</li>
<li>配置<code>u-form-item</code>中的<code>prop</code>属性，配置对应的rules规则</li>
<li>在script的<code>onReady</code>回调中配置<code>this.$refs.uForm.setRules(this.rules)</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">&lt;script&gt;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-attr">components</span>: &#123;&#125;,<br>  <span class="hljs-attr">data</span>: <span class="hljs-function">() =&gt;</span> (&#123;<br>    <span class="hljs-attr">show</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">show1</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">form</span>: &#123;<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>      <span class="hljs-attr">content</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>      <span class="hljs-attr">catalog</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>      <span class="hljs-attr">fav</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>      <span class="hljs-attr">snapshot</span>: <span class="hljs-string">&#x27;&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">rules</span>: &#123;<br>      <span class="hljs-attr">title</span>: [<br>        &#123;<br>          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>          <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入标题&#x27;</span>,<br>          <span class="hljs-comment">// 可以单个或者同时写两个触发验证方式</span><br>          <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;blur&#x27;</span>]<br>        &#125;<br>      ],<br>      <span class="hljs-attr">content</span>: [<br>        &#123;<br>          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>          <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请输入文章内容&#x27;</span>,<br>          <span class="hljs-attr">trigger</span>: <span class="hljs-string">&#x27;blur&#x27;</span><br>        &#125;<br>      ],<br>      <span class="hljs-attr">catalog</span>: [<br>        &#123;<br>          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>          <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择发贴类型&#x27;</span>,<br>          <span class="hljs-comment">// 触发器可以同时用blur和change</span><br>          <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-string">&#x27;blur&#x27;</span>]<br>        &#125;<br>      ],<br>      <span class="hljs-attr">fav</span>: [<br>        &#123;<br>          <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,<br>          <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;请选择积分&#x27;</span>,<br>          <span class="hljs-attr">trigger</span>: [<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-string">&#x27;blur&#x27;</span>]<br>        &#125;<br>      ]<br>    &#125;,<br>    <span class="hljs-attr">list</span>: [<br>      &#123;<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;请选择&#x27;</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;ask&#x27;</span>,<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;提问&#x27;</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;share&#x27;</span>,<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;分享&#x27;</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;discuss&#x27;</span>,<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;讨论&#x27;</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;advise&#x27;</span>,<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;建议&#x27;</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">listIndex</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">tempFavs</span>: [<br>      &#123;<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;请选择&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;&#x27;</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;20&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-number">20</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;30&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-number">30</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;50&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-number">50</span><br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">label</span>: <span class="hljs-string">&#x27;100&#x27;</span>,<br>        <span class="hljs-attr">value</span>: <span class="hljs-number">100</span><br>      &#125;<br>    ],<br>    <span class="hljs-attr">favIndex</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">fileList</span>: [],<br>    <span class="hljs-attr">disabledButton</span>: <span class="hljs-literal">true</span><br>  &#125;),<br>  <span class="hljs-attr">methods</span>: &#123;<br>    <span class="hljs-title function_">confirmType</span> (e) &#123;<br>      <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">value</span> === e[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>)<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listIndex</span> = index<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span>.<span class="hljs-property">catalog</span> = e[<span class="hljs-number">0</span>].<span class="hljs-property">label</span><br>    &#125;,<br>    <span class="hljs-title function_">confirmFav</span> (e) &#123;<br>      <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tempFavs</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">value</span> === e[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>)<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">favIndex</span> = index<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span>.<span class="hljs-property">fav</span> = e[<span class="hljs-number">0</span>].<span class="hljs-property">label</span><br>    &#125;,<br>    <span class="hljs-title function_">addPost</span> () &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">uForm</span>.<span class="hljs-title function_">validate</span>(<span class="hljs-keyword">async</span> valid =&gt; &#123;<br>        <span class="hljs-keyword">if</span> (valid) &#123;<br>          <span class="hljs-comment">// to do</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;验证失败&#x27;</span>)<br>        &#125;<br>      &#125;)<br>    &#125;<br>  &#125;,<br>  <span class="hljs-title function_">onReady</span> () &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">uForm</span>.<span class="hljs-title function_">setRules</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rules</span>)<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<h2 id="图片上传"><a href="#图片上传" class="headerlink" title="#图片上传"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#图片上传">#</a>图片上传</h2><h3 id="上传接口"><a href="#上传接口" class="headerlink" title="#上传接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#上传接口">#</a>上传接口</h3><p>上传formdata类型的数据，需要使用uni.uploadFile API，封装成一个promise谅，在complete中加入callback，方便后续的处理：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 图片上传接口</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadImg</span> = (<span class="hljs-params">params, callback</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    uni.<span class="hljs-title function_">uploadFile</span>(&#123;<br>      <span class="hljs-attr">url</span>: baseUrl + <span class="hljs-string">&#x27;/content/upload&#x27;</span>, <span class="hljs-comment">// 仅为示例，非真实的接口地址</span><br>      <span class="hljs-attr">filePath</span>: params,<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;file&#x27;</span>,<br>      <span class="hljs-attr">header</span>: &#123;<br>        <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;multipart/form-data&#x27;</span>,<br>        <span class="hljs-attr">authorization</span>: <span class="hljs-string">&#x27;Bearer &#x27;</span> + store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span><br>      &#125;,<br>      <span class="hljs-attr">formData</span>: &#123;<br>        <span class="hljs-comment">// &#x27;user&#x27;: &#x27;test&#x27;</span><br>      &#125;,<br>      <span class="hljs-attr">success</span>: <span class="hljs-function">(<span class="hljs-params">uploadFileRes</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(uploadFileRes)<br>      &#125;,<br>      <span class="hljs-attr">fail</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">reject</span>(err)<br>      &#125;,<br>      <span class="hljs-attr">complete</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;<br>        callback &amp;&amp; <span class="hljs-title function_">callback</span>(res)<br>      &#125;<br>    &#125;)<br>  &#125;)<br>&#125;<br><br><span class="hljs-comment">// 发贴接口</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">addPost</span> = (<span class="hljs-params">data</span>) =&gt; axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/content/wxAdd&#x27;</span>, data)<br></code></pre></td></tr></table></figure>
<h3 id="页面结构"><a href="#页面结构" class="headerlink" title="#页面结构"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#页面结构">#</a>页面结构</h3><p>可以使用<a target="_blank" rel="noopener" href="https://www.uviewui.com/components/upload.html">u-upload (opens new window)</a>组件来轻松实现图片上传：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;container&quot;&gt;<br>    &lt;u-form :model=&quot;form&quot; ref=&quot;uForm&quot; label-width=&quot;0&quot;&gt;<br>      &lt;u-form-item prop=&quot;title&quot;&gt;<br>        &lt;u-input v-model=&quot;form.title&quot; placeholder=&quot;请输入帖子标题&quot; clearable&gt;&lt;/u-input&gt;<br>      &lt;/u-form-item&gt;<br>      &lt;u-form-item prop=&quot;content&quot;&gt;<br>        &lt;u-input v-model=&quot;form.content&quot; placeholder=&quot;请输入帖子内容&quot; type=&quot;textarea&quot;&gt;&lt;/u-input&gt;<br>      &lt;/u-form-item&gt;<br><br>      &lt;view class=&quot;upload-img&quot;&gt;<br>        &lt;view class=&quot;prev&quot;&gt;设置封面图片:&lt;/view&gt;<br>        &lt;u-upload ref=&quot;uUpload&quot; :file-list=&quot;fileList&quot; action=&quot;#&quot; :auto-upload=&quot;false&quot; @on-list-change=&quot;uploadImg&quot; multiple :max-size=&quot;5 * 1024 * 1024&quot; max-count=&quot;1&quot; /&gt;<br>      &lt;/view&gt;<br>      &lt;u-form-item :label-position=&quot;labelPosition&quot; label=&quot;发贴类型&quot; label-width=&quot;140&quot; prop=&quot;catalog&quot;&gt;<br>        &lt;u-input class=&quot;right-text&quot; type=&quot;select&quot; :select-open=&quot;show1&quot; v-model=&quot;form.catalog&quot; placeholder=&quot;请选择发贴类型&quot; @click=&quot;show1=true&quot;&gt;&lt;/u-input&gt;<br>        &lt;u-select v-model=&quot;show1&quot; :list=&quot;list&quot; @confirm=&quot;confirmType&quot;&gt;&lt;/u-select&gt;<br>      &lt;/u-form-item&gt;<br>      &lt;!-- &lt;/view&gt; --&gt;<br>      &lt;u-form-item label=&quot;奖励积分&quot; label-width=&quot;140&quot; prop=&quot;fav&quot;&gt;<br>        &lt;u-input class=&quot;right-text&quot; type=&quot;select&quot; :select-open=&quot;show&quot; v-model=&quot;form.fav&quot; placeholder=&quot;请选择奖励积分&quot; @click=&quot;show=true&quot;&gt;&lt;/u-input&gt;<br>        &lt;u-select v-model=&quot;show&quot; :list=&quot;tempFavs&quot; @confirm=&quot;confirmFav&quot;&gt;&lt;/u-select&gt;<br>      &lt;/u-form-item&gt;<br>    &lt;/u-form&gt;<br>    &lt;view class=&quot;btn&quot;&gt;<br>      &lt;u-button size=&quot;default&quot; type=&quot;primary&quot; @click=&quot;addPost&quot; hover-class=&quot;none&quot;&gt;发布&lt;/u-button&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; authNav &#125; from &#x27;@/common/checkAuth&#x27;<br>export default &#123;<br>  data: () =&gt; (&#123;<br>    // ...<br>    fileList: [],<br>  &#125;),<br>  methods: &#123;<br>    // ....<br>    async uploadImg (lists, name) &#123;<br>      if (lists.length &gt; 0) &#123;<br>        const res = await this.$u.api.uploadImg(lists[0].url)<br>        if (res.statusCode === 401) &#123;<br>          await authNav(&#x27;登录已失效，图片上传失败，请登录后重传！&#x27;)<br>          this.$refs.uUpload.clear()<br>        &#125;<br>        if (res.statusCode === 200) &#123;<br>          const &#123; data &#125; = res<br>          const &#123; code, msg, data: url &#125; = JSON.parse(data)<br>          if (code === 200) &#123;<br>            this.form.snapshot = url<br>          &#125;<br>          uni.showToast(&#123;<br>            icon: &#x27;none&#x27;,<br>            title: msg,<br>            duration: 2000<br>          &#125;)<br>        &#125;<br>      &#125;<br>    &#125;,<br>    // ...<br>  &#125;,<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>
<h2 id="完成效果"><a href="#完成效果" class="headerlink" title="#完成效果"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#完成效果">#</a>完成效果</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;container&quot;&gt;<br>    &lt;u-form :model=&quot;form&quot; ref=&quot;uForm&quot; label-width=&quot;0&quot;&gt;<br>      &lt;u-form-item prop=&quot;title&quot;&gt;<br>        &lt;u-input v-model=&quot;form.title&quot; placeholder=&quot;请输入帖子标题&quot; clearable&gt;&lt;/u-input&gt;<br>      &lt;/u-form-item&gt;<br>      &lt;u-form-item prop=&quot;content&quot;&gt;<br>        &lt;u-input v-model=&quot;form.content&quot; placeholder=&quot;请输入帖子内容&quot; type=&quot;textarea&quot;&gt;&lt;/u-input&gt;<br>      &lt;/u-form-item&gt;<br><br>      &lt;view class=&quot;upload-img&quot;&gt;<br>        &lt;view class=&quot;prev&quot;&gt;设置封面图片:&lt;/view&gt;<br>        &lt;u-upload ref=&quot;uUpload&quot; :file-list=&quot;fileList&quot; action=&quot;#&quot; :auto-upload=&quot;false&quot; @on-list-change=&quot;uploadImg&quot; multiple :max-size=&quot;5 * 1024 * 1024&quot; max-count=&quot;1&quot; /&gt;<br>      &lt;/view&gt;<br>      &lt;u-form-item :label-position=&quot;labelPosition&quot; label=&quot;发贴类型&quot; label-width=&quot;140&quot; prop=&quot;catalog&quot;&gt;<br>        &lt;u-input class=&quot;right-text&quot; type=&quot;select&quot; :select-open=&quot;show1&quot; v-model=&quot;form.catalog&quot; placeholder=&quot;请选择发贴类型&quot; @click=&quot;show1=true&quot;&gt;&lt;/u-input&gt;<br>        &lt;u-select v-model=&quot;show1&quot; :list=&quot;list&quot; @confirm=&quot;confirmType&quot;&gt;&lt;/u-select&gt;<br>      &lt;/u-form-item&gt;<br>      &lt;!-- &lt;/view&gt; --&gt;<br>      &lt;u-form-item label=&quot;奖励积分&quot; label-width=&quot;140&quot; prop=&quot;fav&quot;&gt;<br>        &lt;u-input class=&quot;right-text&quot; type=&quot;select&quot; :select-open=&quot;show&quot; v-model=&quot;form.fav&quot; placeholder=&quot;请选择奖励积分&quot; @click=&quot;show=true&quot;&gt;&lt;/u-input&gt;<br>        &lt;u-select v-model=&quot;show&quot; :list=&quot;tempFavs&quot; @confirm=&quot;confirmFav&quot;&gt;&lt;/u-select&gt;<br>      &lt;/u-form-item&gt;<br>    &lt;/u-form&gt;<br>    &lt;view class=&quot;btn&quot;&gt;<br>      &lt;u-button size=&quot;default&quot; type=&quot;primary&quot; @click=&quot;addPost&quot; hover-class=&quot;none&quot;&gt;发布&lt;/u-button&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; mapMutations &#125; from &#x27;vuex&#x27;<br>import &#123; authNav &#125; from &#x27;@/common/checkAuth&#x27;<br>export default &#123;<br>  components: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    show: false,<br>    show1: false,<br>    form: &#123;<br>      title: &#x27;&#x27;,<br>      content: &#x27;&#x27;,<br>      catalog: &#x27;&#x27;,<br>      fav: &#x27;&#x27;,<br>      snapshot: &#x27;&#x27;<br>    &#125;,<br>    rules: &#123;<br>      title: [<br>        &#123;<br>          required: true,<br>          message: &#x27;请输入标题&#x27;,<br>          // 可以单个或者同时写两个触发验证方式<br>          trigger: [&#x27;blur&#x27;]<br>        &#125;<br>      ],<br>      content: [<br>        &#123;<br>          required: true,<br>          message: &#x27;请输入文章内容&#x27;,<br>          trigger: &#x27;blur&#x27;<br>        &#125;<br>      ],<br>      catalog: [<br>        &#123;<br>          required: true,<br>          message: &#x27;请选择发贴类型&#x27;,<br>          // 触发器可以同时用blur和change<br>          trigger: [&#x27;change&#x27;, &#x27;blur&#x27;]<br>        &#125;<br>      ],<br>      fav: [<br>        &#123;<br>          required: true,<br>          message: &#x27;请选择积分&#x27;,<br>          trigger: [&#x27;change&#x27;, &#x27;blur&#x27;]<br>        &#125;<br>      ]<br>    &#125;,<br>    list: [<br>      &#123;<br>        value: &#x27;&#x27;,<br>        label: &#x27;请选择&#x27;<br>      &#125;,<br>      &#123;<br>        value: &#x27;ask&#x27;,<br>        label: &#x27;提问&#x27;<br>      &#125;,<br>      &#123;<br>        value: &#x27;share&#x27;,<br>        label: &#x27;分享&#x27;<br>      &#125;,<br>      &#123;<br>        value: &#x27;discuss&#x27;,<br>        label: &#x27;讨论&#x27;<br>      &#125;,<br>      &#123;<br>        value: &#x27;advise&#x27;,<br>        label: &#x27;建议&#x27;<br>      &#125;<br>    ],<br>    listIndex: 0,<br>    tempFavs: [<br>      &#123;<br>        label: &#x27;请选择&#x27;,<br>        value: &#x27;&#x27;<br>      &#125;,<br>      &#123;<br>        label: &#x27;20&#x27;,<br>        value: 20<br>      &#125;,<br>      &#123;<br>        label: &#x27;30&#x27;,<br>        value: 30<br>      &#125;,<br>      &#123;<br>        label: &#x27;50&#x27;,<br>        value: 50<br>      &#125;,<br>      &#123;<br>        label: &#x27;100&#x27;,<br>        value: 100<br>      &#125;<br>    ],<br>    favIndex: 0,<br>    fileList: [],<br>    disabledButton: true<br>  &#125;),<br>  computed: &#123;<br>  &#125;,<br>  methods: &#123;<br>    ...mapMutations([&#x27;setPage&#x27;]),<br>    confirmType (e) &#123;<br>      const index = this.list.findIndex(item =&gt; item.value === e[0].value)<br>      this.listIndex = index<br>      this.form.catalog = e[0].label<br>    &#125;,<br>    confirmFav (e) &#123;<br>      const index = this.tempFavs.findIndex(item =&gt; item.value === e[0].value)<br>      this.favIndex = index<br>      this.form.fav = e[0].label<br>    &#125;,<br>    async uploadImg (lists, name) &#123;<br>      if (lists.length &gt; 0) &#123;<br>        const res = await this.$u.api.uploadImg(lists[0].url)<br>        if (res.statusCode === 401) &#123;<br>          await authNav(&#x27;登录已失效，图片上传失败，请登录后重传！&#x27;)<br>          this.$refs.uUpload.clear()<br>        &#125;<br>        if (res.statusCode === 200) &#123;<br>          const &#123; data &#125; = res<br>          const &#123; code, msg, data: url &#125; = JSON.parse(data)<br>          if (code === 200) &#123;<br>            this.form.snapshot = url<br>          &#125;<br>          uni.showToast(&#123;<br>            icon: &#x27;none&#x27;,<br>            title: msg,<br>            duration: 2000<br>          &#125;)<br>        &#125;<br>      &#125;<br>    &#125;,<br>    addPost () &#123;<br>      this.$refs.uForm.validate(async valid =&gt; &#123;<br>        if (valid) &#123;<br>          const data = &#123;<br>            ...this.form,<br>            catalog: this.list[this.listIndex].value,<br>            fav: this.tempFavs[this.favIndex].value<br>          &#125;<br>          const &#123; code, msg, data: res &#125; = await this.$u.api.addPost(data)<br>          // console.log(&#x27;🚀 ~ file: post.vue ~ line 157 ~ addPost ~ res&#x27;, res)<br>          if (code === 200 &amp;&amp; res._id) &#123;<br>            uni.showToast(&#123;<br>              icon: &#x27;none&#x27;,<br>              title: msg,<br>              duration: 2000<br>            &#125;)<br>            uni.navigateBack()<br>          &#125; else &#123;<br>            // 内容审核提示<br>            if (code === 500 &amp;&amp; /内容安全/.test(msg)) &#123;<br>              uni.showModal(&#123;<br>                title: &#x27;注意文明用语&#x27;,<br>                content: &#x27;发布内容没有通过内容审核，请检查后重新提效&#x27;,<br>                showCancel: false,<br>                success: function (res) &#123;<br>                  console.log(res)<br>                &#125;<br>              &#125;)<br>              return<br>            &#125;<br>            uni.showToast(&#123;<br>              icon: &#x27;none&#x27;,<br>              title: msg,<br>              duration: 2000<br>            &#125;)<br>          &#125;<br>        &#125; else &#123;<br>          console.log(&#x27;验证失败&#x27;)<br>        &#125;<br>      &#125;)<br>    &#125;<br>  &#125;,<br>  onReady () &#123;<br>    this.$refs.uForm.setRules(this.rules)<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot; scoped&gt;<br>.container &#123;<br>  padding: 32rpx;<br>&#125;<br><br>::v-deep .edit-post &#123;<br>  position: relative;<br>  textarea &#123;<br>    max-height: 400rpx;<br>  &#125;<br>  .u-clear-icon &#123;<br>    position: absolute;<br>    right: 10rpx;<br>    bottom: 30rpx;<br>  &#125;<br>&#125;<br><br>.btn &#123;<br>  margin-top: 60rpx;<br>&#125;<br><br>::v-deep .right-text &#123;<br>  .u-input__input &#123;<br>    text-align: end;<br>    padding-right: 15rpx;<br>  &#125;<br>&#125;<br><br>.prev &#123;<br>  padding: 15rpx 0 30rpx;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<p>完成效果：</p>
<p><img src="uniapp.assets/image-20210527014805079.5b658899.png" alt="image-20210527014805079"></p>
<h2 id="发帖服务端逻辑"><a href="#发帖服务端逻辑" class="headerlink" title="#发帖服务端逻辑"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#发帖服务端逻辑">#</a>发帖服务端逻辑</h2><h3 id="图片上传-1"><a href="#图片上传-1" class="headerlink" title="#图片上传"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#图片上传-2">#</a>图片上传</h3><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 上传图片</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">uploadImg</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> file = ctx.<span class="hljs-property">request</span>.<span class="hljs-property">files</span>.<span class="hljs-property">file</span><br>  <span class="hljs-comment">// 这里加入内容安全</span><br>  <span class="hljs-keyword">const</span> flag = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxImgCheck</span>(file)<br>  <span class="hljs-keyword">if</span> (!flag) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;内容安全校验失败，请检查&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-comment">// 图片名称、图片格式、存储的位置，返回前台一可以读取的路径</span><br>  <span class="hljs-keyword">const</span> ext = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>).<span class="hljs-title function_">pop</span>()<br>  <span class="hljs-keyword">const</span> dir = <span class="hljs-string">`<span class="hljs-subst">$&#123;config.uploadPath&#125;</span>/<span class="hljs-subst">$&#123;moment().format(<span class="hljs-string">&#x27;YYYYMMDD&#x27;</span>)&#125;</span>`</span><br>  <span class="hljs-comment">// 判断路径是否存在，不存在则创建</span><br>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">mkdir</span>(dir)<br>  <span class="hljs-comment">// 存储文件到指定的路径</span><br>  <span class="hljs-comment">// 给文件一个唯一的名称</span><br>  <span class="hljs-keyword">const</span> picname = <span class="hljs-title function_">uuidv4</span>()<br>  <span class="hljs-keyword">const</span> destPath = <span class="hljs-string">`<span class="hljs-subst">$&#123;dir&#125;</span>/<span class="hljs-subst">$&#123;picname&#125;</span>.<span class="hljs-subst">$&#123;ext&#125;</span>`</span><br>  <span class="hljs-keyword">const</span> reader = fs.<span class="hljs-title function_">createReadStream</span>(file.<span class="hljs-property">path</span>)<br>  <span class="hljs-keyword">const</span> upStream = fs.<span class="hljs-title function_">createWriteStream</span>(destPath)<br>  <span class="hljs-keyword">const</span> filePath = <span class="hljs-string">`/<span class="hljs-subst">$&#123;moment().format(<span class="hljs-string">&#x27;YYYYMMDD&#x27;</span>)&#125;</span>/<span class="hljs-subst">$&#123;picname&#125;</span>.<span class="hljs-subst">$&#123;ext&#125;</span>`</span><br>  <span class="hljs-comment">// method 1</span><br>  reader.<span class="hljs-title function_">pipe</span>(upStream)<br><br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;图片上传成功&#x27;</span>,<br>    <span class="hljs-attr">data</span>: filePath<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="发帖接口"><a href="#发帖接口" class="headerlink" title="#发帖接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#发帖接口">#</a>发帖接口</h3><p>调整整体的逻辑，删除验证码的逻辑部分，并添加内容安全校验：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">addWxPost</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>  <span class="hljs-comment">// 校验用户传递的参数与内容是否通过内容安全的校验</span><br>  <span class="hljs-comment">// 判断用户的积分数是否 &gt; fav，否则，提示用户积分不足发贴</span><br>  <span class="hljs-comment">// 用户积分足够的时候，新建Post，减除用户对应的积分</span><br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByID</span>(&#123; <span class="hljs-attr">_id</span>: ctx.<span class="hljs-property">_id</span> &#125;)<br>  <span class="hljs-keyword">const</span> flag = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxMsgCheck</span>(body.<span class="hljs-property">content</span> || <span class="hljs-string">&#x27;&#x27;</span>, &#123; <span class="hljs-attr">user</span>: user, <span class="hljs-attr">title</span>: body.<span class="hljs-property">title</span> &#125;)<br>  <span class="hljs-keyword">if</span> (!flag) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;内容安全校验失败，请检查&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">favs</span> &lt; body.<span class="hljs-property">fav</span>) &#123;<br>    ctx.<span class="hljs-property">body</span> = &#123;<br>      <span class="hljs-attr">code</span>: <span class="hljs-number">501</span>,<br>      <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;积分不足&#x27;</span><br>    &#125;<br>    <span class="hljs-keyword">return</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">updateOne</span>(&#123; <span class="hljs-attr">_id</span>: ctx.<span class="hljs-property">_id</span> &#125;, &#123; <span class="hljs-attr">$inc</span>: &#123; <span class="hljs-attr">favs</span>: -body.<span class="hljs-property">fav</span> &#125; &#125;)<br>  &#125;<br>  <span class="hljs-keyword">const</span> newPost = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Post</span>(body)<br>  newPost.<span class="hljs-property">uid</span> = ctx.<span class="hljs-property">_id</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> newPost.<span class="hljs-title function_">save</span>()<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;成功的保存的文章&#x27;</span>,<br>    <span class="hljs-attr">data</span>: result<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>添加路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 小程序发表新贴</span><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/wxAdd&#x27;</span>, contentController.<span class="hljs-property">addWxPost</span>)<br></code></pre></td></tr></table></figure>
<h2 id="评论功能"><a href="#评论功能" class="headerlink" title="#评论功能"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#评论功能">#</a>评论功能</h2><h3 id="创建接口"><a href="#创建接口" class="headerlink" title="#创建接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#创建接口">#</a>创建接口</h3><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 评论接口</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">addComment</span> = (<span class="hljs-params">data</span>) =&gt; axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/comments/reply&#x27;</span>, data)<br></code></pre></td></tr></table></figure>
<h3 id="fixed底部定位问题"><a href="#fixed底部定位问题" class="headerlink" title="#fixed底部定位问题"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#fixed底部定位问题">#</a>fixed底部定位问题</h3><p>在小程序中，使用了fixed定位的底部元素可能被遮挡：</p>
<p>解决方案：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;!-- fixed: 1.static/absolute 2.点击跳转新页面 3.cursor-spacing --&gt;<br>&lt;view class=&quot;box u-flex u-col-center&quot; v-else&gt;<br>  &lt;u-input v-model=&quot;content&quot; class=&quot;reply&quot; placeholder=&quot;请输入评论内容&quot; focus @clear=&quot;clear&quot; :cursor-spacing=&quot;10&quot;&gt;&lt;/u-input&gt;<br>  &lt;button type=&quot;primary&quot; plain size=&quot;mini&quot; @click.stop=&quot;send&quot;&gt;发送&lt;/button&gt;<br>&lt;/view&gt;<br></code></pre></td></tr></table></figure>
<p>推荐：使用<code>cursor-spacing</code>，<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/component/input.html">官方链接(opens new window)</a></p>
<p><img src="uniapp.assets/image-20210817235100442.52657281.png" alt="image-20210817235100442"></p>
<p>如果不设置，默认是0，也是为什么会浮动不准确的原因。</p>
<h3 id="页面样式与事件"><a href="#页面样式与事件" class="headerlink" title="#页面样式与事件"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#页面样式与事件">#</a>页面样式与事件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;view class=&quot;detail&quot; :class=&quot;&#123;&#x27;ipx&#x27;: ipxFlag&#125;&quot; v-show=&quot;page._id&quot; @click.stop=&quot;showReply = false&quot;&gt;<br>    // .....<br>    &lt;view class=&quot;footer&quot;&gt;<br>      &lt;view class=&quot;box u-flex u-col-center&quot; v-if=&quot;!showReply&quot;&gt;<br>        &lt;view class=&quot;add-comment&quot; @click.stop=&quot;reply()&quot;&gt;<br>          &lt;u-icon name=&quot;edit-pen&quot; size=&quot;32&quot; color=&quot;#cccccc&quot;&gt;&lt;/u-icon&gt;<br>          &lt;text class=&quot;text&quot;&gt;写评论&lt;/text&gt;<br>        &lt;/view&gt;<br>        &lt;view class=&quot;ctrls u-flex u-col-center u-row-between&quot;&gt;<br>          &lt;view class=&quot;comment u-flex flex-column&quot;&gt;<br>            &lt;u-icon name=&quot;chat&quot; size=&quot;45&quot;&gt;&lt;/u-icon&gt;<br>            &lt;text&gt;评论&#123;&#123; page.answer &gt; 0 ? page.answer : &#x27;&#x27;&#125;&#125;&lt;/text&gt;<br>          &lt;/view&gt;<br>          &lt;view class=&quot;fav u-flex flex-column&quot; :class=&quot;&#123;&#x27;active&#x27;: page.isFav === 1&#125;&quot; @click=&quot;setCollect&quot;&gt;<br>            &lt;u-icon name=&quot;star-fill&quot; size=&quot;45&quot; v-if=&quot;page.isFav === 1&quot;&gt;&lt;/u-icon&gt;<br>            &lt;u-icon name=&quot;star&quot; size=&quot;45&quot; v-else&gt;&lt;/u-icon&gt;<br>            &lt;text&gt;&#123;&#123;page.isFav === 1 ? &#x27;已收藏&#x27;: &#x27;收藏&#x27;&#125;&#125;&lt;/text&gt;<br>          &lt;/view&gt;<br>          &lt;view class=&quot;like u-flex flex-column&quot; :class=&quot;&#123;&#x27;active&#x27;: page.isHand === 1&#125;&quot; @click=&quot;handsPost&quot;&gt;<br>            &lt;u-icon name=&quot;thumb-up-fill&quot; size=&quot;45&quot; v-if=&quot;page.isHand === 1&quot;&gt;&lt;/u-icon&gt;<br>            &lt;u-icon name=&quot;thumb-up&quot; size=&quot;45&quot; v-else&gt;&lt;/u-icon&gt;<br>            &lt;text&gt;&#123;&#123;page.isHand === 1 ? &#x27;已点赞&#x27; : &#x27;点赞&#x27;&#125;&#125;&lt;/text&gt;<br>          &lt;/view&gt;<br>        &lt;/view&gt;<br>      &lt;/view&gt;<br>      &lt;!-- fixed: 1.static/absolute 2.点击跳转新页面 3.cursor-spacing --&gt;<br>      &lt;view class=&quot;box u-flex u-col-center&quot; v-else&gt;<br>        &lt;u-input v-model=&quot;content&quot; class=&quot;reply&quot; placeholder=&quot;请输入评论内容&quot; focus @clear=&quot;clear&quot; :cursor-spacing=&quot;10&quot;&gt;&lt;/u-input&gt;<br>        &lt;button type=&quot;primary&quot; plain size=&quot;mini&quot; @click.stop=&quot;send&quot;&gt;发送&lt;/button&gt;<br>      &lt;/view&gt;<br>    &lt;/view&gt;<br>  &lt;/view&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import &#123; mapGetters, mapState &#125; from &#x27;vuex&#x27;<br>import &#123; checkToken &#125; from &#x27;@/common/checkAuth&#x27;<br>import formatHTML from &#x27;@/common/utils/formatHTML&#x27;<br><br>export default &#123;<br>  components: &#123;&#125;,<br>  data: () =&gt; (&#123;<br>    // ....<br>    content: &#x27;&#x27;,<br>    showReply: false,<br>		// ...<br>  &#125;),<br>  // ....<br>  methods: &#123;<br>    // ....<br>    reply () &#123;<br>      if (!this.check()) return<br>      this.showReply = true<br>    &#125;,<br>    async send () &#123;<br>      const &#123; code, msg &#125; = await this.$u.api.addReply(&#123; tid: this.params.tid, content: this.content &#125;)<br>      if (code === 200) &#123;<br>        uni.$success(msg)<br>      &#125; else &#123;<br>        if (code === 500 &amp;&amp; /内容安全/.test(msg)) &#123;<br>          uni.showModal(&#123;<br>            title: &#x27;注意文明用语&#x27;,<br>            content: &#x27;发布内容没有通过内容审核，请检查后重新提效&#x27;,<br>            showCancel: false<br>          &#125;)<br>          return<br>        &#125;<br>        uni.$error(msg)<br>      &#125;<br>      await this.getReply()<br>      this.content = &#x27;&#x27;<br>      this.showReply = false<br>    &#125;,<br>  &#125;,<br>  // ...<br>&#125;<br>&lt;/script&gt;<br><br>&lt;style lang=&quot;scss&quot;&gt;<br>.detail &#123;<br>  background: #f4f6f8;<br>  height: 100vh;<br>  &amp;.ipx &#123;<br>    .comments,<br>    .footer &#123;<br>      padding-bottom: constant(safe-area-inset-bottom); // 兼容iOS &lt; 11.2<br>      padding-bottom: env(safe-area-inset-bottom);<br>    &#125;<br>  &#125;<br>&#125;<br><br>.header,<br>.content,<br>.comments &#123;<br>  background: #fff;<br>  padding: 32rpx;<br>&#125;<br><br>.header,<br>.content &#123;<br>  margin-bottom: 24rpx;<br>  box-shadow: 0 5rpx 5px rgba($color: black, $alpha: 0.1);<br>&#125;<br><br>.add-hand &#123;<br>  position: relative;<br>  .caina &#123;<br>    position: absolute;<br>    right: 100rpx;<br>    top: -20rpx;<br>  &#125;<br>  .setBest &#123;<br>    padding-left: 25rpx;<br>  &#125;<br>&#125;<br><br>.footer &#123;<br>  position: fixed;<br>  bottom: 0;<br>  left: 0;<br>  width: 100vw;<br>  padding: 10px 32rpx;<br>  background-color: #fff;<br>  // height: 100rpx;<br>  box-shadow: 0 -5rpx 5px rgba($color: black, $alpha: 0.1);<br>  .box &#123;<br>    width: 100%;<br>  &#125;<br>  .reply &#123;<br>    flex: 1;<br>    border: 1px solid #eee;<br>    padding: 0 15rpx;<br>    margin-right: 15rpx;<br>  &#125;<br>&#125;<br><br>.title &#123;<br>  font-size: 32rpx;<br>  color: #333;<br>  font-weight: bold;<br>&#125;<br>.add-comment &#123;<br>  background: #f3f3f3;<br>  height: 64rpx;<br>  border-radius: 32rpx;<br>  line-height: 64rpx;<br>  padding: 0 32rpx;<br>  width: 65%;<br>  margin-right: 40rpx;<br>  color: #ccc;<br>  .text &#123;<br>    padding-left: 10rpx;<br>  &#125;<br>&#125;<br><br>.loading &#123;<br>  height: 50px;<br>  .loading-text &#123;<br>    padding-left: 15rpx;<br>  &#125;<br>&#125;<br><br>.layui-elem-quote &#123;<br>  margin-bottom: 10rpx;<br>  padding: 15rpx;<br>  line-height: 14px;<br>  border-left: 2px solid #009688;<br>  border-radius: 0 2px 2px 0;<br>  background-color: #f2f2f2;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>
<h2 id="评论服务端逻辑"><a href="#评论服务端逻辑" class="headerlink" title="#评论服务端逻辑"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#评论服务端逻辑">#</a>评论服务端逻辑</h2><h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="#需求分析"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#需求分析">#</a>需求分析</h3><ul>
<li>用户是否被禁言</li>
<li>内容安全检查</li>
<li>评论 -&gt; 发送订阅消息给用户</li>
</ul>
<h3 id="评论接口"><a href="#评论接口" class="headerlink" title="#评论接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/10-发贴&amp;评论功能.html#评论接口">#</a>评论接口</h3><p>路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 微信评论回复</span><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/wxreply&#x27;</span>, commentsController.<span class="hljs-property">wxAddComment</span>)<br></code></pre></td></tr></table></figure>
<p>逻辑代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">canReply</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">ctx</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> result = <span class="hljs-literal">false</span><br>  <span class="hljs-comment">// const obj = await getJWTPayload(ctx.header.authorization)</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ctx.<span class="hljs-property">_id</span> === <span class="hljs-string">&#x27;undefined&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> result<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByID</span>(ctx.<span class="hljs-property">_id</span>)<br>    <span class="hljs-keyword">if</span> (user &amp;&amp; user.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;0&#x27;</span>) &#123;<br>      result = <span class="hljs-literal">true</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> result<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">wxAddComment</span>(<span class="hljs-params">ctx</span>) &#123;<br>    <span class="hljs-comment">// 查看用户是否被禁言</span><br>    <span class="hljs-keyword">const</span> check = <span class="hljs-keyword">await</span> <span class="hljs-title function_">canReply</span>(ctx)<br>    <span class="hljs-keyword">if</span> (!check) &#123;<br>      ctx.<span class="hljs-property">body</span> = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;用户已被禁言！&#x27;</span>,<br>      &#125;<br>      <span class="hljs-keyword">return</span><br>    &#125;<br>    <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxMsgCheck</span>(body.<span class="hljs-property">content</span>)<br>    <span class="hljs-keyword">if</span> (result &amp;&amp; ctx.<span class="hljs-property">_id</span>) &#123;<br>      <span class="hljs-comment">// const obj = await getJWTPayload(ctx.header.authorization)</span><br>      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByID</span>(ctx.<span class="hljs-property">_id</span>)<br>      <span class="hljs-keyword">const</span> newComment = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comments</span>(body)<br>      newComment.<span class="hljs-property">cuid</span> = ctx.<span class="hljs-property">_id</span><br>      <span class="hljs-comment">// 添加文章评论记数</span><br>      <span class="hljs-keyword">await</span> <span class="hljs-title class_">Post</span>.<span class="hljs-title function_">updateOne</span>(&#123; <span class="hljs-attr">_id</span>: body.<span class="hljs-property">tid</span> &#125;, &#123; <span class="hljs-attr">$inc</span>: &#123; <span class="hljs-attr">answer</span>: <span class="hljs-number">1</span> &#125; &#125;)<br>      <span class="hljs-keyword">const</span> post = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Post</span>.<span class="hljs-title function_">findByPostId</span>(body.<span class="hljs-property">tid</span>)<br>      newComment.<span class="hljs-property">uid</span> = post.<span class="hljs-property">uid</span>.<span class="hljs-property">_id</span> <span class="hljs-comment">// 保存帖子作者的id</span><br>      <span class="hljs-keyword">const</span> comment = <span class="hljs-keyword">await</span> newComment.<span class="hljs-title function_">save</span>()<br><br>      <span class="hljs-comment">// 调用微信订阅消息api</span><br>      <span class="hljs-comment">// 1、发帖的作者必须是用微信登录的才可以接收订阅消息</span><br>      <span class="hljs-comment">// 2、自己不能给自己发订阅消息</span><br>      <span class="hljs-comment">// if (post.uid.openid) &#123;</span><br>      <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">_id</span> !== post.<span class="hljs-property">uid</span>.<span class="hljs-property">_id</span>.<span class="hljs-title function_">toString</span>() &amp;&amp; post.<span class="hljs-property">uid</span>.<span class="hljs-property">openid</span>) &#123;<br>        <span class="hljs-keyword">const</span> notice = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxSendMessage</span>(&#123;<br>          <span class="hljs-attr">touser</span>: post.<span class="hljs-property">uid</span>.<span class="hljs-property">openid</span>,<br>          <span class="hljs-attr">template_id</span>: <span class="hljs-string">&#x27;ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs&#x27;</span>,<br>          <span class="hljs-attr">data</span>: &#123;<br>            <span class="hljs-attr">thing1</span>: &#123;<br>              <span class="hljs-attr">value</span>: <span class="hljs-title function_">getShort</span>(post.<span class="hljs-property">title</span>),<br>            &#125;,<br>            <span class="hljs-attr">thing4</span>: &#123;<br>              <span class="hljs-attr">value</span>: <span class="hljs-title function_">getCatalog</span>(post.<span class="hljs-property">catalog</span>),<br>            &#125;,<br>            <span class="hljs-attr">thing2</span>: &#123;<br>              <span class="hljs-attr">value</span>: <span class="hljs-title function_">getShort</span>(comment.<span class="hljs-property">content</span>),<br>            &#125;,<br>            <span class="hljs-attr">name6</span>: &#123;<br>              <span class="hljs-attr">value</span>: user.<span class="hljs-property">name</span>.<span class="hljs-title function_">substr</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>),<br>            &#125;,<br>            <span class="hljs-attr">date3</span>: &#123;<br>              <span class="hljs-attr">value</span>: <span class="hljs-title function_">moment</span>().<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYY年MM月DD HH:mm&#x27;</span>),<br>            &#125;,<br>          &#125;,<br>          <span class="hljs-attr">page</span>: <span class="hljs-string">&#x27;/subcom-pkg/detail/detail?tid=&#x27;</span> + post.<span class="hljs-property">_id</span>,<br>        &#125;)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(notice)<br>      &#125;<br><br>      ctx.<span class="hljs-property">body</span> = &#123;<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;回帖成功&#x27;</span>,<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>        <span class="hljs-attr">data</span>: comment,<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ctx.<span class="hljs-property">body</span> = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,<br>        <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;内容安全：&#x27;</span> + result.<span class="hljs-property">errmsg</span>,<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>
<h1 id="发布上线"><a href="#发布上线" class="headerlink" title="#发布上线"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#发布上线">#</a>发布上线</h1><h2 id="分包机制"><a href="#分包机制" class="headerlink" title="#分包机制"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#分包机制">#</a>分包机制</h2><p>某些情况下，开发者需要将小程序划分成不同的子包，在构建时打包成不同的分包，用户在使用时按需进行加载。</p>
<p><img src="uniapp.assets/image-20210818000627795.e1b5dd91.png" alt="image-20210818000627795"></p>
<h3 id="普通分包"><a href="#普通分包" class="headerlink" title="#普通分包"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#普通分包">#</a>普通分包</h3><p>在构建小程序分包项目时，构建会输出一个或多个分包。</p>
<p>每个使用分包小程序必定含有一个<strong>主包</strong>。</p>
<p>所谓的主包，即放置默认启动页面/TabBar 页面，以及一些所有分包都需用到公共资源/JS 脚本；而<strong>分包</strong>则是根据开发者的配置进行划分。</p>
<p>在小程序启动时，默认会下载主包并启动主包内页面，当用户进入分包内某个页面时，客户端会把对应分包下载下来，下载完成后再进行展示。</p>
<p>目前小程序分包大小有以下限制：</p>
<ul>
<li>整个小程序所有分包大小不超过 20M</li>
<li>单个分包/主包大小不能超过 2M</li>
</ul>
<p>对小程序进行分包，可以优化小程序首次启动的下载时间，以及在多团队共同开发时可以更好的解耦协作。</p>
<h3 id="独立分包"><a href="#独立分包" class="headerlink" title="#独立分包"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#独立分包">#</a>独立分包</h3><p>独立分包是小程序中一种特殊类型的分包，可以独立于主包和其他分包运行。从独立分包中页面进入小程序时，不需要下载主包。当用户进入普通分包或主包内页面时，主包才会被下载。</p>
<p>独立分包属于分包的一种，普通分包的所有限制都对独立分包有效（2M大小）。独立分包中插件、自定义组件的处理方式同普通分包。</p>
<p>此外，使用独立分包时要注意：</p>
<ul>
<li><p><strong>独立分包中不能依赖主包和其他分包中的内容</strong>，包括 js 文件、template、wxss、自定义组件、插件等。</p>
</li>
<li><p>主包中的 <code>app.wxss</code> 对独立分包无效，应避免在独立分包页面中使用 <code>app.wxss</code> 中的样式；</p>
</li>
<li><p><code>App</code> 只能在主包内定义，独立分包中不能定义 <code>App</code>，会造成无法预期的行为；</p>
<p>与普通分包不同，独立分包运行时，<code>App</code> 并不一定被注册，因此 <code>getApp()</code> 也不一定可以获得 <code>App</code> 对象；</p>
</li>
<li><p>独立分包中暂时不支持使用插件。</p>
</li>
<li><p>由于独立分包中无法定义 <code>App</code>，小程序生命周期的监听可以使用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onAppShow.html">wx.onAppShow (opens new window)</a>，<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onAppHide.html">wx.onAppHide (opens new window)</a>完成。</p>
<p><code>App</code> 上的其他事件可以使用 <a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onError.html">wx.onError (opens new window)</a>，<a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onPageNotFound.html">wx.onPageNotFound (opens new window)</a>监听。</p>
</li>
</ul>
<blockquote>
<p>应用场景：活动页面、登录注册相关页面…</p>
<p>大多数独立分包的场景，使用分包也可以很好的完成对应的功能，而且可以共享主包的样式。</p>
</blockquote>
<h3 id="分包预加载"><a href="#分包预加载" class="headerlink" title="#分包预加载"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#分包预加载">#</a>分包预加载</h3><p>开发者可以通过配置，在进入小程序某个页面时，由框架自动预下载可能需要的分包，提升进入后续分包页面时的启动速度。</p>
<p>预下载分包行为在进入某个页面时触发，通过在 <code>app.json</code> 增加 <code>preloadRule</code> 配置来控制。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;preloadRule&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;进入的页面&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;network&quot;</span>: <span class="hljs-string">&quot;all&quot;</span>,<br>      <span class="hljs-string">&quot;packages&quot;</span>: [<span class="hljs-string">&quot;加载的包中的页面&quot;</span>, <span class="hljs-string">&quot;或者加载整个目录&quot;</span>]<br>    &#125;,<br>    <span class="hljs-string">&quot;sub1/index&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;packages&quot;</span>: [<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;sub3&quot;</span>]<br>    &#125;,<br>    <span class="hljs-string">&quot;sub3/index&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;packages&quot;</span>: [<span class="hljs-string">&quot;path/to&quot;</span>]<br>    &#125;,<br>    <span class="hljs-string">&quot;indep/index&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;packages&quot;</span>: [<span class="hljs-string">&quot;__APP__&quot;</span>]<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>
<p><code>preloadRule</code> 中，<code>key</code> 是页面路径，<code>value</code> 是进入此页面的预下载配置，每个配置有以下几项：</p>
<table>
<thead>
<tr>
<th style="text-align:left">字段</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">必填</th>
<th style="text-align:left">默认值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">packages</td>
<td style="text-align:left">StringArray</td>
<td style="text-align:left">是</td>
<td style="text-align:left">无</td>
<td style="text-align:left">进入页面后预下载分包的 <code>root</code> 或 <code>name</code>。<code>__APP__</code> 表示主包。</td>
</tr>
<tr>
<td style="text-align:left">network</td>
<td style="text-align:left">String</td>
<td style="text-align:left">否</td>
<td style="text-align:left">wifi</td>
<td style="text-align:left">在指定网络下预下载，可选值为： <code>all</code>: 不限网络 <code>wifi</code>: 仅wifi下预下载</td>
</tr>
</tbody>
</table>
<p>说明：</p>
<ul>
<li><code>network</code>建议使用<code>all</code>；</li>
<li>所有预下载的分包的总体积要小于2m，限额会打包自动校验；</li>
</ul>
<blockquote>
<p>不是必要，不是非常影响用户的交互体验，不要占用预下载分包的份额，不要使用大于40k的图片与资源。</p>
</blockquote>
<h3 id="检查分包大小"><a href="#检查分包大小" class="headerlink" title="#检查分包大小"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#检查分包大小">#</a>检查分包大小</h3><ul>
<li>使用HBuilder中的发布方式打包；</li>
</ul>
<ul>
<li>在详情中进行查看：</li>
</ul>
<p>  点击查看详情，用于排查哪些比较大的资源：</p>
<p>  <img src="uniapp.assets/image-20210818001614038.b58d4f6c.png" alt="image-20210818001614038"></p>
<h2 id="基本流程"><a href="#基本流程" class="headerlink" title="#基本流程"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#基本流程">#</a>基本流程</h2><p><img src="uniapp.assets/5.2.ac870e6c.ac870e6c.png" alt="img"></p>
<ul>
<li>测试-检查-打包-配置</li>
<li>在开发工具中上传</li>
<li>管理后台中，提交审核，通过后发布</li>
</ul>
<h3 id="成员说明"><a href="#成员说明" class="headerlink" title="#成员说明"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#成员说明">#</a>成员说明</h3><p>小程序成员管理包括对小程序项目成员及体验成员的管理。</p>
<ul>
<li>项目成员：表示参与小程序开发、运营的成员，可登录小程序管理后台，包括运营者、开发者及数据分析者。管理员可在“成员管理”中添加、删除项目成员，并设置项目成员的角色。</li>
<li>体验成员：表示参与小程序内测体验的成员，可使用体验版小程序，但不属于项目成员。管理员及项目成员均可添加、删除体验成员。</li>
</ul>
<p>不同项目成员拥有不同的权限，从而保证小程序开发安全有序。</p>
<table>
<thead>
<tr>
<th style="text-align:left">权限</th>
<th style="text-align:left">运营者</th>
<th style="text-align:left">开发者</th>
<th style="text-align:left">数据分析者</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">开发者权限</td>
<td style="text-align:left"></td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">体验者权限</td>
<td style="text-align:left">√</td>
<td style="text-align:left">√</td>
<td style="text-align:left">√</td>
</tr>
<tr>
<td style="text-align:left">登录</td>
<td style="text-align:left">√</td>
<td style="text-align:left">√</td>
<td style="text-align:left">√</td>
</tr>
<tr>
<td style="text-align:left">数据分析</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
<td style="text-align:left">√</td>
</tr>
<tr>
<td style="text-align:left">微信支付</td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">推广</td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">开发管理</td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">开发设置</td>
<td style="text-align:left"></td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">暂停服务</td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">解除关联公众号</td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">腾讯云管理</td>
<td style="text-align:left"></td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">小程序插件</td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">游戏运营管理</td>
<td style="text-align:left">√</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>配置路径：登录<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/，选择管理">https://mp.weixin.qq.com/，选择管理</a> -&gt; 成员管理 -&gt; 添加项目成员，最多100个；体验成员-&gt;最多100个（已认证）；</p>
<p><img src="uniapp.assets/image-20210818123401415.973c514f.png" alt="image-20210818123401415"></p>
<h3 id="版本说明"><a href="#版本说明" class="headerlink" title="#版本说明"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#版本说明">#</a>版本说明</h3><table>
<thead>
<tr>
<th style="text-align:left"><strong>权限</strong></th>
<th style="text-align:left"><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">开发版本</td>
<td style="text-align:left">使用开发者工具，可将代码上传到开发版本中。 开发版本只保留每人最新的一份上传的代码。 点击提交审核，可将代码提交审核。开发版本可删除，不影响线上版本和审核中版本的代码。</td>
</tr>
<tr>
<td style="text-align:left">体验版本</td>
<td style="text-align:left">可以选择某个开发版本作为体验版，并且选取一份体验版。</td>
</tr>
<tr>
<td style="text-align:left">审核中版本</td>
<td style="text-align:left">只能有一份代码处于审核中。有审核结果后可以发布到线上，也可直接重新提交审核，覆盖原审核版本。</td>
</tr>
<tr>
<td style="text-align:left">线上版本</td>
<td style="text-align:left">线上所有用户使用的代码版本，该版本代码在新版本代码发布后被覆盖更新。</td>
</tr>
</tbody>
</table>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="#注意事项"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#注意事项">#</a>注意事项</h2><h3 id="配置BaseURL"><a href="#配置BaseURL" class="headerlink" title="#配置BaseURL"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#配置baseurl">#</a>配置BaseURL</h3><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> baseUrl = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span> ? <span class="hljs-string">&#x27;http://192.168.31.132:3000&#x27;</span> : <span class="hljs-string">&#x27;https://yourdomain.com&#x27;</span><br></code></pre></td></tr></table></figure>
<blockquote>
<p>uniapp内置的打包工具即是webpack</p>
</blockquote>
<p>说明：</p>
<ul>
<li><p>uniapp中，使用发布方式打包，即<code>process.env.NODE_ENV</code>会自动设置成<code>production</code>；</p>
</li>
<li><p>在上线之前，请确保配置了api后台项目，并申请了域名，配置好了HTTPS服务；</p>
</li>
<li><p>在小程序后台中，添加安全域名：</p>
</li>
</ul>
<h3 id="使用HBuilder生产打包方式"><a href="#使用HBuilder生产打包方式" class="headerlink" title="#使用HBuilder生产打包方式"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#使用hbuilder生产打包方式">#</a>使用HBuilder生产打包方式</h3><p>一定要注意，在uniapp中开发的时候，启动的是调试进程，这时的代码中有很多调试代码，也未进行压缩。</p>
<p>步骤：</p>
<ul>
<li><p>打开项目的<code>pages.json</code>文件；</p>
</li>
<li><p>点击顶部的菜单：<code>发行</code>-&gt; <code>小程序-微信</code></p>
</li>
</ul>
<h2 id="打包上线"><a href="#打包上线" class="headerlink" title="#打包上线"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#打包上线">#</a>打包上线</h2><h3 id="小程序打包"><a href="#小程序打包" class="headerlink" title="#小程序打包"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#小程序打包">#</a>小程序打包</h3><p>见 <a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#检查分包大小">检查分包大小</a>，注意这里的项目名称并非小程序的项目名称。</p>
<blockquote>
<p>小程序的名称在注册小程序的时候，就已经确定下来了，这里只是一个项目别名。</p>
</blockquote>
<p>请检查小程序的AppID。</p>
<h3 id="上传代码"><a href="#上传代码" class="headerlink" title="#上传代码"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#上传代码">#</a>上传代码</h3><p><img src="uniapp.assets/image-20210818123801710.34fb94d4.png" alt="image-20210818123801710"></p>
<p>上传代码是用于提交体验或者审核使用的。</p>
<p>点击开发者工具顶部操作栏的上传按钮，填写版本号以及项目备注，需要注意的是，这里版本号以及项目备注是为了方便管理员检查版本使用的，开发者可以根据自己的实际要求来填写这两个字段。</p>
<p><img src="uniapp.assets/image-20210818124047238.169f3490.png" alt="image-20210818124047238"></p>
<h2 id="审核与发布"><a href="#审核与发布" class="headerlink" title="#审核与发布"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#审核与发布">#</a>审核与发布</h2><h3 id="审核版本"><a href="#审核版本" class="headerlink" title="#审核版本"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#审核版本">#</a>审核版本</h3><p>上传成功之后，登录<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">小程序管理后台 (opens new window)</a>- 开发管理 - 开发版本 就可以找到刚提交上传的版本了。</p>
<p>可以将这个版本设置 体验版 或者是 提交审核。</p>
<p><img src="uniapp.assets/image-20210818124719121.d35f55fa.png" alt="image-20210818124719121"></p>
<p>然后点击下一步：</p>
<p><img src="uniapp.assets/image-20210818124806867.cce75ad9.png" alt="image-20210818124806867"></p>
<p>说明：</p>
<ul>
<li>加急的情况：与用户的钱有关，与平台的稳定有关，与自身的利益有关，才加急——慎用；</li>
<li>上面一般要写一个注释，说明版本的升级情况；</li>
</ul>
<p>审核中：</p>
<p><img src="uniapp.assets/image-20210818125910968.f62dbdcc.png" alt="image-20210818125910968"></p>
<h3 id="关于灰度发布"><a href="#关于灰度发布" class="headerlink" title="#关于灰度发布"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/11-发布上线.html#关于灰度发布">#</a>关于灰度发布</h3><p>审核通过后，需要在页面中点击发布，选择全量发布或者指定用户进行发布（灰度测试）。</p>
<p>点击发布后，即可发布小程序。小程序提供了两种发布模式：全量发布和分阶段发布。全量发布是指当点击发布之后，所有用户访问小程序时都会使用当前最新的发布版本。</p>
<p>分阶段发布是指分不同时间段来控制部分用户使用最新的发布版本，分阶段发布我们也称为灰度发布。一般来说，普通小程序发布时采用全量发布即可，当小程序承载的功能越来越多，使用的用户数越来越多时，采用分阶段发布是一个非常好的控制风险的办法。</p>
<h1 id="支付专题"><a href="#支付专题" class="headerlink" title="#支付专题"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#支付专题">#</a>支付专题</h1><p>支付作为工作中最常见的一个核心业务场景，前端同学其实需要做的东西有限，基本的流程、逻辑与难点都是在服务端。为了让前端同学，也能自己后续开发支付功能（Node.js），在本篇介绍了详细的从企业主体 -&gt; 支付必要条件 -&gt;微信小程序支付完整的闭环。</p>
<p>支付业务支撑：</p>
<ul>
<li>商城应用</li>
<li>金融产品</li>
<li>充值应用（会员、点券）</li>
<li>…</li>
</ul>
<p>支付应用场景：</p>
<ul>
<li>H5支付 -&gt; 扫码、跳转App</li>
<li>小程序</li>
<li>移动App</li>
</ul>
<p>支付的技术难点：</p>
<ul>
<li>多平台（微信、支付宝、银联）</li>
<li>安全性（HTTPS、全流程日志、交易备案、数据安全性如灾备…）</li>
</ul>
<p>常见的问题：</p>
<ul>
<li>支付的开发流程，是不是前端不用管？只用调接口——是的，举例：小程序前端，其实上只是wx.requestPayment调起支付即可；</li>
<li>支付功能的开通容易吗？——容易，但是针对于个人，无法开通微信支付；个人能开通吗？——不行，但是可以使用第三方服务，比如JSAPI；</li>
<li>服务端对接常见的支付功能的流程是怎样的？——基本步骤如下：<ol>
<li>申请微信小程序账号</li>
<li>微信小程序认证</li>
<li>申请商户平台账号</li>
<li>信小程序关联商户号</li>
<li>接入微信支付</li>
</ol>
</li>
</ul>
<h2 id="企业注册与税务"><a href="#企业注册与税务" class="headerlink" title="#企业注册与税务"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#企业注册与税务">#</a>企业注册与税务</h2><p>开办企业需要注意：</p>
<ul>
<li><p>财税问题，如果零报税，则需要企业年报每年需要申报。</p>
<p>开办企业不是玩，一定要负责任。而且，不良的企业负债，可能会影响到个人的征信，最终无法贷款、乘车等。</p>
</li>
<li><p>股份问题：如果多人开办，千万不要对半</p>
<p>多人入股不能均分，不能0资金入股，分股用期权；</p>
<p>设计退股机制，分红机制，以及债务问题解决办法；</p>
<p>股权主要的目的是激励；</p>
</li>
<li><p>利益分配问题：天下熙熙皆为利来，天下攘攘皆为利往；</p>
</li>
</ul>
<p>无论是支付宝还是微信，能够支持的支付主体只有企业、个体工商户和政府及事业单位等，共同点是<strong>非个人</strong>。</p>
<blockquote>
<p>个人开发者，如果需要接入支付功能，也可以选择第三方服务商：</p>
<ul>
<li>PayJS：开通费用300+手续费0.38%+服务费2%</li>
<li>PaysApi：月付手续费30-199+单笔费率从0.3~0.1%不等</li>
<li>PayBob：开通费用300+手续费0.38%+服务费1-2%</li>
<li>xorpay：月付手续费0-60+手续费0.38%+单笔手续费1.2%~0.5%不等</li>
</ul>
</blockquote>
<p>了解企业的注册流程及税务相关的知识，有助于学习支付相关的内容，扩展知识面。</p>
<p>企业注册比较麻烦的地方：</p>
<ul>
<li>设立登记可能要跑几躺</li>
<li>税务登记 + 银行开户 折腾个10几天</li>
<li>报税：有季报+年报（工商年报次年6月前、汇缴清算不定）</li>
</ul>
<p>但是，开办企业也是有好处的，举例：</p>
<ul>
<li>作为团队出去接项目</li>
<li>大多数网上的服务针对的是企业</li>
<li>国家政府对于小微企业现在有大力的扶持</li>
</ul>
<h3 id="注册企业流程"><a href="#注册企业流程" class="headerlink" title="#注册企业流程"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#注册企业流程">#</a>注册企业流程</h3><p><img src="./assets/图片 1.png" alt="图片 1"></p>
<p>企业注册流程中，需要注意的点：</p>
<ul>
<li><p>准备工作（场地、人员、名称）</p>
<p>公司查名各地有各地的查询网址或者在工商管理部门办事大厅进行现场查重（因为可能会重名，所以需要多准备几个）</p>
<p>湖北企业查名查重：<a target="_blank" rel="noopener" href="http://scjg.hubei.gov.cn/ICPSP/newNamecheck/nameCheck.action">http://scjg.hubei.gov.cn/ICPSP/newNamecheck/nameCheck.action</a></p>
<p>企业经营范围查询网址：<a target="_blank" rel="noopener" href="https://jyfwyun.com/">https://jyfwyun.com/</a></p>
</li>
<li><p>提交资料（章程、住所证明）</p>
<p>可以在当地的区（县）政务中心领取材料 或者在其网站上下载对应的模板文件，自行打印与复印。</p>
</li>
<li><p>办理税务+银行开户</p>
<p>当办理完企业登记，并核发营业执照之后，可以输税务与企业银行开户。</p>
<p>各家银行的开户费用大体相同，只是服务可能不一样，大家可以选择几家对比一下。推荐：招商与中兴。</p>
<p>选择银行需要注意：</p>
<ul>
<li>服务问题；</li>
<li>便利性——不要选择一家离自己办公点或者家很远的地方；</li>
</ul>
</li>
</ul>
<h3 id="个人工商户与企业区别"><a href="#个人工商户与企业区别" class="headerlink" title="#个人工商户与企业区别"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#个人工商户与企业区别">#</a>个人工商户与企业区别</h3><p>共同点：</p>
<ul>
<li>流程：个体要记账、交税、年检、审批，也会被抽查</li>
<li>税费：与小微企业无异</li>
</ul>
<p>不同点：</p>
<ul>
<li>债务：个体负责到底-无限，公司申请破产保护-有限责任</li>
<li>规模：个体8人不能上市，公司可以设立分机构、上市</li>
<li>业务：个体不能做进出口业务</li>
<li>经营 ：个体限制经营范围</li>
<li>税费：税种不一样，征收方式不一样</li>
</ul>
<h3 id="自己注册vs代注册"><a href="#自己注册vs代注册" class="headerlink" title="#自己注册vs代注册"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#自己注册vs代注册">#</a>自己注册vs代注册</h3><p><strong>自己注册：</strong></p>
<p>优点：</p>
<ul>
<li>没有费用</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要花时间</li>
<li>需要了解整体流程</li>
<li>需要去税务、银行</li>
</ul>
<p><strong>代注册：</strong></p>
<p>优点：</p>
<ul>
<li>省时间</li>
<li>省事（办证、税务、企业银行、注册地、资料准备一条龙）</li>
</ul>
<p>缺点：</p>
<ul>
<li>费用不等，从3000-6000，甚至更多；</li>
<li>后续可能会有代账、年租费用等；</li>
<li>开票&amp;办税也会收费；</li>
</ul>
<h3 id="报税-amp-开票"><a href="#报税-amp-开票" class="headerlink" title="#报税&amp;开票"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#报税-开票">#</a>报税&amp;开票</h3><p>大多数企业会找一个代账会计或者找一个代账公司，而企业前期是无需会计的，完全可以零报税，操作流程非常的简单。</p>
<p>如果不清楚报税的流程，可以在税务机关处进行现场报税。</p>
<p>代账费用：从200元到300元/月不等。</p>
<p>找了代账的企业需要会看如下的几个表格，了解概念：</p>
<ul>
<li>利润表：你赚了多少钱！</li>
<li>资产负债表：有没有欠你的钱、你欠的钱，余下的钱</li>
</ul>
<p>除了找代账公司以外，Brain更推荐自己在前期进行记账与报税，流程不复杂，而且软件非常的智能，只用填入自己的收入与支出，财务软件可以自动形成报表。</p>
<p>财务软件推荐：</p>
<ul>
<li>金碟</li>
<li>用友</li>
</ul>
<p>云平台推荐：</p>
<ul>
<li>柠檬云</li>
</ul>
<blockquote>
<p>季度+年度报税：3个月报季报，照着软件填</p>
</blockquote>
<h3 id="企业日常的开销"><a href="#企业日常的开销" class="headerlink" title="#企业日常的开销"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#企业日常的开销">#</a>企业日常的开销</h3><p>主要分为如下几类：</p>
<ul>
<li>资产：办公设备如打印机、办公桌椅、空调等</li>
<li>费用：租赁场地、水+电+网</li>
<li>费用：人员（会计、开发、产品等）</li>
<li>…</li>
</ul>
<p>从上面的分类来看，注册企业没有什么费用，反而是维持一个企业的运转是需要大量费用的。大家在准备企业开办之前，需要有一定的准备。</p>
<blockquote>
<p>不打没有准备的仗，也不要什么都准备好了，才开始！！</p>
</blockquote>
<h2 id="支付前置必要条件"><a href="#支付前置必要条件" class="headerlink" title="#支付前置必要条件"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#支付前置必要条件">#</a>支付前置必要条件</h2><p>下面以微信支付为例，来介绍，开发支付功能需要准备的前置条件：</p>
<ul>
<li>选择合适的主体&amp;场景（企业服务号）微信（支付宝）认证；</li>
<li>域名+公网IP+HTTPS；</li>
<li>云服务器ICP备案；</li>
</ul>
<p>微信支付：</p>
<ul>
<li>主体问题：订阅号非媒体号无法支付，推荐企业服务号；</li>
<li>小程序：必须HTTPS + ICP备案；</li>
<li>开通商户号，也需要企业主体，与公众号&amp;小程序同一主体；</li>
</ul>
<p>支付宝支付：</p>
<ul>
<li><p>主体问题：企业主体；</p>
</li>
<li><p>行业类目及资质要求，<a target="_blank" rel="noopener" href="https://opendocs.alipay.com/iot/multi-platform/material">文档 (opens new window)</a>；</p>
<p>而且对于实体店铺审核要严格一些。</p>
</li>
</ul>
<p><img src="uniapp.assets/image-20210830134004706.f4a99b49.png" alt="image-20210830134004706"></p>
<p>说明：</p>
<ul>
<li>关于ICP备案，可以参考：<a target="_blank" rel="noopener" href="https://beian.aliyun.com/">阿里云 (opens new window)</a>、<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/ba">腾讯云 (opens new window)</a>（前置条件：域名、云服务器）；</li>
<li>HTTPS：必须要有域名，必须要有一台云服务器；</li>
<li>微信商户号，对应的网址：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/">https://pay.weixin.qq.com/</a></li>
</ul>
<h2 id="小程序支付流程"><a href="#小程序支付流程" class="headerlink" title="#小程序支付流程"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#小程序支付流程">#</a>小程序支付流程</h2><h3 id="开发技巧"><a href="#开发技巧" class="headerlink" title="#开发技巧"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#开发技巧">#</a>开发技巧</h3><ul>
<li>技术问题，先读文档，查找官方的社区；</li>
<li>比较主流的支付方案，可以搜索一下有没有Node.js侧的npm包，例如：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/wechatpay-axios-plugin">wechatpay-axios-plugin (opens new window)</a>是一个非常不错的支持v2/v3的npm包，ts风格；</li>
<li>问stackoverflow、知乎、csdn等；</li>
<li>最后，才考虑自己开发轮子；</li>
</ul>
<p>如果是学习，也可以从0到1的开发，了解整个支付的流程。</p>
<h3 id="流程图"><a href="#流程图" class="headerlink" title="#流程图"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#流程图">#</a>流程图</h3><p>学会看时序图：</p>
<ul>
<li>最上面的是角色</li>
<li>从左往右看，按照箭头的方向走</li>
<li>从上往下看，是时间关系流程的流转</li>
</ul>
<p><img src="uniapp.assets/6_2.39c8c442.png" alt="img"></p>
<p>重点步骤说明：</p>
<p>步骤3：用户下单发起支付，商户可通过<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml">JSAPI下单 (opens new window)</a>创建支付订单。</p>
<p>步骤8： 用户可通过<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_4.shtml">小程序调起支付API (opens new window)</a>调起微信支付，发起支付请求。</p>
<p>步骤15：用户支付成功后，商户可接收到微信支付支付结果通知<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml">支付通知API (opens new window)</a>。</p>
<p>步骤20：商户在没有接收到微信支付结果通知的情况下需要主动调用<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml">查询订单API (opens new window)</a>查询支付结果。</p>
<h2 id="搭建开发环境-1"><a href="#搭建开发环境-1" class="headerlink" title="#搭建开发环境"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#搭建开发环境">#</a>搭建开发环境</h2><h3 id="支付准备"><a href="#支付准备" class="headerlink" title="#支付准备"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#支付准备">#</a>支付准备</h3><p><img src="uniapp.assets/image-20210830135731466.7d34db68.png" alt="image-20210830135731466"></p>
<p>按照上面的流程，准备相关的开发环境，参考指引：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_8_1.shtml">官方链接(opens new window)</a></p>
<h3 id="配置Https-域名解析"><a href="#配置Https-域名解析" class="headerlink" title="#配置Https+域名解析"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#配置https-域名解析">#</a>配置Https+域名解析</h3><p>说明：</p>
<ul>
<li><p>前置的章节有介绍HTTPS介绍，<a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/07-安全域名相关.html#ssl证书申请">文章</a></p>
</li>
<li><p>域名解析以阿里云为例：</p>
<p><img src="uniapp.assets/image-20210830140428900.83fd5ad0.png" alt="image-20210830140428900"></p>
</li>
</ul>
<h3 id="配置API密钥"><a href="#配置API密钥" class="headerlink" title="#配置API密钥"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#配置api密钥">#</a>配置API密钥</h3><p><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/">商户平台 (opens new window)</a>-&gt; 账户中心 -&gt; API安全，分别配置API商户证书 + APIv3密钥</p>
<p><img src="uniapp.assets/image-20210830140522534.b857eaea.png" alt="image-20210830140522534"></p>
<h3 id="配置frp内网穿透"><a href="#配置frp内网穿透" class="headerlink" title="#配置frp内网穿透"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#配置frp内网穿透">#</a>配置frp内网穿透</h3><p>为了方便测试微信支付通知，有两种方案：</p>
<ul>
<li><p>上传API服务到测试服务器：</p>
<p><img src="uniapp.assets/image-20210830140648414.f3ff8b55.png" alt="image-20210830140648414"></p>
</li>
<li><p>使用本地的API服务，需要使用frp工具把远程的通知转发到本地：</p>
<p><img src="uniapp.assets/image-20210830140722039.310b80f5.png" alt="image-20210830140722039"></p>
</li>
</ul>
<p>配置过程如下：</p>
<ul>
<li><p>下载frp包到本地，见<a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/releases">release (opens new window)</a>（darwin是mac系统、windows、Linux要分arm与amd）；</p>
</li>
<li><p>SSH到远程服务端，新建配置文件<code>/home/frp/frps.ini</code>：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx">[common]<br><span class="hljs-attribute">bind_port</span> = <span class="hljs-number">10010</span><br>vhost_https_port = <span class="hljs-number">443</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>在服务器上运行frps，使用docker镜像：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">docker run --restart=always --network host -d -v /home/frp/frps.ini:/etc/frp/frps.ini --name frps snowdreamtech/frps<br></code></pre></td></tr></table></figure>
</li>
<li><p>下载let’s encrypt创建的SSL证书 -&gt; 一般在acme生成的目录中-&gt;放置到本地解压的frp目录中；</p>
<p><img src="uniapp.assets/image-20210830141415349.46683708.png" alt="image-20210830141415349"></p>
</li>
<li><p>在本地创建<code>frpc.ini</code>文件</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx">[common]<br><span class="hljs-attribute">server_addr</span> = <span class="hljs-number">121.36.194.226</span><br>server_port = <span class="hljs-number">10010</span><br><br>[test_htts2http]<br>type = https<br>custom_domains = test1.toimc.com<br><br>plugin = https2http<br>plugin_local_addr = <span class="hljs-number">127.0.0.1:3000</span><br><br><span class="hljs-comment"># HTTPS 证书相关的配置</span><br>plugin_crt_path = ./fullchain.pem<br>plugin_key_path = ./key.pem<br>plugin_host_header_rewrite = <span class="hljs-number">127.0.0.1</span><br>plugin_header_X-From-Where = frp<br>; test1.toimc.<span class="hljs-attribute">com</span> -&gt; vhost_https_port <span class="hljs-number">443</span><br>; test1.toimc.com:443 -&gt; <span class="hljs-attribute">frp</span> -&gt; <span class="hljs-number">127.0.0.1:3000</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>使用frpc运行该配置文件：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">chmod +x frpc<br>./frpc -c ./frpc.ini<br></code></pre></td></tr></table></figure>
<p>运行成功的提示：</p>
<p><img src="uniapp.assets/image-20210830141622200.32b8bdce.png" alt="image-20210830141622200"></p>
</li>
</ul>
<p>如果运行失败，可以在<a target="_blank" rel="noopener" href="https://gofrp.org/">官方网站 (opens new window)</a>上查询失败的原因：</p>
<ul>
<li>官方FAQ：<a target="_blank" rel="noopener" href="https://gofrp.org/docs/faq/">https://gofrp.org/docs/faq/</a></li>
<li>官方Issues：<a target="_blank" rel="noopener" href="https://github.com/fatedier/frp/issues">https://github.com/fatedier/frp/issues</a></li>
</ul>
<h2 id="APIv3-vs-APIv2"><a href="#APIv3-vs-APIv2" class="headerlink" title="#APIv3 vs APIv2"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#apiv3-vs-apiv2">#</a>APIv3 vs APIv2</h2><p>为了在 保证支付 安全的前提下，带给商户 简单、一致且易用的开发体验，我们推出了全新的微信支付API v3。</p>
<p>相较于之前的微信支付API，主要区别是：</p>
<ul>
<li>遵循统一的REST 的设计风格</li>
<li>使用JSON作为数据交互的格式，不再使用XML</li>
<li>使用基于非对称密钥的SHA256-RSA的数字签名算法，不再使用MD5或HMAC-SHA256</li>
<li>不再要求HTTPS客户端证书</li>
<li>使用AES-256-GCM，对回调中的关键信息进行加密保护</li>
</ul>
<p>APIv3的文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay-1.shtml">官方链接(opens new window)</a></p>
<p>两个接口的对接图：</p>
<table>
<thead>
<tr>
<th><strong>V3</strong></th>
<th><strong>规则差异</strong></th>
<th><strong>V2</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>JSON</td>
<td>参数格式</td>
<td>XML</td>
</tr>
<tr>
<td>POST、GET 或 DELETE</td>
<td>提交方式</td>
<td>POST</td>
</tr>
<tr>
<td>AES-256-GCM加密</td>
<td>回调加密</td>
<td>无需加密</td>
</tr>
<tr>
<td>RSA 加密</td>
<td>敏感加密</td>
<td>无需加密</td>
</tr>
<tr>
<td>UTF-8</td>
<td>编码方式</td>
<td>UTF-8</td>
</tr>
<tr>
<td>非对称密钥SHA256-RSA</td>
<td>签名方式</td>
<td>MD5 或 HMAC-SHA256</td>
</tr>
</tbody>
</table>
<p><strong>推荐：在没有接触v2的情况下，直接上手v3；如果有老旧业务，也可以对接到v3，或者不动原有的业务，直至v2的证书快过期，需要更换时，再切换到v3。</strong></p>
<h2 id="JSAPI统一下单"><a href="#JSAPI统一下单" class="headerlink" title="#JSAPI统一下单"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#jsapi统一下单">#</a>JSAPI统一下单</h2><h3 id="签名生成"><a href="#签名生成" class="headerlink" title="#签名生成"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#签名生成">#</a>签名生成</h3><p><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml">官方文档(opens new window)</a></p>
<p>商户可以按照下述步骤生成请求的签名，微信支付API v3 要求商户对请求进行签名，微信支付会在收到请求后进行签名的验证。</p>
<p><strong>如果签名验证不通过，微信支付API v3将会拒绝处理请求，并返回<code>401 Unauthorized</code>。</strong></p>
<p>签名生成的步骤有：</p>
<ul>
<li><p>构造签名串</p>
<p>签名串一共有五行，每一行为一个参数。行尾以 <code>\n</code>（换行符，ASCII编码值为0x0A）结束，包括最后一行。如果参数本身以<code>\n</code>结束，也需要附加一个<code>\n</code>。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-variable constant_">HTTP</span>请求方法\n<br><span class="hljs-variable constant_">URL</span>\n<br>请求时间戳\n<br>请求随机串\n<br>请求报文主体\n <br></code></pre></td></tr></table></figure>
</li>
<li><p>计算签名值</p>
<p>使用商户私钥对待签名串进行SHA256 with RSA签名，并对签名结果进行Base64编码得到签名值，示例：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ <span class="hljs-built_in">echo</span> -n -e \<br><span class="hljs-string">&quot;GET\n/v3/certificates\n1554208460\n593BEC0C930BF1AFEB40B4A08C8FB242\n\n&quot;</span> \<br>  | openssl dgst -sha256 -sign apiclient_key.pem \<br>  | openssl <span class="hljs-built_in">base64</span> -A<br>  uOVRnA4qG/MNnYzdQxJanN+zU+lTgIcnU9BxGw5dKjK+VdEUz2FeIoC+D5sB/LN+nGzX3hfZg6r5wT1pl2ZobmIc6p0ldN7J6yDgUzbX8Uk3sD4a4eZVPTBvqNDoUqcYMlZ9uuDdCvNv4TM3c1WzsXUrExwVkI1XO5jCNbgDJ25nkT/c1gIFvqoogl7MdSFGc4W4xZsqCItnqbypR3RuGIlR9h9vlRsy7zJR9PBI83X8alLDIfR1ukt1P7tMnmogZ0cuDY8cZsd8ZlCgLadmvej58SLsIkVxFJ8XyUgx9FmutKSYTmYtWBZ0+tNvfGmbXU7cob8H/4nLBiCwIUFluw==<br></code></pre></td></tr></table></figure>
</li>
</ul>
<p>第一步比较好实现：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// HTTP请求方法\n</span><br><span class="hljs-comment">// URL\n  https://www.imooc.com/path1/path2/?query1=value</span><br><span class="hljs-comment">// 请求时间戳\n</span><br><span class="hljs-comment">// 请求随机串\n</span><br><span class="hljs-comment">// 请求报文主体\n</span><br><span class="hljs-keyword">const</span> tmpUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url)<br><span class="hljs-keyword">const</span> nonceStr = rand.<span class="hljs-title function_">generate</span>(<span class="hljs-number">16</span>)<br><span class="hljs-keyword">const</span> pathname = <span class="hljs-regexp">/http/</span>.<span class="hljs-title function_">test</span>(url) ? tmpUrl.<span class="hljs-property">pathname</span> : url<br><span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() / <span class="hljs-number">1000</span>)<br><span class="hljs-keyword">const</span> message = <span class="hljs-string">`<span class="hljs-subst">$&#123;method.toUpperCase()&#125;</span>\n<span class="hljs-subst">$&#123;pathname + tmpUrl.search</span></span><br><span class="hljs-subst"><span class="hljs-string">  &#125;</span>\n<span class="hljs-subst">$&#123;timestamp&#125;</span>\n<span class="hljs-subst">$&#123;nonceStr&#125;</span>\n<span class="hljs-subst">$&#123;body ? <span class="hljs-built_in">JSON</span>.stringify(body) : <span class="hljs-string">&#x27;&#x27;</span>&#125;</span>\n`</span><br></code></pre></td></tr></table></figure>
<p>第二步的RSA的算法实现思路：</p>
<ul>
<li>找一下微信社区有没有类似实现</li>
<li>找一下网上有没有类似实现</li>
<li>找一下有没有npm开源包</li>
<li>找一下stackoverflow或者百度</li>
<li>…</li>
</ul>
<p>如果 以上都没有，那么就要自己造轮子了。但是这样的场景少之有少，哈哈，还轮不上大家自己上。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">rsaSign</span> = (<span class="hljs-params">message</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> keyPem = fs.<span class="hljs-title function_">readFileSync</span>(<br>    path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;keys/apiclient_key.pem&#x27;</span>),<br>    <span class="hljs-string">&#x27;utf-8&#x27;</span><br>  )<br>  <span class="hljs-keyword">const</span> signature = crypto<br>    .<span class="hljs-title function_">createSign</span>(<span class="hljs-string">&#x27;RSA-SHA256&#x27;</span>)<br>    .<span class="hljs-title function_">update</span>(message, <span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    .<span class="hljs-title function_">sign</span>(keyPem, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>  <span class="hljs-keyword">return</span> signature<br>&#125;<br></code></pre></td></tr></table></figure>
<p>然后使用上面合成的message进行签名即可：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> signature = <span class="hljs-title function_">rsaSign</span>(message)<br></code></pre></td></tr></table></figure>
<p><strong>如何验证呢？</strong></p>
<p>方案一：</p>
<p>Linux或者mac直接使用openssl来进行验证</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">echo -n -e \<br>&quot;GET\n/v3/certificates\n1554208460\n593BEC0C930BF1AFEB40B4A08C8FB242\n\n&quot; \<br>  | openssl dgst -sha256 -sign apiclient_key.pem \<br>  | openssl base64 -A<br></code></pre></td></tr></table></figure>
<p>方案二：</p>
<p>使用老师给大家准备的docker镜像进行验证<code>lw96/libressl</code>：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1.创建容器</span><br>docker run -itd --name ssl lw96/libressl<br><br><span class="hljs-comment"># 2.拷贝证书</span><br>docker <span class="hljs-built_in">cp</span> 证书目录 容器<span class="hljs-built_in">id</span>:/tmp<br><br><span class="hljs-comment"># 3.进入容器</span><br>docker <span class="hljs-built_in">exec</span> -it ssl sh<br><br><span class="hljs-comment"># 4.使用上面的一样的命令</span><br><span class="hljs-built_in">echo</span> -n -e \<br><span class="hljs-string">&quot;GET\n/v3/certificates\n1554208460\n593BEC0C930BF1AFEB40B4A08C8FB242\n\n&quot;</span> \<br>  | openssl dgst -sha256 -sign /tmp/apiclient_key.pem \<br>  | openssl <span class="hljs-built_in">base64</span> -A<br></code></pre></td></tr></table></figure>
<h3 id="Authentication头部密钥串"><a href="#Authentication头部密钥串" class="headerlink" title="#Authentication头部密钥串"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#authentication头部密钥串">#</a>Authentication头部密钥串</h3><p>微信支付商户API v3要求请求通过<code>HTTP Authorization</code>头来传递签名。<code>Authorization</code>由<em>认证类型</em>和<em>签名信息</em>两个部分组成。</p>
<p>下面我们使用命令行演示如何生成签名。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">Authorization: 认证类型 签名信息<br></code></pre></td></tr></table></figure>
<p>具体组成为：</p>
<p>1.认证类型，目前为WECHATPAY2-SHA256-RSA2048</p>
<p>2.签名信息</p>
<ul>
<li>发起请求的商户（包括直连商户、服务商或渠道商）的商户号<code>mchid</code></li>
<li><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml">商户API证书 (opens new window)</a><code>serial_no</code>，用于<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml#part-3">声明所使用的证书 (opens new window)</a>（管理员账号登录微信商户管理后台，在API安全里面点击查看证书可以获取。）</li>
<li>请求随机串<code>nonce_str</code></li>
<li>时间戳<code>timestamp</code></li>
<li>签名值<code>signature</code></li>
<li>注：以上五项签名信息，无顺序要求。</li>
</ul>
<p><code>Authorization</code> 头的示例如下：（注意，示例因为排版可能存在换行，实际数据应在一行）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Authorization: WECHATPAY2-SHA256-RSA2048 mchid=<span class="hljs-string">&quot;1900009191&quot;</span>,nonce_str=<span class="hljs-string">&quot;593BEC0C930B</span><br></code></pre></td></tr></table></figure>
<p>最终我们可以组一个包含了签名的HTTP请求了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ curl https://api.mch.weixin.qq.com/v3/certificates -H <span class="hljs-string">&#x27;Authorization: WECHATPAY2-SHA256-RSA2048 mchid=&quot;1900009191&quot;,nonce_str=&quot;593BEC0C930BF1AFEB40B4A08C8FB242&quot;,signature=&quot;uOVRnA4qG/MNnYzdQxJanN+zU+lTgIcnU9BxGw5dKjK+VdEUz2FeIoC+D5sB/LN+nGzX3hfZg6r5wT1pl2ZobmIc6p0ldN7J6yDgUzbX8Uk3sD4a4eZVPTBvqNDoUqcYMlZ9uuDdCvNv4TM3c1WzsXUrExwVkI1XO5jCNbgDJ25nkT/c1gIFvqoogl7MdSFGc4W4xZsqCItnqbypR3RuGIlR9h9vlRsy7zJR9PBI83X8alLDIfR1ukt1P7tMnmogZ0cuDY8cZsd8ZlCgLadmvej58SLsIkVxFJ8XyUgx9FmutKSYTmYtWBZ0+tNvfGmbXU7cob8H/4nLBiCwIUFluw==&quot;,timestamp=&quot;1554208460&quot;,serial_no=&quot;1DDE55AD98ED71D6EDD4A4A16996DE7B47773A8C&quot;&#x27;</span><br></code></pre></td></tr></table></figure>
<p>代码示例：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// config.js</span><br><span class="hljs-keyword">const</span> mchid = <span class="hljs-string">&#x27;xxxxx&#x27;</span><br><br><span class="hljs-keyword">const</span> serialNo = <span class="hljs-string">&#x27;xxxxx&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-comment">// ...</span><br>  mchid,<br>  serialNo<br>&#125;<br><br><span class="hljs-comment">// WxPay.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getSignHeaders</span> = (<span class="hljs-params">url, method, body</span>) =&gt; &#123;<br>  <span class="hljs-comment">// HTTP请求方法\n</span><br>  <span class="hljs-comment">// URL\n  https://www.imooc.com/path1/path2/?query1=value</span><br>  <span class="hljs-comment">// 请求时间戳\n</span><br>  <span class="hljs-comment">// 请求随机串\n</span><br>  <span class="hljs-comment">// 请求报文主体\n</span><br>  <span class="hljs-keyword">const</span> tmpUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url)<br>  <span class="hljs-keyword">const</span> nonceStr = rand.<span class="hljs-title function_">generate</span>(<span class="hljs-number">16</span>)<br>  <span class="hljs-keyword">const</span> pathname = <span class="hljs-regexp">/http/</span>.<span class="hljs-title function_">test</span>(url) ? tmpUrl.<span class="hljs-property">pathname</span> : url<br>  <span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() / <span class="hljs-number">1000</span>)<br>  <span class="hljs-keyword">const</span> message = <span class="hljs-string">`<span class="hljs-subst">$&#123;method.toUpperCase()&#125;</span>\n<span class="hljs-subst">$&#123;pathname + tmpUrl.search</span></span><br><span class="hljs-subst"><span class="hljs-string">    &#125;</span>\n<span class="hljs-subst">$&#123;timestamp&#125;</span>\n<span class="hljs-subst">$&#123;nonceStr&#125;</span>\n<span class="hljs-subst">$&#123;body ? <span class="hljs-built_in">JSON</span>.stringify(body) : <span class="hljs-string">&#x27;&#x27;</span>&#125;</span>\n`</span><br>  <span class="hljs-comment">// const keyPem = fs.readFileSync(path.join(__dirname, &#x27;keys/apiclient_key.pem&#x27;), &#x27;utf-8&#x27;)</span><br>  <span class="hljs-comment">// const signature = crypto.createSign(&#x27;RSA-SHA256&#x27;).update(message, &#x27;utf-8&#x27;).sign(keyPem, &#x27;base64&#x27;)</span><br>  <span class="hljs-keyword">const</span> signature = <span class="hljs-title function_">rsaSign</span>(message)<br>  <span class="hljs-comment">// 1.解决问题：windows上无openssl -&gt; lw96/libressl</span><br>  <span class="hljs-comment">// 2.需要传递apiclient_key.pem给镜像 -&gt; 因为只有在容器里面才能执行openssl</span><br>  <span class="hljs-comment">// 3.method1: docker cp  method2: -v</span><br>  <span class="hljs-comment">// 4.使用openssl进行签名 -&gt; 对比crypto产生的base64串</span><br><br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">headers</span>: <span class="hljs-string">`WECHATPAY2-SHA256-RSA2048 mchid=&quot;<span class="hljs-subst">$&#123;config.mchid&#125;</span>&quot;,nonce_str=&quot;<span class="hljs-subst">$&#123;nonceStr&#125;</span>&quot;,signature=&quot;<span class="hljs-subst">$&#123;signature&#125;</span>&quot;,timestamp=&quot;<span class="hljs-subst">$&#123;timestamp&#125;</span>&quot;,serial_no=&quot;<span class="hljs-subst">$&#123;config.serialNo&#125;</span>&quot;&#x27;`</span>,<br>    nonceStr,<br>    timestamp<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="接口说明"><a href="#接口说明" class="headerlink" title="#接口说明"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#接口说明">#</a>接口说明</h3><p>接口文档：<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml">JSAPI(opens new window)</a></p>
<p><strong>请求URL：</strong><a target="_blank" rel="noopener" href="https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi">https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi</a></p>
<p><strong>请求方式：</strong>POST</p>
<p>形成随机的商户订单号：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getTradeNo</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">// 服务端侧：out_trade_no -&gt; 订单号 -&gt; timestamp + type + id</span><br>  <span class="hljs-comment">// 1.Date.now()  2.Moment/dayjs</span><br>  <span class="hljs-comment">// 2. 01-小程序</span><br>  <span class="hljs-keyword">return</span> (<br>    <span class="hljs-title function_">dayjs</span>().<span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;YYYYMMDDHHmmssSSS&#x27;</span>) +<br>    <span class="hljs-string">&#x27;01&#x27;</span> +<br>    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">substr</span>(-<span class="hljs-number">10</span>)<br>  )<br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终，统一订单的接口：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">wxJSPAY</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123;<br>    description,<br>    goodsTag,<br>    total,<br>    <span class="hljs-attr">user</span>: &#123; openid &#125;,<br>    detail,<br>    sceneInfo,<br>    settleInfo<br>  &#125; = params<br>  <span class="hljs-comment">// https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi</span><br>  <span class="hljs-comment">// 小程序用户侧： description，amount:&#123;total&#125; -&gt; token -&gt; id -&gt; openid</span><br><br>  <span class="hljs-comment">// 参数准备</span><br>  <span class="hljs-keyword">const</span> wxParams = &#123;<br>    <span class="hljs-attr">appid</span>: config.<span class="hljs-property">AppID</span>,<br>    <span class="hljs-attr">mchid</span>: config.<span class="hljs-property">mchid</span>,<br>    description,<br>    <span class="hljs-attr">out_trade_no</span>: <span class="hljs-title function_">getTradeNo</span>(),<br>    <span class="hljs-attr">time_expire</span>: <span class="hljs-title function_">dayjs</span>().<span class="hljs-title function_">add</span>(<span class="hljs-number">30</span>, <span class="hljs-string">&#x27;m&#x27;</span>).<span class="hljs-title function_">format</span>(),<br>    <span class="hljs-attr">attach</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">notify_url</span>: <span class="hljs-string">&#x27;https://test1.toimc.com/public/notify&#x27;</span>,<br>    <span class="hljs-attr">goods_tag</span>: goodsTag,<br>    <span class="hljs-attr">amount</span>: &#123;<br>      <span class="hljs-attr">total</span>: <span class="hljs-built_in">parseInt</span>(total),<br>      <span class="hljs-attr">currency</span>: <span class="hljs-string">&#x27;CNY&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">payer</span>: &#123;<br>      openid<br>    &#125;,<br>    detail,<br>    <span class="hljs-attr">scene_info</span>: sceneInfo,<br>    <span class="hljs-attr">settle_info</span>: settleInfo<br>  &#125;<br>  <span class="hljs-keyword">const</span> url = <span class="hljs-string">&#x27;https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi&#x27;</span><br>	<span class="hljs-comment">// 头部签名  </span><br>  <span class="hljs-keyword">const</span> &#123; headers, nonceStr, timestamp &#125; = <span class="hljs-title function_">getSignHeaders</span>(<br>    url,<br>    <span class="hljs-string">&#x27;post&#x27;</span>,<br>    wxParams<br>  )<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(url, wxParams, &#123;<br>      <span class="hljs-attr">headers</span>: &#123;<br>        <span class="hljs-title class_">Authorization</span>: headers<br>      &#125;<br>    &#125;)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: WxPay.js ~ line 53 ~ wxJSPAY ~ result&#x27;</span>, result)<br>    <span class="hljs-keyword">const</span> &#123; status, data &#125; = result<br>    <span class="hljs-keyword">if</span> (status === <span class="hljs-number">200</span>) &#123;<br>      <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">prepayId</span>: data.<span class="hljs-property">prepay_id</span>, nonceStr, timestamp &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`wxJSPAY error: <span class="hljs-subst">$&#123;result&#125;</span>`</span>)<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`wxJSPAY error: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="用户支付"><a href="#用户支付" class="headerlink" title="#用户支付"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#用户支付">#</a>用户支付</h2><h3 id="支付步骤"><a href="#支付步骤" class="headerlink" title="#支付步骤"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#支付步骤">#</a>支付步骤</h3><p>前端步骤：</p>
<ul>
<li>用户下单 -&gt; 发起请求，让后端生成支付参数</li>
<li>用户支付 -&gt; wx.requestPayment调起支付</li>
</ul>
<p>后端步骤：</p>
<ul>
<li>使用JSAPI统一下单，产生的prepay_id（预支付id）</li>
<li>构造签名串 -&gt; 计算签名</li>
<li>返回前端支付参数</li>
</ul>
<h3 id="准备支付参数"><a href="#准备支付参数" class="headerlink" title="#准备支付参数"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#准备支付参数">#</a>准备支付参数</h3><p>第一步：</p>
<p><strong>造签名串</strong></p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">签名串一共有四行，每一行为一个参数。行尾以\n（换行符，ASCII编码值为0x0A）结束，包括最后一行。<br>如果参数本身以\n结束，也需要附加一个\n<br></code></pre></td></tr></table></figure>
<p><strong>参与签名字段及格式：</strong></p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">小程序appId<br>时间戳<br>随机字符串<br>订单详情扩展字符串<br></code></pre></td></tr></table></figure>
<p>第二步：</p>
<p><strong>计算签名：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> -n -e \<br><span class="hljs-string">&quot;wx8888888888888888\n1414561699\n5K8264ILTKCH16CQ2502SI8ZNMTM67VS\nprepay_id=wx201410272009395522657a690389285100\n&quot;</span> \<br>  | openssl dgst -sha256 -sign apiclient_key.pem \<br>  | openssl <span class="hljs-built_in">base64</span> -A<br></code></pre></td></tr></table></figure>
<p>参数：</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数名</th>
<th style="text-align:left">变量</th>
<th style="text-align:left">类型[长度限制]</th>
<th style="text-align:left">必填</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">时间戳</td>
<td style="text-align:left">timeStamp</td>
<td style="text-align:left">string[1,32]</td>
<td style="text-align:left">是</td>
<td style="text-align:left">当前的时间，其他详见<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/api/wxpay_v2/jiekouguize/chapter1_2.shtml#part-5">时间戳规则 (opens new window)</a>。 示例值：1414561699</td>
</tr>
<tr>
<td style="text-align:left">随机字符串</td>
<td style="text-align:left">nonceStr</td>
<td style="text-align:left">string[1,32]</td>
<td style="text-align:left">是</td>
<td style="text-align:left">随机字符串，不长于32位。 示例值：5K8264ILTKCH16CQ2502SI8ZNMTM67VS</td>
</tr>
<tr>
<td style="text-align:left">订单详情扩展字符串</td>
<td style="text-align:left">package</td>
<td style="text-align:left">string[1,128]</td>
<td style="text-align:left">是</td>
<td style="text-align:left">小程序下单接口返回的prepay_id参数值，提交格式如：prepay_id=*** 示例值：prepay_id=wx201410272009395522657a690389285100</td>
</tr>
<tr>
<td style="text-align:left">签名方式</td>
<td style="text-align:left">signType</td>
<td style="text-align:left">string[1,32]</td>
<td style="text-align:left">是</td>
<td style="text-align:left">签名类型，默认为RSA，仅支持RSA。 示例值：RSA</td>
</tr>
<tr>
<td style="text-align:left">签名</td>
<td style="text-align:left">paySign</td>
<td style="text-align:left">string[1,512]</td>
<td style="text-align:left">是</td>
<td style="text-align:left">签名，使用字段appId、timeStamp、nonceStr、package计算得出的签名值 示例值</td>
</tr>
</tbody>
</table>
<h3 id="后端接口开发"><a href="#后端接口开发" class="headerlink" title="#后端接口开发"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#后端接口开发">#</a>后端接口开发</h3><p>创建路由：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 微信用户下单</span><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/wxOrder&#x27;</span>, userController.<span class="hljs-property">wxOrder</span>)<br></code></pre></td></tr></table></figure>
<p>创建<code>wxOrder</code>下单方法：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">wxOrder</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>  <span class="hljs-comment">// 为什么订单的total即商品的金额信息不能从前端传？</span><br>  <span class="hljs-comment">// 从前端传商品的id -&gt; 在后端查询对应id的商品价格</span><br>  <span class="hljs-keyword">const</span> &#123; description, total &#125; = body<br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">User</span>.<span class="hljs-title function_">findByID</span>(ctx.<span class="hljs-property">_id</span>)<br>  <span class="hljs-keyword">const</span> params = &#123;<br>    description,<br>    total,<br>    user<br>  &#125;<br>  <span class="hljs-comment">// 1. 发起wxPay -&gt; prepay_id</span><br>  <span class="hljs-keyword">const</span> &#123; prepayId, nonceStr, timestamp &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">wxJSPAY</span>(params)<br>  <span class="hljs-comment">// 小程序appId</span><br>  <span class="hljs-comment">// 时间戳</span><br>  <span class="hljs-comment">// 随机字符串</span><br>  <span class="hljs-comment">// 订单详情扩展字符串</span><br>  <span class="hljs-keyword">const</span> paySign = <span class="hljs-title function_">rsaSign</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;config.AppID&#125;</span>\n<span class="hljs-subst">$&#123;timestamp&#125;</span>\n<span class="hljs-subst">$&#123;nonceStr&#125;</span>\nprepay_id=<span class="hljs-subst">$&#123;prepayId&#125;</span>\n`</span>)<br>  <span class="hljs-comment">// 2. 拼接数据返回前端</span><br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>    <span class="hljs-attr">data</span>: &#123;<br>      <span class="hljs-attr">appId</span>: config.<span class="hljs-property">AppID</span>,<br>      timestamp,<br>      nonceStr,<br>      <span class="hljs-attr">package</span>: <span class="hljs-string">`prepay_id=<span class="hljs-subst">$&#123;prepayId&#125;</span>`</span>,<br>      <span class="hljs-attr">signType</span>: <span class="hljs-string">&#x27;RSA&#x27;</span>,<br>      paySign<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="前端模拟下单-amp-支付"><a href="#前端模拟下单-amp-支付" class="headerlink" title="#前端模拟下单&amp;支付"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#前端模拟下单-支付">#</a>前端模拟下单&amp;支付</h3><figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-title function_">order</span> () &#123;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$u</span>.<span class="hljs-property">api</span>.<span class="hljs-title function_">orderGoods</span>(&#123;<br>    <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;toimc测试商品&#x27;</span>,<br>    <span class="hljs-attr">total</span>: <span class="hljs-number">1</span> <span class="hljs-comment">// 单位分</span><br>  &#125;)<br>  <span class="hljs-comment">// console.log(&#x27;🚀 ~ file: order.vue ~ line 23 ~ order ~ res&#x27;, res)</span><br>  <span class="hljs-keyword">const</span> &#123; code, data &#125; = res<br>  <span class="hljs-keyword">if</span> (code === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderParams</span> = data<br>    uni.<span class="hljs-title function_">showToast</span>(&#123;<br>      <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;下单成功&#x27;</span>,<br>      <span class="hljs-attr">duration</span>: <span class="hljs-number">2000</span><br>    &#125;)<br>  &#125;<br>&#125;,<br><span class="hljs-title function_">pay</span> () &#123;<br>  uni.<span class="hljs-title function_">requestPayment</span>(&#123;<br>    <span class="hljs-attr">provider</span>: <span class="hljs-string">&#x27;weixin&#x27;</span>,<br>    <span class="hljs-attr">orderInfo</span>: &#123;<br>      <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;toimc测试商品&#x27;</span>,<br>      <span class="hljs-attr">total</span>: <span class="hljs-number">1</span> <span class="hljs-comment">// 单位分</span><br>    &#125;,<br>    <span class="hljs-attr">timeStamp</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderParams</span>.<span class="hljs-property">timestamp</span> + <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">nonceStr</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderParams</span>.<span class="hljs-property">nonceStr</span>,<br>    <span class="hljs-attr">package</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderParams</span>.<span class="hljs-property">package</span>,<br>    <span class="hljs-attr">signType</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderParams</span>.<span class="hljs-property">signType</span>,<br>    <span class="hljs-attr">paySign</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderParams</span>.<span class="hljs-property">paySign</span>,<br>    <span class="hljs-attr">complete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: order.vue ~ line 47 ~ pay ~ res&#x27;</span>, res)<br>      <span class="hljs-comment">// errMsg: &quot;requestPayment:ok&quot; -&gt; 支付成功</span><br>      <span class="hljs-comment">// errMsg: &quot;requestPayment:fail cancel&quot; -&gt; 取消</span><br>    &#125;<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="订单查询"><a href="#订单查询" class="headerlink" title="#订单查询"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#订单查询">#</a>订单查询</h2><p>用户支付成功后，需要接受微信平台的被动通知或者是主动查询订单的支付状态。</p>
<p>原因：可能用户支付成功后，微信后台已经给了用户侧反馈，但是由于网络问题，商户平台可能未收到通知。</p>
<p><img src="uniapp.assets/image-20210830173043224.358bbadb.png" alt="image-20210830173043224"></p>
<h3 id="微信主动通知"><a href="#微信主动通知" class="headerlink" title="#微信主动通知"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#微信主动通知">#</a>微信主动通知</h3><p>frp转发通知，只需要创建对应的接口，然后在JSAPI统一下单的接口中指定回调的域名即可。</p>
<p><strong>请求方式：</strong>POST</p>
<p><strong>回调URL：</strong>该链接是通过基础下单接口中的请求参数“notify_url”来设置的，要求必须为https地址。请确保回调URL是外部可正常访问的，且不能携带后缀参数，否则可能导致商户无法接收到微信的回调通知信息。回调URL示例： “<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wxpay/pay.action”">https://pay.weixin.qq.com/wxpay/pay.action”</a></p>
<p><strong>通知规则</strong></p>
<p>用户支付完成后，微信会把相关支付结果和用户信息发送给商户，商户需要接收处理该消息，并返回应答。</p>
<p>对后台通知交互时，如果微信收到商户的应答不符合规范或超时，微信认为通知失败，微信会通过一定的策略定期重新发起通知，尽可能提高通知的成功率，但微信不保证通知最终能成功。（通知频率为15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - 总计 24h4m）</p>
<p><strong>通知报文</strong></p>
<p>支付结果通知是以POST 方法访问商户设置的通知url，通知的数据以JSON 格式通过请求主体（BODY）传输。通知的数据包括了加密的支付结果详情。</p>
<p>下面详细描述对通知数据进行解密的流程：</p>
<ol>
<li>用商户平台上设置的APIv3密钥【<a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/">微信商户平台 (opens new window)</a>—&gt;账户设置—&gt;API安全—&gt;设置APIv3密钥】，记为key；</li>
<li>针对resource.algorithm中描述的算法（目前为AEAD_AES_256_GCM），取得对应的参数nonce和associated_data；</li>
<li>使用key、nonce和associated_data，对数据密文resource.ciphertext进行解密，得到JSON形式的资源对象；</li>
</ol>
<p><strong>注：</strong> AEAD_AES_256_GCM算法的接口细节，请参考<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc5116">rfc5116 (opens new window)</a>。微信支付使用的密钥key长度为32个字节，随机串nonce长度12个字节，associated_data长度小于16个字节并可能为空。</p>
<h3 id="主动通知后端接口"><a href="#主动通知后端接口" class="headerlink" title="#主动通知后端接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#主动通知后端接口">#</a>主动通知后端接口</h3><p>解密方法：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">decryptByApiV3</span> = (<span class="hljs-params">&#123;</span><br><span class="hljs-params">  associate, // 加密参数 - 类型</span><br><span class="hljs-params">  nonce, // 加密参数 - 随机数</span><br><span class="hljs-params">  ciphertext // 加密密文</span><br><span class="hljs-params">&#125; = &#123;&#125;</span>) =&gt; &#123;<br>  ciphertext = <span class="hljs-built_in">decodeURIComponent</span>(ciphertext)<br>  ciphertext = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(ciphertext, <span class="hljs-string">&#x27;base64&#x27;</span>)<br><br>  <span class="hljs-keyword">const</span> authTag = ciphertext.<span class="hljs-title function_">slice</span>(ciphertext.<span class="hljs-property">length</span> - <span class="hljs-number">16</span>)<br>  <span class="hljs-keyword">const</span> data = ciphertext.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, ciphertext.<span class="hljs-property">length</span> - <span class="hljs-number">16</span>)<br><br>  <span class="hljs-keyword">const</span> decipher = crypto.<span class="hljs-title function_">createDecipheriv</span>(<br>    <span class="hljs-string">&#x27;aes-256-gcm&#x27;</span>,<br>    config.<span class="hljs-property">apiV3Key</span>,<br>    nonce<br>  )<br>  decipher.<span class="hljs-title function_">setAuthTag</span>(authTag)<br>  decipher.<span class="hljs-title function_">setAAD</span>(<span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(associate))<br><br>  <span class="hljs-keyword">let</span> decryptedText = decipher.<span class="hljs-title function_">update</span>(data, <span class="hljs-literal">null</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>)<br>  decryptedText += decipher.<span class="hljs-title function_">final</span>()<br>  <span class="hljs-keyword">return</span> decryptedText<br>&#125;<br></code></pre></td></tr></table></figure>
<p>创建接口：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">// 获取支付通知<br>router.post(&#x27;/notify&#x27;, adminController.wxNotify)<br></code></pre></td></tr></table></figure>
<p>接口详情<code>wxNotify</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 微信支付回调通知</span><br><span class="hljs-keyword">async</span> <span class="hljs-title function_">wxNotify</span> (ctx) &#123;<br>  <span class="hljs-keyword">const</span> &#123; body &#125; = ctx.<span class="hljs-property">request</span><br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">resource_type</span>: type, resource &#125; = body<br>  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">&#x27;encrypt-resource&#x27;</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; ciphertext, <span class="hljs-attr">associated_data</span>: associate, nonce &#125; = resource<br>    <span class="hljs-keyword">const</span> str = <span class="hljs-title function_">decryptByApiV3</span>(&#123;<br>      associate,<br>      nonce,<br>      ciphertext<br>    &#125;)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: AdminController.js ~ line 326 ~ AdminController ~ wxNotify ~ str&#x27;</span>, str)<br>    <span class="hljs-comment">// todo 入库，并修改订单的支付成功的状态</span><br>  &#125;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>    <span class="hljs-string">&#x27;🚀 ~ file: AdminController.js ~ line 294 ~ AdminController ~ wxNotify ~ body&#x27;</span>,<br>    body<br>  )<br>  ctx.<span class="hljs-property">body</span> = &#123;<br>    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>收到订单通知后，需要保存通知中的状态与数据（微信订单号）。</p>
</blockquote>
<h3 id="订单查询接口"><a href="#订单查询接口" class="headerlink" title="#订单查询接口"></a><a target="_blank" rel="noopener" href="https://front-end.toimc.com/notes-page/project/community-miniapp/12-支付专题.html#订单查询接口">#</a>订单查询接口</h3><p><a target="_blank" rel="noopener" href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml">官方文档(opens new window)</a></p>
<p>有两种方案：</p>
<ul>
<li>微信支付订单号查询</li>
<li>商户订单号查询（一般采用这种）</li>
</ul>
<p><strong>请求URL：</strong> <code>https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/&#123;out_trade_no&#125;</code></p>
<p><strong>请求方式：</strong>GET</p>
<p><strong>请求参数</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">参数名</th>
<th style="text-align:left">变量</th>
<th style="text-align:left">类型[长度限制]</th>
<th style="text-align:left">必填</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">直连商户号</td>
<td style="text-align:left">mchid</td>
<td style="text-align:left">string[1,32]</td>
<td style="text-align:left">是</td>
<td style="text-align:left">query 直连商户的商户号，由微信支付生成并下发。 示例值：1230000109</td>
</tr>
<tr>
<td style="text-align:left">商户订单号</td>
<td style="text-align:left">out_trade_no</td>
<td style="text-align:left">string[6,32]</td>
<td style="text-align:left">是</td>
<td style="text-align:left">path 商户系统内部订单号，只能是数字、大小写字母_-*且在同一个商户号下唯一。 特殊规则：最小字符长度为6 示例值：1217752501201407033233368018</td>
</tr>
</tbody>
</table>
<p>示例：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><code class="hljs text">https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/1217752501201407033233368018?mchid=1230000109<br></code></pre></td></tr></table></figure>
<blockquote>
<p>这里要特别注意，url中有路径参数与query参数</p>
</blockquote>
<p>后端代码：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> qs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;qs&#x27;</span><br><br><span class="hljs-comment">// 微信支付订单查询 out_trade_no</span><br><span class="hljs-comment">//  https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/&#123;out_trade_no&#125;</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getNofityByTradeNo</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">id</span>) =&gt; &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">let</span> url = <span class="hljs-string">`https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/<span class="hljs-subst">$&#123;id&#125;</span>?`</span><br>    <span class="hljs-keyword">const</span> params = &#123;<br>      <span class="hljs-attr">mchid</span>: config.<span class="hljs-property">mchid</span><br>    &#125;<br>    url += qs.<span class="hljs-title function_">stringify</span>(params)<br>    <span class="hljs-keyword">const</span> &#123; headers, nonceStr, timestamp &#125; = <span class="hljs-title function_">getSignHeaders</span>(url, <span class="hljs-string">&#x27;get&#x27;</span>)<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">get</span>(url, &#123;<br>      <span class="hljs-attr">headers</span>: &#123;<br>        <span class="hljs-title class_">Authorization</span>: headers<br>      &#125;<br>    &#125;)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>      <span class="hljs-string">&#x27;🚀 ~ file: WxPay.js ~ line 147 ~ getNofityByTradeNo ~ timestamp&#x27;</span>,<br>      timestamp<br>    )<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>      <span class="hljs-string">&#x27;🚀 ~ file: WxPay.js ~ line 147 ~ getNofityByTradeNo ~ nonceStr&#x27;</span>,<br>      nonceStr<br>    )<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;🚀 ~ file: WxPay.js ~ line 53 ~ wxJSPAY ~ result&#x27;</span>, result)<br>    <span class="hljs-comment">// todo result.data -&gt; trade_state trade_type -&gt; 存储订单的其他信息</span><br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`getNofityByTradeNo error: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>至此，完成的小程序支付的一个完整的闭环。</p>
<blockquote>
<p>关于退款与退款通知与下单&amp;订单通知是类似，不再提供示例。</p>
</blockquote>
  
    <div class="footer">
<script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>
<div id="bsa-native"></div>
<script>
_bsa.init('custom', 'CKYD62QM', 'placement:vuejsorg',
  {
    target: '#bsa-native',
    template: '<a class="native-box" href="##statlink##"><div class="native-sponsor">Sponsor</div><div class="native-text"><strong>##company##</strong> — ##description##</div></a>'
  }
);
</script>

发现错误？想参与编辑？
        <a
            href="https://github.com/vuejs/v2.cn.vuejs.org/blob/master/src/framework/uniapp/index.md"
            rel="noopener"
            target="_blank"
        >
            在 GitHub 上编辑此页！
        </a>
        <!-- Deployed on
    <a href="https://url.netlify.com/HJ8X2mxP8" rel="noopener" target="_blank">
      Netlify
    </a>. -->
    </div>
</div>

      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- search -->
    <link href="//code.bdstatic.com/npm/docsearch.js@1.5.0/dist/cdn/docsearch.min.css" rel='stylesheet' type='text/css'>
    
<link rel="stylesheet" href="/css/search.css">

    <script src="//code.bdstatic.com/npm/docsearch.js@1.5.0/dist/cdn/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      docsearch({
        appId: 'UURH1MHAF7',
        apiKey: 'c23eb8e7895f42daeaf2bf6f63eb4bf6',
        indexName: 'vuejs_cn2',
        inputSelector: selector,
        algoliaOptions: { facetFilters: ["version:v2"]},
        autocompleteOptions: { hint: false, appendTo: 'body'}
      })
    })

    // unregister service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister()
        }
      })
    }
    </script>
  </body>
</html>
