
---
title: uniappä»‹ç»
type: uniapp
order: 1
---

# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#uniappä»‹ç»)uniappä»‹ç»

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#ä»€ä¹ˆæ˜¯å¿«åº”ç”¨)ä»€ä¹ˆæ˜¯å¿«åº”ç”¨ï¼Ÿ

å¿«åº”ç”¨æ˜¯æŒ‡ç”¨æˆ·æ— éœ€ä¸‹è½½å®‰è£…ï¼Œå³ç‚¹å³ç”¨ï¼Œäº«å—åŸç”Ÿæ€§èƒ½ä½“éªŒçš„åº”ç”¨ï¼Œä¾‹å¦‚ï¼šå¾®ä¿¡å°ç¨‹åºï¼Œæ”¯ä»˜å®å°ç¨‹åºï¼Œç™¾åº¦å°ç¨‹åºç­‰ã€‚

å¿«åº”ç”¨çš„ä¼˜åŠ¿ï¼š

* æ— éœ€ä¸‹è½½å®‰è£…Appï¼ŒèŠ‚çº¦æ‰‹æœºç©ºé—´ï¼›
* æ€§èƒ½å¥½ï¼Œä½“éªŒæ¥è¿‘åŸç”Ÿï¼›
* èƒŒé æµé‡ï¼›

å¿«åº”ç”¨çš„ç¼ºç‚¹ï¼š

* å¹³å°å¤šï¼Œè¯­æ³•å¤šï¼Œå¼€å‘æˆæœ¬é«˜ï¼›
* ç®¡æ§éš¾ï¼›

å¿«åº”ç”¨çš„å‘å±•è¶‹åŠ¿ï¼šå¹³å°åº•å±‚æ”¯æŒï¼Œæ‰«ç å³ç”¨ï¼Œæ— éœ€å®‰è£…å¾®ä¿¡ã€æ”¯ä»˜å®ç­‰å¹³å°ï¼Œå¯ä»¥å‚çœ‹ï¼Œ[é“¾æ¥(opens new window)](https://www.zhihu.com/question/269267011)

ä¸ºä»€ä¹ˆPWAä¸é¦™äº†ï¼Ÿ

* æµè§ˆå™¨ç¯å¢ƒéœ€è¦è€ƒè™‘å…¼å®¹æ€§ï¼›
* æ”¯ä»˜ä¼šè¢«é™åˆ¶ï¼›
* ç¼ºä¹åŸç”Ÿèƒ½åŠ›ï¼›
* è¿½æ±‚åŸç”Ÿä½“éªŒï¼›
* æ›´é«˜çš„å®‰å…¨æ€§çš„è¦æ±‚ï¼ˆå†…å®¹ã€ä»£ç ï¼‰ï¼›

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#èƒŒæ™¯ä»‹ç»)èƒŒæ™¯ä»‹ç»

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#æŠ€æœ¯äººæƒ³å·æ‡’)æŠ€æœ¯äººæƒ³å·æ‡’

å›°å¢ƒï¼š

* å°ç¨‹åºçš„å¹³å°å¤ªå¤šï¼Œéœ€è¦å­¦ä¹ å¤šä¸ªå¹³å°çš„è¯­æ³•ï¼›
* å‰ç«¯äººä¹Ÿæƒ³ç”¨vueï¼Œreactè¯­æ³•æ¥å†™å°ç¨‹åºï¼›
* æƒ³åœ¨å°ç¨‹åºä¸­ä½¿ç”¨npmåŒ…ï¼ˆåºå¤§çš„ç¬¬ä¸‰æ–¹åŒ…ï¼‰ï¼›
* å°ç¨‹åºä»£ç  -> åŸç”ŸAppï¼Œä¸€å¥—ä»£ç å¤šç«¯è¿è¡Œï¼›

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#å„ä¸ªå¹³å°ä¹‹é—´çš„å¯¹æ¯”)å„ä¸ªå¹³å°ä¹‹é—´çš„å¯¹æ¯”

![test-frame-11.png](uniapp.assets/test-frame-11.9ab52396.png)

æ•°æ®æºï¼š[é“¾æ¥ (opens new window)](https://juejin.cn/post/6844903810788245511)ï¼Œ 2020å¹´æ¨ªè¯„ï¼š[é“¾æ¥(opens new window)](https://juejin.cn/post/6844904118901817351)

**ç»“è®ºï¼š**

* è·¨ç«¯æ”¯æŒåº¦æµ‹è¯„ç»“è®ºï¼š`uni-app` > `taro` > `chameleon` > `mpvue` >`wepy`ã€`åŸç”Ÿå¾®ä¿¡å°ç¨‹åº`
* å¾®ä¿¡åŸç”Ÿæ¡†æ¶å¯è¾¾åˆ°æ›´å¥½çš„æ€§èƒ½ï¼Œä½† `uni-app`ã€`taro` ç›¸æ¯”å¾®ä¿¡åŸç”Ÿï¼Œæ€§èƒ½å·®è·å¹¶ä¸å¤§ï¼›
* å¾®ä¿¡åŸç”Ÿå¼€å‘æ‰‹å·¥ä¼˜åŒ–, `uni-app`>å¾®ä¿¡åŸç”Ÿå¼€å‘æœªæ‰‹å·¥ä¼˜åŒ–, `taro` > `chameleon`> `wepy` > `mpvue`
* `mpvue`æ”¯æŒç»å¤§éƒ¨åˆ†çš„Vueè¯­æ³•ï¼›`uni-app` ç¼–è¯‘åˆ°å¾®ä¿¡ç«¯æ›¾ç»ä½¿ç”¨è¿‡`mpvue`ï¼Œä½†åæ¥é‡æ–°ç¼–å†™ï¼Œæ”¯æŒäº†æ›´å¤švueè¯­æ³•å¦‚`filter`ã€å¤æ‚ `JavaScript` è¡¨è¾¾å¼ç­‰ï¼›`wepy`ã€`chameleon` éƒ½æ˜¯ `ç±»Vue` çš„å®ç°ï¼Œä»…æ”¯æŒ `Vue` çš„éƒ¨åˆ†è¯­æ³•ï¼Œå¼€å‘æ—¶éœ€è¦å•ç‹¬å­¦ä¹ å®ƒä»¬çš„è§„åˆ™ï¼›`taro` å¯¹äº `JSX` çš„è¯­æ³•æ”¯æŒæ˜¯ç›¸å¯¹å®Œå–„çš„ï¼ŒReactæŠ€æœ¯æ ˆå‹å¥½ï¼›
* å­¦ä¹ èµ„æ–™å®Œå–„åº¦ï¼š`uni-app` > `mpvue` , `taro` > `chameleon` > `wepy`
* ç¤¾åŒºæ´»è·ƒåº¦ï¼š`uni-app` > `taro`> `chameleon` > `wepy` >`mpvue`

TIP

æ²¡æœ‰æœ€å¥½çš„ï¼Œåªæœ‰æœ€é€‚åˆçš„ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#åº”ç”¨åœºæ™¯)åº”ç”¨åœºæ™¯

* ç†Ÿæ‚‰VueæŠ€æœ¯æ ˆï¼Œæ¨èï¼šuniapp > wepy > mpvueï¼›ç†Ÿæ‚‰ReactæŠ€æœ¯æ ˆï¼Œtaroï¼›
* é¡¹ç›®åˆæœŸï¼Œæƒ³æ³•è®ºè¯å¯ä»¥ä½¿ç”¨uniapp -> å¤šç«¯å¼€å‘ï¼›åç»­ï¼Œæ¨èFlutterè·¨ç«¯å¼€å‘ï¼Œå†åˆ°åæœŸæ¨èåŸç”Ÿå¼€å‘ï¼›
* æ¡†æ¶çš„æ›´æ–°æœ¬èº«ï¼Œä¸èƒ½ä½œä¸ºä½¿ç”¨æ¡†æ¶çš„ç»å¯¹æŒ‡æ ‡ï¼›é€‰æ‹©åˆé€‚çš„æ¡†æ¶ï¼Œè§£å†³å½“ä¸‹çš„é—®é¢˜ï¼›

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#ä»€ä¹ˆæ˜¯uniapp)ä»€ä¹ˆæ˜¯uniapp?

`uni-app` æ˜¯ä¸€ä¸ªä½¿ç”¨ [Vue.js (opens new window)](https://vuejs.org/)å¼€å‘æ‰€æœ‰å‰ç«¯åº”ç”¨çš„æ¡†æ¶ï¼Œå¼€å‘è€…ç¼–å†™ä¸€å¥—ä»£ç ï¼Œå¯å‘å¸ƒåˆ°iOSã€Androidã€Webï¼ˆå“åº”å¼ï¼‰ã€ä»¥åŠå„ç§å°ç¨‹åºï¼ˆå¾®ä¿¡/æ”¯ä»˜å®/ç™¾åº¦/å¤´æ¡/QQ/é’‰é’‰/æ·˜å®ï¼‰ã€å¿«åº”ç”¨ç­‰å¤šä¸ªå¹³å°ã€‚

TIP

uni-appä¸mpvueçš„æ¸Šæºï¼š`uni-app`åœ¨åˆæœŸå€Ÿé‰´äº†`mpvue`ï¼Œå®ç°äº†å¾®ä¿¡å°ç¨‹åºç«¯çš„å¿«é€Ÿå…¼å®¹ï¼Œ[å‚è€ƒé“¾æ¥ (opens new window)](https://ask.dcloud.net.cn/article/35699)ã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#å¼€å‘è§„èŒƒ)å¼€å‘è§„èŒƒ

ä¸ºäº†å®ç°å¤šç«¯å…¼å®¹ï¼Œç»¼åˆè€ƒè™‘ç¼–è¯‘é€Ÿåº¦ã€è¿è¡Œæ€§èƒ½ç­‰å› ç´ ï¼Œ`uni-app` çº¦å®šäº†å¦‚ä¸‹å¼€å‘è§„èŒƒï¼š

* é¡µé¢æ–‡ä»¶éµå¾ª [Vue å•æ–‡ä»¶ç»„ä»¶ (SFC) è§„èŒƒ(opens new window)](https://vue-loader.vuejs.org/zh/spec.html)

* ç»„ä»¶æ ‡ç­¾é è¿‘å°ç¨‹åºè§„èŒƒï¼Œè¯¦è§[uni-app ç»„ä»¶è§„èŒƒ(opens new window)](https://uniapp.dcloud.io/component/README)

  æœ‰å‡ ç‚¹ç‰¹åˆ«è¦æ³¨æ„çš„ï¼š

  1. æ³¨æ„ï¼šæ‰€æœ‰ç»„ä»¶ä¸å±æ€§åéƒ½æ˜¯å°å†™ï¼Œå•è¯ä¹‹é—´ä»¥è¿å­—ç¬¦`-`è¿æ¥ï¼›
  2. æ¯ä¸ªvueæ–‡ä»¶çš„æ ¹èŠ‚ç‚¹å¿…é¡»ä¸º `<template>`ï¼Œä¸”è¿™ä¸ª `<template>` ä¸‹åªèƒ½ä¸”å¿…é¡»æœ‰ä¸€ä¸ªæ ¹ `<view>` ç»„ä»¶ï¼›
  3. ä¸æ¨èä½¿ç”¨HTMLæ ‡ç­¾ï¼Œä¸ºäº†ç®¡ç†æ–¹ä¾¿ã€ç­–ç•¥ç»Ÿä¸€ï¼Œæ–°å†™ä»£ç æ—¶ä»ç„¶å»ºè®®ä½¿ç”¨viewç­‰ç»„ä»¶ï¼›
  4. ç»„ä»¶ä¸Šçš„äº‹ä»¶ç»‘å®šï¼Œéœ€è¦ä»¥ vue çš„äº‹ä»¶ç»‘å®šè¯­æ³•æ¥ç»‘å®šï¼Œå¦‚ bindchange="eventName" äº‹ä»¶ï¼Œéœ€è¦å†™æˆ `@change="eventName"`ï¼›
  5. uni-appæ”¯æŒçš„ç»„ä»¶åˆ†ä¸ºvueç»„ä»¶å’Œå°ç¨‹åºè‡ªå®šä¹‰ç»„ä»¶ï¼›å¦‚æœæ‰©å±•ç»„ä»¶ç¬¦åˆuni-appçš„`easycom`ç»„ä»¶è§„èŒƒï¼Œåˆ™å¯ä»¥å…æ³¨å†Œï¼Œç›´æ¥ä½¿ç”¨ï¼›å¦‚æœç»„ä»¶ä¸ç¬¦åˆeasycomè§„èŒƒï¼Œåˆ™éœ€è¦åœ¨ä»£ç é‡Œæ‰‹åŠ¨importå’Œæ³¨å†Œç»„ä»¶ï¼Œç„¶åæ‰èƒ½ä½¿ç”¨

* æ¥å£èƒ½åŠ›ï¼ˆJS APIï¼‰é è¿‘å¾®ä¿¡å°ç¨‹åºè§„èŒƒï¼Œä½†éœ€å°†å‰ç¼€ `wx` æ›¿æ¢ä¸º `uni`ï¼Œè¯¦è§[uni-appæ¥å£è§„èŒƒ(opens new window)](https://uniapp.dcloud.io/api/README)

* æ•°æ®ç»‘å®šåŠäº‹ä»¶å¤„ç†åŒ `Vue.js` è§„èŒƒï¼ŒåŒæ—¶è¡¥å……äº†AppåŠé¡µé¢çš„ç”Ÿå‘½å‘¨æœŸ

* ä¸ºå…¼å®¹å¤šç«¯è¿è¡Œï¼Œå»ºè®®ä½¿ç”¨flexå¸ƒå±€è¿›è¡Œå¼€å‘

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#ç›®å½•ç»“æ„)ç›®å½•ç»“æ„

ä¸€ä¸ªuni-appå·¥ç¨‹ï¼Œé»˜è®¤åŒ…å«å¦‚ä¸‹ç›®å½•åŠæ–‡ä»¶ï¼š

```markdown
â”Œâ”€uniCloud              äº‘ç©ºé—´ç›®å½•ï¼Œé˜¿é‡Œäº‘ä¸ºuniCloud-aliyun,è…¾è®¯äº‘ä¸ºuniCloud-tcbï¼ˆè¯¦è§uniCloudï¼‰
â”‚â”€components            ç¬¦åˆvueç»„ä»¶è§„èŒƒçš„uni-appç»„ä»¶ç›®å½•
â”‚  â””â”€comp-a.vue         å¯å¤ç”¨çš„aç»„ä»¶
â”œâ”€hybrid                Appç«¯å­˜æ”¾æœ¬åœ°htmlæ–‡ä»¶çš„ç›®å½•ï¼Œè¯¦è§
â”œâ”€platforms             å­˜æ”¾å„å¹³å°ä¸“ç”¨é¡µé¢çš„ç›®å½•ï¼Œè¯¦è§
â”œâ”€pages                 ä¸šåŠ¡é¡µé¢æ–‡ä»¶å­˜æ”¾çš„ç›®å½•
â”‚  â”œâ”€index
â”‚  â”‚  â””â”€index.vue       indexé¡µé¢
â”‚  â””â”€list
â”‚     â””â”€list.vue        listé¡µé¢
â”œâ”€static                å­˜æ”¾åº”ç”¨å¼•ç”¨çš„æœ¬åœ°é™æ€èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰çš„ç›®å½•ï¼Œæ³¨æ„ï¼šé™æ€èµ„æºåªèƒ½å­˜æ”¾äºæ­¤
â”œâ”€uni_modules           å­˜æ”¾uni_moduleè§„èŒƒçš„æ’ä»¶ã€‚
â”œâ”€wxcomponents          å­˜æ”¾å°ç¨‹åºç»„ä»¶çš„ç›®å½•ï¼Œè¯¦è§
â”œâ”€main.js               Vueåˆå§‹åŒ–å…¥å£æ–‡ä»¶
â”œâ”€App.vue               åº”ç”¨é…ç½®ï¼Œç”¨æ¥é…ç½®Appå…¨å±€æ ·å¼ä»¥åŠç›‘å¬ åº”ç”¨ç”Ÿå‘½å‘¨æœŸ
â”œâ”€manifest.json         é…ç½®åº”ç”¨åç§°ã€appidã€logoã€ç‰ˆæœ¬ç­‰æ‰“åŒ…ä¿¡æ¯
â””â”€pages.json            é…ç½®é¡µé¢è·¯ç”±ã€å¯¼èˆªæ¡ã€é€‰é¡¹å¡ç­‰é¡µé¢ç±»ä¿¡æ¯
```

TIP

* ç¼–è¯‘åˆ°ä»»æ„å¹³å°æ—¶ï¼Œ`static` ç›®å½•ä¸‹çš„æ–‡ä»¶å‡ä¼šè¢«å®Œæ•´æ‰“åŒ…è¿›å»ï¼Œä¸”ä¸ä¼šç¼–è¯‘ã€‚é `static` ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆvueã€jsã€css ç­‰ï¼‰åªæœ‰è¢«å¼•ç”¨åˆ°æ‰ä¼šè¢«æ‰“åŒ…ç¼–è¯‘è¿›å»ã€‚
* `static` ç›®å½•ä¸‹çš„ `js` æ–‡ä»¶ä¸ä¼šè¢«ç¼–è¯‘ï¼Œå¦‚æœé‡Œé¢æœ‰ `es6` çš„ä»£ç ï¼Œä¸ç»è¿‡è½¬æ¢ç›´æ¥è¿è¡Œï¼Œåœ¨æ‰‹æœºè®¾å¤‡ä¸Šä¼šæŠ¥é”™ã€‚
* `css`ã€`less/scss` ç­‰èµ„æºä¸è¦æ”¾åœ¨ `static` ç›®å½•ä¸‹ï¼Œå»ºè®®è¿™äº›å…¬ç”¨çš„èµ„æºæ”¾åœ¨è‡ªå»ºçš„ `common` ç›®å½•ä¸‹ã€‚
* HbuilderX 1.9.0+ æ”¯æŒåœ¨æ ¹ç›®å½•åˆ›å»º `ext.json`ã€`sitemap.json` ç­‰å°ç¨‹åºéœ€è¦çš„æ–‡ä»¶ã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#å¯¼å…¥é™æ€èµ„æº)å¯¼å…¥é™æ€èµ„æº

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#æ¨¡æ¿å†…å¼•å…¥é™æ€èµ„æº)æ¨¡æ¿å†…å¼•å…¥é™æ€èµ„æº

`template`å†…å¼•å…¥é™æ€èµ„æºï¼Œå¦‚`image`ã€`video`ç­‰æ ‡ç­¾çš„`src`å±æ€§æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–è€…ç»å¯¹è·¯å¾„ï¼Œå½¢å¼å¦‚ä¸‹

```html
<!-- ç»å¯¹è·¯å¾„ï¼Œ/staticæŒ‡æ ¹ç›®å½•ä¸‹çš„staticç›®å½•ï¼Œåœ¨clié¡¹ç›®ä¸­/staticæŒ‡srcç›®å½•ä¸‹çš„staticç›®å½• -->
<image class="logo" src="/static/logo.png"></image>
<image class="logo" src="@/static/logo.png"></image>
<!-- ç›¸å¯¹è·¯å¾„ -->
<image class="logo" src="../../static/logo.png"></image>
```

ç‰¹åˆ«è¯´æ˜ï¼š

TIP

* `@`å¼€å¤´çš„ç»å¯¹è·¯å¾„ä»¥åŠç›¸å¯¹è·¯å¾„ä¼šç»è¿‡base64è½¬æ¢è§„åˆ™æ ¡éªŒ
* å¼•å…¥çš„é™æ€èµ„æºåœ¨éh5å¹³å°ï¼Œå‡ä¸è½¬ä¸ºbase64ã€‚
* H5å¹³å°ï¼Œå°äº4kbçš„èµ„æºä¼šè¢«è½¬æ¢æˆbase64ï¼Œå…¶ä½™ä¸è½¬ã€‚
* è‡ª`HBuilderX 2.6.6`èµ·`template`å†…æ”¯æŒ`@`å¼€å¤´è·¯å¾„å¼•å…¥é™æ€èµ„æºï¼Œæ—§ç‰ˆæœ¬ä¸æ”¯æŒæ­¤æ–¹å¼
* Appå¹³å°è‡ª`HBuilderX 2.6.9`èµ·`template`èŠ‚ç‚¹ä¸­å¼•ç”¨é™æ€èµ„æºæ–‡ä»¶æ—¶ï¼ˆå¦‚ï¼šå›¾ç‰‡ï¼‰ï¼Œè°ƒæ•´æŸ¥æ‰¾ç­–ç•¥ä¸ºã€åŸºäºå½“å‰æ–‡ä»¶çš„è·¯å¾„æœç´¢ã€‘ï¼Œä¸å…¶ä»–å¹³å°ä¿æŒä¸€è‡´
* æ”¯ä»˜å®å°ç¨‹åºç»„ä»¶å†… image æ ‡ç­¾ä¸å¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#jsæ–‡ä»¶å¼•å…¥)jsæ–‡ä»¶å¼•å…¥

`js`æ–‡ä»¶æˆ–`script`æ ‡ç­¾å†…ï¼ˆåŒ…æ‹¬renderjsç­‰ï¼‰å¼•å…¥`js`æ–‡ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼Œå½¢å¼å¦‚ä¸‹

```js
// ç»å¯¹è·¯å¾„ï¼Œ@æŒ‡å‘é¡¹ç›®æ ¹ç›®å½•ï¼Œåœ¨clié¡¹ç›®ä¸­@æŒ‡å‘srcç›®å½•
import add from '@/common/add.js'
// ç›¸å¯¹è·¯å¾„
import add from '../../common/add.js'
```

WARNING

jsæ–‡ä»¶ä¸æ”¯æŒä½¿ç”¨`/`å¼€å¤´çš„æ–¹å¼å¼•å…¥

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/#csså¼•å…¥é™æ€èµ„æº)csså¼•å…¥é™æ€èµ„æº

1. `css`æ–‡ä»¶æˆ–`styleæ ‡ç­¾`å†…å¼•å…¥`css`æ–‡ä»¶æ—¶ï¼ˆscssã€lessæ–‡ä»¶åŒç†ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„ï¼ˆ`HBuilderX 2.6.6`ï¼‰

```css
/* ç»å¯¹è·¯å¾„ */
@import url('/common/uni.css');
@import url('@/common/uni.css');
/* ç›¸å¯¹è·¯å¾„ */
@import url('../../common/uni.css');
```

WARNING

è‡ª`HBuilderX 2.6.6`èµ·æ”¯æŒç»å¯¹è·¯å¾„å¼•å…¥é™æ€èµ„æºï¼Œæ—§ç‰ˆæœ¬ä¸æ”¯æŒæ­¤æ–¹å¼

1. `css`æ–‡ä»¶æˆ–`styleæ ‡ç­¾`å†…å¼•ç”¨çš„å›¾ç‰‡è·¯å¾„å¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¹Ÿå¯ä»¥ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰äº›å°ç¨‹åºç«¯cssæ–‡ä»¶ä¸å…è®¸å¼•ç”¨æœ¬åœ°æ–‡ä»¶ï¼ˆè¯·çœ‹æ³¨æ„äº‹é¡¹ï¼‰ã€‚

```css
/* ç»å¯¹è·¯å¾„ */
background-image: url(/static/logo.png);
background-image: url(@/static/logo.png);
/* ç›¸å¯¹è·¯å¾„ */
background-image: url(../../static/logo.png);
```

æ³¨æ„äº‹é¡¹ï¼š

TIP

* å¼•å…¥å­—ä½“å›¾æ ‡è¯·å‚è€ƒï¼Œ[å­—ä½“å›¾æ ‡(opens new window)](https://uniapp.dcloud.io/frame?id=å­—ä½“å›¾æ ‡)
* `@`å¼€å¤´çš„ç»å¯¹è·¯å¾„ä»¥åŠç›¸å¯¹è·¯å¾„ä¼šç»è¿‡base64è½¬æ¢è§„åˆ™æ ¡éªŒ
* ä¸æ”¯æŒæœ¬åœ°å›¾ç‰‡çš„å¹³å°ï¼Œå°äº40kbï¼Œä¸€å®šä¼šè½¬base64ã€‚ï¼ˆå…±å››ä¸ªå¹³å°mp-weixin, mp-qq, mp-toutiao, app v2ï¼‰
* h5å¹³å°ï¼Œå°äº4kbä¼šè½¬base64ï¼Œè¶…å‡º4kbæ—¶ä¸è½¬ã€‚
* å…¶ä½™å¹³å°ä¸ä¼šè½¬base64



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#æ­å»ºå¼€å‘ç¯å¢ƒ)æ­å»ºå¼€å‘ç¯å¢ƒ

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#é›†æˆscss-sassç¼–è¯‘)é›†æˆscss/sassç¼–è¯‘

ä¸ºäº†æ–¹ä¾¿ç¼–å†™æ ·å¼ï¼ˆä¾‹å¦‚`<style lang="scss">`ï¼‰ï¼Œå»ºè®®å¤§å®¶å®‰è£…`sass/scssç¼–è¯‘`æ’ä»¶ï¼Œæ’ä»¶çš„ä¸‹è½½åœ°å€ï¼š[scss/sassç¼–è¯‘(opens new window)](https://ext.dcloud.net.cn/plugin?name=compile-node-sass)

![image-20210419163056984](uniapp.assets/image-20210419163056984.8ea29f1f.png)

ç™»å½•è´¦å· -> æ— è´¦å·ï¼Œå³æ³¨å†Œï¼ˆé‚®ç®±éªŒè¯ï¼‰ -> å†æ¬¡ç‚¹å‡»å®‰è£…æ’ä»¶ -> æ‰“å¼€HBuilderX

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#è‡ªå®šä¹‰ä¸»é¢˜ã€å¿«æ·é”®ç­‰)è‡ªå®šä¹‰ä¸»é¢˜ã€å¿«æ·é”®ç­‰

1. å¿«æ·é”®åˆ‡æ¢

åœ¨`å·¥å…· -> é¢„è®¾å¿«æ·é”®æ–¹æ¡ˆåˆ‡æ¢` ä¸­å¯ä»¥åˆ‡æ¢è‡ªå·±å–œæ¬¢çš„å¿«æ·é”®æ–¹æ¡ˆï¼Œå¯¹HBuilderXè¿›è¡Œè‡ªå®šä¹‰ï¼š

![image-20210419163655412](uniapp.assets/image-20210419163655412.cd023f65.png)

1. è®¾ç½®ä¸»é¢˜

![image-20210419163851076](uniapp.assets/image-20210419163851076.d0d9fcc5.png)

1. å­—å·è®¾ç½®

macOSçš„å¿«æ·é”®æ˜¯ `Command + ,`ï¼Œwindowsçš„å¿«æ·é”®æ˜¯`Ctrl + ,`

![image-20210419164115182](uniapp.assets/image-20210419164115182.daa3ac9b.png)

å¸¸è§é…ç½®ï¼š

```json
{
    "editor.colorScheme" : "Default",
    "editor.fontFamily" : "Consolas",
    "editor.fontSize" : 14,
    "editor.insertSpaces" : true,
    "editor.lineHeight" : "1.5",
    "editor.mouseWheelZoom" : true,
    "editor.onlyHighlightWord" : false,
    "editor.tabSize" : 2,
    "editor.wordWrap" : true,
    "editor.codeassist.px2rem.enabel": false,
    "editor.codeassist.px2upx.enabel": false
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#åˆ›å»ºé¡¹ç›®)åˆ›å»ºé¡¹ç›®

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#ä½¿ç”¨hbuilderx)ä½¿ç”¨HBuilderX

æ­¥éª¤ï¼š

* ä¸‹è½½HBuilderXï¼š[å®˜æ–¹IDEä¸‹è½½åœ°å€ (opens new window)](https://www.dcloud.io/hbuilderx.html)â€”â€”å»ºè®®ä½¿ç”¨æ ‡å‡†ç‰ˆæœ¬

  > HBuilderXæ ‡å‡†ç‰ˆå¯ç›´æ¥ç”¨äºwebå¼€å‘ã€markdownã€å­—å¤„ç†åœºæ™¯ã€‚åšAppä»éœ€è¦å®‰è£…æ’ä»¶ã€‚
  >
  > Appå¼€å‘ç‰ˆé¢„ç½®äº†App/uni-appå¼€å‘æ‰€éœ€çš„æ’ä»¶ï¼Œå¼€ç®±å³ç”¨ã€‚
  >
  > æ ‡å‡†ç‰ˆä¹Ÿå¯ä»¥åœ¨æ’ä»¶å®‰è£…ç•Œé¢å®‰è£…Appå¼€å‘æ‰€éœ€æ’ä»¶ï¼ŒAppå¼€å‘ç‰ˆåªæ˜¯ä¸€ä¸ªé¢„é›†æˆä½œç”¨ã€‚
  >
  > Appå¼€å‘æ’ä»¶ä½“ç§¯å¤§çš„åŸå› ä¸»è¦æœ‰2æ–¹é¢ï¼š
  >
  > 1. çœŸæœºè¿è¡ŒåŸºåº§ï¼ŒAndroidç‰ˆã€iOSç‰ˆã€iOSæ¨¡æ‹Ÿå™¨ç‰ˆï¼ŒåŠ èµ·æ¥ä½“ç§¯å°±1ç™¾å¤šMã€‚çœŸæœºè¿è¡ŒåŸºåº§éœ€è¦æŠŠæ‰€æœ‰æ¨¡å—éƒ½å†…ç½®è¿›å»ï¼Œæ–¹ä¾¿å¤§å®¶å¼€å‘è°ƒè¯•ã€‚å¼€å‘è€…è‡ªå·±åšappæ‰“åŒ…æ˜¯ä¸ä¼šè¿™ä¹ˆå¤§çš„ï¼Œå› ä¸ºå¯ä»¥åœ¨manifesté‡Œé€‰æ¨¡å—æ¥æ§åˆ¶ä½“ç§¯ã€‚
  > 2. uni-appçš„ç¼–è¯‘å™¨ï¼Œä¾èµ–webpackå’Œå„ç§nodeæ¨¡å—ï¼Œnode_moduleså°±æ˜¯è¿™ä¹ˆä¸€ä¸ªç”Ÿæ€ç°çŠ¶ï¼Œæ–‡ä»¶è¶…çº§å¤šï¼Œå‡ ä¸‡ä¸ªæ–‡ä»¶ï¼Œè§£å‹èµ·æ¥å¾ˆæ…¢ã€‚

* åœ¨ç‚¹å‡»å·¥å…·æ é‡Œçš„æ–‡ä»¶ -> æ–°å»º -> é¡¹ç›®ï¼š

  ![img](uniapp.assets/b925a1c0-4f19-11eb-97b7-0dc4655d6e68.0528b5af.png)

* é€‰æ‹©`uni-app`ç±»å‹ï¼Œè¾“å…¥å·¥ç¨‹åï¼Œé€‰æ‹©æ¨¡æ¿ï¼Œç‚¹å‡»åˆ›å»ºï¼Œå³å¯æˆåŠŸåˆ›å»ºã€‚

  ![image-20210419161501579](uniapp.assets/image-20210419161501579.57b59a7b.png)

* åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·é‡Œè¿è¡Œï¼šè¿›å…¥hello-uniappé¡¹ç›®ï¼Œç‚¹å‡»å·¥å…·æ çš„è¿è¡Œ -> è¿è¡Œåˆ°å°ç¨‹åºæ¨¡æ‹Ÿå™¨ -> å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼Œå³å¯åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·é‡Œé¢ä½“éªŒuni-appã€‚

   ![img](uniapp.assets/d89fd6f0-4f1a-11eb-97b7-0dc4655d6e68.627f3d67.png)

  ç¬¬ä¸€æ¬¡è¿è¡Œçš„æç¤ºï¼š

  ![image-20210419170249359](uniapp.assets/image-20210419170249359.6b82ec00.png)

  æˆåŠŸè¿è¡Œï¼š

  ![image-20210419170454810](uniapp.assets/image-20210419170454810.8b9f0528.png)

  **æ³¨æ„ï¼š**

  * å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆé…ç½®å°ç¨‹åºideçš„ç›¸å…³è·¯å¾„ï¼Œæ‰èƒ½è¿è¡ŒæˆåŠŸã€‚å¦‚ä¸‹å›¾ï¼Œéœ€åœ¨è¾“å…¥æ¡†è¾“å…¥å¾®ä¿¡å¼€å‘è€…å·¥å…·çš„å®‰è£…è·¯å¾„ï¼Œuni-appé»˜è®¤æŠŠé¡¹ç›®ç¼–è¯‘åˆ°æ ¹ç›®å½•çš„unpackageç›®å½•ã€‚

    ![image-20210419171415089](uniapp.assets/image-20210419171415089.8ee56032.png)

  * è‹¥HBuilderXä¸èƒ½æ­£å¸¸å¯åŠ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨å¯åŠ¨ï¼Œç„¶åå°†uni-appç”Ÿæˆå°ç¨‹åºå·¥ç¨‹çš„è·¯å¾„æ‹·è´åˆ°å¾®ä¿¡å¼€å‘è€…å·¥å…·é‡Œé¢ï¼Œåœ¨HBuilderXé‡Œé¢å¼€å‘ï¼Œåœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·é‡Œé¢å°±å¯çœ‹åˆ°å®æ—¶çš„æ•ˆæœã€‚

  * å¦‚æœæç¤º`[error] å·¥å…·çš„æœåŠ¡ç«¯å£å·²å…³é—­ã€‚è¦ä½¿ç”¨å‘½ä»¤è¡Œè°ƒç”¨å·¥å…·ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥ y ä»¥ç¡®è®¤å¼€å¯ï¼Œæˆ–æ‰‹åŠ¨æ‰“å¼€å·¥å…· -> è®¾ç½® -> å®‰å…¨è®¾ç½®ï¼Œå°†æœåŠ¡ç«¯å£å¼€å¯`ï¼Œå¦‚å›¾ï¼š

    ![image-20210419170330616](uniapp.assets/image-20210419170330616.ed49854b.png)

    å¾®ä¿¡å¼€å‘è€…å·¥å…·è®¾ç½®èœå•ï¼Œå®‰å…¨ä¸­æ‰“å¼€æœåŠ¡ç«¯å£ï¼š

    ![image-20210419165932479](uniapp.assets/image-20210419165932479.6a975e1a.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#ä½¿ç”¨vue-cliå‘½ä»¤è¡Œ-vscode)ä½¿ç”¨vue-cliå‘½ä»¤è¡Œ(VSCode)

1. åˆå§‹åŒ–é¡¹ç›®

```text
// å…¨å±€å®‰è£… vue-cli 3.xï¼ˆå¦‚å·²å®‰è£…è¯·è·³è¿‡æ­¤æ­¥éª¤ï¼‰
npm install -g @vue/cli

// é€šè¿‡ CLI åˆ›å»º uni-app é¡¹ç›®
vue create -p dcloudio/uni-preset-vue my-project
```

![img](uniapp.assets/1190eb9efa120f8db46d2aa81773a8a8.ca422b25.png)

1. å®‰è£…ç»„ä»¶è¯­æ³•æç¤º

ç»„ä»¶è¯­æ³•æç¤ºæ˜¯uni-appçš„äº®ç‚¹ï¼Œå…¶ä»–æ¡†æ¶å¾ˆå°‘èƒ½æä¾›ã€‚

```text
npm i @dcloudio/uni-helper-json
```

å¦‚æœæ˜¯HBuilderXçš„é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨

```text
npm i @types/uni-app @types/html5plus -D
```

å¦å¤–ï¼Œuni-app é¡¹ç›®ä¸‹çš„ manifest.jsonã€pages.json ç­‰æ–‡ä»¶å¯ä»¥åŒ…å«æ³¨é‡Šã€‚vscode é‡Œéœ€è¦æ”¹ç”¨ jsonc ç¼–è¾‘å™¨æ‰“å¼€ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#é…ç½®appid)é…ç½®AppID

![image-20210419171015789](uniapp.assets/image-20210419171015789.c41b33ae.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#eslintä¸ä»£ç æ ¼å¼åŒ–)ESLintä¸ä»£ç æ ¼å¼åŒ–

TIP

ESLintä¸ä»£ç ä¿å­˜å³è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œä»…åœ¨VSCodeä¸Šæœ‰æ•ˆ

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#ä½¿ç”¨ç¬¬ä¸‰æ–¹npmåŒ…)ä½¿ç”¨ç¬¬ä¸‰æ–¹npmåŒ…

uni-appæ”¯æŒä½¿ç”¨**npm**å®‰è£…ç¬¬ä¸‰æ–¹åŒ…ã€‚

æ­¤æ–‡æ¡£è¦æ±‚å¼€å‘è€…ä»¬å¯¹**npm**æœ‰ä¸€å®šçš„äº†è§£ï¼Œå› æ­¤ä¸ä¼šå†å»ä»‹ç»**npm**çš„åŸºæœ¬åŠŸèƒ½ã€‚å¦‚è‹¥ä¹‹å‰æœªæ¥è§¦è¿‡**npm**ï¼Œè¯·ç¿»é˜…[NPMå®˜æ–¹æ–‡æ¡£ (opens new window)](https://docs.npmjs.com/getting-started/what-is-npm)è¿›è¡Œå­¦ä¹ ã€‚

**1. åˆå§‹åŒ–npmå·¥ç¨‹**

è‹¥é¡¹ç›®ä¹‹å‰æœªä½¿ç”¨npmç®¡ç†ä¾èµ–ï¼ˆé¡¹ç›®æ ¹ç›®å½•ä¸‹æ— package.jsonæ–‡ä»¶ï¼‰ï¼Œå…ˆåœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œå‘½ä»¤åˆå§‹åŒ–npmå·¥ç¨‹ï¼š

```shell
npm init -y
```

clié¡¹ç›®é»˜è®¤å·²ç»æœ‰package.jsonäº†ã€‚HBuilderXåˆ›å»ºçš„é¡¹ç›®é»˜è®¤æ²¡æœ‰ï¼Œéœ€è¦é€šè¿‡åˆå§‹åŒ–å‘½ä»¤æ¥åˆ›å»ºã€‚

**2. å®‰è£…ä¾èµ–**

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œå‘½ä»¤å®‰è£…npmåŒ…ï¼š

```shell
npm install packageName --save
```

**3. ä½¿ç”¨**

å®‰è£…å®Œå³å¯ä½¿ç”¨npmåŒ…ï¼Œjsä¸­å¼•å…¥npmåŒ…ï¼š

TIP

* ä¸ºå¤šç«¯å…¼å®¹è€ƒè™‘ï¼Œå»ºè®®ä¼˜å…ˆä» [uni-appæ’ä»¶å¸‚åœº (opens new window)](https://ext.dcloud.net.cn/)è·å–æ’ä»¶ã€‚ç›´æ¥ä» npm ä¸‹è½½åº“å¾ˆå®¹æ˜“åªå…¼å®¹H5ç«¯ã€‚
* é H5 ç«¯ä¸æ”¯æŒä½¿ç”¨å«æœ‰ domã€window ç­‰æ“ä½œçš„ vue ç»„ä»¶å’Œ js æ¨¡å—ï¼Œå®‰è£…çš„æ¨¡å—åŠå…¶ä¾èµ–çš„æ¨¡å—ä½¿ç”¨çš„ API å¿…é¡»æ˜¯ uni-app å·²æœ‰çš„ [API (opens new window)](https://uniapp.dcloud.io/api/README)ï¼ˆå…¼å®¹å°ç¨‹åº APIï¼‰ï¼Œæ¯”å¦‚ï¼šæ”¯æŒ[é«˜å¾·åœ°å›¾å¾®ä¿¡å°ç¨‹åº SDK (opens new window)](https://www.npmjs.com/package/amap-wx)ã€‚ç±»ä¼¼[jQuery (opens new window)](https://www.npmjs.com/package/jquery)ç­‰åº“åªèƒ½ç”¨äºH5ç«¯ã€‚
* node_modules ç›®å½•å¿…é¡»åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ã€‚ä¸ç®¡æ˜¯clié¡¹ç›®è¿˜æ˜¯HBuilderXåˆ›å»ºçš„é¡¹ç›®ã€‚
* æ”¯æŒå®‰è£… mpvue ç»„ä»¶ï¼Œä½†npmæ–¹å¼ä¸æ”¯æŒå°ç¨‹åºè‡ªå®šä¹‰ç»„ä»¶ï¼ˆå¦‚ wxmlæ ¼å¼çš„vant-weappï¼‰ï¼Œä½¿ç”¨å°ç¨‹åºè‡ªå®šä¹‰ç»„ä»¶è¯·å‚è€ƒï¼š[å°ç¨‹åºç»„ä»¶æ”¯æŒ (opens new window)](https://uniapp.dcloud.io/frame?id=å°ç¨‹åºç»„ä»¶æ”¯æŒ)ã€‚
* å…³äºuiåº“çš„è·å–ï¼Œè¯¦è§[å¤šç«¯UIåº“(opens new window)](https://ask.dcloud.net.cn/article/35489)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#åˆå§‹åŒ–eslint)åˆå§‹åŒ–ESLint

```text
# åˆå§‹åŒ–npmåŒ…ç®¡ç†
npm init -y

# å®‰è£…eslintä¾èµ–
npm i -D eslint eslint-config-standard eslint-plugin-import eslint-plugin-node eslint-plugin-promise eslint-plugin-vue
```

package.jsonæ–‡ä»¶é…ç½®å¦‚ä¸‹ï¼š

```json
  "devDependencies": {
    "eslint": "^7.24.0",
    "eslint-config-standard": "^16.0.2",
    "eslint-plugin-import": "^2.22.1",
    "eslint-plugin-node": "^11.1.0",
    "eslint-plugin-promise": "^4.3.1",
    "eslint-plugin-vue": "^7.8.0"
  }
```

æ–°å»º ä¸¤ä¸ªæ–‡ä»¶ï¼Œ`.eslintrc.js`ï¼š

```js
module.exports = {
  env: {
    browser: true,
    commonjs: true,
    es2021: true,
    node: true
  },
  extends: ['eslint:recommended', 'standard', 'plugin:vue/essential'],
  parserOptions: {
    ecmaVersion: 12
  },
  plugins: ['vue'],
  rules: {
    // è¿™é‡Œæœ‰ä¸€äº›è‡ªå®šä¹‰é…ç½®
    'no-console': [
      'warn',
      {
        allow: ['warn', 'error']
      }
    ],
    'no-eval': 'error',
    'no-alert': 'error'
  },
  globals: {
    uni: 'readonly',
    plus: 'readonly',
    wx: 'readonly'
  }
}
```

åˆ›å»º`.eslintignore`æ–‡ä»¶ï¼š

```text
node_modules
.hbuilderx
static
uni_modules
unpackage
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#é…ç½®vscodeè‡ªåŠ¨ä¿®å¤åŠŸèƒ½)é…ç½®vscodeè‡ªåŠ¨ä¿®å¤åŠŸèƒ½

å®‰è£…`vetur`ã€`eslint`æ’ä»¶

æ‰“å¼€vscodeçš„é¦–é€‰é¡¹é…ç½®ï¼Œ`settings.json`æ–‡ä»¶

```json
{
  // ... ä½ è‡ªå·±çš„é…ç½®
  "editor.codeActionsOnSave": {
  "source.fixAll.eslint": true
  },
  "eslint.format.enable": true,
  //autoFixé»˜è®¤å¼€å¯ï¼Œåªéœ€è¾“å…¥å­—ç¬¦ä¸²æ•°ç»„å³å¯
  "eslint.validate": ["javascript", "vue", "html"],

  // å…³é—­vueæ–‡ä»¶çš„è‡ªåŠ¨æ ¼å¼åŒ–å·¥å…·, veturï¼Œä½¿ç”¨eslint
  "[vue]": {
  	"editor.defaultFormatter": "octref.vetur"
  },

  "vetur.format.defaultFormatter.ts": "none",
  "vetur.format.defaultFormatter.js": "none",

  // ... 
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/01-æ­å»ºå¼€å‘ç¯å¢ƒ.html#ä¸‹è½½å®˜æ–¹ä»£ç æç¤º)ä¸‹è½½å®˜æ–¹ä»£ç æç¤º

ç‚¹å‡» [ä¸‹è½½åœ°å€ (opens new window)](https://github.com/zhetengbiji/uniapp-snippets-vscode)ï¼Œæ”¾åˆ°é¡¹ç›®ç›®å½•ä¸‹çš„ .vscode ç›®å½•å³å¯æ‹¥æœ‰å’Œ HBuilderX ä¸€æ ·çš„ä»£ç å—ã€‚

![img](uniapp.assets/d39d378c0821a67c8bf72c7965833378.436a861e.png)



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#é¦–é¡µæ¨¡å—)é¦–é¡µæ¨¡å—

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#é¦–é¡µtabbar)é¦–é¡µtabBar

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#ä»£ç ä¾èµ–åˆ†æ)ä»£ç ä¾èµ–åˆ†æ

å¯ä»¥åœ¨åŸºæœ¬ä¿¡æ¯ä¸­é€‰æ‹©ä»£ç ä¾èµ–åˆ†æ

![img](uniapp.assets/image-20210428193747590.a3e78cc2.png)

æŸ¥çœ‹æœ¬åœ°ä»£ç ä¸åˆ†åŒ…å¤§å°ï¼š

![img](uniapp.assets/image-20210428193958813.de26ed19.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å¯¼å…¥é™æ€èµ„æº)å¯¼å…¥é™æ€èµ„æº

* åˆ é™¤åŸ`static`ç›®å½•ä¸­çš„æ–‡ä»¶ï¼›
* ä¸‹è½½è¯¾ç¨‹çš„é™æ€èµ„æºæ–‡ä»¶å¤¹ï¼Œå¹¶æ”¾ç½®äº`static`çš„`images`ç›®å½•ä¸­ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å¸ƒå±€ä¸æ ·å¼)å¸ƒå±€ä¸æ ·å¼

å®Œæˆæ•ˆæœï¼š

![img](uniapp.assets/image-20210428194953556.b102bed2.png)

åˆ›å»ºtabBarçš„æ­¥éª¤ï¼š

* åˆ›å»ºtabBarå¯¹åº”çš„é¡µé¢ï¼›
* ä¿®æ”¹pages.jsonä¸­çš„é…ç½®é¡¹ï¼š`pages`å’Œ`tabBar`

åˆ›å»ºé¡µé¢HBuilderxæ–¹å¼ï¼š

![img](uniapp.assets/image-20210419173303417.abf903c9.png)

åˆ›å»ºé¡µé¢çš„VSCodeæ’ä»¶æ–¹å¼ï¼š

![image-20210428194346415](uniapp.assets/image-20210428194346415.a9dc6d4b.png)

å¿«é€Ÿåˆ›å»º4ä¸ªé¡µé¢

![image-20210428194614781](uniapp.assets/image-20210428194614781.39a556bc.png)

å¹¶è°ƒæ•´`pages.json`ï¼š

```json
{
	"pages": [
		{
			"path": "pages/home/home"
		},
		{
			"path": "pages/msg/msg"
		},
		{
			"path": "pages/hot/hot"
		},
		{
			"path": "pages/center/center"
		}
	],
	"globalStyle": {
		"navigationBarTextStyle": "black",
		"navigationBarTitleText": "uni-app",
		"navigationBarBackgroundColor": "#F8F8F8",
		"backgroundColor": "#F8F8F8",
		"app-plus": {
			"background": "#efeff4"
		}
	}
}
```

æ–°å»ºtabBarå±æ€§ï¼š

```json
"tabBar": {
	"color": "#999",
	"backgroundColor": "#fafafa",
	"selectedColor": "#02D199",
	"borderStyle": "white",
	"list": [
		{
			"text": "é¦–é¡µ",
			"pagePath": "pages/home/home",
			"iconPath": "static/images/tab_home_no.png",
			"selectedIconPath": "static/images/tab_home_yes.png"
		},
		{
			"text": "æ¶ˆæ¯",
			"pagePath": "pages/msg/msg",
			"iconPath": "static/images/tab_news_no.png",
			"selectedIconPath": "static/images/tab_news_yes.png"
		},
		{
			"text": "çƒ­é—¨",
			"pagePath": "pages/hot/hot",
			"iconPath": "static/images/tab_popular_no.png",
			"selectedIconPath": "static/images/tab_popular_yes.png"
		},
		{
			"text": "æˆ‘çš„",
			"pagePath": "pages/center/center",
			"iconPath": "static/images/tab_my_no.png",
			"selectedIconPath": "static/images/tab_my_yes.png"
		}
	],
	"position": "bottom"
}
```

é…ç½®package.jsonä¸­çš„eslintä¿®å¤å‘½ä»¤ï¼š

```text
"lint": "eslint --ext vue --ext js pages --fix"
```

åº•éƒ¨çš„é˜´å½±ï¼š

```vue
<view class="bottom-line"></view>

<style lang="scss">
.bottom-line {
  position: fixed;
  bottom: -5px;
  left: 0;
  width: 100vw;
  height: 5px;
  background: transparent;
  box-shadow: 0 -5px 5px rgba(0, 0, 0, 0.05);
}
</style>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å¯¼å…¥uview-ui)å¯¼å…¥uView UI

å‡†å¤‡å·¥ä½œ

```js
// å®‰è£…sassä¾èµ–
npm i node-sass sass-loader@10 -D

// å®‰è£…uView
npm install uview-ui
```

åœ¨`main.js`ä¸­å¼•å…¥ï¼š

```text
import uView from 'uview-ui'
Vue.use(uView)
```

åœ¨é¡¹ç›®æ ¹ç›®å½•çš„`uni.scss`ä¸­å¼•å…¥æ ·å¼æ–‡ä»¶ï¼š

```css
/* uni.scss */
@import 'uview-ui/theme.scss';
```

è°ƒæ•´`App.vue`çš„æ ·å¼

```vue
<style lang="scss">
/* æ³¨æ„è¦å†™åœ¨ç¬¬ä¸€è¡Œï¼ŒåŒæ—¶ç»™styleæ ‡ç­¾åŠ å…¥lang="scss"å±æ€§ */
@import "uview-ui/index.scss";
</style>
```

é…ç½®`pages.json`ï¼š

```json
	// ....
	"easycom": {
		"^u-(.*)": "uview-ui/components/u-$1/u-$1.vue"
	}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#é¦–é¡µtabs)é¦–é¡µTabs

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å¸ƒå±€ä¸æ ·å¼-2)å¸ƒå±€ä¸æ ·å¼

`home.vue`æ·»åŠ tabs

```vue
<u-tabs ref="uTabs" :is-scroll="true" active-color="#02D199" height="88" gutter="50"></u-tabs>
```

æ·»åŠ tabsæ•°æ®

```vue
<u-tabs ref="uTabs" :list="tabs" :name="'value'" :current="current" :is-scroll="true" active-color="#02D199" height="88" gutter="50"></u-tabs>
<script>
  export default {
  data: () => ({
    tabs: [
      {
        key: '',
        value: 'é¦–é¡µ'
      },
      {
        key: 'ask',
        value: 'æé—®'
      },
      {
        key: 'share',
        value: 'åˆ†äº«'
      },
      {
        key: 'discuss',
        value: 'è®¨è®º'
      },
      {
        key: 'advise',
        value: 'å»ºè®®'
      },
      {
        key: 'advise',
        value: 'å…¬å‘Š'
      },
      {
        key: 'advise',
        value: 'åŠ¨æ€'
      }
    ],
    // å› ä¸ºå†…éƒ¨çš„æ»‘åŠ¨æœºåˆ¶é™åˆ¶ï¼Œè¯·å°†tabsç»„ä»¶å’Œswiperç»„ä»¶çš„currentç”¨ä¸åŒå˜é‡èµ‹å€¼
    current: 0, // tabsç»„ä»¶çš„currentå€¼ï¼Œè¡¨ç¤ºå½“å‰æ´»åŠ¨çš„tabé€‰é¡¹
    swiperCurrent: 0, // swiperç»„ä»¶çš„currentå€¼ï¼Œè¡¨ç¤ºå½“å‰é‚£ä¸ªswiper-itemæ˜¯æ´»åŠ¨çš„
  })
}
</script>
```

å®Œæˆæ•ˆæœ

![image-20210526225831609](uniapp.assets/image-20210526225831609.c1003bc6.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æ·»åŠ äº‹ä»¶)æ·»åŠ äº‹ä»¶

tabsæ·»åŠ åˆ‡æ¢äº‹ä»¶`tabsChange`

```vue
<u-tabs ref="uTabs" :list="tabs" :name="'value'" :current="current" @change="tabsChange" :is-scroll="true" active-color="#02D199" height="88" gutter="50"></u-tabs>

<script>
	export default {
    ...
    methods: {
      // tabsé€šçŸ¥swiperåˆ‡æ¢
      tabsChange (index) {
        this.current = index
      }
    }
  }
</script>
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æ¥å£å°è£…)æ¥å£å°è£…

é—®é¢˜ï¼šå°ç¨‹åºåŸç”Ÿæä¾›äº†requestè¯·æ±‚ï¼Œä½†æ˜¯æ˜¯callbackçš„ä½¿ç”¨æ–¹å¼ï¼Œå¹¶ä¸æ”¯æŒPromiseï¼Œè§[é“¾æ¥ (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html)ã€‚

![image-20210714162901877](uniapp.assets/image-20210714162901877.3807c355.png)

éœ€æ±‚ï¼šæˆ‘ä»¬å‰ç«¯é‡Œé¢å†™ç½‘ç»œè¯·æ±‚ï¼Œä¹ æƒ¯äº†Axios + async/awaitçš„ä¹¦å†™é£æ ¼ï¼Œé‚£åœ¨å°ç¨‹åºä¸­æ€ä¹ˆå»å®ç°æ¥å£è¯·æ±‚çš„å°è£…å‘¢ï¼Ÿ

æ‹†åˆ†éœ€æ±‚ï¼š

* PromiseåŒ– -> async/awaitæ”¯æŒ
* æ¥å£è¯·æ±‚å°è£…
  * æ‹¦æˆªå™¨
  * ç»Ÿä¸€é”™è¯¯å¤„ç†
  * å–æ¶ˆé‡å¤è¯·æ±‚
  * ..

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å°ç¨‹åºapi-promiseåŒ–)å°ç¨‹åºAPI PromiseåŒ–

æ‰©å±•å¾®ä¿¡å°ç¨‹åºapiæ”¯æŒpromise

é¦–å…ˆï¼Œæœ¬åœ°å°ç¨‹åºnpmåˆå§‹åŒ–

```text
npm init -y

// å®‰è£…ä¾èµ–åŒ…
npm install --save miniprogram-api-promise
```

åœ¨å°ç¨‹åºå…¥å£ï¼ˆapp.jsï¼‰è°ƒç”¨ä¸€æ¬¡promisifyAllï¼Œåªéœ€è¦è°ƒç”¨ä¸€æ¬¡ã€‚

```js
import { promisifyAll, promisify } from 'miniprogram-api-promise';

const wxp = {}
// promisify all wx's api
promisifyAll(wx, wxp)
console.log(wxp.getSystemInfoSync())
wxp.getSystemInfo().then(console.log)
wxp.showModal().then(wxp.openSetting())

// compatible usage
wxp.getSystemInfo({success(res) {console.log(res)}})

// promisify single api
promisify(wx.getSystemInfo)().then(console.log)
```

å»ºè®®çš„å†™æ³•ï¼š

```text
import { promisifyAll, promisify } from 'miniprogram-api-promise';

const wx.p = {}

promisifyAll(wx, wx.p)

// å…¨å±€ä½¿ç”¨wx.p
wx.p.getSystemInfo().then(console.log)
```

async/awaitæ”¯æŒçš„æ–¹æ³•æ¯”è¾ƒç®€å•ï¼šå¼€æˆ·`å°† JS ä»£ç ç¼–è¯‘æˆ ES5`å³å¯ï¼š[é“¾æ¥(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/devtools/codecompile.html)

> åœ¨å·¥å…· 1.05.2106091 ç‰ˆæœ¬ä¹‹åï¼ŒåŸæœ‰çš„`ES6 è½¬ ES5` å’Œ `å¢å¼ºç¼–è¯‘` é€‰é¡¹ç»Ÿä¸€åˆå¹¶ä¸º`å°† JS ä»£ç ç¼–è¯‘æˆ ES5`ï¼Œæ­¤åŠŸèƒ½å’ŒåŸæœ‰çš„`å¢å¼ºç¼–è¯‘`é€»è¾‘ä¸€è‡´ã€‚å¦‚éœ€äº†è§£æ—§ç‰ˆæœ¬çš„æ–‡æ¡£ï¼Œè¯·[ç‚¹æ­¤æŸ¥çœ‹ (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/devtools/codecompile_old.html)ã€‚

æ”¯æŒasync/awaitè¯­æ³•ï¼ŒæŒ‰éœ€æ³¨å…¥`regeneratorRuntime`ï¼Œç›®å½•ä½ç½®ä¸è¾…åŠ©å‡½æ•°ä¸€è‡´

![image-20210714164109331](uniapp.assets/image-20210714164109331.812b4718.png)

å¹³æ—¶å¼€å‘çš„æ—¶å€™ï¼Œä¸€å®šè¦æ³¨æ„è¯¥é€‰é¡¹æœ‰æ²¡æœ‰æ‰“å¼€å“¦ï¼ï¼

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#uniappå°ç¨‹åºè¯·æ±‚å°è£…)uniappå°ç¨‹åºè¯·æ±‚å°è£…

æ¥å£è¯·æ±‚å°è£…

* æ‹¦æˆªå™¨
* ç»Ÿä¸€é”™è¯¯å¤„ç†
* å–æ¶ˆé‡å¤è¯·æ±‚

TIP

uniappä¸­å·²ç»æ”¯æŒPromise + async/awaitï¼Œä½†æ˜¯ï¼Œå¯¹äºrequestè¯·æ±‚çš„é”™è¯¯çš„å¤„ç†éœ€è¦è‡ªå·±æ¥å¤„ç†ã€‚

è¯·æ±‚å·¥å…·jsï¼š

```js
// è¿™ä¸ªæ–‡ä»¶æˆ‘ä»¬ä½¿ç”¨uni.requestè¿›è¡Œå°è£…
// åŒæ ·é€‚åˆäºåŸç”Ÿå°ç¨‹åºçš„requestå°è£… -> Promise API

// éœ€æ±‚åˆ†æ

const errorHandle = (err) => {
  if (err.statusCode === 401) {
    // todo 4.ä¸šåŠ¡ â€”> refreshToken -> è¯·æ±‚å“åº”401 -> åˆ·æ–°token
  } else {
    // å…¶ä»–çš„é”™è¯¯
    // showToastæç¤ºç”¨æˆ·
    // 3.å¯¹é”™è¯¯è¿›è¡Œç»Ÿä¸€çš„å¤„ç† -> showToast
    const { data: { msg } } = err
    uni.showToast({
      icon: 'none',
      title: msg || 'è¯·æ±‚å¼‚å¸¸ï¼Œè¯·é‡è¯•',
      duration: 2000
    })
  }
}

export const request = (options = {}) => {
  const { success, fail } = options
  // 1.åœ¨å¤´éƒ¨è¯·æ±‚çš„æ—¶å€™ï¼Œtokenå¸¦ä¸Š -> è¯·æ±‚æ‹¦æˆªå™¨
  const publicArr = [/\/public/, /\/login/]
  // local store -> uni.getStorageSync('token')
  let isPublic = false
  publicArr.forEach(path => {
    isPublic = isPublic || path.test(options.url)
  })
  const token = uni.getStorageSync('token')
  if (!isPublic && token) {
    options.header = Object.assign({},
      {
        Authorization: 'Bearer ' + token
      }, options.header)
  }
  return new Promise((resolve, reject) => {
    uni.request(Object.assign({}, options, {
      success: (res) => {
        // å“åº”æ‹¦æˆªå™¨
        if (res.statusCode >= 200 && res.statusCode < 300) {
          if (success && typeof success === 'function') {
            // 2.åœ¨å“åº”çš„æ—¶å€™ï¼Œå¤„ç†dataæ•°æ®
            success(res.data)
            return
          }
          // è¯·æ±‚æˆåŠŸ
          // 2.åœ¨å“åº”çš„æ—¶å€™ï¼Œå¤„ç†dataæ•°æ®
          resolve(res.data)
        } else {
          // è¯·æ±‚å¤±è´¥
          errorHandle(res)
          reject(res)
        }
      },
      fail: (err) => {
        if (fail && typeof fail === 'function') {
          fail(err)
          return
        }
        errorHandle(err)
        reject(err)
      }
    }))
  })
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#uviewä¸­è¯·æ±‚å°è£…)uviewä¸­è¯·æ±‚å°è£…

å·¥ä½œåŸç†ï¼š

uViewæä¾›äº† httpå°è£…ï¼š

å¹³å°å·®å¼‚è¯´æ˜

| App  |  H5  | å¾®ä¿¡å°ç¨‹åº | æ”¯ä»˜å®å°ç¨‹åº | ç™¾åº¦å°ç¨‹åº | å¤´æ¡å°ç¨‹åº | QQå°ç¨‹åº |
| :--: | :--: | :--------: | :----------: | :--------: | :--------: | :------: |
|  âˆš   |  âˆš   |     âˆš      |      âˆš       |     âˆš      |     âˆš      |    âˆš     |

ç”±äºæŸäº›å°ç¨‹åºå¹³å°çš„é™åˆ¶ï¼š

* deleteè¯·æ±‚ï¼Œä¸æ”¯æŒæ”¯ä»˜å®å’Œå¤´æ¡å°ç¨‹åº(HX2.6.15)
* putè¯·æ±‚ï¼Œä¸æ”¯æŒæ”¯ä»˜å®å°ç¨‹åº(HX2.6.15)

```text
è¯­æ³•ï¼š

get | post | put | delete(url, params, header).then(res => {}).catch(res => {})
```

* `url<String>` è¯·æ±‚çš„URLï¼Œå¯ä»¥å®Œæ•´çš„URL(httpå¼€å¤´)ï¼Œæˆ–è€…æ˜¯è·¯å¾„çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ—¶ä¼šè‡ªåŠ¨æ‹¼æ¥ä¸Š`baseUrl`(ä¸€èˆ¬ä¸ºapiçš„åŸŸåéƒ¨åˆ†)
* `params<Object>` è¯·æ±‚çš„å‚æ•°ï¼Œå¯¹è±¡å½¢å¼ï¼Œå¦‚`"{name: 'lisa', age: 23}"`ï¼Œè¯¥å‚æ•°æ˜¯å¯é€‰çš„
* `header <Object>` è¯·æ±‚çš„headerï¼Œå¯¹è±¡å½¢å¼ï¼Œå¦‚æœtokenç­‰å­—æ®µï¼Œå»ºè®®é€šè¿‡é…ç½®å†™å…¥ï¼Œè¯¥å‚æ•°æ˜¯å¯é€‰çš„`get`å’Œ`post`éƒ½æŒ‚è½½åœ¨`$u`å¯¹è±¡ä¸‹ï¼Œå…¶ä¸­`get`å’Œ`post`ä½¿ç”¨æ–¹æ³•å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯ä¸€ä¸ªä¸º`this.$u.get`

ä½†æ˜¯å¦‚æœç›´æ¥æŒ‰ç…§ä¸Šé¢çš„å†™ä¼šæŠ¥é”™ï¼Œç”±äºæ²¡æœ‰è®¾ç½®baseURLï¼š ![image-20210716134642927](uniapp.assets/image-20210716134642927.6c997f5f.png)

å®˜æ–¹æ–‡æ¡£ä¹Ÿæœ‰è¯´æ˜ï¼š

![image-20210716134734477](uniapp.assets/image-20210716134734477.4f953221.png)

è®¾ç½®baseURLçš„æ–¹æ³•ï¼šé…ç½®å‚æ•°çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨`$u.http.setConfig()`ï¼Œæ‰“å¼€`main.js`ï¼š

```js
Vue.prototype.$u.http.setConfig({
  baseUrl: 'http://localhost:3000'
})
```

ä¿®æ”¹æ¥å£ï¼š

```js
this.$u.get('/public/getCaptcha?sid=123123123'
).then(res => {
  console.log(res)
}).catch(err => {
  console.log('err', err)
})
```

ç„¶åå°±å¯ä»¥æ­£å¸¸çš„è¯·æ±‚äº†ï¼š

![image-20210716134858589](uniapp.assets/image-20210716134858589.a1e4dff2.png)

uviewå¯¹äºæ‹¦æˆªå™¨ï¼ˆè¯·æ±‚/å“åº”ï¼‰çš„æ”¯æŒï¼š

```js
Vue.prototype.$u.http.interceptor.request = (config) => {
  console.log('config)
  return config
}

Vue.prototype.$u.http.interceptor.response = (data) => {
  console.log('data)
  return data
}
```

è¯·æ±‚å°è£…ï¼š

`config.js`é…ç½®æ–‡ä»¶ï¼š

```js
// export const baseUrl = 'https://mp.toimc.com'
export const baseUrl =
  process.env.NODE_ENV === 'development'
    ? 'http://localhsot:3000'
    : 'https://mp.toimc.com'
```

`common/request.js`æ–‡ä»¶

```js
// console.log(process.env)
import store from '@/store'
import { authNav } from '@/common/checkAuth'
import { baseUrl } from '@/config'
import { simpleHttp } from '@/common/utils/simple-http'

export const config = {
  baseUrl: baseUrl, // è¯·æ±‚çš„æœ¬åŸŸå
  // baseUrl: 'https://mp.toimc.com', // è¯·æ±‚çš„æœ¬åŸŸå
  // è®¾ç½®ä¸ºjsonï¼Œè¿”å›åä¼šå¯¹æ•°æ®è¿›è¡Œä¸€æ¬¡JSON.parse()
  dataType: 'json',
  showLoading: true, // æ˜¯å¦æ˜¾ç¤ºè¯·æ±‚ä¸­çš„loading
  loadingText: 'è¯·æ±‚ä¸­...', // è¯·æ±‚loadingä¸­çš„æ–‡å­—æç¤º
  loadingTime: 800, // åœ¨æ­¤æ—¶é—´å†…ï¼Œè¯·æ±‚è¿˜æ²¡å›æ¥çš„è¯ï¼Œå°±æ˜¾ç¤ºåŠ è½½ä¸­åŠ¨ç”»ï¼Œå•ä½ms
  originalData: false, // æ˜¯å¦åœ¨æ‹¦æˆªå™¨ä¸­è¿”å›æœåŠ¡ç«¯çš„åŸå§‹æ•°æ®
  loadingMask: true, // å±•ç¤ºloadingçš„æ—¶å€™ï¼Œæ˜¯å¦ç»™ä¸€ä¸ªé€æ˜çš„è’™å±‚ï¼Œé˜²æ­¢è§¦æ‘¸ç©¿é€
  // é…ç½®è¯·æ±‚å¤´ä¿¡æ¯
  header: {
    'content-type': 'application/json;charset=UTF-8'
  },
}

const install = (Vue) => {
  const http = Vue.prototype.$u.http
  http.setConfig(config)

  http.interceptor.request = (config) => {
    let isPublic = false
    const publicPath = [/^\/public/, /^\/login/]
    publicPath.forEach((path) => {
      isPublic = isPublic || path.test(config.url)
    })
    const token = store.state.token
    // if (token) {
    if (!isPublic && token) {
      config.header.Authorization = 'Bearer ' + token
    }
    return config
    // å¦‚æœreturnä¸€ä¸ªfalseå€¼ï¼Œåˆ™ä¼šå–æ¶ˆæœ¬æ¬¡è¯·æ±‚
    // if(config.url == '/user/rest') return false; // å–æ¶ˆæŸæ¬¡è¯·æ±‚
  }

  http.interceptor.response = (data) => {
    return data
  }
}

export default {
  install
}
```

é—®é¢˜æ˜¯å¦‚ä½•è¿›è¡Œç»Ÿä¸€çš„é”™è¯¯å¤„ç†ï¼Ÿ

* uview-uiçš„httpå·¥å…·ç±»æ²¡æœ‰é”™è¯¯çš„ç»Ÿä¸€å¤„ç†
* ç»Ÿä¸€çš„é”™è¯¯å¤„ç†çš„åº”ç”¨åœºæ™¯ï¼š401è·³è½¬åˆ°é‰´æƒã€ç»™ç”¨æˆ·å‹å¥½æç¤ºã€refreshTokençš„åœºæ™¯

å…·ä½“åšæ³•ï¼Œä¿®æ”¹uviewçš„æºç ï¼Œå¹¶æŠŠuviewçš„ä»£ç ç§»åŠ¨åˆ°é¡¹ç›®çš„ä»£ç ä¸­ï¼Œåˆ©ç”¨hbuilder&uniappçš„æŒ‰éœ€åŠ è½½ï¼ŒæŒ‰éœ€æ‰“åŒ…çš„æœºåˆ¶ï¼Œä½¿ç”¨uviewä¸­çš„ç»„ä»¶ã€‚

æ­¥éª¤ï¼š

* å¤åˆ¶`node_modules`ä¸­çš„`uview-ui`åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ï¼›

* åˆ é™¤`package.json`ä¸­çš„`dependencies`

* ä¿®æ”¹pages.jsonä¸­çš„`easycom`ï¼š

  ```js
  	"easycom": {
  		"^u-(.*)": "@/uview-ui/components/u-$1/u-$1.vue"
  	}
  ```

* ä¿®æ”¹main.jsä¸­çš„å¼•å…¥ ï¼š

  ```js
  import uView from './uview-ui'
  ```

  `uni.scss`ä¸­çš„å¼•å…¥ ï¼š

  ```js
  /* uni.scss */
  @import "./uview-ui/theme.scss";
  ```

  è¿˜æœ‰App.vueä¸­çš„å¼•å…¥ ï¼š

  ```js
  /* æ³¨æ„è¦å†™åœ¨ç¬¬ä¸€è¡Œï¼ŒåŒæ—¶ç»™styleæ ‡ç­¾åŠ å…¥lang="scss"å±æ€§ */
  @import "./uview-ui/index.scss";
  ```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#åˆå¹¶uviewè¯·æ±‚)åˆå¹¶uviewè¯·æ±‚

ç›®çš„ï¼š

* åŠ¨æ€å¼•å…¥ API æ¥å£
* ç»Ÿä¸€æ‰€æœ‰çš„è¯·æ±‚çš„ä½¿ç”¨æ–¹å¼ `this.$u.api.æ¥å£`

æ€è·¯ï¼š

* ä½¿ç”¨`require.context`åŠ¨æ€å¼•å…¥apiæ¥å£
* ä½¿ç”¨æ’ä»¶çš„æ–¹å¼ï¼Œåœ¨Vue.prototype.$uæ¥æ·»åŠ apiå±æ€§

ç›®å½•ç»“æ„ï¼š

![img](uniapp.assets/image-20210717223433286.90a35ff7.png)

å…¶ä¸­`index.js`ä»£ç ï¼š

```js
const req = require.context('./modules', false, /\.js$/)

const install = (Vue) => {
  let api = Vue.prototype.$u.api || {}
  req.keys().forEach(item => {
    const module = req(item)
    // 1.å–å¾—æ‰€æœ‰çš„æ–¹æ³• -> keyå€¼,
    const keys = Object.keys(module)
    keys.forEach(key => {
      api = {
        ...api,
        // 2.å–å¾—æ‰€æœ‰æ–¹æ³•å¯¹åº”çš„function -> valueå€¼
        // 3.æŠŠä¸Šé¢çš„å¯¹è±¡ -> $u.api
        [key]: module[key]
      }
    })
    // 4.æŠŠå®ƒå°è£…æˆä¸ºä¸€ä¸ªæ’ä»¶ï¼Œä»¥ä¾¿åœ¨åé¢çš„æ–¹æ³•ä¸­ä½¿ç”¨ this.$u.api.æ–¹æ³•å(å‚æ•°).then(res) ....
  })
  Vue.prototype.$u.api = api
}

export default {
  install
}
```

ä¿®æ”¹`main.js`ï¼š

```js
import apis from '@/api'

Vue.use(apis)
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å†…å®¹åˆ—è¡¨)å†…å®¹åˆ—è¡¨

æµ‹è¯•å›¾ç‰‡åœ°å€ï¼š[é“¾æ¥(opens new window)](https://toimc-public.obs.cn-east-3.myhuaweicloud.com/1322928787@qq.com/2021-05-30/107382e7-024d-45ad-a4f4-c5df8a40e91f-tmp_40bdb731a1cae24e217376f9473ed92c.jpg)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å¸ƒå±€ä¸æ ·å¼-3)å¸ƒå±€ä¸æ ·å¼

æ·»åŠ `list-item`ç»„ä»¶

```vue
<template>
  <view class="list-item">
    <view class="list-head">
      <!-- æ ‡é¢˜éƒ¨åˆ† -->
      <text class="type" :class="['type-'+item.catalog]">{{tabs.filter(o => o.key === item.catalog)[0].value}}</text>
      <text class="title">{{item.title}}</text>
    </view>
    <!-- ç”¨æˆ·éƒ¨åˆ† -->
    <view class="author u-flex u-m-b-18">
      <u-image :src="item.uid.pic" class="head" width="40" height="40" shape="circle" error-icon="/static/images/header.jpg"></u-image>
      <text class="name u-m-l-10">{{item.uid.name}}</text>
    </view>
    <!-- æ‘˜è¦éƒ¨åˆ† + å³ä¾§çš„å›¾ç‰‡ -->
    <view class="list-body u-m-b-30 u-flex u-col-top">
      <view class="info u-m-r-20 u-flex-1">{{item.content}}</view>
      <image class="fmt" :src="item.snapshot" v-if="item.snapshot" mode="aspectFill" />
    </view>
    <!-- å›å¤ + æ–‡ç« å‘è¡¨çš„æ—¶é—´ -->
    <view class="list-footer u-flex">
      <view class="left">
        <text class="reply-num u-m-r-25">{{item.answer}} å›å¤</text>
        <text class="timer">{{item.created | moment}}</text>
      </view>
    </view>
  </view>
</template>

<script>
import { tabs } from '@/config/const'
export default {
  props: {
    item: {
      type: Object,
      default: () => ({})
    }
  },
  data: () => ({
    tabs
  })
}
</script>

<style lang="scss" scoped>
.list-item {
  background: #fff;
  margin-top: 20rpx;
  padding: 30rpx;
}

.list-head {
  margin-bottom: 18rpx;
  .type {
    display: inline-block;
    height: 36rpx;
    width: 72rpx;
    text-align: center;
    line-height: 36rpx;
    white-space: nowrap;
    margin-right: 10rpx;
    font-size: 24rpx;
    border-radius: 18rpx;
    border-bottom-left-radius: 0;
    color: #fff;
    background-color: red;
    position: relative;
    top: -4rpx;
    transform: scale(0.9);
  }
  .type-share {
    background-color: #feb21e;
  }
  .type-ask {
    background-color: #02d199;
  }
  .type-discuss {
    background-color: #fe1e1e;
  }
  .type-advise {
    background-color: #0166f8;
  }
  .type-notice {
    background-color: #00a3b8;
  }
  .type-logs {
    background-color: #33cb61;
  }
  .title {
    color: #333;
    font-size: 32rpx;
    line-height: 44rpx;
    font-weight: bold;
  }
}

.author {
  color: #666;
  font-size: 24rpx;
}

.list-body {
  .info {
    font-size: 28rpx;
    color: #666;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }
  .fmt {
    width: 192rpx;
    height: 122rpx;
    border-radius: 8rpx;
    flex-shrink: 0;
  }
}

.list-footer {
  color: #999;
  font-size: 24rpx;
}
</style>
```

`home.vue`æ·»åŠ å†…å®¹å±•ç¤ºåŒº

```vue
<template>
  <view class="home">
    <view class="fixed-top">
      <search @click="handle()"></search>
      <u-tabs name="value" :list="tabs" :is-scroll="true" :current="current" @change="change" gutter="50" height="88" active-color="#02D199"></u-tabs>
    </view>
    <!-- é¦–é¡µçš„åˆ—è¡¨ -->
    <view class="content" :style="{'padding-top': offsetTop + 'px'}">
      <view class="wrapper">
        <view class="list-box" v-for="(item,index) in lists" :key="index">
          <list-item :item="item" v-if="item.status === '0' && item.title && item.catalog"></list-item>
        </view>
        <view class="end">{{msg}}</view>
      </view>
    </view>
    <view class="bottom-line"></view>
  </view>
</template>

<script>
// import { request } from '@/common/http'
import { tabs } from '@/config/const'
export default {
  components: {},
  data: () => ({
    current: 0,
    offsetTop: 50,
    page: {
      page: 0,
      limit: 10,
      catalog: '',
      sort: 'created'
    },
    lists: [],
    loading: false,
    pullDown: false,
    isEnd: false,
    tabs
  }),
  methods: {
    handle () {
      uni.navigateTo({
        url: '/subcom-pkg/search/search'
      })
    },
    change (index) {
      this.isEnd = false
      this.current = index
      this.page = {
        page: 0,
        limit: 10,
        catalog: this.tabs[index].key,
        sort: 'created'
      }
      this.lists = []
      this.getList()
    },
    async getList () {
      this.loading = true
      const { data } = await this.$u.api.getList(this.page)
      if (data.length < this.page.limit) {
        this.isEnd = true
      }
      this.lists = [...this.lists, ...data]
      this.loading = false
      this.page.page++
    }
  },
  mounted () {
    this.getList()
  },
  computed: {
    msg () {
      let str = ''
      if (this.loading) {
        str = 'åŠ è½½ä¸­...'
      } else {
        if (this.lists.length > 0) {
          // è¯´æ˜æœ‰æ•°æ®
          if (this.isEnd) {
            str = 'æ‚¨å·²ç»åˆ°åº•å•¦~æ²¡æœ‰æ›´å¤šäº†ï¼'
          }
        } else {
          // è¯´æ˜æ²¡æœ‰æ•°æ®
          str = 'æš‚æ— å†…å®¹ï¼Œè¯·ä¸‹æ‹‰åˆ·æ–°'
        }
      }
      return str
    }
  },

  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
  onLoad () {},
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆ
  onReady () {
    const query = uni.createSelectorQuery().in(this)
    query.select('.fixed-top').boundingClientRect((data) => {
      this.offsetTop = data.height
    }).exec()
  },
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢æ˜¾ç¤º(not-nvue)
  onShow () {},
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢éšè—
  onHide () {},
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢å¸è½½
  onUnload () {},
  // é¡µé¢å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸‹æ‹‰åŠ¨ä½œ
  onPullDownRefresh () {
    this.pullDown = true
    this.change(this.current)
    // setTimeout(() => {
    //   console.log(2222)
    //   uni.stopPullDownRefresh()
    // }, 2000)
  },
}
</script>

<style lang="scss">
.fixed-top {
  position: fixed;
  left: 0;
  top: 0;
  width: 100vw;
  z-index: 999;
}

.search {
  width: 70%;
}

.content {
  background: #f5f6f7;
  .wrapper {
    padding-bottom: 24rpx;
  }
}

.end {
  color: #999;
  text-align: center;
  background: #fff;
  padding: 25rpx 0;
  // background: transparent;
}
</style>
```

ç›‘å¬é¡µé¢åŠ è½½ï¼Œå¤„ç†å†…å®¹åˆ—è¡¨å®¹å™¨çš„padding

```javascript
onLoad () {
  const query = uni.createSelectorQuery().in(this)
  query.select('.fixed-top').boundingClientRect(data => {
    this.offsetTop = data.height
  }).exec()
  // const { windowHeight } = uni.getSystemInfoSync()
  // const query = uni.createSelectorQuery().in(this)
  // query.select('#tabs').boundingClientRect(data => {
  // }).exec()
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#è·å–æ•°æ®)è·å–æ•°æ®

åœ¨é€šè¿‡åå°æ¥å£è·å–æ•°æ®å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹requestå’Œapiè¿›è¡Œç®€å•çš„å°è£…ã€‚

åˆ›å»º`common`æ–‡ä»¶å¤¹ï¼Œæ–°å»º request.js

```javascript
// 1.è¯·æ±‚æ‹¦æˆªå™¨
// 2.åœ¨å“åº”çš„æ—¶å€™ï¼Œå¤„ç†dataæ•°æ®
// 3.ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
// è¿™é‡Œçš„vmï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨vueæ–‡ä»¶é‡Œé¢çš„thisï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½åœ¨è¿™é‡Œè·å–vuexçš„å˜é‡ï¼Œæ¯”å¦‚å­˜æ”¾åœ¨é‡Œé¢çš„tokenå˜é‡
const install = (Vue, vm) => {
  // æ­¤ä¸ºè‡ªå®šä¹‰é…ç½®å‚æ•°ï¼Œå…·ä½“å‚æ•°è§ä¸Šæ–¹è¯´æ˜
  Vue.prototype.$u.http.setConfig({
    baseUrl: 'http://localhost:3000',
    dataType: 'json',
    showLoading: true, // æ˜¯å¦æ˜¾ç¤ºè¯·æ±‚ä¸­çš„loading
    loadingText: 'è¯·æ±‚ä¸­...', // è¯·æ±‚loadingä¸­çš„æ–‡å­—æç¤º
    loadingTime: 800, // åœ¨æ­¤æ—¶é—´å†…ï¼Œè¯·æ±‚è¿˜æ²¡å›æ¥çš„è¯ï¼Œå°±æ˜¾ç¤ºåŠ è½½ä¸­åŠ¨ç”»ï¼Œå•ä½ms
    originalData: false, // æ˜¯å¦åœ¨æ‹¦æˆªå™¨ä¸­è¿”å›æœåŠ¡ç«¯çš„åŸå§‹æ•°æ®
    loadingMask: true, // å±•ç¤ºloadingçš„æ—¶å€™ï¼Œæ˜¯å¦ç»™ä¸€ä¸ªé€æ˜çš„è’™å±‚ï¼Œé˜²æ­¢è§¦æ‘¸ç©¿é€
    // é…ç½®è¯·æ±‚å¤´ä¿¡æ¯
    header: {
      'content-type': 'application/json;charset=UTF-8'
    },
    errorHandle: (err) => {
      if (err.statusCode === 401) {
        // todo 4.ä¸šåŠ¡ â€”> refreshToken -> è¯·æ±‚å“åº”401 -> åˆ·æ–°token
        uni.showToast({
          icon: 'none',
          title: 'é‰´æƒå¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•',
          duration: 2000
        })
      } else {
        // å…¶ä»–çš„é”™è¯¯
        // showToastæç¤ºç”¨æˆ·
        // 3.å¯¹é”™è¯¯è¿›è¡Œç»Ÿä¸€çš„å¤„ç† -> showToast
        const { data: { msg } } = err
        uni.showToast({
          icon: 'none',
          title: msg || 'è¯·æ±‚å¼‚å¸¸ï¼Œè¯·é‡è¯•',
          duration: 2000
        })
      }
    }
  })

  // è¯·æ±‚æ‹¦æˆªï¼Œé…ç½®Tokenç­‰å‚æ•°
  Vue.prototype.$u.http.interceptor.request = (config) => {
    // å¼•ç”¨token
    // 1.åœ¨å¤´éƒ¨è¯·æ±‚çš„æ—¶å€™ï¼Œtokenå¸¦ä¸Š -> è¯·æ±‚æ‹¦æˆªå™¨
    const publicArr = [/\/public/, /\/login/]
    // local store -> uni.getStorageSync('token')
    let isPublic = false
    publicArr.forEach(path => {
      isPublic = isPublic || path.test(config.url)
    })
    const token = uni.getStorageSync('token')
    if (!isPublic && token) {
      config.header = Object.assign({},
        {
          Authorization: 'Bearer ' + token
        }, config.header)
    }
    // æœ€åéœ€è¦å°†configè¿›è¡Œreturn
    return config
    // å¦‚æœreturnä¸€ä¸ªfalseå€¼ï¼Œåˆ™ä¼šå–æ¶ˆæœ¬æ¬¡è¯·æ±‚
    // if(config.url === '/user/rest') return false; // å–æ¶ˆæŸæ¬¡è¯·æ±‚
  }

  // å“åº”æ‹¦æˆªï¼Œåˆ¤æ–­çŠ¶æ€ç æ˜¯å¦é€šè¿‡
  Vue.prototype.$u.http.interceptor.response = (res) => {
    console.log('ğŸš€ ~ file: request.js ~ line 46 ~ install ~ res', res)
    return res
  }
}

export default {
  install
}
```

åˆ›å»º`api`æ–‡ä»¶å¤¹ï¼Œæ–°å»º index.jsï¼ŒæŒ‰æ¨¡å—è¿›è¡Œæ¥å£åˆ’åˆ†

![image-20210526235920712](uniapp.assets/image-20210526235920712.8bf13693.png)

index.js

```javascript
const req = require.context('./modules', false, /\.js$/)

const install = (Vue) => {
  let api = Vue.prototype.$u.api || {}
  req.keys().forEach(item => {
    const module = req(item)
    // 1.å–å¾—æ‰€æœ‰çš„æ–¹æ³• -> keyå€¼,
    const keys = Object.keys(module)
    keys.forEach(key => {
      api = {
        ...api,
        // 2.å–å¾—æ‰€æœ‰æ–¹æ³•å¯¹åº”çš„function -> valueå€¼
        // 3.æŠŠä¸Šé¢çš„å¯¹è±¡ -> $u.api
        [key]: module[key]
      }
    })
    // 4.æŠŠå®ƒå°è£…æˆä¸ºä¸€ä¸ªæ’ä»¶ï¼Œä»¥ä¾¿åœ¨åé¢çš„æ–¹æ³•ä¸­ä½¿ç”¨ this.$u.api.æ–¹æ³•å(å‚æ•°).then(res) ....
  })
  Vue.prototype.$u.api = api
}

export default {
  install
}
```

public.js

```javascript
import Vue from 'vue'

const HttpRequest = Vue.prototype.$u

// ---------------------------------------é¦–é¡µ----------------------------------------- //
// è·å–é¦–é¡µåˆ—è¡¨æ•°æ®
export const getContentList = params => HttpRequest.get('/public/list', params)
```

åœ¨`main.js`ä¸­å¼•å…¥

```javascript
import apis from '@/api/index'
import interceptors from '@/common/request'

Vue.use(interceptors)
Vue.use(apis)
```

ä¸‹é¢æˆ‘ä»¬æ¥è·å–é¦–é¡µåˆ—è¡¨æ•°æ®ï¼Œåˆ›å»º`getList`æ–¹æ³•

```javascript
  methods: {
    async getList () {
      this.loading = true
      const { data } = await this.$u.api.getList(this.page)
      if (data.length < this.page.limit) {
        this.isEnd = true
      }
      this.lists = [...this.lists, ...data]
      this.loading = false
      this.page.page++
    }
  },
```

æœ€ååœ¨`onshow`å‘¨æœŸè¯·æ±‚æ•°æ®

```javascript
onShow () {
    this.getList()
}
```

å®Œæˆæ•ˆæœï¼š

![image-20210527003502507](uniapp.assets/image-20210527003502507.3b9a3d15.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#åˆ†é¡µä¸åˆ‡æ¢)åˆ†é¡µä¸åˆ‡æ¢

ä¸Šæ‹‰åˆ†é¡µåŠ è½½åˆ—è¡¨æ•°æ®

```javascript
  watch: {
    loading (newval) {
      if (this.pullDown && !newval) {
        this.pullDown = false
        uni.stopPullDownRefresh()
      }
    }
  },
  // é¡µé¢å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸Šæ‹‰è§¦åº•
  onReachBottom () {
    // 1. è§¦å‘æ¡ä»¶çš„è®¾ç½®ï¼Œè·ç¦»åº•éƒ¨å¤šè¿œçš„æ—¶å€™è§¦å‘ - 50
    // console.log('reach bottom')
    // 2. å½“æ²¡æœ‰æ›´å¤šçš„æ—¶å€™ï¼Œéœ€è¦ç»™ç”¨æˆ·ä¸€ä¸ªæç¤ºï¼ŒåŒæ—¶è®¾ç½®é¡µé¢æ ·å¼ï¼Œä¸å†å‘è¯·æ–°çš„è¯·æ±‚
    if (this.isEnd || this.loading) return
    this.getList()
  },
```

åŒæ—¶åœ¨tabåˆ‡æ¢æ—¶åŠ è½½ä¸åŒåˆ†ç±»çš„æ•°æ®ï¼Œåœ¨tabsåˆ‡æ¢æ–¹æ³•`tabsChange`ä¸­æ·»åŠ  getList æ–¹æ³•

```javascript
tabsChange (index) {
  this.current = index
  this.page = {
    page: 0,
    limit: 10,
    catalog: this.tabs[this.current].key || '',
    sort: 'created'
  }
  this.getList()
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æ—¥æœŸè¿‡æ»¤å™¨)æ—¥æœŸè¿‡æ»¤å™¨

æ³¨æ„ï¼šç”¨æ³•ä¸vueä¸­çš„è¿‡æ»¤å™¨ä¸€è‡´

1. å®‰è£…ä¾èµ–ï¼š

```text
npm i dayjs
```

1. æ·»åŠ filter.jsæ–‡ä»¶ï¼š

```js
import dayjs from 'dayjs'
import relativeTime from 'dayjs/plugin/relativeTime'
import 'dayjs/locale/zh-cn'

dayjs.extend(relativeTime)

const moment = (date) => {
  // è¶…è¿‡7å¤©ï¼Œæ˜¾ç¤ºæ—¥æœŸ
  if (dayjs(date).isBefore(dayjs().subtract(7, 'days'))) {
    return dayjs(date).format('YYYY-MM-DD')
  } else {
    // 1å°å‰ï¼Œxxå°æ—¶å‰ï¼ŒXå¤©å‰
    return dayjs(date).locale('zh-cn').from(dayjs())
  }
}

const hours = (date) => {
  if (dayjs(date).isBefore(dayjs(dayjs().format('YYYY-MM-DD 00:00:00')))) {
    return dayjs(date).format('YYYY-MM-DD')
  } else {
    // 1å¤©å†…
    return dayjs(date).format('HH:mm:ss')
  }
}

// ...

export default {
  moment,
  hours
}
```

1. main.jsä¸­ä½¿ç”¨ï¼š

```js
import filters from '@/common/filter'

Object.keys(filters).forEach((key) => {
  Vue.filter(key, filters[key])
})
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æœç´¢)æœç´¢

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#é¦–é¡µæœç´¢æŒ‰é’®)é¦–é¡µæœç´¢æŒ‰é’®

å…³äºè®¾è®¡ï¼š

å‚è€ƒï¼š[é“¾æ¥1 (opens new window)](https://developers.weixin.qq.com/miniprogram/design/#å›¾æ ‡)ï¼Œ [é“¾æ¥2(opens new window)](https://segmentfault.com/a/1190000018733860)

å®˜æ–¹çš„æ–‡æ¡£ç›®å‰æ²¡æœ‰å¯¹å³ä¾§æŒ‰é’®çš„è¯´æ˜ï¼š

![image-20210712184845616](uniapp.assets/image-20210712184845616.663c9f4c.png)

åœ¨æ—§çš„æ–‡æ¡£ä¸­æœ‰è¯´æ˜ï¼š

![image-20210712184922032](uniapp.assets/image-20210712184922032.fce664cd.png)

ä»å›¾ä¸­åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š

* Androidè·ŸiOSæœ‰å·®å¼‚ï¼Œè¡¨ç°åœ¨é¡¶éƒ¨åˆ°èƒ¶å›ŠæŒ‰é’®ä¹‹é—´çš„è·ç¦»å·®äº†6pt
* èƒ¶å›ŠæŒ‰é’®é«˜åº¦ä¸º32ptï¼Œ iOSå’ŒAndroidä¸€è‡´

**å…³äºpxï¼Œemä¸ptå•ä½çš„è¯´æ˜ï¼š**

pxæ˜¯åƒç´ å•ä½ï¼Œemæ˜¯ç›¸å¯¹å•ä½ï¼Œptæ˜¯ç»å¯¹å•ä½ã€‚

å®ƒä»¬å„è‡ªçš„å¥½å¤„æ˜¯ï¼š

* pxå¯ä»¥åœ¨è®¡ç®—æœºå±å¹•ä¸Šï¼Œèƒ½è¾¾åˆ°é¢„æœŸçš„æ•ˆæœï¼Œåœ¨æ‰“å°æœºå’Œå…¶å®ƒçš„é«˜åˆ†è¾¨ç‡è®¾å¤‡ä¸Šï¼Œå®ƒåˆèƒ½å–å¾—æ‰€å¸Œæœ›çš„æ•ˆæœã€‚
* emçš„ä¼˜ç‚¹å¾ˆå¤šï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªé¡µé¢ä¸Šï¼Œä½ ç»™å®šäº†ä¸€ä¸ªçˆ¶å…ƒç´ çš„å­—ä½“å¤§å°ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡è°ƒæ•´ä¸€ä¸ªå…ƒç´ æ¥æˆæ¯”ä¾‹çš„æ”¹å˜æ‰€æœ‰å…ƒç´ å¤§å°ã€‚å®ƒå¯ä»¥è‡ªç”±ç¼©æ”¾ï¼Œæ¯”å¦‚ç”¨æ¥åˆ¶ä½œå¯ä¼¸ç¼©çš„æ ·å¼è¡¨ã€‚
* ptæ˜¯ä¸€ç§å›ºå®šé•¿åº¦çš„åº¦é‡å•ä½ï¼Œæ˜¯èƒ½å¤Ÿä½¿ç”¨æµ‹é‡è®¾å¤‡æµ‹å¾—çš„é•¿åº¦ã€‚ç»å¯¹å•ä½ä½œç”¨æœ‰é™ï¼Œå› ä¸ºå®ƒä»¬ä¸èƒ½å¤Ÿç¼©æ”¾ï¼Œé€šå¸¸åªç”¨åœ¨å·²ç»çŸ¥é“æ˜¯ç”¨åœ¨å“ªç§è¾“å‡ºåª’ä½“çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨ã€‚ä½†å¤§å¤šæ•°æƒ…å†µä¸‹æœ€å¥½ä½¿ç”¨ç›¸å¯¹å•ä½ã€‚ä¸€èˆ¬éƒ½æ˜¯ç”¨pxå’Œemè¿™ä¸¤ç§ç§é…æ­æ¯”è¾ƒå¥½ã€‚

ä½¿ç”¨`wx.getSystemInfoSync()`å¯ä»¥åœ¨consoleä¸­å¿«é€ŸæŸ¥çœ‹è®¾å¤‡çš„ä¿¡æ¯ã€‚

ä¸¤ç§æ–¹å¼åˆ›å»ºuniçš„easycomç»„ä»¶ï¼š

1. åˆ›å»º`components/ç»„ä»¶ååŒåæ–‡ä»¶å¤¹/ç»„ä»¶å.vue`
2. ä½¿ç”¨hbuilderxæ¥åˆ›å»ºç»„ä»¶ï¼Œå‹¾é€‰`åˆ›å»ºç›®å½•`

![image-20210712193718265](uniapp.assets/image-20210712193718265.0bf6f757.png)

åˆ›å»ºsearchç»„ä»¶ï¼š

```vue
<template>
  <view class="search" :style="{'padding-top': barHeight + 'px'}" @click="$emit('click')">
    <view class="search-box">
      <u-icon name="search" color="#CCC" size="28" class="icon"></u-icon>
      <text>æœç´¢ç¤¾åŒºå†…å®¹</text>
    </view>
  </view>
</template>

<script>
export default {
  name: 'search',
  data () {
    return {
      barHeight: 0
    }
  },
  beforeMount () {
    this.getNavBarHeight()
  },
  methods: {
    getNavBarHeight () {
      uni.getSystemInfo({
        success: (result) => {
          console.log('ğŸš€ ~ file: home.vue ~ line 24 ~ getNavBarHeight ~ result', result)
          const statusBarHeight = result.statusBarHeight
          const isiOS = result.system.indexOf('iOS') > -1
          if (isiOS) {
            this.barHeight = statusBarHeight + 5
          } else {
            this.barHeight = statusBarHeight + 8
          }
        }
      })
    }
  }
}
</script>

<style lang="scss" scoped>
.search {
  position: relative;
  width: 100vw;
  background: #fff;
  padding: 0 32rpx 12rpx;
  z-index: 999;
  display: flex;
  justify-content: flex-start;
  align-items: center;
  color: #ccc;
  .search-box {
    position: relative;
    width: 60%;
    @media screen and (max-width: 320px) {
      width: 50%;
    }
    background: #f3f3f3;
    height: 64rpx;
    border-radius: 32rpx;
    line-height: 64rpx;
    columns: #ccc;
    font-size: 26rpx;
    padding-left: 74rpx;
  }
  .icon {
    position: absolute;
    left: 32rpx;
    top: 19rpx;
  }
}
</style>
```

æ³¨æ„ï¼š

* åœ¨uniappä¸­è‡ªå®šä¹‰çš„ç»„ä»¶æ˜¯æ— æ³•ç›´æ¥ç»‘å®šäº‹ä»¶çš„ï¼›
* å¯ä»¥åœ¨å­ç»„ä»¶ä¸­çš„æœ€å¤–ä¾§çš„viewä¸Šç»‘å®š`$emit('click')`

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æ·»åŠ åˆ†åŒ…)æ·»åŠ åˆ†åŒ…

åœ¨uniappä¸­æ·»åŠ åˆ†åŒ…

* æ–°å¢é¡µé¢ï¼Œæ¯”å¦‚`/sub-pkg/search/search`
* é…ç½®`pages.json`

æ³¨æ„ï¼š

**åˆ†åŒ…çš„ä½œç”¨æ˜¯ä¸ºäº†æå‡å°ç¨‹åºçš„åŠ è½½æ€§èƒ½ï¼Œé¦–é¡µtabsç›¸å…³çš„é¡µé¢æ˜¯ä¸èƒ½æ”¾ç½®åœ¨åˆ†åŒ…ä¸­çš„ã€‚**

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å¸ƒå±€ä¸æ ·å¼-4)å¸ƒå±€ä¸æ ·å¼

```vue
<template>
  <view class="search">
    <div class="search-box">
      <u-search :focus="true"></u-search>
    </div>
    <!-- æœç´¢å»ºè®®åˆ—è¡¨ -->
    <view class="list" v-if="searchResults.length !== 0">
      <view class="item" v-for="(item, i) in searchResults" :key="i">
        <view class="name">{{item.name}}</view>
        <u-icon type="arrow-right" size="16"></u-icon>
      </view>
    </view>
    <!-- æœç´¢å†å² -->
    <view class="history-box" v-else>
      <!-- æ ‡é¢˜åŒºåŸŸ -->
      <view class="history-title" v-if="historyList.length !== 0">
        <text>æœç´¢å†å²</text>
        <u-icon type="trash" size="17" @click="clean"></u-icon>
      </view>
      <!-- åˆ—è¡¨åŒºåŸŸ -->
      <view class="history-list">
        <uni-tag :text="item" v-for="(item, i) in historyList" :key="i"></uni-tag>
      </view>
    </view>
    <!-- çƒ­é—¨æ¨è -->
    <view class="history-box">
      <!-- æ ‡é¢˜åŒºåŸŸ -->
      <view class="history-title" v-if="hotList.length !== 0">
        <text>çƒ­é—¨æ¨è</text>
      </view>
      <!-- åˆ—è¡¨åŒºåŸŸ -->
      <view class="history-list">
        <uni-tag :text="item" v-for="(item, i) in hotList" :key="i"></uni-tag>
      </view>
    </view>
  </view>
</template>

<style lang="scss" scoped>
.search {
  padding: 24rpx;
}

.search-box {
  position: sticky;
  top: 0;
  z-index: 999;
  padding-bottom: 50rpx;
}

.list {
  padding: 0 5px;
  .item {
    font-size: 12px;
    padding: 13px 0;
    border-bottom: 1px solid #efefef;
    display: flex;
    align-items: center;
    justify-content: space-between;
    .name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 3px;
    }
  }
}

.history-box {
  padding: 0 10rpx 50rpx;

  .history-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 40px;
    font-size: 16px;
    font-weight: bold;
  }

  .history-list {
    display: flex;
    flex-wrap: wrap;
    ::v-deep .uni-tag {
      margin-top: 5px;
      margin-right: 5px;
      border-radius: 25rpx;
    }
  }
}
</style>
```

`pages.json`ä¸­é…ç½®åˆ†åŒ…ï¼š

```json
"subPackages": [
	{
		"root": "subpkg",
		"pages": [
			{
				"path": "search/search",
				"style": {
					"navigationBarTitleText": "æœç´¢"
				}
			},
      // ...
    ]
  }
]
```

ä½¿ç”¨easycomï¼Œæ·»åŠ `search.vue`ç»„ä»¶ï¼š

```vue
<template>
  <view :style="{'padding-top': barHeight + 'px'}" class="search" @click="$emit('click')">
    <view class="search-box">
      <u-icon name="search" color="#CCCCCC" size="28" class="icon"></u-icon>
      <text>æœç´¢ç¤¾åŒºå†…å®¹</text>
    </view>
  </view>
</template>

<script>

export default {
  props: {},
  data: () => ({
    barHeight: 80
  }),
  computed: {},
  methods: {
    getNavBarHeight () {
      uni.getSystemInfo({
        success: (result) => {
          const statusBarHeight = result.statusBarHeight
          const isiOS = result.system.indexOf('iOS') > -1
          if (isiOS) {
            this.barHeight = statusBarHeight + 5
          } else {
            this.barHeight = statusBarHeight + 7
          }
          // getApp().globalData.barHeight = this.barHeight
          // å­˜å‚¨è‡³storeä¸­
          // uni.setStorage({
          //   key: 'setBarHeight',
          //   data: this.barHeight
          // })
        },
        fail: () => {},
        complete: () => {}
      })
    }
  },
  beforeMount () {
    this.getNavBarHeight()
  }
}
</script>

<style lang="scss" scoped>
// search
.search {
  // padding-top: 25px;
  position: relative;
  background: #fff;
  width: 100vw;
  padding: 0 32rpx 12rpx;
  z-index: 999;
  .search-box {
    position: relative;
    width: 70%;
    @media (max-width: 320px) {
      width: 60%;
    }
    height: 64rpx;
    line-height: 64rpx;
    background: #f3f3f3;
    border-radius: 32rpx;
    color: #ccc;
    font-size: 26rpx;
    padding-left: 74rpx;
  }
  .icon {
    position: absolute;
    left: 32rpx;
    top: 19rpx;
  }
}
</style>
```

`home.vue`æ·»åŠ å¯¼èˆªï¼š

```vue
<search @click="gotoSearch"></search>
```

å®Œæˆæ•ˆæœï¼š

![image-20210523231442459](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgQAAABOCAYAAABfXg61AAAEDmlDQ1BrQ0dDb2xvclNwYWNlR2VuZXJpY1JHQgAAOI2NVV1oHFUUPpu5syskzoPUpqaSDv41lLRsUtGE2uj+ZbNt3CyTbLRBkMns3Z1pJjPj/KRpKT4UQRDBqOCT4P9bwSchaqvtiy2itFCiBIMo+ND6R6HSFwnruTOzu5O4a73L3PnmnO9+595z7t4LkLgsW5beJQIsGq4t5dPis8fmxMQ6dMF90A190C0rjpUqlSYBG+PCv9rt7yDG3tf2t/f/Z+uuUEcBiN2F2Kw4yiLiZQD+FcWyXYAEQfvICddi+AnEO2ycIOISw7UAVxieD/Cyz5mRMohfRSwoqoz+xNuIB+cj9loEB3Pw2448NaitKSLLRck2q5pOI9O9g/t/tkXda8Tbg0+PszB9FN8DuPaXKnKW4YcQn1Xk3HSIry5ps8UQ/2W5aQnxIwBdu7yFcgrxPsRjVXu8HOh0qao30cArp9SZZxDfg3h1wTzKxu5E/LUxX5wKdX5SnAzmDx4A4OIqLbB69yMesE1pKojLjVdoNsfyiPi45hZmAn3uLWdpOtfQOaVmikEs7ovj8hFWpz7EV6mel0L9Xy23FMYlPYZenAx0yDB1/PX6dledmQjikjkXCxqMJS9WtfFCyH9XtSekEF+2dH+P4tzITduTygGfv58a5VCTH5PtXD7EFZiNyUDBhHnsFTBgE0SQIA9pfFtgo6cKGuhooeilaKH41eDs38Ip+f4At1Rq/sjr6NEwQqb/I/DQqsLvaFUjvAx+eWirddAJZnAj1DFJL0mSg/gcIpPkMBkhoyCSJ8lTZIxk0TpKDjXHliJzZPO50dR5ASNSnzeLvIvod0HG/mdkmOC0z8VKnzcQ2M/Yz2vKldduXjp9bleLu0ZWn7vWc+l0JGcaai10yNrUnXLP/8Jf59ewX+c3Wgz+B34Df+vbVrc16zTMVgp9um9bxEfzPU5kPqUtVWxhs6OiWTVW+gIfywB9uXi7CGcGW/zk98k/kmvJ95IfJn/j3uQ+4c5zn3Kfcd+AyF3gLnJfcl9xH3OfR2rUee80a+6vo7EK5mmXUdyfQlrYLTwoZIU9wsPCZEtP6BWGhAlhL3p2N6sTjRdduwbHsG9kq32sgBepc+xurLPW4T9URpYGJ3ym4+8zA05u44QjST8ZIoVtu3qE7fWmdn5LPdqvgcZz8Ww8BWJ8X3w0PhQ/wnCDGd+LvlHs8dRy6bLLDuKMaZ20tZrqisPJ5ONiCq8yKhYM5cCgKOu66Lsc0aYOtZdo5QCwezI4wm9J/v0X23mlZXOfBjj8Jzv3WrY5D+CsA9D7aMs2gGfjve8ArD6mePZSeCfEYt8CONWDw8FXTxrPqx/r9Vt4biXeANh8vV7/+/16ffMD1N8AuKD/A/8leAvFY9bLAAAAbGVYSWZNTQAqAAAACAAEARoABQAAAAEAAAA+ARsABQAAAAEAAABGASgAAwAAAAEAAgAAh2kABAAAAAEAAABOAAAAAAAAAJAAAAABAAAAkAAAAAEAAqACAAQAAAABAAACBKADAAQAAAABAAAATgAAAAC40TxvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAXBklEQVR4Ae2d65LUxhmGZ3cWWDDG5xOYg43BxofyH18ITlUuI5VfTnwJqbgqF5KqxEmlKteQH/4RnzjYBi/ngw02LBjYZdfpR/BuerWSRpptzWhm364SmpVare6nhb63v/4kzfQK0q+//rotbD7+ePkgrPeGZXdYnEzABEzABEzABCaLwJ1Q3cth+Sws/2CZmZlZDut1aWbdX+GPIAY+DKtPwnI4v89/m4AJmIAJmIAJTDyBM6EFHwVR8GnckjVBEITAbNjxJzLFGfzbBEzABEzABExgKgkw+P84CINVWjcXNdFiIILhnyZgAiZgAiYw5QTkAPgD7cw8BI+nCf4+5Q1380zABEzABEzABDYS+A3TBzOPAwhPhv2OGdgIyVtMwARMwARMYNoJEFNwjLgBniawGJj27nb7TMAETMAETKCYABrguARBcRZvNQETMAETMAET2AoEjhNUyHsGOp/C1Ebv4cOHvZWVld7q6mq2ZhuLkwmYgAmYgAmMm0CYh++x9Pv93uzsbLaem5vLto27bjXO/wExBIshYydfOoQAWF5ezoQAIsDJBEzABEzABCaNAOIAYbBt27Zs3dH630EQdGqITXUePHiQCQGLgI5eNq6WCZiACZjAUAQQBwiDHTt2dM5z0BlBICGAGHAyARMwARMwgWkngCjokjDohCBYWlrq3b9/3/EA0371u30mYAImYALrCBBzMD8/39u+ffu67eP4Y6yCYGV1pXf/3v0sRmAcjfc5TcAETMAETKALBIgxmN853+vP9sdWnbEJArwC9+7dG1vDfWITMAETMAET6BqBnTt3js1bMBZBgBBAEDiZgAmYgAmYgAmsJ8D0AcJg1GnkguCXX37JniAYdUN9PhMwARMwAROYFAI8ibBr166RVpc3FY4sWQyMDLVPZAImYAImMMEEeAcPNnOUaWSCwGJglN3qc5mACZiACUw6gVGLgpEIAmIGaJiTCZiACZiACZhAfQLYzlEF4LcuCAgedABh/c53ThMwARMwAROICYzKjrYqCHjPwKiUTQzPv03ABEzABExgmghgS7GpbaZWBQEvHXIyARMwARMwARPYPIG2bWprggAXB18rdDIBEzABEzABE9g8AWxqm1PwrQgCPlTEtwmcTMAETMAETMAE0hFo87s/rQgCvljYsa8qp+sNl2QCJmACJmACYyKgLwO3cfrkgqDNyrYBwGWagAmYgAmYwCQRaGvQPZcaAhXtckKwEK3JoldD8pUpJxMwARMwAROYFALYWj6bnDIlt4RdfAHR6upq7+rVq73FxcVekbLavn1b+JDErt5LL7008g9K/PTTT707d+5k76x+7rnnCvuW+vPNbAJKLl++nAmZvXv3FuYdZiN9trCwkJ3j9ddf783ODu84unHjRo820ZZnnnlmYHWuX7+e9clTTz3V27Nnz8D8Xctw7ty5TFzSVq6fNtKVK1fWrpF9+/a1cQqXaQImMGEEuG93WhBgsDBeXUoY2wsXzofIzPI3JbJvaelW7/bt29lNva0bexGXH3/8MXtfNR6LvCC4e/duJgB47TMfucAY/Pzzz1kxCIIffvhhXZE7duwYyqjSb3pnNoJpM1/ZQnhR3vLyUi1BcO3atbVrpo4goOwLFy6sa/dm/4DbsAILkbmy0u77NjiHvFrUE3HoZAImsLUJYGu5H6b0cCf1EHTNO3Dp0qUeBlcJcLt3786MK0YP40fEJoaXGy7TCRi0W7du9V577bVsJK5jR7mmk0+fPr3usU3qFz9uQh68BXFiZP/ee+/Fm7LfFy9erHx1NGUpkbfqAmPf/v37lX3D+sUXX8zqhciCL8Y2ZeI/AcItZcLADisIuGZI/X5/qCoh6gb9v2FqS9fn999/P3BUQP4XXnhhqPr4IBMwgckhwL2j6n7dtCVJBUFsWJpWJHV+hEAsBp5//vnsph+PrhAHSoy8MYYa7eEKfuONN7R7pGvqIJYYGowsi0bxVAbjL2Mb5y+q6M2bN2s/9RGfo6gs+FUJAgwRLm4MJetDhw4VFZNkG+2P+3PYQoc15pxPgmDYaRYEaBOvGt4ClqpEXSwIqgh5nwlMBwHZiVStSSYIuDE2ubGlakBROYykMUYkbo7Miz/xxBNFWde2Pf3005n3gBEYRhGvAaO3cd9Y33333bU6xj9o11tvvZVtYsRMvcsSrviqC4d+YwRKwnNSZdwkQuJz4YkhdkBJRhJPyxdffJFtfvnllzNRozwp1m+++WZjQYCiZhppUHwD/U/9ByW1VdM7Vfnph1iExnlhPjc3nJdB5Tx8uNKZ/4Oqk9cmYALtEeDezT0oxcCIWiYTBFUGpz0cxSUzupc4wRU8SAyoFFwvjGhPnTqVHc/ojZt4kRHUMcOs8UZo/l8vcGL97bffZsUdOHBgmGJLjxk0SkcMfPPNN9nxjP6bxhDQ9zKM+UpoO16MNhNGvszYxufl2sB4X716pXfs2NvxrnW/8aqw1E0wlKgqOwahWlZHPFivvPLKukOZEiJ/PrYCocL1ko91QQQTpOlkAiawdQhw/2WaMEVKJgjavuHXbSyje7m9n3zyyQ2BeoPKAeyrr77aO3/+fCYKmHZIHdnNDV11VH0wnPlt7Pvyyy+zLNQrLxS++uqrzBDL6KqseI3noGo/eWMxR7sHXVyoUWIslBj985RAPmGk5Tko2p/PP+zfBBlivBFuR48eLfVwYJARA6R+v/6lXzalAFcJT0b4ZSq96f8N6ok4pF8QjkxdSdRS/4XwRAgJ44/gzQejZjv9jwmYwJYgwP1l0D27Loj6d8UBJerGOCBb67tjo5ofQdU9Oe5kRmfckOPy6h4/KB+jPm76JEZ6sMOg8AhJ3viIa2y0VX4dQ9M0AI/6sDRJGOIiLwpTCST28ZREW0lGniDGr7/+OjOgRV4OxI5SVRyE8rCmX8qmbeIROXnKBAHCrayv6HOuhe3bt2enxchruosNTGVJDPA3HJ999tlMAHFtEPdy/fq1IBYPrgXLtsmaOjiZgAl0h4BsRIoaJRMEZTe8FJVsUkbsti0yCnXL4qaKMW1qHOuUz4hOozpGgogOjOaRI0eywzFsSvFTA/m6aB/1xBVelTAqRUabMiV62B8bn3x51EvGN78v/zeGTSKGUSyGa3Fx49MBupgfvY9hY7Dc3r37Cr0P8fmIpTh79mwWbEd5TH/gTYnjBKi36k7fbuba0LnxgJCqvAPKW7ZWnzONhJgRM8QFbUAQ4Ilg+oo13hjEDOuF4Cmg73ii47vvvsvy4iFxMgET2DoEUtreZIJgkFt6VN0TGzdu1MMmCQIMTBuPz9WtV1UbtE/rqjJ5SiE/F80IXrwwQBgZDJASxil+pGVQ8KKOQ5RplAtHzsvfGK6yxPVTtB8jXme6gcBR3mmA4SThDaBtTPdQNoJBKT/1ou1N1xJulE+w4jBuO4QA/SAhQB3wGhw+fDhjz/V38uTJtf0Ip2PHjmXnQkzAh2khbgqUxRMITOdUCbum7XR+EzCB7hJIaXunThCsrj4KXsu73pt2Z2xkuVkXja6bljlMfkaNSnHHx9s1yla+QWuM15kzZzKhQ16MR/yGQgwdnguMDCKhydQLrBitkhAZGDYSbm6NqLMNj//RlAbCA/GQT2VBePl8/E09GfkzcoYV8R+IAsoWI4L3UvQlxlfKnHMRiIqnookogEfs2eGNmfv3H1gLPKSfeB+FzkMb4YtA4AkL2kXfMV1Bm4lNIS/88R7F1zDHOpmACUwfgdgubLZ1yQTBZiuS6vj5+Z3ZSDPvXm9afnx8CgNS5/wYLwLkMFpK8chR21iXbY/z8JvRNXlpA0aRETSGkotIbmlG8ORhwdDpCQiOxygpUQZGm+OKEmViwGR8Mc4ySjy+WfQIJ0GT5KcOdef1i86tbZSDYWbaAOMoDwj7MaCpAkSZAokTbUAUMHrnPHWSniBglE+94ikOgjHxHOg/+8GDB7MiERD004kTJ9amFNhxKDwdQ99x/TBFI+516uE8JmACJgCBeneuCWIVu/pxXQ87VyxDgqeh7g1+M5ioK6NyEjfzIrc2IkWPlRXtL/KKYCiUMPSxscfYxCNU5WNNm/EaxO/KRhBozjvOy28M4unTpzJjpX0wPHnyRAjyO9Jo5Kzjh10ToPfOO+9kRhPjqZRCcFAWfaBRO4ILw47xlihAkNS9ZuKnNSib+i6E0b7iHRBfPGUg7wkeCLw76jueruBa4HxM98RTPpTnZAImYAJ1CUydIIgFACOm+O+6UHCZa35YN+K6x9bNh7sY4xwHQXIsRhc3sKLO4/IwsBIE8WgyzlP1G2PB8bOzM2GU/+gxOQyL2qpjiTfgmXgF6jE6rTI0Ra5tlUVcAC5ujPEwdVY5TdcYylgMcDzip6lbP39ejD6xCiR5WBBwMJBQwEuCIGmS6AdEhR7T5FiMPAIsvha4Npgu0JQOMQNMHxGkipehzHvTpC7OawImsDUJJBME3Ii4qY07MVpjpMwIDoOLIWsiCjTyUluazJ/XbXvRY2gYFb1RkblgjEpV0vsJ4jyIiaooc0aXMlQYMNzL8WtweW8Dhlvz4Ho0EkNK/xYF98FJL3KiLrjsFRdA/AHGkzwE+dHGojLiNqT4zSOjsScELoieeASvNjY5n4QP5ZC4NmgTCQGFAJEQwWCXeVOyAx7/Q5nUlz7XNQdryi679mgPcQOwFV+EBOeGP8JgmPbF9fJvEzCBySCQchAwdYKAGzRGbeFxYBmGCCNZFxpz7Bq1c3NlRJY6qS7UFSPAIs8A58KwyOiUnbtovwx41TEYyps3b6xF9FMHAv4wPtSDc2M8WTPqxFiR4EmAYD7Ij7bIkBEjgAiQWEFgwJAgN/K1LQZgQj1jkYM7Hc8EkfgIFfIMEwCoKR21lQDAvMHmuiMfC94cRvxVMQtw0dSA+gxOxJCwljdI+/Jr5UUM0C7qhrBggT0C08kETGC6CXAfSJWSCQJG5UVGKlVFm5SD4cEzwJQB8+6MtrlZVxl3DCA3cI5RwnXeRqIuuIOZjmAkifGIE4YYnogZbvISOXEe/WbqQW5mjEBRQijgti9K9BlBhiyDElMIeuQtzosHBubwyl8D7MNNn98eH5/iN8JFwZKUx38SBIz6nLl6GWDq0kQUICQQGhIDtKnME8N8Py58cdX5i9oYj+LJx7Uqz1ZR/kHb6H+JoTj2Y9Bx3m8CJjC5BIpix4ZtTTJBgNHqUmJkxkiN0S4LgVgYWm6a3NC5GXPT1miO0RiiIE5Ekut58Hj7Zn8zah6UEDQYB+pAPXn+PB+AhpCQGOCiUCR6vux4Dpp9UpTxWkFyCBXyUx4Lf7PINY24yr+5b5BrPDZ8+bpt9m/ajxiAkRL1zc+9sw9jLQFG/rqiACMrMYDwORQFauqcWvP/gGuG88A3z175WNNfGG48KxxHfegHftdlxjWrvsMjQLtgUvRER3xu/zYBE5gOAiltbzJBkFKlpOgmjAKjOIwFN0hu6PFImPpy89SNXufkOPYhIhixISTaEAU6X9UaAYMQwK3MKJVH6TBqXAAYaL2EhzKoY1V6//331+2m3DjI7/PPP8/24/LnvLSfxFSG1sQSVI14s4wj/kfTAJwWLszlx49t5quDUEDU0Lf0P6Jq0FSGxCVtz3+AKF8+f+P54XsYGPtBQan5aQeOZ1omL/7YXpSYHsB7oQQDiwHR8NoEpp9AStubTBBgSLuWuDlyY2ZEfunSxbV5c+qpUZXqTF5uztxM2YcQwGiMWxQgABTtjzcDd/TcXH+tLdSbPHg96iTEhd5sh0AqGt1jKBEfrDFozMPjscAg1h251qlLijyM1nkmn/pVzdfH51KUPrETg8SAjoNxk4SocjIBEzCBtgmktL3JrDjuUYwTRqRrCUGwZ8/b2aiXESELxhWQGFJGwYzKBJY1I+6uiAJcwbGre2npEWN489QA60GJ9hIjEQexlc0zE/muvoQVrmw4Ia66Jgi47vTkxCAG8f4iIRTv928TMAET6DoB7tOa+k1R12SCgMpgSAdFuqeo9LBlYPhZYld5WVlFooDH9Oq6csvKzW+vElAYb54KYA67KB/b8BggePBs5N3T7GdqQY/C6dy4mBAZ+fzaDyOMLOdHRCAmWBAliAiEQZOpA9z6TFEUJU3Z3LmzWPiSJC54gjCLEl6MVP8Z8BQUue+LzttkG+2TN6puXeXFqXMexJuTCZjA1iSgQWyq1icVBIweuywImkLLi4J80GHT8pQfYaGRuubqFXymrwIuLW280WPIcUWz1ktwMPo8GcGCwaEc3NvUHWOOGFDCuDK/rnlw9mOwYqMSz0dh9InDoE+ZZtAUCtH6epxPZVetmZpQ9HtZPtq7tPT/JzzifGWCgPqkSnBIIQh4xwR9IuPPb6U6QpS8CAhElJMJmIAJVBFI7bFNKggwQnI1VzVikvbRJtzL3KCbjIqr2ogBlhBQPj3iiIs+FgPwZDqDYL84ToD81InAQgwjBo0F402dSRh+BAEjfo5nnj1O7IsNFvuK5tQRGcy7E8CGmOE8dY0bZeJVwMOQIvEfAI8IdUiZUvVtvz+bGfR8/egT6l0nIcrKpnPyxy8vL627XvL7/bcJmMB0EsA26F6fqoUz4caV9M6Kccobu1SVnZZyMPp634FG/epYDPpCiBrHMBP0VlcBUiYGnvx1R7o8gaEvEGL0ERll0wgxezwlqm+8Xb8JgmSUeygE/NWtv47typonU1jgQjvqJnjK+6NjeNS1Dle8QxxPv0sgqoyyNf3O+yq4jhwXUUbJ201g+ggw0Ks7cKjb+uSCAH1hd2dd/M5nAiZgAiZgAs0J4HHU1GTzo4uPGByeXnxc6VYqiHJxMgETMAETMAETSE8AG5taDFDL5IKAQtuqLGU7mYAJmIAJmMBWJdDmoLsVQUCFU89tbNXOd7tNwARMwARMQASwrW14Byi/FUFAwQRjVQWekcfJBEzABEzABEygHgFsKra1rdSaIKDC8zvn26q3yzUBEzABEzCBLUWgbZvaqiDoz/bXPTu/pXrOjTUBEzABEzCBRAR4Dw02tc3UqiCg4rg32nRxtAnHZZuACZiACZjAuAmMyo62LggAibKZ1BfUjPtC8PlNwARMwAS2LgFsZ/yW2jZJjEQQ0ADe1GZR0GZXumwTMAETMIFpIoDNrPOW01RtHpkgoMIWBam6zeWYgAmYgAlMM4FRiwFYJn91cZ0O4kM30/RVxDptdh4TMAETMAETqEOAmIFRTRPE9RmLIKACCIJUX8CLG+TfJmACJmACJjCpBBAC4wrEH5sgoLNWVld69+/d7/H1PCcTMAETMAET2KoEeOkQ7xlo+9HCKr5jFQSqGN4CPpuc+EvMKt5rEzABEzABE+gkAb3qf1xegRgKgmAxbNgdbxzHb8TAgwcPsmUc5/c5TcAETMAETGCUBPgQYIc+BngbQXA6ADg6SghV55IwWF5e7q2urlZl9T4TMAETMAETmCgCs7Oz2SP4HRIC4ndiLvz6LCydEQRyn/BFJ2ILEAasLQ7UZ16bgAmYgAlMEgFEADECPErY4Y/+/RcPwW8D2L92HS6eA4TByspKJg5Ys43FyQRMwARMwATGTYABLUu/3+8hAlgjANg2Aek4gmBbqOjJsByegAq7iiZgAiZgAiZgAmkJnA3FHZsNymU5/PgobdkuzQRMwARMwARMYEII/C5ogaXs1cXhx6eh0p9MSMVdTRMwARMwARMwgTQE/hw0wL8pKv6Wwcfhb4uCNIBdigmYgAmYgAl0ncBfghj4oyq5IdIhxBR8GHYiDBxTIEpem4AJmIAJmMD0EDgXmvL7IAb+GTdpgyBg5+NAw+PhJ8sHYdkblrG/vCjUwckETMAETMAETKAZgbsh+9Ww/Ccs/wrL34IY2PDNgP8BQKksQoi1naQAAAAASUVORK5CYII=)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æ·»åŠ äº‹ä»¶-2)æ·»åŠ äº‹ä»¶

`home.vue`æ·»åŠ `gotoSearch`æ–¹æ³•ï¼Œå®Œæˆé¡µé¢è·³è½¬ã€‚

```javascript
gotoSearch () {
  uni.navigateTo({
    url: '/subcom-pkg/search/search'
  })
}
```

å®Œæˆæ•ˆæœï¼š

![iShot2021-05-23 23.36.17](./assets/iShot2021-05-23 23.36.17.gif)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æœç´¢å†å²åŠŸèƒ½)æœç´¢å†å²åŠŸèƒ½

* æœ¬åœ°æ•°æ®ç¼“å­˜
* æ–°çš„æœç´¢æ•°æ®æ˜¾ç¤ºåœ¨æœ€å‰é¢
* ç‚¹å‡»åƒåœ¾æ¡¶åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œå¹¶åªæ˜¾ç¤ºçƒ­é—¨æ¨è
* ç‚¹å‡»æ ‡ç­¾è¿›è¡Œå¿«é€Ÿæœç´¢

æœ¬åœ°æ•°æ®ç¼“å­˜ï¼š

```js
data () {
  return {
    // ...
    historyList: uni.getStorageSync('historyList') || [],
  }
},
```

æ·»åŠ å¯¹åº”çš„äº‹ä»¶ï¼š

```js
// æ·»åŠ æœ¬åœ°ç¼“å­˜
addHis (value) {
  // æ ‡ç­¾å»é‡
  const index = this.historyList.indexOf(value)
  if (index !== -1) {
    this.historyList.splice(index, 1)
  }
  // æœ€è¿‘æœç´¢çš„æ ‡ç­¾ï¼Œæ˜¾ç¤ºåœ¨æœ€å‰ç«¯
  this.historyList.unshift(value)
  // æœ¬åœ°ç¼“å­˜
  uni.setStorageSync('historyList', this.historyList)
},
clearSearch () {
  // å½“ç”¨æˆ·ç‚¹å‡»æœç´¢æ¡†å³ä¾§çš„æ¸…ç©ºæŒ‰é’®çš„é€»è¾‘
  this.showResult = false
  this.searchResults = []
  this.page = {
    title: '',
    page: 0,
    limit: 20
  }
  this.loading = false
},
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æœç´¢å»ºè®®-åˆ—è¡¨)æœç´¢å»ºè®®(åˆ—è¡¨)

* å®Œæˆæ¨èåˆ—è¡¨æ ·å¼
* è®¾ç½®è¯·æ±‚å‚æ•°
* ä½¿ç”¨ç»Ÿä¸€å‘é€æ–‡ç« è¯·æ±‚
* æœ¬åœ°å±•ç¤ºåˆ—è¡¨ï¼Œå¹¶éšè—æ¨èå†å²ä¸çƒ­é—¨æ¨è
* æ¸…ç©ºæœç´¢æ¡ä»¶æ—¶ï¼ŒæŠŠæ¨èåˆ—è¡¨æ¸…ç©ºï¼Œå¹¶å±•ç¤ºæœç´¢å†å²&çƒ­é—¨æ¨è

ç»“æ„éƒ¨åˆ†ï¼š

```vue
<template>
  <view class="search">
    <!-- æœç´¢æ¡† -->
    <view class="search-box">
      <u-search v-model="searchValue" @clear="clearSearch"></u-search>
    </view>
    <!-- æœç´¢å»ºè®®åˆ—è¡¨ -->
    <view class="list" v-if="searchResults.length !== 0">
      <view class="item" v-for="(item) in searchResults" :key="item._id" @click="gotoDetail(item)">
        <view class="name">{{item.title}}</view>
        <u-icon name="arrow-right" size="25"></u-icon>
      </view>
    </view>
    <view class="list no-result" v-else-if="searchResults.length === 0 && showResult">
      è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ~
    </view>
    <!-- æœç´¢å†å² -->
    <view class="history-box" v-else-if="historyList.length !== 0 && searchResults.length === 0">
      <view class="history-title">
        <text>æœç´¢å†å²</text>
        <u-icon name="trash" size="32" @click="clearStorage"></u-icon>
      </view>
      <!-- æ ‡ç­¾åˆ—è¡¨åŒºåŸŸ -->
      <view class="history-list">
        <uni-tag :text="item" v-for="(item,i) in historyList" :key="i" @click="quickSearch(item)"></uni-tag>
      </view>
    </view>
    <!-- çƒ­é—¨æ¨è -->
    <view class="history-box" v-if="!showResult">
      <view class="history-title">
        <text>çƒ­é—¨æ¨è</text>
      </view>
      <!-- æ ‡ç­¾åˆ—è¡¨åŒºåŸŸ -->
      <view class="history-list">
        <uni-tag :text="item" v-for="(item,i) in hotList" :key="i" @click="quickSearch(item)"></uni-tag>
      </view>
    </view>
  </view>
</template>
```

æ ·å¼éƒ¨åˆ†ï¼š

```scss
// ...
.list {
  padding: 0 5px;
  .item {
    font-size: 12px;
    padding: 13px 0;
    border-bottom: 1px solid #efefef;
    display: flex;
    align-items: center;
    justify-content: space-between;
    &:last-child {
      border-bottom: none;
    }
    .name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 3px;
    }
  }
  &.no-result {
    text-align: center;
    color: #666;
    font-size: 28rpx;
  }
}
```

methodséƒ¨åˆ†:

```js
// å‘èµ·è¯·æ±‚
async getList () {
  if (this.loading) return
  this.loading = true
  this.showResult = true
  const { data } = await this.$u.api.getList(this.page)
  this.searchResults = [...this.searchResults, ...data]
  this.loading = false
},
// ç‚¹å‡»çƒ­é—¨æ¨èï¼Œå¿«é€Ÿæœç´¢
quickSearch (item) {
  this.searchValue = item
  this.page.title = item
  // æ·»åŠ åˆ°æœç´¢å†å²
  this.addHis(item)
  // å‘é€æœç´¢è¯·æ±‚ -> è¯·æ±‚æ–‡ä»¶åˆ—è¡¨
  this.getList()
},
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æœç´¢æŒ‰é’®äº‹ä»¶ç»‘å®š)æœç´¢æŒ‰é’®äº‹ä»¶ç»‘å®š

```vue
<u-search v-model="searchValue" @clear="clearSearch" @search="search" @custom="search"></u-search>
```

æ·»åŠ å¯¹åº”çš„searchæ–¹æ³•ï¼š

```js
search (value) {
  if (value.trim() === '') {
    uni.showToast({
      icon: 'error',
      title: 'å…³é”®è¯ä¸å¾—ä¸ºç©º',
      duration: 2000
    })
    return
  }
  this.page.title = value
  this.quickSearch(value)
},
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æ•´ä½“ä»£ç )æ•´ä½“ä»£ç 

```vue
<template>
  <view class="search">
    <!-- æœç´¢æ¡† -->
    <view class="search-box">
      <u-search v-model="searchValue" @clear="clearSearch" @search="search" @custom="search"></u-search>
    </view>
    <!-- æœç´¢å»ºè®®åˆ—è¡¨ -->
    <view class="list" v-if="searchResults.length !== 0">
      <view class="item" v-for="(item) in searchResults" :key="item._id" @click="gotoDetail(item)">
        <view class="name">{{item.title}}</view>
        <u-icon name="arrow-right" size="25"></u-icon>
      </view>
    </view>
    <view class="list no-result" v-else-if="searchResults.length === 0 && showResult">
      è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿ~
    </view>
    <!-- æœç´¢å†å² -->
    <view class="history-box" v-else-if="historyList.length !== 0 && searchResults.length === 0">
      <view class="history-title">
        <text>æœç´¢å†å²</text>
        <u-icon name="trash" size="32" @click="clearStorage"></u-icon>
      </view>
      <!-- æ ‡ç­¾åˆ—è¡¨åŒºåŸŸ -->
      <view class="history-list">
        <uni-tag :text="item" v-for="(item,i) in historyList" :key="i" @click="quickSearch(item)"></uni-tag>
      </view>
    </view>
    <!-- çƒ­é—¨æ¨è -->
    <view class="history-box" v-if="!showResult">
      <view class="history-title">
        <text>çƒ­é—¨æ¨è</text>
      </view>
      <!-- æ ‡ç­¾åˆ—è¡¨åŒºåŸŸ -->
      <view class="history-list">
        <uni-tag :text="item" v-for="(item,i) in hotList" :key="i" @click="quickSearch(item)"></uni-tag>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data () {
    return {
      searchValue: '',
      historyList: uni.getStorageSync('historyList') || [],
      hotList: ['å‰ç«¯', 'vue', 'node', 'é¢è¯•', 'react', 'devops', 'flutter', 'MySQL', 'gitlab', 'redis', 'git', 'typescript', 'å‡èŒ', 'Bç«™'],
      page: {
        title: '',
        page: 0,
        limit: 20
      },
      loading: false,
      searchResults: [],
      showResult: false
    }
  },
  methods: {
    search (value) {
      if (value.trim() === '') {
        uni.showToast({
          icon: 'error',
          title: 'å…³é”®è¯ä¸å¾—ä¸ºç©º',
          duration: 2000
        })
        return
      }
      this.page.title = value
      this.quickSearch(value)
    },
    addHis (value) {
      // æ ‡ç­¾å»é‡
      const index = this.historyList.indexOf(value)
      if (index !== -1) {
        this.historyList.splice(index, 1)
      }
      // æœ€è¿‘æœç´¢çš„æ ‡ç­¾ï¼Œæ˜¾ç¤ºåœ¨æœ€å‰ç«¯
      this.historyList.unshift(value)
      // æœ¬åœ°ç¼“å­˜
      uni.setStorageSync('historyList', this.historyList)
    },
    async getList () {
      if (this.loading) return
      this.loading = true
      this.showResult = true
      const { data } = await this.$u.api.getList(this.page)
      this.searchResults = [...this.searchResults, ...data]
      this.loading = false
    },
    // ç‚¹å‡»çƒ­é—¨æ¨èï¼Œå¿«é€Ÿæœç´¢
    quickSearch (item) {
      this.searchValue = item
      this.page.title = item
      // æ·»åŠ åˆ°æœç´¢å†å²
      this.addHis(item)
      // å‘é€æœç´¢è¯·æ±‚ -> è¯·æ±‚æ–‡ä»¶åˆ—è¡¨
      this.getList()
    },
    clearSearch () {
      // å½“ç”¨æˆ·ç‚¹å‡»æœç´¢æ¡†å³ä¾§çš„æ¸…ç©ºæŒ‰é’®çš„é€»è¾‘
      this.showResult = false
      this.searchResults = []
      this.page = {
        title: '',
        page: 0,
        limit: 20
      }
      this.loading = false
    },
    gotoDetail (item) {
      // æ–‡ç« è¯¦æƒ…
      console.log('ğŸš€ ~ file: search.vue ~ line 99 ~ gotoDetail ~ item', item)
    },
    clearStorage () {
      this.historyList = []
      uni.setStorageSync('historyList', [])
    }
  }
}
</script>

<style lang="scss" scoped>
.search {
  padding: 24rpx;
}

.search-box {
  padding-bottom: 50rpx;
}

.history-box {
  padding: 0 10rpx 50rpx;
  .history-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 40px;
    font-size: 16px;
    font-weight: bold;
  }

  .history-list {
    display: flex;
    flex-wrap: wrap;
    ::v-deep .uni-tag {
      margin-top: 5px;
      margin-right: 5px;
      border-radius: 25rpx;
    }
  }
}

.list {
  padding: 0 5px;
  .item {
    font-size: 12px;
    padding: 13px 0;
    border-bottom: 1px solid #efefef;
    display: flex;
    align-items: center;
    justify-content: space-between;
    &:last-child {
      border-bottom: none;
    }
    .name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 3px;
    }
  }
  &.no-result {
    text-align: center;
    color: #666;
    font-size: 28rpx;
  }
}
</style>
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å‘å¸–å…¥å£)å‘å¸–å…¥å£

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#å¸ƒå±€ä¸æ ·å¼-5)å¸ƒå±€ä¸æ ·å¼

åœ¨`home.vue`æ·»åŠ å‘å¸–å…¥å£

```vue
<image class="add-post" src="/static/images/add-post.png" />
```

ä¿®æ”¹`add-post`æ ·å¼

```css
.add-post {
  position: fixed;
  width: 150rpx;
  height: 150rpx;
  bottom: 30rpx;
  right: 10rpx;
  z-index: 999;
}
```

å®Œæˆæ•ˆæœ

![image-20210527004752928](uniapp.assets/image-20210527004752928.affac181.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/02-é¦–é¡µæ¨¡å—.html#æ·»åŠ äº‹ä»¶-3)æ·»åŠ äº‹ä»¶

æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»è·³è½¬å‘å¸–é¡µé¢

```javascript
newContent () {
  uni.navigateTo({
    url: '/subcom-pkg/post/post'
  })
}
```



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#å°ç¨‹åºé‰´æƒç™»å½•)å°ç¨‹åºé‰´æƒç™»å½•

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#éœ€æ±‚åˆ†æ)éœ€æ±‚åˆ†æ

æµç¨‹åˆ†æï¼š

![img](uniapp.assets/api-login.2fcc9f35.2fcc9f35.jpg)

è¯´æ˜ï¼š

* æ—¶åºå›¾çš„é˜…è¯»æ–¹å¼ï¼š
  * ææ¸…æ¥šæœ‰å‡ æ–¹ï¼Œå“ªå‡ ä¸ªé‡è¦çš„äº¤äº’éƒ¨åˆ†ï¼Œæ¯”å¦‚ï¼šä¸Šé¢æœ‰å°ç¨‹åºã€å¼€å‘æœåŠ¡å™¨ã€å°ç¨‹åºå®˜æ–¹åå°ï¼›
  * ä»ä¸Šè‡³ä¸‹ï¼Œä»å·¦è‡³å³ï¼Œè·Ÿéšç®­å¤´çš„æ–¹å‘èµ°ï¼›
  * æ—¶åºå›¾ä¸­ï¼Œä»»ä½•ä¸€ä¸ªæµç¨‹ä¸­æ–­ï¼Œåç»­çš„ç›¸å…³æµç¨‹ä¸ä¼šç»§ç»­è¿›è¡Œï¼›

é€šè¿‡åˆ†æï¼Œæˆ‘ä»¬è·å–ç”¨æˆ·çš„ä¿¡æ¯ç”¨äºåˆ›å»ºç”¨æˆ·ï¼Œå¹¶é€šè¿‡è‡ªå·±çš„æœåŠ¡å™¨è¿”å›ç”¨æˆ·çš„ç™»å½•æ€ï¼Œå³tokenä¿¡æ¯ä¸ç”¨æˆ·ä¿¡æ¯ã€‚

ç”¨æˆ·ä¿¡æ¯éœ€è¦è·¨é¡µé¢è¿›è¡Œå…±äº«ï¼ŒåŒæ—¶ï¼Œä¹Ÿéœ€è¦æŒä¹…åŒ–ï¼Œæ‰€ä»¥æƒ¯æ€§çš„æ€è€ƒåˆ°äº† vuex + æœ¬åœ°ç¼“å­˜çš„æ–¹æ¡ˆã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#vuexé›†æˆuniapp)Vuexé›†æˆuniapp

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#åˆå§‹åŒ–store)åˆå§‹åŒ–store

é‡è¦ï¼šuniappä¸­å†…ç½®vuexï¼Œæ‰€ä»¥ç›´æ¥æŒ‰ç…§vueä¸­ä½¿ç”¨vuexçš„æ­¥éª¤è¿›è¡Œé›†æˆã€‚

åˆ›å»ºæ–‡ä»¶`store/index.js`ï¼š

```js
import Vue from 'vue'
import Vuex from 'vuex'

Vue.use(Vuex);//vueçš„æ’ä»¶æœºåˆ¶

//Vuex.Store æ„é€ å™¨é€‰é¡¹
const store = new Vuex.Store({
    state:{
      //å­˜æ”¾çŠ¶æ€
      // ...
    }
})
export default store
```

åœ¨ `main.js` ä¸­å¯¼å…¥æ–‡ä»¶ï¼š

```js
import Vue from 'vue'
import App from './App'
import store from './store'

// æŠŠ store å¯¹è±¡æä¾›ç»™ â€œstoreâ€ é€‰é¡¹ï¼Œè¿™å¯ä»¥æŠŠ store çš„å®ä¾‹æ³¨å…¥æ‰€æœ‰çš„å­ç»„ä»¶
const app = new Vue({
    store,
    ...App
})
app.$mount()
```

stateä½¿ç”¨ä¸Šçš„åŒºåˆ«ï¼š

* ç›´æ¥åœ¨templateä¸­ä¸èƒ½ä½¿ç”¨`$store`å–å€¼ï¼›
* åœ¨dataä¸­æ— æ³•ä½¿ç”¨`this.$store.state`å–å¯¹åº”çš„åˆå§‹å€¼ï¼›

æ­£ç¡®çš„æ‰“å¼€å§¿åŠ¿ï¼š

* è¾…åŠ©å‡½æ•°ï¼ˆæ¨èï¼‰
* computedæ–¹æ³•

```js
// store.js
const state = {
  count: 0,
  msg: 'hello Vuex'
}


// ç»„ä»¶ä¸­
computed: {
  // æ–¹æ³•ä¸€ï¼šè¾…åŠ©å‡½æ•°
  // ...mapState(['count']),
  // ...mapState({
  //   msg2: (state) => state.msg
  // }),
  // æ–¹æ³•äºŒï¼šcomputed
  count1 () {
    return this.$store.state.count
  },
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#å¦‚ä½•è¿›è¡Œè°ƒè¯•)å¦‚ä½•è¿›è¡Œè°ƒè¯•

```js
import Vue from 'vue'
import Vuex from 'vuex'
import createLogger from 'vuex/dist/logger'

// è·å–æ‰§è¡Œç¯å¢ƒå˜é‡
const debug = process.env.NODE_ENV === 'development'
// console.log('ğŸš€ ~ file: index.js ~ line 5 ~ debug', debug)

Vue.use(Vuex)

const state = {
  count: 0,
  msg: 'hello Vuex'
}

const mutations = {
  // æµ‹è¯•Mutation
  add (state, payload) {
    state.count += payload
  }
}

const actions = {}

const getters = {}

// æ·»åŠ vuexæ—¥å¿—æ’ä»¶
const plugins = debug ? [createLogger()] : []

const store = new Vuex.Store({
  state,
  mutations,
  actions,
  getters,
  plugins
})

export default store
```

å½“æˆ‘ä»¬åœ¨é¡µé¢è§¦å‘mutationçš„æ—¶å€™ï¼š

```js
mounted () {
  this.getList()
  setTimeout(() => {
    this.$store.commit('add', 100)
  }, 2000)
  // console.log(this.$store)
},
```

å³å¯ä»¥æ”¶åˆ°consoleä¸­çš„æ‰“å°æ—¥å¿—ï¼š

![image-20210723135408789](uniapp.assets/image-20210723135408789.c89a35bf.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#å¾®ä¿¡å®˜æ–¹æœåŠ¡ç›¸å…³)å¾®ä¿¡å®˜æ–¹æœåŠ¡ç›¸å…³

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#è·å–appidä¸appsecret)è·å–AppIDä¸AppSecret

ç™»å½•å°ç¨‹åºçš„åå° [https://mp.weixin.qq.com/(opens new window)](https://mp.weixin.qq.com/)

![image-20210724102639423](uniapp.assets/image-20210724102639423.71ad0747.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#unionidä¸openid)unionidä¸openid

* ä»€ä¹ˆæ˜¯unionidï¼Œopenidï¼Ÿ

  openidæ˜¯ç”¨æˆ·åœ¨å½“å‰å°ç¨‹åºçš„å”¯ä¸€æ ‡è¯†ï¼›

  unionidæ˜¯ç”¨æˆ·åœ¨å¼€æ”¾å¹³å°çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè‹¥å½“å‰å°ç¨‹åºå·²ç»‘å®šåˆ°å¾®ä¿¡å¼€æ”¾å¹³å°å¸å·ä¸‹ä¼šè¿”å›ï¼›

* ä¸¤è€…çš„åŒºåˆ«åœ¨å“ªé‡Œï¼Ÿunionidçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

  éƒ½æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œé’ˆå¯¹çš„å¹³å°ä¸ä¸€æ ·ï¼Œopenidé’ˆå¯¹å°ç¨‹åºï¼Œunionidé’ˆå¯¹å¼€æ”¾å¹³å°ï¼›

  å¼€æ”¾å¹³å°æ˜¯æŒ‡ï¼š[https://open.weixin.qq.com/(opens new window)](https://open.weixin.qq.com/)

  å¦‚æœå¼€å‘è€…æ‹¥æœ‰å¤šä¸ªç§»åŠ¨åº”ç”¨ã€ç½‘ç«™åº”ç”¨ã€å’Œå…¬ä¼—å¸å·ï¼ˆåŒ…æ‹¬å°ç¨‹åºï¼‰ï¼Œå¯é€šè¿‡ UnionID æ¥åŒºåˆ†ç”¨æˆ·çš„å”¯ä¸€æ€§ï¼Œå› ä¸ºåªè¦æ˜¯åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°å¸å·ä¸‹çš„ç§»åŠ¨åº”ç”¨ã€ç½‘ç«™åº”ç”¨å’Œå…¬ä¼—å¸å·ï¼ˆåŒ…æ‹¬å°ç¨‹åºï¼‰ï¼Œç”¨æˆ·çš„ UnionID æ˜¯å”¯ä¸€çš„ã€‚

  **æ¢å¥è¯è¯´ï¼ŒåŒä¸€ç”¨æˆ·ï¼Œå¯¹åŒä¸€ä¸ªå¾®ä¿¡å¼€æ”¾å¹³å°ä¸‹çš„ä¸åŒåº”ç”¨ï¼ŒUnionIDæ˜¯ç›¸åŒçš„ã€‚**

  **å¦‚æœæ²¡æœ‰å¾®ä¿¡ä¾§å¤šåº”ç”¨åœºæ™¯ï¼ˆå…¬ä¼—å·ã€å°ç¨‹åºã€ç½‘é¡µäº’é€šçš„éœ€æ±‚ï¼‰ï¼Œå¯ä»¥ä¸ç”¨å¼„è¿™ä¸ªå¼€æ”¾å¹³å°çš„è´¦å·ã€‚**

* unionIDå¦‚ä½•è·å–ï¼Ÿ

  ç»‘å®šäº†å¼€æ”¾å¹³å°å¼€å‘è€…å¸å·çš„å°ç¨‹åºï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹é€”å¾„è·å– UnionIDã€‚

  1. å¼€å‘è€…å¯ä»¥ç›´æ¥é€šè¿‡ [wx.login (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)+ `code2Session` è·å–åˆ°è¯¥ç”¨æˆ· UnionIDï¼Œæ— é¡»ç”¨æˆ·æˆæƒã€‚
  2. å°ç¨‹åºç«¯è°ƒç”¨äº‘å‡½æ•°æ—¶ï¼Œå¯åœ¨äº‘å‡½æ•°ä¸­é€šè¿‡ [Cloud.getWXContext (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/utils/Cloud.getWXContext.html)è·å– UnionIDã€‚

* å¼€æ”¾å¹³å°å¦‚ä½•æ³¨å†Œä¸ä½¿ç”¨ï¼Ÿ

  å¼€æ”¾å¹³å°éœ€è¦åœ¨[å¼€æ”¾å¹³å°åœ°å€ (opens new window)](https://open.weixin.qq.com/)æ³¨å†Œï¼ŒåŒæ—¶éœ€è¦è®¤è¯åæ‰èƒ½ä½¿ç”¨ã€‚

  ![image-20210724102333624](uniapp.assets/image-20210724102333624.d28d20ad.png)

  è®¤è¯è´¹ç”¨300å…ƒï¼ˆxxxxé©¬xè…¾ï¼‰

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#è·å–ç”¨æˆ·opendata)è·å–ç”¨æˆ·OpenData

ç™»å½•å‡­è¯æ ¡éªŒï¼Œé€šè¿‡ [wx.login (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)æ¥å£è·å¾—ä¸´æ—¶ç™»å½•å‡­è¯ code åä¼ åˆ°å¼€å‘è€…æœåŠ¡å™¨è°ƒç”¨æ­¤æ¥å£å®Œæˆç™»å½•æµç¨‹ã€‚æ›´å¤šä½¿ç”¨æ–¹æ³•è¯¦è§ [å°ç¨‹åºç™»å½• (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)ã€‚

```js
// è®°å½•å¾®ä¿¡ç›¸å…³çš„æ¥å£ï¼Œ APIé¡¹ç›® -> å¾®ä¿¡å®˜æ–¹æœåŠ¡å™¨
import axios from 'axios'
import config from '@/config'

const instance = axios.create({
  timeout: 10000
})

export const wxGetOpenData = async (code) => {
  const res = await instance.get(`https://api.weixin.qq.com/sns/jscode2session?appid=${config.AppID}&secret=${config.AppSecret}&js_code=${code}&grant_type=authorization_code`)
  console.log('ğŸš€ ~ file: WxUtils.js ~ line 11 ~ wxGetOpenData ~ res', res)
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#é‰´æƒé¡µé¢æ ·å¼)é‰´æƒé¡µé¢æ ·å¼

```vue
<template>
  <div class="auth">
    <view class="title">
      <image src="/static/images/logo.jpg" mode="aspectFill" />
      <text>toimcæŠ€æœ¯ç¤¾åŒº</text>
    </view>
    <view class="container">
      <u-button type="primary" @click="login" hover-class="none">
        <u-icon name="weixin-fill" size="32" color="#fff"></u-icon>
        <text>å¾®ä¿¡ç™»å½•</text>
      </u-button>
      <u-button plain :custom-style="customStyle" hover-class="none" @click="goto">æ‰‹æœºå·ç™»å½•</u-button>
    </view>
    <view class="forbid" @click="leave">æš‚ä¸ç™»å½•</view>
    <u-toast ref="uToast" />
  </div>
</template>

<script>
import { mapMutations, mapGetters } from 'vuex'
import auth from '@/mixins/auth'

export default {
  components: {},
  data: () => ({
    customStyle: {
      'margin-top': '40rpx',
      'background-color': '#fff',
      color: '#02d199'
    }
  }),
  mixins: [auth],
  computed: {
    ...mapGetters(['isLogin'])
  },
  methods: {
    ...mapMutations(['setIsLogin', 'setWxInfo', 'setToken', 'setUserInfo']),
    goto () {
      uni.navigateTo({
        url: '/subcom-pkg/auth/mobile-login'
      })
    },
    login () {
      // è·å–ç”¨æˆ·ä¿¡æ¯
      // todo
    },
    leave () {
			// todo
      uni.navigateBack()
    }
  },
  watch: {}
}
</script>

<style lang="scss">
.title {
  display: flex;
  flex-flow: column nowrap;
  align-items: center;
  justify-content: center;
  height: 500rpx;
  width: 100vw;
  image {
    width: 168rpx;
    height: 168rpx;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba($color: #000000, $alpha: 0.1);
  }
  text {
    margin-top: 32rpx;
    font-size: 32rpx;
    color: #333;
    font-weight: 500;
  }
}

.container {
  padding: 32rpx;
}

.forbid {
  position: fixed;
  bottom: 60px;
  left: 0;
  width: 100%;
  text-align: center;
  font-size: 28rpx;
  text-decoration: underline;
}
</style>
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#è§£å¯†å¾®ä¿¡æ•°æ®)è§£å¯†å¾®ä¿¡æ•°æ®

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#ç”¨æˆ·ä¿¡æ¯çš„è§£å¯†)ç”¨æˆ·ä¿¡æ¯çš„è§£å¯†

* å°ç¨‹åºè°ƒç”¨`getUserProfile`ï¼Œè·å–ç”¨æˆ·åŠ å¯†æ•°æ® + è¯ä¹¦ï¼Œè¯·æ±‚ç”¨æˆ·åå°ï¼›

* åå°è¿›è¡ŒåŠ å¯†æ•°æ®çš„æ ¡éªŒï¼Œç¡®å®šç”¨æˆ·ä¼ é€’çš„æ•°æ®æ˜¯å¾®ä¿¡ä¾§çš„æ•°æ®ï¼›

  signature = sha1( rawData + session_key )ç®—æ˜¯æ ¡éªŒæˆåŠŸï¼›

* åŠ å¯†æ•°æ®è§£å¯†ï¼Œå‚è€ƒå®˜æ–¹çš„[ä»£ç  (opens new window)](https://res.wx.qq.com/wxdoc/dist/assets/media/aes-sample.eae1f364.zip)ï¼›

å®˜æ–¹è¯´æ˜[é“¾æ¥(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html#åŠ å¯†æ•°æ®è§£å¯†ç®—æ³•)

![img](uniapp.assets/signature.8a30a825.8a30a825.jpg)

ä»£ç ç¤ºä¾‹ï¼š

å¾®ä¿¡è§£å¯†å·¥å…·jsï¼š

```js
import crypto from 'crypto'

function WXBizDataCrypt (appId, sessionKey) {
  this.appId = appId
  this.sessionKey = sessionKey
}

WXBizDataCrypt.prototype.decryptData = function (encryptedData, iv) {
  // base64 decode
  let sessionKey = Buffer.from(this.sessionKey, 'base64')
  encryptedData = Buffer.from(encryptedData, 'base64')
  iv = Buffer.from(iv, 'base64')
  let decoded
  try {
    // è§£å¯†
    let decipher = crypto.createDecipheriv('aes-128-cbc', sessionKey, iv)
    // è®¾ç½®è‡ªåŠ¨ padding ä¸º trueï¼Œåˆ é™¤å¡«å……è¡¥ä½
    decipher.setAutoPadding(true)
    decoded = decipher.update(encryptedData, 'binary', 'utf8')
    decoded += decipher.final('utf8')

    decoded = JSON.parse(decoded)
  } catch (err) {
    throw new Error('Illegal Buffer')
  }

  if (decoded.watermark.appid !== this.appId) {
    throw new Error('Illegal Buffer')
  }

  return decoded
}

export default WXBizDataCrypt
```

å¾®ä¿¡å·¥å…·jsçš„å°è£…ï¼š

```js
// è®°å½•å¾®ä¿¡ç›¸å…³çš„æ¥å£ï¼Œ APIé¡¹ç›® -> å¾®ä¿¡å®˜æ–¹æœåŠ¡å™¨
import axios from 'axios'
import config from '@/config'
import crypto from 'crypto'
import WXBizDataCrypt from './WXBizDataCrypt'

const instance = axios.create({
  timeout: 10000
})

// è·å–session_keyï¼Œopenid ç­‰OpenDataæ•°æ®
export const wxGetOpenData = async (code) => {
  // sessin_key, openid, unoinid
  const res = await instance.get(`https://api.weixin.qq.com/sns/jscode2session?appid=${config.AppID}&secret=${config.AppSecret}&js_code=${code}&grant_type=authorization_code`)
  // console.log('ğŸš€ ~ file: WxUtils.js ~ line 11 ~ wxGetOpenData ~ res', res)
  return res.data
}

// è·å–è§£å¯†ç”¨æˆ·çš„ä¿¡æ¯
export const wxGetUserInfo = async (user, code) => {
  // 1.è·å–ç”¨æˆ·çš„openData -> session_key
  const data = await wxGetOpenData(code)
  const sessionKey = data.session_key
  // 2.ç”¨æˆ·æ•°æ®è¿›è¡Œç­¾åæ ¡éªŒ -> sha1 -> session_key + rawData + signature
  const { rawData, signature, encryptedData, iv } = user
  const sha1 = crypto.createHash('sha1')
  sha1.update(rawData)
  sha1.update(sessionKey)
  if (sha1.digest('hex') !== signature) {
    // æ ¡éªŒå¤±è´¥
    return Promise.reject(
      new Error({
        code: 500,
        msg: 'ç­¾åæ ¡éªŒå¤±è´¥'
      })
    )
  }
  const wxBizDataCrypt = new WXBizDataCrypt(config.AppID, sessionKey)
  // 3.ç”¨æˆ·åŠ å¯†æ•°æ®çš„è§£å¯†
  const userInfo = wxBizDataCrypt.decryptData(encryptedData, iv)
  return { ...userInfo, ...data }
}
```

å°ç¨‹åºä¾§ï¼š

```js
async login () {
  uni.login({
    success: (e) => {
      this.code = e.code
    }
  })
  uni.getUserProfile({
    lang: 'zh_CN',
    desc: 'ç”¨äºå®Œå–„ä¼šå‘˜èµ„æ–™',
    success: async (e) => {
      console.log('ğŸš€ ~ file: auth.vue ~ line 37 ~ test ~ e', e)
      await this.$u.api.wxLogin({
        code: this.code,
        user: e
      })
    },
    fail: (e) => {
      console.log('ğŸš€ ~ file: auth.vue ~ line 40 ~ test ~ e', e)
    }
  })
}
```

éœ€è¦æ³¨æ„çš„ç‚¹ï¼š

* uni.loginä¸éœ€è¦ç”¨æˆ·æ„ŸçŸ¥çš„è§¦å‘ä¸uni.getUserProfileéœ€è¦tapï¼ˆç”¨æˆ·ç‚¹å‡»ï¼‰äº‹ä»¶è§¦å‘ï¼›
* uni.loginä¸uni.getUserProfileå¦‚æœéœ€è¦åŒæ—¶ä½¿ç”¨ï¼Œå¯ä»¥éƒ½ä½¿ç”¨callbackå›è°ƒçš„å½¢å¼æ¥ä½¿ç”¨ï¼›

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#ç”¨æˆ·ç™»å½•å‡­è¯ç»´æŠ¤)ç”¨æˆ·ç™»å½•å‡­è¯ç»´æŠ¤

é˜²æ­¢codeå¤±æ•ˆï¼Œè€Œè¯·æ±‚å¤±è´¥ã€‚

è§£å†³åŠæ³•ï¼šå‰ç«¯è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”<5åˆ†é’Ÿçš„æ—¶é—´ï¼Œè¯·æ±‚ä¸€æ¬¡`uni.login`åˆ·æ–°ç™»å½•å‡­è¯ã€‚

```js
<script>

export default {
  components: {},
  data: () => ({
    code: '',
    ctrl: null
  }),
  computed: {},
  created () {
    this.getNewCode()
    this.setCron()
  },
  onShow () {
    this.getNewCode()
    this.setCron()
  },
  onHide () {
    clearTimeout(this.ctrl)
  },
  // ç”¨æˆ·ç¦»å¼€å½“å‰é¡µé¢
  onUnload () {
    clearTimeout(this.ctrl)
  },
  methods: {
    // è·å–code
    getNewCode () {
      uni.login({
        success: (e) => {
          this.code = e.code
        }
      })
    },
    // è®¾ç½®å®šæ—¶ä»»åŠ¡
    setCron () {
      clearTimeout(this.ctrl)
      // å®šæ—¶åˆ·æ–°codeçš„æ–¹æ³•
      this.ctrl = setTimeout(() => {
        this.getNewCode()
        // é‡æ–°è¿›è¡Œcronï¼Œä¿è¯codeçš„æœ‰æ•ˆæ€§
        this.setCron()
      }, 4 * 60 * 1000)
    },
  },
}
</script>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#ç”¨æˆ·ç™»å½•æ¥å£)ç”¨æˆ·ç™»å½•æ¥å£

**æ¥å£éƒ¨åˆ†:**

äº§ç”Ÿtokenï¼š

```js
// ç”Ÿæˆ token è¿”å›ç»™å®¢æˆ·ç«¯
const generateToken = (payload, expire = '1h') => {
  if (payload) {
    return jwt.sign(
      {
        ...payload,
      },
      config.JWT_SECRET,
      { expiresIn: expire }
    )
  } else {
    throw new Error('ç”Ÿæˆtokenå¤±è´¥ï¼')
  }
}
```

éšæœºç”¨æˆ·åï¼š

```js
const rand = (len = 8) => {
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'
  let text = ''
  for (let i = 0; i < len; i++) {
    text += possible.charAt(Math.floor(Math.random() * possible.length))
  }
  return text
}

const getTempName = () => {
  // è¿”å›ç”¨æˆ·é‚®ç®±
  return 'toimc_' + rand() + '@toimc.com'
}
```

å¾®ä¿¡è§£å¯†ç”¨æˆ·ä¿¡æ¯çš„`wxUtils.js`ï¼š

```js
// è·å–è§£å¯†ç”¨æˆ·çš„ä¿¡æ¯
export const wxGetUserInfo = async (user, code) => {
  // 1.è·å–ç”¨æˆ·çš„openData -> session_key
  const data = await wxGetOpenData(code)
  const { session_key: sessionKey } = data
  if (sessionKey) {
    // 2.ç”¨æˆ·æ•°æ®è¿›è¡Œç­¾åæ ¡éªŒ -> sha1 -> session_key + rawData + signature
    const { rawData, signature, encryptedData, iv } = user
    const sha1 = crypto.createHash('sha1')
    sha1.update(rawData)
    sha1.update(sessionKey)
    if (sha1.digest('hex') !== signature) {
      // æ ¡éªŒå¤±è´¥
      return Promise.reject(
        new Error({
          code: 500,
          msg: 'ç­¾åæ ¡éªŒå¤±è´¥'
        })
      )
    }
    const wxBizDataCrypt = new WXBizDataCrypt(config.AppID, sessionKey)
    // 3.ç”¨æˆ·åŠ å¯†æ•°æ®çš„è§£å¯†
    const userInfo = wxBizDataCrypt.decryptData(encryptedData, iv)
    return { ...userInfo, ...data, errcode: 0 }
  } else {
    // data -> errcodeé0 ï¼Œè¯·æ±‚å¤±è´¥
    return data
  }
}
```

æŸ¥è¯¢å¹¶åˆ›å»ºç”¨æˆ·`User.js`

```js
findOrCreateByUnionid: function (user) {
  return this.findOne({
    unionid: user.unionid
    // openid: user.openid
  }, {
    unionid: 0, password: 0
  }).then(obj => {
    return (
      obj || this.create({
        openid: user.openid,
        unionid: user.unionid,
        username: getTempName(),
        name: user.nickName,
        roles: ['user'],
        gender: user.gender,
        pic: user.avatarUrl,
        location: user.city
      })
    )
  })
},
```

`LoginController.js`å¾®ä¿¡ç™»å½•æ¥å£ï¼š

```js
// å¾®ä¿¡ç™»å½•
async wxLogin (ctx) {
  // 1.è§£å¯†ç”¨æˆ·ä¿¡æ¯
  const { body } = ctx.request
  // console.log('ğŸš€ ~ file: LoginController.js ~ line 223 ~ LoginController ~ wxLogin ~ body', body)
  const { user, code } = body
  if (!code) {
    ctx.body = {
      code: 500,
      data: 'æ²¡æœ‰è¶³å¤Ÿå‚æ•°'
    }
    return
  }
  const res = await wxGetUserInfo(user, code)
  if (res.errcode === 0) {
    // 2.æŸ¥è¯¢æ•°æ®åº“ -> åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    // 3.å¦‚æœä¸å­˜åœ¨ â€”> åˆ›å»ºç”¨æˆ·
    // 4.å¦‚æœå­˜åœ¨ -> è·å–ç”¨æˆ·ä¿¡æ¯
    const tmpUser = await User.findOrCreateByUnionid(res)
    // 5.äº§ç”Ÿtokenï¼Œè·å–ç”¨æˆ·çš„ç­¾åˆ°çŠ¶æ€
    const token = generateToken({ _id: tmpUser._id })
    const userInfo = await addSign(tmpUser)
    ctx.body = {
      code: 200,
      data: userInfo,
      token
    }
  } else {
    ctx.throw(501, res.errcode === 40163 ? 'codeå·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°åé‡è¯•' : 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•')
  }
}
```

è·å–access_tokenï¼Œå¹¶æŒ‰ä¸¤å°æ—¶ç»´æŠ¤ï¼š

```js
export const wxGetAccessToken = async (flag = false) => {
  // https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
  let accessToken = await getValue('accessToken')
  if (!accessToken || flag) {
    try {
      const result = await instance.get(
        `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${config.AppID}&secret=${config.AppSecret}`
      )
      if (result.status === 200) {
        // è¯´æ˜è¯·æ±‚æˆåŠŸ
        await setValue(
          'accessToken',
          result.data.access_token,
          result.data.expires_in
        )
        accessToken = result.data.access_token
        // {"errcode":40013,"errmsg":"invalid appid"}
        if (result.data.errcode && result.data.errmsg) {
          logger.error(
            `Wx-GetAccessToken Error: ${result.data.errcode} - ${result.data.errmsg}`
          )
        }
      }
    } catch (error) {
      logger.error(`GetAccessToken Error: ${error.message}`)
    }
  }
  return accessToken
}
```

ç»´æŠ¤`access_token`æ•°æ®ï¼š

```js
import { CronJob } from 'cron'
import { wxGetAccessToken } from './WxUtils'

const job = new CronJob('* 55 */1 * * *', () => {
  wxGetAccessToken()
})

job.start()
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#æ‰‹æœºç™»å½•)æ‰‹æœºç™»å½•

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#ä¸šåŠ¡æµç¨‹å›¾)ä¸šåŠ¡æµç¨‹å›¾

* è·å–æ‰‹æœºå· -> å‘é€çŸ­ä¿¡éªŒè¯ç é¡µé¢

![img](uniapp.assets/image-20210730163452597.76d98020.png)

* è¾“å…¥éªŒè¯ç  -> æ‰‹æœºå·ç™»å½•é¡µé¢

![img](uniapp.assets/image-20210730163719652.14834a3e.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#å¦‚ä½•é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†)å¦‚ä½•é€‰æ‹©çŸ­ä¿¡æœåŠ¡å•†

æ¨èè…¾è®¯äº‘ã€é˜¿é‡Œäº‘ï¼Œä¸‹é¢ä»¥è…¾è®¯äº‘ä¸ºç¤ºä¾‹ï¼š

![image-20210726203051548](uniapp.assets/image-20210726203051548.4d7929a2.png)

åŸºæœ¬çš„ä½¿ç”¨æ­¥éª¤ï¼š

1. åˆ›å»ºäº‘å¹³å°è´¦å· -> å®å -> æ¨èå…¬å¸å®å
2. å¤Ÿä¹°çŸ­ä¿¡åŒ… -> æ·»åŠ çŸ­ä¿¡æ¨¡æ¿
3. é›†æˆSDKå‘é€çŸ­ä¿¡

è…¾è®¯äº‘çš„ä¸¤ç§é›†æˆæ–¹å¼ï¼š

1. qcloudsms_jsï¼Œå‚è€ƒ[githubä»“åº“(opens new window)](https://github.com/qcloudsms/qcloudsms_js)
2. Tencentcloud-sdk-nodejsï¼Œå‚è€ƒ[å®˜æ–¹æ–‡æ¡£(opens new window)](https://cloud.tencent.com/document/product/382/43197)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#ç™»å½•é¡µé¢æ ·å¼)ç™»å½•é¡µé¢æ ·å¼

`auth/mobile-login.vue`é¡µé¢

```vue
<template>
  <view class="wrapper">
    <view class="title">ç™»å½•æ³¨å†Œæ›´ç²¾å½©</view>
    <view class="info">æœªæ³¨å†Œçš„æ‰‹æœºå·éªŒè¯åè‡ªåŠ¨åˆ›å»ºè´¦å·</view>
    <view class="form">
      <u-form label-width="120">
        <u-form-item label="æ‰‹æœºå·">
          <u-input v-model="mobile" placeholder="è¯·è¾“å…¥æ‰‹æœºå·"></u-input>
          <template v-slot:right>
            <u-button type="primary" shape="circle" size="mini" hover-class="none">è·å–æ‰‹æœºå·</u-button>
          </template>
        </u-form-item>
      </u-form>
      <view class="btn" :class="{'deactive': !/^1[3-9]\d{9}$/.test(mobile)}">
        <u-button type="primary" hover-class="none" @click="getCode">è·å–éªŒè¯ç </u-button>
      </view>
    </view>
    <navigator open-type="navigateBack" hover-class="none">
      <view class="footer u-flex u-col-center u-row-center">
        <u-icon name="weixin-circle-fill" size="120" color="#1BB723"></u-icon>
        <text>å¾®ä¿¡ç™»å½•</text>
      </view>
    </navigator>
  </view>
</template>

<script>
import auth from '@/mixins/auth'
export default {
  mixins: [auth],
  data: () => ({
    mobile: '',
    phoneNumber: '',
    loading: false
  }),
  methods: {
    async getCode () {
      // å‘é€çŸ­ä¿¡éªŒè¯ç 
    },
  }
}
</script>

<style lang="scss" scoped>
.wrapper {
  padding: 32rpx;
  .title {
    color: #333;
    font-size: 48rpx;
    font-weight: bold;
    padding-top: 50rpx;
  }
  .info {
    color: #666;
    line-height: 28rpx;
    padding-top: 24rpx;
  }
  .form {
    padding-top: 40rpx;
  }
  ::v-deep .btn {
    padding-top: 80rpx;
    &.deactive {
      .u-btn--primary {
        background-color: #ccc;
      }
    }
  }
}
.footer {
  position: absolute;
  bottom: 120rpx;
  width: 100vw;
  left: 0;
  text-align: center;
  flex-direction: column;
  text {
    color: #666;
    font-size: 28rpx;
    padding-top: 14rpx;
  }
}
</style>
```

`mobile-code.vue`é¡µé¢ï¼š

```vue
<template>
  <view class="wrapper">
    <view class="title">è¾“å…¥éªŒè¯ç </view>
    <view class="info">éªŒè¯ç å·²å‘é€è‡³ {{mobile.substr(0,3)}}****{{mobile.substr(7,10)}} </view>
    <view class="inputs">
      <u-message-input :maxlength="6" mode="bottomLine" active-color="#02d199" inactive-color="#DDD" width="90" :bold="false" :breathe="false" :focus="true"></u-message-input>
    </view>
    <view class="resend" :class="{'disabled': sending}" @click="resend()">{{msg}}</view>
  </view>
</template>

<script>
import { mapMutations } from 'vuex'
export default {
  data: () => ({
    mobile: '',
    count: 60,
    ctrl: null,
    sending: false
  }),
  onLoad (options) {
    // console.log('ğŸš€ ~ file: mobile-code.vue ~ line 15 ~ onLoad ~ options', options)
    this.mobile = options.mobile
    this.setCron()
  },
  methods: {
    ...mapMutations(['setToken', 'setUserInfo']),
    setCron () {
      clearInterval(this.ctrl)
      this.sending = true
      this.ctrl = setInterval(() => {
        this.count--
        if (this.count === 0) {
          this.count = 60
          this.sending = false
          clearInterval(this.ctrl)
        }
      }, 1000)
    },
    async resend () {
      if (this.sending) return
      const res = await this.$u.api.sendCode({
        phone: this.mobile
      })
      // console.log('ğŸš€ ~ file: mobile-code.vue ~ line 75 ~ resend ~ res', res)
      this.setCron()
    }
  },
  computed: {
    msg () {
      let str = 'é‡æ–°è·å–'
      if (this.sending) {
        str += ('(' + (this.count + '').padStart(2, '0') + 's)')
      }
      return str
    }
  }
}
</script>

<style lang="scss" scoped>
.wrapper {
  padding: 32rpx;
  .title {
    color: #333;
    font-size: 48rpx;
    font-weight: bold;
    padding-top: 50rpx;
  }
  .info {
    color: #666;
    line-height: 28rpx;
    padding-top: 24rpx;
  }
  .inputs {
    padding: 60rpx 0 40rpx;
  }
  .resend {
    font-size: 26rpx;
    font-weight: 300;
    color: #02d199;
    &.disabled {
      color: #ddd;
    }
  }
}
</style>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#å°ç¨‹åºè·å–æ‰‹æœºå·)å°ç¨‹åºè·å–æ‰‹æœºå·

å°ç¨‹åºä¾§é€»è¾‘ï¼š

è®¾ç½®open-typeä¸º`getPhoneNumber`ï¼š

```js
<u-button type="primary" shape="circle" size="mini" hover-class="none" open-type="getPhoneNumber" @getphonenumber="getPhoneNumber">è·å–æ‰‹æœºå·</u-button>
```

getPhoneNumberæ–¹æ³•ï¼š

```js
async getPhoneNumber (value) {
  const { encryptedData, iv } = value.detail
  // value.detail + code
  const { code, data } = await this.$u.api.getMobile({
    code: this.code,
    encryptedData,
    iv
  })
  if (code === 200) {
    const { phoneNumber, purePhoneNumber, countryCode } = data
    if (countryCode !== '86') {
      uni.showToast({
        title: 'Please use a cell phone number from mainland China',
        duration: 2000
      })
      return
    }
    this.phoneNumber = phoneNumber
    this.mobile = purePhoneNumber
  } else {
    uni.showToast({
      icon: 'error',
      title: 'è·å–æ‰‹æœºå·å¤±è´¥ï¼Œè¯·é‡è¯•',
      duration: 2000
    })
  }
  // console.log('ğŸš€ ~ file: mobile-login.vue ~ line 48 ~ getPhoneNumber ~ res', res)
}
```

APIæ¥å£è§£å¯†æ•°æ®ï¼š

è®¾ç½®è·¯ç”±ï¼š

```js
router.post('/getMobile', loginController.getMobile)
```

è·å–æ‰‹æœºå·`LoginController.js`ï¼š

```js
// è·å–ç”¨æˆ·æ‰‹æœºå·
async getMobile (ctx) {
  const { body } = ctx.request
  const { code, encryptedData, iv } = body
  if (!code) {
    ctx.body = {
      code: 500,
      data: 'æ²¡æœ‰è¶³å¤Ÿå‚æ•°'
    }
    return
  }
  const { session_key: sessionKey } = await wxGetOpenData(code)
  const wxBizDataCrypt = new WXBizDataCrypt(config.AppID, sessionKey)
  // 3.ç”¨æˆ·åŠ å¯†æ•°æ®çš„è§£å¯†
  const data = wxBizDataCrypt.decryptData(encryptedData, iv)
  // console.log('ğŸš€ ~ file: LoginController.js ~ line 274 ~ LoginController ~ getMobile ~ data', data)
  ctx.body = {
    code: 200,
    data,
    msg: 'è·å–æ‰‹æœºå·æˆåŠŸ'
  }
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#å‰åç«¯é€»è¾‘-è”è°ƒ)å‰åç«¯é€»è¾‘&è”è°ƒ

å¸¸è§é—®é¢˜ï¼š

* å‚æ•°ä¼ é€’å¼‚å¸¸ï¼š

  ![image-20210730161557953](uniapp.assets/image-20210730161557953.500dcdbf.png)

  è§£å†³åŠæ³•ï¼šç¡®ä¿å‰åç«¯ä¼ é€’çš„å‚æ•°çš„æ­£ç¡®æ€§ï¼Œæ¯”å¦‚ï¼Œç»Ÿä¸€å‚æ•°åç§°ï¼Œç»Ÿä¸€è¯·æ±‚methodsã€‚

* çŸ­ä¿¡æœåŠ¡å•†çš„é—®é¢˜

  ![image-20210730161718446](uniapp.assets/image-20210730161718446.59b97977.png)

  è§£å†³åŠæ³•ï¼š1. ä½™é¢ä¸è¶³å³å……å€¼ï¼›2. ä¼ å‚éæ³•ï¼Œä¿®æ”¹å‚æ•°ï¼›3. ç­¾åæˆ–è€…æ¨¡æ¿é—®é¢˜ï¼Œä¿®æ”¹å¯¹åº”çš„æ¨¡æ¿å‚æ•°åå†è¿›è¡Œå‘é€ã€‚

* éœ€è¦åˆ é™¤å·²ç»ä½¿ç”¨è¿‡çš„çŸ­ä¿¡éªŒè¯ç æ•°æ®ï¼›

* å¦‚æœç»™ç”¨æˆ·å·²ç»å‘é€ä¸€æ¬¡çŸ­ä¿¡éªŒè¯ç ï¼Œåˆ™ä¸å†ç›¸åŒçš„æ—¶é—´é—´éš”å†…ï¼Œå†ç»™ç”¨æˆ·å‘é€ï¼Œé™åˆ¶ç”¨æˆ·å‘é€çŸ­ä¿¡çš„é¢‘æ¬¡ï¼›

å°ç¨‹åºä¾§æ¥å£ï¼š

```js
// è·å–ç”¨æˆ·æ‰‹æœºå·
const getMobile = (data) => axios.post('/login/getMobile', data)

// å‘é€çŸ­ä¿¡
const sendCode = params => axios.get('/public/sendCode', params)
```

å®Œæˆçš„æ‰‹æœºå‘é€éªŒè¯ç é¡µé¢

```vue
<template>
  <view class="wrapper">
    <view class="title">ç™»å½•æ³¨å†Œæ›´ç²¾å½©</view>
    <view class="info">æœªæ³¨å†Œçš„æ‰‹æœºå·éªŒè¯åè‡ªåŠ¨åˆ›å»ºè´¦å·</view>
    <view class="form">
      <u-form label-width="120">
        <u-form-item label="æ‰‹æœºå·">
          <u-input v-model="mobile" placeholder="è¯·è¾“å…¥æ‰‹æœºå·"></u-input>
          <template v-slot:right>
            <u-button type="primary" shape="circle" size="mini" hover-class="none" open-type="getPhoneNumber" @getphonenumber="getPhoneNumber">è·å–æ‰‹æœºå·</u-button>
          </template>
        </u-form-item>
      </u-form>
      <view class="btn" :class="{'deactive': !/^1[3-9]\d{9}$/.test(mobile)}">
        <u-button type="primary" hover-class="none" @click="getCode">è·å–éªŒè¯ç </u-button>
      </view>
    </view>
    <navigator open-type="navigateBack" hover-class="none">
      <view class="footer u-flex u-col-center u-row-center">
        <u-icon name="weixin-circle-fill" size="120" color="#1BB723"></u-icon>
        <text>å¾®ä¿¡ç™»å½•</text>
      </view>
    </navigator>
  </view>
</template>

<script>
import auth from '@/mixins/auth'
export default {
  mixins: [auth],
  data: () => ({
    mobile: '',
    phoneNumber: '',
    loading: false
  }),
  methods: {
    async getCode () {
      // å‘é€çŸ­ä¿¡éªŒè¯ç 
      // é˜²æ­¢ç”¨æˆ·é¢‘ç¹å‘é€
      if (this.loading) return
      this.loading = true
      try {
        const res = await this.$u.api.sendCode({
          mobile: this.mobile
        })
        this.loading = false
        if (res.code === 200) {
        // æç¤ºç”¨æˆ·
          uni.showToast({
            icon: 'none',
            title: 'å‘é€æˆåŠŸ',
            duration: 2000
          })
          // å»¶è¿Ÿè·³è½¬åˆ°è¾“å…¥éªŒè¯ç çš„é¡µé¢
          setTimeout(() => {
            uni.navigateTo({
              url: '/subcom-pkg/auth/mobile-code?mobile=' + this.mobile
            })
          }, 2000)
        } else {
          uni.showToast({
            icon: 'error',
            title: 'çŸ­ä¿¡å‘é€å¤±è´¥',
            duration: 2000
          })
        }
      } catch (error) {
        this.loading = false
      }
    },
    async getPhoneNumber (value) {
      const { encryptedData, iv } = value.detail
      // value.detail + code
      const { code, data } = await this.$u.api.getMobile({
        code: this.code,
        encryptedData,
        iv
      })
      if (code === 200) {
        const { phoneNumber, purePhoneNumber, countryCode } = data
        if (countryCode !== '86') {
          uni.showToast({
            title: 'Please use a cell phone number from mainland China',
            duration: 2000
          })
          return
        }
        this.phoneNumber = phoneNumber
        this.mobile = purePhoneNumber
      } else {
        uni.showToast({
          icon: 'error',
          title: 'è·å–æ‰‹æœºå·å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        })
      }
    }
  }
}
</script>

<style lang="scss" scoped>
.wrapper {
  padding: 32rpx;
  .title {
    color: #333;
    font-size: 48rpx;
    font-weight: bold;
    padding-top: 50rpx;
  }
  .info {
    color: #666;
    line-height: 28rpx;
    padding-top: 24rpx;
  }
  .form {
    padding-top: 40rpx;
  }
  ::v-deep .btn {
    padding-top: 80rpx;
    &.deactive {
      .u-btn--primary {
        background-color: #ccc;
      }
    }
  }
}
.footer {
  position: absolute;
  bottom: 120rpx;
  width: 100vw;
  left: 0;
  text-align: center;
  flex-direction: column;
  text {
    color: #666;
    font-size: 28rpx;
    padding-top: 14rpx;
  }
}
</style>
```

æ ¡éªŒéªŒè¯ç çš„é¡µé¢ï¼š

```vue
<template>
  <view class="wrapper">
    <view class="title">è¾“å…¥éªŒè¯ç </view>
    <view class="info">éªŒè¯ç å·²å‘é€è‡³ {{mobile.substr(0,3)}}****{{mobile.substr(7,10)}} </view>
    <view class="inputs">
      <u-message-input :maxlength="6" mode="bottomLine" active-color="#02d199" inactive-color="#DDD" width="90" :bold="false" :breathe="false" :focus="true" @change="change"></u-message-input>
    </view>
    <view class="resend" :class="{'disabled': sending}" @click="resend()">{{msg}}</view>
  </view>
</template>

<script>
import { mapMutations } from 'vuex'
export default {
  data: () => ({
    mobile: '',
    count: 60,
    ctrl: null,
    sending: false
  }),
  onLoad (options) {
    this.mobile = options.mobile
    this.setCron()
  },
  methods: {
    ...mapMutations(['setToken', 'setUserInfo']),
    setCron () {
      clearInterval(this.ctrl)
      this.sending = true
      this.ctrl = setInterval(() => {
        this.count--
        if (this.count === 0) {
          this.count = 60
          this.sending = false
          clearInterval(this.ctrl)
        }
      }, 1000)
    },
    async change (val) {
      if (/\d{6}/.test(val)) {
        const res = await this.$u.api.loginByPhone({
          mobile: this.mobile,
          code: val
        })
        if (res.code === 200) {
          uni.showToast({
            icon: 'none',
            title: 'ç™»å½•æˆåŠŸï¼Œ2såè·³è½¬',
            duration: 2000
          })
          const { token, data } = res
          this.setToken(token)
          this.setUserInfo(data)
          setTimeout(() => {
            uni.navigateBack({
              delta: 3
            })
          }, 2000)
        } else {
          uni.showToast({
            icon: 'none',
            title: res.msg,
            duration: 2000
          })
        }
      }
    },
    async resend () {
      if (this.sending) return
      const res = await this.$u.api.sendCode({
        mobile: this.mobile
      })
      if (res.code === 200) {
        this.setCron()
      } else {
        uni.showToast({
          icon: 'none',
          title: res.msg || 'çŸ­ä¿¡å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
          duration: 2000
        })
      }
    }
  },
  computed: {
    msg () {
      let str = 'é‡æ–°è·å–'
      if (this.sending) {
        str += ('(' + (this.count + '').padStart(2, '0') + 's)')
      }
      return str
    }
  }
}
</script>

<style lang="scss" scoped>
.wrapper {
  padding: 32rpx;
  .title {
    color: #333;
    font-size: 48rpx;
    font-weight: bold;
    padding-top: 50rpx;
  }
  .info {
    color: #666;
    line-height: 28rpx;
    padding-top: 24rpx;
  }
  .inputs {
    padding: 60rpx 0 40rpx;
  }
  .resend {
    font-size: 26rpx;
    font-weight: 300;
    color: #02d199;
    &.disabled {
      color: #ddd;
    }
  }
}
</style>
```

åç«¯æ¥å£`LoginController.js`ï¼š

```js
// æ‰‹æœºå·ç™»å½•
async loginByPhone (ctx) {
  const { body } = ctx.request
  // mobile + code
  const { mobile, code } = body
  // éªŒè¯æ‰‹æœºå·ä¸çŸ­ä¿¡éªŒè¯ç çš„æ­£ç¡®æ€§
  const sms = await getValue(mobile)
  if (sms && sms === code) {
    await delValue(mobile)
    // æŸ¥è¯¢å¹¶åˆ›å»ºç”¨æˆ·
    const user = await User.findOrCreateByMobile({
      mobile
    })
    // æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦ç­¾åˆ°
    const userObj = await addSign(user)
    // å“åº”ç”¨æˆ·
    ctx.body = {
      code: 200,
      token: generateToken({ _id: userObj._id }),
      data: userObj
    }
  } else {
    ctx.body = {
      code: 500,
      msg: 'æ‰‹æœºå·ä¸éªŒè¯ç ä¸åŒ¹é…'
    }
  }
}
```

æŸ¥è¯¢å¹¶åˆ›å»ºæ‰‹æœºç”¨æˆ·`User.js`

```js
findOrCreateByMobile: function (user) {
  return this.findOne({ mobile: user.mobile }, {
    unionid: 0, password: 0
  }).then(res => {
    return res || this.create({
      mobile: user.mobile,
      username: getTempName(),
      name: getTempName(),
      roles: ['user']
    })
  })
},
```

å‘é€éªŒè¯ç é€»è¾‘`PublicController.js`ï¼š

```js
// å‘é€æ‰‹æœºéªŒè¯ç 
async sendCode (ctx) {
  // 1.è·å–æ‰‹æœºå· phone
  const { mobile } = ctx.query
  // 2.æŸ¥è¯¢redis -> åˆ¤æ–­æ˜¯å¦éªŒè¯ç è¿‡æœŸ
  if (await getValue(mobile)) {
    ctx.body = {
      code: 501,
      msg: 'çŸ­ä¿¡æ­£åœ¨å‘é€ä¸­ï¼Œè¯·å‹¿é‡æ–°å‘é€'
    }
    return
  }
  // 3.äº§ç”Ÿéšæœºçš„6ä½æ•°å­—
  const sms = String(Math.random()).slice(-6)
  // 4.å‘é€çŸ­ä¿¡ -> è®¾ç½®redis -> sms, expire -> key:phone
  const res = await sendSms(mobile, sms)
  if (res.result === 0) {
    setValue(mobile, sms, 10 * 60)
    // 5.å“åº”
    ctx.body = {
      code: 200,
      msg: 'å‘é€æˆåŠŸ',
      data: res
    }
  } else {
    ctx.throw(500, 'å‘é€çŸ­ä¿¡å¤±è´¥' + res.errmsg || '')
  }
}
```

éœ€è¦æ³¨æ„çš„ç‚¹ï¼š

* çŸ­ä¿¡å‘é€å¤±è´¥æ—¶ï¼š
  * é™åˆ¶ç”¨æˆ·é¢‘ç¹å‘é€-> ä¸å½±å“é‡å‘ï¼›
  * ç”¨æˆ·æç¤º -> çŸ­ä¿¡å¤±è´¥åŸå›  -> è¿™é‡Œå¤§éƒ¨åˆ†æ˜¯ç¬¬ä¸‰æ–¹æœåŠ¡å•†çš„é”™è¯¯æç¤ºï¼Œæ‰€ä»¥éœ€è¦ä¸“é—¨è¿›è¡Œå¤„ç†ï¼›
  * çŸ­ä¿¡é™åˆ¶å‘é€æœºåˆ¶è®¾è®¡ï¼šä¸è®©æˆåŠŸå‘é€çŸ­ä¿¡ä¹‹åï¼Œè¿˜è®©ç”¨æˆ·é‡å¤å‘é€ -> redisè®°å½•çŸ­ä¿¡æ•°æ®ï¼›
* æ‰‹æœºç™»å½•æ¥å£ï¼š
  * å‘é€æˆåŠŸçŸ­ä¿¡åˆ™å“åº”ï¼Œå¹¶è®¾ç½®redisï¼Œå¦åˆ™ç›´æ¥throwé”™è¯¯ï¼›
  * åˆ›å»ºç”¨æˆ·éœ€è¦ä½¿ç”¨findOneæ¥è¿›è¡ŒæŸ¥é‡ï¼›
  * æ¥å£å‚æ•°éœ€è¦ä¸å‰ç«¯è¿›è¡Œä¸€ä¸€å¯¹åº”ï¼Œæœ€å¥½ä½¿ç”¨æ–‡æ¡£è¿›è¡Œçº¦å®šï¼›

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/03-ç™»å½•é‰´æƒ.html#ç»Ÿä¸€çš„ç”¨æˆ·æˆæƒç™»å½•)ç»Ÿä¸€çš„ç”¨æˆ·æˆæƒç™»å½•

ç”¨æˆ·æˆæƒç™»å½•æ˜¯ç»å¸¸éœ€è¦ä½¿ç”¨çš„åŠŸèƒ½ï¼Œå°è£…åˆ°`common/checkAuth.js`ä¸­ï¼š

* éœ€è¦åˆ¤æ–­å°ç¨‹åºç”¨æˆ·çš„ç™»å½•çŠ¶æ€æ˜¯å¦å¤±æ•ˆ - ä½¿ç”¨å°ç¨‹åºAPI `checkSession`
* ç”¨æˆ·ç™»å½•å¤±æ•ˆï¼Œç»™ç”¨æˆ·ä¸€ä¸ªConfirmæç¤ºæ¡†ï¼Œè®©ç”¨æˆ·é€‰æ‹©æ˜¯å¦è¿›è¡Œè·³è½¬ç™»å½•

```js
import store from '@/store'

export const checkSession = async () => {
  try {
    await uni.checkSession()
    return true
  } catch (error) {
    return false
  }
}

export const checkToken = async () => {
  let flag = true
  const token = uni.getStorageSync('token')
  const checked = await checkSession()
  if (!store.state.token || !token || !checked) {
    flag = false
    uni.showModal({
      title: 'æ‚¨æœªç™»å½•',
      content: 'éœ€è¦ç™»å½•æ‰èƒ½æ“ä½œï¼Œç¡®å®šç™»å½•å—ï¼Ÿ',
      success: function (res) {
        if (res.confirm) {
          uni.navigateTo({
            url: '/subcom-pkg/auth/auth'
          })
        }
      }
    })
  }
  return flag
}
```



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#æ¶ˆæ¯-çƒ­é—¨-ä¸ªäººä¸­å¿ƒ)æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ

æ¶ˆæ¯ã€çƒ­é—¨ã€ä¸ªäººä¸­å¿ƒè¿™ä¸‰å—çš„å†…å®¹é‡ç‚¹ï¼š

* çµæ´»ä½¿ç”¨UIæ¡†æ¶ï¼šuviewå†…ç½®æ ·å¼çš„ç»¼åˆä½¿ç”¨ï¼›
* ç»Ÿä¸€é‰´æƒè·³è½¬æç¤ºï¼šç”¨æˆ·ç™»å½•ä¸æœªç™»å½•çŠ¶æ€ä¸‹ï¼Œé¡µé¢è·³è½¬é€»è¾‘ï¼›
* ç†Ÿæ‚‰å‰åç«¯å¼€å‘æµç¨‹ï¼šä»å‰åˆ°åçš„å¼€å‘é€»è¾‘ï¼Œæ’æŸ¥é—®é¢˜ä»æºå¤´å¼€å§‹æ‰¾é—®é¢˜ï¼›
* å®Œå–„ç™»å½•å¤±æ•ˆï¼Œæ¥å£é‰´æƒå¤±è´¥401çš„é¡µé¢è·³è½¬é€»è¾‘ï¼›

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#æ¶ˆæ¯æ¨¡å—)æ¶ˆæ¯æ¨¡å—

æœ€ç»ˆ å®Œæˆæ•ˆæœï¼š

![img](uniapp.assets/image-20210527025158228.2c02523b.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#é¡µé¢å¸ƒå±€å’Œæ ·å¼)é¡µé¢å¸ƒå±€å’Œæ ·å¼

* æ·»åŠ  tabs åˆ‡æ¢ï¼Œå¹¶è®¾ç½®å¸é¡¶

```vue
<template>
  <view class="msg">
    <view class="msg" v-if="isLogin">
      <u-sticky>
        <view class="tabs box-shadow">
          <!-- tabs -->
          <u-tabs :list="tabs" :name="'value'" :is-scroll="false" active-color="#02D199" inactive-color="#666" height="88" @change="tabsChange" :current="current"></u-tabs>
        </view>
      <u-sticky>
      <view>
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <!-- ç‚¹èµåˆ—è¡¨ -->
      </view>
    </view>
    <view class="info u-flex u-row-center u-col-center flex-column" v-else>
      <view class="center">
        ç™»å½•è¿‡åæŸ¥çœ‹è¯„è®º&ç‚¹èµæ¶ˆæ¯
      </view>
      <u-button type="primary" hover-class="none">å»ç™»å½•</u-button>
    </view>
    <view class="bottom-line"></view>
  </view>
</template>

<script>
export default {
  props: {},
  data: () => ({
    current: 0,
    tabs: [
      {
        key: 'comments',
        value: 'è¯„è®º'
      },
      {
        key: 'like',
        value: 'ç‚¹èµ'
      }
    ],
  }),
  methods: {
    tabsChange (i) {
      this.current = i
      this.$store.commit('setType', i === 0 ? 'comment' : 'hands')
      this.checkType()
    },
	}
}
</script>

<style lang="scss" scoped>
.flex-column {
  flex-flow: column nowrap;
}

.info {
  flex-flow: column nowrap;
  height: 100vh;
  width: 100vw;
  .center {
    color: #666;
    font-size: 32rpx;
    line-height: 50px;
  }
}
</style>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#è‡ªå®šä¹‰å¸é¡¶ç»„ä»¶)è‡ªå®šä¹‰å¸é¡¶ç»„ä»¶

å¸é¡¶æ•ˆæœæœ€å…³é”®çš„å±æ€§ï¼š

```text
.t-sticky {
  position: sticky;
  top: 0;
}
```

å¯ä»¥è‡ªè¡Œåˆ›å»º`components/t-sticky/t-sticky.vue`ç»„ä»¶ï¼š

```vue
<template>
  <view class="t-sticky" :style="{'top': top + 'px'}">
    <slot></slot>
  </view>
</template>

<script>

export default {
  props: {
    top: {
      default: 0,
      type: Number
    }
  },
  data: () => ({})
}
</script>

<style lang="scss" scoped>
.t-sticky {
  position: sticky;
  // top: 0;
}
</style>
```

ä½¿ç”¨æ–¹æ³•ï¼š

```text
<t-sticky :top="è·ç¦»é¡¶éƒ¨çš„å€¼">
  // ... ç»„ä»¶ 
</t-sticky>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#æ¶ˆæ¯æ¨¡å—çš„æ ·å¼)æ¶ˆæ¯æ¨¡å—çš„æ ·å¼

```vue
<template>
  <view class="msg">
    <view class="msg" v-if="isLogin">
      <u-sticky>
        <view class="tabs box-shadow">
          <!-- tabs -->
          <u-tabs :list="tabs" :name="'value'" :is-scroll="false" active-color="#02D199" inactive-color="#666" height="88" @change="tabsChange" :current="current"></u-tabs>
        </view>
      </u-sticky>
      <view>
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view v-if="current === 0">
          <view v-for="(item, index) in comments" :key="index">
            <view class="box">
              <!-- è¯„è®ºç”¨æˆ·å¡ç‰‡ -->
              <view class="user u-flex">
                <u-image class="phone" :src="item.cuid.pic" width="72" height="72" shape="circle" error-icon="/static/images/header.jpg"></u-image>
                <view class="user-column u-flex-1 u-flex flex-column u-col-top">
                  <text class="name">{{ item.cuid.name }}</text>
                  <text class="label">{{ item.created | moment }} å›å¤äº†ä½ </text>
                </view>
                <view class="reply u-flex u-row-center">
                  <image src="/static/images/advice.png" mode="aspectFit" />
                  å›å¤
                </view>
              </view>
              <!-- è¯„è®ºå†…å®¹ -->
              <view class="comment">{{ item.content }}</view>
              <view class="post">
                <view>
                  <!-- å°é¢å›¾ -->
                  <view v-if="item.tid.shotpic">
                    <view class="img">
                      <u-image :src="item.tid.shotpic" width="192" height="122"></u-image>
                    </view>
                  </view>
                  <!-- æ–‡ç« æ ‡é¢˜ + æ‘˜è¦ -->
                  <view class="post-content u-flex flex-column u-col-top">
                    <text class="title">{{ item.tid.title }}</text>
                    <text class="content">{{ item.tid.content }}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
        <!-- ç‚¹èµåˆ—è¡¨ -->
        <view v-else>
          <view v-for="(item, index) in handUsers" :key="index">
            <view class="box">
              <view class="user u-flex">
                <u-image class="pic" :src="item.huid.pic" width="72" height="72" shape="circle" error-icon="/static/images/header.jpg" />
                <view class="user-column u-flex-1 u-flex flex-column u-col-top">
                  <span class="name">{{ item.huid.name }}</span>
                  <span class="label">{{ item.created | moment }}</span>
                </view>
              </view>
            </view>
            <view class="comment">èµäº†ä½ çš„è¯„è®º {{item.cid.content}}</view>
          </view>
        </view>
      </view>
    </view>
    <view class="info u-flex u-row-center u-col-center flex-column" v-else>
      <view class="center">
        ç™»å½•è¿‡åæŸ¥çœ‹è¯„è®º&ç‚¹èµæ¶ˆæ¯
      </view>
      <u-button type="primary" hover-class="none" @click="navTo">å»ç™»å½•</u-button>
    </view>
    <view class="bottom-line"></view>
  </view>
</template>

<script>
import { mapGetters } from 'vuex'
import { checkAuth } from '@/common/checkAuth'
export default {
  props: {},
  data: () => ({
    current: 0,
    tabs: [
      {
        key: 'comments',
        value: 'è¯„è®º'
      },
      {
        key: 'like',
        value: 'ç‚¹èµ'
      }
    ],
    comments: [
    ],
    handUsers: [
    ],
    pageMsg: {
      page: 0,
      limit: 10
    },
    pageHands: {
      page: 0,
      limit: 10
    }
  }),
  computed: {
    ...mapGetters(['isLogin'])
  },
  methods: {
    navTo () {
      uni.navigateTo({
        url: '/subcom-pkg/auth/auth'
      })
    },
    tabsChange (i) {
      this.current = i
      this.$store.commit('setType', i === 0 ? 'comment' : 'hands')
      this.checkType()
    },
    async getMsg () {
      const { data, code } = await this.$u.api.getMsg(this.pageMsg)
      if (code === 200) {
        this.comments = data
      }
    },
    async getHands () {
      const { data, code } = await this.$u.api.getHands(this.pageHands)
      if (code === 200) {
        this.handUsers = data
      }
    },
    async checkType () {
      if (!this.isLogin) return
      const flag = await checkAuth()
      if (!flag) {
        return
      }
      if (this.$store.state.type === 'hands') {
        // è¿™é‡Œè‚¯å®šå·²ç»ç™»å½•
        this.current = 1
        this.getHands()
      } else {
        this.current = 0
        this.getMsg()
      }
    }
  },
  watch: {},
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢æ˜¾ç¤º(not-nvue)
  onShow () {
    this.checkType()
  },
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢éšè—
  onHide () {
    this.current = 0
  }
}
</script>

<style lang="scss" scoped>
.flex-column {
  flex-flow: column nowrap;
}

.info {
  flex-flow: column nowrap;
  height: 100vh;
  width: 100vw;
  .center {
    color: #666;
    font-size: 32rpx;
    line-height: 50px;
  }
}
.user {
  margin: 20rpx;
  .name {
    margin-block: 20rpx;
    margin-bottom: 10rpx;
    font-size: 28rpx;
    font-weight: bold;
    color: rgba(51, 51, 51, 1);
  }
  .phone {
    width: 72rpx;
    height: 72rpx;
    border-radius: 50%;
  }
  .user-column {
    margin-left: 20rpx;
  }
  .label {
    font-size: 22rpx;
    font-weight: 500;
    color: rgba(153, 153, 153, 1);
  }
}

.reply {
  color: rgba(153, 153, 153, 1);
  margin-right: 40rpx;
  font-size: 24rpx;
  font-weight: 500;
  line-height: 40rpx;
  image {
    width: 30rpx;
    height: 30rpx;
    margin-right: 10rpx;
  }
}

.comment {
  margin: 0 20rpx 20rpx;
}

.post {
  margin: 0 20rpx 20rpx;
  padding: 20rpx;
  background-color: #f3f3f3;
  border-radius: 15rpx;
  .title {
    margin-bottom: 10rpx;
    font-size: 26rpx;
    font-weight: bold;
    color: rgba(51, 51, 51, 1);
    display: -webkit-box;
    -webkit-line-clamp: 1; /*è¿™ä¸ªæ•°å­—æ˜¯è®¾ç½®è¦æ˜¾ç¤ºçœç•¥å·çš„è¡Œæ•°*/
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .content {
    font-size: 24rpx;
    font-weight: 400;
    color: rgba(102, 102, 102, 1);
    line-height: 30rpx;
    display: -webkit-box;
    -webkit-line-clamp: 2; /*è¿™ä¸ªæ•°å­—æ˜¯è®¾ç½®è¦æ˜¾ç¤ºçœç•¥å·çš„è¡Œæ•°*/
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
}
</style>
```

å‰ç«¯æ¥å£`api/modules/user.js`ï¼š

```text
// è·å–ç‚¹èµæ•°æ®
const getHands = params => axios.get('/user/getHands', params)

// è·å–ç”¨æˆ·æœªè¯»æ¶ˆæ¯
const getMsg = (data) => axios.get('/user/getmsg', data)
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#æ¥å£å¯¹æ¥ä¸è”è°ƒ)æ¥å£å¯¹æ¥ä¸è”è°ƒ

è°ƒæ•´`src/model/CommentsHands.js`

```js
import mongoose from '../config/DBHelpler'

const Schema = mongoose.Schema

const CommentsSchema = new Schema({
  cid: { type: String, ref: 'comments' }, // è¯„è®ºid
  huid: { type: String, ref: 'users' }, // è¢«ç‚¹èµç”¨æˆ·çš„id
  uid: { type: String, ref: 'users' }, // ç‚¹èµç”¨æˆ·id
  created: { type: Date }
})

CommentsSchema.pre('save', function (next) {
  this.created = new Date()
  next()
})

CommentsSchema.post('save', function (error, doc, next) {
  if (error.name === 'MongoError' && error.code === 11000) {
    next(new Error('There was a duplicate key error'))
  } else {
    next(error)
  }
})

CommentsSchema.statics = {
  findByCid: function (id) {
    return this.find({ cid: id })
  },
  getHandsByUid: function (id, page, limit) {
    return this.find({ uid: id })
      .populate({
        path: 'huid',
        select: '_id name pic'
      })
      .populate({
        path: 'cid',
        select: '_id content'
      })
      .skip(page * limit)
      .limit(limit)
      .sort({ created: -1 })
  }
}

const CommentsHands = mongoose.model('comments_hands', CommentsSchema)

export default CommentsHands
```

è·å–å†å²æ¶ˆæ¯`src/api/UserController.js`ï¼š

```js
  // è·å–å†å²æ¶ˆæ¯
  // è®°å½•è¯„è®ºä¹‹åï¼Œç»™ä½œè€…å‘é€æ¶ˆæ¯
  async getHands (ctx) {
    const params = ctx.query
    const page = params.page ? params.page : 0
    const limit = params.limit ? parseInt(params.limit) : 0
    // æ–¹æ³•ä¸€ï¼š åµŒå¥—æŸ¥è¯¢ -> aggregate
    // æ–¹æ³•äºŒï¼š é€šè¿‡å†—ä½™æ¢æ—¶é—´
    const obj = await getJWTPayload(ctx.header.authorization)
    const result = await CommentsHands.getHandsByUid(obj._id, page, limit)

    ctx.body = {
      code: 200,
      data: result
    }
  }
```

å®Œæˆæ•ˆæœï¼ˆç‚¹èµï¼‰ï¼š

![image-20210527031025147](uniapp.assets/image-20210527031025147.cad808cc.png)

å®Œæˆæ•ˆæœï¼ˆè¯„è®ºï¼‰ï¼š

![image-20210527030947602](uniapp.assets/image-20210527030947602.6589bfe7.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#çƒ­é—¨æ¨¡å—)çƒ­é—¨æ¨¡å—

è¿™ä¸ªéƒ¨åˆ†åˆ©æ—§æ¥å£ï¼Œæ‰€ä»¥åªç”¨å¼€å‘å‰ç«¯é¡µé¢å³å¯ï¼š

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#é¡µé¢å¸ƒå±€å’Œæ ·å¼-2)é¡µé¢å¸ƒå±€å’Œæ ·å¼

```vue
<template>
  <view>
    <u-sticky>
      <view class="tabs box-shadow">
        <u-tabs :list="tabs" :name="'value'" :current="current" @change="tabsChange" :is-scroll="false" active-color="#02D199" inactive-color="#666" height="88"></u-tabs>
      </view>
    </u-sticky>
    <view class="content">
      <view class="tags">
        <uni-tag :text="item.value" v-for="(item, i) in types[tabs[current].key]" :class="{ active: tagCur === i }" :key="i" @click="tagsChange(i)"></uni-tag>
      </view>
      <HotPostList :lists="lists" v-if="tabs[current].key === 'posts'" @click="postDetail"></HotPostList>
      <HotCommentsList :lists="lists" :type="types.comments[tagCur].key" v-else-if="tabs[current].key === 'comments'" @click="commentDetail"></HotCommentsList>
      <HotSignList :lists="lists" :type="types.sign[tagCur].key" v-else></HotSignList>
    </view>
    <view class="bottom-line"></view>
  </view>
</template>

<script>
import HotPostList from './components/HotPostList'
import HotCommentsList from './components/HotCommentsList'
import HotSignList from './components/HotSignList'

export default {
  components: {
    HotPostList,
    HotCommentsList,
    HotSignList
  },
  data: () => ({
    tabs: [
      {
        key: 'posts',
        value: 'çƒ­é—¨å¸–å­'
      },
      {
        key: 'comments',
        value: 'çƒ­é—¨è¯„è®º'
      },
      {
        key: 'sign',
        value: 'ç­¾åˆ°æ’è¡Œ'
      }
    ],
    types: {
      posts: [
        {
          key: '3',
          value: 'å…¨éƒ¨'
        },
        {
          key: '0',
          value: '3æ—¥å†…'
        },
        {
          key: '1',
          value: '7æ—¥å†…'
        },
        {
          key: '2',
          value: '30æ—¥å†…'
        }
      ],
      comments: [
        {
          key: '1',
          value: 'æœ€æ–°è¯„è®º'
        },
        {
          key: '0',
          value: 'çƒ­é—¨è¯„è®º'
        }
      ],
      sign: [
        {
          key: '0',
          value: 'æ€»ç­¾åˆ°æ¦œ'
        },
        {
          key: '1',
          value: 'ä»Šæ—¥ç­¾åˆ°æ¦œ'
        }
      ]
    },
    current: 0,
    tagCur: 0,
    lists: [
    ],
    page: {
      page: 0,
      limit: 50
    }
  }),
  onLoad (options) {
    const { scene } = options
    if (scene) {
      this.tabsChange(scene)
    } else {
      this.getHotPost()
    }
  },
  onShow () {
    this.hanldeChange()
  },
  methods: {
    async getHotPost () {
      const { data } = await this.$u.api.getHotPost({
        ...this.page,
        index: this.types.posts[this.tagCur].key
      })
      this.lists = data
    },
    async getHotComments () {
      const { data } = await this.$u.api.getHotComments({
        ...this.page,
        index: this.types.comments[this.tagCur].key
      })
      this.lists = data
    },
    async getHotSignRecord () {
      const { data } = await this.$u.api.getHotSignRecord({
        ...this.page,
        index: this.types.sign[this.tagCur].key
      })
      this.lists = data
    },
    tabsChange (value) {
      this.current = value
      this.tagCur = 0
      this.page = {
        page: 0,
        limit: 50
      }
      this.hanldeChange()
    },
    tagsChange (value) {
      this.tagCur = value
      this.page = {
        page: 0,
        limit: 50
      }
      this.hanldeChange()
    },
    hanldeChange () {
      if (this.current === 0) {
        // çƒ­é—¨å¸–å­
        this.getHotPost()
      } else if (this.current === 1) {
        // çƒ­é—¨è¯„è®º
        this.getHotComments()
      } else {
        // ç­¾åˆ°æ’è¡Œ
        this.getHotSignRecord()
      }
    },
    // è·³è½¬æ–‡ç« è¯¦æƒ…
    postDetail (item) {
      uni.navigateTo({
        url: '/subcom-pkg/detail/detail?tid=' + item._id
      })
    },
    // è¯„è®ºè¯¦æƒ…
    commentDetail (item) {
      uni.navigateTo({
        url: `/subcom-pkg/detail/detail?tid=${item.tid}&cid=${item._id}`
      })
    }
  },
  async onPullDownRefresh () {
    this.hanldeChange()
    uni.stopPullDownRefresh()
  },
  // é¡µé¢å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸Šæ‹‰è§¦åº•
  onReachBottom () {}
  // é¡µé¢å¤„ç†å‡½æ•°--ç›‘å¬é¡µé¢æ»šåŠ¨(not-nvue)
  /* onPageScroll(event) {}, */
  // é¡µé¢å¤„ç†å‡½æ•°--ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
  /* onShareAppMessage(options) {}, */
}
</script>

<style lang="scss" scoped>
.tags {
  display: flex;
  padding: 20rpx 25rpx;
  width: 100vw;
  background-color: #fff;
  z-index: 200;
  ::v-deep .uni-tag {
    // margin-top: 20rpx;
    margin-right: 25rpx;
    border-radius: 25rpx;
    text {
      color: #999;
      white-space: nowrap;
      font-size: 26rpx;
    }
  }
  .active {
    ::v-deep .uni-tag {
      background-color: #d6f8ef;
      text {
        color: #02d199;
        font-weight: bold;
      }
    }
  }
}

::v-deep .list {
  z-index: 100;
  padding: 0 30rpx 60rpx 30rpx;
  .list-item {
    display: flex;
    flex-flow: row nowrap;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
  }
  .num {
    font-size: 36rpx;
    font-weight: bold;
    &.first {
      color: #ed745e;
    }
    &.second {
      color: #e08435;
    }
    &.third {
      color: #f1ae37;
    }
    &.common {
      color: #999;
    }
  }
  .user {
    width: 90rpx;
    height: 90rpx;
    border-radius: 50%;
    margin-left: 20rpx;
  }
  .column {
    flex: 1;
    display: flex;
    flex-flow: column nowrap;
    justify-content: space-between;
    height: 186rpx;
    padding: 30rpx 24rpx;

    &.no-between {
      justify-content: center;
      .title {
        padding-bottom: 16rpx;
      }
    }
    .title {
      color: #333;
      font-size: 32rpx;
      font-weight: bold;
    }
    .read {
      font-size: 26rpx;
      color: #999;
      text {
        color: #333;
        font-weight: bold;
        padding-right: 10rpx;
      }
    }
  }
  .img {
    width: 200rpx;
    height: 125rpx;
    border-radius: 12rpx;
    overflow: hidden;
    img {
      width: 100%;
      height: 100%;
    }
  }
}
</style>
```

è‡ªå®šä¹‰ä¸‰ä¸ªç»„ä»¶ï¼Œçƒ­é—¨å¸–å­`HotPostList.vue`ï¼š

```vue
<template>
  <view>
    <view class="list" v-for="(item,index) in lists" :key="index">
      <view class="list-item" @click="gotoDetail(item)">
        <view class="num first" v-if="index === 0">01</view>
        <view class="num second" v-else-if="index === 1">02</view>
        <view class="num third" v-else-if="index === 2">03</view>
        <view class="num common" v-else-if="index < 9">{{ '0' + (index+1) }}</view>
        <view class="num common" v-else-if="index < 50 && index >=9">{{ index+1 }}</view>
        <view class="num" v-else></view>
        <view class="column">
          <view class="title">{{item.title}}</view>
          <view class="read">{{parseInt(item.answer) > 1000?parseInt(item.answer/1000).toFixed(1) + 'k': item.answer}} è¯„è®º</view>
        </view>
        <view class="img" v-if="item.shotpic">
          <image :src="item.shotpic" mode="aspectFill" />
        </view>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  props: {
    lists: {
      type: Array,
      default: () => []
    }
  },
  methods: {
    gotoDetail (item) {
      this.$emit('click', item)
    }
  }
}
</script>

<style lang="scss" scoped>
</style>
```

çƒ­é—¨è¯„è®º`HotCommentsList.vue`ï¼š

```vue
<template>
  <view>
    <view class="list" v-for="(item,index) in lists" :key="index">
      <!-- è¯„è®º -->
      <view class="list-item" @click="gotoDetail(item)">
        <view class="num first" v-if="index === 0">01</view>
        <view class="num second" v-else-if="index === 1">02</view>
        <view class="num third" v-else-if="index === 2">03</view>
        <view class="num common" v-else-if="index < 9">{{ '0' + (index+1) }}</view>
        <view class="num common" v-else-if="index < 50 && index >=9">{{ index+1 }}</view>
        <view class="num" v-else></view>
        <u-image width="88" height="88" class="user" :src="item.cuid? item.cuid.pic : ''" mode="aspectFit" shape="circle" error-icon="/static/images/header.jpg" />
        <view class="column no-between">
          <view class="title">{{item.cuid && item.cuid.name? item.cuid.name : 'imooc'}}</view>
          <view class="read" v-if="parseInt(type) === 0">
            <text>{{item.count}}</text> æ¡è¯„è®º
          </view>
          <view class="read" v-else>{{item.created | moment}} å‘è¡¨äº†è¯„è®º</view>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  props: {
    lists: {
      type: Array,
      default: () => []
    },
    type: {
      type: [Number, String],
      default: 0
    }
  },
  methods: {
    gotoDetail (item) {
      this.$emit('click', item)
    }
  }
}
</script>

<style lang="scss" scoped>
</style>
```

ç­¾åˆ°æ’è¡Œ`HotSignList.vue`ï¼š

```vue
<template>
  <view>
    <view class="list" v-for="(item, index) in lists" :key="index">
      <!-- ç­¾åˆ° -->
      <view
        class="list-item"
        v-if="item.count && item.count > 0"
        @click="gotoDetail(item)"
      >
        <view class="num first" v-if="index === 0">01</view>
        <view class="num second" v-else-if="index === 1">02</view>
        <view class="num third" v-else-if="index === 2">03</view>
        <view class="num common" v-else-if="index < 9">{{
          '0' + (index + 1)
        }}</view>
        <view class="num common" v-else-if="index < 50 && index >= 9">{{
          index + 1
        }}</view>
        <view class="num" v-else></view>
        <u-image
          width="88"
          height="88"
          class="user"
          :src="parseInt(type) === 0 ? item.pic : item.uid.pic"
          mode="aspectFit"
          shape="circle"
          error-icon="/static/images/header.jpg"
        />
        <view class="column no-between">
          <view class="title">{{
            (item.uid ? item.uid.name : item.name) || 'imooc'
          }}</view>
          <view class="read" v-if="parseInt(type) === 0">
            å·²ç»è¿ç»­ç­¾åˆ°
            <span>{{ item.count }}</span> å¤©
          </view>
          <view class="read" v-else>{{ item.created | hours }}</view>
        </view>
      </view>
      <view class="list-item" v-else>
        <view class="num first" v-if="index === 0">01</view>
        <view class="num second" v-else-if="index === 1">02</view>
        <view class="num third" v-else-if="index === 2">03</view>
        <view class="num common" v-else-if="index < 9">{{
          '0' + (index + 1)
        }}</view>
        <view class="num common" v-else-if="index < 50 && index >= 9">{{
          index + 1
        }}</view>
        <view class="num" v-else></view>
        <u-image
          width="88"
          height="88"
          class="user"
          :src="parseInt(type) === 0 ? item.pic : item.uid.pic"
          mode="aspectFit"
          shape="circle"
          error-icon="/static/images/header.jpg"
        />
        <view class="column no-between">
          <view class="title">{{ item.uid ? item.uid.name : 'imooc' }}</view>
          <view class="read">
            ä»Šæ—¥ç­¾åˆ°æ—¶é—´<span class="text">{{ item.created | hours }}</span>
          </view>
          <!-- <view class="read" v-else>{{item.created | hours}}</view> -->
        </view>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  props: {
    lists: {
      type: Array,
      default: () => []
    },
    type: {
      type: [Number, String],
      default: 0
    }
  },
  methods: {
    gotoDetail (item) {
      this.$emit('click', item)
    }
  }
}
</script>

<style lang="scss" scoped>
.text {
  padding-left: 15rpx;
}
</style>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#æ¥å£å¯¹æ¥ä¸è”è°ƒ-2)æ¥å£å¯¹æ¥ä¸è”è°ƒ

`PublicController.js`æ–‡ä»¶ï¼š

```js
  async getHotPost (ctx) {
    // page limit
    // type index 0-3æ—¥å†…ï¼Œ 1-7æ—¥å†…ï¼Œ 2-30æ—¥å†…ï¼Œ 3-å…¨éƒ¨
    const params = ctx.query
    const page = params.page ? parseInt(params.page) : 0
    const limit = params.limit ? parseInt(params.limit) : 10
    const index = params.index ? params.index : '0'
    let startTime = ''
    let endTime = ''
    if (index === '0') {
      startTime = moment().subtract(2, 'day').format('YYYY-MM-DD 00:00:00')
    } else if (index === '1') {
      startTime = moment().subtract(6, 'day').format('YYYY-MM-DD 00:00:00')
    } else if (index === '2') {
      startTime = moment().subtract(29, 'day').format('YYYY-MM-DD 00:00:00')
    }
    endTime = moment().add(1, 'day').format('YYYY-MM-DD 00:00:00')
    const result = await Post.getHotPost(page, limit, startTime, endTime)
    const total = await Post.getHotPostCount(page, limit, startTime, endTime)
    ctx.body = {
      code: 200,
      total,
      data: result,
      msg: 'è·å–çƒ­é—¨æ–‡ç« æˆåŠŸ'
    }
  }

  async getHotComments (ctx) {
    // 0-çƒ­é—¨è¯„è®ºï¼Œ1-æœ€æ–°è¯„è®º
    const params = ctx.query
    const page = params.page ? parseInt(params.page) : 0
    const limit = params.limit ? parseInt(params.limit) : 10
    const index = params.index ? params.index : '0'
    const result = await Comments.getHotComments(page, limit, index)
    const total = await Comments.getHotCommentsCount(index)
    ctx.body = {
      code: 200,
      data: result,
      total,
      msg: 'è·å–çƒ­é—¨è¯„è®ºæˆåŠŸ'
    }
  }

  async getHotSignRecord (ctx) {
    // 0-æ€»ç­¾åˆ°æ¦œï¼Œ1-æœ€æ–°ç­¾åˆ°
    const params = ctx.query
    const page = params.page ? parseInt(params.page) : 0
    const limit = params.limit ? parseInt(params.limit) : 10
    const index = params.index ? params.index : '0'
    let result
    let total = 0
    if (index === '0') {
      // æ€»ç­¾åˆ°æ¦œ
      result = await User.getTotalSign(page, limit)
      total = await User.getTotalSignCount()
    } else if (index === '1') {
      // ä»Šæ—¥ç­¾åˆ°
      result = await SignRecord.getTopSign(page, limit)
      total = await SignRecord.getTopSignCount()
    } else if (index === '2') {
      // æœ€æ–°ç­¾åˆ°
      result = await SignRecord.getLatestSign(page, limit)
      total = await SignRecord.getSignCount()
    }
    ctx.body = {
      code: 200,
      data: result,
      total,
      msg: 'è·å–ç­¾åˆ°æ’è¡ŒæˆåŠŸ'
    }
  }
```

å®Œæˆæ•ˆæœï¼ˆçƒ­é—¨å¸–å­ï¼‰ï¼š

![image-20210527032522285](uniapp.assets/image-20210527032522285.4590bccc.png)

å®Œæˆæ•ˆæœï¼ˆçƒ­é—¨è¯„è®ºï¼‰ï¼š

![image-20210527032608703](uniapp.assets/image-20210527032608703.890cffa2.png)

å®Œæˆæ•ˆæœï¼ˆç­¾åˆ°æ’è¡Œï¼‰ï¼š

![image-20210527032652755](uniapp.assets/image-20210527032652755.931b7a09.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#ä¸ªäººä¸­å¿ƒæ¨¡å—)ä¸ªäººä¸­å¿ƒæ¨¡å—

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#é¡µé¢å¸ƒå±€å’Œæ ·å¼-3)é¡µé¢å¸ƒå±€å’Œæ ·å¼

æ•´ä½“çš„é¡µé¢åˆ†ä¸ºï¼š

* èƒŒæ™¯
* ä¸ªäººä¿¡æ¯ + ç»Ÿè®¡ä¿¡æ¯
* åŠŸèƒ½åŒº
* å¿«é€Ÿè·³è½¬åŒº

```vue
<template>
  <view>
    <view class="grey">
      <view class="bg"></view>
      <view class="wrapper">
        <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
        <view class="profile">
          <view class="info">
            <u-image class="pic" :src="isLogin ? userInfo.pic: ''" width="120" height="120" shape="circle" error-icon="/static/images/header.jpg" />
            <!-- ç”¨æˆ·æ˜µç§° + VIP -->
            <view class="user" @click="navTo">
              <view class="name">{{isLogin ?userInfo.name : 'è¯·ç™»å½•'}}</view>
              <view class="fav">
                <!-- <van-icon name="fav2" class-prefix="iconfont" size="14"></van-icon> -->
                ç§¯åˆ†ï¼š{{userInfo && userInfo.favs ? userInfo.favs:0}}
              </view>
            </view>
            <view class="link" @click="gotoGuard('/sub-pkg/user-info/user-info')">ä¸ªäººä¸»é¡µ ></view>
          </view>
          <!-- ç»Ÿè®¡ä¿¡æ¯ -->
          <view class="stats" v-if="isLogin">
            <view class="item">
              <navigator :url="'/sub-pkg/posts/posts?uid=' + uid + '&type=p'">
                <view>{{ countMyPost }}</view>
                <view class="title">æˆ‘çš„å¸–å­</view>
              </navigator>
            </view>
            <view class="item">
              <navigator :url="'/sub-pkg/posts/posts?uid=' + uid+ '&type=c'">
                <view>{{ countMyCollect }}</view>
                <view class="title">æ”¶è—å¤¹</view>
              </navigator>
            </view>
            <view class="item">
              <navigator :url="'/sub-pkg/posts/posts?uid=' + uid+ '&type=h'">
                <view>{{ countMyHistory }}</view>
                <view class="title">æœ€è¿‘æµè§ˆ</view>
              </navigator>
            </view>
          </view>
        </view>
      </view>
      <!-- åŠŸèƒ½åŒº -->
      <view class="center-wraper">
        <view class="center-list first">
          <li v-for="(item,index) in lists" :key="index">
            <view @click="gotoGuardHandler(item)">
              <i :class="item.icon"></i>
              <span>{{item.name}}</span>
            </view>
          </li>
        </view>
        <!-- é¦–é¡µ -> åˆ†ç±»æ ‡ç­¾ å¿«é€Ÿè·³è½¬ -->
        <view class="center-list">
          <li v-for="(item,index) in routes" :key="index" @click="gotoHome(item.tab)">
            <i :class="item.icon"></i>
            <span>{{item.name}}</span>
          </li>
        </view>
      </view>
    </view>
    <view class="bottom-line"></view>
  </view>
</template>

<script>
import { gotoGuard } from '@/common/checkAuth'
import { mapGetters, mapState, mapMutations } from 'vuex'
export default {
  data: () => ({
    lists: [
      {
        name: 'æˆ‘çš„å¸–å­',
        icon: 'icon-teizi',
        routeName: '/sub-pkg/posts/posts'
      },
      {
        name: 'ä¿®æ”¹è®¾ç½®',
        icon: 'icon-setting',
        routeName: '/sub-pkg/settings/settings'
      },
      {
        name: 'ç­¾åˆ°ä¸­å¿ƒ',
        icon: 'icon-qiandao',
        routeName: '/sub-pkg/sign/sign'
      },
      {
        name: 'ç”µå­ä¹¦',
        icon: 'icon-book',
        routeName: '/sub-pkg/books/books'
      },
      {
        name: 'å…³äºæˆ‘ä»¬',
        icon: 'icon-about',
        routeName: '/sub-pkg/about/about'
      },
      {
        name: 'äººå·¥å®¢æœ',
        icon: 'icon-support',
        routeName: '/sub-pkg/suggest/suggest'
      },
      {
        name: 'æ„è§åé¦ˆ',
        icon: 'icon-lock2',
        routeName: '/sub-pkg/suggest/survey'
      }
    ],
    routes: [
      {
        name: 'æé—®',
        icon: 'icon-question',
        tab: 'ask'
      },
      {
        name: 'åˆ†äº«',
        icon: 'icon-share',
        tab: 'share'
      },
      {
        name: 'è®¨è®º',
        icon: 'icon-taolun',
        tab: 'discuss'
      },
      {
        name: 'å»ºè®®',
        icon: 'icon-advise',
        tab: 'advise'
      }
    ],
    countMyPost: 0,
    countMyCollect: 0,
    countMyHistory: 0
    // isLogin: true
  }),
  computed: {
    ...mapGetters(['isLogin']),
    ...mapState(['userInfo']),
    uid () {
      return this.userInfo._id
    }
  },
  onShow () {
  },
  methods: {
    ...mapMutations(['setUserInfo']),
    gotoGuard,
    gotoGuardHandler (item) {
      const { name, routeName } = item
      if (name === 'æˆ‘çš„å¸–å­') {
        gotoGuard(routeName + `?uid=${this.uid}&type=p`)
      } else {
        gotoGuard(routeName)
      }
    },
    gotoHome (tab) {
      uni.switchTab({
        url: '/pages/home/home'
      })
    },
    navTo () {
      if (!this.isLogin) {
        uni.navigateTo({
          url: '/subcom-pkg/auth/auth'
        })
      }
    },

  }

}
</script>

<style lang="scss">
.grey {
  position: fixed;
  width: 100%;
  height: 100%;
  left: 0;
  top: 0;
  z-index: 30;
}
a {
  color: #666;
  text-decoration: none;
}
.bg {
  background-image: url("/static/images/my_bg.png");
  background-repeat: no-repeat;
  background-size: contain;
  position: relative;
  left: 0;
  top: 0;
  width: 100%;
  height: 280rpx;
  background-position: 0 0;
  z-index: 100;
}
.wrapper {
  width: 100%;
  height: 370rpx;
  padding: 25rpx;
  position: absolute;
  left: 0;
  top: 0;
  z-index: 100;
  box-sizing: border-box;
  color: #333;
  .profile {
    background: #fff;
    border-radius: 12rpx;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 100%;
    height: 100%;
    padding: 30rpx;
    box-sizing: border-box;
    .name {
      font-size: 36rpx;
      font-weight: 700;
      margin-bottom: 10rpx;
      margin-top: 0;
      width: 370rpx;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .link {
      font-size: 24rpx;
      color: #999;
    }
    .fav {
      display: inline-block;
      padding: 8px 12rpx;
      background: rgba(2, 209, 153, 0.16);
      border-radius: 12rpx;
      color: #02d199;
      margin: 0;
      font-size: 22rpx;
      .icon-fav {
        padding-right: 10rpx;
      }
    }
    .info,
    .stats {
      display: flex;
      flex-flow: row nowrap;
      justify-content: space-between;
      align-items: center;
    }
    .info {
      margin-bottom: 24rpx;
    }
    .stats {
      justify-content: space-around;
    }
    .user {
      flex: 1;
      padding-left: 20rpx;
    }
    .pic {
      width: 120rpx;
      height: 120rpx;
      border-radius: 50%;
    }
    .item {
      text-align: center;
      position: relative;
      p {
        margin-top: 14rpx;
        margin-bottom: 0;
      }
      &:after {
        width: 2rpx;
        height: 80rpx;
        background: #ddd;
        content: "";
        position: absolute;
        right: -60rpx;
        top: 20rpx;
      }
      &:last-child {
        &:after {
          width: 0;
        }
      }
      .title {
        color: #666;
      }
    }
  }
}
.center-wraper {
  background: #f6f5f8;
  position: relative;
  width: 100%;
  // height: 100%;
  z-index: 10;
  .center-list {
    background: #fff;
    margin-bottom: 30rpx;
    display: flex;
    flex-flow: wrap;
    padding-top: 40rpx;
    &.first {
      padding-top: 100rpx;
    }
    li {
      width: 25%;
      text-align: center;
      color: #666;
      margin-bottom: 40rpx;
      font-size: 26rpx;
    }
    i {
      display: block;
      margin: 0 auto;
      font-size: 40rpx;
      width: 56rpx;
      height: 56rpx;
      margin-bottom: 20rpx;
      color: #888;
      background-size: contain;
    }
    .icon-teizi {
      background-image: url("/static/images/teizi@2x.png");
    }
    .icon-setting {
      background-image: url("/static/images/setting@2x.png");
    }
    .icon-lock2 {
      background-image: url("/static/images/lock2@2x.png");
    }
    .icon-support {
      background-image: url("/static/images/support.png");
    }
    .icon-qiandao {
      background-image: url("/static/images/sign1.png");
    }
    .icon-book {
      background-image: url("/static/images/books.png");
    }
    .icon-record {
      background-image: url("/static/images/record@2x.png");
    }
    .icon-about {
      background-image: url("/static/images/about.png");
    }
    // å¿«æ·è®¿é—®
    .icon-question {
      background-image: url("/static/images/question@2x.png");
    }
    .icon-share {
      background-image: url("/static/images/share@2x.png");
    }
    .icon-taolun {
      background-image: url("/static/images/taolun@2x.png");
    }
    .icon-advise {
      background-image: url("/static/images/advice@2x.png");
    }
  }
}
</style>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#æœ€è¿‘æµè§ˆåŠŸèƒ½)æœ€è¿‘æµè§ˆåŠŸèƒ½

åˆ›å»º`PostHistory`æ¨¡å‹ï¼š

```js
import mongoose from '../config/DBHelpler'

const Schema = mongoose.Schema

const PostHistorySchema = new Schema(
  {
    uid: { type: String, ref: 'user', required: true },
    tid: { type: String, ref: 'post', required: true }
  },
  { timestamps: { createdAt: 'created', updatedAt: 'updated' } }
)

PostHistorySchema.statics = {
  queryCount (options) {
    return this.find(options).countDocuments()
  },
  addOrUpdate (uid, tid) {
    // å¢åŠ æµè§ˆè®°å½•ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°æµè§ˆæ—¶é—´
    return this.findOne({ uid, tid }).exec((err, doc) => {
      if (err) {
        console.log(err)
      }
      if (doc) {
        doc.created = new Date()
        doc.save()
      } else {
        this.create({ uid, tid })
      }
    })
  },
  delOne (uid, tid) {
    return this.deleteOne({ uid, tid })
  },
  getListByUid (uid, skip, limit) {
    // è·å–ç”¨æˆ·çš„æµè§ˆè®°å½•
    return this.find({ uid })
      .populate({
        path: 'tid',
        select: 'uid catalog title content answer created',
        populate: {
          path: 'uid',
          select: 'name pic'
        }
      })
      .sort({ created: -1 })
      .skip(skip)
      .limit(limit)
  },
  deleteByPostId: function (tid) {
    return this.deleteMany({ tid })
  }
}

const PostHistory = mongoose.model('post_history', PostHistorySchema)

export default PostHistory
```

åˆ›å»º`src/api/StaticsController.js`ï¼š

* ç»Ÿè®¡æœ€è¿‘æµè§ˆã€æˆ‘çš„å¸–å­ã€æ”¶è—å¤¹ã€æˆ‘çš„è¯„è®ºã€æˆ‘çš„ç‚¹èµã€æˆ‘çš„è·èµã€ä¸ªäººç§¯åˆ†ã€ç”¨æˆ·çš„ç­¾åˆ°æ—¥æœŸï¼›
* ä¸ªäººç§¯åˆ†éœ€è¦å•ç‹¬å†™æ–¹æ³•ï¼Œå…¶ä»–çš„å¯ä»¥ä½¿ç”¨mongooseä¸­çš„`countDocuments`æ–¹æ³•ï¼›

```js
// import { getJWTPayload } from '@/common/Utils'
import Post from '@/model/Post'
import PostHistory from '@/model/PostHistory'
import User from '@/model/User'
import UserCollect from '@/model/UserCollect'
import Comments from '@/model/Comments'
import CommentsHands from '@/model/CommentsHands'
import SignRecord from '@/model/SignRecord'

/**
 * ç»Ÿè®¡ç›¸å…³çš„ api æ”¾åœ¨è¿™é‡Œ
 */
class StatisticsController {
  // ç»Ÿè®¡æ•°æ®ï¼šæœ€è¿‘æµè§ˆã€æˆ‘çš„å¸–å­ã€æ”¶è—å¤¹ã€æˆ‘çš„è¯„è®ºã€æˆ‘çš„ç‚¹èµã€è·èµã€ä¸ªäººç§¯åˆ†
  async wxUserCount (ctx) {
    const body = ctx.query
    // const obj = await getJWTPayload(ctx.header.authorization)
    const { _id: uid } = ctx
    const { reqAll } = body
    // console.log('ğŸš€ ~ file: StatisticsController.js ~ line 20 ~ StatisticsController ~ wxUserCount ~ reqAll', reqAll)
    if (uid) {
      const countMyHistory =
        (body.reqHistory || reqAll) && (await PostHistory.countDocuments({ uid })) // æœ€è¿‘æµè§ˆ
      const countMyPost =
        (body.reqPost || reqAll) && (await Post.countDocuments({ uid })) // æˆ‘çš„å¸–å­
      const countMyCollect =
        (body.reqCollect || reqAll) &&
        (await UserCollect.countDocuments({ uid })) // æ”¶è—å¤¹
      const countMyComment =
        (body.reqComment || reqAll) &&
        (await Comments.countDocuments({ cuid: uid })) // æˆ‘çš„è¯„è®º
      const countMyHands =
        (body.reqHands || reqAll) &&
        (await CommentsHands.countDocuments({ uid })) // æˆ‘çš„ç‚¹èµ
      const countHandsOnMe =
        (body.reqHandsOnMe || reqAll) &&
        (await CommentsHands.countDocuments({ huid: uid })) // è·èµ
      const countFavs = (body.reqFavs || reqAll) && (await User.getFavs(uid)) // ä¸ªäººç§¯åˆ†
      const countSign =
        (body.reqSign || reqAll) && (await SignRecord.countDocuments({ uid })) // ç­¾åˆ°æ¬¡æ•°
      const lastSigned =
        (body.reqLastSigned || reqAll) && (await SignRecord.countDocuments({ uid })) // è·å–ç”¨æˆ·æœ€æ–°çš„ç­¾åˆ°æ—¥æœŸ

      ctx.body = {
        code: 200,
        data: {
          countMyPost,
          countMyCollect,
          countMyComment,
          countMyHands,
          countHandsOnMe,
          countMyHistory,
          countFavs,
          lastSigned,
          countSign
        }
      }
    } else {
      ctx.body = {
        code: 500,
        msg: 'æŸ¥è¯¢å¤±è´¥'
      }
    }
  }
}

export default new StatisticsController()
```

æ›´æ–°ç”¨æˆ·è·å–æ–‡ç« è¯¦æƒ…çš„æ–¹æ³•`getPostDetail`ï¼Œåœ¨æ–‡ä»¶`src/api/ContentController.js`ä¸­ï¼š

```js
  // è·å–æ–‡ç« è¯¦æƒ…
  async getPostDetail (ctx) {
    const params = ctx.query
    if (!params.tid) {
      ctx.body = {
        code: 500,
        msg: 'æ–‡ç« idä¸ºç©º'
      }
      return
    }
    const post = await Post.findByTid(params.tid)
    if (!post) {
      ctx.body = {
        code: 200,
        data: {},
        msg: 'æŸ¥è¯¢æ–‡ç« è¯¦æƒ…æˆåŠŸ'
      }
      return
    }
    let isFav = 0
    // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¼ é€’Authorizationçš„æ•°æ®ï¼Œå³æ˜¯å¦ç™»å½•
    if (
      typeof ctx.header.authorization !== 'undefined' &&
      ctx.header.authorization !== ''
    ) {
      const obj = await getJWTPayload(ctx.header.authorization)
      const userCollect = await UserCollect.findOne({
        uid: obj._id,
        tid: params.tid
      })
      if (userCollect && userCollect.tid) {
        isFav = 1
      }
      await PostHistory.addOrUpdate(ctx._id, params.tid) // æ·»åŠ æµè§ˆè®°å½•
    }
    const newPost = post.toJSON()
    newPost.isFav = isFav
    // æ›´æ–°æ–‡ç« é˜…è¯»è®°æ•°
    const result = await Post.updateOne(
      { _id: params.tid },
      { $inc: { reads: 1 } }
    )
    if (post._id && result.ok === 1) {
      ctx.body = {
        code: 200,
        data: newPost,
        msg: 'æŸ¥è¯¢æ–‡ç« è¯¦æƒ…æˆåŠŸ'
      }
    } else {
      ctx.body = {
        code: 500,
        msg: 'è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥'
      }
    }
  }
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/04-æ¶ˆæ¯&çƒ­é—¨&ä¸ªäººä¸­å¿ƒ.html#æ¥å£å¯¹æ¥ä¸è”è°ƒ-3)æ¥å£å¯¹æ¥ä¸è”è°ƒ

å‰ç«¯æ·»åŠ æ¥å£ï¼š

```js
// ä¸ªäººä¸­å¿ƒçš„ç»Ÿè®¡æ•°å­—
const wxUserCount = params => axios.get('/user/wxUserCount', params)
```

å‰ç«¯é¡µé¢æ·»åŠ è¯·æ±‚ï¼š

```js
async getUserCount () {
  const { _id: uid } = this.userInfo
  if (!uid) return
  await this.getUserInfo()
  const { data, code } = await this.$u.api.wxUserCount({ uid, reqAll: 1 })
  if (code === 200) {
    const { countMyPost, countMyCollect, countMyHistory } = data
    this.countMyPost = countMyPost
    this.countMyCollect = countMyCollect
    this.countMyHistory = countMyHistory
  }
}
```

å®Œæ•´çš„é¡µé¢ä»£ç ï¼š

```vue
<template>
  <view>
    <view class="grey">
      <view class="bg"></view>
      <view class="wrapper">
        <!-- ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
        <view class="profile">
          <view class="info">
            <u-image class="pic" :src="isLogin ? userInfo.pic: ''" width="120" height="120" shape="circle" error-icon="/static/images/header.jpg" />
            <!-- ç”¨æˆ·æ˜µç§° + VIP -->
            <view class="user" @click="navTo">
              <view class="name">{{isLogin ?userInfo.name : 'è¯·ç™»å½•'}}</view>
              <view class="fav">
                <!-- <van-icon name="fav2" class-prefix="iconfont" size="14"></van-icon> -->
                ç§¯åˆ†ï¼š{{userInfo && userInfo.favs ? userInfo.favs:0}}
              </view>
            </view>
            <view class="link" @click="gotoGuard('/sub-pkg/user-info/user-info')">ä¸ªäººä¸»é¡µ ></view>
            <!-- <navigator class="link" url="/subcom-pkg/auth/auth">ä¸ªäººä¸»é¡µ ></navigator> -->
            <!-- <navigator class="link" url="/sub-pkg/user-info/user-info">ä¸ªäººä¸»é¡µ ></navigator> -->
          </view>
          <view class="stats" v-if="isLogin">
            <view class="item">
              <navigator :url="'/sub-pkg/posts/posts?uid=' + uid + '&type=p'">
                <view>{{ countMyPost }}</view>
                <view class="title">æˆ‘çš„å¸–å­</view>
              </navigator>
            </view>
            <view class="item">
              <navigator :url="'/sub-pkg/posts/posts?uid=' + uid+ '&type=c'">
                <view>{{ countMyCollect }}</view>
                <view class="title">æ”¶è—å¤¹</view>
              </navigator>
            </view>
            <view class="item">
              <navigator :url="'/sub-pkg/posts/posts?uid=' + uid+ '&type=h'">
                <view>{{ countMyHistory }}</view>
                <view class="title">æœ€è¿‘æµè§ˆ</view>
              </navigator>
            </view>
          </view>
        </view>
      </view>
      <view class="center-wraper">
        <view class="center-list first">
          <li v-for="(item,index) in lists" :key="index">
            <view @click="gotoGuardHandler(item)">
              <i :class="item.icon"></i>
              <span>{{item.name}}</span>
            </view>
          </li>
        </view>
        <view class="center-list">
          <li v-for="(item,index) in routes" :key="index" @click="gotoHome(item.tab)">
            <i :class="item.icon"></i>
            <span>{{item.name}}</span>
          </li>
        </view>
      </view>
    </view>
    <view class="bottom-line"></view>
  </view>
</template>

<script>
import { gotoGuard } from '@/common/checkAuth'
import { mapGetters, mapState, mapMutations } from 'vuex'
export default {
  data: () => ({
    lists: [
      {
        name: 'æˆ‘çš„å¸–å­',
        icon: 'icon-teizi',
        routeName: '/sub-pkg/posts/posts'
      },
      {
        name: 'ä¿®æ”¹è®¾ç½®',
        icon: 'icon-setting',
        routeName: '/sub-pkg/settings/settings'
      },
      {
        name: 'ç­¾åˆ°ä¸­å¿ƒ',
        icon: 'icon-qiandao',
        routeName: '/sub-pkg/sign/sign'
      },
      {
        name: 'ç”µå­ä¹¦',
        icon: 'icon-book',
        routeName: '/sub-pkg/books/books'
      },
      {
        name: 'å…³äºæˆ‘ä»¬',
        icon: 'icon-about',
        routeName: '/sub-pkg/about/about'
      },
      {
        name: 'äººå·¥å®¢æœ',
        icon: 'icon-support',
        routeName: '/sub-pkg/suggest/suggest'
      },
      {
        name: 'æ„è§åé¦ˆ',
        icon: 'icon-lock2',
        routeName: '/sub-pkg/suggest/survey'
      }
    ],
    routes: [
      {
        name: 'æé—®',
        icon: 'icon-question',
        tab: 'ask'
      },
      {
        name: 'åˆ†äº«',
        icon: 'icon-share',
        tab: 'share'
      },
      {
        name: 'è®¨è®º',
        icon: 'icon-taolun',
        tab: 'discuss'
      },
      {
        name: 'å»ºè®®',
        icon: 'icon-advise',
        tab: 'advise'
      }
    ],
    countMyPost: 0,
    countMyCollect: 0,
    countMyHistory: 0
    // isLogin: true
  }),
  computed: {
    ...mapGetters(['isLogin']),
    ...mapState(['userInfo']),
    uid () {
      return this.userInfo._id
    }
  },
  onShow () {
    this.getUserCount()
  },
  methods: {
    ...mapMutations(['setTab', 'setUserInfo']),
    gotoGuard,
    gotoGuardHandler (item) {
      const { name, routeName } = item
      if (name === 'æˆ‘çš„å¸–å­') {
        gotoGuard(routeName + `?uid=${this.uid}&type=p`)
      } else {
        gotoGuard(routeName)
      }
    },
    gotoHome (tab) {
      this.setTab(tab)
      uni.switchTab({
        url: '/pages/home/home'
      })
    },
    navTo () {
      if (!this.isLogin) {
        uni.navigateTo({
          url: '/subcom-pkg/auth/auth'
        })
      }
    },
    async getUserInfo () {
      const { _id: uid } = this.userInfo
      const { code, data } = await this.$u.api.getBasic({ uid })
      if (code === 200) {
        this.setUserInfo(data)
      }
    },
    async getUserCount () {
      const { _id: uid } = this.userInfo
      if (!uid) return
      await this.getUserInfo()
      const { data, code } = await this.$u.api.wxUserCount({ uid, reqAll: 1 })
      if (code === 200) {
        const { countMyPost, countMyCollect, countMyHistory } = data
        this.countMyPost = countMyPost
        this.countMyCollect = countMyCollect
        this.countMyHistory = countMyHistory
      }
    }
  }

}
</script>

<style lang="scss">
.grey {
  position: fixed;
  width: 100%;
  height: 100%;
  left: 0;
  top: 0;
  z-index: 30;
}
a {
  color: #666;
  text-decoration: none;
}
// .bg {
//   height: 260rpx;
//   // 4ä¸ªå‚æ•°ï¼š å·¦ä¸Š å³ä¸Š å³ä¸‹ å·¦ä¸‹
//   border-radius: 0 0 50% 50%;
//   background-color: #16d1a2;
//   position: relative;
//   z-index: 50;
// }
.bg {
  background-image: url("/static/images/my_bg.png");
  background-repeat: no-repeat;
  background-size: contain;
  position: relative;
  left: 0;
  top: 0;
  width: 100%;
  height: 280rpx;
  background-position: 0 0;
  z-index: 100;
}
.wrapper {
  width: 100%;
  height: 370rpx;
  padding: 25rpx;
  position: absolute;
  left: 0;
  top: 0;
  z-index: 100;
  box-sizing: border-box;
  color: #333;
  .profile {
    background: #fff;
    border-radius: 12rpx;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    width: 100%;
    height: 100%;
    padding: 30rpx;
    box-sizing: border-box;
    .name {
      font-size: 36rpx;
      font-weight: 700;
      margin-bottom: 10rpx;
      margin-top: 0;
      width: 370rpx;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .link {
      font-size: 24rpx;
      color: #999;
    }
    .fav {
      display: inline-block;
      padding: 8px 12rpx;
      background: rgba(2, 209, 153, 0.16);
      border-radius: 12rpx;
      color: #02d199;
      margin: 0;
      font-size: 22rpx;
      .icon-fav {
        padding-right: 10rpx;
      }
    }
    .info,
    .stats {
      display: flex;
      flex-flow: row nowrap;
      justify-content: space-between;
      align-items: center;
    }
    .info {
      margin-bottom: 24rpx;
    }
    .stats {
      justify-content: space-around;
    }
    .user {
      flex: 1;
      padding-left: 20rpx;
    }
    .pic {
      width: 120rpx;
      height: 120rpx;
      border-radius: 50%;
    }
    .item {
      text-align: center;
      position: relative;
      p {
        margin-top: 14rpx;
        margin-bottom: 0;
      }
      &:after {
        width: 2rpx;
        height: 80rpx;
        background: #ddd;
        content: "";
        position: absolute;
        right: -60rpx;
        top: 20rpx;
      }
      &:last-child {
        &:after {
          width: 0;
        }
      }
      .title {
        color: #666;
      }
    }
  }
}
.center-wraper {
  background: #f6f5f8;
  position: relative;
  width: 100%;
  // height: 100%;
  z-index: 10;
  .center-list {
    background: #fff;
    margin-bottom: 30rpx;
    display: flex;
    flex-flow: wrap;
    padding-top: 40rpx;
    &.first {
      padding-top: 100rpx;
    }
    li {
      width: 25%;
      text-align: center;
      color: #666;
      margin-bottom: 40rpx;
      font-size: 26rpx;
    }
    i {
      display: block;
      margin: 0 auto;
      font-size: 40rpx;
      width: 56rpx;
      height: 56rpx;
      margin-bottom: 20rpx;
      color: #888;
      background-size: contain;
    }
    .icon-teizi {
      background-image: url("/static/images/teizi@2x.png");
    }
    .icon-setting {
      background-image: url("/static/images/setting@2x.png");
    }
    .icon-lock2 {
      background-image: url("/static/images/lock2@2x.png");
    }
    .icon-support {
      background-image: url("/static/images/support.png");
    }
    .icon-qiandao {
      background-image: url("/static/images/sign1.png");
    }
    .icon-book {
      background-image: url("/static/images/books.png");
    }
    .icon-record {
      background-image: url("/static/images/record@2x.png");
    }
    .icon-about {
      background-image: url("/static/images/about.png");
    }
    // å¿«æ·è®¿é—®
    .icon-question {
      background-image: url("/static/images/question@2x.png");
    }
    .icon-share {
      background-image: url("/static/images/share@2x.png");
    }
    .icon-taolun {
      background-image: url("/static/images/taolun@2x.png");
    }
    .icon-advise {
      background-image: url("/static/images/advice@2x.png");
    }
  }
}
</style>
```

æœ€ç»ˆæ•ˆæœï¼š

![image-20210801235142625](uniapp.assets/image-20210801235142625.48262a26.png)



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#refreshtokenæœºåˆ¶)RefreshTokenæœºåˆ¶

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#éœ€æ±‚åˆ†æ)éœ€æ±‚åˆ†æ

ç”¨æˆ·tokenä¸èƒ½è®¾ç½®å¤ªé•¿çš„æœ‰æ•ˆæ—¶é—´ï¼Œè¿™æ ·å¯ä»¥æé«˜æ¥å£éƒ¨åˆ†çš„å®‰å…¨æ€§ã€‚

![refreshToken](uniapp.assets/refreshToken.02c26e12.gif)

è¯´æ˜ï¼š

* ç™»å½•è¯·æ±‚/loginæˆåŠŸä¹‹åä¼šå“åº”token&refreshTokenï¼›
* tokençš„è¿‡æœŸæ—¶é—´æ¯”è¾ƒçŸ­ï¼Œæ¯”å¦‚1å°æ—¶åˆ°4å°æ—¶ï¼ŒrefreshTokençš„è¿‡æœŸæ—¶é—´æ¯”tokenè¦é•¿ï¼Œæ¯”å¦‚1å¤©æˆ–è€…7å¤©ï¼›
* ç”¨æˆ·åœ¨ç™»å½•ä¹‹åï¼Œæ‰€æœ‰çš„é‰´æƒçš„æ¥å£å¸¦ä¸Štokenï¼›
* å¦‚æœtokenè¿‡æœŸï¼Œåˆ™ä½¿ç”¨refreshTokenè¿›è¡Œè¯·æ±‚/login/refreshæ¥å£ï¼Œè¯·æ±‚æ–°çš„tokenï¼›
* å¦‚æœrefreshTokenæœªè¿‡æœŸï¼Œåˆ™è¿”å›æ–°tokenï¼›
* å¦‚æœrefreshTokenè¿‡æœŸï¼Œåˆ™è¿”å›401;

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#åˆ›å»ºrefreshtokenæ¥å£)åˆ›å»ºrefreshTokenæ¥å£

æ·»åŠ `src/routes/modules/loginRouter.js`è·¯ç”±ï¼š

```js
// refresh
router.post('/refresh', loginController.refresh)
```

è°ƒæ•´ç™»å½•æ¥å£`src/api/LoginController.js`ï¼š

```js
  // å¾®ä¿¡ç™»å½•
  async wxLogin (ctx) {
  // 1.è§£å¯†ç”¨æˆ·ä¿¡æ¯
    const { body } = ctx.request
    const { user, code } = body
    if (!code) {
      ctx.body = {
        code: 500,
        data: 'æ²¡æœ‰è¶³å¤Ÿå‚æ•°'
      }
      return
    }
    const res = await wxGetUserInfo(user, code)
    if (res.errcode === 0) {
    // 2.æŸ¥è¯¢æ•°æ®åº“ -> åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    // 3.å¦‚æœä¸å­˜åœ¨ â€”> åˆ›å»ºç”¨æˆ·
    // 4.å¦‚æœå­˜åœ¨ -> è·å–ç”¨æˆ·ä¿¡æ¯
      const tmpUser = await User.findOrCreateByUnionid(res)
      // 5.äº§ç”Ÿtokenï¼Œè·å–ç”¨æˆ·çš„ç­¾åˆ°çŠ¶æ€
      const token = generateToken({ _id: tmpUser._id })
      const userInfo = await addSign(tmpUser)
      ctx.body = {
        code: 200,
        data: userInfo,
        token,
        // æ–°å¢refreshToken
        refreshToken: generateToken({ _id: tmpUser._id }, '7d')
      }
    } else {
      ctx.throw(501, res.errcode === 40163 ? 'codeå·²å¤±æ•ˆï¼Œè¯·åˆ·æ–°åé‡è¯•' : 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•')
    }
  }

  // refreshToken
  async refresh (ctx) {
    ctx.body = {
      code: 200,
      token: generateToken({ _id: ctx._id }, '60m'),
      msg: 'è·å–tokenæˆåŠŸ'
    }
  }
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#å‰ç«¯é¡µé¢é€»è¾‘)å‰ç«¯é¡µé¢é€»è¾‘

* é”™è¯¯æ‹¦æˆªä¸­ï¼Œé’ˆå¯¹ 401çš„æƒ…å†µè¿›è¡Œå•ç‹¬å¤„ç†ï¼›
  * è¿”å›401ä¹‹åï¼Œä½¿ç”¨æ–°çš„requestå®ä¾‹è¯·æ±‚refreshTokençš„æ¥å£ï¼›
  * è¯·æ±‚æˆåŠŸä¹‹åï¼Œæ›´æ–°æœ¬åœ°çš„tokenåŠç¼“å­˜ï¼›
* ä½¿ç”¨æ–°çš„Tokené‡æ–°å‘å‘èµ·æ—§çš„è¯·æ±‚ï¼›

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#ç™»å½•å¤±è´¥åå¤„ç†ç¼“å­˜)ç™»å½•å¤±è´¥åå¤„ç†ç¼“å­˜

åœ¨`src/store/index.js`ä¸­æ–°å¢å…³äºæ¸…é™¤tokenåŠç”¨æˆ·ä¿¡æ¯çš„`actions`ï¼š

```js
const actions = {
  logout ({ commit }) {
    commit('setToken', '')
    commit('setUserInfo', {})
    commit('setRefreshToken', '')
    uni.clearStorage()
  }
}
```

æœ€ç»ˆæµ‹è¯•ä¸æ•ˆæœï¼š

![image-20210802192754262](uniapp.assets/image-20210802192754262.f2e58c05.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#å°è£…simple-js)å°è£…Simple.js

simple.jså°è£…æ–°çš„requestè¡¥å…¨ï¼Œç”¨äºåœ¨é»˜è®¤å®ä¾‹è¯·æ±‚401çš„æƒ…å†µä¸‹ï¼Œå‘é€refreshTokençš„è¯·æ±‚ï¼š

```js
export const simpleHttp = (options, { header = {}, callback }) => {
  const result = new Promise((resolve, reject) => {
    uni.request(Object.assign({
      timeout: 10 * 1000
    }, options, {
      header,
      success: (res) => {
        // è¯·æ±‚æˆåŠŸ
        if (res.statusCode >= 200 && res.statusCode < 300) {
          resolve(res.data)
        } else {
          reject(res)
        }
      },
      fail: (err) => {
        reject(err)
      },
      complete: () => {
        callback && callback()
      }
    }))
  })
  return result
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#è°ƒæ•´errorhandle-401é€»è¾‘)è°ƒæ•´errorHandle 401é€»è¾‘

```js
import { simpleHttp } from './request/simple'

// è°ƒæ•´errorHandleå¤„ç†æµç¨‹ï¼š
errorHandle: async (err, { options, instance }) => {
  if (err.statusCode === 401) {
    // 4.ä¸šåŠ¡ â€”> refreshToken -> è¯·æ±‚å“åº”401 -> åˆ·æ–°token
    try {
      const { code, token } = await simpleHttp({
        method: 'POST',
        url: baseUrl + '/login/refresh'
      }, {
        header: {
          Authorization: 'Bearer ' + uni.getStorageSync('refreshToken')
        }
      })
      if (code === 200) {
        // refreshTokenè¯·æ±‚æˆåŠŸ
        // 1.è®¾ç½®å…¨å±€çš„token
        store.commit('setToken', token)
        // 2.é‡æ–°å‘èµ·è¯·æ±‚
        const newResult = await instance.request(options)
        return newResult
      }
    } catch (error) {
      // ä»£è¡¨refreshTokenå·²ç»å¤±æ•ˆ
      // æ¸…é™¤æœ¬åœ°çš„token
      store.dispatch('logout')
      // å¯¼èˆªåˆ°ç”¨æˆ·çš„ç™»å½•é¡µé¢
      authNav()
    }
    uni.showToast({
      icon: 'none',
      title: 'é‰´æƒå¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•',
      duration: 2000
    })
  } else {
    // å…¶ä»–çš„é”™è¯¯
    // showToastæç¤ºç”¨æˆ·
    // 3.å¯¹é”™è¯¯è¿›è¡Œç»Ÿä¸€çš„å¤„ç† -> showToast
    const { data: { msg } } = err
    uni.showToast({
      icon: 'none',
      title: msg || 'è¯·æ±‚å¼‚å¸¸ï¼Œè¯·é‡è¯•',
      duration: 2000
    })
  }
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#è¯·æ±‚æ‹¦æˆªå™¨)è¯·æ±‚æ‹¦æˆªå™¨

è¦æ³¨æ„è¯·æ±‚æ‹¦æˆªå™¨ä¸­tokençš„è®¾ç½®æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨`config.header.Authorization = 'Bearer ' + token`è¿›è¡Œèµ‹å€¼ï¼š

```js
// è¯·æ±‚æ‹¦æˆªï¼Œé…ç½®Tokenç­‰å‚æ•°
Vue.prototype.$u.http.interceptor.request = (config) => {
  // å¼•ç”¨token
  // 1.åœ¨å¤´éƒ¨è¯·æ±‚çš„æ—¶å€™ï¼Œtokenå¸¦ä¸Š -> è¯·æ±‚æ‹¦æˆªå™¨
  const publicArr = [/\/public/, /\/login/]
  // local store -> uni.getStorageSync('token')
  let isPublic = false
  publicArr.forEach(path => {
    isPublic = isPublic || path.test(config.url)
  })
  const token = uni.getStorageSync('token')
  if (!isPublic && token) {
    config.header.Authorization = 'Bearer ' + token
  }
  // æœ€åéœ€è¦å°†configè¿›è¡Œreturn
  return config
  // å¦‚æœreturnä¸€ä¸ªfalseå€¼ï¼Œåˆ™ä¼šå–æ¶ˆæœ¬æ¬¡è¯·æ±‚
  // if(config.url === '/user/rest') return false; // å–æ¶ˆæŸæ¬¡è¯·æ±‚
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/05-RefreshTokenæœºåˆ¶.html#è°ƒæ•´å·¥å…·ç±»request-js)è°ƒæ•´å·¥å…·ç±»request.js

åŸå…ˆRequest.jså°è£…ä¸­ï¼Œerrorhandleçš„éƒ¨åˆ†åªä¼šè¿”å›é”™è¯¯çš„å†…å®¹ã€‚

è€Œæˆ‘ä»¬åœ¨errorHandleä¸­éœ€è¦å‘é€æ—§çš„è¯·æ±‚ï¼Œå³éœ€è¦ï¼š

* åŸè¯·æ±‚çš„ç›¸å…³é…ç½®`config`ï¼Œå¦‚urlã€methodç­‰ï¼›
* åŸè¯·æ±‚çš„å®ä¾‹ï¼Œä¸Šé¢æœ‰è¯·æ±‚æ‹¦æˆªå™¨ï¼Œä½¿ç”¨tokenæ•°æ®å‘é€è¯·æ±‚ï¼›

æ€è·¯ä½¿ç”¨callbackå›è°ƒçš„æ–¹å¼ï¼ŒæŠŠå‚æ•°ä¼ é€’å‡ºæ¥ï¼š

```js
const errCallback = { options, instance: this }

// ...
errorHandle(response, errCallback)
```

å®Œæ•´çš„ä»£ç ï¼š

```js
import deepMerge from '../function/deepMerge'
// import validate from '../function/test'
class Request {
  // è®¾ç½®å…¨å±€é»˜è®¤é…ç½®
  setConfig (customConfig) {
    // æ·±åº¦åˆå¹¶å¯¹è±¡ï¼Œå¦åˆ™ä¼šé€ æˆå¯¹è±¡æ·±å±‚å±æ€§ä¸¢å¤±
    this.config = deepMerge(this.config, customConfig)
  }

  // ä¸»è¦è¯·æ±‚éƒ¨åˆ†
  request (options = {}) {
    // æ£€æŸ¥è¯·æ±‚æ‹¦æˆª
    if (this.interceptor.request && typeof this.interceptor.request === 'function') {
      const interceptorRequest = this.interceptor.request(options)
      if (interceptorRequest === false) {
        // è¿”å›ä¸€ä¸ªå¤„äºpendingçŠ¶æ€ä¸­çš„Promiseï¼Œæ¥å–æ¶ˆåŸpromiseï¼Œé¿å…è¿›å…¥then()å›è°ƒ
        return new Promise(() => { })
      }
      this.options = interceptorRequest
    }
    options.dataType = options.dataType || this.config.dataType
    options.responseType = options.responseType || this.config.responseType
    options.url = options.url || ''
    options.params = options.params || {}
    options.header = Object.assign({}, this.config.header, options.header)
    options.method = options.method || this.config.method
    const errCallback = { options, instance: this }
    return new Promise((resolve, reject) => {
      options.complete = (response) => {
        const { errorHandle } = this.config
        // è¯·æ±‚è¿”å›åï¼Œéšè—loading(å¦‚æœè¯·æ±‚è¿”å›å¿«çš„è¯ï¼Œå¯èƒ½ä¼šæ²¡æœ‰loading)
        uni.hideLoading()
        // æ¸…é™¤å®šæ—¶å™¨ï¼Œå¦‚æœè¯·æ±‚å›æ¥äº†ï¼Œå°±æ— éœ€loading
        clearTimeout(this.config.timer)
        this.config.timer = null
        // åˆ¤æ–­ç”¨æˆ·å¯¹æ‹¦æˆªè¿”å›æ•°æ®çš„è¦æ±‚ï¼Œå¦‚æœoriginalDataä¸ºtrueï¼Œè¿”å›æ‰€æœ‰çš„æ•°æ®(response)åˆ°æ‹¦æˆªå™¨ï¼Œå¦åˆ™åªè¿”å›response.data
        if (this.config.originalData) {
          // åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ‹¦æˆªå™¨
          if (this.interceptor.response && typeof this.interceptor.response === 'function') {
            const resInterceptors = this.interceptor.response(response)
            // å¦‚æœæ‹¦æˆªå™¨ä¸è¿”å›falseï¼Œå°±å°†æ‹¦æˆªå™¨è¿”å›çš„å†…å®¹ç»™this.$u.postçš„thenå›è°ƒ
            if (resInterceptors !== false) {
              resolve(resInterceptors)
            } else {
              // å¦‚æœæ‹¦æˆªå™¨è¿”å›falseï¼Œæ„å‘³ç€æ‹¦æˆªå™¨å®šä¹‰è€…è®¤ä¸ºè¿”å›æœ‰é—®é¢˜ï¼Œç›´æ¥æ¥å…¥catchå›è°ƒ
              errorHandle(response, errCallback)
              reject(response)
            }
          } else {
            // å¦‚æœè¦æ±‚è¿”å›åŸå§‹æ•°æ®ï¼Œå°±ç®—æ²¡æœ‰æ‹¦æˆªå™¨ï¼Œä¹Ÿè¿”å›æœ€åŸå§‹çš„æ•°æ®
            resolve(response)
          }
        } else {
          if (response.statusCode === 200) {
            if (this.interceptor.response && typeof this.interceptor.response === 'function') {
              const resInterceptors = this.interceptor.response(response.data)
              if (resInterceptors !== false) {
                resolve(resInterceptors)
              } else {
                errorHandle(response, errCallback)
                reject(response.data)
              }
            } else {
              // å¦‚æœä¸æ˜¯è¿”å›åŸå§‹æ•°æ®(originalData=false)ï¼Œä¸”æ²¡æœ‰æ‹¦æˆªå™¨çš„æƒ…å†µä¸‹ï¼Œè¿”å›çº¯æ•°æ®ç»™thenå›è°ƒ
              resolve(response.data)
            }
          } else {
            // ä¸è¿”å›åŸå§‹æ•°æ®çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨çŠ¶æ€ç ä¸ä¸º200ï¼Œmodalå¼¹æ¡†æç¤º
            // if(response.errMsg) {
            //  uni.showModal({
            //   title: response.errMsg
            //  });
            // }
            errorHandle(response, errCallback)
            reject(response)
          }
        }
      }

      // åˆ¤æ–­ç”¨æˆ·ä¼ é€’çš„URLæ˜¯å¦/å¼€å¤´,å¦‚æœä¸æ˜¯,åŠ ä¸Š/ï¼Œè¿™é‡Œä½¿ç”¨äº†uViewçš„test.jséªŒè¯åº“çš„url()æ–¹æ³•
      // æƒ…æ™¯ä¸€ï¼šå¦‚æœæ˜¯ä½¿ç”¨çš„å®˜æ–¹çš„uviewç»„ä»¶åº“ -> åˆ›å»ºæ–°çš„reg -> url
      // æƒ…å†µäºŒï¼šå¦‚æœæ˜¯è‡ªå·±å®šä¹‰çš„requestå·¥å…·js -> æ›¿æ¢æ­£åˆ™
      options.url = /^https?:\/\/.*/.test(options.url)
        ? options.url
        : (this.config.baseUrl + (options.url.indexOf('/') === 0
            ? options.url
            : '/' + options.url))
      // console.log('ğŸš€ ~ file: index.js ~ line 82 ~ Request ~ returnnewPromise ~ options.url', options.url, /^https?:\/\/.*/.test(options.url))

      // æ˜¯å¦æ˜¾ç¤ºloading
      // åŠ ä¸€ä¸ªæ˜¯å¦å·²æœ‰timerå®šæ—¶å™¨çš„åˆ¤æ–­ï¼Œå¦åˆ™æœ‰ä¸¤ä¸ªåŒæ—¶è¯·æ±‚çš„æ—¶å€™ï¼Œåè€…ä¼šæ¸…é™¤å‰è€…çš„å®šæ—¶å™¨id
      // è€Œæ²¡æœ‰æ¸…é™¤å‰è€…çš„å®šæ—¶å™¨ï¼Œå¯¼è‡´å‰è€…è¶…æ—¶ï¼Œä¸€ç›´æ˜¾ç¤ºloading
      if (this.config.showLoading && !this.config.timer) {
        this.config.timer = setTimeout(() => {
          uni.showLoading({
            title: this.config.loadingText,
            mask: this.config.loadingMask
          })
          this.config.timer = null
        }, this.config.loadingTime)
      }
      uni.request(options)
    })
    // .catch(res => {
    //  // å¦‚æœè¿”å›reject()ï¼Œä¸è®©å…¶è¿›å…¥this.$u.post().then().catch()åé¢çš„catct()
    //  // å› ä¸ºå¾ˆå¤šäººéƒ½ä¼šå¿˜äº†å†™åé¢çš„catch()ï¼Œå¯¼è‡´æŠ¥é”™æ•è·ä¸åˆ°catch
    //  return new Promise(()=>{});
    // })
  }

  constructor () {
    this.config = {
      baseUrl: '', // è¯·æ±‚çš„æ ¹åŸŸå
      // é»˜è®¤çš„è¯·æ±‚å¤´
      header: {},
      method: 'POST',
      // è®¾ç½®ä¸ºjsonï¼Œè¿”å›åuni.requestä¼šå¯¹æ•°æ®è¿›è¡Œä¸€æ¬¡JSON.parse
      dataType: 'json',
      // æ­¤å‚æ•°æ— éœ€å¤„ç†ï¼Œå› ä¸º5+å’Œæ”¯ä»˜å®å°ç¨‹åºä¸æ”¯æŒï¼Œé»˜è®¤ä¸ºtextå³å¯
      responseType: 'text',
      showLoading: true, // æ˜¯å¦æ˜¾ç¤ºè¯·æ±‚ä¸­çš„loading
      loadingText: 'è¯·æ±‚ä¸­...',
      loadingTime: 800, // åœ¨æ­¤æ—¶é—´å†…ï¼Œè¯·æ±‚è¿˜æ²¡å›æ¥çš„è¯ï¼Œå°±æ˜¾ç¤ºåŠ è½½ä¸­åŠ¨ç”»ï¼Œå•ä½ms
      timer: null, // å®šæ—¶å™¨
      originalData: false, // æ˜¯å¦åœ¨æ‹¦æˆªå™¨ä¸­è¿”å›æœåŠ¡ç«¯çš„åŸå§‹æ•°æ®ï¼Œè§æ–‡æ¡£è¯´æ˜
      loadingMask: true // å±•ç¤ºloadingçš„æ—¶å€™ï¼Œæ˜¯å¦ç»™ä¸€ä¸ªé€æ˜çš„è’™å±‚ï¼Œé˜²æ­¢è§¦æ‘¸ç©¿é€
    }

    // æ‹¦æˆªå™¨
    this.interceptor = {
      // è¯·æ±‚å‰çš„æ‹¦æˆª
      request: null,
      // è¯·æ±‚åçš„æ‹¦æˆª
      response: null
    }

    // getè¯·æ±‚
    this.get = (url, data = {}, header = {}) => {
      return this.request({
        method: 'GET',
        url,
        header,
        data
      })
    }

    // postè¯·æ±‚
    this.post = (url, data = {}, header = {}) => {
      return this.request({
        url,
        method: 'POST',
        header,
        data
      })
    }

    // putè¯·æ±‚ï¼Œä¸æ”¯æŒæ”¯ä»˜å®å°ç¨‹åº(HX2.6.15)
    this.put = (url, data = {}, header = {}) => {
      return this.request({
        url,
        method: 'PUT',
        header,
        data
      })
    }

    // deleteè¯·æ±‚ï¼Œä¸æ”¯æŒæ”¯ä»˜å®å’Œå¤´æ¡å°ç¨‹åº(HX2.6.15)
    this.delete = (url, data = {}, header = {}) => {
      return this.request({
        url,
        method: 'DELETE',
        header,
        data
      })
    }
  }
}
export default new Request()
```



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/06-æ–‡ç« è¯¦æƒ….html#æ–‡ç« è¯¦æƒ…)æ–‡ç« è¯¦æƒ…

å®Œæˆæ•ˆæœï¼š

![image-20210527020457329](uniapp.assets/image-20210527020457329.01b5962e.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/06-æ–‡ç« è¯¦æƒ….html#é¡µé¢å¸ƒå±€ä¸æ ·å¼)é¡µé¢å¸ƒå±€ä¸æ ·å¼

åŸºæœ¬çš„æ­¥éª¤

* æ–°å¢é¡µé¢`/subcom-pkg/detail/detail`

* é…ç½®`pages.json`
* è°ƒæ•´é¡µé¢çš„æ ·å¼ä¸æ¥å£

é…ç½®`pages.json`

```json
"subPackages": [
  {
    "root": "subcom-pkg",
    "pages": [
      ...
      {
        "path": "detail/detail",
        "style": {
          "navigationBarTitleText": "æ–‡ç« è¯¦æƒ…"
        }
      }
    ]
  }
]
```

é¡µé¢æ ·å¼ä¸åŸºç¡€é€»è¾‘

```vue
<template>
  <view class="detail" v-show="page._id" @click.stop="showReply = false">
    <view class="header title">
      {{page.title}}
    </view>
    <view class="content">
      <view class="user u-flex">
        <u-image class="photo" :src="page.uid.pic" error-icon="/static/images/header.jpg" width="72" height="72" />
        <view class="user-column u-flex-1">
          <span class="name">{{page.uid.name}}</span>
          <span class="label">{{ page.created | moment }}</span>
        </view>
      </view>
      <u-parse :html="page.content">
        <view class="title"></view>
      </u-parse>
    </view>
    <view class="comments" :style="{'padding-bottom': paddingHeight + 'px'}">
      <view class="title">è¯„è®º</view>
      <view class="item" v-for="(item) in comments" :key="item._id">
        <view class="u-flex u-col-center">
          <view class="user u-flex-1">
            <u-image class="photo" :src="item.cuid.pic" error-icon="/static/images/header.jpg" width="72" height="72" />
            <view class="user-column u-flex-1">
              <span class="name">{{ item.cuid.name }}</span>
              <span class="label">{{ item.created | moment }} å›å¤äº†ä½ </span>
            </view>
          </view>
          <view class="u-flex u-col-center add-hand">
            <view class="reply" :class="{'active': item.handed === '1'}" @click="hand(item)">
              <u-icon name="thumb-up-fill" size="30" v-if="item.handed === '1'"></u-icon>
              <u-icon name="thumb-up" size="30" v-else></u-icon>
              <text>{{item.hands}}</text>
            </view>
            <view v-if="isOwner">
              <view class="caina" v-if="item.isBest === '1'">
                <u-icon name="yicaina" custom-prefix="iconfont" size="70" color="#58a571"></u-icon>
              </view>
              <view class="setBest" v-else-if="parseInt(page.isEnd) === 0 && parseInt(item.isBest) === 0" @click="setBest(item)">
                <u-icon name="caina" custom-prefix="iconfont" size="32"></u-icon>
              </view>
            </view>
          </view>
        </view>
        <view class="comments-content">{{item.content}}</view>
      </view>
      <view v-if="comments.length === 0">
        <view v-if="!loading" class="info">
          æš‚æ— è¯„è®ºï¼Œèµ¶ç´§æ¥æŠ¢æ²™å‘å§~~~
        </view>
        <view class="flex-center-center loading" v-else>
          <u-loading class="loading-icon" mode="circle"></u-loading>
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
      </view>
    </view>
    <view class="footer">
      <view class="box u-flex u-col-center" v-if="!showReply">
        <view class="add-comment" @click.stop="reply()">
          <u-icon name="edit-pen" size="32" color="#cccccc"></u-icon>
          <text class="text">å†™è¯„è®º</text>
        </view>
        <view class="ctrls u-flex u-col-center u-row-between">
          <view class="comment u-flex flex-column">
            <u-icon name="chat" size="45"></u-icon>
            <text>è¯„è®º{{ page.answer > 0 ? page.answer : ''}}</text>
          </view>
          <view class="fav u-flex flex-column" :class="{'active': page.isFav === 1}" @click="setCollect">
            <u-icon name="star-fill" size="45" v-if="page.isFav === 1"></u-icon>
            <u-icon name="star" size="45" v-else></u-icon>
            <text>{{page.isFav === 1 ? 'å·²æ”¶è—': 'æ”¶è—'}}</text>
          </view>
          <view class="like u-flex flex-column" :class="{'active': page.isHand === 1}" @click="handsPost">
            <u-icon name="thumb-up-fill" size="45" v-if="page.isHand === 1"></u-icon>
            <u-icon name="thumb-up" size="45" v-else></u-icon>
            <text>{{page.isHand === 1 ? 'å·²ç‚¹èµ' : 'ç‚¹èµ'}}</text>
          </view>
        </view>
      </view>
      <view class="box u-flex u-col-center" v-else>
        <u-input v-model="content" class="reply" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹" focus @clear="clear"></u-input>
        <button type="primary" plain size="mini" @click.stop="send">å‘é€</button>
      </view>
    </view>
  </view>
</template>

<script>
import { mapGetters, mapState } from 'vuex'
import { checkToken } from '@/common/checkAuth'

export default {
  components: {},
  data: () => ({
    page: {},
    comments: [],
    params: {
      page: 0,
      limit: 10,
      tid: ''
    },
    content: '',
    showReply: false,
    height: 0,
    paddingHeight: 60,
    loading: false
  }),
  computed: {
    ...mapState(['userInfo']),
    ...mapGetters(['isLogin']),
    isCollect () {
      return typeof this.page.isFav !== 'undefined' && this.page.isFav === 1
    },
    isOwner () {
      let flag = false
      if (this.page.uid && typeof this.page.uid !== 'undefined' && typeof this.userInfo._id !== 'undefined') {
        flag = this.page.uid._id === this.userInfo._id
      }
      return flag
    }
  },
  methods: {
    check: checkToken,
    async getReply () {
      const { data } = await this.$u.api.getComents(this.params)
      const arr = data.reverse()
      if (this.params.page === 0) {
        this.comments = arr
      } else {
        this.comments = [...this.comments, ...arr]
      }
      this.page.answer = this.comments.length || 0
    },
    async handsPost () {
      // æ–‡ç« ç‚¹èµ
    },
    async hand (item) {
      // è¯„è®ºç‚¹èµ
      if (!this.check()) return
      const { msg, data, code } = await this.$u.api.setHands({ cid: item._id })
      if (code === 200 && data) {
        item.handed = '1'
        item.hands++
      } else {
        uni.showToast({
          icon: 'none',
          title: msg,
          duration: 2000
        })
      }
    },
    async setCollect () {
      // è®¾ç½®æ”¶è—
      if (!this.check()) return
      const { msg, isCollect } = await this.$u.api.addCollect({ tid: this.params.tid, isFav: this.isCollect ? 1 : 0 })
      if (isCollect) {
        this.page.isFav = 1
      } else {
        this.page.isFav = 0
      }
      uni.showToast({
        icon: 'none',
        title: msg,
        duration: 2000
      })
    },
    reply () {
      if (!this.check()) return
      this.showReply = true
    },
    async send () {
      // å¾®ä¿¡è¯„è®º
    },
    setBest (item) {
      // è®¾ç½®æœ€ä½³
    },
    onShareAppMessage () {
      // å¾®ä¿¡åˆ†äº«
    }
  },
  watch: {},
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åŠ è½½
  async onLoad (options) {
    this.loading = true
    const { tid } = options
    this.params.tid = tid
    const { data } = await this.$u.api.getDetail({ tid })
    this.page = data
    await this.getReply()
    this.loading = false
  },
  // é¡µé¢å‘¨æœŸå‡½æ•°--ç›‘å¬é¡µé¢åˆæ¬¡æ¸²æŸ“å®Œæˆ
  onPullDownRefresh () {
    uni.stopPullDownRefresh()
  },
  // é¡µé¢å¤„ç†å‡½æ•°--ç›‘å¬ç”¨æˆ·ä¸Šæ‹‰è§¦åº•
  onReachBottom () {}
  // é¡µé¢å¤„ç†å‡½æ•°--ç›‘å¬é¡µé¢æ»šåŠ¨(not-nvue)
  /* onPageScroll(event) {}, */
  // é¡µé¢å¤„ç†å‡½æ•°--ç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
  /* onShareAppMessage(options) {}, */
}
</script>

<style lang="scss">
.detail {
  background: #f4f6f8;
  min-height: 100vh;
}

.header,
.content,
.comments {
  background: #fff;
  padding: 32rpx;
}

.header,
.content {
  margin-bottom: 24rpx;
  box-shadow: 0 5rpx 5px rgba($color: black, $alpha: 0.1);
}

.add-hand {
  position: relative;
  .caina {
    position: absolute;
    right: 100rpx;
    top: -20rpx;
  }
  .setBest {
    padding-left: 25rpx;
  }
}

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100vw;
  padding: 20rpx 32rpx;
  background-color: #fff;
  // height: 100rpx;
  box-shadow: 0 -5rpx 5px rgba($color: black, $alpha: 0.1);
  .box {
    width: 100%;
  }
  .reply {
    flex: 1;
    border: 1px solid #eee;
    padding: 0 15rpx;
    margin-right: 15rpx;
  }
}

.title {
  font-size: 32rpx;
  color: #333;
  font-weight: bold;
}

.user {
  display: flex;
  align-items: center; /* å‚ç›´å±…ä¸­ */
  margin-right: 20rpx;
  .name {
    margin-bottom: 10rpx;
    font-size: 28rpx;
    font-family: PingFang SC;
    font-weight: bold;
    color: rgba(51, 51, 51, 1);
    white-space: nowrap;
    max-width: 420rpx;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .photo {
    width: 72rpx;
    height: 72rpx;
    border-radius: 50%;
  }
  .user-column {
    display: flex;
    flex-direction: column;
    margin-left: 20rpx;
  }
  .label {
    font-size: 22rpx;
    font-family: PingFang SC;
    font-weight: 500;
    color: rgba(153, 153, 153, 1);
  }
}

.comments {
  .item {
    padding: 24rpx 0;
    .comments-content {
      padding-top: 32rpx;
    }
    .reply {
      text {
        padding-left: 10rpx;
      }
      &.active {
        color: $u-type-primary;
      }
    }
  }
  .info {
    font-size: 28rpx;
    color: #666;
    line-height: 90rpx;
    text-align: center;
  }
}

.ctrls {
  color: #999;
  font-size: 22rpx;
  width: 35%;
  .fav,
  .like {
    &.active {
      color: $u-type-primary;
    }
  }
}

.add-comment {
  background: #f3f3f3;
  height: 64rpx;
  border-radius: 32rpx;
  line-height: 64rpx;
  padding: 0 32rpx;
  width: 65%;
  margin-right: 40rpx;
  color: #ccc;
  .text {
    padding-left: 10rpx;
  }
}

.loading {
  height: 50px;
  .loading-text {
    padding-left: 15rpx;
  }
}
</style>
```

App.vueé¡µé¢ä¸­æ·»åŠ å…¬å…±æ ·å¼ï¼š

```scss
.flex-column {
  flex-direction: column;
}
```

è°ƒæ•´apiæ¥å£ï¼š

```js
// è·å–æ–‡ç« ä¸­çš„è¯„è®ºåˆ—è¡¨
const getComents = (params) => {
  const token = store.state.token
  let headers = {}
  if (token !== '') {
    headers = {
      headers: {
        Authorization: 'Bearer ' + store.state.token
      }
    }
  }
  return axios.get('/public/comments', params, headers)
}

// è·å–æ–‡ç« è¯¦æƒ…
const getDetail = (data) => {
  const token = store.state.token
  let headers = {}
  if (token !== '') {
    headers = {
      headers: {
        Authorization: 'Bearer ' + store.state.token
      }
    }
  }
  return axios.get('/public/content/detail', data, headers)
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/06-æ–‡ç« è¯¦æƒ….html#é•¿å±é€‚é…æ–¹æ¡ˆ)é•¿å±é€‚é…æ–¹æ¡ˆ

å®‰å…¨åŒºåŸŸæŒ‡çš„æ˜¯ä¸€ä¸ªå¯è§†çª—å£èŒƒå›´ï¼Œå¤„äºå®‰å…¨åŒºåŸŸçš„å†…å®¹ä¸å—åœ†è§’ï¼ˆcornersï¼‰ã€é½åˆ˜æµ·ï¼ˆsensor housingï¼‰ã€å°é»‘æ¡ï¼ˆHome Indicatorï¼‰å½±å“ï¼Œå¦‚ä¸‹å›¾è“è‰²åŒºåŸŸï¼š

![img](uniapp.assets/iphonex_4.7d2b50ea.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦åšå¥½é€‚é…ï¼Œå¿…é¡»ä¿è¯é¡µé¢å¯è§†ã€å¯æ“ä½œåŒºåŸŸæ˜¯åœ¨å®‰å…¨åŒºåŸŸå†…ã€‚

è§£å†³æ–¹æ¡ˆenv() å’Œ constant()ï¼š

iOS11 æ–°å¢ç‰¹æ€§ï¼ŒWebkit çš„ä¸€ä¸ª CSS å‡½æ•°ï¼Œç”¨äºè®¾å®šå®‰å…¨åŒºåŸŸä¸è¾¹ç•Œçš„è·ç¦»ï¼Œæœ‰å››ä¸ªé¢„å®šä¹‰çš„å˜é‡ï¼š

* safe-area-inset-leftï¼šå®‰å…¨åŒºåŸŸè·ç¦»å·¦è¾¹è¾¹ç•Œè·ç¦»
* safe-area-inset-rightï¼šå®‰å…¨åŒºåŸŸè·ç¦»å³è¾¹è¾¹ç•Œè·ç¦»
* safe-area-inset-topï¼šå®‰å…¨åŒºåŸŸè·ç¦»é¡¶éƒ¨è¾¹ç•Œè·ç¦»
* safe-area-inset-bottomï¼šå®‰å…¨åŒºåŸŸè·ç¦»åº•éƒ¨è¾¹ç•Œè·ç¦»

è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ safe-area-inset-bottom è¿™ä¸ªå˜é‡ï¼Œå› ä¸ºå®ƒå¯¹åº”çš„å°±æ˜¯å°é»‘æ¡çš„é«˜åº¦ï¼ˆæ¨ªç«–å±æ—¶å€¼ä¸ä¸€æ ·ï¼‰ã€‚

> æ³¨æ„ï¼šå½“ viewport-fit=contain æ—¶ env() æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œå¿…é¡»è¦é…åˆ viewport-fit=cover ä½¿ç”¨ã€‚å¯¹äºä¸æ”¯æŒenv() çš„æµè§ˆå™¨ï¼Œæµè§ˆå™¨å°†ä¼šå¿½ç•¥å®ƒã€‚

åœ¨è¿™ä¹‹å‰ï¼Œç¬”è€…ä½¿ç”¨çš„æ˜¯ constant()ï¼Œåæ¥ï¼Œå®˜æ–¹æ–‡æ¡£åŠ äº†è¿™ä¹ˆä¸€æ®µæ³¨é‡Šï¼ˆå‘ï¼‰ï¼š

> The env() function shipped in iOS 11 with the name constant(). Beginning with Safari Technology Preview 41 and the iOS 11.2 beta, constant() has been removed and replaced with env(). You can use the CSS fallback mechanism to support both versions, if necessary, but should prefer env() going forward.

è¿™å°±æ„å‘³ç€ï¼Œä¹‹å‰ä½¿ç”¨çš„ constant() åœ¨ iOS11.2 ä¹‹åå°±ä¸èƒ½ä½¿ç”¨çš„ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯éœ€è¦åšå‘åå…¼å®¹ï¼Œåƒè¿™æ ·ï¼š

```javascript
padding-bottom: constant(safe-area-inset-bottom); /* å…¼å®¹ iOS < 11.2 */
padding-bottom: env(safe-area-inset-bottom); /* å…¼å®¹ iOS >= 11.2 */
```

æ³¨æ„ï¼šenv() è·Ÿ constant() éœ€è¦åŒæ—¶å­˜åœ¨ï¼Œè€Œä¸”é¡ºåºä¸èƒ½æ¢ã€‚

æ›´è¯¦ç»†è¯´æ˜ï¼Œå‚è€ƒæ–‡æ¡£ï¼š [Designing Websites for iPhone X(opens new window)](https://webkit.org/blog/7929/designing-websites-for-iphone-x/?hmsr=funteas.com&utm_medium=funteas.com&utm_source=funteas.com)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/06-æ–‡ç« è¯¦æƒ….html#é¡µé¢åˆ†äº«è®¾ç½®)é¡µé¢åˆ†äº«è®¾ç½®

ä¸é¡µé¢åˆ†äº«ç›¸å…³çš„uniappçš„APIæœ‰ä¸¤ä¸ªï¼š

* [uni.share(OBJECT) (opens new window)](https://uniapp.dcloud.io/api/plugins/share?id=share)â€”â€” é’ˆå¯¹äºAppåˆ†äº«åˆ°å¾®ä¿¡ã€QQã€å¾®åš
* [onShareAppMessage(OBJECT) (opens new window)](https://uniapp.dcloud.io/api/plugins/share?id=onshareappmessage)â€”â€” é’ˆå¯¹äºå°ç¨‹åºçš„é¡µé¢çš„åˆ†äº«

å°ç¨‹åºä¸­ç”¨æˆ·ç‚¹å‡»åˆ†äº«åï¼Œåœ¨ js ä¸­å®šä¹‰ onShareAppMessage å¤„ç†å‡½æ•°ï¼ˆå’Œ onLoad ç­‰ç”Ÿå‘½å‘¨æœŸå‡½æ•°åŒçº§ï¼‰ï¼Œè®¾ç½®è¯¥é¡µé¢çš„åˆ†äº«ä¿¡æ¯ã€‚

* ç”¨æˆ·ç‚¹å‡»åˆ†äº«æŒ‰é’®çš„æ—¶å€™ä¼šè°ƒç”¨ã€‚è¿™ä¸ªåˆ†äº«æŒ‰é’®å¯èƒ½æ˜¯å°ç¨‹åºå³ä¸Šè§’åŸç”Ÿèœå•è‡ªå¸¦çš„åˆ†äº«æŒ‰é’®ï¼Œä¹Ÿå¯èƒ½æ˜¯å¼€å‘è€…åœ¨é¡µé¢ä¸­æ”¾ç½®çš„åˆ†äº«æŒ‰é’®ï¼ˆ`<button open-type="share">`ï¼‰ï¼›
* æ­¤äº‹ä»¶éœ€è¦ return ä¸€ä¸ªObjectï¼Œç”¨äºè‡ªå®šä¹‰åˆ†äº«å†…å®¹ã€‚

å¾®ä¿¡å°ç¨‹åºå¹³å°çš„åˆ†äº«ç®¡ç†æ¯”è¾ƒä¸¥æ ¼ï¼Œè¯·å‚è€ƒ [å°ç¨‹åºåˆ†äº«æŒ‡å¼• (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/share.html)ã€‚

åœ¨è¯¦æƒ…é¡µé¢ä¸­åŠ å…¥`onShareAppMessage`æ–¹æ³•ï¼š

```js
onShareAppMessage () {
  // å¾®ä¿¡åˆ†äº« -> è¿™ä¸ªåˆ†äº«å•ä¸€çš„å¥½å‹
  return {
    title: this.page.title,
    path: '/subcom-pkg/detail/detail?tid=' + this.params.tid
  }
}
```

> ç›®å‰ï¼Œå¾®ä¿¡å®˜æ–¹æ²¡æœ‰æä¾›æ­£å¼çš„æœ‹å‹åœˆåˆ†äº«çš„åŠŸèƒ½ï¼Œåªæ˜¯åœ¨androidè®¾å¤‡ä¸Šè¿›è¡Œbetaæµ‹è¯•ï¼Œå‚è€ƒè¯´æ˜ï¼šhttps://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html#onShareTimeline
>
> ![image-20210802212601310](uniapp.assets/image-20210802212601310.a2267358.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/06-æ–‡ç« è¯¦æƒ….html#å¯Œæ–‡æœ¬æ˜¾ç¤º)å¯Œæ–‡æœ¬æ˜¾ç¤º

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/06-æ–‡ç« è¯¦æƒ….html#é«˜äº®æ–¹æ¡ˆä¸€-è‡ªå®šä¹‰çš„highlightç»„ä»¶)é«˜äº®æ–¹æ¡ˆä¸€ï¼šè‡ªå®šä¹‰çš„highlightç»„ä»¶

æ­¥éª¤ï¼š

* å®šä¹‰highlight.vueç»„ä»¶ï¼›
* å®‰è£…prismjsåº“ï¼Œå¹¶ä½¿ç”¨tokenizeæ–¹æ³•è¿›è¡Œæ‹†åˆ†htmlå­—ç¬¦ä¸²ï¼›
* ä½¿ç”¨normalizeåº“è¿›è¡Œè½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„ï¼›

å®‰è£…ä¾èµ–ï¼š

```text
npm i prismjs
```

è‡ªå®šä¹‰çš„`highlight.vue`ç»„ä»¶

```vue
<template>
  <view class="highlight">
    <scroll-view scroll-x>
      <view v-for="(line,i) in tokenLines" :key="i" class="lines">
        <!-- è¡Œæ•° -->
        <text class="line-number">{{i+1}}</text>
        <!-- ä»£ç å— -->
        <text v-for="(token,index) in line" :key="index" :class="'token--' + token.type">{{token.content}}</text>
      </view>
    </scroll-view>
  </view>
</template>

<script>
import Prism from 'prismjs'
import normalize from '@/common/utils/normalize'

// const code = `
// <template>
//   <view class="list-item">
//     <view class="list-head">
//       <!-- æ ‡é¢˜éƒ¨åˆ† -->
//       <text class="type" :class="['type-'+item.catalog]">{{tabs.filter(o => o.key === item.catalog)[0].value}}</text>
//       <text class="title">{{item.title}}</text>
//     </view>
//     <!-- ç”¨æˆ·éƒ¨åˆ† -->
//     <view class="author u-flex u-m-b-18">
//       <u-image :src="item.uid.pic" class="head" width="40" height="40" shape="circle" error-icon="/static/images/header.jpg"></u-image>
//       <text class="name u-m-l-10">{{item.uid.name}}</text>
//     </view>
//     <!-- æ‘˜è¦éƒ¨åˆ† + å³ä¾§çš„å›¾ç‰‡ -->
//     <view class="list-body u-m-b-30 u-flex u-col-top">
//       <view class="info u-m-r-20 u-flex-1">{{item.content}}</view>
//       <image class="fmt" :src="item.snapshot" v-if="item.snapshot" mode="aspectFill" />
//     </view>
//     <!-- å›å¤ + æ–‡ç« å‘è¡¨çš„æ—¶é—´ -->
//     <view class="list-footer u-flex">
//       <view class="left">
//         <text class="reply-num u-m-r-25">{{item.answer}} å›å¤</text>
//         <text class="timer">{{item.created | moment}}</text>
//       </view>
//     </view>
//   </view>
// </template>
// `
export default {
  props: {
    code: {
      type: String,
      default: ''
    },
    language: {
      type: String,
      default: 'js'
    }
  },
  data: () => ({
  }),
  computed: {
    tokenLines () {
      const result = normalize(Prism.tokenize(this.code, Prism.languages[this.language]))
      // console.log('ğŸš€ ~ file: highlight.vue ~ line 54 ~ tokenLines ~ result', result)
      return result
    }
  },
  methods: {}
}
</script>

<style lang="scss" scoped>
.intro {
  margin: 30px;
  text-align: center;
}

:host {
  text-align: left;
  font-family: consolas, monospace;
  line-height: 1.44;
  white-space: nowrap;
}

.lines {
  display: flex;
  flex-flow: row nowrap;
  width: 100%;
  align-items: center;
  justify-content: flex-start;
}

.line-number {
  display: inline-block;
  flex-shrink: 0;
  border-right: 4px solid #d8d8d8;
  min-width: 55px;
  text-align: right;
  margin-right: 10px;
  padding-right: 10px;
  color: #888;
  &.max {
    width: 110px;
  }
}

.token {
  color: #333;
  white-space: pre;
}

.token--plain,
.token--string {
  white-space: pre;
}

.token--keyword {
  color: #00f;
}

.token--number {
  color: #09885a;
}

.token--string {
  color: #a31515;
}

.token--regex {
  color: #811f3f;
}

.token--comment {
  color: #008000;
}
</style>
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/06-æ–‡ç« è¯¦æƒ….html#é«˜äº®æ–¹æ¡ˆäºŒ-wxparse)é«˜äº®æ–¹æ¡ˆäºŒï¼šwxParse

æ•ˆæœå±•ç¤ºï¼š

![img](uniapp.assets/image-20210803112201381.b1453768.png) ![img](uniapp.assets/image-20210803112237505.ba04d822.png)

* 1.å°†`prism.css`é‡å‘½åä¸º`prism.wxss`
* 2.å¤åˆ¶`prism.js`å’Œ`prism.wxss`è‡³`utils`æ–‡ä»¶å¤¹ä¸‹
* 3.æ›¿æ¢`prism.wxss`ä¸­çš„`code[class*="language-"]`ä¸º`.wxParse-code[class*="language-"]`
* 4.`wxParse.wxss`ä¸­å¼•ç”¨`prism.wxss`

```css
@import "../utils/prism.wxss";
```

* 5.æ–°å¢`highlight.js`é«˜äº®å·¥å…·ç±»ï¼ˆä»£ç æ”¾ç½®åœ¨wxParseæ–‡ä»¶å¤¹ä¸‹ï¼‰

```js
var Prism = require('../utils/prism.js')
function highlight(data, that) {
  // Prism æ‰€æ”¯æŒçš„ä»£ç è¯­è¨€æ•°ç»„
  let langArr = new Array();
  langArr = listLanguages();
  // console.log('all-language:'+langArr)
  let html = data;
  //åŒ¹é…åˆ°çš„æ‰€æœ‰æ ‡ç­¾<\/code>
  let tagArr = data.match(/<\/?code[^>]*>/g);
  if (tagArr == null) {
    return html;// å¦‚æœæ²¡æœ‰ pre æ ‡ç­¾å°±ç›´æ¥è¿”å›åŸæ¥çš„å†…å®¹ï¼Œä¸åšä»£ç é«˜äº®å¤„ç†
  }
  //è®°å½•æ¯ä¸€ä¸ª code æ ‡ç­¾åœ¨dataä¸­çš„ç´¢å¼•ä½ç½®
  let indexArr = [];
  //è®¡ç®—ç´¢å¼•ä½ç½®
  for (let i = 0; i < tagArr.length; i++) {
    //æ·»åŠ ç´¢å¼•å€¼
    if (i == 0) {
      indexArr.push(data.indexOf(tagArr[i]));
    }
    else {
      indexArr.push(data.indexOf(tagArr[i], indexArr[i - 1]));
    }
  }

  //è®°å½•åŸºæœ¬çš„classä¿¡æ¯
  let cls;

  // å¼€å§‹å¾ªç¯å¤„ç† code æ ‡ç­¾
  let i = 0;
  while (i < tagArr.length - 1) {// è¿™é‡Œå‡ä¸€æ˜¯å› ä¸ºä¸å¤„ç†æœ€åçš„ code æ ‡ç­¾
    // è°ƒç”¨å‡½æ•°æ¥è·å– class ä¿¡æ¯
    getStartInfo(tagArr[i])
    // è·å–æ ‡ç­¾çš„å€¼
    var label = tagArr[i].match(/<*([^> ]*)/)[1];
    // console.log('label:'+label)
    if (tagArr[i + 1] === '</' + label + '>') {//åˆ¤æ–­ç´§è·Ÿå®ƒçš„ä¸‹ä¸€ä¸ªæ ‡ç­¾æ˜¯å¦ä¸ºå®ƒçš„é—­åˆæ ‡ç­¾
      if (label === 'code') {
        // ä»£ç è¯­è¨€åˆ¤æ–­,æ ¹æ®ç±»è¿›è¡Œåˆ¤æ–­ï¼Œè‡ªå®šä¹‰ï¼Œæ¯”å¦‚ lang-è¯­è¨€,language-è¯­è¨€ã€‚
        let lang = cls.split(' ')[0];
        if (/lang-(.*)/i.test(lang)) {// ä»£ç è¯­è¨€å®šä¹‰æ˜¯ lang-XXX çš„æ ·å¼
          lang = lang.replace(/lang-(.*)/i, '$1');
        }
        else if (/languages?-(.*)/i.test(lang)) {
          lang = lang.replace(/languages?-(.*)/i, '$1');// ä»£ç è¯­è¨€å®šä¹‰æ˜¯ language(s)-XXX çš„æ ·å¼
        }
        // å¦‚æœä»£ç è¯­è¨€ä¸åœ¨ Prism å­˜åœ¨çš„è¯­è¨€ï¼Œæˆ–è€… class å€¼æ˜¯ nullï¼Œåˆ™ä¸æ‰§è¡Œä»£ç é«˜äº®å‡½æ•°
        if (langArr.indexOf(lang) == -1 || lang == null || lang == 'none' || lang == 'null') {
        }
        else {
          // è·å–ä»£ç æ®µå†…å®¹ä¸º code
          let code = data.substring(indexArr[i], indexArr[i + 1]).replace(/<code[^>]*>/, '');

          // æ‰§è¡Œ Prism çš„ä»£ç é«˜äº®å‡½æ•°
          let hcode = Prism.highlight(code, Prism.languages[lang], lang);
          html = html.replace(code, hcode);
        }

      }
      // æŒ‡å‘ä¸‹ä¸€ä¸ªæ ‡ç­¾ï¼ˆé—­åˆæ ‡ç­¾ï¼‰ç´¢å¼•
      i++;
    } else {
      //onsole.log('ä¸æ˜¯é—­åŒ…')
    }
    // æŒ‡å‘ä¸‹ä¸€ä¸ªæ ‡ç­¾ï¼ˆå¼€å§‹æ ‡ç­¾ï¼‰çš„ç´¢å¼•
    i++;
  }
  return html;

  function getStartInfo(str) {
    cls = matchRule(str, 'class');
  }

  //è·å–éƒ¨åˆ†å±æ€§çš„å€¼
  function matchRule(str, rule) {
    let value = '';
    let re = new RegExp(rule + '=[\'"]?([^\'"]*)');
    //console.log('regexp:'+re)
    if (str.match(re) !== null) {
      value = str.match(re)[1];
      //console.log('value:'+value)
    }
    return value;
  }


  // åˆ—å‡ºå½“å‰ Prism.js ä¸­å·²æœ‰çš„ä»£ç è¯­è¨€ï¼Œå¯ä»¥è‡ªå·±åœ¨ Prism çš„ä¸‹è½½é¡µé¢é€‰æ‹©æ›´å¤šçš„è¯­è¨€ã€‚
  function listLanguages() {
    var langs = new Array();
    let i = 0;
    for (let language in Prism.languages) {
      if (Object.prototype.toString.call(Prism.languages[language]) !== '[object Function]') {
        langs[i] = language;
        i++;
      }
    }
    return langs;
  }
}

module.exports = {
  highlight: highlight
};
```

* 6.åœ¨`wxParse`æ–‡ä»¶å¤¹ä¸‹çš„`html2json.js`ä¸­å¼•ç”¨`highlight.js`å·¥å…·ç±»çš„`highligh`é«˜äº®å‡½æ•°

```js
//å¼•ç”¨`highlight.js`å·¥å…·ç±»
var highlight = require('./highlight.js');

function html2json(html, bindName, that) {
    html = removeDOCTYPE(html);
    html = trimHtml(html);
    html = wxDiscode.strDiscode(html);
    //å¼•ç”¨é«˜äº®å‡½æ•°
    html = highlight.highlight(html, that); 

    //çœç•¥äº†åç»­ä»£ç 
    ...

}
```

å‚è€ƒé“¾æ¥ ï¼š

https://blog.sunriseydy.top/technology/server-blog/wordpress/wordpress-miniapp-code-highlight

https://blog.csdn.net/qq_41107410/article/details/89042212



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#å®‰å…¨åŸŸåç›¸å…³)å®‰å…¨åŸŸåç›¸å…³

å¾®ä¿¡å°ç¨‹åºçš„å®‰å…¨åŸŸåå¿…é¡»æ˜¯HTTPSï¼ŒåŒæ—¶å¿…é¡»æ˜¯åœ¨å›½å†…ICPå¤‡æ¡ˆçš„åŸŸåï¼Œæœ¬ç« æ¥ä»‹ç»å¦‚ä½•ä½¿ç”¨acme.sh+nginxé…ç½®httpsä¸ç”³è¯·SSLè¯ä¹¦ã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#sslè¯ä¹¦ç”³è¯·)SSLè¯ä¹¦ç”³è¯·

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#å‰ç½®å‡†å¤‡)å‰ç½®å‡†å¤‡

* ç”³è¯·åŸŸåï¼šé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰å„å®¶äº‘æœåŠ¡å•†ï¼›

* æœ‰ä¸€å°äº‘ä¸»æœºï¼Œæœ‰å…¬ç½‘çš„IPï¼Œæœ€å¥½è¿›è¡Œè¿‡å¤‡æ¡ˆï¼›å¦‚æœæ²¡æœ‰å›½å†…çš„æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ³¨å†Œä¸€å°å›½å¤–çš„æœåŠ¡å™¨ï¼Œåœ°å€1ï¼š[æ¬ç“¦å·¥ (opens new window)](https://bwh81.net/aff.php?aff=6389)ï¼Œåœ°å€2ï¼š[vultr (opens new window)](https://www.vultr.com/?ref=6862890)ï¼›

* äº‘ä¸»æœºçš„æ“ä½œç³»ç»Ÿï¼šCentos 7+ï¼ˆä»¥ä¸‹æ‰€æœ‰æ¼”ç¤ºå†…å®¹ï¼Œå‡ä¸ºCentos 7ï¼‰æˆ–è€…Ubuntu 16LTS+ï¼›

* DNSè§£æï¼šDNSpodï¼Œcloudflareï¼›

  é…ç½®åŸŸåè¿›è¡Œè§£æï¼š

  ![image-20210810145545806](uniapp.assets/image-20210810145545806.a0e07748.png)

  ä½¿ç”¨Aè®°å½•ï¼Œé…ç½®è‡ªå·±çš„åŸŸå -> è‡ªå·±çš„äº‘ä¸»æœºIP

  ä½¿ç”¨pingå‘½ä»¤æ£€æŸ¥ æ˜¯å¦å·²ç»ç½‘ç»œé€šäº†ï¼š

  ![image-20210810145801200](uniapp.assets/image-20210810145801200.cc140063.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#æ•´ä½“æ¶æ„)æ•´ä½“æ¶æ„

é…ç½®æ¶æ„å›¾ï¼š

![image-20210810144327946](uniapp.assets/image-20210810144327946.bbb98c11.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#åŸºæœ¬æ­¥éª¤)åŸºæœ¬æ­¥éª¤

å€ŸåŠ©[acme.sh (opens new window)](https://github.com/acmesh-official/acme.sh/wiki/è¯´æ˜)è¿›è¡Œç”³è¯·SSLè¯ä¹¦ï¼Œä»¥ä¾¿å¾®ä¿¡æ¥å£éƒ¨åˆ†çš„ä½¿ç”¨ï¼Œä¸‹é¢æ¼”ç¤ºçš„æ˜¯DNSpodè¿›è¡Œè¯ä¹¦ç”³è¯·çš„è¿‡ç¨‹ã€‚

**ä¸»è¦æ­¥éª¤ï¼š**

å‰ç½®ï¼šä½¿ç”¨sshå‘½ä»¤è¿æ¥åˆ°æœåŠ¡å™¨ ->

1. å®‰è£… **acme.sh**

2. ç”Ÿæˆè¯ä¹¦ â€”â€”[æ¨èDNSçš„æ–¹å¼(opens new window)](https://github.com/acmesh-official/acme.sh/wiki/dnsapi)

   > æ”¯æŒçš„DNSåˆ—è¡¨ï¼š[https://github.com/acmesh-official/acme.sh/tree/master/dnsapi(opens new window)](https://github.com/acmesh-official/acme.sh/tree/master/dnsapi)

3. copy è¯ä¹¦åˆ° nginx/apache æˆ–è€…å…¶ä»–æœåŠ¡

4. æ›´æ–°è¯ä¹¦

5. æ›´æ–° **acme.sh**

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#acme-shå®‰è£…)acme.shå®‰è£…

å®‰è£…å¾ˆç®€å•, ä¸€ä¸ªå‘½ä»¤:

```text
curl  https://get.acme.sh | sh -s email=my@example.com
```

![image-20210810145930893](uniapp.assets/image-20210810145930893.237427d0.png)

å†æ¬¡æ‰“å¼€ä¸€ä¸ªæ–°çš„sshç»ˆç«¯ï¼Œä½¿ç”¨`crontab -e`(Centos)æŸ¥çœ‹`acme.sh`è‡ªåŠ¨åˆ›å»ºçš„å®šæ—¶ä»»åŠ¡ï¼š

![image-20210810150236024](uniapp.assets/image-20210810150236024.e82227d2.png)

è¾“å…¥`i`è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œè°ƒæ•´å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä½¿ç”¨`:wq`é€€å‡ºã€‚

> PSï¼šä¸Šé¢çš„é…ç½®æ˜¯æ¯å¤©çš„0ç‚¹23åˆ†å»æ‰§è¡Œä¸€æ¬¡è„šæœ¬ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#é…ç½®dnså¯†é’¥)é…ç½®DNSå¯†é’¥

ä¸‹é¢ä»‹ç»äº†DNSpodã€é˜¿é‡Œäº‘ã€Cloudflareçš„é…ç½®è¿‡ç¨‹ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„äº‘æœåŠ¡å•†é€‰æ‹©ï¼Œè¿‡ç¨‹ç±»ä¼¼ã€‚

#### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#dnspod)DNSpod

* é€‰æ‹©å¯†é’¥ç®¡ç†ï¼š

  ![image-20210810150640094](uniapp.assets/image-20210810150640094.3d656e26.png)

* åˆ›å»ºå¯†é’¥

  ![image-20210810150731394](uniapp.assets/image-20210810150731394.b27888e3.png)

* è®°å½•ä¸‹æ¥ï¼Œåç»­ä½¿ç”¨ï¼š

  ![image-20210810150751582](uniapp.assets/image-20210810150751582.43ca872b.png)

é…ç½®å¯†é’¥ï¼š

```sh
export DPI_Id="1234"
export DPI_Key="sADDsdasdgdsf"
```

#### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#é˜¿é‡Œäº‘)é˜¿é‡Œäº‘

ç‚¹å‡»ï¼š[https://ak-console.aliyun.com/#/accesskey (opens new window)](https://ak-console.aliyun.com/#/accesskey)ï¼Œç”³è¯·å¯†é’¥ï¼š

![image-20210810151001761](uniapp.assets/image-20210810151001761.9040174d.png)

é€‰æ‹©`ç¼–ç¨‹è®¿é—®`ï¼š

![image-20210810151252035](uniapp.assets/image-20210810151252035.d404c680.png)

ç”ŸæˆaccessKeyä¸å¯†é’¥ï¼š

![image-20210810151319187](uniapp.assets/image-20210810151319187.d113629f.png)

é…ç½®è¿‡ç¨‹ï¼š

```sh
export Ali_Key="sdfsdfsdfljlbjkljlkjsdfoiwje"
export Ali_Secret="jlsdflanljkljlfdsaklkjflsa"
```

#### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#cloudflare)Cloudflare

é…ç½®[é¡µé¢ (opens new window)](https://dash.cloudflare.com/profile)ï¼š

![image-20210810151518194](uniapp.assets/image-20210810151518194.3045c842.png)

é…ç½®è¿‡ç¨‹ï¼š

```shell
export CF_Key="sdfsdfsdfljlbjkljlkjsdfoiwje"
export CF_Email="xxxx@sss.com"
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#äº§ç”Ÿè¯ä¹¦)äº§ç”Ÿè¯ä¹¦

* Dnspod:

  ```sh
  acme.sh --issue --dns dns_dpi -d example.com -d www.example.com
  ```

* é˜¿é‡Œäº‘ï¼š

  ```sh
  acme.sh --issue --dns dns_ali -d example.com -d www.example.com
  ```

* Cloudflareï¼š

  ```sh
  acme.sh --issue --dns dns_cf -d example.com -d www.example.com
  ```

> æ¨èåŸŸåé€šé…ç¬¦çš„å†™æ³•ï¼šexample.com ä¸ *.example.comï¼Œé‚£ä¹ˆäºŒçº§å­åŸŸåï¼Œå…¨éƒ¨éƒ½å¯ä»¥ä½¿ç”¨httpsã€‚

è¿‡ç¨‹1ï¼š

![image-20210810152354761](uniapp.assets/image-20210810152354761.b8f93ecb.png)

ä¸Šé¢çš„å›¾ç‰‡æ˜¯å±•ç¤ºå‡ºåœ¨å¯¹åŸŸåè¿›è¡Œæ ¡éªŒã€‚

è¿‡ç¨‹2ï¼š

![image-20210810152415177](uniapp.assets/image-20210810152415177.a8f72743.png)

è¯ä¹¦ç”³è¯·æˆåŠŸï¼Œè¯ä¹¦æ‰€åœ¨ä½ç½®ã€‚

```text
cer è‡ªç­¾
key å¯†é’¥
CA ä¸­é—´è¯ä¹¦
æŠŠCAä¸certé“¾æ¥åˆ°ä¸€èµ·çš„è¯ä¹¦ï¼Œè¿™ä¸ªæ˜¯åç»­æ”¾åœ¨nginxä¸Šçš„ï¼Œç”¨äºæœåŠ¡å™¨ä¹‹é—´çš„åå•†
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#nginxé…ç½®)Nginxé…ç½®

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#å‰ç½®å‡†å¤‡-2)å‰ç½®å‡†å¤‡

![image-20210810205823556](uniapp.assets/image-20210810205823556.b18f986b.png)

æ­¥éª¤ï¼š

* å®‰è£…docker,docker-compose -> nginx
* docker-composeæ¥å¯åŠ¨nginx
* åˆ›å»ºä¸€ä¸ªhttps dockerç½‘ç»œ -> å…±äº«ç»™github, jenkins ç­‰éœ€è¦httpsçš„æœåŠ¡
* é…ç½®`nginx.conf`é…ç½®æ–‡ä»¶ï¼Œåˆ›å»º`conf.d`æ–‡ä»¶ç›®å½•ï¼Œå¯ä»¥åˆ›å»ºè™šæ‹ŸåŸŸå`vhost.conf`æ–‡ä»¶
* ä½¿ç”¨è¯ä¹¦å®‰è£…å‘½ä»¤å®‰è£…sslè¯ä¹¦ -> åˆ°æŒ‡å®šçš„ç›®å½•
* `docker-compose up -d`è¿è¡Œnginxå®¹å™¨ -> æµ‹è¯•cronå®šæ—¶ä»»åŠ¡è„šæœ¬

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#è¯ä¹¦å®‰è£…å‘½ä»¤)è¯ä¹¦å®‰è£…å‘½ä»¤

Apacheé…ç½®:

```sh
acme.sh --install-cert -d example.com \
--cert-file      /path/to/certfile/in/apache/cert.pem  \
--key-file       /path/to/keyfile/in/apache/key.pem  \
--fullchain-file /path/to/fullchain/certfile/apache/fullchain.pem \
--reloadcmd     "service apache2 force-reload"
```

Nginxé…ç½®:

```sh
acme.sh --install-cert -d example.com \
--key-file       /path/to/keyfile/in/nginx/key.pem  \
--fullchain-file /path/to/fullchain/nginx/cert.pem \
--reloadcmd     "service nginx force-reload"
```

> `--reloadcmd`å¯ä»¥æŒ‡å®šdockerå®¹å™¨è¿›è¡Œé‡å¯ï¼Œæˆ–è€…æ˜¯æŒ‡å®šè¿è¡Œshellè„šæœ¬ã€‚
>
> æ¯”å¦‚ï¼š
>
> ```
> --reloadcmd "docker restart some-nginx"
> ```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#dhparam-pemè¯ä¹¦)dhparam.pemè¯ä¹¦

åˆ›å»ºä¸€ä¸ªç›®å½•ï¼š`/home/keys`

```text
# ç”Ÿæˆ dhparam.pem æ–‡ä»¶, åœ¨å‘½ä»¤è¡Œæ‰§è¡Œä»»ä¸€æ–¹æ³•:

# æ–¹æ³•1: å¾ˆæ…¢
openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048

# æ–¹æ³•2: è¾ƒå¿«
# ä¸æ–¹æ³•1æ— æ˜æ˜¾åŒºåˆ«. 2048ä½ä¹Ÿè¶³å¤Ÿç”¨, 4096æ›´å¼º
openssl dhparam -dsaparam -out /etc/nginx/ssl/dhparam.pem 4096
```

æŠŠdhparam.pemå¤åˆ¶åˆ°ä¸ªäººSSLè¯ä¹¦å®‰è£…ç›¸åŒçš„ç›®å½•`/home/keys`ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#dockeré…ç½®)dockeré…ç½®

* æ‰‹åŠ¨åˆ›å»ºç½‘ç»œ

  ```text
  docker network create https
  ```

  ![image-20210810210138510](uniapp.assets/image-20210810210138510.dce600c7.png)

  > æŸ¥çœ‹ç½‘ç»œ `docker network ls`
  >
  > æ£€æŸ¥ç½‘ç»œçš„ä¿¡æ¯ `docker network inspect https`

* åˆ›å»º`docker-compose.yml`æ–‡ä»¶

```yaml
version: "3"
services:
  web:
    image: nginx:latest
    container_name: "some-nginx"
    restart: always
    volumes:
      - /home/nginx/nginx.conf:/etc/nginx/nginx.conf
      - /home/nginx/conf.d:/etc/nginx/conf.d
      - /home/keys:/home/keys
      # blog
      # - /home/blog:/var/www
    ports:
      - "80:80"
      - "443:443"

# docker network create https
networks:
  default:
    external:
      name: https
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#nginx-confé…ç½®)nginx.confé…ç½®

```shell
user nginx;
worker_processes auto;
pid /run/nginx.pid;
worker_rlimit_nofile 65535;

events {
	# è®¾ç½®äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œæ˜¯å†…æ ¸2.6ä»¥ä¸Šæ”¯æŒ
	use epoll;
	worker_connections 65535;
	accept_mutex off;
	multi_accept off;
}

http {
	# Basic Settings
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	send_timeout 120;
	keepalive_timeout 300;
	client_body_timeout 300;
	client_header_timeout 120;

	proxy_read_timeout 300;
	proxy_send_timeout 300;
	#tcp_nopush on;
	types_hash_max_size 4096;
	client_header_buffer_size 16m;
	client_max_body_size 4096m;

  # æ·»åŠ nginxçš„é…ç½®æ–‡ä»¶ç›®å½• -> ç”¨æˆ·åæœŸæ·»åŠ vhostæ–‡ä»¶
	include /etc/nginx/mime.types;
	include /etc/nginx/conf.d/*.conf;

	default_type application/octet-stream;
	# Logging Settings
	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;
	log_format main '$remote_addr - $remote_user [$time_local] "$request" '
	'$status $body_bytes_sent "$http_referer" '
	'"$http_user_agent" "$http_x_forwarded_for"';
	
	# å¼€å¯gzip
	gzip on;
	# å¯ç”¨gzipå‹ç¼©çš„æœ€å°æ–‡ä»¶ï¼Œå°äºè®¾ç½®å€¼çš„æ–‡ä»¶å°†ä¸ä¼šå‹ç¼©
	gzip_min_length 1k;
	# gzip å‹ç¼©çº§åˆ«ï¼Œ1-10ï¼Œæ•°å­—è¶Šå¤§å‹ç¼©çš„è¶Šå¥½ï¼Œä¹Ÿè¶Šå ç”¨CPUæ—¶é—´ï¼Œåé¢ä¼šæœ‰è¯¦ç»†è¯´æ˜
	gzip_comp_level 2;
	# è¿›è¡Œå‹ç¼©çš„æ–‡ä»¶ç±»å‹ã€‚javascriptæœ‰å¤šç§å½¢å¼ã€‚å…¶ä¸­çš„å€¼å¯ä»¥åœ¨ mime.types æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚
	gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png font/ttf font/otf image/svg+xml;
	# æ˜¯å¦åœ¨http headerä¸­æ·»åŠ Vary: Accept-Encodingï¼Œå»ºè®®å¼€å¯
	gzip_vary on;
	# ç¦ç”¨IE 6 gzip
	gzip_disable "MSIE [1-6]\.";
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#å®‰è£…è¯ä¹¦å¯åŠ¨nginx)å®‰è£…è¯ä¹¦å¯åŠ¨nginx

![image-20210810211832312](uniapp.assets/image-20210810211832312.c848f3ae.png)

æµ‹è¯•Nignxçš„é…ç½®æ–‡ä»¶ï¼š

```text
docker exec -it some-nginx nginx -t
```

![image-20210810220403001](uniapp.assets/image-20210810220403001.ba89c359.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#è¯¾ç¨‹ç¦åˆ©nginxé…ç½®)è¯¾ç¨‹ç¦åˆ©nginxé…ç½®

nginxçš„é…ç½®æ–‡ä»¶åœ°å€ï¼š[github(opens new window)](https://gist.github.com/toimc/24df7ea1adab57ee9560062ae9905c2a)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#åœºæ™¯ä¸€-é…ç½®åšå®¢åº”ç”¨)åœºæ™¯ä¸€ï¼šé…ç½®åšå®¢åº”ç”¨

æ·»åŠ å®¿ä¸»æœºçš„dockerç›®å½•æ˜ å°„ï¼š

```yaml
version: "3"
services:
  web:
    image: nginx:latest
    container_name: "some-nginx"
    restart: always
    volumes:
      - /home/nginx/nginx.conf:/etc/nginx/nginx.conf
      - /home/nginx/conf.d:/etc/nginx/conf.d
      - /home/keys:/home/keys
      # blog
      - /home/blog:/var/www
    ports:
      - "80:80"
      - "443:443"

# docker network create https
networks:
  default:
    external:
      name: https
```

nginxçš„é…ç½®æ–‡ä»¶ `conf.d/vhost.conf`ï¼š

```sh
# listen on HTTP2/SSL
server {
  listen 443 ssl http2;
  server_name www.wayearn.com;
  # ssl certs from letsencrypt
  # ssl on;
  # è¿™é‡Œè¦æ³¨æ„ç›®å½•æ˜¯dockeré‡Œé¢çš„ç›®å½•ï¼Œæ‰€ä»¥å»ºè®®å¤§å®¶æŠŠå®¹å™¨é‡Œé¢çš„ç›®å½•ä¸å®¿ä¸»æœºçš„ç›®å½•æ˜ å°„ä¸€è‡´
  ssl_certificate /home/keys/certs.pem;
  ssl_certificate_key /home/keys/key.pem;
  # dhparam.pem
  ssl_dhparam /home/keys/dhparam.pem;

  ssl_session_cache shared:SSL:50m;
  ssl_session_timeout 30m;
  ssl_session_tickets off;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
  # ciphers chosen for forward secrecy and compatibility
  # http://blog.ivanristic.com/2013/08/configuring-apache-nginx-and-openssl-for-forward-secrecy.html
  ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';

  ssl_prefer_server_ciphers on;

  add_header Strict-Transport-Security "max-age=31536000; includeSubdomains; preload";

  location / {
    root /var/www/;
    index index.html;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}

# redirect HTTP and handle let's encrypt requests
server {
  listen 80;
  server_name www.wayearn.com;
  location / {
    return 301 https://$host$request_uri;
  }
}
```

æ£€æµ‹sslç½‘ç«™çš„è¯„çº§ myssl.comï¼š

![image-20210810220929142](uniapp.assets/image-20210810220929142.1537ad70.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#åœºæ™¯äºŒ-é…ç½®å°ç¨‹åºapiæ¥å£)åœºæ™¯äºŒï¼šé…ç½®å°ç¨‹åºAPIæ¥å£

æ­¥éª¤ï¼š

* api -> çº¿ä¸Š -> nginxè¿›è¡Œä»£ç† ï¼›
* apiéƒ¨ç½²åˆ°çº¿ä¸Šçš„æœåŠ¡å™¨ï¼›
* apiæœåŠ¡å¯ä»¥è¢«nginxè®¿é—®åˆ°ï¼›
* åŸŸå + httpså½¢å¼å»è®¿é—® -> æä¾›apiæœåŠ¡
  * é…ç½®nginxçš„vhosté…ç½® + é…ç½®åŸŸåè§£ædns
  * wx.yourdomain.com -> æŒ‡å‘æœåŠ¡å™¨çš„IP
  * é‡å¯nginxå®¹å™¨è®©vhostçš„é…ç½®ç”Ÿæ•ˆ -> æµ‹è¯•æœåŠ¡

å°ç¨‹åºçš„docker-composeæ–‡ä»¶ï¼š

```yaml
version: "3"
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        Version: ${Version}
    image: api_online:${tag}
    container_name: api_online
    restart: always
    # env_file: .env
    environment:
      - DB_USER=$DB_USER
      - DB_PASS=$DB_PASS
      - DB_HOST=$DB_HOST
      - DB_PORT=$DB_PORT
      - DB_NAME=$DB_NAME
      - REDIS_HOST=$REDIS_HOST
      - REDIS_PORT=$REDIS_PORT
      - REDIS_PASS=$REDIS_PASS
    ports:
      - "${PORT}:3000"
      - "${WS_PORT}:3001"
    volumes:
      - /home/imooc/online:/app/public

# å…³é”®å°±æ˜¯è¿™é‡Œï¼Œé…ç½®APIé¡¹ç›®çš„ç½‘ç»œï¼Œè¿æ¥åˆ°httpsç½‘ç»œ
# ç„¶åï¼Œä½¿ç”¨vhosté…ç½®ï¼Œè®©Nginxè¿›è¡Œä»£ç†
networks:
  default:
    external:
      name: https
```

å¯é€‰æ–¹æ¡ˆï¼šæä¾›Mongoã€redisç¯å¢ƒçš„`docker-compose.yml`æ–‡ä»¶ï¼š

```yaml
version: "3"
services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        Version: 1.0
    image: api_online:1.0
    container_name: api_online
    restart: always
    # env_file: .env
    environment:
      - DB_USER=toimc
      - DB_PASS=long_random_pass_mongo
      - DB_HOST=mongo
      - DB_PORT=27017
      - DB_NAME=community
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=long_random_pass_redis
    ports:
      - "10030:3000"
      - "10031:3001"
    volumes:
      - /home/imooc/online:/app/public

  mongo:
    image: mongo
    container_name: "mongodb"
    restart: always
    volumes:
      - /home/imooc/db:/data/db
      - /home/imooc/db/initdb.d:/docker-entrypoint-initdb.d/
      # .sh & .js
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: testdb
      MONGO_INITDB_USERNAME: toimc
      MONGO_INITDB_PASSWORD: long_random_pass_mongo

  redis:
    image: redis
    container_name: "redis"
    restart: always
    ports:
      - "6379:6379"
    command: redis-server --requirepass long_random_pass_redis

networks:
  default:
    external:
      name: https
```

MongoDBçš„åˆå§‹åŒ–æ–‡ä»¶`init.d/mongo-init.sh`æ–‡ä»¶ï¼š

```sh
mongo -- "$MONGO_INITDB_DATABASE" <<EOF
var rootUser = '$MONGO_INITDB_ROOT_USERNAME';
var rootPassword = '$MONGO_INITDB_ROOT_PASSWORD';
var initDB = '$MONGO_INITDB_DATABASE'
var admin = db.getSiblingDB(initDB);
admin.auth(rootUser, rootPassword);

var user = '$MONGO_INITDB_USERNAME';
var passwd = '$MONGO_INITDB_PASSWORD';
db.createUser({ user: user, pwd: passwd, roles: ["dbOwner"] });
EOF
```

æ‰‹åŠ¨éƒ¨ç½²APIæœåŠ¡ï¼š

* ä½¿ç”¨dockerå‘½ä»¤è¿›è¡Œdockeré•œåƒçš„æ„å»º

* æ¨é€é•œåƒæˆ–è€…ä½¿ç”¨æ‰‹åŠ¨æ–¹å¼å¯¼å…¥é•œåƒ

  ä¿å­˜(Save)

  ```text
   # ä¿ç•™åŸé•œåƒçš„åç§°å’Œæ ‡ç­¾
   docker save <IMAGE NAME>:<IMAGE TAG> > save.tar
  
   # ä¸ä¿ç•™åŸé•œåƒçš„åŸºæœ¬ä¿¡æ¯,åŠ è½½loadåéœ€æ‰§è¡Œtagå‘½ä»¤é‡å‘½ånoneé•œåƒ
   docker save <IMAGE ID> > save.tar 
  ```

  ç¤ºä¾‹:

  ```text
  docker save elasticsearch:7.1.1 > elasticsearch-7.1.1.tar
  # æˆ–
  docker save b0cb1543380d > elasticsearch-7.1.1.tar
  ```

  åŠ è½½(Load)

  ```text
  docker load < save.tar
  ```

  ç¤ºåˆ—:

  ```text
  docker load < elasticsearch-7.1.1.tar
  ```

* é…ç½®nginxæ–‡ä»¶`/home/nginx/conf.d/ws.conf`ï¼š

  ```sh
  upstream target-server {
    server api_online:3001 fail_timeout=0;
  }
  # listen on HTTP2/SSL
  server {
    listen 443 ssl http2;
    server_name ws.wayearn.com;
    # ssl certs from letsencrypt
    ssl_certificate /home/acme/fullchain.pem;
    ssl_certificate_key /home/acme/key.pem;
    # dhparam.pem
    ssl_dhparam /home/acme/dhparam.pem;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4';
    ssl_prefer_server_ciphers on;
    location / {
      proxy_set_header X-Forwarded-Ssl on;
      proxy_redirect off;
      proxy_set_header Host $host:$server_port;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_pass http://target-server;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'Upgrade';
    }
  }
  # redirect HTTP and handle let's encrypt requests
  server {
    listen 80;
    server_name ws.wayearn.com;
    # send everything else to HTTPS
    rewrite ^(.*)$ https://$host$1 permanent;
  }
  ```

* æ·»åŠ dnsè§£æ

  ![image-20210810223431309](uniapp.assets/image-20210810223431309.368c5c94.png)

* å¯¼å…¥é•œåƒï¼Œå¯åŠ¨apiæœåŠ¡ï¼š

  ![image-20210810223550333](uniapp.assets/image-20210810223550333.d0fedae0.png)

  ä½¿ç”¨`docker-compose up -d`å¯åŠ¨æœåŠ¡ï¼š

  ![image-20210810223613863](uniapp.assets/image-20210810223613863.5fbb1359.png)

* é‡å¯nginxæœåŠ¡ï¼š

  ```text
  docker restart some-nginx
  ```

  ç½‘ç»œäº’è®¿ï¼š

  ```text
  docker network inspect https
  ```

  ![image-20210810223801721](uniapp.assets/image-20210810223801721.cc7b1e2f.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#æ’æŸ¥é—®é¢˜)æ’æŸ¥é—®é¢˜

* å¸¸è§çš„é˜²ç«å¢™é—®é¢˜ï¼š

```sh
# æŸ¥çœ‹é˜²ç«å¢™çš„è¿è¡ŒçŠ¶æ€
firewall-cmd --state

firewall-cmd --add-port=443/tcp --permanenet

firewall-cmd --reload
```

* äº‘æœåŠ¡å•†çš„æ”¾è¡Œç­–ç•¥ï¼š

åä¸ºäº‘ç¤ºä¾‹ï¼š

![image-20210810221145314](uniapp.assets/image-20210810221145314.e34347c6.png)

è…¾è®¯äº‘ï¼š

![image-20210810221210594](uniapp.assets/image-20210810221210594.0b72c5d5.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#å°ç¨‹åºæ¥å£è”è°ƒ)å°ç¨‹åºæ¥å£è”è°ƒ

* nginxå¯åŠ¨ä¹‹åï¼Œå°±å¯ä»¥è®¿é—®`https://åŸŸå`äº†

* å¯¼å‡ºæµ‹è¯•æ•°æ®åº“

  ```sh
  docker exec -it mongodb mongodump -u test -d testdb -o /tmp/
  ```

  ä½¿ç”¨docker cpå‘½ä»¤æ¥å¤åˆ¶ç›®å½•ï¼š

  ```sh
  docker cp <å®¹å™¨id>:/tmp/testdb /tmp/æœ¬åœ°ç›®å½•
  ```

* å¯¼å…¥æ•°æ®åº“

  ä¸Šä¼ ä¸Šé¢çš„æœ¬åœ°ç›®å½•çš„æ–‡ä»¶åˆ°çº¿ä¸Šçš„æœåŠ¡å™¨ã€‚

  mongodbæ¢å¤æ•°æ®åº“çš„å‘½ä»¤ï¼š

  ```sh
  docker cp /home/docker/testdb <å®¹å™¨id>:/tmp/
  
  docker exec -it mongodb mongorestore -u test -d testdb /tmp/testdb
  ```

  ![image-20210810224430465](uniapp.assets/image-20210810224430465.e62eb13b.png)

è¯·æ±‚æµ‹è¯•ï¼š

![image-20210810224507919](uniapp.assets/image-20210810224507919.89fa22dc.png)

* å¾®ä¿¡å°ç¨‹åºé…ç½®å®‰å…¨åŸŸå

  å¼€å‘ -> å¼€å‘è®¾ç½® -> å®‰å…¨åŸŸå

  ![image-20210810224610237](uniapp.assets/image-20210810224610237.4224a675.png)

  æ·»åŠ åŸŸåï¼š

  ![image-20210810224636162](uniapp.assets/image-20210810224636162.9792e446.png)

  

  ä¸‹é¢å³å¯ä»¥åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­è¿›è¡Œæµ‹è¯•äº†ï¼Œå–æ¶ˆ`ä¸æ ¡éªŒåˆæ³•åŸŸå`ï¼š

  ![image-20210810224714543](uniapp.assets/image-20210810224714543.439e8328.png)



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#è®¢é˜…æ¶ˆæ¯)è®¢é˜…æ¶ˆæ¯

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#ä»‹ç»)ä»‹ç»

æ¶ˆæ¯èƒ½åŠ›æ˜¯å°ç¨‹åºèƒ½åŠ›ä¸­çš„é‡è¦ç»„æˆï¼Œæˆ‘ä»¬ä¸ºå¼€å‘è€…æä¾›äº†è®¢é˜…æ¶ˆæ¯èƒ½åŠ›ï¼Œä»¥ä¾¿å®ç°æœåŠ¡çš„é—­ç¯å’Œæ›´ä¼˜çš„ä½“éªŒã€‚

* è®¢é˜…æ¶ˆæ¯æ¨é€ä½ç½®ï¼šæœåŠ¡é€šçŸ¥
* è®¢é˜…æ¶ˆæ¯ä¸‹å‘æ¡ä»¶ï¼šç”¨æˆ·è‡ªä¸»è®¢é˜…
* è®¢é˜…æ¶ˆæ¯å¡ç‰‡è·³è½¬èƒ½åŠ›ï¼šç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…å¯è·³è½¬è‡³è¯¥å°ç¨‹åºçš„é¡µé¢

![intro](uniapp.assets/request-subscribe-message.3851318e.3851318e.jpg)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#æ¶ˆæ¯ç±»å‹)æ¶ˆæ¯ç±»å‹

**1. ä¸€æ¬¡æ€§è®¢é˜…æ¶ˆæ¯**

ä¸€æ¬¡æ€§è®¢é˜…æ¶ˆæ¯ç”¨äºè§£å†³ç”¨æˆ·ä½¿ç”¨å°ç¨‹åºåï¼Œåç»­æœåŠ¡ç¯èŠ‚çš„é€šçŸ¥é—®é¢˜ã€‚ç”¨æˆ·è‡ªä¸»è®¢é˜…åï¼Œå¼€å‘è€…å¯**ä¸é™æ—¶é—´**åœ°ä¸‹å‘**ä¸€æ¡å¯¹åº”çš„æœåŠ¡æ¶ˆæ¯**ï¼›æ¯æ¡æ¶ˆæ¯å¯å•ç‹¬è®¢é˜…æˆ–é€€è®¢ã€‚

**2. é•¿æœŸè®¢é˜…æ¶ˆæ¯**

ä¸€æ¬¡æ€§è®¢é˜…æ¶ˆæ¯å¯æ»¡è¶³å°ç¨‹åºçš„å¤§éƒ¨åˆ†æœåŠ¡åœºæ™¯éœ€æ±‚ï¼Œä½†çº¿ä¸‹å…¬å…±æœåŠ¡é¢†åŸŸå­˜åœ¨ä¸€æ¬¡æ€§è®¢é˜…æ— æ³•æ»¡è¶³çš„åœºæ™¯ï¼Œå¦‚èˆªç­å»¶è¯¯ï¼Œéœ€æ ¹æ®èˆªç­å®æ—¶åŠ¨æ€æ¥å¤šæ¬¡å‘é€æ¶ˆæ¯æé†’ã€‚ä¸ºä¾¿äºæœåŠ¡ï¼Œæˆ‘ä»¬æä¾›äº†é•¿æœŸæ€§è®¢é˜…æ¶ˆæ¯ï¼Œç”¨æˆ·è®¢é˜…ä¸€æ¬¡åï¼Œå¼€å‘è€…å¯é•¿æœŸä¸‹å‘å¤šæ¡æ¶ˆæ¯ã€‚

ç›®å‰é•¿æœŸæ€§è®¢é˜…æ¶ˆæ¯ä»…å‘æ”¿åŠ¡æ°‘ç”Ÿã€åŒ»ç–—ã€äº¤é€šã€é‡‘èã€æ•™è‚²ç­‰çº¿ä¸‹å…¬å…±æœåŠ¡å¼€æ”¾ï¼ŒåæœŸå°†é€æ­¥æ”¯æŒåˆ°å…¶ä»–çº¿ä¸‹å…¬å…±æœåŠ¡ä¸šåŠ¡ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#ä½¿ç”¨æ­¥éª¤)ä½¿ç”¨æ­¥éª¤

* æ­¥éª¤ä¸€ï¼šè·å–æ¨¡æ¿ ID

  åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°æ‰‹åŠ¨é…ç½®è·å–æ¨¡æ¿ IDï¼š ç™»å½• [https://mp.weixin.qq.com (opens new window)](https://mp.weixin.qq.com/)è·å–æ¨¡æ¿ï¼Œå¦‚æœæ²¡æœ‰åˆé€‚çš„æ¨¡æ¿ï¼Œå¯ä»¥ç”³è¯·æ·»åŠ æ–°æ¨¡æ¿ï¼Œå®¡æ ¸é€šè¿‡åå¯ä½¿ç”¨ã€‚

  ![intro](uniapp.assets/subscribe-message.b562750a.jpg)

* æ­¥éª¤äºŒï¼šè·å–ä¸‹å‘æƒé™

  è¯¦è§å°ç¨‹åºç«¯æ¶ˆæ¯è®¢é˜…æ¥å£ [wx.requestSubscribeMessage(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html)

* æ­¥éª¤ä¸‰ï¼šè°ƒç”¨æ¥å£ä¸‹å‘è®¢é˜…æ¶ˆæ¯

  è¯¦è§æœåŠ¡ç«¯æ¶ˆæ¯å‘é€æ¥å£ [subscribeMessage.send(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)

  > æ³¨æ„äº‹é¡¹ï¼šç”¨æˆ·å‹¾é€‰ â€œæ€»æ˜¯ä¿æŒä»¥ä¸Šé€‰æ‹©ï¼Œä¸å†è¯¢é—®â€ ä¹‹åï¼Œä¸‹æ¬¡è®¢é˜…è°ƒç”¨ wx.requestSubscribeMessage ä¸ä¼šå¼¹çª—ï¼Œä¿æŒä¹‹å‰çš„é€‰æ‹©ï¼Œä¿®æ”¹é€‰æ‹©éœ€è¦æ‰“å¼€å°ç¨‹åºè®¾ç½®è¿›è¡Œä¿®æ”¹ã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#å°è£…è®¢é˜…æ¶ˆæ¯å·¥å…·js)å°è£…è®¢é˜…æ¶ˆæ¯å·¥å…·js

ä½œç”¨ï¼š

* å‘èµ·è®¢é˜…è¯·æ±‚ï¼›
* åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¼€å¯äº†é€šçŸ¥ï¼›
* æç¤ºæœªå¼€å¯é€šçŸ¥çš„ç”¨æˆ·ï¼Œå¹¶è·³è½¬è®¾ç½®é¡µé¢ï¼›

```js
export default (arr, cb, mute = false) => {
  uni.requestSubscribeMessage({
    tmplIds: arr.length > 3 ? arr.splice(0, 3) : arr,
    // åœ¨è°ƒè¯•å·¥å…·ä¸­ï¼Œæ— è®ºè®¢é˜…æˆåŠŸè¿˜æ˜¯å–æ¶ˆï¼Œéƒ½å¯ä»¥åœ¨completeå–åˆ°çŠ¶æ€
    // è°ƒè¯•å·¥å…·ä¸­ï¼Œæ— æ³•ç›´æ¥æµ‹è¯•å…³é—­è®¢é˜…çš„çŠ¶æ€
    // åœ¨çœŸæœºä¸Šï¼Œå¯ä»¥è·å–ç”¨æˆ·æ‹’ç»è®¢é˜…çš„çŠ¶æ€
    // è€Œä¸”åœ¨completeéƒ¨åˆ†å¯ä»¥è·å–åˆ°success/failçš„å›è°ƒå†…å®¹
    complete: (res) => {
      // 2.1 å¦‚æœç”¨æˆ·æœªè®¢é˜…ï¼Œå¹¶æœªæ‹’ç»ï¼Œæ­£å¸¸å‘èµ·è®¢é˜…
      // 2.2 å¦‚æœç”¨æˆ·æ‹’ç»äº†è®¢é˜…ï¼Œéœ€è¦ç»™ç”¨æˆ·ä¸€ä¸ªè½»æç¤º -> æ‰‹åŠ¨æ‰“å¼€è®¢é˜…æ¶ˆæ¯çš„
      // wx.openSetting
      if (arr.includes(item => res[item] === 'reject') || res.errCode === 20004) {
        uni.showModal({
          title: 'æ‚¨å…³é—­äº†è®¢é˜…é€šçŸ¥',
          content: 'éœ€è¦æ‰“å¼€è®¾ç½®è¿›è¡Œæ‰‹åŠ¨è®¾ç½®å—ï¼Ÿ',
          success: function (res) {
            if (res.confirm) {
              uni.openSetting()
            } else if (res.cancel) {
              uni.showToast({
                icon: 'error',
                title: 'æ‚¨å–æ¶ˆäº†è®¢é˜…',
                duration: 2000
              })
            }
          }
        })
      } else if (!arr.some(item => res[item] === 'reject')) {
        !mute && uni.showToast({
          icon: 'none',
          title: 'æ‚¨å·²ç»è®¢é˜…äº†è¯¥æ¶ˆæ¯',
          duration: 1500
        })
      } else if (res.errCode === 10002 || res.errCode === 10003) {
        uni.showToast({
          title: 'ç½‘ç»œé—®é¢˜è®¢é˜…å¤±è´¥ï¼Œè¯·é‡æ–°è®¢é˜…',
          duration: 1500
        })
      } else {
        // å…¶ä»–çš„é€»è¾‘ https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html
      }
      cb && cb()
    }
  })
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#å‰ç«¯ä¸»åŠ¨è®¢é˜…)å‰ç«¯ä¸»åŠ¨è®¢é˜…

åœ¨App.vueä¸­æ·»åŠ åˆ¤æ–­ç”¨æˆ·è®¢é˜…é€»è¾‘ï¼š

```js
export default {
  onLaunch: function () {
    // console.warn('å½“å‰ç»„ä»¶ä»…æ”¯æŒ uni_modules ç›®å½•ç»“æ„ ï¼Œè¯·å‡çº§ HBuilderX åˆ° 3.1.0 ç‰ˆæœ¬ä»¥ä¸Šï¼')
    // console.log('App Launch')
    uni.getSetting({
      withSubscriptions: true,
      success: async (res) => {
        const app = getApp()
        app.globalData.subscriptionsSetting = res.subscriptionsSetting
        const arr = [
          'S7zrpjN9Kq05-4ZG_nlTAYxnARMLWlSW09h54A2JCZo',
          'ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs',
          'FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA',
          'g9FFU43_deHRuez-2FcrASorTSITsJJPYx-GhzvHEIU'
        ]
        // 1. è·å–ç”¨æˆ·å·²ç»è®¢é˜…çš„æ¶ˆæ¯
        const { itemSettings: keys, mainSwitch } = res.subscriptionsSetting
        // ç›¸å½“äºç”¨æˆ·æœªæ‰“å¼€è®¢é˜…å¼€å…³
        if (!mainSwitch) {
          return
        }
        // ç”¨æˆ·å¼€å¯è®¢é˜…æ¶ˆæ¯ -> å¦‚æœæœªè®¾ç½®ä»»ä½•æ¶ˆæ¯
        if (!keys) {
          app.globalData.tmplIds = arr
        } else {
          // ç”¨æˆ·å¼€å¯äº†è®¢é˜…æ¶ˆæ¯ -> å·²ç»æœ‰éƒ¨åˆ†è®¢é˜… -> reject, accept
          const keysArr = Object.keys(keys)
          app.globalData.tmplIds = arr.filter((item) => keysArr.indexOf(item) === -1)
        }
      }
    })
  },
  onShow: function () {
    console.log('App Show')
  },
  onHide: function () {
    console.log('App Hide')
  }
}
```

åœ¨éœ€è¦è®¢é˜…çš„ä½ç½®ï¼ŒåŠ å…¥è®¢é˜…é€»è¾‘ï¼Œæ¯”å¦‚åœ¨ä¸ªäººä¸­å¿ƒä¸­ï¼Œç‚¹å‡»å»ç™»å½•æ—¶ï¼š

```js
import sub from '@/common/utils/subscribe'

// ...
const app = getApp()
const tmplIds = app.globalData.tmplIds || []
sub(tmplIds.splice(0, 3), () => {
  if (!this.isLogin) {
    uni.navigateTo({
      url: '/subcom-pkg/auth/auth'
    })
  }
}, true)
```

> æ³¨æ„ï¼šè®¢é˜…æ¶ˆæ¯ä¸€æ¬¡æœ€å¤šåªå¯ä»¥è®¢é˜…3æ¡ï¼Œæ‰€ä»¥éœ€è¦åŠ å…¥ä¸€ä¸ªspliceæ–¹æ³•æˆªæ–­æœªè®¢é˜…çš„æ¶ˆæ¯ã€‚
>
> ä¹Ÿå¯ä»¥è‡ªå·±åœ¨æŒ‡å®šçš„ä¸šåŠ¡éƒ¨åˆ†ï¼Œç»™`sub`æ–¹æ³•ï¼Œä¼ é€’æŒ‡å®šçš„æ¨¡æ¿IDã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#è®¢é˜…æ¶ˆæ¯æ¨¡æ¿api)è®¢é˜…æ¶ˆæ¯æ¨¡æ¿API

åº”ç”¨åœºæ™¯ï¼š

* åå°æ§åˆ¶å“ªäº›æ¶ˆæ¯å¯ä»¥è¢«è®¢é˜…ï¼›
* å½“æ¨¡æ¿æ¶ˆæ¯çš„idå‘ç”Ÿäº†å˜åŒ–æ—¶ï¼Œå¦‚æœä¿è¯è®¢é˜…çš„å‡†ç¡®æ€§ï¼›

å‰ç«¯è¯·æ±‚æ¨¡æ¿APIï¼š

```js
// è·å–æ¨¡æ¿id
const getSubIds = () => axios.get('/public/subids')
```

è°ƒæ•´App.vueä¸­çš„æ¨¡æ¿IDsçš„åˆ¤æ–­é€»è¾‘ï¼Œå¤„ç†ï¼š

```js
// æ¨¡æ¿ID
// æ”¹è£…æˆä¸€ä¸ªAPIæ¥å£ -> key:value -> value, key -> ä¸šåŠ¡åœºæ™¯
const { code, data } = await this.$u.api.getSubIds()
let arr
if (code === 200) {
  // {key: value, key1: value1} => [value, value1]
  arr = Object.entries(data).map(o => o[1])
} else {
  // é»˜è®¤çš„å‰ç«¯æ¨¡æ¿æ•°æ®
  arr = [
    'S7zrpjN9Kq05-4ZG_nlTAYxnARMLWlSW09h54A2JCZo',
    'ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs',
    'FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA',
    'g9FFU43_deHRuez-2FcrASorTSITsJJPYx-GhzvHEIU'
  ]
}
```

åç«¯åˆ›å»ºè·¯ç”±ä¸æ¥å£ï¼š

è·¯ç”±ï¼š

```js
// è·å–å¾®ä¿¡æ¨¡æ¿id
router.get('/subids', publicController.getSubIds)
```

æ¥å£ï¼š

```js
async getSubIds (ctx) {
  ctx.body = {
    code: 200,
    data: config.subIds
  }
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#ç»´æŠ¤accesstoken)ç»´æŠ¤accessToken

åç«¯å‘é€è®¢é˜…æ¶ˆæ¯éœ€è¦accessTokenï¼š

```js
POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN
```

è§å®˜æ–¹æ–‡æ¡£ï¼š[é“¾æ¥(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)

ç”±äºacessTokençš„æœ‰æ•ˆæ—¶é—´æ˜¯2å°æ—¶ï¼Œè€Œä¸”æ¯å¤©å¾®ä¿¡è¯·æ±‚çš„é™åˆ¶ä¸º2000æ¬¡ï¼ˆ[é“¾æ¥ (opens new window)](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/API_Call_Limits.html)ï¼‰ï¼Œå¦‚ä¸‹å›¾ï¼š

![image-20210812102933432](uniapp.assets/image-20210812102933432.90192975.png)

æ‰€ä»¥ï¼Œéœ€è¦è‡ªå·±å®šæ—¶ç»´æŠ¤accessTokenï¼š

* åˆ›å»º`wxGetAccessToken`æ–¹æ³•ï¼š

  ```js
  import log4js from '@/config/Log4j'
  const logger = log4js.getLogger('error')
  import { getValue, setValue } from '@/config/RedisConfig'
  
  // flag å¼ºåˆ¶åˆ·æ–°ï¼Œé»˜è®¤false - ä¸å¼ºåˆ¶åˆ·æ–°
  export const wxGetAccessToken = async (flag = false) => {
    // https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
    // 1.åˆ¤æ–­redisä¸­æ˜¯å¦æœ‰accessToken
    // 2.æœ‰ & flag -> åˆ™ç›´æ¥è¿”å›
    // 3.æ²¡æœ‰ -> è¯·æ±‚æ–°çš„token
    let accessToken = await getValue('accessToken')
    if (!accessToken || flag) {
      try {
        const result = await instance.get(`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${config.AppID}&secret=${config.AppSecret}`)
        // console.log('ğŸš€ ~ file: WxUtils.js ~ line 60 ~ wxGetAccessToken ~ result', result)
        if (result.status === 200) {
          await setValue('accessToken', result.data.access_token, result.data.expires_in)
          accessToken = result.data.access_token
          if (result.data.errcode && result.data.errmsg) {
            logger.error(`wxGetAccessToken error${result.data.errcode} - ${result.data.errmsg}`)
          }
        }
      } catch (error) {
        logger.error(`wxGetAccessToken error: ${error.message}`)
      }
    }
    return accessToken
  }
  ```

* å®‰è£…ä¾èµ–`npm i cron`

* é…ç½®å®šæ—¶ä»»åŠ¡ï¼š

  ```js
  // æ¯éš”7200ç§’æ‰§è¡Œä¸€æ¬¡ åˆ·æ–°accessToken
  import { CronJob } from 'cron'
  import { wxGetAccessToken } from './WxUtils'
  
  // Seconds: 0-59
  // Minutes: 0-59
  // Hours: 0-23
  // Day of Month: 1-31
  // Months: 0-11 (Jan-Dec)
  // Day of Week: 0-6 (Sun-Sat)
  
  const job = new CronJob('* * */1 * * *', () => {
    wxGetAccessToken(true)
  })
  
  job.start()
  ```

* åœ¨å…¥å£æ–‡ä»¶å¤„ç†ï¼Œæ·»åŠ è¯¥æ–‡ä»¶ï¼š

  ```js
  import './common/Cron'
  ```

**å¸¸è§é—®é¢˜ï¼Œå¦‚æœä¸å°å¿ƒaccessTokenè¯·æ±‚è¶…é™æ€ä¹ˆåŠï¼š**

![img](uniapp.assets/0.a36c9ed1.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#åå°å‘é€è®¢é˜…æ¶ˆæ¯)åå°å‘é€è®¢é˜…æ¶ˆæ¯

å‘é€è®¢é˜…æ¶ˆæ¯ï¼š[å®˜æ–¹æ–‡æ¡£(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)

è°ƒç”¨æ–¹å¼ï¼š

* [HTTPS è°ƒç”¨(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-http)
* [äº‘è°ƒç”¨(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html#method-cloud)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#httpsè°ƒç”¨æ¥å£è¯´æ˜)HTTPSè°ƒç”¨æ¥å£è¯´æ˜

```text
POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN
```

**è¯·æ±‚å‚æ•°ï¼š**

| å±æ€§                                  | ç±»å‹   | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜                                                         |
| :------------------------------------ | :----- | :----- | :--- | :----------------------------------------------------------- |
| access_token / cloudbase_access_token | string |        | æ˜¯   | [æ¥å£è°ƒç”¨å‡­è¯(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html) |
| touser                                | string |        | æ˜¯   | æ¥æ”¶è€…ï¼ˆç”¨æˆ·ï¼‰çš„ openid                                      |
| template_id                           | string |        | æ˜¯   | æ‰€éœ€ä¸‹å‘çš„è®¢é˜…æ¨¡æ¿id                                         |
| page                                  | string |        | å¦   | ç‚¹å‡»æ¨¡æ¿å¡ç‰‡åçš„è·³è½¬é¡µé¢ï¼Œä»…é™æœ¬å°ç¨‹åºå†…çš„é¡µé¢ã€‚æ”¯æŒå¸¦å‚æ•°,ï¼ˆç¤ºä¾‹index?foo=barï¼‰ã€‚è¯¥å­—æ®µä¸å¡«åˆ™æ¨¡æ¿æ— è·³è½¬ã€‚ |
| data                                  | Object |        | æ˜¯   | æ¨¡æ¿å†…å®¹ï¼Œæ ¼å¼å½¢å¦‚ { "key1": { "value": any }, "key2": { "value": any } } |
| miniprogram_state                     | string |        | å¦   | è·³è½¬å°ç¨‹åºç±»å‹ï¼šdeveloperä¸ºå¼€å‘ç‰ˆï¼›trialä¸ºä½“éªŒç‰ˆï¼›formalä¸ºæ­£å¼ç‰ˆï¼›é»˜è®¤ä¸ºæ­£å¼ç‰ˆ |
| lang                                  | string |        | å¦   | è¿›å…¥å°ç¨‹åºæŸ¥çœ‹â€çš„è¯­è¨€ç±»å‹ï¼Œæ”¯æŒzh_CN(ç®€ä½“ä¸­æ–‡)ã€en_US(è‹±æ–‡)ã€zh_HK(ç¹ä½“ä¸­æ–‡)ã€zh_TW(ç¹ä½“ä¸­æ–‡)ï¼Œé»˜è®¤ä¸ºzh_CN |

**è¯´æ˜ä¸€ä¸‹å…³äº`data`ï¼š**

ä¾‹å¦‚ï¼Œæ¨¡æ¿çš„å†…å®¹ä¸º

```text
å§“å: {{name01.DATA}}
é‡‘é¢: {{amount01.DATA}}
è¡Œç¨‹: {{thing01.DATA}}
æ—¥æœŸ: {{date01.DATA}}
```

åˆ™å¯¹åº”çš„jsonä¸º

```json
{
  "touser": "OPENID",
  "template_id": "TEMPLATE_ID",
  "page": "index",
  "data": {
      "name01": {
          "value": "æŸæŸ"
      },
      "amount01": {
          "value": "ï¿¥100"
      },
      "thing01": {
          "value": "å¹¿å·è‡³åŒ—äº¬"
      } ,
      "date01": {
          "value": "2018-01-01"
      }
  }
}
```

è¿™é‡Œçš„dataæœ‰å†…å®¹é™åˆ¶ï¼ˆä¸¾ä¾‹å¦‚ä¸‹è¡¨ï¼‰ï¼Œæ›´å¤šæŸ¥çœ‹å®˜æ–¹æ–‡æ¡£è¯¦æƒ…ï¼š

| å‚æ•°ç±»åˆ«              | å‚æ•°è¯´æ˜ | å‚æ•°å€¼é™åˆ¶                                                   | è¯´æ˜                                                         |
| :-------------------- | :------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| thing.DATA            | äº‹ç‰©     | 20ä¸ªä»¥å†…å­—ç¬¦                                                 | å¯æ±‰å­—ã€æ•°å­—ã€å­—æ¯æˆ–ç¬¦å·ç»„åˆ                                 |
| number.DATA           | æ•°å­—     | 32ä½ä»¥å†…æ•°å­—                                                 | åªèƒ½æ•°å­—ï¼Œå¯å¸¦å°æ•°                                           |
| letter.DATA           | å­—æ¯     | 32ä½ä»¥å†…å­—æ¯                                                 | åªèƒ½å­—æ¯                                                     |
| symbol.DATA           | ç¬¦å·     | 5ä½ä»¥å†…ç¬¦å·                                                  | åªèƒ½ç¬¦å·                                                     |
| character_string.DATA | å­—ç¬¦ä¸²   | 32ä½ä»¥å†…æ•°å­—ã€å­—æ¯æˆ–ç¬¦å·                                     | å¯æ•°å­—ã€å­—æ¯æˆ–ç¬¦å·ç»„åˆ                                       |
| time.DATA             | æ—¶é—´     | 24å°æ—¶åˆ¶æ—¶é—´æ ¼å¼ï¼ˆæ”¯æŒ+å¹´æœˆæ—¥ï¼‰ï¼Œæ”¯æŒå¡«æ—¶é—´æ®µï¼Œä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´ç”¨â€œ~â€ç¬¦å·è¿æ¥ | ä¾‹å¦‚ï¼š15:01ï¼Œæˆ–ï¼š2019å¹´10æœˆ1æ—¥ 15:01                         |
| date.DATA             | æ—¥æœŸ     | å¹´æœˆæ—¥æ ¼å¼ï¼ˆæ”¯æŒ+24å°æ—¶åˆ¶æ—¶é—´ï¼‰ï¼Œæ”¯æŒå¡«æ—¶é—´æ®µï¼Œä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´ç”¨â€œ~â€ç¬¦å·è¿æ¥ | ä¾‹å¦‚ï¼š2019å¹´10æœˆ1æ—¥ï¼Œæˆ–ï¼š2019å¹´10æœˆ1æ—¥ 15:01                 |
| amount.DATA           | é‡‘é¢     | 1ä¸ªå¸ç§ç¬¦å·+10ä½ä»¥å†…çº¯æ•°å­—ï¼Œå¯å¸¦å°æ•°ï¼Œç»“å°¾å¯å¸¦â€œå…ƒâ€           | å¯å¸¦å°æ•°                                                     |
| phone_number.DATA     | ç”µè¯     | 17ä½ä»¥å†…ï¼Œæ•°å­—ã€ç¬¦å·                                         | ç”µè¯å·ç ï¼Œä¾‹ï¼š+86-0766-66888866                              |
| car_number.DATA       | è½¦ç‰Œ     | 8ä½ä»¥å†…ï¼Œç¬¬ä¸€ä½ä¸æœ€åä¸€ä½å¯ä¸ºæ±‰å­—ï¼Œå…¶ä½™ä¸ºå­—æ¯æˆ–æ•°å­—          | è½¦ç‰Œå·ç ï¼šç²¤A8Z888æŒ‚                                         |
| name.DATA             | å§“å     | 10ä¸ªä»¥å†…çº¯æ±‰å­—æˆ–20ä¸ªä»¥å†…çº¯å­—æ¯æˆ–ç¬¦å·                         | ä¸­æ–‡å10ä¸ªæ±‰å­—å†…ï¼›çº¯è‹±æ–‡å20ä¸ªå­—æ¯å†…ï¼›ä¸­æ–‡å’Œå­—æ¯æ··åˆæŒ‰ä¸­æ–‡åç®—ï¼Œ10ä¸ªå­—å†… |
| phrase.DATA           | æ±‰å­—     | 5ä¸ªä»¥å†…æ±‰å­—                                                  | 5ä¸ªä»¥å†…çº¯æ±‰å­—ï¼Œä¾‹å¦‚ï¼šé…é€ä¸­                                  |

è¿”å›çš„ JSON æ•°æ®åŒ…

| å±æ€§    | ç±»å‹   | è¯´æ˜     |
| :------ | :----- | :------- |
| errcode | number | é”™è¯¯ç    |
| errmsg  | string | é”™è¯¯ä¿¡æ¯ |

**errcode çš„åˆæ³•å€¼**

| å€¼    | è¯´æ˜                                                         |
| :---- | :----------------------------------------------------------- |
| 40003 | touserå­—æ®µopenidä¸ºç©ºæˆ–è€…ä¸æ­£ç¡®                               |
| 40037 | è®¢é˜…æ¨¡æ¿idä¸ºç©ºä¸æ­£ç¡®                                         |
| 43101 | ç”¨æˆ·æ‹’ç»æ¥å—æ¶ˆæ¯ï¼Œå¦‚æœç”¨æˆ·ä¹‹å‰æ›¾ç»è®¢é˜…è¿‡ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·å–æ¶ˆäº†è®¢é˜…å…³ç³» |
| 47003 | æ¨¡æ¿å‚æ•°ä¸å‡†ç¡®ï¼Œå¯èƒ½ä¸ºç©ºæˆ–è€…ä¸æ»¡è¶³è§„åˆ™ï¼Œerrmsgä¼šæç¤ºå…·ä½“æ˜¯å“ªä¸ªå­—æ®µå‡ºé”™ |
| 41030 | pageè·¯å¾„ä¸æ­£ç¡®ï¼Œéœ€è¦ä¿è¯åœ¨ç°ç½‘ç‰ˆæœ¬å°ç¨‹åºä¸­å­˜åœ¨ï¼Œä¸app.jsonä¿æŒä¸€è‡´ |

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#åˆ›å»ºå‘é€æ¶ˆæ¯å·¥å…·js)åˆ›å»ºå‘é€æ¶ˆæ¯å·¥å…·js

```js
export const wxSendMessage = async (options) => {
  // POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN
  let accessToken = await wxGetAccessToken()
  try {
    const { data } = await instance.post(`https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=${accessToken}`, options)
    return data
  } catch (error) {
    logger.error(`wxSendMessage error: ${error.message}`)
  }
}
```

ä¸¾ä¾‹ï¼š

åœ¨ç”¨æˆ·ç™»å½•ä¹‹åï¼Œå‘é€è®¢é˜…æ¶ˆæ¯é€šçŸ¥ï¼š

```js
// æ¨é€æ¶ˆæ¯
// å­—æ®µé™åˆ¶ï¼šhttps://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html
const notify = await wxSendMessage({
  touser: tmpUser.openid,
  template_id: 'FSQZganmBgaRRoNNlelQ1Qm2u4gx6pVSt69EJfkLbPA',
  data: {
    phrase1: {
      value: 'ç™»å½•å®‰å…¨'
    },
    date2: {
      value: moment().format('YYYYå¹´MMæœˆDD HH:mm')
    },
    thing4: {
      value: 'é€šè¿‡å¾®ä¿¡æˆæƒç™»å½•æˆåŠŸï¼Œè¯·æ³¨æ„ä¿¡æ¯å®‰å…¨'
    }
  },
  miniprogram_state: process.env.NODE_ENV === 'development' ? 'developer' : 'formal'
})
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/08-è®¢é˜…æ¶ˆæ¯.html#å‰åç«¯è”è°ƒ)å‰åç«¯è”è°ƒ

è”è°ƒéœ€è¦æ³¨æ„çš„ç‚¹ï¼š

* è®¾ç½®`miniprogram_state`å±æ€§ï¼›
* ä½¿ç”¨çœŸæœºè¿›è¡Œè°ƒè¯• -> é…ç½®å±€åŸŸç½‘çš„è®¿é—®çš„IP -> è®©ç”µè„‘ä¸æ‰‹æœºå¤„äºåŒä¸€ä¸ªç½‘æ®µï¼›
* æ£€æŸ¥å‘é€è®¢é˜…æ¶ˆæ¯çš„æ•°æ®æ ¼å¼ã€æ¨¡æ¿idã€ç”¨æˆ·openidæ•°æ®æ˜¯å¦æ­£ç¡®ï¼›
* ä½¿ç”¨å•æ­¥è°ƒè¯•ï¼šå‘é€è®¢é˜…æ¶ˆæ¯çš„æ¥å£ï¼ŒæŸ¥çœ‹è¿”å›çš„errcodeå¦‚æœæ˜¯0ï¼Œè¯´æ˜å‘é€æˆåŠŸï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™æ ¹æ®errcodeæ¥è°ƒæ•´ç¨‹åºä»£ç ï¼›

![image-20210812111502555](uniapp.assets/image-20210812111502555.6ac23418.png)



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#å†…å®¹å®‰å…¨)å†…å®¹å®‰å…¨

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#å¾®ä¿¡å®‰å…¨æ£€æµ‹)å¾®ä¿¡å®‰å…¨æ£€æµ‹

å¾®ä¿¡å®˜æ–¹æä¾›äº†å¯ç–‘ç”¨æˆ·ä¸å±é™©æ¥å£çš„æ£€æŸ¥ï¼š

![image-20210815144637652](uniapp.assets/image-20210815144637652.605489b5.png)

æ¥å£å®‰å…¨æ‰«æï¼š

![image-20210815144649621](uniapp.assets/image-20210815144649621.30fc62ba.png)

è¿™ä¸¤ä¸ªåŠŸèƒ½åœ¨åå°å³å¯æ“ä½œï¼Œå¹³å¦å¯ä»¥äº¤ç”±è¿è¥å°å§å§æ¥è¿›è¡Œæ“ä½œä¸€ä¸‹ã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#ç¬¬ä¸‰æ–¹å†…å®¹å®‰å…¨æ¨è)ç¬¬ä¸‰æ–¹å†…å®¹å®‰å…¨æ¨è

* å„å®¶äº‘æœåŠ¡å•†ï¼š[äº‘ç›¾ (opens new window)](https://www.aliyun.com/product/lvwang)(é˜¿é‡Œ)ï¼Œ[æ˜“ç›¾ (opens new window)](https://dun.163.com/)(ç½‘æ˜“)ï¼Œ[å¤©å¾¡ (opens new window)](https://cloud.tencent.com/product/tms)(è…¾è®¯)
* ç¬¬ä¸‰æ–¹ï¼š[å›¾æ™® (opens new window)](https://www.tuputech.com/text_moderation)ã€å›½ä¿¡ç½‘å®‰ã€[æ¢µä¸ºç§‘æŠ€(opens new window)](https://www.vanwei.com.cn/main/tq)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#æ–‡æœ¬å†…å®¹å®‰å…¨)æ–‡æœ¬å†…å®¹å®‰å…¨

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#æ•´ä½“æ€è·¯)æ•´ä½“æ€è·¯

* ä¸‹è½½ç½‘ç»œä¸Šçš„ä¸€äº›æ•æ„Ÿè¯çš„æ•°æ®åº“ï¼Œä½¿ç”¨æ­£åˆ™è¿›è¡ŒåŒ¹é…è¿‡æ»¤ä¸€æ¬¡ï¼Œå‡å°‘æˆæœ¬ï¼›
* ä½¿ç”¨å®˜æ–¹çš„é™é¢çš„apiå¯¹æ–‡æœ¬è¿›è¡ŒæŸ¥éªŒï¼›
* ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„apiå¯¹å†…å®¹è¿›è¡ŒæŸ¥éªŒï¼›

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#å®˜æ–¹ä»‹ç»)å®˜æ–¹ä»‹ç»

æ£€æŸ¥ä¸€æ®µæ–‡æœ¬æ˜¯å¦å«æœ‰è¿æ³•è¿è§„å†…å®¹ï¼Œä¸‹é¢ä»‹ç»çš„æ¥å£ï¼š[å®˜æ–¹é“¾æ¥(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html)

1.0 ç‰ˆæœ¬æ¥å£æ–‡æ¡£[ã€ç‚¹å‡»æŸ¥çœ‹ã€‘(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck-v1.html)

åº”ç”¨åœºæ™¯ä¸¾ä¾‹ï¼š

1. ç”¨æˆ·ä¸ªäººèµ„æ–™è¿è§„æ–‡å­—æ£€æµ‹ï¼›
2. åª’ä½“æ–°é—»ç±»ç”¨æˆ·å‘è¡¨æ–‡ç« ï¼Œè¯„è®ºå†…å®¹æ£€æµ‹ï¼›
3. æ¸¸æˆç±»ç”¨æˆ·ç¼–è¾‘ä¸Šä¼ çš„ç´ æ(å¦‚ç­”é¢˜ç±»å°æ¸¸æˆç”¨æˆ·ä¸Šä¼ çš„é—®é¢˜åŠç­”æ¡ˆ)æ£€æµ‹ç­‰ã€‚ *é¢‘ç‡é™åˆ¶ï¼šå•ä¸ª appId è°ƒç”¨ä¸Šé™ä¸º 4000 æ¬¡/åˆ†é’Ÿï¼Œ2,000,000 æ¬¡/å¤©**

è°ƒç”¨æ–¹å¼ï¼š

* [HTTPS è°ƒç”¨(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html#method-http)
* [äº‘è°ƒç”¨(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/sec-check/security.msgSecCheck.html#method-cloud)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#å·¥å…·jså°è£…)å·¥å…·jså°è£…

è¯·æ±‚åœ°å€

```text
POST https://api.weixin.qq.com/wxa/msg_sec_check?access_token=ACCESS_TOKEN
```

è¯·æ±‚å‚æ•°

| å±æ€§                                  | ç±»å‹   | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜                                                         |
| :------------------------------------ | :----- | :----- | :--- | :----------------------------------------------------------- |
| access_token / cloudbase_access_token | string |        | æ˜¯   | [æ¥å£è°ƒç”¨å‡­è¯(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html) |
| version                               | string |        | æ˜¯   | æ¥å£ç‰ˆæœ¬å·ï¼Œ2.0ç‰ˆæœ¬ä¸ºå›ºå®šå€¼2                                 |
| openid                                | string |        | æ˜¯   | ç”¨æˆ·çš„openidï¼ˆç”¨æˆ·éœ€åœ¨è¿‘ä¸¤å°æ—¶è®¿é—®è¿‡å°ç¨‹åºï¼‰                 |
| scene                                 | number |        | æ˜¯   | åœºæ™¯æšä¸¾å€¼ï¼ˆ1 èµ„æ–™ï¼›2 è¯„è®ºï¼›3 è®ºå›ï¼›4 ç¤¾äº¤æ—¥å¿—ï¼‰             |
| content                               | string |        | æ˜¯   | éœ€æ£€æµ‹çš„æ–‡æœ¬å†…å®¹ï¼Œæ–‡æœ¬å­—æ•°çš„ä¸Šé™ä¸º2500å­—                     |
| nickname                              | string |        | å¦   | ç”¨æˆ·æ˜µç§°                                                     |
| title                                 | string |        | å¦   | æ–‡æœ¬æ ‡é¢˜                                                     |
| signature                             | string |        | å¦   | ä¸ªæ€§ç­¾åï¼Œè¯¥å‚æ•°ä»…åœ¨èµ„æ–™ç±»åœºæ™¯æœ‰æ•ˆ(scene=1)                  |

è¿”å›çš„ JSON æ•°æ®åŒ…

| å±æ€§     | ç±»å‹   | è¯´æ˜                       |
| :------- | :----- | :------------------------- |
| errcode  | number | é”™è¯¯ç                      |
| errmsg   | string | é”™è¯¯ä¿¡æ¯                   |
| trace_id | string | å”¯ä¸€è¯·æ±‚æ ‡è¯†ï¼Œæ ‡è®°å•æ¬¡è¯·æ±‚ |
| result   | object | ç»¼åˆç»“æœ                   |
| detail   | array  | è¯¦ç»†æ£€æµ‹ç»“æœ               |

é€»è¾‘ï¼š

* ç”¨æˆ·åªç”¨ä¼ æ–‡æœ¬å†…å®¹ï¼Œå…¶ä»–çš„openidç­‰ä¿¡æ¯å¯ä»¥ä¸ä¼ ï¼Œè®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼ï¼Œæ–¹ä¾¿å…¶ä»–çš„å¹³å°ä½¿ç”¨ï¼›
* ä½¿ç”¨æ­£åˆ™åŒ¹é…æ‰ä¸€äº›æ— ç”¨çš„å†…å®¹ï¼›
* é•¿åº¦åˆ¤æ–­ï¼Œåˆ†2500è¯è¿›è¡Œå¤šæ¬¡åˆ¤æ–­ï¼›
* åˆ¤æ–­ç»“æœépassçš„å…¨éƒ¨è¿›å…¥riskyéƒ¨åˆ†ï¼›

```js
// æ–‡æœ¬å†…å®¹å®‰å…¨
// content - å†…å®¹
// title - æ ‡é¢˜ å¯é€‰
// signature - ç­¾å ä¹Ÿæ˜¯å¯é€‰
export const wxMsgCheck = async (content, {
  user: {
    openid,
    name: nickname,
    remark: signature
  },
  scene,
  title
} = {
  user: {},
  scene: 3,
  title: ''
}) => {
  // POST https://api.weixin.qq.com/wxa/msg_sec_check?access_token=ACCESS_TOKEN
  let accessToken = await wxGetAccessToken()
  let res
  try {
    // 1.è¿‡æ»¤æ‰ä¸€äº›å¦‚Htmlï¼Œè‡ªå®šä¹‰çš„æ ‡ç­¾å†…å®¹
    content = content.replace(/<[^>]+>/g, '').replace(/\sface\[\S{1,}]/g, '').replace(/img\[\S+\]/g, '').replace(/\sa\(\S+\]/g, '').replace(/\[\/?quote\]/g, '').replace(/\[\/?pre\]/g, '').replace(/\[\/?hr\]/g, '').replace(/[\r\n|\n|\s]/g, '')
    // 2.å¦‚æœcontentå†…å®¹è¶…è¿‡äº†2500è¯ï¼Œéœ€è¦è¿›è¡Œåˆ†æ®µå¤„ç†
    if (content.length > 2500) {
      // åˆ†æ®µ â€”> arr -> method1: for , method2: reg
      let arr = content.match(/[\s\S]{1,2500}/g) || []
      // å¤šæ¬¡è¯·æ±‚æ¥å£
      let mulResult = []
      for (let i = 0; i < arr.length; i++) {
        // è·å–æ‰€æœ‰æ¥å£çš„è¿”å›ç»“æœ -> ç»“æœåˆ¤æ–­ -> è¿”å›
        res = await instance.post(`https://api.weixin.qq.com/wxa/msg_sec_check?access_token=${accessToken}`, {
          version: 2,
          openid: openid || 'ooTjn5YPpogMWLtEQ_PxyUJkIp2I',
          scene,
          content: arr[i],
          nickname: nickname,
          title,
          signature: scene === 1 ? signature : null
        })
        mulResult.push(res)
      }
      // åˆ¤æ–­mulResult
      console.log(mulResult)
      const arrTemp = mulResult.filter(item => {
        const { status, data: { errcode, result } } = item
        return status !== 200 || errcode !== 0 || (result && result.suggest !== 'pass')
      })
      return !(arrTemp.length > 0)
    } else {
      res = await instance.post(`https://api.weixin.qq.com/wxa/msg_sec_check?access_token=${accessToken}`, {
        version: 2,
        openid: openid || 'ooTjn5YPpogMWLtEQ_PxyUJkIp2I',
        scene,
        content,
        nickname: nickname,
        title,
        signature: scene === 1 ? signature : null
      })
      const { status, data: { errcode, result } } = res
      return status === 200 && errcode === 0 && result && result.suggest === 'pass'
    }
  } catch (error) {
    logger.error(`wxMsgCheck error: ${error.message}`)
  }
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#è‡ªå®šä¹‰å®‰å…¨æ•æ„Ÿè¯æ±‡)è‡ªå®šä¹‰å®‰å…¨æ•æ„Ÿè¯æ±‡

åœ¨å°ç¨‹åºç®¡ç†åå°ï¼Œå¼€å‘ç®¡ç† -> å®‰å…¨ä¸­å¿ƒ -> å†…å®¹é£æ§ï¼š

![image-20210815144815314](uniapp.assets/image-20210815144815314.0bc0ee08.png)

> åœ¨è¿™é‡Œæ·»åŠ çš„åˆ†å€¼è¶Šé«˜ï¼Œè¶Šå¯èƒ½è¢«å±è”½ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#æµ‹è¯•æ¥å£å·¥å…·js)æµ‹è¯•æ¥å£å·¥å…·js

* åŠ å…¥accessTokenå¤±æ•ˆåˆ¤æ–­

  ```js
  instance.interceptors.response.use(async (res) => {
    const { data } = res
    if (data.errcode === 40001) {
      // é‡æ–°è·å–æ–°çš„accessToken
      const accessToken = await wxGetAccessToken(true)
      const { url } = res.config
      // é‡æ–°å‘èµ·è¯·æ±‚ -> res
      if (url.indexOf('access_token') !== -1) {
        const arr = url.split('?') // ?key=value&key1=value1... -> ['åŸŸå', 'key=value&key1=value1...']
        const params = qs.parse(arr[1])
        const newParams = {
          ...params,
          access_token: accessToken
        }
        const newUrl = arr[0] + '?' + qs.stringify(newParams)
        const config = { ...res.config, url: newUrl }
        const result = await axios(config)
        return result
      }
    }
    return res
  })
  ```

* æœ‰é£é™©çš„è¯æ±‡ï¼š

  ![image-20210815151921140](uniapp.assets/image-20210815151921140.02b4ac8e.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#å›¾ç‰‡å†…å®¹å®‰å…¨)å›¾ç‰‡å†…å®¹å®‰å…¨

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#æ•´ä½“æ€è·¯-2)æ•´ä½“æ€è·¯

* å›¾ç‰‡ä¸Šä¼ ä¹‹åï¼Œåˆ›å»ºtmpç›®å½•ï¼ˆä½¿ç”¨[make-dir (opens new window)](https://www.npmjs.com/package/make-dir)ï¼‰ï¼Œè·å–å›¾ç‰‡çš„åŸºæœ¬ä¿¡æ¯ï¼›
* åˆ¤æ–­å›¾ç‰‡çš„å°ºå¯¸ï¼Œå¦‚æœè¶…è¿‡äº†å¾®ä¿¡æ¥å£çš„åˆ†è¾¨ç‡è¦æ±‚750x1336ï¼Œé‚£éœ€è¦ä½¿ç”¨[sharp (opens new window)](https://www.npmjs.com/package/sharp)æ¥è¿›è¡Œå‹ç¼©;
* nodejsä¾§å¯¹æ¥å¾®ä¿¡æ¥å£éœ€è¦ä½¿ç”¨formDataæ•°æ®ç±»å‹ï¼Œæ‰€ä»¥è¿˜éœ€è¦å®‰è£…[form-data(opens new window)](https://www.npmjs.com/package/form-data)
* æœ€åè¿˜éœ€è¦åˆ é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œä½¿ç”¨[del (opens new window)](https://www.npmjs.com/package/del)åº“ï¼Œåˆ é™¤ä¹‹å‰ä½¿ç”¨[fs.access (opens new window)](https://nodejs.org/api/fs.html#fs_fs_accesssync_path_mode)è¿›è¡Œåˆ¤æ–­

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#å®˜æ–¹ä»‹ç»-2)å®˜æ–¹ä»‹ç»

è¯·æ±‚åœ°å€

```text
POST https://api.weixin.qq.com/wxa/img_sec_check?access_token=ACCESS_TOKEN
```

è¯·æ±‚å‚æ•°

| å±æ€§                                  | ç±»å‹     | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜                                                         |
| :------------------------------------ | :------- | :----- | :--- | :----------------------------------------------------------- |
| access_token / cloudbase_access_token | string   |        | æ˜¯   | [æ¥å£è°ƒç”¨å‡­è¯(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/access-token/auth.getAccessToken.html) |
| media                                 | FormData |        | æ˜¯   | è¦æ£€æµ‹çš„å›¾ç‰‡æ–‡ä»¶ï¼Œæ ¼å¼æ”¯æŒPNGã€JPEGã€JPGã€GIFï¼Œå›¾ç‰‡å°ºå¯¸ä¸è¶…è¿‡ 750px x 1334px |

è¿”å›çš„ JSON æ•°æ®åŒ…

| å±æ€§    | ç±»å‹   | è¯´æ˜     |
| :------ | :----- | :------- |
| errcode | number | é”™è¯¯ç    |
| errmsg  | string | é”™è¯¯ä¿¡æ¯ |

**errcode çš„åˆæ³•å€¼**

| å€¼    | è¯´æ˜             | æœ€ä½ç‰ˆæœ¬ |
| :---- | :--------------- | :------- |
| 0     | å†…å®¹æ­£å¸¸         |          |
| 87014 | å†…å®¹å¯èƒ½æ½œåœ¨é£é™© |          |

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#å·¥å…·jså°è£…-2)å·¥å…·jså°è£…

å®‰è£…ä¾èµ–ï¼š

```sh
npm i make-dir form-date sharp del
```

å…¶ä¸­[sharp (opens new window)](https://sharp.pixelplumbing.com/)éœ€è¦é…ç½®åŠ é€Ÿï¼š

```sh
npm config set sharp_binary_host "https://npm.taobao.org/mirrors/sharp"
npm config set sharp_libvips_binary_host "https://npm.taobao.org/mirrors/sharp-libvips"
```

å·¥å…·jsï¼š

```js
// è·å–å¤´éƒ¨å±æ€§
export const getHeaders = (form) => {
  return new Promise((resolve, reject) => {
    form.getLength((err, length) => {
      if (err) {
        reject(err)
      }
      const headers = Object.assign({
        'Content-Length': length
      }, form.getHeaders())
      resolve(headers)
    })
  })
}

// åˆ é™¤æ–‡ä»¶
export const checkAndDelFile = async (path) => {
  try {
    accessSync(path, constants.R_OK | constants.W_OK)
    await del(path)
  } catch (err) {
    // console.error('no access!')
  }
}

// å›¾ç‰‡å†…å®¹å®‰å…¨
export const wxImgCheck = async (file) => {
  // POST https://api.weixin.qq.com/wxa/img_sec_check?access_token=ACCESS_TOKEN
  const accessToken = await wxGetAccessToken()
  // 1.ä¿è¯å›¾ç‰‡ -> åˆ¤æ–­åˆ†è¾¨ç‡ -> sharp 750 * 1334
  let newPath = file.path
  const tmpPath = path.resolve('./tmp')
  try {
    const img = sharp(newPath)
    const meta = await img.metadata()
    if (meta.width > 750 || meta.height > 1334) {
      // åˆ¤æ–­ä¸´æ—¶è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åˆ›å»º
      await mkdir(tmpPath)
      // uuid -> æŒ‡å®šä¸´æ—¶çš„æ–‡ä»¶åç§°
      newPath = path.join(tmpPath, uuidv4() + path.extname(newPath) || '.jpg')
      await img.resize(750, 1334, {
        fit: 'inside'
      }).toFile(newPath)
    }
    const stream = fs.createReadStream(newPath)
    // 2.FormDataç±»å‹çš„æ•°æ®å‡†å¤‡
    const form = new FormData()
    form.append('media', stream)
    const headers = await getHeaders(form)
    // 3.è¯·æ±‚æ¥å£ -> è¿”å›ç»“æœ
    const result = await instance.post(`https://api.weixin.qq.com/wxa/img_sec_check?access_token=${accessToken}`, form, { headers })
    // æ ¡éªŒæˆåŠŸ -> åˆ é™¤tmpæ•°æ® -> åˆ¤æ–­è·¯å¾„ä¸­çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    console.log('ğŸš€ ~ file: WxUtils.js ~ line 232 ~ wxImgCheck ~ result', result)
    await checkAndDelFile(newPath)
    return result.status === 200 && result.data && result.data.errcode === 0
    // if (result.status === 200 && result.data && result.data.errcode === 0) {
    //   // errcode 0 - å†…å®¹æ­£å¸¸ï¼Œå¦åˆ™ - å¼‚å¸¸
    //   return true
    // } else {
    //   return false
    // }
  } catch (error) {
    await checkAndDelFile(newPath)
    logger.error(`wxImgCheck error: ${error.message}`)
  }
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/09-å†…å®¹å®‰å…¨.html#æµ‹è¯•æ¥å£å·¥å…·js-2)æµ‹è¯•æ¥å£å·¥å…·js

æ³¨æ„ï¼š

* è‡ªè¡Œæ‰¾ä¸€ä¸‹ç½‘ä¸Šå¯ç–‘çš„å›¾ç‰‡è¿›è¡Œæµ‹è¯•ï¼›
* errcodeä¸º0è¯´æ˜æ ¡éªŒé€šè¿‡ï¼Œåä¹‹ä¸é€šè¿‡ï¼›
* é€šè¿‡ä¹‹åï¼Œåˆ é™¤å›¾ç‰‡ä¸´æ—¶ç›®å½•ä¸­çš„æ–‡ä»¶ï¼›
* ä¸€èˆ¬ä¸Šä¼ å›¾ç‰‡çš„æ¥å£éœ€è¦å¯¹æ¥äº‘ä¸Šçš„å­˜å‚¨ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æœ¬åœ°ç¼“å­˜çš„æ–¹å¼æ ¡éªŒå›¾ç‰‡ï¼›

![image-20210815154746020](uniapp.assets/image-20210815154746020.dd53a2fe.png)



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#å‘è´´è¯„è®ºåŠŸèƒ½)å‘è´´è¯„è®ºåŠŸèƒ½

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#åˆ›å»ºåˆ†åŒ…)åˆ›å»ºåˆ†åŒ…

åœ¨uniappä¸­æ·»åŠ åˆ†åŒ…ï¼Œå‡å°‘ä¸»åŒ…ä½“ç§¯ï¼Œæå‡é¡µé¢åŠ è½½çš„æ€§èƒ½ï¼š

* æ–°å¢é¡µé¢ï¼Œ`/subcom-pkg/post/post`åŠ å…¥åŸºæœ¬çš„vueé¡µé¢çš„ç»“æ„

* é…ç½®`pages.json`

`pages.json`ä¸­é…ç½®åˆ†åŒ…ï¼š

```json
"subPackages": [
  {
    "root": "subcom-pkg",
    "pages": [
      ...
      {
        "path": "post/post",
        "style": {
          "navigationBarTitleText": "å‘è´´"
        }
      }
    ]
  }
]
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#è¡¨å•æ ¡éªŒ)è¡¨å•æ ¡éªŒ

ä½¿ç”¨uviewä¸­çš„[form (opens new window)](https://www.uviewui.com/components/form.html)è¡¨å•ç»„ä»¶ï¼š

```vue
<template>
  <view class="container">
    <u-form :model="form" ref="uForm" label-width="0">
      <u-form-item prop="title">
        <u-input v-model="form.title" placeholder="è¯·è¾“å…¥å¸–å­æ ‡é¢˜" clearable></u-input>
      </u-form-item>
      <u-form-item prop="content">
        <u-input v-model="form.content" placeholder="è¯·è¾“å…¥å¸–å­å†…å®¹" type="textarea"></u-input>
      </u-form-item>

      <view class="upload-img">
        <view class="prev">è®¾ç½®å°é¢å›¾ç‰‡:</view>
        <!-- ä¸Šä¼ å›¾ç‰‡ -->
      </view>
      <u-form-item :label-position="labelPosition" label="å‘è´´ç±»å‹" label-width="140" prop="catalog">
        <u-input class="right-text" type="select" :select-open="show1" v-model="form.catalog" placeholder="è¯·é€‰æ‹©å‘è´´ç±»å‹" @click="show1=true"></u-input>
        <u-select v-model="show1" :list="list" @confirm="confirmType"></u-select>
      </u-form-item>
      <!-- </view> -->
      <u-form-item label="å¥–åŠ±ç§¯åˆ†" label-width="140" prop="fav">
        <u-input class="right-text" type="select" :select-open="show" v-model="form.fav" placeholder="è¯·é€‰æ‹©å¥–åŠ±ç§¯åˆ†" @click="show=true"></u-input>
        <u-select v-model="show" :list="tempFavs" @confirm="confirmFav"></u-select>
      </u-form-item>
    </u-form>
    <view class="btn">
      <u-button size="default" type="primary" hover-class="none">å‘å¸ƒ</u-button>
    </view>
  </view>
</template>
```

åŠ å…¥è¡¨å•æ ¡éªŒï¼š

* é…ç½®`u-form`ä¸­çš„`model`å±æ€§ï¼Œ`ref`ç”¨äºæ ¡éªŒæ•´ä¸ªè¡¨å•ï¼›
* é…ç½®`u-form-item`ä¸­çš„`prop`å±æ€§ï¼Œé…ç½®å¯¹åº”çš„rulesè§„åˆ™
* åœ¨scriptçš„`onReady`å›è°ƒä¸­é…ç½®`this.$refs.uForm.setRules(this.rules)`

```js
<script>
export default {
  components: {},
  data: () => ({
    show: false,
    show1: false,
    form: {
      title: '',
      content: '',
      catalog: '',
      fav: '',
      snapshot: ''
    },
    rules: {
      title: [
        {
          required: true,
          message: 'è¯·è¾“å…¥æ ‡é¢˜',
          // å¯ä»¥å•ä¸ªæˆ–è€…åŒæ—¶å†™ä¸¤ä¸ªè§¦å‘éªŒè¯æ–¹å¼
          trigger: ['blur']
        }
      ],
      content: [
        {
          required: true,
          message: 'è¯·è¾“å…¥æ–‡ç« å†…å®¹',
          trigger: 'blur'
        }
      ],
      catalog: [
        {
          required: true,
          message: 'è¯·é€‰æ‹©å‘è´´ç±»å‹',
          // è§¦å‘å™¨å¯ä»¥åŒæ—¶ç”¨blurå’Œchange
          trigger: ['change', 'blur']
        }
      ],
      fav: [
        {
          required: true,
          message: 'è¯·é€‰æ‹©ç§¯åˆ†',
          trigger: ['change', 'blur']
        }
      ]
    },
    list: [
      {
        value: '',
        label: 'è¯·é€‰æ‹©'
      },
      {
        value: 'ask',
        label: 'æé—®'
      },
      {
        value: 'share',
        label: 'åˆ†äº«'
      },
      {
        value: 'discuss',
        label: 'è®¨è®º'
      },
      {
        value: 'advise',
        label: 'å»ºè®®'
      }
    ],
    listIndex: 0,
    tempFavs: [
      {
        label: 'è¯·é€‰æ‹©',
        value: ''
      },
      {
        label: '20',
        value: 20
      },
      {
        label: '30',
        value: 30
      },
      {
        label: '50',
        value: 50
      },
      {
        label: '100',
        value: 100
      }
    ],
    favIndex: 0,
    fileList: [],
    disabledButton: true
  }),
  methods: {
    confirmType (e) {
      const index = this.list.findIndex(item => item.value === e[0].value)
      this.listIndex = index
      this.form.catalog = e[0].label
    },
    confirmFav (e) {
      const index = this.tempFavs.findIndex(item => item.value === e[0].value)
      this.favIndex = index
      this.form.fav = e[0].label
    },
    addPost () {
      this.$refs.uForm.validate(async valid => {
        if (valid) {
          // to do
        } else {
          console.log('éªŒè¯å¤±è´¥')
        }
      })
    }
  },
  onReady () {
    this.$refs.uForm.setRules(this.rules)
  }
}
</script>
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#å›¾ç‰‡ä¸Šä¼ )å›¾ç‰‡ä¸Šä¼ 

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#ä¸Šä¼ æ¥å£)ä¸Šä¼ æ¥å£

ä¸Šä¼ formdataç±»å‹çš„æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨uni.uploadFile APIï¼Œå°è£…æˆä¸€ä¸ªpromiseè°…ï¼Œåœ¨completeä¸­åŠ å…¥callbackï¼Œæ–¹ä¾¿åç»­çš„å¤„ç†ï¼š

```js
// å›¾ç‰‡ä¸Šä¼ æ¥å£
const uploadImg = (params, callback) => {
  return new Promise((resolve, reject) => {
    uni.uploadFile({
      url: baseUrl + '/content/upload', // ä»…ä¸ºç¤ºä¾‹ï¼ŒéçœŸå®çš„æ¥å£åœ°å€
      filePath: params,
      name: 'file',
      header: {
        'Content-Type': 'multipart/form-data',
        authorization: 'Bearer ' + store.state.token
      },
      formData: {
        // 'user': 'test'
      },
      success: (uploadFileRes) => {
        resolve(uploadFileRes)
      },
      fail: (err) => {
        reject(err)
      },
      complete: (res) => {
        callback && callback(res)
      }
    })
  })
}

// å‘è´´æ¥å£
const addPost = (data) => axios.post('/content/wxAdd', data)
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#é¡µé¢ç»“æ„)é¡µé¢ç»“æ„

å¯ä»¥ä½¿ç”¨[u-upload (opens new window)](https://www.uviewui.com/components/upload.html)ç»„ä»¶æ¥è½»æ¾å®ç°å›¾ç‰‡ä¸Šä¼ ï¼š

```vue
<template>
  <view class="container">
    <u-form :model="form" ref="uForm" label-width="0">
      <u-form-item prop="title">
        <u-input v-model="form.title" placeholder="è¯·è¾“å…¥å¸–å­æ ‡é¢˜" clearable></u-input>
      </u-form-item>
      <u-form-item prop="content">
        <u-input v-model="form.content" placeholder="è¯·è¾“å…¥å¸–å­å†…å®¹" type="textarea"></u-input>
      </u-form-item>

      <view class="upload-img">
        <view class="prev">è®¾ç½®å°é¢å›¾ç‰‡:</view>
        <u-upload ref="uUpload" :file-list="fileList" action="#" :auto-upload="false" @on-list-change="uploadImg" multiple :max-size="5 * 1024 * 1024" max-count="1" />
      </view>
      <u-form-item :label-position="labelPosition" label="å‘è´´ç±»å‹" label-width="140" prop="catalog">
        <u-input class="right-text" type="select" :select-open="show1" v-model="form.catalog" placeholder="è¯·é€‰æ‹©å‘è´´ç±»å‹" @click="show1=true"></u-input>
        <u-select v-model="show1" :list="list" @confirm="confirmType"></u-select>
      </u-form-item>
      <!-- </view> -->
      <u-form-item label="å¥–åŠ±ç§¯åˆ†" label-width="140" prop="fav">
        <u-input class="right-text" type="select" :select-open="show" v-model="form.fav" placeholder="è¯·é€‰æ‹©å¥–åŠ±ç§¯åˆ†" @click="show=true"></u-input>
        <u-select v-model="show" :list="tempFavs" @confirm="confirmFav"></u-select>
      </u-form-item>
    </u-form>
    <view class="btn">
      <u-button size="default" type="primary" @click="addPost" hover-class="none">å‘å¸ƒ</u-button>
    </view>
  </view>
</template>

<script>
import { authNav } from '@/common/checkAuth'
export default {
  data: () => ({
    // ...
    fileList: [],
  }),
  methods: {
    // ....
    async uploadImg (lists, name) {
      if (lists.length > 0) {
        const res = await this.$u.api.uploadImg(lists[0].url)
        if (res.statusCode === 401) {
          await authNav('ç™»å½•å·²å¤±æ•ˆï¼Œå›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç™»å½•åé‡ä¼ ï¼')
          this.$refs.uUpload.clear()
        }
        if (res.statusCode === 200) {
          const { data } = res
          const { code, msg, data: url } = JSON.parse(data)
          if (code === 200) {
            this.form.snapshot = url
          }
          uni.showToast({
            icon: 'none',
            title: msg,
            duration: 2000
          })
        }
      }
    },
    // ...
  },
}
</script>
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#å®Œæˆæ•ˆæœ)å®Œæˆæ•ˆæœ

```vue
<template>
  <view class="container">
    <u-form :model="form" ref="uForm" label-width="0">
      <u-form-item prop="title">
        <u-input v-model="form.title" placeholder="è¯·è¾“å…¥å¸–å­æ ‡é¢˜" clearable></u-input>
      </u-form-item>
      <u-form-item prop="content">
        <u-input v-model="form.content" placeholder="è¯·è¾“å…¥å¸–å­å†…å®¹" type="textarea"></u-input>
      </u-form-item>

      <view class="upload-img">
        <view class="prev">è®¾ç½®å°é¢å›¾ç‰‡:</view>
        <u-upload ref="uUpload" :file-list="fileList" action="#" :auto-upload="false" @on-list-change="uploadImg" multiple :max-size="5 * 1024 * 1024" max-count="1" />
      </view>
      <u-form-item :label-position="labelPosition" label="å‘è´´ç±»å‹" label-width="140" prop="catalog">
        <u-input class="right-text" type="select" :select-open="show1" v-model="form.catalog" placeholder="è¯·é€‰æ‹©å‘è´´ç±»å‹" @click="show1=true"></u-input>
        <u-select v-model="show1" :list="list" @confirm="confirmType"></u-select>
      </u-form-item>
      <!-- </view> -->
      <u-form-item label="å¥–åŠ±ç§¯åˆ†" label-width="140" prop="fav">
        <u-input class="right-text" type="select" :select-open="show" v-model="form.fav" placeholder="è¯·é€‰æ‹©å¥–åŠ±ç§¯åˆ†" @click="show=true"></u-input>
        <u-select v-model="show" :list="tempFavs" @confirm="confirmFav"></u-select>
      </u-form-item>
    </u-form>
    <view class="btn">
      <u-button size="default" type="primary" @click="addPost" hover-class="none">å‘å¸ƒ</u-button>
    </view>
  </view>
</template>

<script>
import { mapMutations } from 'vuex'
import { authNav } from '@/common/checkAuth'
export default {
  components: {},
  data: () => ({
    show: false,
    show1: false,
    form: {
      title: '',
      content: '',
      catalog: '',
      fav: '',
      snapshot: ''
    },
    rules: {
      title: [
        {
          required: true,
          message: 'è¯·è¾“å…¥æ ‡é¢˜',
          // å¯ä»¥å•ä¸ªæˆ–è€…åŒæ—¶å†™ä¸¤ä¸ªè§¦å‘éªŒè¯æ–¹å¼
          trigger: ['blur']
        }
      ],
      content: [
        {
          required: true,
          message: 'è¯·è¾“å…¥æ–‡ç« å†…å®¹',
          trigger: 'blur'
        }
      ],
      catalog: [
        {
          required: true,
          message: 'è¯·é€‰æ‹©å‘è´´ç±»å‹',
          // è§¦å‘å™¨å¯ä»¥åŒæ—¶ç”¨blurå’Œchange
          trigger: ['change', 'blur']
        }
      ],
      fav: [
        {
          required: true,
          message: 'è¯·é€‰æ‹©ç§¯åˆ†',
          trigger: ['change', 'blur']
        }
      ]
    },
    list: [
      {
        value: '',
        label: 'è¯·é€‰æ‹©'
      },
      {
        value: 'ask',
        label: 'æé—®'
      },
      {
        value: 'share',
        label: 'åˆ†äº«'
      },
      {
        value: 'discuss',
        label: 'è®¨è®º'
      },
      {
        value: 'advise',
        label: 'å»ºè®®'
      }
    ],
    listIndex: 0,
    tempFavs: [
      {
        label: 'è¯·é€‰æ‹©',
        value: ''
      },
      {
        label: '20',
        value: 20
      },
      {
        label: '30',
        value: 30
      },
      {
        label: '50',
        value: 50
      },
      {
        label: '100',
        value: 100
      }
    ],
    favIndex: 0,
    fileList: [],
    disabledButton: true
  }),
  computed: {
  },
  methods: {
    ...mapMutations(['setPage']),
    confirmType (e) {
      const index = this.list.findIndex(item => item.value === e[0].value)
      this.listIndex = index
      this.form.catalog = e[0].label
    },
    confirmFav (e) {
      const index = this.tempFavs.findIndex(item => item.value === e[0].value)
      this.favIndex = index
      this.form.fav = e[0].label
    },
    async uploadImg (lists, name) {
      if (lists.length > 0) {
        const res = await this.$u.api.uploadImg(lists[0].url)
        if (res.statusCode === 401) {
          await authNav('ç™»å½•å·²å¤±æ•ˆï¼Œå›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç™»å½•åé‡ä¼ ï¼')
          this.$refs.uUpload.clear()
        }
        if (res.statusCode === 200) {
          const { data } = res
          const { code, msg, data: url } = JSON.parse(data)
          if (code === 200) {
            this.form.snapshot = url
          }
          uni.showToast({
            icon: 'none',
            title: msg,
            duration: 2000
          })
        }
      }
    },
    addPost () {
      this.$refs.uForm.validate(async valid => {
        if (valid) {
          const data = {
            ...this.form,
            catalog: this.list[this.listIndex].value,
            fav: this.tempFavs[this.favIndex].value
          }
          const { code, msg, data: res } = await this.$u.api.addPost(data)
          // console.log('ğŸš€ ~ file: post.vue ~ line 157 ~ addPost ~ res', res)
          if (code === 200 && res._id) {
            uni.showToast({
              icon: 'none',
              title: msg,
              duration: 2000
            })
            uni.navigateBack()
          } else {
            // å†…å®¹å®¡æ ¸æç¤º
            if (code === 500 && /å†…å®¹å®‰å…¨/.test(msg)) {
              uni.showModal({
                title: 'æ³¨æ„æ–‡æ˜ç”¨è¯­',
                content: 'å‘å¸ƒå†…å®¹æ²¡æœ‰é€šè¿‡å†…å®¹å®¡æ ¸ï¼Œè¯·æ£€æŸ¥åé‡æ–°ææ•ˆ',
                showCancel: false,
                success: function (res) {
                  console.log(res)
                }
              })
              return
            }
            uni.showToast({
              icon: 'none',
              title: msg,
              duration: 2000
            })
          }
        } else {
          console.log('éªŒè¯å¤±è´¥')
        }
      })
    }
  },
  onReady () {
    this.$refs.uForm.setRules(this.rules)
  }
}
</script>

<style lang="scss" scoped>
.container {
  padding: 32rpx;
}

::v-deep .edit-post {
  position: relative;
  textarea {
    max-height: 400rpx;
  }
  .u-clear-icon {
    position: absolute;
    right: 10rpx;
    bottom: 30rpx;
  }
}

.btn {
  margin-top: 60rpx;
}

::v-deep .right-text {
  .u-input__input {
    text-align: end;
    padding-right: 15rpx;
  }
}

.prev {
  padding: 15rpx 0 30rpx;
}
</style>
```

å®Œæˆæ•ˆæœï¼š

![image-20210527014805079](uniapp.assets/image-20210527014805079.5b658899.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#å‘å¸–æœåŠ¡ç«¯é€»è¾‘)å‘å¸–æœåŠ¡ç«¯é€»è¾‘

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#å›¾ç‰‡ä¸Šä¼ -2)å›¾ç‰‡ä¸Šä¼ 

```js
// ä¸Šä¼ å›¾ç‰‡
async uploadImg (ctx) {
  const file = ctx.request.files.file
  // è¿™é‡ŒåŠ å…¥å†…å®¹å®‰å…¨
  const flag = await wxImgCheck(file)
  if (!flag) {
    ctx.body = {
      code: 500,
      msg: 'å†…å®¹å®‰å…¨æ ¡éªŒå¤±è´¥ï¼Œè¯·æ£€æŸ¥'
    }
    return
  }
  // å›¾ç‰‡åç§°ã€å›¾ç‰‡æ ¼å¼ã€å­˜å‚¨çš„ä½ç½®ï¼Œè¿”å›å‰å°ä¸€å¯ä»¥è¯»å–çš„è·¯å¾„
  const ext = file.name.split('.').pop()
  const dir = `${config.uploadPath}/${moment().format('YYYYMMDD')}`
  // åˆ¤æ–­è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
  await mkdir(dir)
  // å­˜å‚¨æ–‡ä»¶åˆ°æŒ‡å®šçš„è·¯å¾„
  // ç»™æ–‡ä»¶ä¸€ä¸ªå”¯ä¸€çš„åç§°
  const picname = uuidv4()
  const destPath = `${dir}/${picname}.${ext}`
  const reader = fs.createReadStream(file.path)
  const upStream = fs.createWriteStream(destPath)
  const filePath = `/${moment().format('YYYYMMDD')}/${picname}.${ext}`
  // method 1
  reader.pipe(upStream)

  ctx.body = {
    code: 200,
    msg: 'å›¾ç‰‡ä¸Šä¼ æˆåŠŸ',
    data: filePath
  }
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#å‘å¸–æ¥å£)å‘å¸–æ¥å£

è°ƒæ•´æ•´ä½“çš„é€»è¾‘ï¼Œåˆ é™¤éªŒè¯ç çš„é€»è¾‘éƒ¨åˆ†ï¼Œå¹¶æ·»åŠ å†…å®¹å®‰å…¨æ ¡éªŒï¼š

```js
async addWxPost (ctx) {
  const { body } = ctx.request
  // æ ¡éªŒç”¨æˆ·ä¼ é€’çš„å‚æ•°ä¸å†…å®¹æ˜¯å¦é€šè¿‡å†…å®¹å®‰å…¨çš„æ ¡éªŒ
  // åˆ¤æ–­ç”¨æˆ·çš„ç§¯åˆ†æ•°æ˜¯å¦ > favï¼Œå¦åˆ™ï¼Œæç¤ºç”¨æˆ·ç§¯åˆ†ä¸è¶³å‘è´´
  // ç”¨æˆ·ç§¯åˆ†è¶³å¤Ÿçš„æ—¶å€™ï¼Œæ–°å»ºPostï¼Œå‡é™¤ç”¨æˆ·å¯¹åº”çš„ç§¯åˆ†
  const user = await User.findByID({ _id: ctx._id })
  const flag = await wxMsgCheck(body.content || '', { user: user, title: body.title })
  if (!flag) {
    ctx.body = {
      code: 500,
      msg: 'å†…å®¹å®‰å…¨æ ¡éªŒå¤±è´¥ï¼Œè¯·æ£€æŸ¥'
    }
    return
  }
  if (user.favs < body.fav) {
    ctx.body = {
      code: 501,
      msg: 'ç§¯åˆ†ä¸è¶³'
    }
    return
  } else {
    await User.updateOne({ _id: ctx._id }, { $inc: { favs: -body.fav } })
  }
  const newPost = new Post(body)
  newPost.uid = ctx._id
  const result = await newPost.save()
  ctx.body = {
    code: 200,
    msg: 'æˆåŠŸçš„ä¿å­˜çš„æ–‡ç« ',
    data: result
  }
}
```

æ·»åŠ è·¯ç”±ï¼š

```js
// å°ç¨‹åºå‘è¡¨æ–°è´´
router.post('/wxAdd', contentController.addWxPost)
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#è¯„è®ºåŠŸèƒ½)è¯„è®ºåŠŸèƒ½

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#åˆ›å»ºæ¥å£)åˆ›å»ºæ¥å£

```js
// è¯„è®ºæ¥å£
const addComment = (data) => axios.post('/comments/reply', data)
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#fixedåº•éƒ¨å®šä½é—®é¢˜)fixedåº•éƒ¨å®šä½é—®é¢˜

åœ¨å°ç¨‹åºä¸­ï¼Œä½¿ç”¨äº†fixedå®šä½çš„åº•éƒ¨å…ƒç´ å¯èƒ½è¢«é®æŒ¡ï¼š

è§£å†³æ–¹æ¡ˆï¼š

```vue
<!-- fixed: 1.static/absolute 2.ç‚¹å‡»è·³è½¬æ–°é¡µé¢ 3.cursor-spacing -->
<view class="box u-flex u-col-center" v-else>
  <u-input v-model="content" class="reply" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹" focus @clear="clear" :cursor-spacing="10"></u-input>
  <button type="primary" plain size="mini" @click.stop="send">å‘é€</button>
</view>
```

æ¨èï¼šä½¿ç”¨`cursor-spacing`ï¼Œ[å®˜æ–¹é“¾æ¥(opens new window)](https://developers.weixin.qq.com/miniprogram/dev/component/input.html)

![image-20210817235100442](uniapp.assets/image-20210817235100442.52657281.png)

å¦‚æœä¸è®¾ç½®ï¼Œé»˜è®¤æ˜¯0ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼šæµ®åŠ¨ä¸å‡†ç¡®çš„åŸå› ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#é¡µé¢æ ·å¼ä¸äº‹ä»¶)é¡µé¢æ ·å¼ä¸äº‹ä»¶

```vue
<template>
  <view class="detail" :class="{'ipx': ipxFlag}" v-show="page._id" @click.stop="showReply = false">
    // .....
    <view class="footer">
      <view class="box u-flex u-col-center" v-if="!showReply">
        <view class="add-comment" @click.stop="reply()">
          <u-icon name="edit-pen" size="32" color="#cccccc"></u-icon>
          <text class="text">å†™è¯„è®º</text>
        </view>
        <view class="ctrls u-flex u-col-center u-row-between">
          <view class="comment u-flex flex-column">
            <u-icon name="chat" size="45"></u-icon>
            <text>è¯„è®º{{ page.answer > 0 ? page.answer : ''}}</text>
          </view>
          <view class="fav u-flex flex-column" :class="{'active': page.isFav === 1}" @click="setCollect">
            <u-icon name="star-fill" size="45" v-if="page.isFav === 1"></u-icon>
            <u-icon name="star" size="45" v-else></u-icon>
            <text>{{page.isFav === 1 ? 'å·²æ”¶è—': 'æ”¶è—'}}</text>
          </view>
          <view class="like u-flex flex-column" :class="{'active': page.isHand === 1}" @click="handsPost">
            <u-icon name="thumb-up-fill" size="45" v-if="page.isHand === 1"></u-icon>
            <u-icon name="thumb-up" size="45" v-else></u-icon>
            <text>{{page.isHand === 1 ? 'å·²ç‚¹èµ' : 'ç‚¹èµ'}}</text>
          </view>
        </view>
      </view>
      <!-- fixed: 1.static/absolute 2.ç‚¹å‡»è·³è½¬æ–°é¡µé¢ 3.cursor-spacing -->
      <view class="box u-flex u-col-center" v-else>
        <u-input v-model="content" class="reply" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹" focus @clear="clear" :cursor-spacing="10"></u-input>
        <button type="primary" plain size="mini" @click.stop="send">å‘é€</button>
      </view>
    </view>
  </view>
</template>

<script>
import { mapGetters, mapState } from 'vuex'
import { checkToken } from '@/common/checkAuth'
import formatHTML from '@/common/utils/formatHTML'

export default {
  components: {},
  data: () => ({
    // ....
    content: '',
    showReply: false,
		// ...
  }),
  // ....
  methods: {
    // ....
    reply () {
      if (!this.check()) return
      this.showReply = true
    },
    async send () {
      const { code, msg } = await this.$u.api.addReply({ tid: this.params.tid, content: this.content })
      if (code === 200) {
        uni.$success(msg)
      } else {
        if (code === 500 && /å†…å®¹å®‰å…¨/.test(msg)) {
          uni.showModal({
            title: 'æ³¨æ„æ–‡æ˜ç”¨è¯­',
            content: 'å‘å¸ƒå†…å®¹æ²¡æœ‰é€šè¿‡å†…å®¹å®¡æ ¸ï¼Œè¯·æ£€æŸ¥åé‡æ–°ææ•ˆ',
            showCancel: false
          })
          return
        }
        uni.$error(msg)
      }
      await this.getReply()
      this.content = ''
      this.showReply = false
    },
  },
  // ...
}
</script>

<style lang="scss">
.detail {
  background: #f4f6f8;
  height: 100vh;
  &.ipx {
    .comments,
    .footer {
      padding-bottom: constant(safe-area-inset-bottom); // å…¼å®¹iOS < 11.2
      padding-bottom: env(safe-area-inset-bottom);
    }
  }
}

.header,
.content,
.comments {
  background: #fff;
  padding: 32rpx;
}

.header,
.content {
  margin-bottom: 24rpx;
  box-shadow: 0 5rpx 5px rgba($color: black, $alpha: 0.1);
}

.add-hand {
  position: relative;
  .caina {
    position: absolute;
    right: 100rpx;
    top: -20rpx;
  }
  .setBest {
    padding-left: 25rpx;
  }
}

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100vw;
  padding: 10px 32rpx;
  background-color: #fff;
  // height: 100rpx;
  box-shadow: 0 -5rpx 5px rgba($color: black, $alpha: 0.1);
  .box {
    width: 100%;
  }
  .reply {
    flex: 1;
    border: 1px solid #eee;
    padding: 0 15rpx;
    margin-right: 15rpx;
  }
}

.title {
  font-size: 32rpx;
  color: #333;
  font-weight: bold;
}
.add-comment {
  background: #f3f3f3;
  height: 64rpx;
  border-radius: 32rpx;
  line-height: 64rpx;
  padding: 0 32rpx;
  width: 65%;
  margin-right: 40rpx;
  color: #ccc;
  .text {
    padding-left: 10rpx;
  }
}

.loading {
  height: 50px;
  .loading-text {
    padding-left: 15rpx;
  }
}

.layui-elem-quote {
  margin-bottom: 10rpx;
  padding: 15rpx;
  line-height: 14px;
  border-left: 2px solid #009688;
  border-radius: 0 2px 2px 0;
  background-color: #f2f2f2;
}
</style>
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#è¯„è®ºæœåŠ¡ç«¯é€»è¾‘)è¯„è®ºæœåŠ¡ç«¯é€»è¾‘

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#éœ€æ±‚åˆ†æ)éœ€æ±‚åˆ†æ

* ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
* å†…å®¹å®‰å…¨æ£€æŸ¥
* è¯„è®º -> å‘é€è®¢é˜…æ¶ˆæ¯ç»™ç”¨æˆ·

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/10-å‘è´´&è¯„è®ºåŠŸèƒ½.html#è¯„è®ºæ¥å£)è¯„è®ºæ¥å£

è·¯ç”±ï¼š

```js
// å¾®ä¿¡è¯„è®ºå›å¤
router.post('/wxreply', commentsController.wxAddComment)
```

é€»è¾‘ä»£ç ï¼š

```js
const canReply = async (ctx) => {
  let result = false
  // const obj = await getJWTPayload(ctx.header.authorization)
  if (typeof ctx._id === 'undefined') {
    return result
  } else {
    const user = await User.findByID(ctx._id)
    if (user && user.status === '0') {
      result = true
    }
    return result
  }
}

async wxAddComment(ctx) {
    // æŸ¥çœ‹ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
    const check = await canReply(ctx)
    if (!check) {
      ctx.body = {
        code: 500,
        msg: 'ç”¨æˆ·å·²è¢«ç¦è¨€ï¼',
      }
      return
    }
    const { body } = ctx.request
    const result = await wxMsgCheck(body.content)
    if (result && ctx._id) {
      // const obj = await getJWTPayload(ctx.header.authorization)
      const user = await User.findByID(ctx._id)
      const newComment = new Comments(body)
      newComment.cuid = ctx._id
      // æ·»åŠ æ–‡ç« è¯„è®ºè®°æ•°
      await Post.updateOne({ _id: body.tid }, { $inc: { answer: 1 } })
      const post = await Post.findByPostId(body.tid)
      newComment.uid = post.uid._id // ä¿å­˜å¸–å­ä½œè€…çš„id
      const comment = await newComment.save()

      // è°ƒç”¨å¾®ä¿¡è®¢é˜…æ¶ˆæ¯api
      // 1ã€å‘å¸–çš„ä½œè€…å¿…é¡»æ˜¯ç”¨å¾®ä¿¡ç™»å½•çš„æ‰å¯ä»¥æ¥æ”¶è®¢é˜…æ¶ˆæ¯
      // 2ã€è‡ªå·±ä¸èƒ½ç»™è‡ªå·±å‘è®¢é˜…æ¶ˆæ¯
      // if (post.uid.openid) {
      if (ctx._id !== post.uid._id.toString() && post.uid.openid) {
        const notice = await wxSendMessage({
          touser: post.uid.openid,
          template_id: 'ANN2-LhDgrhdFjs7jHOLdTnaxWpQU1LqS3kDIMF9GDs',
          data: {
            thing1: {
              value: getShort(post.title),
            },
            thing4: {
              value: getCatalog(post.catalog),
            },
            thing2: {
              value: getShort(comment.content),
            },
            name6: {
              value: user.name.substr(0, 10),
            },
            date3: {
              value: moment().format('YYYYå¹´MMæœˆDD HH:mm'),
            },
          },
          page: '/subcom-pkg/detail/detail?tid=' + post._id,
        })
        console.log(notice)
      }

      ctx.body = {
        msg: 'å›å¸–æˆåŠŸ',
        code: 200,
        data: comment,
      }
    } else {
      ctx.body = {
        code: 500,
        msg: 'å†…å®¹å®‰å…¨ï¼š' + result.errmsg,
      }
    }
  }
```



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#å‘å¸ƒä¸Šçº¿)å‘å¸ƒä¸Šçº¿

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#åˆ†åŒ…æœºåˆ¶)åˆ†åŒ…æœºåˆ¶

æŸäº›æƒ…å†µä¸‹ï¼Œå¼€å‘è€…éœ€è¦å°†å°ç¨‹åºåˆ’åˆ†æˆä¸åŒçš„å­åŒ…ï¼Œåœ¨æ„å»ºæ—¶æ‰“åŒ…æˆä¸åŒçš„åˆ†åŒ…ï¼Œç”¨æˆ·åœ¨ä½¿ç”¨æ—¶æŒ‰éœ€è¿›è¡ŒåŠ è½½ã€‚

![image-20210818000627795](uniapp.assets/image-20210818000627795.e1b5dd91.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#æ™®é€šåˆ†åŒ…)æ™®é€šåˆ†åŒ…

åœ¨æ„å»ºå°ç¨‹åºåˆ†åŒ…é¡¹ç›®æ—¶ï¼Œæ„å»ºä¼šè¾“å‡ºä¸€ä¸ªæˆ–å¤šä¸ªåˆ†åŒ…ã€‚

æ¯ä¸ªä½¿ç”¨åˆ†åŒ…å°ç¨‹åºå¿…å®šå«æœ‰ä¸€ä¸ª**ä¸»åŒ…**ã€‚

æ‰€è°“çš„ä¸»åŒ…ï¼Œå³æ”¾ç½®é»˜è®¤å¯åŠ¨é¡µé¢/TabBar é¡µé¢ï¼Œä»¥åŠä¸€äº›æ‰€æœ‰åˆ†åŒ…éƒ½éœ€ç”¨åˆ°å…¬å…±èµ„æº/JS è„šæœ¬ï¼›è€Œ**åˆ†åŒ…**åˆ™æ˜¯æ ¹æ®å¼€å‘è€…çš„é…ç½®è¿›è¡Œåˆ’åˆ†ã€‚

åœ¨å°ç¨‹åºå¯åŠ¨æ—¶ï¼Œé»˜è®¤ä¼šä¸‹è½½ä¸»åŒ…å¹¶å¯åŠ¨ä¸»åŒ…å†…é¡µé¢ï¼Œå½“ç”¨æˆ·è¿›å…¥åˆ†åŒ…å†…æŸä¸ªé¡µé¢æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šæŠŠå¯¹åº”åˆ†åŒ…ä¸‹è½½ä¸‹æ¥ï¼Œä¸‹è½½å®Œæˆåå†è¿›è¡Œå±•ç¤ºã€‚

ç›®å‰å°ç¨‹åºåˆ†åŒ…å¤§å°æœ‰ä»¥ä¸‹é™åˆ¶ï¼š

* æ•´ä¸ªå°ç¨‹åºæ‰€æœ‰åˆ†åŒ…å¤§å°ä¸è¶…è¿‡ 20M
* å•ä¸ªåˆ†åŒ…/ä¸»åŒ…å¤§å°ä¸èƒ½è¶…è¿‡ 2M

å¯¹å°ç¨‹åºè¿›è¡Œåˆ†åŒ…ï¼Œå¯ä»¥ä¼˜åŒ–å°ç¨‹åºé¦–æ¬¡å¯åŠ¨çš„ä¸‹è½½æ—¶é—´ï¼Œä»¥åŠåœ¨å¤šå›¢é˜Ÿå…±åŒå¼€å‘æ—¶å¯ä»¥æ›´å¥½çš„è§£è€¦åä½œã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#ç‹¬ç«‹åˆ†åŒ…)ç‹¬ç«‹åˆ†åŒ…

ç‹¬ç«‹åˆ†åŒ…æ˜¯å°ç¨‹åºä¸­ä¸€ç§ç‰¹æ®Šç±»å‹çš„åˆ†åŒ…ï¼Œå¯ä»¥ç‹¬ç«‹äºä¸»åŒ…å’Œå…¶ä»–åˆ†åŒ…è¿è¡Œã€‚ä»ç‹¬ç«‹åˆ†åŒ…ä¸­é¡µé¢è¿›å…¥å°ç¨‹åºæ—¶ï¼Œä¸éœ€è¦ä¸‹è½½ä¸»åŒ…ã€‚å½“ç”¨æˆ·è¿›å…¥æ™®é€šåˆ†åŒ…æˆ–ä¸»åŒ…å†…é¡µé¢æ—¶ï¼Œä¸»åŒ…æ‰ä¼šè¢«ä¸‹è½½ã€‚

ç‹¬ç«‹åˆ†åŒ…å±äºåˆ†åŒ…çš„ä¸€ç§ï¼Œæ™®é€šåˆ†åŒ…çš„æ‰€æœ‰é™åˆ¶éƒ½å¯¹ç‹¬ç«‹åˆ†åŒ…æœ‰æ•ˆï¼ˆ2Må¤§å°ï¼‰ã€‚ç‹¬ç«‹åˆ†åŒ…ä¸­æ’ä»¶ã€è‡ªå®šä¹‰ç»„ä»¶çš„å¤„ç†æ–¹å¼åŒæ™®é€šåˆ†åŒ…ã€‚

æ­¤å¤–ï¼Œä½¿ç”¨ç‹¬ç«‹åˆ†åŒ…æ—¶è¦æ³¨æ„ï¼š

* **ç‹¬ç«‹åˆ†åŒ…ä¸­ä¸èƒ½ä¾èµ–ä¸»åŒ…å’Œå…¶ä»–åˆ†åŒ…ä¸­çš„å†…å®¹**ï¼ŒåŒ…æ‹¬ js æ–‡ä»¶ã€templateã€wxssã€è‡ªå®šä¹‰ç»„ä»¶ã€æ’ä»¶ç­‰ã€‚

* ä¸»åŒ…ä¸­çš„ `app.wxss` å¯¹ç‹¬ç«‹åˆ†åŒ…æ— æ•ˆï¼Œåº”é¿å…åœ¨ç‹¬ç«‹åˆ†åŒ…é¡µé¢ä¸­ä½¿ç”¨ `app.wxss` ä¸­çš„æ ·å¼ï¼›

* `App` åªèƒ½åœ¨ä¸»åŒ…å†…å®šä¹‰ï¼Œç‹¬ç«‹åˆ†åŒ…ä¸­ä¸èƒ½å®šä¹‰ `App`ï¼Œä¼šé€ æˆæ— æ³•é¢„æœŸçš„è¡Œä¸ºï¼›

  ä¸æ™®é€šåˆ†åŒ…ä¸åŒï¼Œç‹¬ç«‹åˆ†åŒ…è¿è¡Œæ—¶ï¼Œ`App` å¹¶ä¸ä¸€å®šè¢«æ³¨å†Œï¼Œå› æ­¤ `getApp()` ä¹Ÿä¸ä¸€å®šå¯ä»¥è·å¾— `App` å¯¹è±¡ï¼›

* ç‹¬ç«‹åˆ†åŒ…ä¸­æš‚æ—¶ä¸æ”¯æŒä½¿ç”¨æ’ä»¶ã€‚

* ç”±äºç‹¬ç«‹åˆ†åŒ…ä¸­æ— æ³•å®šä¹‰ `App`ï¼Œå°ç¨‹åºç”Ÿå‘½å‘¨æœŸçš„ç›‘å¬å¯ä»¥ä½¿ç”¨ [wx.onAppShow (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onAppShow.html)ï¼Œ[wx.onAppHide (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onAppHide.html)å®Œæˆã€‚

  `App` ä¸Šçš„å…¶ä»–äº‹ä»¶å¯ä»¥ä½¿ç”¨ [wx.onError (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onError.html)ï¼Œ[wx.onPageNotFound (opens new window)](https://developers.weixin.qq.com/miniprogram/dev/api/base/app/app-event/wx.onPageNotFound.html)ç›‘å¬ã€‚

> åº”ç”¨åœºæ™¯ï¼šæ´»åŠ¨é¡µé¢ã€ç™»å½•æ³¨å†Œç›¸å…³é¡µé¢...
>
> å¤§å¤šæ•°ç‹¬ç«‹åˆ†åŒ…çš„åœºæ™¯ï¼Œä½¿ç”¨åˆ†åŒ…ä¹Ÿå¯ä»¥å¾ˆå¥½çš„å®Œæˆå¯¹åº”çš„åŠŸèƒ½ï¼Œè€Œä¸”å¯ä»¥å…±äº«ä¸»åŒ…çš„æ ·å¼ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#åˆ†åŒ…é¢„åŠ è½½)åˆ†åŒ…é¢„åŠ è½½

å¼€å‘è€…å¯ä»¥é€šè¿‡é…ç½®ï¼Œåœ¨è¿›å…¥å°ç¨‹åºæŸä¸ªé¡µé¢æ—¶ï¼Œç”±æ¡†æ¶è‡ªåŠ¨é¢„ä¸‹è½½å¯èƒ½éœ€è¦çš„åˆ†åŒ…ï¼Œæå‡è¿›å…¥åç»­åˆ†åŒ…é¡µé¢æ—¶çš„å¯åŠ¨é€Ÿåº¦ã€‚

é¢„ä¸‹è½½åˆ†åŒ…è¡Œä¸ºåœ¨è¿›å…¥æŸä¸ªé¡µé¢æ—¶è§¦å‘ï¼Œé€šè¿‡åœ¨ `app.json` å¢åŠ  `preloadRule` é…ç½®æ¥æ§åˆ¶ã€‚

```js
"preloadRule": {
    "è¿›å…¥çš„é¡µé¢": {
      "network": "all",
      "packages": ["åŠ è½½çš„åŒ…ä¸­çš„é¡µé¢", "æˆ–è€…åŠ è½½æ•´ä¸ªç›®å½•"]
    },
    "sub1/index": {
      "packages": ["hello", "sub3"]
    },
    "sub3/index": {
      "packages": ["path/to"]
    },
    "indep/index": {
      "packages": ["__APP__"]
    }
  }
```

`preloadRule` ä¸­ï¼Œ`key` æ˜¯é¡µé¢è·¯å¾„ï¼Œ`value` æ˜¯è¿›å…¥æ­¤é¡µé¢çš„é¢„ä¸‹è½½é…ç½®ï¼Œæ¯ä¸ªé…ç½®æœ‰ä»¥ä¸‹å‡ é¡¹ï¼š

| å­—æ®µ     | ç±»å‹        | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜                                                         |
| :------- | :---------- | :--- | :----- | :----------------------------------------------------------- |
| packages | StringArray | æ˜¯   | æ—      | è¿›å…¥é¡µé¢åé¢„ä¸‹è½½åˆ†åŒ…çš„ `root` æˆ– `name`ã€‚`__APP__` è¡¨ç¤ºä¸»åŒ…ã€‚ |
| network  | String      | å¦   | wifi   | åœ¨æŒ‡å®šç½‘ç»œä¸‹é¢„ä¸‹è½½ï¼Œå¯é€‰å€¼ä¸ºï¼š `all`: ä¸é™ç½‘ç»œ `wifi`: ä»…wifiä¸‹é¢„ä¸‹è½½ |

è¯´æ˜ï¼š

* `network`å»ºè®®ä½¿ç”¨`all`ï¼›
* æ‰€æœ‰é¢„ä¸‹è½½çš„åˆ†åŒ…çš„æ€»ä½“ç§¯è¦å°äº2mï¼Œé™é¢ä¼šæ‰“åŒ…è‡ªåŠ¨æ ¡éªŒï¼›

> ä¸æ˜¯å¿…è¦ï¼Œä¸æ˜¯éå¸¸å½±å“ç”¨æˆ·çš„äº¤äº’ä½“éªŒï¼Œä¸è¦å ç”¨é¢„ä¸‹è½½åˆ†åŒ…çš„ä»½é¢ï¼Œä¸è¦ä½¿ç”¨å¤§äº40kçš„å›¾ç‰‡ä¸èµ„æºã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#æ£€æŸ¥åˆ†åŒ…å¤§å°)æ£€æŸ¥åˆ†åŒ…å¤§å°

* ä½¿ç”¨HBuilderä¸­çš„å‘å¸ƒæ–¹å¼æ‰“åŒ…ï¼›

  

* åœ¨è¯¦æƒ…ä¸­è¿›è¡ŒæŸ¥çœ‹ï¼š

  

  ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼Œç”¨äºæ’æŸ¥å“ªäº›æ¯”è¾ƒå¤§çš„èµ„æºï¼š

  ![image-20210818001614038](uniapp.assets/image-20210818001614038.b58d4f6c.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#åŸºæœ¬æµç¨‹)åŸºæœ¬æµç¨‹

![img](uniapp.assets/5.2.ac870e6c.ac870e6c.png)

* æµ‹è¯•-æ£€æŸ¥-æ‰“åŒ…-é…ç½®
* åœ¨å¼€å‘å·¥å…·ä¸­ä¸Šä¼ 
* ç®¡ç†åå°ä¸­ï¼Œæäº¤å®¡æ ¸ï¼Œé€šè¿‡åå‘å¸ƒ

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#æˆå‘˜è¯´æ˜)æˆå‘˜è¯´æ˜

å°ç¨‹åºæˆå‘˜ç®¡ç†åŒ…æ‹¬å¯¹å°ç¨‹åºé¡¹ç›®æˆå‘˜åŠä½“éªŒæˆå‘˜çš„ç®¡ç†ã€‚

* é¡¹ç›®æˆå‘˜ï¼šè¡¨ç¤ºå‚ä¸å°ç¨‹åºå¼€å‘ã€è¿è¥çš„æˆå‘˜ï¼Œå¯ç™»å½•å°ç¨‹åºç®¡ç†åå°ï¼ŒåŒ…æ‹¬è¿è¥è€…ã€å¼€å‘è€…åŠæ•°æ®åˆ†æè€…ã€‚ç®¡ç†å‘˜å¯åœ¨â€œæˆå‘˜ç®¡ç†â€ä¸­æ·»åŠ ã€åˆ é™¤é¡¹ç›®æˆå‘˜ï¼Œå¹¶è®¾ç½®é¡¹ç›®æˆå‘˜çš„è§’è‰²ã€‚
* ä½“éªŒæˆå‘˜ï¼šè¡¨ç¤ºå‚ä¸å°ç¨‹åºå†…æµ‹ä½“éªŒçš„æˆå‘˜ï¼Œå¯ä½¿ç”¨ä½“éªŒç‰ˆå°ç¨‹åºï¼Œä½†ä¸å±äºé¡¹ç›®æˆå‘˜ã€‚ç®¡ç†å‘˜åŠé¡¹ç›®æˆå‘˜å‡å¯æ·»åŠ ã€åˆ é™¤ä½“éªŒæˆå‘˜ã€‚

ä¸åŒé¡¹ç›®æˆå‘˜æ‹¥æœ‰ä¸åŒçš„æƒé™ï¼Œä»è€Œä¿è¯å°ç¨‹åºå¼€å‘å®‰å…¨æœ‰åºã€‚

| æƒé™           | è¿è¥è€… | å¼€å‘è€… | æ•°æ®åˆ†æè€… |
| :------------- | :----- | :----- | :--------- |
| å¼€å‘è€…æƒé™     |        | âˆš      |            |
| ä½“éªŒè€…æƒé™     | âˆš      | âˆš      | âˆš          |
| ç™»å½•           | âˆš      | âˆš      | âˆš          |
| æ•°æ®åˆ†æ       |        |        | âˆš          |
| å¾®ä¿¡æ”¯ä»˜       | âˆš      |        |            |
| æ¨å¹¿           | âˆš      |        |            |
| å¼€å‘ç®¡ç†       | âˆš      |        |            |
| å¼€å‘è®¾ç½®       |        | âˆš      |            |
| æš‚åœæœåŠ¡       | âˆš      |        |            |
| è§£é™¤å…³è”å…¬ä¼—å· | âˆš      |        |            |
| è…¾è®¯äº‘ç®¡ç†     |        | âˆš      |            |
| å°ç¨‹åºæ’ä»¶     | âˆš      |        |            |
| æ¸¸æˆè¿è¥ç®¡ç†   | âˆš      |        |            |

é…ç½®è·¯å¾„ï¼šç™»å½•https://mp.weixin.qq.com/ï¼Œé€‰æ‹©ç®¡ç† -> æˆå‘˜ç®¡ç† -> æ·»åŠ é¡¹ç›®æˆå‘˜ï¼Œæœ€å¤š100ä¸ªï¼›ä½“éªŒæˆå‘˜->æœ€å¤š100ä¸ªï¼ˆå·²è®¤è¯ï¼‰ï¼›

![image-20210818123401415](uniapp.assets/image-20210818123401415.973c514f.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#ç‰ˆæœ¬è¯´æ˜)ç‰ˆæœ¬è¯´æ˜

| **æƒé™**   | **è¯´æ˜**                                                     |
| :--------- | :----------------------------------------------------------- |
| å¼€å‘ç‰ˆæœ¬   | ä½¿ç”¨å¼€å‘è€…å·¥å…·ï¼Œå¯å°†ä»£ç ä¸Šä¼ åˆ°å¼€å‘ç‰ˆæœ¬ä¸­ã€‚ å¼€å‘ç‰ˆæœ¬åªä¿ç•™æ¯äººæœ€æ–°çš„ä¸€ä»½ä¸Šä¼ çš„ä»£ç ã€‚ ç‚¹å‡»æäº¤å®¡æ ¸ï¼Œå¯å°†ä»£ç æäº¤å®¡æ ¸ã€‚å¼€å‘ç‰ˆæœ¬å¯åˆ é™¤ï¼Œä¸å½±å“çº¿ä¸Šç‰ˆæœ¬å’Œå®¡æ ¸ä¸­ç‰ˆæœ¬çš„ä»£ç ã€‚ |
| ä½“éªŒç‰ˆæœ¬   | å¯ä»¥é€‰æ‹©æŸä¸ªå¼€å‘ç‰ˆæœ¬ä½œä¸ºä½“éªŒç‰ˆï¼Œå¹¶ä¸”é€‰å–ä¸€ä»½ä½“éªŒç‰ˆã€‚         |
| å®¡æ ¸ä¸­ç‰ˆæœ¬ | åªèƒ½æœ‰ä¸€ä»½ä»£ç å¤„äºå®¡æ ¸ä¸­ã€‚æœ‰å®¡æ ¸ç»“æœåå¯ä»¥å‘å¸ƒåˆ°çº¿ä¸Šï¼Œä¹Ÿå¯ç›´æ¥é‡æ–°æäº¤å®¡æ ¸ï¼Œè¦†ç›–åŸå®¡æ ¸ç‰ˆæœ¬ã€‚ |
| çº¿ä¸Šç‰ˆæœ¬   | çº¿ä¸Šæ‰€æœ‰ç”¨æˆ·ä½¿ç”¨çš„ä»£ç ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬ä»£ç åœ¨æ–°ç‰ˆæœ¬ä»£ç å‘å¸ƒåè¢«è¦†ç›–æ›´æ–°ã€‚ |

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#æ³¨æ„äº‹é¡¹)æ³¨æ„äº‹é¡¹

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#é…ç½®baseurl)é…ç½®BaseURL

```js
export const baseUrl = process.env.NODE_ENV === 'development' ? 'http://192.168.31.132:3000' : 'https://yourdomain.com'
```

> uniappå†…ç½®çš„æ‰“åŒ…å·¥å…·å³æ˜¯webpack

è¯´æ˜ï¼š

* uniappä¸­ï¼Œä½¿ç”¨å‘å¸ƒæ–¹å¼æ‰“åŒ…ï¼Œå³`process.env.NODE_ENV`ä¼šè‡ªåŠ¨è®¾ç½®æˆ`production`ï¼›

* åœ¨ä¸Šçº¿ä¹‹å‰ï¼Œè¯·ç¡®ä¿é…ç½®äº†apiåå°é¡¹ç›®ï¼Œå¹¶ç”³è¯·äº†åŸŸåï¼Œé…ç½®å¥½äº†HTTPSæœåŠ¡ï¼›

* åœ¨å°ç¨‹åºåå°ä¸­ï¼Œæ·»åŠ å®‰å…¨åŸŸåï¼š

  

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#ä½¿ç”¨hbuilderç”Ÿäº§æ‰“åŒ…æ–¹å¼)ä½¿ç”¨HBuilderç”Ÿäº§æ‰“åŒ…æ–¹å¼

ä¸€å®šè¦æ³¨æ„ï¼Œåœ¨uniappä¸­å¼€å‘çš„æ—¶å€™ï¼Œå¯åŠ¨çš„æ˜¯è°ƒè¯•è¿›ç¨‹ï¼Œè¿™æ—¶çš„ä»£ç ä¸­æœ‰å¾ˆå¤šè°ƒè¯•ä»£ç ï¼Œä¹Ÿæœªè¿›è¡Œå‹ç¼©ã€‚

æ­¥éª¤ï¼š

* æ‰“å¼€é¡¹ç›®çš„`pages.json`æ–‡ä»¶ï¼›

* ç‚¹å‡»é¡¶éƒ¨çš„èœå•ï¼š`å‘è¡Œ`-> `å°ç¨‹åº-å¾®ä¿¡`

  

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#æ‰“åŒ…ä¸Šçº¿)æ‰“åŒ…ä¸Šçº¿

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#å°ç¨‹åºæ‰“åŒ…)å°ç¨‹åºæ‰“åŒ…

è§ [æ£€æŸ¥åˆ†åŒ…å¤§å°](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#æ£€æŸ¥åˆ†åŒ…å¤§å°)ï¼Œæ³¨æ„è¿™é‡Œçš„é¡¹ç›®åç§°å¹¶éå°ç¨‹åºçš„é¡¹ç›®åç§°ã€‚

> å°ç¨‹åºçš„åç§°åœ¨æ³¨å†Œå°ç¨‹åºçš„æ—¶å€™ï¼Œå°±å·²ç»ç¡®å®šä¸‹æ¥äº†ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªé¡¹ç›®åˆ«åã€‚

è¯·æ£€æŸ¥å°ç¨‹åºçš„AppIDã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#ä¸Šä¼ ä»£ç )ä¸Šä¼ ä»£ç 

![image-20210818123801710](uniapp.assets/image-20210818123801710.34fb94d4.png)

ä¸Šä¼ ä»£ç æ˜¯ç”¨äºæäº¤ä½“éªŒæˆ–è€…å®¡æ ¸ä½¿ç”¨çš„ã€‚

ç‚¹å‡»å¼€å‘è€…å·¥å…·é¡¶éƒ¨æ“ä½œæ çš„ä¸Šä¼ æŒ‰é’®ï¼Œå¡«å†™ç‰ˆæœ¬å·ä»¥åŠé¡¹ç›®å¤‡æ³¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œç‰ˆæœ¬å·ä»¥åŠé¡¹ç›®å¤‡æ³¨æ˜¯ä¸ºäº†æ–¹ä¾¿ç®¡ç†å‘˜æ£€æŸ¥ç‰ˆæœ¬ä½¿ç”¨çš„ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…è¦æ±‚æ¥å¡«å†™è¿™ä¸¤ä¸ªå­—æ®µã€‚

![image-20210818124047238](uniapp.assets/image-20210818124047238.169f3490.png)

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#å®¡æ ¸ä¸å‘å¸ƒ)å®¡æ ¸ä¸å‘å¸ƒ

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#å®¡æ ¸ç‰ˆæœ¬)å®¡æ ¸ç‰ˆæœ¬

ä¸Šä¼ æˆåŠŸä¹‹åï¼Œç™»å½•[å°ç¨‹åºç®¡ç†åå° (opens new window)](https://mp.weixin.qq.com/)- å¼€å‘ç®¡ç† - å¼€å‘ç‰ˆæœ¬ å°±å¯ä»¥æ‰¾åˆ°åˆšæäº¤ä¸Šä¼ çš„ç‰ˆæœ¬äº†ã€‚

å¯ä»¥å°†è¿™ä¸ªç‰ˆæœ¬è®¾ç½® ä½“éªŒç‰ˆ æˆ–è€…æ˜¯ æäº¤å®¡æ ¸ã€‚

![image-20210818124719121](uniapp.assets/image-20210818124719121.d35f55fa.png)

ç„¶åç‚¹å‡»ä¸‹ä¸€æ­¥ï¼š

![image-20210818124806867](uniapp.assets/image-20210818124806867.cce75ad9.png)

è¯´æ˜ï¼š

* åŠ æ€¥çš„æƒ…å†µï¼šä¸ç”¨æˆ·çš„é’±æœ‰å…³ï¼Œä¸å¹³å°çš„ç¨³å®šæœ‰å…³ï¼Œä¸è‡ªèº«çš„åˆ©ç›Šæœ‰å…³ï¼Œæ‰åŠ æ€¥â€”â€”æ…ç”¨ï¼›
* ä¸Šé¢ä¸€èˆ¬è¦å†™ä¸€ä¸ªæ³¨é‡Šï¼Œè¯´æ˜ç‰ˆæœ¬çš„å‡çº§æƒ…å†µï¼›

å®¡æ ¸ä¸­ï¼š

![image-20210818125910968](uniapp.assets/image-20210818125910968.f62dbdcc.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/11-å‘å¸ƒä¸Šçº¿.html#å…³äºç°åº¦å‘å¸ƒ)å…³äºç°åº¦å‘å¸ƒ

å®¡æ ¸é€šè¿‡åï¼Œéœ€è¦åœ¨é¡µé¢ä¸­ç‚¹å‡»å‘å¸ƒï¼Œé€‰æ‹©å…¨é‡å‘å¸ƒæˆ–è€…æŒ‡å®šç”¨æˆ·è¿›è¡Œå‘å¸ƒï¼ˆç°åº¦æµ‹è¯•ï¼‰ã€‚

ç‚¹å‡»å‘å¸ƒåï¼Œå³å¯å‘å¸ƒå°ç¨‹åºã€‚å°ç¨‹åºæä¾›äº†ä¸¤ç§å‘å¸ƒæ¨¡å¼ï¼šå…¨é‡å‘å¸ƒå’Œåˆ†é˜¶æ®µå‘å¸ƒã€‚å…¨é‡å‘å¸ƒæ˜¯æŒ‡å½“ç‚¹å‡»å‘å¸ƒä¹‹åï¼Œæ‰€æœ‰ç”¨æˆ·è®¿é—®å°ç¨‹åºæ—¶éƒ½ä¼šä½¿ç”¨å½“å‰æœ€æ–°çš„å‘å¸ƒç‰ˆæœ¬ã€‚

åˆ†é˜¶æ®µå‘å¸ƒæ˜¯æŒ‡åˆ†ä¸åŒæ—¶é—´æ®µæ¥æ§åˆ¶éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨æœ€æ–°çš„å‘å¸ƒç‰ˆæœ¬ï¼Œåˆ†é˜¶æ®µå‘å¸ƒæˆ‘ä»¬ä¹Ÿç§°ä¸ºç°åº¦å‘å¸ƒã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ™®é€šå°ç¨‹åºå‘å¸ƒæ—¶é‡‡ç”¨å…¨é‡å‘å¸ƒå³å¯ï¼Œå½“å°ç¨‹åºæ‰¿è½½çš„åŠŸèƒ½è¶Šæ¥è¶Šå¤šï¼Œä½¿ç”¨çš„ç”¨æˆ·æ•°è¶Šæ¥è¶Šå¤šæ—¶ï¼Œé‡‡ç”¨åˆ†é˜¶æ®µå‘å¸ƒæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ§åˆ¶é£é™©çš„åŠæ³•ã€‚



# [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æ”¯ä»˜ä¸“é¢˜)æ”¯ä»˜ä¸“é¢˜

æ”¯ä»˜ä½œä¸ºå·¥ä½œä¸­æœ€å¸¸è§çš„ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡åœºæ™¯ï¼Œå‰ç«¯åŒå­¦å…¶å®éœ€è¦åšçš„ä¸œè¥¿æœ‰é™ï¼ŒåŸºæœ¬çš„æµç¨‹ã€é€»è¾‘ä¸éš¾ç‚¹éƒ½æ˜¯åœ¨æœåŠ¡ç«¯ã€‚ä¸ºäº†è®©å‰ç«¯åŒå­¦ï¼Œä¹Ÿèƒ½è‡ªå·±åç»­å¼€å‘æ”¯ä»˜åŠŸèƒ½ï¼ˆNode.jsï¼‰ï¼Œåœ¨æœ¬ç¯‡ä»‹ç»äº†è¯¦ç»†çš„ä»ä¼ä¸šä¸»ä½“ -> æ”¯ä»˜å¿…è¦æ¡ä»¶ ->å¾®ä¿¡å°ç¨‹åºæ”¯ä»˜å®Œæ•´çš„é—­ç¯ã€‚

æ”¯ä»˜ä¸šåŠ¡æ”¯æ’‘ï¼š

* å•†åŸåº”ç”¨
* é‡‘èäº§å“
* å……å€¼åº”ç”¨ï¼ˆä¼šå‘˜ã€ç‚¹åˆ¸ï¼‰
* ...

æ”¯ä»˜åº”ç”¨åœºæ™¯ï¼š

* H5æ”¯ä»˜ -> æ‰«ç ã€è·³è½¬App
* å°ç¨‹åº
* ç§»åŠ¨App

æ”¯ä»˜çš„æŠ€æœ¯éš¾ç‚¹ï¼š

* å¤šå¹³å°ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ã€é“¶è”ï¼‰
* å®‰å…¨æ€§ï¼ˆHTTPSã€å…¨æµç¨‹æ—¥å¿—ã€äº¤æ˜“å¤‡æ¡ˆã€æ•°æ®å®‰å…¨æ€§å¦‚ç¾å¤‡...ï¼‰

å¸¸è§çš„é—®é¢˜ï¼š

* æ”¯ä»˜çš„å¼€å‘æµç¨‹ï¼Œæ˜¯ä¸æ˜¯å‰ç«¯ä¸ç”¨ç®¡ï¼Ÿåªç”¨è°ƒæ¥å£â€”â€”æ˜¯çš„ï¼Œä¸¾ä¾‹ï¼šå°ç¨‹åºå‰ç«¯ï¼Œå…¶å®ä¸Šåªæ˜¯wx.requestPaymentè°ƒèµ·æ”¯ä»˜å³å¯ï¼›
* æ”¯ä»˜åŠŸèƒ½çš„å¼€é€šå®¹æ˜“å—ï¼Ÿâ€”â€”å®¹æ˜“ï¼Œä½†æ˜¯é’ˆå¯¹äºä¸ªäººï¼Œæ— æ³•å¼€é€šå¾®ä¿¡æ”¯ä»˜ï¼›ä¸ªäººèƒ½å¼€é€šå—ï¼Ÿâ€”â€”ä¸è¡Œï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œæ¯”å¦‚JSAPIï¼›
* æœåŠ¡ç«¯å¯¹æ¥å¸¸è§çš„æ”¯ä»˜åŠŸèƒ½çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿâ€”â€”åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š
  1. ç”³è¯·å¾®ä¿¡å°ç¨‹åºè´¦å·
  2. å¾®ä¿¡å°ç¨‹åºè®¤è¯
  3. ç”³è¯·å•†æˆ·å¹³å°è´¦å·
  4. ä¿¡å°ç¨‹åºå…³è”å•†æˆ·å·
  5. æ¥å…¥å¾®ä¿¡æ”¯ä»˜

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#ä¼ä¸šæ³¨å†Œä¸ç¨åŠ¡)ä¼ä¸šæ³¨å†Œä¸ç¨åŠ¡

å¼€åŠä¼ä¸šéœ€è¦æ³¨æ„ï¼š

* è´¢ç¨é—®é¢˜ï¼Œå¦‚æœé›¶æŠ¥ç¨ï¼Œåˆ™éœ€è¦ä¼ä¸šå¹´æŠ¥æ¯å¹´éœ€è¦ç”³æŠ¥ã€‚

  å¼€åŠä¼ä¸šä¸æ˜¯ç©ï¼Œä¸€å®šè¦è´Ÿè´£ä»»ã€‚è€Œä¸”ï¼Œä¸è‰¯çš„ä¼ä¸šè´Ÿå€ºï¼Œå¯èƒ½ä¼šå½±å“åˆ°ä¸ªäººçš„å¾ä¿¡ï¼Œæœ€ç»ˆæ— æ³•è´·æ¬¾ã€ä¹˜è½¦ç­‰ã€‚

* è‚¡ä»½é—®é¢˜ï¼šå¦‚æœå¤šäººå¼€åŠï¼Œåƒä¸‡ä¸è¦å¯¹åŠ

  å¤šäººå…¥è‚¡ä¸èƒ½å‡åˆ†ï¼Œä¸èƒ½0èµ„é‡‘å…¥è‚¡ï¼Œåˆ†è‚¡ç”¨æœŸæƒï¼›

  è®¾è®¡é€€è‚¡æœºåˆ¶ï¼Œåˆ†çº¢æœºåˆ¶ï¼Œä»¥åŠå€ºåŠ¡é—®é¢˜è§£å†³åŠæ³•ï¼›

  è‚¡æƒä¸»è¦çš„ç›®çš„æ˜¯æ¿€åŠ±ï¼›

* åˆ©ç›Šåˆ†é…é—®é¢˜ï¼šå¤©ä¸‹ç†™ç†™çš†ä¸ºåˆ©æ¥ï¼Œå¤©ä¸‹æ”˜æ”˜çš†ä¸ºåˆ©å¾€ï¼›

æ— è®ºæ˜¯æ”¯ä»˜å®è¿˜æ˜¯å¾®ä¿¡ï¼Œèƒ½å¤Ÿæ”¯æŒçš„æ”¯ä»˜ä¸»ä½“åªæœ‰ä¼ä¸šã€ä¸ªä½“å·¥å•†æˆ·å’Œæ”¿åºœåŠäº‹ä¸šå•ä½ç­‰ï¼Œå…±åŒç‚¹æ˜¯**éä¸ªäºº**ã€‚

> ä¸ªäººå¼€å‘è€…ï¼Œå¦‚æœéœ€è¦æ¥å…¥æ”¯ä»˜åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ç¬¬ä¸‰æ–¹æœåŠ¡å•†ï¼š
>
> * PayJSï¼šå¼€é€šè´¹ç”¨300+æ‰‹ç»­è´¹0.38%+æœåŠ¡è´¹2%
> * PaysApiï¼šæœˆä»˜æ‰‹ç»­è´¹30-199+å•ç¬”è´¹ç‡ä»0.3~0.1%ä¸ç­‰
> * PayBobï¼šå¼€é€šè´¹ç”¨300+æ‰‹ç»­è´¹0.38%+æœåŠ¡è´¹1-2%
> * xorpayï¼šæœˆä»˜æ‰‹ç»­è´¹0-60+æ‰‹ç»­è´¹0.38%+å•ç¬”æ‰‹ç»­è´¹1.2%~0.5%ä¸ç­‰

äº†è§£ä¼ä¸šçš„æ³¨å†Œæµç¨‹åŠç¨åŠ¡ç›¸å…³çš„çŸ¥è¯†ï¼Œæœ‰åŠ©äºå­¦ä¹ æ”¯ä»˜ç›¸å…³çš„å†…å®¹ï¼Œæ‰©å±•çŸ¥è¯†é¢ã€‚

ä¼ä¸šæ³¨å†Œæ¯”è¾ƒéº»çƒ¦çš„åœ°æ–¹ï¼š

* è®¾ç«‹ç™»è®°å¯èƒ½è¦è·‘å‡ èºº
* ç¨åŠ¡ç™»è®° + é“¶è¡Œå¼€æˆ· æŠ˜è…¾ä¸ª10å‡ å¤©
* æŠ¥ç¨ï¼šæœ‰å­£æŠ¥+å¹´æŠ¥ï¼ˆå·¥å•†å¹´æŠ¥æ¬¡å¹´6æœˆå‰ã€æ±‡ç¼´æ¸…ç®—ä¸å®šï¼‰

ä½†æ˜¯ï¼Œå¼€åŠä¼ä¸šä¹Ÿæ˜¯æœ‰å¥½å¤„çš„ï¼Œä¸¾ä¾‹ï¼š

* ä½œä¸ºå›¢é˜Ÿå‡ºå»æ¥é¡¹ç›®
* å¤§å¤šæ•°ç½‘ä¸Šçš„æœåŠ¡é’ˆå¯¹çš„æ˜¯ä¼ä¸š
* å›½å®¶æ”¿åºœå¯¹äºå°å¾®ä¼ä¸šç°åœ¨æœ‰å¤§åŠ›çš„æ‰¶æŒ

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æ³¨å†Œä¼ä¸šæµç¨‹)æ³¨å†Œä¼ä¸šæµç¨‹

![å›¾ç‰‡ 1](./assets/å›¾ç‰‡ 1.png)

ä¼ä¸šæ³¨å†Œæµç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹ï¼š

* å‡†å¤‡å·¥ä½œï¼ˆåœºåœ°ã€äººå‘˜ã€åç§°ï¼‰

  å…¬å¸æŸ¥åå„åœ°æœ‰å„åœ°çš„æŸ¥è¯¢ç½‘å€æˆ–è€…åœ¨å·¥å•†ç®¡ç†éƒ¨é—¨åŠäº‹å¤§å…è¿›è¡Œç°åœºæŸ¥é‡ï¼ˆå› ä¸ºå¯èƒ½ä¼šé‡åï¼Œæ‰€ä»¥éœ€è¦å¤šå‡†å¤‡å‡ ä¸ªï¼‰

  æ¹–åŒ—ä¼ä¸šæŸ¥åæŸ¥é‡ï¼šhttp://scjg.hubei.gov.cn/ICPSP/newNamecheck/nameCheck.action

  ä¼ä¸šç»è¥èŒƒå›´æŸ¥è¯¢ç½‘å€ï¼šhttps://jyfwyun.com/

* æäº¤èµ„æ–™ï¼ˆç« ç¨‹ã€ä½æ‰€è¯æ˜ï¼‰

  å¯ä»¥åœ¨å½“åœ°çš„åŒºï¼ˆå¿ï¼‰æ”¿åŠ¡ä¸­å¿ƒé¢†å–ææ–™ æˆ–è€…åœ¨å…¶ç½‘ç«™ä¸Šä¸‹è½½å¯¹åº”çš„æ¨¡æ¿æ–‡ä»¶ï¼Œè‡ªè¡Œæ‰“å°ä¸å¤å°ã€‚

* åŠç†ç¨åŠ¡+é“¶è¡Œå¼€æˆ·

  å½“åŠç†å®Œä¼ä¸šç™»è®°ï¼Œå¹¶æ ¸å‘è¥ä¸šæ‰§ç…§ä¹‹åï¼Œå¯ä»¥è¾“ç¨åŠ¡ä¸ä¼ä¸šé“¶è¡Œå¼€æˆ·ã€‚

  å„å®¶é“¶è¡Œçš„å¼€æˆ·è´¹ç”¨å¤§ä½“ç›¸åŒï¼Œåªæ˜¯æœåŠ¡å¯èƒ½ä¸ä¸€æ ·ï¼Œå¤§å®¶å¯ä»¥é€‰æ‹©å‡ å®¶å¯¹æ¯”ä¸€ä¸‹ã€‚æ¨èï¼šæ‹›å•†ä¸ä¸­å…´ã€‚

  é€‰æ‹©é“¶è¡Œéœ€è¦æ³¨æ„ï¼š

  * æœåŠ¡é—®é¢˜ï¼›
  * ä¾¿åˆ©æ€§â€”â€”ä¸è¦é€‰æ‹©ä¸€å®¶ç¦»è‡ªå·±åŠå…¬ç‚¹æˆ–è€…å®¶å¾ˆè¿œçš„åœ°æ–¹ï¼›

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#ä¸ªäººå·¥å•†æˆ·ä¸ä¼ä¸šåŒºåˆ«)ä¸ªäººå·¥å•†æˆ·ä¸ä¼ä¸šåŒºåˆ«

å…±åŒç‚¹ï¼š

* æµç¨‹ï¼šä¸ªä½“è¦è®°è´¦ã€äº¤ç¨ã€å¹´æ£€ã€å®¡æ‰¹ï¼Œä¹Ÿä¼šè¢«æŠ½æŸ¥
* ç¨è´¹ï¼šä¸å°å¾®ä¼ä¸šæ— å¼‚

ä¸åŒç‚¹ï¼š

* å€ºåŠ¡ï¼šä¸ªä½“è´Ÿè´£åˆ°åº•-æ— é™ï¼Œå…¬å¸ç”³è¯·ç ´äº§ä¿æŠ¤-æœ‰é™è´£ä»»
* è§„æ¨¡ï¼šä¸ªä½“8äººä¸èƒ½ä¸Šå¸‚ï¼Œå…¬å¸å¯ä»¥è®¾ç«‹åˆ†æœºæ„ã€ä¸Šå¸‚
* ä¸šåŠ¡ï¼šä¸ªä½“ä¸èƒ½åšè¿›å‡ºå£ä¸šåŠ¡
* ç»è¥ ï¼šä¸ªä½“é™åˆ¶ç»è¥èŒƒå›´
* ç¨è´¹ï¼šç¨ç§ä¸ä¸€æ ·ï¼Œå¾æ”¶æ–¹å¼ä¸ä¸€æ ·

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#è‡ªå·±æ³¨å†Œvsä»£æ³¨å†Œ)è‡ªå·±æ³¨å†Œvsä»£æ³¨å†Œ

**è‡ªå·±æ³¨å†Œï¼š**

ä¼˜ç‚¹ï¼š

* æ²¡æœ‰è´¹ç”¨

ç¼ºç‚¹ï¼š

* éœ€è¦èŠ±æ—¶é—´
* éœ€è¦äº†è§£æ•´ä½“æµç¨‹
* éœ€è¦å»ç¨åŠ¡ã€é“¶è¡Œ

**ä»£æ³¨å†Œï¼š**

ä¼˜ç‚¹ï¼š

* çœæ—¶é—´
* çœäº‹ï¼ˆåŠè¯ã€ç¨åŠ¡ã€ä¼ä¸šé“¶è¡Œã€æ³¨å†Œåœ°ã€èµ„æ–™å‡†å¤‡ä¸€æ¡é¾™ï¼‰

ç¼ºç‚¹ï¼š

* è´¹ç”¨ä¸ç­‰ï¼Œä»3000-6000ï¼Œç”šè‡³æ›´å¤šï¼›
* åç»­å¯èƒ½ä¼šæœ‰ä»£è´¦ã€å¹´ç§Ÿè´¹ç”¨ç­‰ï¼›
* å¼€ç¥¨&åŠç¨ä¹Ÿä¼šæ”¶è´¹ï¼›

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æŠ¥ç¨-å¼€ç¥¨)æŠ¥ç¨&å¼€ç¥¨

å¤§å¤šæ•°ä¼ä¸šä¼šæ‰¾ä¸€ä¸ªä»£è´¦ä¼šè®¡æˆ–è€…æ‰¾ä¸€ä¸ªä»£è´¦å…¬å¸ï¼Œè€Œä¼ä¸šå‰æœŸæ˜¯æ— éœ€ä¼šè®¡çš„ï¼Œå®Œå…¨å¯ä»¥é›¶æŠ¥ç¨ï¼Œæ“ä½œæµç¨‹éå¸¸çš„ç®€å•ã€‚

å¦‚æœä¸æ¸…æ¥šæŠ¥ç¨çš„æµç¨‹ï¼Œå¯ä»¥åœ¨ç¨åŠ¡æœºå…³å¤„è¿›è¡Œç°åœºæŠ¥ç¨ã€‚

ä»£è´¦è´¹ç”¨ï¼šä»200å…ƒåˆ°300å…ƒ/æœˆä¸ç­‰ã€‚

æ‰¾äº†ä»£è´¦çš„ä¼ä¸šéœ€è¦ä¼šçœ‹å¦‚ä¸‹çš„å‡ ä¸ªè¡¨æ ¼ï¼Œäº†è§£æ¦‚å¿µï¼š

* åˆ©æ¶¦è¡¨ï¼šä½ èµšäº†å¤šå°‘é’±ï¼
* èµ„äº§è´Ÿå€ºè¡¨ï¼šæœ‰æ²¡æœ‰æ¬ ä½ çš„é’±ã€ä½ æ¬ çš„é’±ï¼Œä½™ä¸‹çš„é’±

é™¤äº†æ‰¾ä»£è´¦å…¬å¸ä»¥å¤–ï¼ŒBrainæ›´æ¨èè‡ªå·±åœ¨å‰æœŸè¿›è¡Œè®°è´¦ä¸æŠ¥ç¨ï¼Œæµç¨‹ä¸å¤æ‚ï¼Œè€Œä¸”è½¯ä»¶éå¸¸çš„æ™ºèƒ½ï¼Œåªç”¨å¡«å…¥è‡ªå·±çš„æ”¶å…¥ä¸æ”¯å‡ºï¼Œè´¢åŠ¡è½¯ä»¶å¯ä»¥è‡ªåŠ¨å½¢æˆæŠ¥è¡¨ã€‚

è´¢åŠ¡è½¯ä»¶æ¨èï¼š

* é‡‘ç¢Ÿ
* ç”¨å‹

äº‘å¹³å°æ¨èï¼š

* æŸ æª¬äº‘

> å­£åº¦+å¹´åº¦æŠ¥ç¨ï¼š3ä¸ªæœˆæŠ¥å­£æŠ¥ï¼Œç…§ç€è½¯ä»¶å¡«

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#ä¼ä¸šæ—¥å¸¸çš„å¼€é”€)ä¼ä¸šæ—¥å¸¸çš„å¼€é”€

ä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ï¼š

* èµ„äº§ï¼šåŠå…¬è®¾å¤‡å¦‚æ‰“å°æœºã€åŠå…¬æ¡Œæ¤…ã€ç©ºè°ƒç­‰
* è´¹ç”¨ï¼šç§Ÿèµåœºåœ°ã€æ°´+ç”µ+ç½‘
* è´¹ç”¨ï¼šäººå‘˜ï¼ˆä¼šè®¡ã€å¼€å‘ã€äº§å“ç­‰ï¼‰
* ...

ä»ä¸Šé¢çš„åˆ†ç±»æ¥çœ‹ï¼Œæ³¨å†Œä¼ä¸šæ²¡æœ‰ä»€ä¹ˆè´¹ç”¨ï¼Œåè€Œæ˜¯ç»´æŒä¸€ä¸ªä¼ä¸šçš„è¿è½¬æ˜¯éœ€è¦å¤§é‡è´¹ç”¨çš„ã€‚å¤§å®¶åœ¨å‡†å¤‡ä¼ä¸šå¼€åŠä¹‹å‰ï¼Œéœ€è¦æœ‰ä¸€å®šçš„å‡†å¤‡ã€‚

> ä¸æ‰“æ²¡æœ‰å‡†å¤‡çš„ä»—ï¼Œä¹Ÿä¸è¦ä»€ä¹ˆéƒ½å‡†å¤‡å¥½äº†ï¼Œæ‰å¼€å§‹ï¼ï¼

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æ”¯ä»˜å‰ç½®å¿…è¦æ¡ä»¶)æ”¯ä»˜å‰ç½®å¿…è¦æ¡ä»¶

ä¸‹é¢ä»¥å¾®ä¿¡æ”¯ä»˜ä¸ºä¾‹ï¼Œæ¥ä»‹ç»ï¼Œå¼€å‘æ”¯ä»˜åŠŸèƒ½éœ€è¦å‡†å¤‡çš„å‰ç½®æ¡ä»¶ï¼š

* é€‰æ‹©åˆé€‚çš„ä¸»ä½“&åœºæ™¯ï¼ˆä¼ä¸šæœåŠ¡å·ï¼‰å¾®ä¿¡ï¼ˆæ”¯ä»˜å®ï¼‰è®¤è¯ï¼›
* åŸŸå+å…¬ç½‘IP+HTTPSï¼›
* äº‘æœåŠ¡å™¨ICPå¤‡æ¡ˆï¼›

å¾®ä¿¡æ”¯ä»˜ï¼š

* ä¸»ä½“é—®é¢˜ï¼šè®¢é˜…å·éåª’ä½“å·æ— æ³•æ”¯ä»˜ï¼Œæ¨èä¼ä¸šæœåŠ¡å·ï¼›
* å°ç¨‹åºï¼šå¿…é¡»HTTPS + ICPå¤‡æ¡ˆï¼›
* å¼€é€šå•†æˆ·å·ï¼Œä¹Ÿéœ€è¦ä¼ä¸šä¸»ä½“ï¼Œä¸å…¬ä¼—å·&å°ç¨‹åºåŒä¸€ä¸»ä½“ï¼›

æ”¯ä»˜å®æ”¯ä»˜ï¼š

* ä¸»ä½“é—®é¢˜ï¼šä¼ä¸šä¸»ä½“ï¼›

* è¡Œä¸šç±»ç›®åŠèµ„è´¨è¦æ±‚ï¼Œ[æ–‡æ¡£ (opens new window)](https://opendocs.alipay.com/iot/multi-platform/material)ï¼›

  è€Œä¸”å¯¹äºå®ä½“åº—é“ºå®¡æ ¸è¦ä¸¥æ ¼ä¸€äº›ã€‚

![image-20210830134004706](uniapp.assets/image-20210830134004706.f4a99b49.png)

è¯´æ˜ï¼š

* å…³äºICPå¤‡æ¡ˆï¼Œå¯ä»¥å‚è€ƒï¼š[é˜¿é‡Œäº‘ (opens new window)](https://beian.aliyun.com/)ã€[è…¾è®¯äº‘ (opens new window)](https://cloud.tencent.com/product/ba)ï¼ˆå‰ç½®æ¡ä»¶ï¼šåŸŸåã€äº‘æœåŠ¡å™¨ï¼‰ï¼›
* HTTPSï¼šå¿…é¡»è¦æœ‰åŸŸåï¼Œå¿…é¡»è¦æœ‰ä¸€å°äº‘æœåŠ¡å™¨ï¼›
* å¾®ä¿¡å•†æˆ·å·ï¼Œå¯¹åº”çš„ç½‘å€ï¼šhttps://pay.weixin.qq.com/

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#å°ç¨‹åºæ”¯ä»˜æµç¨‹)å°ç¨‹åºæ”¯ä»˜æµç¨‹

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#å¼€å‘æŠ€å·§)å¼€å‘æŠ€å·§

* æŠ€æœ¯é—®é¢˜ï¼Œå…ˆè¯»æ–‡æ¡£ï¼ŒæŸ¥æ‰¾å®˜æ–¹çš„ç¤¾åŒºï¼›
* æ¯”è¾ƒä¸»æµçš„æ”¯ä»˜æ–¹æ¡ˆï¼Œå¯ä»¥æœç´¢ä¸€ä¸‹æœ‰æ²¡æœ‰Node.jsä¾§çš„npmåŒ…ï¼Œä¾‹å¦‚ï¼š[wechatpay-axios-plugin (opens new window)](https://www.npmjs.com/package/wechatpay-axios-plugin)æ˜¯ä¸€ä¸ªéå¸¸ä¸é”™çš„æ”¯æŒv2/v3çš„npmåŒ…ï¼Œtsé£æ ¼ï¼›
* é—®stackoverflowã€çŸ¥ä¹ã€csdnç­‰ï¼›
* æœ€åï¼Œæ‰è€ƒè™‘è‡ªå·±å¼€å‘è½®å­ï¼›

å¦‚æœæ˜¯å­¦ä¹ ï¼Œä¹Ÿå¯ä»¥ä»0åˆ°1çš„å¼€å‘ï¼Œäº†è§£æ•´ä¸ªæ”¯ä»˜çš„æµç¨‹ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æµç¨‹å›¾)æµç¨‹å›¾

å­¦ä¼šçœ‹æ—¶åºå›¾ï¼š

* æœ€ä¸Šé¢çš„æ˜¯è§’è‰²
* ä»å·¦å¾€å³çœ‹ï¼ŒæŒ‰ç…§ç®­å¤´çš„æ–¹å‘èµ°
* ä»ä¸Šå¾€ä¸‹çœ‹ï¼Œæ˜¯æ—¶é—´å…³ç³»æµç¨‹çš„æµè½¬

![img](uniapp.assets/6_2.39c8c442.png)

é‡ç‚¹æ­¥éª¤è¯´æ˜ï¼š

æ­¥éª¤3ï¼šç”¨æˆ·ä¸‹å•å‘èµ·æ”¯ä»˜ï¼Œå•†æˆ·å¯é€šè¿‡[JSAPIä¸‹å• (opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml)åˆ›å»ºæ”¯ä»˜è®¢å•ã€‚

æ­¥éª¤8ï¼š ç”¨æˆ·å¯é€šè¿‡[å°ç¨‹åºè°ƒèµ·æ”¯ä»˜API (opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_4.shtml)è°ƒèµ·å¾®ä¿¡æ”¯ä»˜ï¼Œå‘èµ·æ”¯ä»˜è¯·æ±‚ã€‚

æ­¥éª¤15ï¼šç”¨æˆ·æ”¯ä»˜æˆåŠŸåï¼Œå•†æˆ·å¯æ¥æ”¶åˆ°å¾®ä¿¡æ”¯ä»˜æ”¯ä»˜ç»“æœé€šçŸ¥[æ”¯ä»˜é€šçŸ¥API (opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_5.shtml)ã€‚

æ­¥éª¤20ï¼šå•†æˆ·åœ¨æ²¡æœ‰æ¥æ”¶åˆ°å¾®ä¿¡æ”¯ä»˜ç»“æœé€šçŸ¥çš„æƒ…å†µä¸‹éœ€è¦ä¸»åŠ¨è°ƒç”¨[æŸ¥è¯¢è®¢å•API (opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml)æŸ¥è¯¢æ”¯ä»˜ç»“æœã€‚

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æ­å»ºå¼€å‘ç¯å¢ƒ)æ­å»ºå¼€å‘ç¯å¢ƒ

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æ”¯ä»˜å‡†å¤‡)æ”¯ä»˜å‡†å¤‡

![image-20210830135731466](uniapp.assets/image-20210830135731466.7d34db68.png)

æŒ‰ç…§ä¸Šé¢çš„æµç¨‹ï¼Œå‡†å¤‡ç›¸å…³çš„å¼€å‘ç¯å¢ƒï¼Œå‚è€ƒæŒ‡å¼•ï¼š[å®˜æ–¹é“¾æ¥(opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_8_1.shtml)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#é…ç½®https-åŸŸåè§£æ)é…ç½®Https+åŸŸåè§£æ

è¯´æ˜ï¼š

* å‰ç½®çš„ç« èŠ‚æœ‰ä»‹ç»HTTPSä»‹ç»ï¼Œ[æ–‡ç« ](https://front-end.toimc.com/notes-page/project/community-miniapp/07-å®‰å…¨åŸŸåç›¸å…³.html#sslè¯ä¹¦ç”³è¯·)

* åŸŸåè§£æä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼š

  ![image-20210830140428900](uniapp.assets/image-20210830140428900.83fd5ad0.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#é…ç½®apiå¯†é’¥)é…ç½®APIå¯†é’¥

[å•†æˆ·å¹³å° (opens new window)](https://pay.weixin.qq.com/)-> è´¦æˆ·ä¸­å¿ƒ -> APIå®‰å…¨ï¼Œåˆ†åˆ«é…ç½®APIå•†æˆ·è¯ä¹¦ + APIv3å¯†é’¥

![image-20210830140522534](uniapp.assets/image-20210830140522534.b857eaea.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#é…ç½®frpå†…ç½‘ç©¿é€)é…ç½®frpå†…ç½‘ç©¿é€

ä¸ºäº†æ–¹ä¾¿æµ‹è¯•å¾®ä¿¡æ”¯ä»˜é€šçŸ¥ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

* ä¸Šä¼ APIæœåŠ¡åˆ°æµ‹è¯•æœåŠ¡å™¨ï¼š

  ![image-20210830140648414](uniapp.assets/image-20210830140648414.f3ff8b55.png)

* ä½¿ç”¨æœ¬åœ°çš„APIæœåŠ¡ï¼Œéœ€è¦ä½¿ç”¨frpå·¥å…·æŠŠè¿œç¨‹çš„é€šçŸ¥è½¬å‘åˆ°æœ¬åœ°ï¼š

  ![image-20210830140722039](uniapp.assets/image-20210830140722039.310b80f5.png)

é…ç½®è¿‡ç¨‹å¦‚ä¸‹ï¼š

* ä¸‹è½½frpåŒ…åˆ°æœ¬åœ°ï¼Œè§[release (opens new window)](https://github.com/fatedier/frp/releases)ï¼ˆdarwinæ˜¯macç³»ç»Ÿã€windowsã€Linuxè¦åˆ†armä¸amdï¼‰ï¼›

* SSHåˆ°è¿œç¨‹æœåŠ¡ç«¯ï¼Œæ–°å»ºé…ç½®æ–‡ä»¶`/home/frp/frps.ini`ï¼š

  ```nginx
  [common]
  bind_port = 10010
  vhost_https_port = 443
  ```

* åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œfrpsï¼Œä½¿ç”¨dockeré•œåƒï¼š

  ```text
  docker run --restart=always --network host -d -v /home/frp/frps.ini:/etc/frp/frps.ini --name frps snowdreamtech/frps
  ```

* ä¸‹è½½let's encryptåˆ›å»ºçš„SSLè¯ä¹¦ -> ä¸€èˆ¬åœ¨acmeç”Ÿæˆçš„ç›®å½•ä¸­->æ”¾ç½®åˆ°æœ¬åœ°è§£å‹çš„frpç›®å½•ä¸­ï¼›

  ![image-20210830141415349](uniapp.assets/image-20210830141415349.46683708.png)

* åœ¨æœ¬åœ°åˆ›å»º`frpc.ini`æ–‡ä»¶

  ```nginx
  [common]
  server_addr = 121.36.194.226
  server_port = 10010
  
  [test_htts2http]
  type = https
  custom_domains = test1.toimc.com
  
  plugin = https2http
  plugin_local_addr = 127.0.0.1:3000
  
  # HTTPS è¯ä¹¦ç›¸å…³çš„é…ç½®
  plugin_crt_path = ./fullchain.pem
  plugin_key_path = ./key.pem
  plugin_host_header_rewrite = 127.0.0.1
  plugin_header_X-From-Where = frp
  ; test1.toimc.com -> vhost_https_port 443
  ; test1.toimc.com:443 -> frp -> 127.0.0.1:3000
  ```

* ä½¿ç”¨frpcè¿è¡Œè¯¥é…ç½®æ–‡ä»¶ï¼š

  ```text
  chmod +x frpc
  ./frpc -c ./frpc.ini
  ```

  è¿è¡ŒæˆåŠŸçš„æç¤ºï¼š

  ![image-20210830141622200](uniapp.assets/image-20210830141622200.32b8bdce.png)

å¦‚æœè¿è¡Œå¤±è´¥ï¼Œå¯ä»¥åœ¨[å®˜æ–¹ç½‘ç«™ (opens new window)](https://gofrp.org/)ä¸ŠæŸ¥è¯¢å¤±è´¥çš„åŸå› ï¼š

* å®˜æ–¹FAQï¼šhttps://gofrp.org/docs/faq/
* å®˜æ–¹Issuesï¼šhttps://github.com/fatedier/frp/issues

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#apiv3-vs-apiv2)APIv3 vs APIv2

ä¸ºäº†åœ¨ ä¿è¯æ”¯ä»˜ å®‰å…¨çš„å‰æä¸‹ï¼Œå¸¦ç»™å•†æˆ· ç®€å•ã€ä¸€è‡´ä¸”æ˜“ç”¨çš„å¼€å‘ä½“éªŒï¼Œæˆ‘ä»¬æ¨å‡ºäº†å…¨æ–°çš„å¾®ä¿¡æ”¯ä»˜API v3ã€‚

ç›¸è¾ƒäºä¹‹å‰çš„å¾®ä¿¡æ”¯ä»˜APIï¼Œä¸»è¦åŒºåˆ«æ˜¯ï¼š

* éµå¾ªç»Ÿä¸€çš„REST çš„è®¾è®¡é£æ ¼
* ä½¿ç”¨JSONä½œä¸ºæ•°æ®äº¤äº’çš„æ ¼å¼ï¼Œä¸å†ä½¿ç”¨XML
* ä½¿ç”¨åŸºäºéå¯¹ç§°å¯†é’¥çš„SHA256-RSAçš„æ•°å­—ç­¾åç®—æ³•ï¼Œä¸å†ä½¿ç”¨MD5æˆ–HMAC-SHA256
* ä¸å†è¦æ±‚HTTPSå®¢æˆ·ç«¯è¯ä¹¦
* ä½¿ç”¨AES-256-GCMï¼Œå¯¹å›è°ƒä¸­çš„å…³é”®ä¿¡æ¯è¿›è¡ŒåŠ å¯†ä¿æŠ¤

APIv3çš„æ–‡æ¡£ï¼š[å®˜æ–¹é“¾æ¥(opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay-1.shtml)

ä¸¤ä¸ªæ¥å£çš„å¯¹æ¥å›¾ï¼š

| **V3**               | **è§„åˆ™å·®å¼‚** | **V2**             |
| -------------------- | ------------ | ------------------ |
| JSON                 | å‚æ•°æ ¼å¼     | XML                |
| POSTã€GET æˆ– DELETE  | æäº¤æ–¹å¼     | POST               |
| AES-256-GCMåŠ å¯†      | å›è°ƒåŠ å¯†     | æ— éœ€åŠ å¯†           |
| RSA åŠ å¯†             | æ•æ„ŸåŠ å¯†     | æ— éœ€åŠ å¯†           |
| UTF-8                | ç¼–ç æ–¹å¼     | UTF-8              |
| éå¯¹ç§°å¯†é’¥SHA256-RSA | ç­¾åæ–¹å¼     | MD5 æˆ– HMAC-SHA256 |

**æ¨èï¼šåœ¨æ²¡æœ‰æ¥è§¦v2çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ä¸Šæ‰‹v3ï¼›å¦‚æœæœ‰è€æ—§ä¸šåŠ¡ï¼Œä¹Ÿå¯ä»¥å¯¹æ¥åˆ°v3ï¼Œæˆ–è€…ä¸åŠ¨åŸæœ‰çš„ä¸šåŠ¡ï¼Œç›´è‡³v2çš„è¯ä¹¦å¿«è¿‡æœŸï¼Œéœ€è¦æ›´æ¢æ—¶ï¼Œå†åˆ‡æ¢åˆ°v3ã€‚**

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#jsapiç»Ÿä¸€ä¸‹å•)JSAPIç»Ÿä¸€ä¸‹å•

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#ç­¾åç”Ÿæˆ)ç­¾åç”Ÿæˆ

[å®˜æ–¹æ–‡æ¡£(opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay4_0.shtml)

å•†æˆ·å¯ä»¥æŒ‰ç…§ä¸‹è¿°æ­¥éª¤ç”Ÿæˆè¯·æ±‚çš„ç­¾åï¼Œå¾®ä¿¡æ”¯ä»˜API v3 è¦æ±‚å•†æˆ·å¯¹è¯·æ±‚è¿›è¡Œç­¾åï¼Œå¾®ä¿¡æ”¯ä»˜ä¼šåœ¨æ”¶åˆ°è¯·æ±‚åè¿›è¡Œç­¾åçš„éªŒè¯ã€‚

**å¦‚æœç­¾åéªŒè¯ä¸é€šè¿‡ï¼Œå¾®ä¿¡æ”¯ä»˜API v3å°†ä¼šæ‹’ç»å¤„ç†è¯·æ±‚ï¼Œå¹¶è¿”å›`401 Unauthorized`ã€‚**

ç­¾åç”Ÿæˆçš„æ­¥éª¤æœ‰ï¼š

* æ„é€ ç­¾åä¸²

  ç­¾åä¸²ä¸€å…±æœ‰äº”è¡Œï¼Œæ¯ä¸€è¡Œä¸ºä¸€ä¸ªå‚æ•°ã€‚è¡Œå°¾ä»¥ `\n`ï¼ˆæ¢è¡Œç¬¦ï¼ŒASCIIç¼–ç å€¼ä¸º0x0Aï¼‰ç»“æŸï¼ŒåŒ…æ‹¬æœ€åä¸€è¡Œã€‚å¦‚æœå‚æ•°æœ¬èº«ä»¥`\n`ç»“æŸï¼Œä¹Ÿéœ€è¦é™„åŠ ä¸€ä¸ª`\n`ã€‚

  ```js
  HTTPè¯·æ±‚æ–¹æ³•\n
  URL\n
  è¯·æ±‚æ—¶é—´æˆ³\n
  è¯·æ±‚éšæœºä¸²\n
  è¯·æ±‚æŠ¥æ–‡ä¸»ä½“\n 
  ```

* è®¡ç®—ç­¾åå€¼

  ä½¿ç”¨å•†æˆ·ç§é’¥å¯¹å¾…ç­¾åä¸²è¿›è¡ŒSHA256 with RSAç­¾åï¼Œå¹¶å¯¹ç­¾åç»“æœè¿›è¡ŒBase64ç¼–ç å¾—åˆ°ç­¾åå€¼ï¼Œç¤ºä¾‹ï¼š

  ```bash
  $ echo -n -e \
  "GET\n/v3/certificates\n1554208460\n593BEC0C930BF1AFEB40B4A08C8FB242\n\n" \
    | openssl dgst -sha256 -sign apiclient_key.pem \
    | openssl base64 -A
    uOVRnA4qG/MNnYzdQxJanN+zU+lTgIcnU9BxGw5dKjK+VdEUz2FeIoC+D5sB/LN+nGzX3hfZg6r5wT1pl2ZobmIc6p0ldN7J6yDgUzbX8Uk3sD4a4eZVPTBvqNDoUqcYMlZ9uuDdCvNv4TM3c1WzsXUrExwVkI1XO5jCNbgDJ25nkT/c1gIFvqoogl7MdSFGc4W4xZsqCItnqbypR3RuGIlR9h9vlRsy7zJR9PBI83X8alLDIfR1ukt1P7tMnmogZ0cuDY8cZsd8ZlCgLadmvej58SLsIkVxFJ8XyUgx9FmutKSYTmYtWBZ0+tNvfGmbXU7cob8H/4nLBiCwIUFluw==
  ```

ç¬¬ä¸€æ­¥æ¯”è¾ƒå¥½å®ç°ï¼š

```js
// HTTPè¯·æ±‚æ–¹æ³•\n
// URL\n  https://www.imooc.com/path1/path2/?query1=value
// è¯·æ±‚æ—¶é—´æˆ³\n
// è¯·æ±‚éšæœºä¸²\n
// è¯·æ±‚æŠ¥æ–‡ä¸»ä½“\n
const tmpUrl = new URL(url)
const nonceStr = rand.generate(16)
const pathname = /http/.test(url) ? tmpUrl.pathname : url
const timestamp = Math.floor(Date.now() / 1000)
const message = `${method.toUpperCase()}\n${pathname + tmpUrl.search
  }\n${timestamp}\n${nonceStr}\n${body ? JSON.stringify(body) : ''}\n`
```

ç¬¬äºŒæ­¥çš„RSAçš„ç®—æ³•å®ç°æ€è·¯ï¼š

* æ‰¾ä¸€ä¸‹å¾®ä¿¡ç¤¾åŒºæœ‰æ²¡æœ‰ç±»ä¼¼å®ç°
* æ‰¾ä¸€ä¸‹ç½‘ä¸Šæœ‰æ²¡æœ‰ç±»ä¼¼å®ç°
* æ‰¾ä¸€ä¸‹æœ‰æ²¡æœ‰npmå¼€æºåŒ…
* æ‰¾ä¸€ä¸‹stackoverflowæˆ–è€…ç™¾åº¦
* ...

å¦‚æœ ä»¥ä¸Šéƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±è¦è‡ªå·±é€ è½®å­äº†ã€‚ä½†æ˜¯è¿™æ ·çš„åœºæ™¯å°‘ä¹‹æœ‰å°‘ï¼Œå“ˆå“ˆï¼Œè¿˜è½®ä¸ä¸Šå¤§å®¶è‡ªå·±ä¸Šã€‚

```js
export const rsaSign = (message) => {
  const keyPem = fs.readFileSync(
    path.join(__dirname, 'keys/apiclient_key.pem'),
    'utf-8'
  )
  const signature = crypto
    .createSign('RSA-SHA256')
    .update(message, 'utf-8')
    .sign(keyPem, 'base64')
  return signature
}
```

ç„¶åä½¿ç”¨ä¸Šé¢åˆæˆçš„messageè¿›è¡Œç­¾åå³å¯ï¼š

```js
const signature = rsaSign(message)
```

**å¦‚ä½•éªŒè¯å‘¢ï¼Ÿ**

æ–¹æ¡ˆä¸€ï¼š

Linuxæˆ–è€…macç›´æ¥ä½¿ç”¨opensslæ¥è¿›è¡ŒéªŒè¯

```text
echo -n -e \
"GET\n/v3/certificates\n1554208460\n593BEC0C930BF1AFEB40B4A08C8FB242\n\n" \
  | openssl dgst -sha256 -sign apiclient_key.pem \
  | openssl base64 -A
```

æ–¹æ¡ˆäºŒï¼š

ä½¿ç”¨è€å¸ˆç»™å¤§å®¶å‡†å¤‡çš„dockeré•œåƒè¿›è¡ŒéªŒè¯`lw96/libressl`ï¼š

```bash
# 1.åˆ›å»ºå®¹å™¨
docker run -itd --name ssl lw96/libressl

# 2.æ‹·è´è¯ä¹¦
docker cp è¯ä¹¦ç›®å½• å®¹å™¨id:/tmp

# 3.è¿›å…¥å®¹å™¨
docker exec -it ssl sh

# 4.ä½¿ç”¨ä¸Šé¢çš„ä¸€æ ·çš„å‘½ä»¤
echo -n -e \
"GET\n/v3/certificates\n1554208460\n593BEC0C930BF1AFEB40B4A08C8FB242\n\n" \
  | openssl dgst -sha256 -sign /tmp/apiclient_key.pem \
  | openssl base64 -A
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#authenticationå¤´éƒ¨å¯†é’¥ä¸²)Authenticationå¤´éƒ¨å¯†é’¥ä¸²

å¾®ä¿¡æ”¯ä»˜å•†æˆ·API v3è¦æ±‚è¯·æ±‚é€šè¿‡`HTTP Authorization`å¤´æ¥ä¼ é€’ç­¾åã€‚`Authorization`ç”±*è®¤è¯ç±»å‹*å’Œ*ç­¾åä¿¡æ¯*ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆã€‚

ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤è¡Œæ¼”ç¤ºå¦‚ä½•ç”Ÿæˆç­¾åã€‚

```text
Authorization: è®¤è¯ç±»å‹ ç­¾åä¿¡æ¯
```

å…·ä½“ç»„æˆä¸ºï¼š

1.è®¤è¯ç±»å‹ï¼Œç›®å‰ä¸ºWECHATPAY2-SHA256-RSA2048

2.ç­¾åä¿¡æ¯

* å‘èµ·è¯·æ±‚çš„å•†æˆ·ï¼ˆåŒ…æ‹¬ç›´è¿å•†æˆ·ã€æœåŠ¡å•†æˆ–æ¸ é“å•†ï¼‰çš„å•†æˆ·å·`mchid`
* [å•†æˆ·APIè¯ä¹¦ (opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml)`serial_no`ï¼Œç”¨äº[å£°æ˜æ‰€ä½¿ç”¨çš„è¯ä¹¦ (opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay3_1.shtml#part-3)ï¼ˆç®¡ç†å‘˜è´¦å·ç™»å½•å¾®ä¿¡å•†æˆ·ç®¡ç†åå°ï¼Œåœ¨APIå®‰å…¨é‡Œé¢ç‚¹å‡»æŸ¥çœ‹è¯ä¹¦å¯ä»¥è·å–ã€‚ï¼‰
* è¯·æ±‚éšæœºä¸²`nonce_str`
* æ—¶é—´æˆ³`timestamp`
* ç­¾åå€¼`signature`
* æ³¨ï¼šä»¥ä¸Šäº”é¡¹ç­¾åä¿¡æ¯ï¼Œæ— é¡ºåºè¦æ±‚ã€‚

`Authorization` å¤´çš„ç¤ºä¾‹å¦‚ä¸‹ï¼šï¼ˆæ³¨æ„ï¼Œç¤ºä¾‹å› ä¸ºæ’ç‰ˆå¯èƒ½å­˜åœ¨æ¢è¡Œï¼Œå®é™…æ•°æ®åº”åœ¨ä¸€è¡Œï¼‰

```bash
Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900009191",nonce_str="593BEC0C930B
```

æœ€ç»ˆæˆ‘ä»¬å¯ä»¥ç»„ä¸€ä¸ªåŒ…å«äº†ç­¾åçš„HTTPè¯·æ±‚äº†ã€‚

```bash
$ curl https://api.mch.weixin.qq.com/v3/certificates -H 'Authorization: WECHATPAY2-SHA256-RSA2048 mchid="1900009191",nonce_str="593BEC0C930BF1AFEB40B4A08C8FB242",signature="uOVRnA4qG/MNnYzdQxJanN+zU+lTgIcnU9BxGw5dKjK+VdEUz2FeIoC+D5sB/LN+nGzX3hfZg6r5wT1pl2ZobmIc6p0ldN7J6yDgUzbX8Uk3sD4a4eZVPTBvqNDoUqcYMlZ9uuDdCvNv4TM3c1WzsXUrExwVkI1XO5jCNbgDJ25nkT/c1gIFvqoogl7MdSFGc4W4xZsqCItnqbypR3RuGIlR9h9vlRsy7zJR9PBI83X8alLDIfR1ukt1P7tMnmogZ0cuDY8cZsd8ZlCgLadmvej58SLsIkVxFJ8XyUgx9FmutKSYTmYtWBZ0+tNvfGmbXU7cob8H/4nLBiCwIUFluw==",timestamp="1554208460",serial_no="1DDE55AD98ED71D6EDD4A4A16996DE7B47773A8C"'
```

ä»£ç ç¤ºä¾‹ï¼š

```js
// config.js
const mchid = 'xxxxx'

const serialNo = 'xxxxx'

export default {
  // ...
  mchid,
  serialNo
}

// WxPay.js
export const getSignHeaders = (url, method, body) => {
  // HTTPè¯·æ±‚æ–¹æ³•\n
  // URL\n  https://www.imooc.com/path1/path2/?query1=value
  // è¯·æ±‚æ—¶é—´æˆ³\n
  // è¯·æ±‚éšæœºä¸²\n
  // è¯·æ±‚æŠ¥æ–‡ä¸»ä½“\n
  const tmpUrl = new URL(url)
  const nonceStr = rand.generate(16)
  const pathname = /http/.test(url) ? tmpUrl.pathname : url
  const timestamp = Math.floor(Date.now() / 1000)
  const message = `${method.toUpperCase()}\n${pathname + tmpUrl.search
    }\n${timestamp}\n${nonceStr}\n${body ? JSON.stringify(body) : ''}\n`
  // const keyPem = fs.readFileSync(path.join(__dirname, 'keys/apiclient_key.pem'), 'utf-8')
  // const signature = crypto.createSign('RSA-SHA256').update(message, 'utf-8').sign(keyPem, 'base64')
  const signature = rsaSign(message)
  // 1.è§£å†³é—®é¢˜ï¼šwindowsä¸Šæ— openssl -> lw96/libressl
  // 2.éœ€è¦ä¼ é€’apiclient_key.pemç»™é•œåƒ -> å› ä¸ºåªæœ‰åœ¨å®¹å™¨é‡Œé¢æ‰èƒ½æ‰§è¡Œopenssl
  // 3.method1: docker cp  method2: -v
  // 4.ä½¿ç”¨opensslè¿›è¡Œç­¾å -> å¯¹æ¯”cryptoäº§ç”Ÿçš„base64ä¸²

  return {
    headers: `WECHATPAY2-SHA256-RSA2048 mchid="${config.mchid}",nonce_str="${nonceStr}",signature="${signature}",timestamp="${timestamp}",serial_no="${config.serialNo}"'`,
    nonceStr,
    timestamp
  }
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æ¥å£è¯´æ˜)æ¥å£è¯´æ˜

æ¥å£æ–‡æ¡£ï¼š[JSAPI(opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_1.shtml)

**è¯·æ±‚URLï¼š**https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi

**è¯·æ±‚æ–¹å¼ï¼š**POST

å½¢æˆéšæœºçš„å•†æˆ·è®¢å•å·ï¼š

```js
export const getTradeNo = () => {
  // æœåŠ¡ç«¯ä¾§ï¼šout_trade_no -> è®¢å•å· -> timestamp + type + id
  // 1.Date.now()  2.Moment/dayjs
  // 2. 01-å°ç¨‹åº
  return (
    dayjs().format('YYYYMMDDHHmmssSSS') +
    '01' +
    Math.random().toString().substr(-10)
  )
}
```

æœ€ç»ˆï¼Œç»Ÿä¸€è®¢å•çš„æ¥å£ï¼š

```js
export const wxJSPAY = async (params) => {
  const {
    description,
    goodsTag,
    total,
    user: { openid },
    detail,
    sceneInfo,
    settleInfo
  } = params
  // https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi
  // å°ç¨‹åºç”¨æˆ·ä¾§ï¼š descriptionï¼Œamount:{total} -> token -> id -> openid

  // å‚æ•°å‡†å¤‡
  const wxParams = {
    appid: config.AppID,
    mchid: config.mchid,
    description,
    out_trade_no: getTradeNo(),
    time_expire: dayjs().add(30, 'm').format(),
    attach: '',
    notify_url: 'https://test1.toimc.com/public/notify',
    goods_tag: goodsTag,
    amount: {
      total: parseInt(total),
      currency: 'CNY'
    },
    payer: {
      openid
    },
    detail,
    scene_info: sceneInfo,
    settle_info: settleInfo
  }
  const url = 'https://api.mch.weixin.qq.com/v3/pay/transactions/jsapi'
	// å¤´éƒ¨ç­¾å  
  const { headers, nonceStr, timestamp } = getSignHeaders(
    url,
    'post',
    wxParams
  )
  try {
    const result = await instance.post(url, wxParams, {
      headers: {
        Authorization: headers
      }
    })
    console.log('ğŸš€ ~ file: WxPay.js ~ line 53 ~ wxJSPAY ~ result', result)
    const { status, data } = result
    if (status === 200) {
      return { prepayId: data.prepay_id, nonceStr, timestamp }
    } else {
      logger.error(`wxJSPAY error: ${result}`)
    }
  } catch (error) {
    logger.error(`wxJSPAY error: ${error.message}`)
  }
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#ç”¨æˆ·æ”¯ä»˜)ç”¨æˆ·æ”¯ä»˜

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#æ”¯ä»˜æ­¥éª¤)æ”¯ä»˜æ­¥éª¤

å‰ç«¯æ­¥éª¤ï¼š

* ç”¨æˆ·ä¸‹å• -> å‘èµ·è¯·æ±‚ï¼Œè®©åç«¯ç”Ÿæˆæ”¯ä»˜å‚æ•°
* ç”¨æˆ·æ”¯ä»˜ -> wx.requestPaymentè°ƒèµ·æ”¯ä»˜

åç«¯æ­¥éª¤ï¼š

* ä½¿ç”¨JSAPIç»Ÿä¸€ä¸‹å•ï¼Œäº§ç”Ÿçš„prepay_idï¼ˆé¢„æ”¯ä»˜idï¼‰
* æ„é€ ç­¾åä¸² -> è®¡ç®—ç­¾å
* è¿”å›å‰ç«¯æ”¯ä»˜å‚æ•°

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#å‡†å¤‡æ”¯ä»˜å‚æ•°)å‡†å¤‡æ”¯ä»˜å‚æ•°

ç¬¬ä¸€æ­¥ï¼š

**é€ ç­¾åä¸²**

```text
ç­¾åä¸²ä¸€å…±æœ‰å››è¡Œï¼Œæ¯ä¸€è¡Œä¸ºä¸€ä¸ªå‚æ•°ã€‚è¡Œå°¾ä»¥\nï¼ˆæ¢è¡Œç¬¦ï¼ŒASCIIç¼–ç å€¼ä¸º0x0Aï¼‰ç»“æŸï¼ŒåŒ…æ‹¬æœ€åä¸€è¡Œã€‚
å¦‚æœå‚æ•°æœ¬èº«ä»¥\nç»“æŸï¼Œä¹Ÿéœ€è¦é™„åŠ ä¸€ä¸ª\n
```

**å‚ä¸ç­¾åå­—æ®µåŠæ ¼å¼ï¼š**

```text
å°ç¨‹åºappId
æ—¶é—´æˆ³
éšæœºå­—ç¬¦ä¸²
è®¢å•è¯¦æƒ…æ‰©å±•å­—ç¬¦ä¸²
```

ç¬¬äºŒæ­¥ï¼š

**è®¡ç®—ç­¾åï¼š**

```bash
echo -n -e \
"wx8888888888888888\n1414561699\n5K8264ILTKCH16CQ2502SI8ZNMTM67VS\nprepay_id=wx201410272009395522657a690389285100\n" \
  | openssl dgst -sha256 -sign apiclient_key.pem \
  | openssl base64 -A
```

å‚æ•°ï¼š

| å‚æ•°å             | å˜é‡      | ç±»å‹[é•¿åº¦é™åˆ¶] | å¿…å¡« | æè¿°                                                         |
| :----------------- | :-------- | :------------- | :--- | :----------------------------------------------------------- |
| æ—¶é—´æˆ³             | timeStamp | string[1,32]   | æ˜¯   | å½“å‰çš„æ—¶é—´ï¼Œå…¶ä»–è¯¦è§[æ—¶é—´æˆ³è§„åˆ™ (opens new window)](https://pay.weixin.qq.com/wiki/doc/api/wxpay_v2/jiekouguize/chapter1_2.shtml#part-5)ã€‚ ç¤ºä¾‹å€¼ï¼š1414561699 |
| éšæœºå­—ç¬¦ä¸²         | nonceStr  | string[1,32]   | æ˜¯   | éšæœºå­—ç¬¦ä¸²ï¼Œä¸é•¿äº32ä½ã€‚ ç¤ºä¾‹å€¼ï¼š5K8264ILTKCH16CQ2502SI8ZNMTM67VS |
| è®¢å•è¯¦æƒ…æ‰©å±•å­—ç¬¦ä¸² | package   | string[1,128]  | æ˜¯   | å°ç¨‹åºä¸‹å•æ¥å£è¿”å›çš„prepay_idå‚æ•°å€¼ï¼Œæäº¤æ ¼å¼å¦‚ï¼šprepay_id=*** ç¤ºä¾‹å€¼ï¼šprepay_id=wx201410272009395522657a690389285100 |
| ç­¾åæ–¹å¼           | signType  | string[1,32]   | æ˜¯   | ç­¾åç±»å‹ï¼Œé»˜è®¤ä¸ºRSAï¼Œä»…æ”¯æŒRSAã€‚ ç¤ºä¾‹å€¼ï¼šRSA                 |
| ç­¾å               | paySign   | string[1,512]  | æ˜¯   | ç­¾åï¼Œä½¿ç”¨å­—æ®µappIdã€timeStampã€nonceStrã€packageè®¡ç®—å¾—å‡ºçš„ç­¾åå€¼ ç¤ºä¾‹å€¼ |

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#åç«¯æ¥å£å¼€å‘)åç«¯æ¥å£å¼€å‘

åˆ›å»ºè·¯ç”±ï¼š

```js
// å¾®ä¿¡ç”¨æˆ·ä¸‹å•
router.post('/wxOrder', userController.wxOrder)
```

åˆ›å»º`wxOrder`ä¸‹å•æ–¹æ³•ï¼š

```js
async wxOrder (ctx) {
  const { body } = ctx.request
  // ä¸ºä»€ä¹ˆè®¢å•çš„totalå³å•†å“çš„é‡‘é¢ä¿¡æ¯ä¸èƒ½ä»å‰ç«¯ä¼ ï¼Ÿ
  // ä»å‰ç«¯ä¼ å•†å“çš„id -> åœ¨åç«¯æŸ¥è¯¢å¯¹åº”idçš„å•†å“ä»·æ ¼
  const { description, total } = body
  const user = await User.findByID(ctx._id)
  const params = {
    description,
    total,
    user
  }
  // 1. å‘èµ·wxPay -> prepay_id
  const { prepayId, nonceStr, timestamp } = await wxJSPAY(params)
  // å°ç¨‹åºappId
  // æ—¶é—´æˆ³
  // éšæœºå­—ç¬¦ä¸²
  // è®¢å•è¯¦æƒ…æ‰©å±•å­—ç¬¦ä¸²
  const paySign = rsaSign(`${config.AppID}\n${timestamp}\n${nonceStr}\nprepay_id=${prepayId}\n`)
  // 2. æ‹¼æ¥æ•°æ®è¿”å›å‰ç«¯
  ctx.body = {
    code: 200,
    data: {
      appId: config.AppID,
      timestamp,
      nonceStr,
      package: `prepay_id=${prepayId}`,
      signType: 'RSA',
      paySign
    }
  }
}
```

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#å‰ç«¯æ¨¡æ‹Ÿä¸‹å•-æ”¯ä»˜)å‰ç«¯æ¨¡æ‹Ÿä¸‹å•&æ”¯ä»˜

```js
async order () {
  const res = await this.$u.api.orderGoods({
    description: 'toimcæµ‹è¯•å•†å“',
    total: 1 // å•ä½åˆ†
  })
  // console.log('ğŸš€ ~ file: order.vue ~ line 23 ~ order ~ res', res)
  const { code, data } = res
  if (code === 200) {
    this.orderParams = data
    uni.showToast({
      icon: 'none',
      title: 'ä¸‹å•æˆåŠŸ',
      duration: 2000
    })
  }
},
pay () {
  uni.requestPayment({
    provider: 'weixin',
    orderInfo: {
      description: 'toimcæµ‹è¯•å•†å“',
      total: 1 // å•ä½åˆ†
    },
    timeStamp: this.orderParams.timestamp + '',
    nonceStr: this.orderParams.nonceStr,
    package: this.orderParams.package,
    signType: this.orderParams.signType,
    paySign: this.orderParams.paySign,
    complete: function (res) {
      console.log('ğŸš€ ~ file: order.vue ~ line 47 ~ pay ~ res', res)
      // errMsg: "requestPayment:ok" -> æ”¯ä»˜æˆåŠŸ
      // errMsg: "requestPayment:fail cancel" -> å–æ¶ˆ
    }
  })
}
```

## [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#è®¢å•æŸ¥è¯¢)è®¢å•æŸ¥è¯¢

ç”¨æˆ·æ”¯ä»˜æˆåŠŸåï¼Œéœ€è¦æ¥å—å¾®ä¿¡å¹³å°çš„è¢«åŠ¨é€šçŸ¥æˆ–è€…æ˜¯ä¸»åŠ¨æŸ¥è¯¢è®¢å•çš„æ”¯ä»˜çŠ¶æ€ã€‚

åŸå› ï¼šå¯èƒ½ç”¨æˆ·æ”¯ä»˜æˆåŠŸåï¼Œå¾®ä¿¡åå°å·²ç»ç»™äº†ç”¨æˆ·ä¾§åé¦ˆï¼Œä½†æ˜¯ç”±äºç½‘ç»œé—®é¢˜ï¼Œå•†æˆ·å¹³å°å¯èƒ½æœªæ”¶åˆ°é€šçŸ¥ã€‚

![image-20210830173043224](uniapp.assets/image-20210830173043224.358bbadb.png)

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#å¾®ä¿¡ä¸»åŠ¨é€šçŸ¥)å¾®ä¿¡ä¸»åŠ¨é€šçŸ¥

frpè½¬å‘é€šçŸ¥ï¼Œåªéœ€è¦åˆ›å»ºå¯¹åº”çš„æ¥å£ï¼Œç„¶ååœ¨JSAPIç»Ÿä¸€ä¸‹å•çš„æ¥å£ä¸­æŒ‡å®šå›è°ƒçš„åŸŸåå³å¯ã€‚

**è¯·æ±‚æ–¹å¼ï¼š**POST

**å›è°ƒURLï¼š**è¯¥é“¾æ¥æ˜¯é€šè¿‡åŸºç¡€ä¸‹å•æ¥å£ä¸­çš„è¯·æ±‚å‚æ•°â€œnotify_urlâ€æ¥è®¾ç½®çš„ï¼Œè¦æ±‚å¿…é¡»ä¸ºhttpsåœ°å€ã€‚è¯·ç¡®ä¿å›è°ƒURLæ˜¯å¤–éƒ¨å¯æ­£å¸¸è®¿é—®çš„ï¼Œä¸”ä¸èƒ½æºå¸¦åç¼€å‚æ•°ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å•†æˆ·æ— æ³•æ¥æ”¶åˆ°å¾®ä¿¡çš„å›è°ƒé€šçŸ¥ä¿¡æ¯ã€‚å›è°ƒURLç¤ºä¾‹ï¼š â€œhttps://pay.weixin.qq.com/wxpay/pay.actionâ€

**é€šçŸ¥è§„åˆ™**

ç”¨æˆ·æ”¯ä»˜å®Œæˆåï¼Œå¾®ä¿¡ä¼šæŠŠç›¸å…³æ”¯ä»˜ç»“æœå’Œç”¨æˆ·ä¿¡æ¯å‘é€ç»™å•†æˆ·ï¼Œå•†æˆ·éœ€è¦æ¥æ”¶å¤„ç†è¯¥æ¶ˆæ¯ï¼Œå¹¶è¿”å›åº”ç­”ã€‚

å¯¹åå°é€šçŸ¥äº¤äº’æ—¶ï¼Œå¦‚æœå¾®ä¿¡æ”¶åˆ°å•†æˆ·çš„åº”ç­”ä¸ç¬¦åˆè§„èŒƒæˆ–è¶…æ—¶ï¼Œå¾®ä¿¡è®¤ä¸ºé€šçŸ¥å¤±è´¥ï¼Œå¾®ä¿¡ä¼šé€šè¿‡ä¸€å®šçš„ç­–ç•¥å®šæœŸé‡æ–°å‘èµ·é€šçŸ¥ï¼Œå°½å¯èƒ½æé«˜é€šçŸ¥çš„æˆåŠŸç‡ï¼Œä½†å¾®ä¿¡ä¸ä¿è¯é€šçŸ¥æœ€ç»ˆèƒ½æˆåŠŸã€‚ï¼ˆé€šçŸ¥é¢‘ç‡ä¸º15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - æ€»è®¡ 24h4mï¼‰

**é€šçŸ¥æŠ¥æ–‡**

æ”¯ä»˜ç»“æœé€šçŸ¥æ˜¯ä»¥POST æ–¹æ³•è®¿é—®å•†æˆ·è®¾ç½®çš„é€šçŸ¥urlï¼Œé€šçŸ¥çš„æ•°æ®ä»¥JSON æ ¼å¼é€šè¿‡è¯·æ±‚ä¸»ä½“ï¼ˆBODYï¼‰ä¼ è¾“ã€‚é€šçŸ¥çš„æ•°æ®åŒ…æ‹¬äº†åŠ å¯†çš„æ”¯ä»˜ç»“æœè¯¦æƒ…ã€‚

ä¸‹é¢è¯¦ç»†æè¿°å¯¹é€šçŸ¥æ•°æ®è¿›è¡Œè§£å¯†çš„æµç¨‹ï¼š

1. ç”¨å•†æˆ·å¹³å°ä¸Šè®¾ç½®çš„APIv3å¯†é’¥ã€[å¾®ä¿¡å•†æˆ·å¹³å° (opens new window)](https://pay.weixin.qq.com/)â€”>è´¦æˆ·è®¾ç½®â€”>APIå®‰å…¨â€”>è®¾ç½®APIv3å¯†é’¥ã€‘ï¼Œè®°ä¸ºkeyï¼›
2. é’ˆå¯¹resource.algorithmä¸­æè¿°çš„ç®—æ³•ï¼ˆç›®å‰ä¸ºAEAD_AES_256_GCMï¼‰ï¼Œå–å¾—å¯¹åº”çš„å‚æ•°nonceå’Œassociated_dataï¼›
3. ä½¿ç”¨keyã€nonceå’Œassociated_dataï¼Œå¯¹æ•°æ®å¯†æ–‡resource.ciphertextè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°JSONå½¢å¼çš„èµ„æºå¯¹è±¡ï¼›

**æ³¨ï¼š** AEAD_AES_256_GCMç®—æ³•çš„æ¥å£ç»†èŠ‚ï¼Œè¯·å‚è€ƒ[rfc5116 (opens new window)](https://tools.ietf.org/html/rfc5116)ã€‚å¾®ä¿¡æ”¯ä»˜ä½¿ç”¨çš„å¯†é’¥keyé•¿åº¦ä¸º32ä¸ªå­—èŠ‚ï¼Œéšæœºä¸²nonceé•¿åº¦12ä¸ªå­—èŠ‚ï¼Œassociated_dataé•¿åº¦å°äº16ä¸ªå­—èŠ‚å¹¶å¯èƒ½ä¸ºç©ºã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#ä¸»åŠ¨é€šçŸ¥åç«¯æ¥å£)ä¸»åŠ¨é€šçŸ¥åç«¯æ¥å£

è§£å¯†æ–¹æ³•ï¼š

```js
export const decryptByApiV3 = ({
  associate, // åŠ å¯†å‚æ•° - ç±»å‹
  nonce, // åŠ å¯†å‚æ•° - éšæœºæ•°
  ciphertext // åŠ å¯†å¯†æ–‡
} = {}) => {
  ciphertext = decodeURIComponent(ciphertext)
  ciphertext = Buffer.from(ciphertext, 'base64')

  const authTag = ciphertext.slice(ciphertext.length - 16)
  const data = ciphertext.slice(0, ciphertext.length - 16)

  const decipher = crypto.createDecipheriv(
    'aes-256-gcm',
    config.apiV3Key,
    nonce
  )
  decipher.setAuthTag(authTag)
  decipher.setAAD(Buffer.from(associate))

  let decryptedText = decipher.update(data, null, 'utf8')
  decryptedText += decipher.final()
  return decryptedText
}
```

åˆ›å»ºæ¥å£ï¼š

```text
// è·å–æ”¯ä»˜é€šçŸ¥
router.post('/notify', adminController.wxNotify)
```

æ¥å£è¯¦æƒ…`wxNotify`ï¼š

```js
// å¾®ä¿¡æ”¯ä»˜å›è°ƒé€šçŸ¥
async wxNotify (ctx) {
  const { body } = ctx.request
  const { resource_type: type, resource } = body
  if (type === 'encrypt-resource') {
    const { ciphertext, associated_data: associate, nonce } = resource
    const str = decryptByApiV3({
      associate,
      nonce,
      ciphertext
    })
    console.log('ğŸš€ ~ file: AdminController.js ~ line 326 ~ AdminController ~ wxNotify ~ str', str)
    // todo å…¥åº“ï¼Œå¹¶ä¿®æ”¹è®¢å•çš„æ”¯ä»˜æˆåŠŸçš„çŠ¶æ€
  }
  console.log(
    'ğŸš€ ~ file: AdminController.js ~ line 294 ~ AdminController ~ wxNotify ~ body',
    body
  )
  ctx.body = {
    code: 200
  }
}
```

> æ”¶åˆ°è®¢å•é€šçŸ¥åï¼Œéœ€è¦ä¿å­˜é€šçŸ¥ä¸­çš„çŠ¶æ€ä¸æ•°æ®ï¼ˆå¾®ä¿¡è®¢å•å·ï¼‰ã€‚

### [#](https://front-end.toimc.com/notes-page/project/community-miniapp/12-æ”¯ä»˜ä¸“é¢˜.html#è®¢å•æŸ¥è¯¢æ¥å£)è®¢å•æŸ¥è¯¢æ¥å£

[å®˜æ–¹æ–‡æ¡£(opens new window)](https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_2.shtml)

æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š

* å¾®ä¿¡æ”¯ä»˜è®¢å•å·æŸ¥è¯¢
* å•†æˆ·è®¢å•å·æŸ¥è¯¢ï¼ˆä¸€èˆ¬é‡‡ç”¨è¿™ç§ï¼‰

**è¯·æ±‚URLï¼š** `https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/{out_trade_no}`

**è¯·æ±‚æ–¹å¼ï¼š**GET

**è¯·æ±‚å‚æ•°**

| å‚æ•°å     | å˜é‡         | ç±»å‹[é•¿åº¦é™åˆ¶] | å¿…å¡« | æè¿°                                                         |
| :--------- | :----------- | :------------- | :--- | :----------------------------------------------------------- |
| ç›´è¿å•†æˆ·å· | mchid        | string[1,32]   | æ˜¯   | query ç›´è¿å•†æˆ·çš„å•†æˆ·å·ï¼Œç”±å¾®ä¿¡æ”¯ä»˜ç”Ÿæˆå¹¶ä¸‹å‘ã€‚ ç¤ºä¾‹å€¼ï¼š1230000109 |
| å•†æˆ·è®¢å•å· | out_trade_no | string[6,32]   | æ˜¯   | path å•†æˆ·ç³»ç»Ÿå†…éƒ¨è®¢å•å·ï¼Œåªèƒ½æ˜¯æ•°å­—ã€å¤§å°å†™å­—æ¯_-*ä¸”åœ¨åŒä¸€ä¸ªå•†æˆ·å·ä¸‹å”¯ä¸€ã€‚ ç‰¹æ®Šè§„åˆ™ï¼šæœ€å°å­—ç¬¦é•¿åº¦ä¸º6 ç¤ºä¾‹å€¼ï¼š1217752501201407033233368018 |

ç¤ºä¾‹ï¼š

```text
https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/1217752501201407033233368018?mchid=1230000109
```

> è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ï¼Œurlä¸­æœ‰è·¯å¾„å‚æ•°ä¸queryå‚æ•°

åç«¯ä»£ç ï¼š

```js
import qs from 'qs'

// å¾®ä¿¡æ”¯ä»˜è®¢å•æŸ¥è¯¢ out_trade_no
//  https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/{out_trade_no}
export const getNofityByTradeNo = async (id) => {
  try {
    let url = `https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/${id}?`
    const params = {
      mchid: config.mchid
    }
    url += qs.stringify(params)
    const { headers, nonceStr, timestamp } = getSignHeaders(url, 'get')
    const result = await instance.get(url, {
      headers: {
        Authorization: headers
      }
    })
    console.log(
      'ğŸš€ ~ file: WxPay.js ~ line 147 ~ getNofityByTradeNo ~ timestamp',
      timestamp
    )
    console.log(
      'ğŸš€ ~ file: WxPay.js ~ line 147 ~ getNofityByTradeNo ~ nonceStr',
      nonceStr
    )
    console.log('ğŸš€ ~ file: WxPay.js ~ line 53 ~ wxJSPAY ~ result', result)
    // todo result.data -> trade_state trade_type -> å­˜å‚¨è®¢å•çš„å…¶ä»–ä¿¡æ¯
  } catch (error) {
    logger.error(`getNofityByTradeNo error: ${error.message}`)
  }
}
```

è‡³æ­¤ï¼Œå®Œæˆçš„å°ç¨‹åºæ”¯ä»˜çš„ä¸€ä¸ªå®Œæ•´çš„é—­ç¯ã€‚

> å…³äºé€€æ¬¾ä¸é€€æ¬¾é€šçŸ¥ä¸ä¸‹å•&è®¢å•é€šçŸ¥æ˜¯ç±»ä¼¼ï¼Œä¸å†æä¾›ç¤ºä¾‹ã€‚